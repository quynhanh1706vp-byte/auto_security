import os, glob, json
from urllib.parse import parse_qs
import wsgi_vsp_ui_gateway as base

def _norm_rid(rid: str) -> str:
    rid = (rid or "").strip()
    return rid[4:] if rid.startswith("RUN_") else rid

def _resolve_ci_dir(rid: str) -> str:
    rn = _norm_rid(rid)
    root = os.environ.get("VSP_CI_OUT_ROOT") or "/home/test/Data/SECURITY-10-10-v4/out_ci"
    cand = os.path.join(root, rn)
    if os.path.isdir(cand):
        return cand
    for d in sorted(glob.glob(os.path.join(root, "VSP_CI_*")), reverse=True):
        if rn in os.path.basename(d):
            return d
    return ""

def _pick_pdf(ci_dir: str) -> str:
    best = ""
    best_m = -1.0
    for pat in (os.path.join(ci_dir, "reports", "*.pdf"), os.path.join(ci_dir, "*.pdf")):
        for f in glob.glob(pat):
            try:
                m = os.path.getmtime(f)
            except Exception:
                continue
            if m > best_m:
                best_m = m
                best = f
    return best

class ExportPdfPreemptApp:
    def __init__(self, inner):
        self.inner = inner

    def __call__(self, environ, start_response):
        path = (environ.get("PATH_INFO") or "").strip()

        # Preempt ONLY exportpdf
        if path.startswith("/api/vsp/run_export_v3/"):
            q = parse_qs(environ.get("QUERY_STRING", "") or "")
            fmt = (q.get("fmt", ["html"])[0] or "html").lower().strip()
            if fmt == "pdf":
                rid = path.split("/api/vsp/run_export_v3/", 1)[1].strip("/")
                ci_dir = _resolve_ci_dir(rid)
                pdf = _pick_pdf(ci_dir) if ci_dir else ""

                if pdf and os.path.isfile(pdf):
                    size = os.path.getsize(pdf)
                    start_response("200 OK", [
                        ("Content-Type", "application/pdf"),
                        ("Content-Disposition", f'attachment; filename="{os.path.basename(pdf)}"'),
                        ("Content-Length", str(size)),
                        ("X-VSP-EXPORT-AVAILABLE", "1"),
                        ("X-VSP-EXPORT-FILE", os.path.basename(pdf)),
                        ("X-VSP-WSGI-LAYER", "EXPORTPDF_ONLY"),
                    ])
                    return open(pdf, "rb")

                body = json.dumps({
                    "ok": False, "http_code": 404, "error": "PDF_NOT_FOUND",
                    "rid": rid, "rid_norm": _norm_rid(rid),
                    "ci_run_dir": ci_dir or None
                }).encode("utf-8")
                start_response("404 NOT FOUND", [
                    ("Content-Type", "application/json"),
                    ("Content-Length", str(len(body))),
                    ("X-VSP-EXPORT-AVAILABLE", "0"),
                    ("X-VSP-WSGI-LAYER", "EXPORTPDF_ONLY"),
                ])
                return [body]

        return self.inner(environ, start_response)

_inner = getattr(base, "application", None) or getattr(base, "app", None)
application = ExportPdfPreemptApp(_inner)

try:
    print("[VSP_WSGI_EXPORTPDF_ONLY] installed")
except Exception:
    pass
