/* VSP_BUNDLE_COMMERCIAL_V1_STUB_P1_V1
   This file was broken (syntax error). Keep as safe stub that loads v2. */
(function(){
  try{
    if (window.__vsp_bundle_commercial_v1_stub) return;
    window.__vsp_bundle_commercial_v1_stub = true;
    var s=document.createElement("script");
    s.src="/static/js/vsp_bundle_commercial_v2.js";
    s.defer=true;
    (document.head||document.documentElement).appendChild(s);
    console.warn("[VSP] v1 bundle stub loaded -> redirected to v2");
  }catch(e){}
})();

/* ===== VSP_P0_RUNS_REPORTS_COMMERCIAL_POLISH_V1 =====
   - Default no-filter + limit=50
   - Bind row click -> localStorage vsp_rid_selected_v2
   - Fix rid_latest fetch order + reduce noisy warn
   Safe: no-op if elements not present.
*/
(function(){
  try{
    function _qs(sel, root){ try{ return (root||document).querySelector(sel);}catch(e){return null;} }
    function _qsa(sel, root){ try{ return Array.from((root||document).querySelectorAll(sel));}catch(e){return [];} }

    function vspSetSelectedRid(rid){
      if(!rid) return;
      try{ localStorage.setItem('vsp_rid_selected_v2', rid); }catch(e){}
      try{ localStorage.setItem('vsp_rid_selected', rid); }catch(e){} // compat
      // optional badges (nếu có)
      const badge =
        document.getElementById('vsp-selected-rid-badge') ||
        document.getElementById('vsp-rid-selected') ||
        document.getElementById('vsp-rid-latest') ||
        _qs('[data-vsp-selected-rid]') ||
        _qs('[data-selected-rid]');
      if(badge){
        try{ badge.textContent = rid; }catch(e){}
      }
    }

    function vspRunsDefaultNoFilterAndLimit(){
      // cố gắng set default limit=50 nếu có input/select
      const limitEls = [
        document.getElementById('limit'),
        document.getElementById('runs-limit'),
        document.getElementById('vsp-runs-limit'),
        _qs('input[name="limit"]'),
        _qs('select[name="limit"]'),
      ].filter(Boolean);

      for(const el of limitEls){
        try{
          if(el.tagName === 'SELECT'){
            // chọn option 50 nếu có
            const opt = Array.from(el.options||[]).find(o => String(o.value) === '50');
            if(opt){ el.value='50'; }
          }else{
            // input
            if(!el.value || String(el.value).trim()==='' || String(el.value)==='20' || String(el.value)==='10'){
              el.value = '50';
            }
          }
        }catch(e){}
      }

      // đảm bảo default không tick filter
      const ids = [
        'has_json','has_summary','has_html','has_csv','has_sarif',
        'filter','filter_on','hide_empty','only_with_artifacts'
      ];
      for(const id of ids){
        const el = document.getElementById(id);
        if(el && (el.type === 'checkbox' || el.type === 'radio')){
          try{ el.checked = false; }catch(e){}
        }
      }
      // các checkbox theo name (phòng khi id khác)
      _qsa('input[type="checkbox"][name^="has_"], input[type="checkbox"][name*="has"]')
        .forEach(el => { try{ el.checked = false; }catch(e){} });
    }

    function vspBindRidRowClick(){
      // delegate click: tìm ancestor có data-run-id/data-rid
      document.addEventListener('click', function(e){
        const t = e.target;
        if(!t || !t.closest) return;
        const holder = t.closest('[data-run-id],[data-rid],[data-runid],tr[data-run-id],tr[data-rid],tr[data-runid]');
        if(!holder) return;
        const rid = holder.getAttribute('data-run-id') || holder.getAttribute('data-rid') || holder.getAttribute('data-runid');
        if(rid) vspSetSelectedRid(rid);
      }, true);
    }

    async function vspFixRidLatestAfterRunsLoad(){
      // chỉ fetch 1 lần, nhẹ
      try{
        const res = await fetch('/api/vsp/runs?limit=1');
        if(!res.ok) return;
        const j = await res.json();
        const rid = (j && j.items && j.items[0] && (j.items[0].run_id || j.items[0].rid)) || j.rid_latest;
        if(rid) vspSetSelectedRid(rid);
      }catch(e){}
    }

    function boot(){
      vspRunsDefaultNoFilterAndLimit();
      vspBindRidRowClick();
      // rid_latest: chạy async sau, tránh log N/A quá sớm
      setTimeout(vspFixRidLatestAfterRunsLoad, 350);
    }

    if(document.readyState === 'loading'){
      document.addEventListener('DOMContentLoaded', boot);
    }else{
      boot();
    }
  }catch(_e){}
})();
