/* VSP_P2_BUNDLE_TABS5_V1
 * Router-bundle: load page modules by route, keep templates minimal:
 * Only include: vsp_tabs4_autorid_v1.js + this file.
 */
(function(){
  "use strict";

  function log(){ try{ console.log.apply(console, arguments); }catch(e){} }
  function warn(){ try{ console.warn.apply(console, arguments); }catch(e){} }

  function getAssetV(){
    // Try to reuse existing ?v=<digits> from any script tag.
    var scripts = document.getElementsByTagName("script");
    for (var i=0;i<scripts.length;i++){
      var src = scripts[i].getAttribute("src") || "";
      var m = src.match(/[?&]v=([0-9]{6,})/);
      if (m) return m[1];
    }
    return "";
  }

  function withV(url){
    var v = getAssetV();
    if(!v) return url;
    return url + (url.indexOf("?")>=0 ? "&" : "?") + "v=" + encodeURIComponent(v);
  }

  function loadScript(url){
    return new Promise(function(resolve, reject){
      var s = document.createElement("script");
      s.defer = true;
      s.src = withV(url);
      s.onload = function(){ resolve(url); };
      s.onerror = function(){ reject(new Error("load fail: "+url)); };
      document.head.appendChild(s);
    });
  }

  function exists(url){
    // Avoid noisy 404s: HEAD first (fallback GET if HEAD not allowed)
    var u = withV(url);
    return fetch(u, { method: "HEAD", credentials: "same-origin", cache: "no-store" })
      .then(function(r){
        if(r && r.ok) return true;
        if(r && (r.status === 405 || r.status === 403)) {
          return fetch(u, { method: "GET", credentials: "same-origin", cache: "no-store" })
            .then(function(r2){ return !!(r2 && r2.ok); })
            .catch(function(){ return false; });
        }
        return false;
      })
      .catch(function(){ return false; });
  }

  function loadIfExists(url){
    return exists(url).then(function(ok){
      if(!ok) return false;
      return loadScript(url).then(function(){ return true; }).catch(function(){ return false; });
    });
  }

  function pickRoute(){
    var p = (location.pathname || "/").toLowerCase();
    // normalize
    if (p === "/" || p === "/index") return "/vsp5";
    return p;
  }

  // Candidate modules: router will only load ones that exist.
  var ROUTES = {
    "/vsp5": [
      "/static/js/vsp_dash_only_v1.js",
      "/static/js/vsp_dashboard_kpi_force_any_v1.js",
      "/static/js/vsp_dashboard_gate_story_v1.js",
      "/static/js/vsp_dashboard_charts_pretty_v3.js"
    ],
    "/runs": [
      "/static/js/vsp_runs_reports_overlay_v1.js",
      "/static/js/vsp_runs_quick_actions_v1.js",
      "/static/js/vsp_runs_tab_resolved_v1.js"
    ],
    "/settings": [
      "/static/js/vsp_settings_tab_v1.js"
    ],
    "/data_source": [
      "/static/js/vsp_data_source_lazy_v1.js"
    ],
    "/rule_overrides": [
      "/static/js/vsp_rule_overrides_v1.js"
    ]
  };

  var route = pickRoute();
  var list = ROUTES[route] || [];
  if(!list.length){
    warn("[BundleTabs5] no modules mapped for route:", route);
    return;
  }

  log("[BundleTabs5] route=", route, "candidates=", list.length);

  // Load sequentially to keep deterministic order
  (function seq(i){
    if(i >= list.length){
      log("[BundleTabs5] done route=", route);
      return;
    }
    loadIfExists(list[i]).then(function(loaded){
      if(loaded) log("[BundleTabs5] loaded:", list[i]);
      seq(i+1);
    });
  })(0);


  // ===================== VSP_P2_BADGES_RID_OVERALL_V1 =====================
  (function(){
    function safeLog(){ try{ console.log.apply(console, arguments); }catch(e){} }
    function safeWarn(){ try{ console.warn.apply(console, arguments); }catch(e){} }

    function ensureStyle(){
      if (document.getElementById("vsp_p2_badges_style")) return;
      var st = document.createElement("style");
      st.id = "vsp_p2_badges_style";
      st.textContent = `
        .vsp-p2-badges{display:flex;gap:8px;align-items:center;margin-left:auto}
        .vsp-badge{font:12px/1.2 ui-sans-serif,system-ui; padding:4px 8px; border-radius:999px;
          border:1px solid rgba(255,255,255,.18); background:rgba(255,255,255,.06); color:#e8eefc;
          letter-spacing:.2px; white-space:nowrap}
        .vsp-badge b{font-weight:700}
        .vsp-badge.green{border-color:rgba(46,204,113,.45); background:rgba(46,204,113,.12)}
        .vsp-badge.amber{border-color:rgba(241,196,15,.45); background:rgba(241,196,15,.12)}
        .vsp-badge.red{border-color:rgba(231,76,60,.45); background:rgba(231,76,60,.12)}
        .vsp-badge.gray{opacity:.85}
        .vsp-badge-click:hover{filter:brightness(1.18)}
      `;
      document.head.appendChild(st);
    }

    function findTopbar(){
      // Your pages use .topnav in /vsp5; other tabs may also have it.
      return document.querySelector(".topnav") || document.querySelector("#topbar") || null;
    }

    function ensureContainer(topbar){
      var id = "vsp_p2_badges";
      var c = document.getElementById(id);
      if (c) return c;
      c = document.createElement("div");
      c.id = id;
      c.className = "vsp-p2-badges";
      if (topbar){
        topbar.appendChild(c);
      } else {
        // fallback: put at top of body (should rarely happen)
        c.style.position = "fixed";
        c.style.top = "10px";
        c.style.right = "10px";
        c.style.zIndex = "9999";
        document.body.appendChild(c);
      }
      return c;
    }

    
    function mkBadge(cls, text, opts){
      opts = opts || {};
      var el = document.createElement("span");
      el.className = "vsp-badge " + cls + (opts.click ? " vsp-badge-click" : "");
      el.textContent = text;
      if (opts.click){
        el.style.cursor = "pointer";
        el.title = opts.title || "Open";
        if (opts.action) el.dataset.vspAction = opts.action;
        if (opts.payload) el.dataset.vspPayload = opts.payload;
        el.addEventListener("click", function(){
          try{
            var a = el.dataset.vspAction || "";
            var p = el.dataset.vspPayload || "";
            if (a === "runs_rid"){
              // p is rid
              location.href = "/runs?rid=" + encodeURIComponent(p);
            } else if (a === "dash_gate"){
              location.href = "/vsp5?gate=1";
            }
          }catch(e){}
        });
      }
      return el;
    }


    function timeoutFetch(url, ms){
      var ctrl = new AbortController();
      var t = setTimeout(function(){ try{ ctrl.abort(); }catch(e){} }, ms);
      return fetch(url, {cache:"no-store", credentials:"same-origin", signal: ctrl.signal})
        .finally(function(){ clearTimeout(t); });
    }

    function pickOverallClass(v){
      v = (v || "").toString().toUpperCase();
      if (v === "GREEN" || v === "PASS" || v === "OK") return "green";
      if (v === "AMBER" || v === "WARN" || v === "WARNING" || v === "DEGRADED") return "amber";
      if (v === "RED" || v === "FAIL" || v === "BLOCK") return "red";
      return "gray";
    }

    function shortRid(rid){
      rid = (rid || "").toString();
      if (rid.length <= 18) return rid;
      return rid.slice(0, 10) + "…" + rid.slice(-6);
    }

    async function run(){
      try{
        ensureStyle();
        var topbar = findTopbar();
        var c = ensureContainer(topbar);

        // clear old
        c.innerHTML = "";
        c.appendChild(mkBadge("gray", "RID: …"));
        c.appendChild(mkBadge("gray", "Overall: …"));

        // 1) rid_latest
        var rid = "";
        try{
          var r1 = await timeoutFetch("/api/vsp/rid_latest?ts=" + Date.now(), 3500);
          var j1 = await r1.json();
          rid = (j1 && j1.rid) ? j1.rid : "";
        }catch(e){
          safeWarn("[P2Badges] rid_latest fetch fail", e);
        }

        // 2) run_gate_summary
        var overall = "";
        var degraded = false;
        try{
          if (rid){
            var url = "/api/vsp/run_file_allow?rid=" + encodeURIComponent(rid) + "&path=run_gate_summary.json&ts=" + Date.now();
            var r2 = await timeoutFetch(url, 4000);
            var j2 = await r2.json();

            overall = (j2 && j2.overall) ? j2.overall : "";
            // Best-effort degraded detection (flexible)
            degraded = !!(
              (j2 && j2.degraded) ||
              (j2 && j2.status && (""+j2.status).toUpperCase().includes("DEGRADED")) ||
              (j2 && j2.degraded_tools && Array.isArray(j2.degraded_tools) && j2.degraded_tools.length) ||
              (j2 && j2.missing_tools && Array.isArray(j2.missing_tools) && j2.missing_tools.length)
            );
          }
        }catch(e){
          safeWarn("[P2Badges] run_gate_summary fetch fail", e);
        }

        // render
        c.innerHTML = "";
        c.appendChild(mkBadge("gray", "RID: " + (rid ? shortRid(rid) : "n/a"), {click:true, action:"runs_rid", payload: rid || "", title:"Open Runs & Reports (RID)"}));
        var oc = pickOverallClass(overall);
        c.appendChild(mkBadge(oc, "Overall: " + (overall ? overall.toString().toUpperCase() : "n/a"), {click:true, action:"dash_gate", payload:"1", title:"Open Dashboard (Gate)"}));
        if (degraded){
          c.appendChild(mkBadge("amber", "DEGRADED", {click:true, action:"dash_gate", payload:"1", title:"Open Dashboard (Gate)"}));
        }

        safeLog("[P2Badges] ok rid=", rid, "overall=", overall, "degraded=", degraded);
      }catch(e){
        // no throw to avoid breaking UI
      }
    }

    // Run after DOM is ready enough
    if (document.readyState === "loading"){
      document.addEventListener("DOMContentLoaded", run);
    } else {
      run();
    }
  })();
  // ===================== /VSP_P2_BADGES_RID_OVERALL_V1 =====================

})();

/* VSP_P2_BADGES_CLICK_ACTIONS_V1 */
