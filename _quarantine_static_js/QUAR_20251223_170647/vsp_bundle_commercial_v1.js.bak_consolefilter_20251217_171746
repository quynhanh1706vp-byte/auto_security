/* VSP_BUNDLE_COMMERCIAL_V1_PROLOGUE */
/* injected_at: 2025-12-17T16:53:25.829229 */
(function(){
  'use strict';
  try{ window.__VSP_BUNDLE_COMMERCIAL_V1 = true; }catch(_){ }
  // single entrypoint contract
  if (!window.VSP_DRILLDOWN) {
    window.VSP_DRILLDOWN = function(intent){
      try{
        if (typeof window.VSP_DRILLDOWN_IMPL === 'function') return window.VSP_DRILLDOWN_IMPL(intent);
        if (typeof window.__VSP_DD_ART_CALL__ === 'function') return window.__VSP_DD_ART_CALL__(intent);
        if (typeof window.__VSP_DRILLDOWN__ === 'function') return window.__VSP_DRILLDOWN__(intent);
        console.warn('[VSP][DRILLDOWN] no impl', intent);
        return null;
      }catch(e){ try{console.warn('[VSP][DRILLDOWN] err', e);}catch(_e){} return null; }
    };
  }
  // HARD ALIASES for legacy callers (stop TypeError)
  var alias = function(){ return window.VSP_DRILLDOWN.apply(window, arguments); };
  try{
    if (typeof window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 !== 'function') window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 = alias;
    if (typeof window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V1 !== 'function') window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V1 = alias;
    if (typeof window.VSP_DASH_DRILLDOWN_ARTIFACTS !== 'function') window.VSP_DASH_DRILLDOWN_ARTIFACTS = alias;
  }catch(_){ }
})();

/* VSP_BUNDLE_COMMERCIAL_V1 */
/* built_at: 2025-12-17 16:22:48 */
/* NOTE: do NOT load vsp_ui_loader_route_v1.js in commercial mode */

(function(){
  'use strict';
  // Single public entrypoint (commercial contract)
  if (!window.VSP_DRILLDOWN) {
    window.VSP_DRILLDOWN = function(intent){
      try{
        // prefer explicit impl if provided
        if (typeof window.VSP_DRILLDOWN_IMPL === 'function') return window.VSP_DRILLDOWN_IMPL(intent);
        // common internal hooks (best-effort compat)
        if (typeof window.__VSP_DD_ART_CALL__ === 'function') return window.__VSP_DD_ART_CALL__(intent);
        if (typeof window.__VSP_DRILLDOWN__ === 'function') return window.__VSP_DRILLDOWN__(intent);
        console.warn('[VSP][DRILLDOWN] no impl', intent);
        return null;
      }catch(e){ try{console.warn('[VSP][DRILLDOWN] err', e);}catch(_){ } return null; }
    };
  }
  // Backward-compat shim (do NOT encourage direct P1_V2 usage)
  if (!window.P1_V2) window.P1_V2 = {};
  if (typeof window.P1_V2 === 'object' && !window.P1_V2.drilldown) {
    window.P1_V2.drilldown = function(intent){ return window.VSP_DRILLDOWN(intent); };
  }
})();

;
/* ==== BEGIN static/js/vsp_drilldown_stub_safe_v1.js ==== */

/* VSP_DRILLDOWN_STUB_SAFE_CALLABLE_V1 (commercial):
   - window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 is ALWAYS callable
   - accepts "real impl" via setter (function or object with .open/.run/.invoke)
   - fallback: emit intent + navigate #datasource */
(function(){
  'use strict';
  if (window.__VSP_DRILLDOWN_STUB_SAFE_CALLABLE_V1__) return;
  window.__VSP_DRILLDOWN_STUB_SAFE_CALLABLE_V1__ = 1;

  var _impl = null;

  function _emitIntent(intent){
    try{
      window.__VSP_DRILLDOWN_INTENT__ = intent;
      try{ localStorage.setItem('vsp_drilldown_intent_v1', JSON.stringify(intent)); }catch(_){}
      window.dispatchEvent(new CustomEvent('vsp:drilldown', { detail: intent }));
    }catch(_){}
  }

  function _gotoDataSource(){
    try{ if (window.location.hash !== '#datasource') window.location.hash = '#datasource'; }catch(_){}
  }

  function _safeInvoke(impl, args){
    try{
      if (typeof impl === 'function') return impl.apply(null, args);
      if (impl && typeof impl.open === 'function') return impl.open.apply(impl, args);
      if (impl && typeof impl.run === 'function') return impl.run.apply(impl, args);
      if (impl && typeof impl.invoke === 'function') return impl.invoke.apply(impl, args);
    }catch(e){
      try{ console.warn('[VSP][DD_SAFE_CALLABLE]', e); }catch(_){}
    }
    return null;
  }

  function exported(opts){
    var intent = {};
    try{
      if (typeof opts === 'string') intent.rid = opts;
      else if (opts && typeof opts === 'object') intent = opts;
      if (!intent.rid){
        intent.rid = (window.__VSP_RID_STATE__ && window.__VSP_RID_STATE__.rid) || window.__VSP_RID || null;
      }
      intent.ts = Date.now();
      intent.kind = intent.kind || 'artifacts';
    }catch(_){}

    var r = _safeInvoke(_impl, arguments);
    if (r !== null) return r;

    _emitIntent(intent);
    _gotoDataSource();
    try{
      if (typeof window.VSP_DATASOURCE_APPLY_DRILLDOWN_V1 === 'function'){
        return window.VSP_DATASOURCE_APPLY_DRILLDOWN_V1(intent);
      }
    }catch(_){}
    return null;
  }

  // Force callable getter/setter forever
  try{
    if (window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 && window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 !== exported){
      _impl = window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2;
    }
    Object.defineProperty(window, 'VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2', {
      configurable: true,
      enumerable: true,
      get: function(){ return exported; },
      set: function(v){
        _impl = v;
        try{ console.log('[VSP][DD] accepted real impl'); }catch(_){}
      }
    });
  }catch(e){
    _impl = window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2;
    window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 = exported;
  }

  // Re-assert callable if clobbered later
  setInterval(function(){
    try{
      if (window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 !== exported){
        _impl = window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2;
        window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 = exported;
      }
    }catch(_){}
  }, 800);
})();


/* ==== END static/js/vsp_drilldown_stub_safe_v1.js ==== */
;
;
/* ==== BEGIN static/js/vsp_drilldown_artifacts_impl_commercial_v1.js ==== */

/* VSP_DRILLDOWN_ARTIFACTS_IMPL_COMMERCIAL_V1
   Goal: VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 is ALWAYS callable (even if someone sets object).
   Behavior: navigate to Data Source tab and pass drilldown intent (rid + optional filters). */
(function(){
  'use strict';
  if (window.__VSP_DRILLDOWN_ART_IMPL_COMMERCIAL_V1__) return;
  window.__VSP_DRILLDOWN_ART_IMPL_COMMERCIAL_V1__ = 1;

  var _impl = null;

  function _emitIntent(intent){
    try{
      // store intent for datasource tab to pick up
      window.__VSP_DRILLDOWN_INTENT__ = intent;
      try{ localStorage.setItem('vsp_drilldown_intent_v1', JSON.stringify(intent)); }catch(_){}
      window.dispatchEvent(new CustomEvent('vsp:drilldown', { detail: intent }));
    }catch(_){}
  }

  function _gotoDataSource(){
    try{
      // prefer router if exists
      if (window.location.hash !== '#datasource'){
        window.location.hash = '#datasource';
      }
    }catch(_){}
  }

  function _safeInvoke(impl, args){
    try{
      if (typeof impl === 'function') return impl.apply(null, args);
      if (impl && typeof impl.open === 'function') return impl.open.apply(impl, args);
      if (impl && typeof impl.run === 'function') return impl.run.apply(impl, args);
      if (impl && typeof impl.invoke === 'function') return impl.invoke.apply(impl, args);
    }catch(e){
      try{ console.warn('[VSP][DD] invoke failed', e); }catch(_){}
    }
    return null;
  }

  // exported callable used by dashboard/runs
  function exported(opts){
    // opts can be (rid) or ({rid, kind, severity, cwe, tool, ...})
    var intent = {};
    try{
      if (typeof opts === 'string') intent.rid = opts;
      else if (opts && typeof opts === 'object') intent = opts;
      // auto-fill rid from global state if missing
      if (!intent.rid){
        intent.rid = (window.__VSP_RID_STATE__ && window.__VSP_RID_STATE__.rid) || window.__VSP_RID || null;
      }
      intent.ts = Date.now();
      intent.kind = intent.kind || 'artifacts';
    }catch(_){}

    // If there is a real impl, call it. Otherwise do commercial fallback navigation.
    var r = _safeInvoke(_impl, arguments);
    if (r !== null) return r;

    _emitIntent(intent);
    _gotoDataSource();

    // if datasource exposes an API, call it
    try{
      if (typeof window.VSP_DATASOURCE_APPLY_DRILLDOWN_V1 === 'function'){
        return window.VSP_DATASOURCE_APPLY_DRILLDOWN_V1(intent);
      }
    }catch(_){}
    return null;
  }

  // Force window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 to be callable forever.
  function install(){
    try{
      // capture current value if any
      if (window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 && window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 !== exported){
        _impl = window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2;
      }
      Object.defineProperty(window, 'VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2', {
        configurable: true,
        enumerable: true,
        get: function(){ return exported; },
        set: function(v){
          _impl = v;
          try{ console.log('[VSP][DD] accepted real impl'); }catch(_){}
        }
      });
    }catch(e){
      // fallback (still callable)
      _impl = window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2;
      window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 = exported;
    }
  }

  install();

  // re-assert callable (some old scripts may clobber)
  setInterval(function(){
    try{
      if (window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 !== exported){
        _impl = window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2;
        window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 = exported;
      }
    }catch(_){}
  }, 800);
})();


/* ==== END static/js/vsp_drilldown_artifacts_impl_commercial_v1.js ==== */
;
;
/* ==== BEGIN static/js/vsp_hash_normalize_v1.js ==== */

/* VSP_HASH_NORMALIZE_V1: normalize #tab=... or #route&k=v to #route */
(function(){
  'use strict';
  if (window.__VSP_HASH_NORMALIZE_V1) return;
  window.__VSP_HASH_NORMALIZE_V1 = 1;

  function parseHash(){
    let h = (location.hash || '').replace(/^#/, '').trim();
    if (!h) return { route: 'dashboard', params: {} };

    // split params by '&'
    const parts = h.split('&').filter(Boolean);
    let first = (parts[0] || '').trim();

    // support "#tab=datasource"
    if (first.startsWith('tab=')) first = first.slice(4).trim();
    else {
      // support "tab=" anywhere
      const m = h.match(/(?:^|&)tab=([^&]+)/);
      if (m && m[1]) first = String(m[1]).trim();
    }

    // normalize synonyms
    if (first === 'runs-reports' || first === 'reports') first = 'runs';
    if (first === 'data') first = 'datasource';
    if (first === 'rule-overrides') first = 'rules';

    const params = {};
    for (const p of parts.slice(1)){
      const i = p.indexOf('=');
      if (i > 0){
        const k = decodeURIComponent(p.slice(0,i));
        const v = decodeURIComponent(p.slice(i+1));
        params[k] = v;
      }
    }
    // also parse if first itself is like "datasource?x=y" (rare)
    if (first.includes('?')) first = first.split('?')[0];

    return { route: first || 'dashboard', params };
  }

  function normalize(){
    const { route, params } = parseHash();
    window.__VSP_HASH_ROUTE__ = route;
    window.__VSP_HASH_PARAMS__ = params;

    const target = '#' + route;
    if (location.hash !== target){
      try{
        history.replaceState(null, '', location.pathname + location.search + target);
        // trigger watchers
        window.dispatchEvent(new HashChangeEvent('hashchange'));
      }catch(_){}
    }
  }

  normalize();
  window.addEventListener('hashchange', normalize);
})();


/* ==== END static/js/vsp_hash_normalize_v1.js ==== */
;
;
/* ==== BEGIN static/js/vsp_ui_global_shims_commercial_p0_v1.js ==== */

// VSP_SAFE_DRILLDOWN_HARDEN_P0_V6
/* VSP_FORCE_ASSET_VERSION_P0_V2
 * Force cache-bust for dynamically injected /static/js/*.js scripts.
 */
(function(){
  'use strict';
  if (window.__VSP_FORCE_ASSET_VERSION_P0_V2) return;
  window.__VSP_FORCE_ASSET_VERSION_P0_V2=1;

  function ver(){
    return (window.__VSP_ASSET_V || window.VSP_ASSET_V || '20251217_142944');
  }
  function rewrite(u){
    try {
      if(!u) return u;
      if(u.indexOf('/static/js/') === -1) return u;
      // remove any existing v= param
      u = u.replace(/[?&]v=[^&]+/g, '');
      u = u.replace(/[?&]$/, '');
      var sep = (u.indexOf('?') >= 0) ? '&' : '?';
      return u + sep + 'v=' + encodeURIComponent(ver());
    } catch(_e) {
      return u;
    }
  }

  var _append = Element.prototype.appendChild;
  Element.prototype.appendChild = function(node){
    try {
      if(node && node.tagName === 'SCRIPT' && node.src) node.src = rewrite(node.src);
    } catch(_e) {}
    return _append.call(this, node);
  };

  var _setAttr = Element.prototype.setAttribute;
  Element.prototype.setAttribute = function(name, value){
    try {
      if(this && this.tagName === 'SCRIPT' && (name === 'src' || name === 'SRC') && typeof value === 'string') {
        value = rewrite(value);
      }
    } catch(_e) {}
    return _setAttr.call(this, name, value);
  };
})();

/* VSP_UI_GLOBAL_SHIMS_COMMERCIAL_P0_V1
 * 목적: UI 안정화(P0)
 *  - Fix: __VSP_DD_ART_CALL__(VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2, ...) is not a function
 *  - Fetch fallback: run_status_v2 -> run_status_v1 (+ /v1/<rid>)
 *  - Soft-degrade for missing endpoints (never throw to console)
 */
(function(){
  'use strict';
  



/* VSP_FIX_DRILLDOWN_CALLSITE_P0_V5: safe-call drilldown artifacts (function OR object.open) */
function __VSP_DD_ART_CALL__(h, ...args) {
  try {
    if (typeof h === 'function') return h(...args);
    if (h && typeof h.open === 'function') return h.open(...args);
  } catch(e) { try{console.warn('[VSP][DD_SAFE]', e);}catch(_e){} }
  return null;
}

/* VSP_FIX_DRILLDOWN_CALLSITE_P0_V3: safe-call for drilldown artifacts (function OR object.open) */
function __VSP_DD_ART_CALL__(h, ...args) {
  try {
    if (typeof h === 'function') return h(...args);
    if (h && typeof h.open === 'function') return h.open(...args);
  } catch (e) {
    try { console.warn('[VSP][DD_SAFE] call failed', e); } catch (_e) {}
  }
  return null;
}

if (window.__VSP_UI_GLOBAL_SHIMS_COMMERCIAL_P0_V1) return;
  window.__VSP_UI_GLOBAL_SHIMS_COMMERCIAL_P0_V1 = 1;

  // ---- (A) normalize drilldown artifacts callable BEFORE anyone uses it ----
  function normalizeCallable(v){
    if (typeof v === 'function') return v;
    if (v && typeof v.open === 'function') {
      const obj = v;
      const fn = function(arg){
        try { return obj.open(arg); } catch(e){ try{ console.warn('[VSP][DD] open failed', e);}catch(_){} return null; }
      };
      fn.__wrapped_from_object = true;
      return fn;
    }
    const noop = function(_arg){ return null; };
    noop.__noop = true;
    return noop;
  }

  try{
    let _val = window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2;
    Object.defineProperty(window, 'VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2', {
      configurable: true, enumerable: true,
      get: function(){ return _val; },
      set: function(v){ _val = normalizeCallable(v); }
    });
    window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 = _val;
  }catch(e){
    window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 = normalizeCallable(window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2);
  }

  // ---- (B) fetch fallback (targeted) ----
  const _fetch = window.fetch ? window.fetch.bind(window) : null;

  // VSP_THROTTLE_DASHBOARD_EXTRAS_P0_V2: throttle + cache + cooldown for dashboard extras to avoid spam ERR_NETWORK_CHANGED
  let __vsp_extras_cache_text = '';
  let __vsp_extras_cache_ts = 0;
  let __vsp_extras_last_try = 0;
  let __vsp_extras_last_fail = 0;
  let __vsp_extras_inflight = null;

  function __vsp_resp_json(text, status=200){
    try {
      return new Response(text || '{}', {
        status: status,
        headers: {'content-type':'application/json; charset=utf-8'}
      });
    } catch(_e) {
      // older browsers fallback
      return new Response(text || '{}');
    }
  }

  async function __vsp_fetch_extras_with_cache(url, init){
    const now = Date.now();
    const THROTTLE_MS = 10_000;   // 1 req / 10s
    const COOLDOWN_MS = 30_000;   // after fail, skip 30s
    const CACHE_OK_MS = 120_000;  // serve cache up to 2 min

    // if hidden -> prefer cache (avoid background spam)
    if (document.hidden && (now - __vsp_extras_cache_ts) < CACHE_OK_MS && __vsp_extras_cache_text) {
      return __vsp_resp_json(__vsp_extras_cache_text, 200);
    }

    // cooldown after fail
    if ((now - __vsp_extras_last_fail) < COOLDOWN_MS) {
      if (__vsp_extras_cache_text) return __vsp_resp_json(__vsp_extras_cache_text, 200);
      return __vsp_resp_json('{}', 200);
    }

    // throttle
    if ((now - __vsp_extras_last_try) < THROTTLE_MS) {
      if (__vsp_extras_cache_text) return __vsp_resp_json(__vsp_extras_cache_text, 200);
      return __vsp_resp_json('{}', 200);
    }

    __vsp_extras_last_try = now;

    // de-dup inflight
    if (__vsp_extras_inflight) {
      const t = await __vsp_extras_inflight;
      return __vsp_resp_json(t, 200);
    }

    __vsp_extras_inflight = (async () => {
      try {
        const r = await _fetch(url, init);
        const t = await r.text();
        if (r && r.ok) {
          __vsp_extras_cache_text = t || '{}';
          __vsp_extras_cache_ts = Date.now();
        }
        return (t || '{}');
      } catch(_e) {
        __vsp_extras_last_fail = Date.now();
        return (__vsp_extras_cache_text || '{}');
      } finally {
        __vsp_extras_inflight = null;
      }
    })();

    const txt = await __vsp_extras_inflight;
    return __vsp_resp_json(txt, 200);
  }
  if (_fetch) {
    function parseRidFromUrl(u){
      try{
        const url = new URL(u, window.location.origin);
        return url.searchParams.get('rid') || '';
      }catch(_){ return ''; }
    }
    function swapEndpoint(u, from, to){
      try { return u.replace(from, to); } catch(_) { return u; }
    }
    async function tryFetch(u, init){
      try { return await _fetch(u, init); } catch(_) { return null; }
    }

    window.fetch = async function(input, init){
      const url = (typeof input === 'string') ? input : (input && input.url ? input.url : '');

      // VSP_THROTTLE_DASHBOARD_EXTRAS_P0_V2: intercept dashboard extras first (avoid repeated failed XHR spam)
      if (url && url.includes('/api/vsp/dashboard_v3_extras_v1')) {
        return await __vsp_fetch_extras_with_cache(url, init);
      }
      let res = null;

      // first attempt
      res = await tryFetch(input, init);

      // if ok => return
      if (res && res.ok) return res;

      // targeted fallbacks
      if (url.includes('/api/vsp/run_status_v2')) {
        const rid = parseRidFromUrl(url);
        // 1) v2 -> v1 (same query)
        let u1 = swapEndpoint(url, '/api/vsp/run_status_v2', '/api/vsp/run_status_v1');
        let r1 = await tryFetch(u1, init);
        if (r1 && r1.ok) return r1;

        // 2) path form /run_status_v1/<rid>
        if (rid) {
          let u2 = '/api/vsp/run_status_v1/' + encodeURIComponent(rid);
          let r2 = await tryFetch(u2, init);
          if (r2 && r2.ok) return r2;
        }
        return res || r1 || null;
      }

      if (url.includes('/api/vsp/findings_effective_v1')) {
        const rid = parseRidFromUrl(url);
        // try path form /findings_effective_v1/<rid>
        if (rid) {
          let u2 = '/api/vsp/findings_effective_v1/' + encodeURIComponent(rid);
          let r2 = await tryFetch(u2, init);
          if (r2 && r2.ok) return r2;
        }
        // no hard fallback => return original (avoid throwing)
        return res;
      }

      // default: return original result (even if null)
      return res;
    };
  }
})();

/* __VSP_FIX_DD_ALIAS_P0_V1: make drilldown handler callable even if it is an object (.open) */
(function(){
  'use strict';
  if (window.__VSP_FIX_DD_ALIAS_P0_V1) return;
  window.__VSP_FIX_DD_ALIAS_P0_V1 = 1;

  // Safe call: function OR {open: fn}
  window.__VSP_DD_ART_CALL__ = window.__VSP_DD_ART_CALL__ || function(h){
    try{
      var args = Array.prototype.slice.call(arguments, 1);
      if (typeof h === 'function') return h.apply(null, args);
      if (h && typeof h.open === 'function') return h.open.apply(h, args);
    }catch(e){
      try{ console.warn('[VSP][DD_SAFE]', e); }catch(_){}
    }
    return null;
  };

  // If VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 is NOT a function but exists, wrap it
  try{
    var h = window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2;
    if (h && typeof h !== 'function'){
      window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 = function(){
        return window.__VSP_DD_ART_CALL__.apply(null, [h].concat([].slice.call(arguments)));
      };
      try{ console.log('[VSP][P0] drilldown alias wrapped (obj->fn)'); }catch(_){}
    }
    // If missing entirely, provide a harmless no-op function (avoid hard crash)
    if (!window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2){
      window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 = function(){
        try{ console.warn('[VSP][P0] drilldown handler missing; noop'); }catch(_){}
        return null;
      };
    }
  }catch(e){
    try{ console.warn('[VSP][P0] drilldown alias init failed', e); }catch(_){}
  }
})();



/* ==== END static/js/vsp_ui_global_shims_commercial_p0_v1.js ==== */
;
;
/* ==== BEGIN static/js/vsp_rid_state_v1.js ==== */

/* VSP_RID_STATE_V10 (commercial stable) */
(function(){
  'use strict';

  const LOGP = '[VSP_RID_STATE_V10]';
  const LS_SELECTED = 'vsp_rid_selected_v1';
  const LS_LATEST   = 'vsp_rid_latest_v1';
  const RID_KEYS_QS = ['rid','run_id','runid'];

  function safeLSGet(k){
    try { return localStorage.getItem(k); } catch(e){ return null; }
  }
  function safeLSSet(k,v){
    try { localStorage.setItem(k, v); } catch(e){}
  }

  function qsRid(){
    try{
      const u = new URL(window.location.href);
      for(const k of RID_KEYS_QS){
        const v = u.searchParams.get(k);
        if(v && String(v).trim()) return String(v).trim();
      }
    }catch(e){}
    return null;
  }

  function getRid(){
    return qsRid() || safeLSGet(LS_SELECTED) || safeLSGet(LS_LATEST) || null;
  }

  function updateBadge(rid){
    const txt = `RID: ${rid || '(none)'}`;

    // common ids
    const ids = ['vsp-rid-badge','rid-badge','vsp_rid_badge','vspRidBadge'];
    for(const id of ids){
      const el = document.getElementById(id);
      if(el){ el.textContent = txt; return; }
    }

    // common classes / data attributes
    const el2 = document.querySelector('[data-vsp-rid-badge], .vsp-rid-badge, .rid-badge');
    if(el2){ el2.textContent = txt; return; }

    // fallback: any small element whose text starts with "RID:"
    const all = document.querySelectorAll('body *');
    for(const el of all){
      const t = (el.textContent || '').trim();
      if(t.startsWith('RID:') && t.length < 80){
        el.textContent = txt;
        return;
      }
    }
  }

  function setRid(rid, why){
    const v = (rid && String(rid).trim()) ? String(rid).trim() : null;
    if(!v) return null;
    safeLSSet(LS_SELECTED, v);
    safeLSSet(LS_LATEST, v);
    updateBadge(v);

    try{
      window.dispatchEvent(new CustomEvent('VSP_RID_CHANGED', { detail: { rid: v, why: why || 'set' } }));
    }catch(e){}
    return v;
  }

  async function pickLatestFromRunsIndex(){
    const url = '/api/vsp/runs_index_v3_fs_resolved?limit=1&hide_empty=0&filter=1';
    const r = await fetch(url, { cache: 'no-store' });
    if(!r.ok) throw new Error('runs_index not ok: ' + r.status);
    const j = await r.json();
    const it = (j && j.items && j.items[0]) ? j.items[0] : null;
    const rid = it && (it.run_id || it.rid || it.id);
    if(rid && String(rid).trim()) return String(rid).trim();
    return null;
  }

  async function pickLatest(){
    // 1) optional override: MUST return string RID or null
    try{
      const ov = window.VSP_RID_PICKLATEST_OVERRIDE_V1;
      if(typeof ov === 'function'){
        const v = await ov();
        if(typeof v === 'string' && v.trim()){
          console.log(LOGP, 'picked by override');
          return setRid(v.trim(), 'override');
        }
      }
    }catch(e){
      console.warn(LOGP, 'override failed', e);
    }

    // 2) default: runs_index
    try{
      const rid = await pickLatestFromRunsIndex();
      if(rid){
        console.log(LOGP, 'picked by runs_index', rid);
        return setRid(rid, 'runs_index');
      }
    }catch(e){
      console.warn(LOGP, 'runs_index pickLatest failed', e);
    }

    return null;
  }

  async function ensure(){
    const cur = getRid();
    updateBadge(cur);
    if(cur) return cur;
    return await pickLatest();
  }

  // compatibility exports
  window.VSP_RID_GET = getRid;
  window.VSP_RID_SET = (rid)=>setRid(rid,'manual');
  window.VSP_RID_PICKLATEST = pickLatest;

  document.addEventListener('DOMContentLoaded', ()=>{ ensure(); });
  console.log(LOGP, 'installed');
})();


/* ==== END static/js/vsp_rid_state_v1.js ==== */
;
;
/* ==== BEGIN static/js/vsp_tabs_hash_router_v1.js ==== */

(function () {
  console.log('[VSP_TABS_ROUTER_V1] clean router + header bind loaded');

  const DEFAULT_TAB = 'dashboard';

  function $(id) {
    return document.getElementById(id);
  }

  function fmtInt(n) {
    if (n == null || isNaN(n)) return '--';
    return Number(n).toLocaleString('en-US');
  }

  function fmtDate(s) {
    if (!s) return '--';
    try {
      const d = new Date(s);
      if (isNaN(d.getTime())) return String(s);
      return d.toLocaleString();
    } catch (e) {
      return String(s);
    }
  }

  // ====== PANE SETUP ======
  const PANES = {
    dashboard: 'vsp-dashboard-main',
    runs:      'vsp-runs-main',
    datasource:'vsp-datasource-main',
    settings:  'vsp-settings-main',
    rules:     'panel-rules',
  };

  function ensureExtraPanes() {
    const dash = $(PANES.dashboard);
    if (!dash) {
      console.warn('[VSP_TABS_ROUTER_V1] Không thấy #' + PANES.dashboard + ' – chỉ dùng được dashboard.');
      return;
    }
    const parent = dash.parentNode;
    const baseStyle = dash.getAttribute('style') || '';

    function ensurePane(key) {
      const id = PANES[key];
      if (!$(id)) {
        const div = document.createElement('div');
        div.id = id;
        div.setAttribute('style', baseStyle);
        div.style.display = 'none';
        parent.appendChild(div);
        console.log('[VSP_TABS_ROUTER_V1] Created pane #' + id);
      }
    }

    ensurePane('runs');
    ensurePane('datasource');
    ensurePane('settings');
    ensurePane('rules');
  }

  // ====== HEADER TABS BIND ======

  function getTabNameFromButton(btn) {
    if (!btn) return '';

    let tab =
      btn.getAttribute('data-vsp-tab') ||
      btn.getAttribute('data-tab') ||
      (btn.dataset && (btn.dataset.vspTab || btn.dataset.tab)) ||
      '';

    if (!tab) {
      const href = btn.getAttribute('href');
      if (href && href.indexOf('#') === 0) {
        tab = href.slice(1);
      }
    }

    tab = (tab || '').trim();

    // Map một số tên thường gặp về chuẩn
    if (tab === 'home') tab = 'dashboard';
    if (tab === 'runs-report' || tab === 'runs_reports') tab = 'runs';
    if (tab === 'data') tab = 'datasource';

    return tab;
  }

  function updateActiveHeader(tab) {
    const buttons = document.querySelectorAll(
      '[data-vsp-tab], [data-tab], .vsp-tab-button, .vsp-tab-btn'
    );
    buttons.forEach(function (btn) {
      const t = getTabNameFromButton(btn);
      if (!t) return;
      if (t === tab) {
        btn.classList.add('vsp-tab-active');
      } else {
        btn.classList.remove('vsp-tab-active');
      }
    });
  }

  function bindHeaderTabs() {
    const buttons = document.querySelectorAll(
      '[data-vsp-tab], [data-tab], .vsp-tab-button, .vsp-tab-btn'
    );
    if (!buttons.length) {
      console.warn('[VSP_TABS_ROUTER_V1] Không tìm thấy header tab buttons để bind.');
      return;
    }
    let bound = 0;
    buttons.forEach(function (btn) {
      const tab = getTabNameFromButton(btn);
      if (!tab) return;

      btn.addEventListener('click', function (ev) {
        // Nếu là <a href="#..."> thì chặn default để khỏi nhảy lên đầu trang
        if (ev && typeof ev.preventDefault === 'function') {
          ev.preventDefault();
        }
        console.log('[VSP_TABS_ROUTER_V1] tab click ->', tab);
        window.location.hash = '#' + tab;
      });
      bound++;
    });
    console.log('[VSP_TABS_ROUTER_V1] Bound', bound, 'header tab buttons');
  }

  // ====== RENDER HELPERS ======

  async function fetchRuns(limit) {
    const url = `/api/vsp/runs_index_v3_fs?limit=${limit || 40}`;
    const res = await fetch(url);
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const data = await res.json();
    if (Array.isArray(data)) return data;
    if (Array.isArray(data.items)) return data.items;
    return [];
  }

  function renderRunsPane() {
    
    // === VSP_COMMERCIAL_RUNS_MASTER_GUARD_V1 ===
    if (window.VSP_COMMERCIAL_RUNS_MASTER) {
      console.log('[VSP_TABS_ROUTER_V1] commercial runs master enabled -> skip legacy runs hydrate');
      return;
    }
    // === END VSP_COMMERCIAL_RUNS_MASTER_GUARD_V1 ===
const pane = $(PANES.runs);
    if (!pane) return;
    pane.innerHTML = `
      <div style="padding:16px; font-size:12px; opacity:0.7;">
        Đang tải danh sách runs từ <code>/api/vsp/runs_index_v3</code>...
      </div>
    `;
    fetchRuns(40).then(items => {
      if (!items || items.length === 0) {
        pane.innerHTML = `
          <div style="padding:16px; font-size:13px; opacity:0.7;">
            Không có run nào trong lịch sử (runs_index_v3 trả về rỗng).
          </div>
        `;
        return;
      }

      const rows = items.map(item => {
        const runId   = item.run_id || item.id || '--';
        const runType = item.run_type || item.type || 'FULL_EXT';
        const created = item.started_at || item.created_at || item.created || '';
        const total   = item.total_findings != null ? item.total_findings : (item.total || 0);
        const status  = item.status || item.result || 'DONE';

        return `
          <tr style="border-bottom:1px solid rgba(148,163,184,0.2);">
            <td style="padding:8px 10px; font-size:12px; white-space:nowrap;">
              <code style="font-size:11px; opacity:0.9;">${runId}</code>
            </td>
            <td style="padding:8px 10px; font-size:12px; text-transform:uppercase; opacity:0.8;">
              ${runType}
            </td>
            <td style="padding:8px 10px; font-size:12px;">
              ${fmtDate(created)}
            </td>
            <td style="padding:8px 10px; font-size:12px; text-align:right;">
              ${fmtInt(total)}
            </td>
            <td style="padding:8px 10px; font-size:12px;">
              <span style="
                display:inline-block;
                padding:2px 8px;
                border-radius:999px;
                font-size:11px;
                text-transform:uppercase;
                letter-spacing:0.05em;
                background:rgba(34,197,94,0.12);
                border:1px solid rgba(34,197,94,0.5);
                color:#bbf7d0;
              ">
                ${status}
              </span>
            </td>
          </tr>
        `;
      }).join('');

      pane.innerHTML = `
        <div style="padding:16px 16px 8px 16px;">
          <div style="font-size:12px; text-transform:uppercase; letter-spacing:0.08em; opacity:0.7; margin-bottom:4px;">
            Runs &amp; Reports
          </div>
          <div style="font-size:12px; opacity:0.7; margin-bottom:12px;">
            Lịch sử scan mới nhất từ SECURITY_BUNDLE (runs_index_v3)
          </div>
        </div>
        <div style="padding:0 16px 16px 16px;">
          <div style="overflow:auto; border-radius:10px; border:1px solid rgba(148,163,184,0.25); background:rgba(15,23,42,0.95);">
            <table style="width:100%; border-collapse:collapse; font-family:system-ui, -apple-system, BlinkMacSystemFont, 'Inter', sans-serif; color:#e5e7eb;">
              <thead>
                <tr style="background:rgba(15,23,42,0.98);">
                  <th style="padding:8px 10px; font-size:11px; text-align:left; opacity:0.7; text-transform:uppercase;">Run ID</th>
                  <th style="padding:8px 10px; font-size:11px; text-align:left; opacity:0.7; text-transform:uppercase;">Type</th>
                  <th style="padding:8px 10px; font-size:11px; text-align:left; opacity:0.7; text-transform:uppercase;">Started</th>
                  <th style="padding:8px 10px; font-size:11px; text-align:right; opacity:0.7; text-transform:uppercase;">Total Findings</th>
                  <th style="padding:8px 10px; font-size:11px; text-align:left; opacity:0.7; text-transform:uppercase;">Status</th>
                </tr>
              </thead>
              <tbody>
                ${rows}
              </tbody>
            </table>
          </div>
        </div>
      `;
      console.log('[VSP_TABS_ROUTER_V1] Runs pane hydrated với', items.length, 'items');
    }).catch(e => {
      console.error('[VSP_TABS_ROUTER_V1] Lỗi khi load runs_index_v3', e);
      pane.innerHTML = `
        <div style="padding:16px; font-size:12px; color:#fecaca;">
          Lỗi khi tải runs_index_v3: ${e}
        </div>
      `;
    });
  }

  async function fetchDatasource(limit) {
    const url = `/api/vsp/datasource_v2?limit=${limit || 500}`;
    const res = await fetch(url);
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const data = await res.json();
    if (Array.isArray(data)) return data;
    if (Array.isArray(data.items)) return data.items;
    return [];
  }

  function renderDatasourcePane() {
    const pane = $(PANES.datasource);
    if (!pane) return;
    pane.innerHTML = `
      <div style="padding:16px; font-size:12px; opacity:0.7;">
        Đang tải findings từ <code>/api/vsp/datasource_v2</code>...
      </div>
    `;
    fetchDatasource(500).then(items => {
      if (!items || items.length === 0) {
        pane.innerHTML = `
          <div style="padding:16px; font-size:13px; opacity:0.7;">
            Không có finding nào (datasource_v2 rỗng).
          </div>
        `;
        return;
      }

      const rows = items.slice(0, 300).map((f, idx) => {
        const tool  = f.tool  || f.source || '--';
        const sev   = f.severity || f.level || 'INFO';
        const rule  = f.rule_id || f.check_id || f.rule || '--';
        const file  = f.file || f.path || '--';
        const line  = f.line || f.start_line || f.end_line || '';
        return `
          <tr style="border-bottom:1px solid rgba(148,163,184,0.15);">
            <td style="padding:6px 8px; font-size:11px; opacity:0.7;">${idx + 1}</td>
            <td style="padding:6px 8px; font-size:11px;">${sev}</td>
            <td style="padding:6px 8px; font-size:11px;">${tool}</td>
            <td style="padding:6px 8px; font-size:11px;">${rule}</td>
            <td style="padding:6px 8px; font-size:11px;">${file}</td>
            <td style="padding:6px 8px; font-size:11px; text-align:right;">${line}</td>
          </tr>
        `;
      }).join('');

      pane.innerHTML = `
        <div style="padding:16px 16px 8px 16px;">
          <div style="font-size:12px; text-transform:uppercase; letter-spacing:0.08em; opacity:0.7; margin-bottom:4px;">
            Data Source
          </div>
          <div style="font-size:12px; opacity:0.7; margin-bottom:12px;">
            Bảng unified findings (tối đa 300 dòng, từ datasource_v2)
          </div>
        </div>
        <div style="padding:0 16px 16px 16px;">
          <div style="overflow:auto; border-radius:10px; border:1px solid rgba(148,163,184,0.25); background:rgba(15,23,42,0.95);">
            <table style="width:100%; border-collapse:collapse; font-family:system-ui, -apple-system, BlinkMacSystemFont, 'Inter', sans-serif; color:#e5e7eb;">
              <thead>
                <tr style="background:rgba(15,23,42,0.98);">
                  <th style="padding:6px 8px; font-size:11px; text-align:left; opacity:0.7;">#</th>
                  <th style="padding:6px 8px; font-size:11px; text-align:left; opacity:0.7;">Sev</th>
                  <th style="padding:6px 8px; font-size:11px; text-align:left; opacity:0.7;">Tool</th>
                  <th style="padding:6px 8px; font-size:11px; text-align:left; opacity:0.7;">Rule</th>
                  <th style="padding:6px 8px; font-size:11px; text-align:left; opacity:0.7;">File</th>
                  <th style="padding:6px 8px; font-size:11px; text-align:right; opacity:0.7;">Line</th>
                </tr>
              </thead>
              <tbody>
                ${rows}
              </tbody>
            </table>
          </div>
        </div>
      `;
      console.log('[VSP_TABS_ROUTER_V1] Datasource pane hydrated với', items.length, 'items');
  if (window.vspInitDatasourceTab) {
    try { window.vspInitDatasourceTab(); }
    catch (e) {
      console.error('[VSP_TABS_ROUTER_V1] vspInitDatasourceTab error:', e);
    }
  }
    }).catch(e => {
      console.error('[VSP_TABS_ROUTER_V1] Lỗi khi load datasource_v2', e);
      pane.innerHTML = `
        <div style="padding:16px; font-size:12px; color:#fecaca;">
          Lỗi khi tải datasource_v2: ${e}
        </div>
      `;
    });
  }

  async function fetchJson(url) {
    const res = await fetch(url);
    if (!res.ok) throw new Error('HTTP ' + res.status);
    return await res.json();
  }

  function renderSettingsPane() {
    const pane = $(PANES.settings);
    if (!pane) return;
    pane.innerHTML = `
      <div style="padding:16px; font-size:12px; opacity:0.7;">
        Đang tải settings từ <code>/api/vsp/settings_ui_v1</code>...
      </div>
    `;
    fetchJson('/api/vsp/settings_ui_v1').then(data => {
      const pretty = JSON.stringify(data, null, 2);
      pane.innerHTML = `
        <div style="padding:16px 16px 8px 16px;">
          <div style="font-size:12px; text-transform:uppercase; letter-spacing:0.08em; opacity:0.7; margin-bottom:4px;">
            Settings
          </div>
          <div style="font-size:12px; opacity:0.7; margin-bottom:12px;">
            Cấu hình SECURITY_BUNDLE (settings_ui_v1)
          </div>
        </div>
        <div style="padding:0 16px 16px 16px;">
          <pre style="
            margin:0;
            padding:16px;
            border-radius:10px;
            border:1px solid rgba(148,163,184,0.25);
            background:rgba(15,23,42,0.96);
            font-size:11px;
            line-height:1.4;
            overflow:auto;
            color:#e5e7eb;
          ">${pretty}</pre>
        </div>
      `;
      console.log('[VSP_TABS_ROUTER_V1] Settings pane hydrated');
    }).catch(e => {
      console.error('[VSP_TABS_ROUTER_V1] Lỗi khi load settings_ui_v1', e);
      pane.innerHTML = `
        <div style="padding:16px; font-size:12px; color:#fecaca;">
          Lỗi khi tải settings_ui_v1: ${e}
        </div>
      `;
    });
  }

  function renderRulesPane() {
    const pane = $(PANES.rules);
    if (!pane) return;
    pane.innerHTML = `
      <div style="padding:16px; font-size:12px; opacity:0.7;">
        Đang tải rule overrides từ <code>/api/vsp/rule_overrides_ui_v1</code>...
      </div>
    `;
    fetchJson('/api/vsp/rule_overrides_ui_v1').then(data => {
      const pretty = JSON.stringify(data, null, 2);
      pane.innerHTML = `
        <div style="padding:16px 16px 8px 16px;">
          <div style="font-size:12px; text-transform:uppercase; letter-spacing:0.08em; opacity:0.7; margin-bottom:4px;">
            Rule Overrides
          </div>
          <div style="font-size:12px; opacity:0.7; margin-bottom:12px;">
            Mapping / override rule (rule_overrides_ui_v1)
          </div>
        </div>
        <div style="padding:0 16px 16px 16px;">
          <pre style="
            margin:0;
            padding:16px;
            border-radius:10px;
            border:1px solid rgba(148,163,184,0.25);
            background:rgba(15,23,42,0.96);
            font-size:11px;
            line-height:1.4;
            overflow:auto;
            color:#e5e7eb;
          ">${pretty}</pre>
        </div>
      `;
      console.log('[VSP_TABS_ROUTER_V1] Rules pane hydrated');
    }).catch(e => {
      console.error('[VSP_TABS_ROUTER_V1] Lỗi khi load rule_overrides_ui_v1', e);
      pane.innerHTML = `
        <div style="padding:16px; font-size:12px; color:#fecaca;">
          Lỗi khi tải rule_overrides_ui_v1: ${e}
        </div>
      `;
    });
  }

  // ====== ROUTER ======
  const hydrated = {
    runs: false,
    datasource: false,
    settings: false,
    rules: false,
  };

  function showTab(tab) {
    tab = tab || DEFAULT_TAB;
    console.log('[VSP_TABS_ROUTER_V1] handleHashChange ->', tab);

    Object.keys(PANES).forEach(key => {
      const el = $(PANES[key]);
      if (!el) return;
      el.style.display = (key === tab) ? '' : 'none';
    });

    updateActiveHeader(tab);

    if (tab === 'runs' && !hydrated.runs) {
      hydrated.runs = true;
      renderRunsPane();
    } else if (tab === 'datasource' && !hydrated.datasource) {
      hydrated.datasource = true;
      renderDatasourcePane();
    } else if (tab === 'settings' && !hydrated.settings) {
      hydrated.settings = true;
      renderSettingsPane();
    } else if (tab === 'rules' && !hydrated.rules) {
      hydrated.rules = true;
      renderRulesPane();
    }
  }

  function handleHashChange() {
    const raw = window.location.hash || '';
    const h = raw.replace('#', '') || DEFAULT_TAB;
    showTab(h);
  }

  function init() {
    ensureExtraPanes();
    bindHeaderTabs();
    window.addEventListener('hashchange', handleHashChange);
    handleHashChange();
  }

  if (document.readyState === 'complete' || document.readyState === 'interactive') {
    init();
  } else {
    document.addEventListener('DOMContentLoaded', init);
  }
})();

// === VSP_P2_NORMALIZE_TAB_HASH_V1 ===
(function(){
  try{
    var h = String(window.location.hash || "");
    var m = h.match(/^#tab=([a-z0-9_-]+)(.*)$/i);
    if(m){
      var tab = m[1];
      var rest = m[2] || "";
      window.location.hash = "#" + tab + rest;
    }
  }catch(e){}
})();

// ROUTE_RULES_V1: enabled 'rules' route


/* VSP_ROUTER_THROTTLE_P1_V1_BEGIN */
(function(){
  'use strict';

/* __VSP_DD_SAFE_CALL__ (P0 final): call handler as function OR {open: fn} */
(function(){
  'use strict';
  if (window.__VSP_DD_SAFE_CALL__) return;
  window.__VSP_DD_SAFE_CALL__ = function(handler){
    try{
      var args = Array.prototype.slice.call(arguments, 1);
      if (typeof handler === 'function') return handler.apply(null, args);
      if (handler && typeof handler.open === 'function') return handler.open.apply(handler, args);
    }catch(e){
      try{ console.warn('[VSP][DD_SAFE_CALL]', e); }catch(_){}
    }
    return null;
  };
})();


  if (window.__VSP_ROUTER_THROTTLE_P1_V1) return;
  window.__VSP_ROUTER_THROTTLE_P1_V1 = true;

  const W = window;
  const orig = W.handleHashChange || W.__vspHandleHashChange || null;

  // If file defines handleHashChange in local scope only, fallback: patch hashchange listener to throttle.
  let last = {h:"", t:0};
  function shouldSkip(){
    const h = String(location.hash || "");
    const now = Date.now();
    if (h === last.h && (now - last.t) < 600) return true;
    last = {h, t: now};
    return false;
  }

  // If global handleHashChange exists, wrap it
  if (typeof orig === "function"){
    W.__vspHandleHashChange = orig;
    W.handleHashChange = function(){
      if (shouldSkip()) return;
      return orig.apply(this, arguments);
    };
    console.log("[VSP_ROUTER_THROTTLE_P1_V1] wrapped global handleHashChange");
    return;
  }

  // Otherwise, add throttled listener (does not remove existing; only prevents rapid duplicates)
  W.addEventListener("hashchange", function(ev){
    if (shouldSkip()) return;
  }, true);

  console.log("[VSP_ROUTER_THROTTLE_P1_V1] installed hashchange throttle (capture)");
})();
/* VSP_ROUTER_THROTTLE_P1_V1_END */



/* ==== END static/js/vsp_tabs_hash_router_v1.js ==== */
;
;
/* ==== BEGIN static/js/vsp_ui_features_v1.js ==== */

/* VSP_UI_FEATURES_V1 (route-scoped) */
(function(){
  'use strict';
  window.__VSP_FEATURE_FLAGS__ = window.__VSP_FEATURE_FLAGS__ || {
    DASHBOARD_CHARTS: true,
    RUNS_PANEL: true,
    DATASOURCE_TAB: true,
    SETTINGS_TAB: true,
    RULE_OVERRIDES_TAB: true
  };
})();


/* ==== END static/js/vsp_ui_features_v1.js ==== */
;
;
/* ==== BEGIN static/js/vsp_nav_scroll_autofix_v1.js ==== */

/* VSP_NAV_SCROLL_AUTOFIX_V1: make left nav scrollable even when CSS selector unknown */
(function(){
  function pickNavContainer(anchor){
    // Walk up and find an ancestor that contains multiple nav items (sidebar list)
    let p = anchor;
    for (let i=0; i<20 && p; i++){
      try {
        const items = p.querySelectorAll ? p.querySelectorAll(".vsp-nav-item, a.vsp-tab, a[data-tab]") : [];
        if (items && items.length >= 4) return p;
      } catch(_){}
      p = p.parentElement;
    }
    return null;
  }

  function apply(){
    const tab = document.getElementById("tab-rules");
    if (!tab) return;

    // Ensure it isn't accidentally hidden
    tab.style.display = "";
    tab.style.visibility = "visible";

    const nav = pickNavContainer(tab) || tab.parentElement;
    if (!nav) return;

    // Make scrollable
    nav.style.overflowY = "auto";
    nav.style.maxHeight = "100vh";
    nav.style.webkitOverflowScrolling = "touch";

    // If nav is inside a fixed sidebar, also allow its parent to not clip
    if (nav.parentElement){
      nav.parentElement.style.overflow = "visible";
    }
    console.log("[VSP_NAV_SCROLL_AUTOFIX_V1] applied");
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", apply);
  } else {
    apply();
  }
  window.addEventListener("hashchange", apply);
})();


/* ==== END static/js/vsp_nav_scroll_autofix_v1.js ==== */
;
;
/* ==== BEGIN static/js/vsp_export_guard_v1.js ==== */

/* VSP_EXPORT_GUARD_V1 */
(function () {
  function hidePDF() {
    const sel = [
      'a[href*="fmt=pdf"]',
      'button[data-fmt="pdf"]',
      '[data-export-fmt="pdf"]',
      '[data-vsp-export="pdf"]'
    ].join(",");

    document.querySelectorAll(sel).forEach((n) => {
      n.style.display = "none";
      n.setAttribute("aria-hidden", "true");
    });

    // Heuristic: hide menu items with exact text "PDF"
    document.querySelectorAll("a,button,li,div,span").forEach((n) => {
      const t = (n.textContent || "").trim().toUpperCase();
      if (t === "PDF") {
        // hide container if it's obviously a menu item
        const box = n.closest("li") || n.closest("a") || n;
        box.style.display = "none";
      }
    });
  }

  function interceptPDFClicks() {
    document.addEventListener("click", (e) => {
      const a = e.target.closest && e.target.closest('a[href*="fmt=pdf"]');
      if (!a) return;
      e.preventDefault();
      e.stopPropagation();
      alert("PDF export is disabled in this commercial build. Use HTML or ZIP.");
    }, true);
  }

  window.addEventListener("DOMContentLoaded", () => {
    hidePDF();
    interceptPDFClicks();
    // re-hide after UI rerenders
    setTimeout(hidePDF, 800);
    setTimeout(hidePDF, 1800);
  });
})();


/* ==== END static/js/vsp_export_guard_v1.js ==== */
;
;
/* ==== BEGIN static/js/vsp_runs_verdict_badges_v1.js ==== */

/* VSP_RUNS_VERDICT_BADGES_V2 (batch + gate_policy_v3) */
(function () {

  // VSP_ROUTE_GUARD_RUNS_ONLY_V1
  function __vsp_is_runs_only_v1(){
    try {
      const h = (location.hash||"").toLowerCase();
      return h.startsWith("#runs") || h.includes("#runs/");
    } catch(_) { return false; }
  }
  if(!__vsp_is_runs_only_v1()){
    try{ console.info("[VSP_ROUTE_GUARD_RUNS_ONLY_V1] skip", "vsp_runs_verdict_badges_v1.js", "hash=", location.hash); }catch(_){}
    return;
  }

  const RID_RE = /(RUN_[A-Za-z0-9_]+_\d{8}_\d{6}|VSP_CI_\d{8}_\d{6}|VSP_[A-Z0-9]+_\d{8}_\d{6}|REQ_[A-Za-z0-9_\-]{6,})/;

  function el(tag, props = {}, children = []) {
    const e = document.createElement(tag);
    Object.assign(e, props);
    children.forEach(c => e.appendChild(typeof c === "string" ? document.createTextNode(c) : c));
    return e;
  }

  function ensureModal() {
    let m = document.getElementById("vsp-gate-modal-v1");
    if (m) return m;

    const overlay = el("div", { id: "vsp-gate-modal-v1" });
    overlay.style.position = "fixed";
    overlay.style.inset = "0";
    overlay.style.zIndex = "99999";
    overlay.style.background = "rgba(0,0,0,0.55)";
    overlay.style.display = "none";
    overlay.addEventListener("click", (e) => { if (e.target === overlay) overlay.style.display = "none"; });

    const card = el("div");
    card.style.position = "absolute";
    card.style.top = "10%";
    card.style.left = "50%";
    card.style.transform = "translateX(-50%)";
    card.style.width = "min(900px, 92vw)";
    card.style.maxHeight = "80vh";
    card.style.overflow = "auto";
    card.style.borderRadius = "16px";
    card.style.border = "1px solid rgba(255,255,255,0.16)";
    card.style.background = "rgba(2,6,23,0.96)";
    card.style.padding = "14px 14px";
    card.style.color = "rgba(255,255,255,0.92)";
    card.style.boxShadow = "0 18px 60px rgba(0,0,0,0.45)";

    const header = el("div");
    header.style.display = "flex";
    header.style.alignItems = "center";
    header.style.justifyContent = "space-between";
    header.style.gap = "10px";

    const title = el("div", { id: "vsp-gate-modal-title-v1" });
    title.style.fontWeight = "800";
    title.style.fontSize = "14px";

    const close = el("button", { innerText: "Close" });
    close.style.cursor = "pointer";
    close.style.padding = "6px 10px";
    close.style.borderRadius = "999px";
    close.style.border = "1px solid rgba(255,255,255,0.16)";
    close.style.background = "rgba(15,23,42,0.6)";
    close.style.color = "rgba(255,255,255,0.92)";
    close.addEventListener("click", () => overlay.style.display = "none");

    header.appendChild(title);
    header.appendChild(close);

    const body = el("div", { id: "vsp-gate-modal-body-v1" });
    body.style.marginTop = "10px";
    body.style.fontSize = "12px";
    body.style.lineHeight = "1.5";
    body.style.whiteSpace = "pre-wrap";

    card.appendChild(header);
    card.appendChild(body);
    overlay.appendChild(card);
    document.body.appendChild(overlay);
    return overlay;
  }

  function badgeStyle(verdict) {
    const v = (verdict || "UNKNOWN").toUpperCase();
    const base = {
      display: "inline-flex",
      alignItems: "center",
      gap: "8px",
      fontSize: "11px",
      fontWeight: "800",
      padding: "4px 10px",
      borderRadius: "999px",
      border: "1px solid rgba(255,255,255,0.16)",
      background: "rgba(15,23,42,0.65)",
      cursor: "pointer",
      userSelect: "none",
      whiteSpace: "nowrap",
    };
    if (v.includes("RED") || v.includes("FAIL")) base.boxShadow = "0 0 0 1px rgba(239,68,68,0.25) inset";
    else if (v.includes("AMBER") || v.includes("WARN")) base.boxShadow = "0 0 0 1px rgba(245,158,11,0.25) inset";
    else if (v.includes("GREEN") || v.includes("PASS")) base.boxShadow = "0 0 0 1px rgba(34,197,94,0.25) inset";
    else base.boxShadow = "0 0 0 1px rgba(148,163,184,0.25) inset";
    return base;
  }

  function attachBadge(target, rid, gp) {
    if (!target || !rid || !gp) return;
    if (target.querySelector?.(`[data-vsp-gate-badge="1"][data-rid="${rid}"]`)) return;

    const verdict = (gp.verdict || "UNKNOWN").toUpperCase();
    const degN = Number(gp.degraded_n || 0);

    const b = el("span");
    b.dataset.vspGateBadge = "1";
    b.dataset.rid = rid;
    b.innerText = `VERDICT: ${verdict}${degN ? ` · DEG:${degN}` : ""}`;
    Object.assign(b.style, badgeStyle(verdict));

    b.addEventListener("click", () => {
      const overlay = ensureModal();
      const title = document.getElementById("vsp-gate-modal-title-v1");
      const body = document.getElementById("vsp-gate-modal-body-v1");
      title.textContent = `Run: ${rid} · Verdict: ${verdict}${degN ? ` · DEG:${degN}` : ""}`;

      const reasons = Array.isArray(gp.reasons) ? gp.reasons : (gp.reasons ? [String(gp.reasons)] : []);
      const degItems = Array.isArray(gp.degraded_items) ? gp.degraded_items : [];

      const lines = [];
      lines.push(`Source: ${gp.source || "unknown"}`);
      lines.push("");
      lines.push("Reasons:");
      if (reasons.length) reasons.forEach((x) => lines.push(`- ${x}`));
      else lines.push("- (none)");
      lines.push("");
      lines.push("Degraded:");
      if (degItems.length) degItems.forEach((x) => lines.push(`- ${x}`));
      else lines.push("- (none)");

      body.textContent = lines.join("\n");
      overlay.style.display = "block";
    });

    target.appendChild(document.createTextNode(" "));
    target.appendChild(b);
  }

  function extractRidFromNode(node) {
    const txt = (node?.innerText || node?.textContent || "").trim();
    const m1 = txt.match(RID_RE);
    if (m1) return m1[1];
    const a = node?.querySelector?.("a[href]") || null;
    if (a) {
      const m2 = a.getAttribute("href").match(RID_RE);
      if (m2) return m2[1];
    }
    return null;
  }

  async function loadRunsIndexMap() {
    try {
      const r = await fetch("/api/vsp/runs_index_v3_fs_resolved?limit=80&hide_empty=0&filter=1");
      if (!r.ok) return new Map();
      const j = await r.json();
      const items = j?.items || [];
      const m = new Map();
      items.forEach((it) => {
        const rid = it.run_id || it.id || it.rid;
        const ci = it.ci_run_dir || it.ci || it.run_dir;
        if (rid && ci) m.set(String(rid), String(ci));
      });
      return m;
    } catch {
      return new Map();
    }
  }

  async function fetchBatch(ridToCi) {
    const items = Array.from(ridToCi.entries()).map(([rid, ci_run_dir]) => ({ rid, ci_run_dir }));
    const r = await fetch("/api/vsp/gate_policy_batch_v1", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ items })
    });
    if (!r.ok) return [];
    const j = await r.json();
    return j?.items || [];
  }

  async function patchDashboardHeader() {
    const anchor =
      document.querySelector(".vsp-page-title") ||
      document.querySelector("h1") ||
      document.querySelector(".dashboard-title") ||
      null;
    if (!anchor) return;

    try {
      const dRes = await fetch("/api/vsp/dashboard_v3");
      if (!dRes.ok) return;
      const d = await dRes.json();
      const rid = d?.run_id || d?.latest_run_id || d?.current_run_id;
      if (!rid) return;

      // resolve ci_run_dir via run_status_v2 (cheap, 1 call)
      const sRes = await fetch(`/api/vsp/run_status_v2/${encodeURIComponent(rid)}`);
      const st = sRes.ok ? await sRes.json() : {};
      const ci = st?.ci_run_dir || null;

      const u = `/api/vsp/gate_policy_v3/${encodeURIComponent(rid)}${ci ? `?ci_run_dir=${encodeURIComponent(ci)}` : ""}`;
      const gRes = await fetch(u);
      if (!gRes.ok) return;
      const gp = await gRes.json();
      if (!gp || gp.ok === false) return;

      attachBadge(anchor.parentElement || anchor, rid, gp);
    } catch {}
  }

  async function patchRunsTable() {
    const roots = Array.from(document.querySelectorAll("table, .vsp-table, .runs-table, .vsp-runs, #tab-runs, [data-tab='runs']"));
    const scope = roots.length ? roots : [document.body];

    const ridToTargets = new Map();
    scope.forEach((root) => {
      const rows = root.querySelectorAll("tr, .row, .vsp-row, li, .vsp-run-item");
      rows.forEach((row) => {
        const rid = extractRidFromNode(row);
        if (!rid) return;
        if (!ridToTargets.has(rid)) ridToTargets.set(rid, []);
        ridToTargets.get(rid).push(row);
      });
    });

    const rids = Array.from(ridToTargets.keys()).slice(0, 50);
    if (!rids.length) return;

    const idx = await loadRunsIndexMap();
    const ridToCi = new Map();
    rids.forEach((rid) => {
      const ci = idx.get(rid) || idx.get(rid.replace(/^RUN_/, "")) || null;
      ridToCi.set(rid, ci);
    });

    const items = await fetchBatch(ridToCi);
    const byRid = new Map();
    items.forEach((it) => byRid.set(it.run_id, it));

    rids.forEach((rid) => {
      const gp = byRid.get(rid) || null;
      if (!gp) return;
      (ridToTargets.get(rid) || []).forEach((row) => {
        const place = row.querySelector("td") || row.querySelector(".title") || row.querySelector("a") || row;
        attachBadge(place, rid, gp);
      });
    });
  }

  window.addEventListener("DOMContentLoaded", () => {
    patchDashboardHeader();
    setTimeout(patchRunsTable, 600);
    setTimeout(patchRunsTable, 1600);
  });
})();


/* ==== END static/js/vsp_runs_verdict_badges_v1.js ==== */
;
;
/* ==== BEGIN static/js/vsp_runs_tab_resolved_v1.js ==== */

// VSP_SAFE_DRILLDOWN_HARDEN_P0_V6
/* VSP_RUNS_TAB_RESOLVED_V3 (P1 commercial): use runs_index flags only (NO per-row status fetch) */

/* __VSP_DD_HANDLER_WRAP_P0_FINAL: normalize VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 to callable */
(function(){
  'use strict';

/* VSP_DD_ART_CALL_V1: commercial stable wrapper (fn OR {open:fn}) */
(function(){
  'use strict';
  if (window.VSP_DD_ART_CALL_V1) return;
  window.VSP_DD_ART_CALL_V1 = function(){
    var h = window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2;
    var args = Array.prototype.slice.call(arguments);
    try{
      if (typeof h === 'function') return h.apply(null, args);
      if (h && typeof h.open === 'function') return h.open.apply(h, args);
    }catch(e){
      try{ console.warn('[VSP][DD_CALL_V1]', e); }catch(_){}
    }
    return null;
  };
})();


  try{
    var h = window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2;
    if (h && typeof h !== 'function'){
      window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 = function(){
        return (window.__VSP_DD_SAFE_CALL__ || function(x){
          try{
            var a=[].slice.call(arguments,1);
            if (typeof x==='function') return x.apply(null,a);
            if (x && typeof x.open==='function') return x.open.apply(x,a);
          }catch(_){}
          return null;
        }).apply(null, [h].concat([].slice.call(arguments)));
      };
      try{ console.log('[VSP][P0] drilldown handler wrapped (obj->fn)'); }catch(_){}
    }
  }catch(e){}
})();

(function(){
  'use strict';

  // VSP_ROUTE_GUARD_RUNS_ONLY_V1
  function __vsp_is_runs_only_v1(){
    try {
      const h = (location.hash||"").toLowerCase();
      return h.startsWith("#runs") || h.includes("#runs/");
    } catch(_) { return false; }
  }
  if(!__vsp_is_runs_only_v1()){
    try{ console.info("[VSP_ROUTE_GUARD_RUNS_ONLY_V1] skip", "vsp_runs_tab_resolved_v1.js", "hash=", location.hash); }catch(_){}
    return;
  }


  if (window.__VSP_RUNS_V3_INITED) return;
  window.__VSP_RUNS_V3_INITED = true;

  const API_RUNS = "/api/vsp/runs_index_v3_fs_resolved";
  const API_STATUS = "/api/vsp/run_status_v2"; // link only
  const EXPORT_BASE = "/api/vsp/run_export_v3";
  const ART_BASE = "/api/vsp/artifacts_index_v1";

  function $(sel, root){ return (root||document).querySelector(sel); }
  function $all(sel, root){ return Array.from((root||document).querySelectorAll(sel)); }
  function esc(s){ return String(s ?? "").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
  function visibleEl(el){
    if (!el) return false;
    const r = el.getBoundingClientRect();
    return !!(el.offsetParent !== null && r.width > 240 && r.height > 160);
  }
  function pickBestContainer(){
    const cands = [
      "#tab-runs","#vsp4-runs","[data-tab='runs']","#runs",
      "#tabpane-runs","#pane-runs","#panel-runs",
      ".tab-pane.active",".tab-pane.is-active",
      ".vsp-main",".vsp-content","main",".content","#content",".page-content",
      "body"
    ];
    let best = document.body, bestArea = 0;
    for (const sel of cands){
      for (const el of $all(sel)){
        if (!visibleEl(el)) continue;
        const r = el.getBoundingClientRect();
        const area = r.width * r.height;
        if (area > bestArea){
          bestArea = area;
          best = el;
        }
      }
    }
    return best || document.body;
  }

  function boolAttr(v){
    if (v === true) return "1";
    if (v === false) return "0";
    return "?";
  }

  function normalizeItems(json){
    const items = (json && (json.items || json.data || json.runs)) || [];
    return Array.isArray(items) ? items : [];
  }

  function ensureUI(root){
    let tb = $("#vsp-runs-toolbar", root);
    if (!tb){
      tb = document.createElement("div");
      tb.id = "vsp-runs-toolbar";
      tb.className = "vsp-card vsp-card--tight";
      tb.style.marginBottom = "10px";
      tb.innerHTML = `
        <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
          <div style="display:flex; gap:8px; align-items:center;">
            <label style="opacity:.9">Limit</label>
            <select id="vsp-runs-limit" class="vsp-input">
              <option value="10">10</option>
              <option value="20">20</option>
              <option value="50" selected>50</option>
              <option value="100">100</option>
              <option value="200">200</option>
            </select>
          </div>

          <div style="display:flex; gap:8px; align-items:center;">
            <label style="opacity:.9">Has findings</label>
            <select id="vsp-runs-filter-hf" class="vsp-input">
              <option value="all" selected>All</option>
              <option value="1">Yes</option>
              <option value="0">No</option>
              <option value="?">Unknown</option>
            </select>
          </div>

          <div style="display:flex; gap:8px; align-items:center;">
            <label style="opacity:.9">Degraded</label>
            <select id="vsp-runs-filter-deg" class="vsp-input">
              <option value="all" selected>All</option>
              <option value="1">Yes</option>
              <option value="0">No</option>
              <option value="?">Unknown</option>
            </select>
          </div>

          <div style="display:flex; gap:8px; align-items:center; flex:1; min-width:240px;">
            <label style="opacity:.9">Search</label>
            <input id="vsp-runs-search" class="vsp-input" placeholder="run_id / target / status..." style="flex:1; min-width:180px;" />
          </div>

          <button id="vsp-runs-refresh" class="vsp-btn">Refresh</button>
          <span id="vsp-runs-meta" style="opacity:.8"></span>
        </div>
      `;
      root.prepend(tb);
    }

    let table = $("#vsp-runs-table", root);
    if (!table){
      table = document.createElement("table");
      table.id = "vsp-runs-table";
      table.className = "vsp-table";
      table.style.width = "100%";
      table.innerHTML = `
        <thead>
          <tr>
            <th style="width:200px;">Time</th>
            <th>Run ID</th>
            <th style="width:140px;">Target</th>
            <th style="width:120px;">Status</th>
            <th style="width:140px;">Findings</th>
            <th style="width:140px;">Degraded</th>
            <th style="width:220px;">Actions</th>
          </tr>
        </thead>
        <tbody id="vsp-runs-tbody"></tbody>
      `;
      root.insertBefore(table, tb.nextSibling);
    }

    const tbody = $("#vsp-runs-tbody", root) || table.querySelector("tbody");
    return {tb, table, tbody};
  }

  function renderRow(item){
    const rid = String(item.run_id || item.rid || item.id || "");
    const created = item.ts || item.created_at || item.created || item.time || item.started_at || "";
    const target = item.target_id || item.target || item.profile || item.app || "";
    const status = item.status || item.stage || item.state || "";

    const total = (typeof item.total_findings === "number") ? item.total_findings : null;
    const hasF = (typeof item.has_findings === "boolean") ? item.has_findings : (total !== null ? total > 0 : null);
    const dn = (typeof item.degraded_n === "number") ? item.degraded_n : null;
    const da = (typeof item.degraded_any === "boolean") ? item.degraded_any : (dn !== null ? dn > 0 : null);

    const hfAttr = boolAttr(hasF);
    const dgAttr = boolAttr(da);

    const hfText =
      hfAttr === "1" ? `YES${(typeof total === "number") ? ` (${total})` : ""}` :
      hfAttr === "0" ? `NO${(typeof total === "number") ? " (0)" : ""}` :
      "UNKNOWN";

    const dgText =
      dgAttr === "1" ? `YES${(typeof dn === "number") ? ` (${dn})` : ""}` :
      dgAttr === "0" ? `NO${(typeof dn === "number") ? " (0)" : ""}` :
      "UNKNOWN";

    const tr = document.createElement("tr");
    tr.dataset.rid = rid;
    tr.setAttribute("data-has-findings", hfAttr);
    tr.setAttribute("data-degraded", dgAttr);

    tr.innerHTML = `
      <td>${esc(created)}</td>
      <td><code>${esc(rid)}</code></td>
      <td>${esc(target)}</td>
      <td>${esc(status)}</td>
      <td><span class="vsp-pill" data-role="hf">${esc(hfText)}</span></td>
      <td><span class="vsp-pill" data-role="deg">${esc(dgText)}</span></td>
      <td style="display:flex; gap:8px; flex-wrap:wrap;">
        <a class="vsp-btn vsp-btn--ghost" href="${esc(API_STATUS + "/" + encodeURIComponent(rid))}" target="_blank" rel="noopener">status</a>
        <a class="vsp-btn vsp-btn--ghost" href="${esc(ART_BASE + "/" + encodeURIComponent(rid))}" target="_blank" rel="noopener">artifacts</a>
        <a class="vsp-btn vsp-btn--ghost" href="${esc("/api/vsp/run_export_cio_v2/" + encodeURIComponent(rid) + "?fmt=html")}" target="_blank" rel="noopener">cio</a>
<a class="vsp-btn vsp-btn--ghost" href="${esc(EXPORT_BASE + "/" + encodeURIComponent(rid) + "?fmt=html")}" target="_blank" rel="noopener">html</a>
        <a class="vsp-btn vsp-btn--ghost" href="${esc(EXPORT_BASE + "/" + encodeURIComponent(rid) + "?fmt=zip")}" target="_blank" rel="noopener">zip</a>
        <a class="vsp-btn vsp-btn--ghost" href="${esc(EXPORT_BASE + "/" + encodeURIComponent(rid) + "?fmt=pdf")}" target="_blank" rel="noopener">pdf</a>
      </td>
    `;
    return tr;
  }

  function applyFilters(root){
    const hf = $("#vsp-runs-filter-hf", root)?.value || "all";
    const dg = $("#vsp-runs-filter-deg", root)?.value || "all";
    const q  = ($("#vsp-runs-search", root)?.value || "").trim().toLowerCase();

    const rows = $all("#vsp-runs-tbody tr", root);
    let shown = 0;

    for (const tr of rows){
      const rhf = tr.getAttribute("data-has-findings") || "?";
      const rdg = tr.getAttribute("data-degraded") || "?";

      let ok = true;
      if (hf !== "all" && rhf !== hf) ok = false;
      if (dg !== "all" && rdg !== dg) ok = false;

      if (ok && q){
        const hay = (tr.textContent || "").toLowerCase();
        if (!hay.includes(q)) ok = false;
      }

      tr.hidden = !ok;
      if (ok) shown++;
    }

    const meta = $("#vsp-runs-meta", root);
    if (meta) meta.textContent = `Showing ${shown}/${rows.length}`;
  }

  async function loadRuns(root){
    const limit = parseInt($("#vsp-runs-limit", root)?.value || "50", 10) || 50;
    const url = `${API_RUNS}?limit=${encodeURIComponent(String(limit))}&hide_empty=0&filter=1`;

    const meta = $("#vsp-runs-meta", root);
    if (meta) meta.textContent = "Loading runs...";

    const r = await fetch(url, {credentials:"same-origin"});
    const json = await r.json().catch(() => ({}));
    const items = normalizeItems(json);

    window.__vspRunsItems = items;

    const {tbody} = ensureUI(root);
    tbody.innerHTML = "";
    for (const it of items){
      tbody.appendChild(renderRow(it));
    }

    applyFilters(root);
    if (meta) meta.textContent = `Loaded ${items.length} (flags from runs_index).`;
  }

  function bind(root){
    $("#vsp-runs-refresh", root)?.addEventListener("click", () => loadRuns(root).catch(e => console.error("[VSP_RUNS] load error", e)));
    $("#vsp-runs-limit", root)?.addEventListener("change", () => loadRuns(root).catch(e => console.error("[VSP_RUNS] load error", e)));

    const onFilter = () => applyFilters(root);
    $("#vsp-runs-filter-hf", root)?.addEventListener("change", onFilter);
    $("#vsp-runs-filter-deg", root)?.addEventListener("change", onFilter);
    $("#vsp-runs-search", root)?.addEventListener("input", onFilter);
  }

  function init(){
    const root = pickBestContainer();
    ensureUI(root);
    bind(root);
    loadRuns(root).catch(e => console.error("[VSP_RUNS] init load error", e));
  }

  if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", init);
  else init();
})();


/* ==== END static/js/vsp_runs_tab_resolved_v1.js ==== */
;
;
/* ==== BEGIN static/js/vsp_datasource_tab_v1.js ==== */

/* VSP_DATASOURCE_TAB_V1 (commercial P1): RID -> findings_unified API + filters + paging */
(function(){
  'use strict';

  function normalizeRid(x){
    x = String(x||"").trim();
    // common: RUN_<RID>
    x = x.replace(/^RUN[_\s]+/i, "");
    // try extract canonical VSP_CI_YYYYmmdd_HHMMSS
    const m = x.match(/(VSP_CI_\d{8}_\d{6})/i);
    if (m) return m[1];
    // fallback: collapse spaces -> underscores
    x = x.replace(/\s+/g, "_");
    return x;
  }



  const $ = (sel, root=document) => root.querySelector(sel);

  async function getActiveRid(){
    // Prefer rid state injected by vsp_rid_state_v1.js (your template already loads it)
    try{
      if (window.VSP_RID_STATE && typeof window.VSP_RID_STATE.get === "function"){
        const r = window.VSP_RID_STATE.get();
        if (r) return r;
      }
    }catch(_){}

    // Fallback: dashboard_v3 run_id (best-effort)
    try{
      const j = await fetch("/api/vsp/dashboard_v3").then(r=>r.json());
      if (j && j.run_id) return j.run_id;
    }catch(_){}

    return null;
  }

  function esc(s){
    return String(s ?? "").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  function renderTable(items){
    const host = $("#vsp4-datasource-table") || $("#datasource-table") || $("#tab-datasource");
    if (!host) return;

    const rows = (items||[]).map(it=>{
      const sev = esc(it.severity||"");
      const tool = esc(it.tool||"");
      const title = esc(it.title||"");
      const file = esc(it.file||"");
      const line = esc(it.line||"");
      const cwe = Array.isArray(it.cwe) ? esc(it.cwe[0]||"") : esc(it.cwe||"");
      return `<tr>
        <td class="vsp-mono">${sev}</td>
        <td class="vsp-mono">${tool}</td>
        <td>${title}</td>
        <td class="vsp-mono">${cwe}</td>
        <td class="vsp-mono">${file}:${line}</td>
      </tr>`;
    }).join("");

    host.innerHTML = `
      <div class="vsp-row" style="gap:10px; align-items:center; margin:10px 0;">
        <input id="ds-q" class="vsp-input" style="min-width:260px" placeholder="search title/file/id..." />
        <input id="ds-file" class="vsp-input" style="min-width:220px" placeholder="file contains..." />
        <select id="ds-sev" class="vsp-input">
          <option value="">SEV (all)</option>
          <option>CRITICAL</option><option>HIGH</option><option>MEDIUM</option>
          <option>LOW</option><option>INFO</option><option>TRACE</option>
        </select>
        <select id="ds-tool" class="vsp-input" style="min-width:180px"><option value="">TOOL (all)</option></select>
        <input id="ds-cwe" class="vsp-input" style="min-width:140px" placeholder="CWE-79" />
        <button id="ds-go" class="vsp-btn">Apply</button>
        <span id="ds-meta" class="vsp-muted" style="margin-left:auto;"></span>
      </div>
      <div class="vsp-row" style="gap:10px; align-items:center; margin:10px 0;">
        <button id="ds-prev" class="vsp-btn vsp-btn-ghost">Prev</button>
        <button id="ds-next" class="vsp-btn vsp-btn-ghost">Next</button>
        <input id="ds-limit" class="vsp-input" style="width:90px" value="50" />
        <span class="vsp-muted">limit (1..500)</span>
      </div>
      <div class="vsp-card" style="overflow:auto;">
        <table class="vsp-table" style="min-width:1100px">
          <thead><tr>
            <th>Severity</th><th>Tool</th><th>Title</th><th>CWE</th><th>File:Line</th>
          </tr></thead>
          <tbody>${rows || `<tr><td colspan="5" class="vsp-muted">No items</td></tr>`}</tbody>
        </table>
      </div>
    `;
  }

  function populateToolOptions(byTool){
    const sel = document.querySelector('#ds-tool');
    if(!sel) return;
    const cur = sel.value || '';
    const keys = Object.keys(byTool||{}).sort((a,b)=>String(a).localeCompare(String(b)));
    sel.innerHTML = '<option value="">TOOL (all)</option>' + keys.map(k=>`<option value="${k}">${k} (${byTool[k]})</option>`).join('');
    if(cur) sel.value = cur;
  }

  async function load(page){
    const rid = normalizeRid(normalizeRid(await getActiveRid()));
    const meta = $("#ds-meta");
    if (!rid){
      renderTable([]);
      if (meta) meta.textContent = "RID: (missing)";
      return;
    }

    const q = ($("#ds-q")?.value || "").trim();
    const fileq = ($("#ds-file")?.value || "").trim();
    const sev = ($("#ds-sev")?.value || "").trim();
    const tool = ($("#ds-tool")?.value || "").trim();
    const cwe = ($("#ds-cwe")?.value || "").trim();
    const limit = parseInt(($("#ds-limit")?.value || "50"), 10) || 50;

    const params = new URLSearchParams();
    params.set("page", String(page||1));
    params.set("limit", String(limit));
    if (q) params.set("q", q);
    if (fileq) params.set("file", fileq);
    if (sev) params.set("sev", sev);
    if (tool) params.set("tool", tool);
    if (cwe) params.set("cwe", cwe);

    const url = `/api/vsp/findings_unified_v2/${encodeURIComponent(rid)}?` + params.toString();
    const j = await fetch(url).then(r=>r.json()).catch(()=>null);

    if (!j){
      renderTable([]);
      if (meta) meta.textContent = `RID=${rid} | fetch failed`;
      return;
    }

    if (j.warning && j.warning.includes("run_dir_not_found")){
      renderTable([]);
      if (meta) meta.textContent = `RID=${rid} | run_dir_not_found (RID state not persisted?)`;
      return;
    }

    renderTable(j.items || []);
    try{ populateToolOptions((j.counts||{}).by_tool||{}); }catch(_){ }

    const total = j.total ?? 0;
    const p = j.page ?? 1;
    const l = j.limit ?? limit;
    const start = total ? ((p-1)*l + 1) : 0;
    const end = Math.min(total, (p*l));
    const src = j.resolve_source || "-";
    const warn = j.warning ? ` | ${j.warning}` : "";
    const sevCounts = (j.counts||{}).by_sev||{};
const sevMini = Object.keys(sevCounts).sort().map(k=>`${k}:${sevCounts[k]}`).join(" ");
if ($("#ds-meta")) $("#ds-meta").textContent = `RID=${rid} | ${start}-${end}/${total} | ${sevMini} | src=${src}${warn}`;

    // wire buttons
    $("#ds-go")?.addEventListener("click", ()=>load(1));
    $("#ds-prev")?.addEventListener("click", ()=>load(Math.max(1, (p-1))));
    $("#ds-next")?.addEventListener("click", ()=>load((p+1)));
  }

  // expose for debugging
  window.VSP_DS_P1 = { reload: ()=>load(1) };

  // auto-load when tab exists
  document.addEventListener("DOMContentLoaded", ()=> {
    // First render shell then load data
    renderTable([]);
    load(1);
  });
})();


/* ==== END static/js/vsp_datasource_tab_v1.js ==== */
;
;
/* ==== BEGIN static/js/vsp_rule_overrides_tab_v1.js ==== */

/* VSP_RULE_OVERRIDES_GUARD_V2_BEGIN */
(function(){
  'use strict';
  if (typeof window === 'undefined') return;

  window.__vspGetRidSafe = async function(){
    try{
      if (typeof window.VSP_RID_PICKLATEST_OVERRIDE_V1 === 'function'){
        const rid = await window.VSP_RID_PICKLATEST_OVERRIDE_V1();
        if (rid) return rid;
      }
    }catch(_e){}
    try{
      if (window.VSP_RID_STATE && typeof window.VSP_RID_STATE.pickLatest === 'function'){
        const rid = await window.VSP_RID_STATE.pickLatest();
        if (rid) return rid;
      }
    }catch(_e){}
    return null;
  };
})();
 /* VSP_RULE_OVERRIDES_GUARD_V2_END */

/* VSP_RULEOVERRIDES_GUARD_V1_BEGIN */
// commercial safety: don't crash if rid override hook not present
try {
  if (!window.VSP_RID_PICKLATEST_OVERRIDE_V1) {
    window.VSP_RID_PICKLATEST_OVERRIDE_V1 = function(items) {
      return (items && items[0]) ? items[0] : null;
    };
  }
} catch(e) {}
/* VSP_RULEOVERRIDES_GUARD_V1_END */
/* VSP_RULE_OVERRIDES_TAB_V1: clean + CRUD (GET/POST) */
(function(){

const API = "/api/vsp/rule_overrides_v1";
  const $ = (id)=>document.getElementById(id);

  function esc(s){
    return String(s==null?'':s)
      .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;").replace(/'/g,"&#39;");
  }
  function nowIsoDate(){
    const d=new Date(); const y=d.getFullYear();
    const m=String(d.getMonth()+1).padStart(2,'0');
    const day=String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${day}`;
  }
  function msg(t, kind){
    const el=$("rules-msg");
    if(!el) return;
    el.textContent = t || "";
    el.style.opacity = t ? "1" : "0.85";
    el.style.color = kind==="err" ? "rgba(248,113,113,0.95)" : "rgba(148,163,184,0.95)";
  }

  function normalizeFromApi(obj){
    // Accept: {version,items:[...]} OR {meta,overrides:[...]}
    if(!obj || typeof obj!=='object') return {version:1, items:[]};
    if(Array.isArray(obj.items)) return {version: obj.version||1, items: obj.items||[]};
    if(Array.isArray(obj.overrides)) return {version: 1, items: obj.overrides||[]};
    if(obj.meta && Array.isArray(obj.meta.overrides)) return {version: 1, items: obj.meta.overrides||[]};
    return {version: 1, items: []};
  }

  function toPostPayload(state){
    // Prefer commercial schema you already used:
    // {meta:{version:"v1"}, overrides:[{match:{...}, set:{...}, action, justification, expires_at, id}]}
    return { meta:{version:"v1"}, overrides: (state.items||[]).map(x=>x||{}) };
  }

  async function apiGet(){
    const r = await fetch(API, { cache:"no-store", credentials:"same-origin" });
    if(!r.ok) throw new Error("GET failed: "+r.status);
    return await r.json();
  }
  async function apiSave(payload){
    const r = await fetch(API, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(payload),
      credentials:"same-origin",
    });
    if(!r.ok){
      const t = await r.text().catch(()=> "");
      throw new Error("POST failed: "+r.status+" "+t.slice(0,200));
    }
    return await r.json();
  }

  function render(container, state){
    const items = Array.isArray(state.items) ? state.items : [];
    const html = `
      <div class="vsp-card" style="margin:12px 0; padding:14px;">
        <div style="display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;">
          <div>
            <div style="font-weight:800; font-size:16px;">Rule Overrides</div>
            <div style="opacity:.75; font-size:12px;">API: <code>${esc(API)}</code></div>
          </div>
          <div style="display:flex; gap:8px; align-items:center;">
            <button class="vsp-btn vsp-btn-soft" id="rules-reload">Reload</button>
            <button class="vsp-btn vsp-btn-soft" id="rules-add">Add</button>
            <button class="vsp-btn vsp-btn-primary" id="rules-save">Save</button>
          </div>
        </div>
        <div id="rules-msg" style="margin-top:10px; font-size:12px; opacity:.9;"></div>
      </div>

      <div class="vsp-card" style="padding:0; overflow:auto;">
        <table style="width:100%; border-collapse:collapse;">
          <thead>
            <tr style="text-align:left; font-size:12px; opacity:.85;">
              <th style="padding:10px 12px; border-bottom:1px solid rgba(255,255,255,.06);">ID</th>
              <th style="padding:10px 12px; border-bottom:1px solid rgba(255,255,255,.06);">Match (JSON)</th>
              <th style="padding:10px 12px; border-bottom:1px solid rgba(255,255,255,.06);">Action</th>
              <th style="padding:10px 12px; border-bottom:1px solid rgba(255,255,255,.06);">Set (JSON)</th>
              <th style="padding:10px 12px; border-bottom:1px solid rgba(255,255,255,.06);">Justification</th>
              <th style="padding:10px 12px; border-bottom:1px solid rgba(255,255,255,.06);">Expires</th>
              <th style="padding:10px 12px; border-bottom:1px solid rgba(255,255,255,.06);">Ops</th>
            </tr>
          </thead>
          <tbody id="rules-body"></tbody>
        </table>
      </div>

      <div class="vsp-card" style="margin:12px 0; padding:14px;">
        <div style="font-weight:700; margin-bottom:8px;">Raw JSON editor</div>
        <textarea id="rules-json" spellcheck="false"
          style="width:100%; min-height:240px; font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
          font-size:12px; padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,.08);
          background:rgba(255,255,255,.03); color:inherit;"></textarea>
        <div style="margin-top:8px; opacity:.75; font-size:12px;">
          Tip: bạn có thể sửa JSON trực tiếp rồi bấm <b>Save</b>.
        </div>
      </div>
    `;
    container.innerHTML = html;

    const tb = $("rules-body");
    const tx = $("rules-json");

    function rowToInputs(it, idx){
      const id = it.id || (`ovr_${idx+1}`);
      const match = it.match || {};
      const action = it.action || (it.set && Object.keys(it.set).length ? "set" : "suppress");
      const setObj = it.set || {};
      const justification = it.justification || "";
      const expires_at = it.expires_at || (new Date().getFullYear()+1)+"-12-31";

      return `
        <tr data-idx="${idx}" style="border-bottom:1px solid rgba(255,255,255,.06); font-size:13px;">
          <td style="padding:10px 12px; white-space:nowrap;">
            <input data-k="id" value="${esc(id)}"
              style="width:160px; padding:8px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.08);
              background:rgba(255,255,255,.03); color:inherit;">
          </td>
          <td style="padding:10px 12px; min-width:260px;">
            <textarea data-k="match" spellcheck="false"
              style="width:360px; min-height:64px; padding:8px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.08);
              background:rgba(255,255,255,.03); color:inherit; font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; font-size:12px;">${esc(JSON.stringify(match, null, 2))}</textarea>
          </td>
          <td style="padding:10px 12px; white-space:nowrap;">
            <select data-k="action" style="padding:8px 10px; border-radius:10px;">
              ${["suppress","set"].map(x=>`<option value="${x}" ${x===action?"selected":""}>${x}</option>`).join("")}
            </select>
          </td>
          <td style="padding:10px 12px; min-width:260px;">
            <textarea data-k="set" spellcheck="false"
              style="width:260px; min-height:64px; padding:8px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.08);
              background:rgba(255,255,255,.03); color:inherit; font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; font-size:12px;">${esc(JSON.stringify(setObj, null, 2))}</textarea>
          </td>
          <td style="padding:10px 12px;">
            <input data-k="justification" value="${esc(justification)}"
              style="width:260px; padding:8px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.08);
              background:rgba(255,255,255,.03); color:inherit;">
          </td>
          <td style="padding:10px 12px; white-space:nowrap;">
            <input data-k="expires_at" value="${esc(expires_at)}" placeholder="${nowIsoDate()}"
              style="width:140px; padding:8px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.08);
              background:rgba(255,255,255,.03); color:inherit;">
          </td>
          <td style="padding:10px 12px; white-space:nowrap;">
            <button class="vsp-btn vsp-btn-soft" data-act="del">Delete</button>
          </td>
        </tr>
      `;
    }

    function syncTextAreaFromState(){
      if(!tx) return;
      tx.value = JSON.stringify(toPostPayload(state), null, 2);
    }

    function syncStateFromTable(){
      const rows = Array.from(tb.querySelectorAll("tr"));
      const out = [];
      for(const r of rows){
        const get = (k)=>r.querySelector(`[data-k="${k}"]`);
        const it = {};
        it.id = (get("id")?.value || "").trim() || undefined;
        it.action = (get("action")?.value || "").trim() || "suppress";
        it.justification = (get("justification")?.value || "").trim() || "";
        it.expires_at = (get("expires_at")?.value || "").trim() || "";

        // JSON fields
        try { it.match = JSON.parse(get("match")?.value || "{}"); }
        catch(e){ throw new Error("Bad JSON in match for row id="+(it.id||"(no id)")); }
        try { it.set = JSON.parse(get("set")?.value || "{}"); }
        catch(e){ throw new Error("Bad JSON in set for row id="+(it.id||"(no id)")); }

        // normalize: if action=suppress => set can be empty
        if(it.action === "suppress") {
          if(!it.match || typeof it.match!=="object") it.match = {};
          // keep set but it's ok if empty
        }
        out.push(it);
      }
      state.items = out;
      syncTextAreaFromState();
    }

    function syncTableFromState(){
      tb.innerHTML = items.map((it, idx)=>rowToInputs(it, idx)).join("");
      syncTextAreaFromState();
    }

    syncTableFromState();
    msg("Loaded "+items.length+" overrides.", "ok");

    // events
    $("rules-add")?.addEventListener("click", ()=>{
      state.items = state.items || [];
      state.items.push({
        id: "ovr_" + (state.items.length+1),
        match: { tool: "KICS" },
        action: "set",
        set: { severity: "LOW" },
        justification: "False positive / accepted risk",
        expires_at: (new Date().getFullYear()+1) + "-12-31"
      });
      syncTableFromState();
      msg("Added draft override. Edit then Save.", "ok");
    });

    $("rules-reload")?.addEventListener("click", async ()=>{
      msg("Reloading…", "ok");
      try{
        const j = normalizeFromApi(await apiGet());
        state.items = j.items || [];
        syncTableFromState();
        msg("Reloaded "+state.items.length+" overrides.", "ok");
      }catch(e){
        msg(String(e), "err");
      }
    });

    $("rules-save")?.addEventListener("click", async ()=>{
      try{
        // If user edited raw JSON, prefer that
        if(tx && tx.value && tx.value.trim().startsWith("{")){
          let raw;
          try { raw = JSON.parse(tx.value); }
          catch(e){ throw new Error("Raw JSON invalid: "+e); }
          // accept either {meta,overrides} or {version,items}
          let st = normalizeFromApi(raw);
          if(raw && raw.meta && Array.isArray(raw.overrides)) st = {version:1, items: raw.overrides};
          state.items = st.items || [];
          // re-render table from state to keep consistent
          syncTableFromState();
        } else {
          syncStateFromTable();
        }

        const payload = toPostPayload(state);
        msg("Saving…", "ok");
        const res = await apiSave(payload);
        msg("Saved OK. File: " + (res.file||"(unknown)"), "ok");
      }catch(e){
        msg(String(e && e.message ? e.message : e), "err");
      }
    });

    tb.addEventListener("click", (ev)=>{
      const t = ev.target;
      if(!(t instanceof Element)) return;
      const btn = t.closest ? t.closest('[data-act="del"]') : null;
      if(!btn) return;
      const tr = btn.closest("tr");
      if(!tr) return;
      tr.remove();
      try{
        syncStateFromTable();
        msg("Deleted row (not saved yet). Click Save.", "ok");
      }catch(e){
        msg(String(e), "err");
      }
    });
  }

  async function init(){
    const root = $("vsp-rules-main") || $("panel-rules") || document.querySelector('[data-panel="rules"]');
    if(!root){ console.warn("[VSP_RULES] rules pane not found"); return; }

    // Avoid double init
    if(root.getAttribute("data-vsp-rules-inited")==="1") return;
    root.setAttribute("data-vsp-rules-inited","1");

    root.innerHTML = '<div class="vsp-card" style="margin:12px 0; padding:14px;">Loading rule overrides…</div>';

    let state = { version: 1, items: [] };
    try{
      const j = normalizeFromApi(await apiGet());
      state.items = j.items || [];
      render(root, state);
    }catch(e){
      root.innerHTML = '<div class="vsp-card" style="margin:12px 0; padding:14px;">' +
        '<div style="font-weight:800;">Rule Overrides load failed</div>' +
        '<pre style="white-space:pre-wrap; opacity:.85; font-size:12px;">'+esc(String(e && e.stack ? e.stack : e))+'</pre>' +
        '</div>';
    }
  }

  // Public hook for router
  window.VSP_RULES_TAB_INIT = init;

  // Init only when hash is #rules
  function maybe(){
    const h = (location.hash||"").toLowerCase();
    if(h.includes("rules")) init();
  }
  window.addEventListener("hashchange", maybe);
  document.addEventListener("DOMContentLoaded", maybe);

  console.log("[VSP_RULE_OVERRIDES_TAB_V1] loaded");
})();


/* ==== END static/js/vsp_rule_overrides_tab_v1.js ==== */
;
;
/* ==== BEGIN static/js/vsp_dashboard_enhance_v1.js ==== */

// VSP_SAFE_DRILLDOWN_HARDEN_P0_V6
/* P0_DRILLDOWN_NUKE_V8 */

/* __VSP_DD_HANDLER_WRAP_P0_FINAL: normalize VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 to callable */
(function(){
  'use strict';

/* VSP_DD_ART_CALL_V1: commercial stable wrapper (fn OR {open:fn}) */
(function(){
  'use strict';
  if (window.VSP_DD_ART_CALL_V1) return;
  window.VSP_DD_ART_CALL_V1 = function(){
    var h = window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2;
    var args = Array.prototype.slice.call(arguments);
    try{
      if (typeof h === 'function') return h.apply(null, args);
      if (h && typeof h.open === 'function') return h.open.apply(h, args);
    }catch(e){
      try{ console.warn('[VSP][DD_CALL_V1]', e); }catch(_){}
    }
    return null;
  };
})();


  try{
    var h = window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2;
    if (h && typeof h !== 'function'){
      window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 = function(){
        return (window.__VSP_DD_SAFE_CALL__ || function(x){
          try{
            var a=[].slice.call(arguments,1);
            if (typeof x==='function') return x.apply(null,a);
            if (x && typeof x.open==='function') return x.open.apply(x,a);
          }catch(_){}
          return null;
        }).apply(null, [h].concat([].slice.call(arguments)));
      };
      try{ console.log('[VSP][P0] drilldown handler wrapped (obj->fn)'); }catch(_){}
    }
  }catch(e){}
})();

(function(){
  try{
    if (typeof window === "undefined") return;


/* VSP_FIX_DRILLDOWN_ARTIFACTS_NOT_FUNCTION_P0_V2
 * Fix: TypeError __VSP_DD_ART_CALL__(VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2, ...) is not a function
 * Normalize BEFORE first use:
 *   - if function: keep
 *   - if object with .open(): wrap as function(arg)->obj.open(arg)
 *   - else: no-op (never throw)
 */
(function(){
  'use strict';
  



/* VSP_FIX_DRILLDOWN_CALLSITE_P0_V5: safe-call drilldown artifacts (function OR object.open) */
function __VSP_DD_ART_CALL__(h, ...args) {
  try {
    if (typeof h === 'function') return h(...args);
    if (h && typeof h.open === 'function') return h.open(...args);
  } catch(e) { try{console.warn('[VSP][DD_SAFE]', e);}catch(_e){} }
  return null;
}

/* VSP_FIX_DRILLDOWN_CALLSITE_P0_V3: safe-call for drilldown artifacts (function OR object.open) */
function __VSP_DD_ART_CALL__(h, ...args) {
  try {
    if (typeof h === 'function') return h(...args);
    if (h && typeof h.open === 'function') return h.open(...args);
  } catch (e) {
    try { console.warn('[VSP][DD_SAFE] call failed', e); } catch (_e) {}
  }
  return null;
}

if (window.__VSP_FIX_DRILLDOWN_ARTIFACTS_NOT_FUNCTION_P0_V2) return;
  window.__VSP_FIX_DRILLDOWN_ARTIFACTS_NOT_FUNCTION_P0_V2 = 1;

  function normalize(v){
    if (typeof v === 'function') return v;
    if (v && typeof v.open === 'function') {
      const obj = v;
      const fn = function(arg){ try { return obj.open(arg); } catch(e){ console.warn('[VSP][DD_FIX] open() failed', e); return null; } };
      fn.__wrapped_from_object = true;
      return fn;
    }
    const noop = function(_arg){ return null; };
    noop.__noop = true;
    return noop;
  }

  try {
    // trap future assignments
    let _val = window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2;
    Object.defineProperty(window, 'VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2', {
      configurable: true, enumerable: true,
      get: function(){ return _val; },
      set: function(v){ _val = normalize(v); }
    });
    window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 = _val;
  } catch(e) {
    window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 = normalize(window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2);
  }
})();

    if (typeof window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 !== "function") {
      window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 = function(){
        try{ console.info("[VSP][P0] drilldown window stub called"); }catch(_){}
        return {open(){},show(){},close(){},destroy(){}};
      };
    }
  }catch(_){}
})();

/* P0_DRILLDOWN_STUB_V6 */
(function(){
  try{
    if (typeof window === "undefined") return;
    if (typeof window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 !== "function") {
      window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 = function(){
        try{ console.info("[VSP_DASH][P0] drilldown window stub called"); }catch(_){}
        return {open(){},show(){},close(){},destroy(){}};
      };
    }
  }catch(_){}
})();

/* P0_DRILLDOWN_CALL_V3 */
(function(){
  try{
    if (typeof window === "undefined") return;

    // Stub always returns an object with safe methods
    window.__VSP_P0_DRILLDOWN_STUB = window.__VSP_P0_DRILLDOWN_STUB || function(){
      try{ console.info("[VSP_DASH][P0] drilldown stub called"); }catch(_){}
      return { open(){}, show(){}, close(){}, destroy(){} };
    };

    // Ensure window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 is callable
    if (typeof window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 !== "function") {
      window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 = window.__VSP_P0_DRILLDOWN_STUB;
      try{ console.info("[VSP_DASH][P0] drilldown forced stub (window)"); }catch(_){}
    }

    // Stable call entry (never throws)
    window.__VSP_P0_DRILLDOWN_CALL = window.__VSP_P0_DRILLDOWN_CALL || function(){
      try{
        const fn = window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2;
        if (typeof fn === "function") return fn.apply(window, arguments);
      }catch(_){}
      try{
        return window.__VSP_P0_DRILLDOWN_STUB.apply(window, arguments);
      }catch(_){}
      return { open(){}, show(){}, close(){}, destroy(){} };
    };
  }catch(_){}
})();

/* VSP_P0_DRILLDOWN_CALL_V2: prevent red console when drilldown is missing */
(function(){
  try{
    if (typeof window === "undefined") return;

    // ensure window function exists early (before any local capture)
    if (typeof window.__VSP_P0_DRILLDOWN_STUB !== "function") {
      window.__VSP_P0_DRILLDOWN_STUB = function(){
        try{ console.info("[VSP_DASH][P0] drilldown stub called"); }catch(_){}
        return { open(){}, show(){}, close(){}, destroy(){} };
      };
    }
    if (typeof window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 !== "function") {
      window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 = window.__VSP_P0_DRILLDOWN_STUB;
      try{ console.info("[VSP_DASH][P0] drilldown forced stub (window)"); }catch(_){}
    }

    // stable caller: always a function
    if (typeof window.__VSP_P0_DRILLDOWN_CALL_V2 !== "function") {
      window.__VSP_P0_DRILLDOWN_CALL_V2 = function(){
        try{
          var fn = window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2;
          if (typeof fn === "function") return fn.apply(window, arguments);
        }catch(_){}
        try{
          var stub = window.__VSP_P0_DRILLDOWN_STUB;
          if (typeof stub === "function") return stub.apply(window, arguments);
        }catch(_){}
        return { open(){}, show(){}, close(){}, destroy(){} };
      };
    }
  }catch(_){}
})();

/* P0_GUARD_GLOBAL_V1 */
// Define global guard so any callsite can see it (prevents ReferenceError)
(function(){
  try{
    if (typeof window === "undefined") return;

    window.VSP_DASH_IS_ACTIVE_P0 = window.VSP_DASH_IS_ACTIVE_P0 || function(){
      try{
        const h = (location.hash || "").toLowerCase();
        if (!h || h === "#" || h === "#dashboard") return true;
        return false;
      }catch(_){ return false; }
    };

    window.VSP_DASH_P0_GUARD = window.VSP_DASH_P0_GUARD || function(reason){
      try{
        if (!window.VSP_DASH_IS_ACTIVE_P0()){
          try{ console.info("[VSP_DASH][P0] skip:", reason, "hash=", location.hash); }catch(_){}
          return false;
        }
        return true;
      }catch(_){ return true; }
    };

    // Also provide plain global function names (some code calls them directly)
    if (typeof window.VSP_DASH_P0_GUARD === "function") {
      window.VSP_DASH_P0_GUARD_NAME = "ok";
    }
  }catch(_){}
})();

// Plain-name wrappers (avoid ReferenceError even if code calls VSP_DASH_P0_GUARD directly)
function VSP_DASH_IS_ACTIVE_P0(){ try{ return (window && window.VSP_DASH_IS_ACTIVE_P0) ? window.VSP_DASH_IS_ACTIVE_P0() : true; }catch(_){ return true; } }
function VSP_DASH_P0_GUARD(reason){ try{ return (window && window.VSP_DASH_P0_GUARD) ? window.VSP_DASH_P0_GUARD(reason) : true; }catch(_){ return true; } }

// === VSP_CHARTS_ENGINE_SHIM_V1 ===
(function(){
  // Always provide a safe resolver so dashboard never crashes on missing symbol names.
  function _findChartsEngineShim(){
    return (
      window.VSP_CHARTS_ENGINE_V3 ||
      window.VSP_CHARTS_V3 ||
      window.VSP_CHARTS_PRETTY_V3 ||
      window.VSP_DASH_CHARTS_V3 ||
      window.VSP_CHARTS_ENGINE_V2 ||
      window.VSP_CHARTS_V2 ||
      window.VSP_CHARTS_ENGINE ||
      window.VSP_CHARTS ||
      null
    );
  }
  if (typeof window.findChartsEngine !== 'function') {
    window.findChartsEngine = _findChartsEngineShim;
  }
})();

// === VSP_FIND_CHARTS_ENGINE_FALLBACK_V1 ===
if (typeof window.findChartsEngine !== 'function') {
  window.findChartsEngine = function () {
    try {
      // Prefer explicit exported engines
      if (window.VSP_DASH_CHARTS_ENGINE) return window.VSP_DASH_CHARTS_ENGINE;
      if (window.VSP_DASH_CHARTS_V3) return window.VSP_DASH_CHARTS_V3;
      if (window.VSP_DASH_CHARTS_V2) return window.VSP_DASH_CHARTS_V2;

      // Heuristic: look for known globals from pretty charts scripts
      var cand = [
        window.vsp_dashboard_charts_v3,
        window.vsp_dashboard_charts_v2,
        window.VSP_CHARTS_V3,
        window.VSP_CHARTS_V2
      ].filter(Boolean)[0];

      return cand || null;
    } catch (e) { return null; }
  };
}
// === END VSP_FIND_CHARTS_ENGINE_FALLBACK_V1 ===
(function () {
  // VSP 2025 – Dashboard enhance V4 (clean, no patch lỗi)
  console.log('[VSP_DASH] vsp_dashboard_enhance_v1.js (V4 clean) loaded');

  function onReady(fn) {
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', fn);
    } else {
      fn();
    }
  }

  function safeText(id, value) {
    var el = document.getElementById(id);
    if (!el) return;
    el.textContent = value;
  }

  function fetchDashboard() {
    return fetch('/api/vsp/dashboard_v3', {
      credentials: 'same-origin'
    }).then(function (r) {
      if (!r.ok) throw new Error('HTTP ' + r.status);
      return r.json();
    });
  }

  function fillKpis(data) {
    if (!data || typeof data !== 'object') return;
    var bySeverity = data.by_severity || {};
    var total = data.total_findings != null
      ? data.total_findings
      : (bySeverity.CRITICAL || 0) + (bySeverity.HIGH || 0) +
        (bySeverity.MEDIUM || 0) + (bySeverity.LOW || 0) +
        (bySeverity.INFO || 0) + (bySeverity.TRACE || 0);

    safeText('vsp-kpi-total-findings', total);
    safeText('vsp-kpi-critical', bySeverity.CRITICAL != null ? bySeverity.CRITICAL : 0);
    safeText('vsp-kpi-high',     bySeverity.HIGH     != null ? bySeverity.HIGH     : 0);
    safeText('vsp-kpi-medium',   bySeverity.MEDIUM   != null ? bySeverity.MEDIUM   : 0);
    safeText('vsp-kpi-low',      bySeverity.LOW      != null ? bySeverity.LOW      : 0);
    safeText('vsp-kpi-info',     bySeverity.INFO     != null ? bySeverity.INFO     : 0);
    safeText('vsp-kpi-trace',    bySeverity.TRACE    != null ? bySeverity.TRACE    : 0);

    if (data.security_posture_score != null) {
      safeText('vsp-kpi-security-score', data.security_posture_score);
    }

    safeText('vsp-kpi-top-tool',   data.top_risky_tool       || 'N/A');
    safeText('vsp-kpi-top-cwe',    data.top_impacted_cwe     || data.top_cwe || 'N/A');
    safeText('vsp-kpi-top-module', data.top_vulnerable_module || 'N/A');

    var gate = data.ci_gate_status || data.ci_gate || {};
    var gateLabel = gate.label || gate.status || 'N/A';
    var gateDesc  = gate.description || 'Gate dựa trên CRITICAL/HIGH, score & coverage.';
    safeText('vsp-kpi-ci-gate-status',      gateLabel);
    safeText('vsp-kpi-ci-gate-status-desc', gateDesc);
  }

  function hydrateDashboard(data) {
    try {
      fillKpis(data);

      if (window.VSP_CHARTS_V3 && typeof window.VSP_CHARTS_V3.updateFromDashboard === 'function') {
        window.VSP_CHARTS_V3.updateFromDashboard(data);
      } else if (window.VSP_CHARTS_V2 && typeof window.VSP_CHARTS_V2.updateFromDashboard === 'function') {
        window.VSP_CHARTS_V2.updateFromDashboard(data);
      } else {
        console.debug('[VSP_DASH] No charts engine V2/V3 found – only KPIs filled. (will retry)');
      }

      console.log('[VSP_DASH] Dashboard hydrated OK (V4 clean).');
    } catch (e) {
      console.error('[VSP_DASH] Error hydrating dashboard:', e);
    }
  }

  window.hydrateDashboard = hydrateDashboard;

  onReady(function () {
    var pane = document.getElementById('vsp-dashboard-main');
    if (!pane) {
      console.log('[VSP_DASH] No dashboard pane found, skip auto fetch.');
      return;
    }
    console.log('[VSP_DASH] Hydrating dashboard (auto fetch)…');
  if (!VSP_DASH_P0_GUARD("hydrate")) { return; }
    fetchDashboard()
      .then(function (data) {
        console.log('[VSP_DASH] dashboard_v3 data =', data);
        hydrateDashboard(data);
      })
      .catch(function (err) {
        console.error('[VSP_DASH] Failed to load /api/vsp/dashboard_v3:', err);
      });
  });

})();


// === VSP_DASH_CHARTS_RETRY_V1 ===
(function(){
  try{
    let tries = 0;
    function tryHydrate(){
      tries++;
      const eng = window.VSP_CHARTS_V3 || window.VSP_CHARTS_PRETTY_V3 || window.VSP_CHARTS_ENGINE_V3;
      if (eng && typeof eng.hydrate === 'function' && window.__VSP_LAST_DASH_DATA__){
        eng.hydrate(window.__VSP_LAST_DASH_DATA__);
        console.log('[VSP_DASH] charts hydrated via retry');
        return;
      }
      if (tries < 8) setTimeout(tryHydrate, 300);
    }
    setTimeout(tryHydrate, 300);
  }catch(e){}
})();
// === END VSP_DASH_CHARTS_RETRY_V1 ===


// === VSP_DASH_CHARTS_RETRY_V2 ===
(function(){
  try{
    let tries = 0;
    function tick(){
      tries++;
      const eng = findChartsEngine();
      if (eng && window.__VSP_LAST_DASH_DATA__){
        try{
          eng.hydrate(window.__VSP_LAST_DASH_DATA__);
          console.log('[VSP_DASH] charts hydrated via retry v2');
          return;
        }catch(e){}
      }
      if (tries < 8) setTimeout(tick, 350);
    }
    setTimeout(tick, 350);
  }catch(e){}
})();
// === END VSP_DASH_CHARTS_RETRY_V2 ===


// === VSP_DASH_USE_DASH_V3_AND_INIT_CHARTS_V1 ===
(function(){
  try {
    if (window.__VSP_DASH_INIT_CHARTS_V1) return;
    window.__VSP_DASH_INIT_CHARTS_V1 = true;

    function _vspGetChartsEngine() {
      return window.VSP_CHARTS_ENGINE_V3 || window.VSP_CHARTS_ENGINE_V2 || null;
    }

    window.__VSP_DASH_TRY_INIT_CHARTS_V1 = function(dash, reason) {
      try {
        if (dash) window.__VSP_DASH_LAST_DATA_V3 = dash;
        var eng = _vspGetChartsEngine();
        if (!eng || !eng.initAll) return false;
        var d = dash || window.__VSP_DASH_LAST_DATA_V3;
        if (!d) return false;
        var ok = eng.initAll(d);
        console.log("[VSP_DASH] charts initAll via", reason || "unknown", "=>", ok);
        return !!ok;
      } catch (e) {
        console.warn("[VSP_DASH] charts init failed", e);
        return false;
      }
    };

    // Listen for charts-ready (late engine load)
    window.addEventListener("vsp:charts-ready", function(ev){
      setTimeout(function(){
        window.__VSP_DASH_TRY_INIT_CHARTS_V1(null, "charts-ready");
      }, 0);
    });
  } catch(e) {
    console.warn("[VSP_DASH] init-charts patch failed", e);
  }
})();

// === VSP_ENHANCE_WAIT_CHARTS_READY_V1 ===

(function(){
  try{
    if (window.__VSP_ENHANCE_WAIT_CHARTS_READY_V1) return;
    window.__VSP_ENHANCE_WAIT_CHARTS_READY_V1 = true;

    function pickEngine(){
      return window.VSP_CHARTS_ENGINE_V3 || window.VSP_CHARTS_ENGINE_V2 || window.VSP_CHARTS_ENGINE || null;
    }

    function tryInit(){
      var eng = pickEngine();
      var d = window.__VSP_DASH_LAST_DATA_V3 || window.__VSP_DASH_LAST_DATA || window.__VSP_DASH_LAST_DATA_ANY || null;
      if (!eng || !eng.initAll || !d) return false;
      try{
        eng.initAll(d);
        return true;
      }catch(e){
        return false;
      }
    }

    window.addEventListener('vsp:charts-ready', function(){
      // chỉ init khi đã có data (dashboard fetch xong)
      tryInit();
    });

    // nếu engine đã có sẵn thì thử init luôn (không warn)
    tryInit();
  }catch(e){}
})();



// === VSP_UI_KPI_DRILLDOWN_V1 ===
(function(){
  const KEY = "vsp_ds_drill_url_v1";

  async function loadDashLatest(){
    try{
      const r = await fetch("/api/vsp/dashboard_latest_v1", {credentials:"same-origin"});
      const j = await r.json();
      window.__VSP_DASH_LATEST_V1 = j;
      return j;
    }catch(e){
      console.warn("[KPI_DRILLDOWN] loadDashLatest failed", e);
      return null;
    }
  }

  function _setDrillUrl(url){
    try{ sessionStorage.setItem(KEY, url); }catch(e){}
  }

  function openDrill(url){
    if(!url) return;
    _setDrillUrl(url);

    // best-effort: switch tab by hash
    try{
      if(!String(location.hash||"").toLowerCase().includes("datasource")){
        location.hash = "#datasource";
        // kick router if it listens
        setTimeout(()=>{ try{ window.dispatchEvent(new Event("hashchange")); }catch(e){} }, 50);
      }
    }catch(e){}

    // if Data Source JS installed hook -> use it
    if(typeof window.VSP_DS_APPLY_DRILL_URL_V1 === "function"){
      try{ window.VSP_DS_APPLY_DRILL_URL_V1(url); return; }catch(e){}
    }

    // fallback: open API in new tab (always works)
    try{ window.open(url, "_blank"); }catch(e){}
  }

  function bindClicks(dash){
    if(!dash || !dash.links) return;

    const sevLinks = (dash.links.severity || {});
    const allUrl   = dash.links.all;

    const nodes = Array.from(document.querySelectorAll("a,button,div,section,article,span"))
      .filter(el=>{
        const txt = (el.innerText||"").trim();
        return txt && txt.length > 0 && txt.length < 160;
      });

    function attachByKeyword(keywordUpper, url, title){
      if(!url) return;
      for(const el of nodes){
        const txt = (el.innerText||"").toUpperCase();
        if(!txt.includes(keywordUpper)) continue;
        if(el.__vsp_drill_attached) continue;
        el.__vsp_drill_attached = true;
        el.style.cursor = "pointer";
        el.title = title;
        el.addEventListener("click", (ev)=>{
          // allow user open normally with ctrl/cmd
          if(ev && (ev.ctrlKey || ev.metaKey || ev.shiftKey)) return;
          try{ ev.preventDefault(); }catch(e){}
          openDrill(url);
        });
      }
    }

    // severity KPI cards (by keyword)
    ["CRITICAL","HIGH","MEDIUM","LOW","INFO","TRACE"].forEach(sev=>{
      attachByKeyword(sev, sevLinks[sev], `Drilldown → ${sev}`);
    });

    // total findings KPI (heuristic)
    if(allUrl){
      for(const el of nodes){
        const txt = (el.innerText||"").toUpperCase();
        const hit = (txt.includes("TOTAL") && (txt.includes("FIND") || txt.includes("FINDINGS"))) || txt.includes("TOTAL FINDINGS");
        if(!hit) continue;
        if(el.__vsp_drill_total) continue;
        el.__vsp_drill_total = true;
        el.style.cursor = "pointer";
        el.title = "Drilldown → ALL findings";
        el.addEventListener("click", (ev)=>{
          if(ev && (ev.ctrlKey || ev.metaKey || ev.shiftKey)) return;
          try{ ev.preventDefault(); }catch(e){}
          openDrill(allUrl);
        });
      }
    }

    // expose helper for manual use
    window.VSP_DASH_OPEN_DRILL_V1 = openDrill;
    console.log("[KPI_DRILLDOWN] bound", {rid: dash.rid, hasLinks: !!dash.links});
  }

  window.addEventListener("load", async ()=>{
    const dash = await loadDashLatest();
    // wait a bit so DOM cards exist
    setTimeout(()=>bindClicks(dash), 600);
  });
})();



// === VSP_UI_DRILL_PANEL_V1 ===
(function(){
  const KEY = "vsp_ds_drill_url_v1";

  function setDrillUrl(url){
    try{ sessionStorage.setItem(KEY, url); }catch(e){}
  }
  function gotoDatasource(){
    const h = String(location.hash||"");
    if(h.startsWith("#vsp4-")) location.hash = "#vsp4-datasource";
    else location.hash = "#datasource";
    try{ window.dispatchEvent(new Event("hashchange")); }catch(e){}
  }
  async function dashLatest(){
    const r = await fetch("/api/vsp/dashboard_latest_v1", {credentials:"same-origin"});
    return await r.json();
  }

  function ensurePanel(d){
    const id="vsp_drill_panel_v1";
    if(document.getElementById(id)) return;

    const wrap=document.createElement("div");
    wrap.id=id;
    wrap.style.position="fixed";
    wrap.style.right="18px";
    wrap.style.bottom="18px";
    wrap.style.zIndex="9999";
    wrap.style.padding="10px";
    wrap.style.borderRadius="14px";
    wrap.style.border="1px solid rgba(255,255,255,.10)";
    wrap.style.background="rgba(2,6,23,.78)";
    wrap.style.backdropFilter="blur(10px)";
    wrap.style.boxShadow="0 10px 30px rgba(0,0,0,.35)";
    wrap.style.fontSize="12px";
    wrap.style.color="rgba(255,255,255,.85)";
    wrap.innerHTML = `
      <div style="font-weight:700;margin-bottom:6px;">Drilldown</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        <button id="vsp_drill_total" style="padding:6px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);color:#fff;cursor:pointer;">TOTAL</button>
        <button id="vsp_drill_critical" style="padding:6px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);color:#fff;cursor:pointer;">CRITICAL</button>
        <button id="vsp_drill_high" style="padding:6px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);color:#fff;cursor:pointer;">HIGH</button>
      </div>
      <div style="opacity:.65;margin-top:6px;">(opens Data Source)</div>
    `;
    document.body.appendChild(wrap);

    const links = (d && d.links) ? d.links : {};
    const sev = (links.severity)||{};
    function bind(btnId, url){
      const b=document.getElementById(btnId);
      if(!b) return;
      b.onclick = ()=>{
        if(!url){ console.warn("[DRILL] missing url for", btnId); return; }
        setDrillUrl(url);
        gotoDatasource();
        if(typeof window.VSP_DS_APPLY_DRILL_URL_V1==="function"){
          try{ window.VSP_DS_APPLY_DRILL_URL_V1(url); }catch(e){}
        }
        console.log("[DRILL] open", url);
      };
    }
    bind("vsp_drill_total", links.all);
    bind("vsp_drill_critical", sev.CRITICAL);
    bind("vsp_drill_high", sev.HIGH);
  }

  window.addEventListener("load", async ()=>{
    try{
      const d = await dashLatest();
      window.__VSP_DASH_LATEST_V1 = d;
      ensurePanel(d);
    }catch(e){
      console.warn("[DRILL_PANEL] failed", e);
    }
  });
})();

// === VSP_P2_DRILL_ROUTER_V1 ===
// Drill router: click elements with data-drill -> switch tab datasource + apply filters
(function(){
  function parseHashParams(){
    let h = (location.hash || "").replace(/^#\/?/,"");
    if (!h) return {};
    const out = {};
    for (const part of h.split("&")){
      if (!part) continue;
      const [k,v] = part.split("=",2);
      if (!k) continue;
      out[decodeURIComponent(k)] = decodeURIComponent(v||"");
    }
    return out;
  }

  function buildHash(tab, filters){
    const sp = new URLSearchParams();
    sp.set("tab", tab || "datasource");
    for (const [k,v] of Object.entries(filters||{})){
      if (v === undefined || v === null) continue;
      const sv = String(v).trim();
      if (!sv) continue;
      sp.set(k, sv);
    }
    return "#" + sp.toString();
  }

  function switchToDatasourceTab(){
    // Try click datasource tab button if exists
    const btn = document.querySelector("#tab-datasource, [data-tab-btn='datasource'], a[href*='datasource']");
    if (btn && btn.click) btn.click();
  }

  function applyDatasource(filters){
    // Set hash first (so reload preserves)
    const h = buildHash("datasource", filters||{});
    if (location.hash !== h) location.hash = h;

    // then call sink if available
    const sink = window.VSP_DATASOURCE_APPLY_FILTERS_V1;
    if (typeof sink === "function"){
      try{ sink(filters||{}, {noHashSync:true}); }catch(e){}
    }
  }

  function handleDrillClick(e){
    const a = e.target.closest("[data-drill]");
    if (!a) return;
    e.preventDefault();
    let val = a.getAttribute("data-drill") || "";
    // accept JSON {"sev":"HIGH"} or query "sev=HIGH&tool=semgrep"
    let filters = {};
    try{
      if (val.trim().startsWith("{")) filters = JSON.parse(val);
      else{
        const sp = new URLSearchParams(val.replace(/^#\/?/,""));
        sp.forEach((v,k)=>{ filters[k]=v; });
      }
    }catch(_){
      filters = {};
    }
    switchToDatasourceTab();
    applyDatasource(filters);
  }

  function onHashChange(){
    const hp = parseHashParams();
    if ((hp.tab||"") !== "datasource") return;
    const f = Object.assign({}, hp);
    delete f.tab;
    const sink = window.VSP_DATASOURCE_APPLY_FILTERS_V1;
    if (typeof sink === "function"){
      sink(f, {noHashSync:true});
    }
  }

  function bind(){
    // delegate click drill
    if (!document.body._vspDrillBound){
      document.body._vspDrillBound = true;
      document.body.addEventListener("click", handleDrillClick);
    }
    window.addEventListener("hashchange", onHashChange);
    // initial
    onHashChange();
  }

  if (document.readyState === "loading"){
    document.addEventListener("DOMContentLoaded", bind);
  }else{
    bind();
  }
})();

// === VSP_P2_AUTOBIND_KPI_DRILL_V1 ===
// Auto bind drilldown for KPI cards (clickable commercial)
// - Uses dashboard_latest_v1.links if present
// - Fallback binds severity labels CRITICAL/HIGH/MEDIUM/LOW/INFO/TRACE
(function(){
  const SEVS = ["CRITICAL","HIGH","MEDIUM","LOW","INFO","TRACE"];

  function qs(sel, root){ return (root||document).querySelector(sel); }
  function qsa(sel, root){ return Array.from((root||document).querySelectorAll(sel)); }

  function norm(s){ return String(s||"").trim().toUpperCase(); }

  function parseDrillToQuery(drill){
    // drill may be absolute/relative url to datasource, or a query-like string
    if (!drill) return "";
    let s = String(drill).trim();
    // if full URL, take hash or query
    try{
      if (s.startsWith("http")){
        const u = new URL(s);
        if (u.hash && u.hash.length > 1) return u.hash.replace(/^#\/?/,"");
        if (u.search && u.search.length > 1) return u.search.replace(/^\?/,"");
      }
    }catch(_){}
    // if starts with #...
    s = s.replace(/^#\/?/,"");
    // remove leading vsp4 path fragments
    s = s.replace(/^\/?vsp4\??/,"").replace(/^\?/,"");
    return s;
  }

  async function fetchDash(){
    const r = await fetch("/api/vsp/dashboard_latest_v1", {cache:"no-store"});
    return await r.json();
  }

  function bindEl(el, query){
    if (!el || !query) return;
    // do not double bind
    if (el.getAttribute("data-drill")) return;
    el.setAttribute("data-drill", query);
    el.style.cursor = "pointer";
    el.title = el.title || "Click to drilldown";
  }

  function findKpiCandidates(){
    // broad selectors; harmless if none
    const sels = [
      ".vsp-kpi-card", ".kpi-card", ".kpi", ".vsp-card",
      "[data-kpi]", "[data-kpi-card]", "[data-role='kpi']"
    ];
    const out = [];
    for (const s of sels){
      qsa(s).forEach(x=>out.push(x));
    }
    // fallback: any card-like divs in dashboard area
    const dash = qs("#vsp-dashboard-main") || qs("#tab-dashboard") || document.body;
    qsa("div", dash).forEach(d=>{
      const txt = norm(d.innerText||"");
      if (SEVS.some(s=>txt.includes(s)) && (d.offsetWidth>80 && d.offsetHeight>40)){
        out.push(d);
      }
    });
    // unique
    return Array.from(new Set(out));
  }

  function bestEffortBindFromLinks(links){
    // expected shapes:
    // links: { severity: {HIGH:"tab=datasource&sev=HIGH"...}, all:"...", suppressed:"..." }
    if (!links || typeof links !== "object") return false;
    const kpis = findKpiCandidates();
    let bound = 0;

    // bind severity-based
    for (const sev of SEVS){
      const drill = links?.severity?.[sev] || links?.["severity."+sev] || links?.[sev] || null;
      if (!drill) continue;
      const q = parseDrillToQuery(drill);
      if (!q) continue;
      for (const el of kpis){
        const txt = norm(el.innerText||"");
        if (txt.includes(sev)){
          bindEl(el, q);
          bound++;
        }
      }
    }

    // bind "all" if present
    if (links.all){
      const q = parseDrillToQuery(links.all);
      if (q){
        for (const el of kpis){
          const txt = norm(el.innerText||"");
          if (txt.includes("TOTAL") || txt.includes("ALL") || txt.includes("FINDINGS")){
            bindEl(el, q);
            bound++;
          }
        }
      }
    }
    return bound > 0;
  }

  function fallbackBindSev(){
    const kpis = findKpiCandidates();
    let bound = 0;
    for (const sev of SEVS){
      const q = "tab=datasource&sev=" + encodeURIComponent(sev) + "&limit=200";
      for (const el of kpis){
        const txt = norm(el.innerText||"");
        if (txt.includes(sev)){
          bindEl(el, q);
          bound++;
        }
      }
    }
    return bound>0;
  }

  async function init(){
    try{
      const j = await fetchDash();
      const links = j?.links || j?.drilldown || j?.drill || null;
      const ok = bestEffortBindFromLinks(links);
      if (!ok) fallbackBindSev();
    }catch(e){
      fallbackBindSev();
    }
  }

  if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", init);
  else init();
})();



// === VSP_P2_FORCE_8TOOLS_V1 ===
// Force Gate Summary to show 8 tools (commercial). Missing tool => NOT_RUN/0.
// Also capture latest /api/vsp/run_status_v2 JSON via fetch clone.
(function(){
  try{
    if (window.__VSP_P2_FORCE_8TOOLS_V1_INSTALLED) return;
    window.__VSP_P2_FORCE_8TOOLS_V1_INSTALLED = true;

    const TOOL_ORDER = ["BANDIT","CODEQL","GITLEAKS","GRYPE","KICS","SEMGREP","SYFT","TRIVY"];
    window.__VSP_TOOL_ORDER = TOOL_ORDER;

    const origFetch = window.fetch;
    window.fetch = async function(){
      const resp = await origFetch.apply(this, arguments);
      try{
        const u = (typeof arguments[0] === "string") ? arguments[0] : (arguments[0] && arguments[0].url) || "";
        if (u.includes("/api/vsp/run_status_v2")) {
          resp.clone().json().then(j => {
            window.__VSP_LAST_STATUS_V2 = j;
            try { window.__VSP_RENDER_GATE_8TOOLS(); } catch(e){}
          }).catch(()=>{});
        }
      }catch(e){}
      return resp;
    };

    function pickToolObj(st, T){
      if (!st || typeof st !== "object") return null;
      const k = T.toLowerCase();
      return st[k + "_summary"] || st[k] || (st.tools && (st.tools[T] || st.tools[k])) || null;
    }

    function normVerdict(v){
      v = String(v || "").toUpperCase();
      if (!v) return "NOT_RUN";
      return v;
    }

    window.__VSP_RENDER_GATE_8TOOLS = function(){
      const st = window.__VSP_LAST_STATUS_V2;
      // find a plausible gate summary container
      const box =
        document.querySelector("#vsp-gate-summary") ||
        document.querySelector("#gate-summary") ||
        document.querySelector("[data-vsp-gate-summary]") ||
        document.querySelector(".vsp-gate-summary") ||
        document.querySelector("section#vsp-pane-dashboard .vsp-card .vsp-gate") ||
        null;
      if (!box) return;

      // create or find list container
      let list = box.querySelector(".vsp-gate-list");
      if (!list) {
        list = document.createElement("div");
        list.className = "vsp-gate-list";
        box.appendChild(list);
      }

      const rows = TOOL_ORDER.map(T => {
        const o = pickToolObj(st, T) || {};
        const verdict = normVerdict(o.verdict || o.status || o.result || (st && st[(T.toLowerCase()) + "_verdict"]) || "");
        const total = (o.total != null) ? Number(o.total) : Number((st && st[(T.toLowerCase()) + "_total"]) || 0) || 0;
        const pillCls = "vsp-pill vsp-pill-" + verdict.toLowerCase();

        return `
          <div class="vsp-gate-row" style="display:flex;align-items:center;justify-content:space-between;padding:6px 0;border-top:1px solid rgba(255,255,255,.06)">
            <div style="font-weight:650;letter-spacing:.2px">${T}</div>
            <div style="display:flex;gap:10px;align-items:center">
              <span class="${pillCls}">${verdict}</span>
              <span style="opacity:.75">total: ${total}</span>
            </div>
          </div>`;
      }).join("");

      list.innerHTML = rows;
    };

    // attempt render once later (in case status fetched before patch)
    setTimeout(()=>{ try{ window.__VSP_RENDER_GATE_8TOOLS(); }catch(e){} }, 1200);
  }catch(e){}
})();
 // === /VSP_P2_FORCE_8TOOLS_V1 ===




// === VSP_UI_DRILLDOWN_AND_EXPORTPROBE_V1 ===
(function(){
  'use strict';

  
  
  
  
  
  
  


/* VSP_DRILLDOWN_ARTIFACTS_NORMALIZE_P0_V1
 * Fix: Uncaught TypeError: __VSP_DD_ART_CALL__(VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2, ...) is not a function
 * Normalize window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2:
 *  - if function: keep
 *  - if object with .open(): wrap to function
 *  - if missing: provide no-op function (never throw)
 */
(function(){
  'use strict';
  if (window.__VSP_DRILLDOWN_ARTIFACTS_NORMALIZE_P0_V1) return;
  window.__VSP_DRILLDOWN_ARTIFACTS_NORMALIZE_P0_V1 = 1;

  function normalize(v){
    if (typeof v === 'function') return v;
    if (v && typeof v.open === 'function'){
      const obj = v;
      const fn = function(arg){
        try { return obj.open(arg); } catch(_e){ return null; }
      };
      fn.__wrapped_from_object = true;
      return fn;
    }
    // missing/unknown => no-op (never throw)
    const noop = function(_arg){ return null; };
    noop.__noop = true;
    return noop;
  }

  try{
    // Use defineProperty to normalize future assignments too (robust).
    let _val = window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2;
    Object.defineProperty(window, 'VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2', {
      configurable: true,
      enumerable: true,
      get: function(){ return _val; },
      set: function(v){ _val = normalize(v); }
    });
    // trigger normalization on current value
    window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 = _val;
  }catch(_e){
    // fallback if defineProperty is blocked
    window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 = normalize(window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2);
  }
})();

/* P0_DRILLDOWN_LOCAL_V4 */
  // P0: force local symbol to be FUNCTION (prevents "is not a function" even with shadowing)
  try{
    var __vsp_stub = function(){
      try{ console.info("[VSP_DASH][P0] drilldown stub called"); }catch(_){}
      return { open:function(){}, show:function(){}, close:function(){}, destroy:function(){} };
    };

    // local symbol (works even if calls are bare identifier)
    if (typeof VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 !== "function") {
      var VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 = __vsp_stub; // var is function-scoped in IIFE
      try{ console.info("[VSP_DASH][P0] drilldown local stub armed"); }catch(_){}
    }

    // window symbol too (for other modules)
    if (typeof window !== "undefined" && typeof window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 !== "function") {
      window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 = VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2;
      try{ console.info("[VSP_DASH][P0] drilldown window stub armed"); }catch(_){}
    }
  }catch(_){}

  // P0 FIX (final2): ensure drilldown helper exists on window (function)
  try{
    if (typeof window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 !== "function") {
      window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 = function(){
        try{ 
console.warn("[VSP_DASH] drilldown forced stub (window)");   // P0_DRILLDOWN_STUB: guarantee callable function
  if (typeof window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 !== "function") {
    window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 = function(){
      try{ console.warn("[VSP_DASH][P0] drilldown stub used (no-op)"); }catch(_){}
      return { open:function(){}, show:function(){}, destroy:function(){} };
    };
  }
}catch(_){}
        return false;
      };
    }
  }catch(_){}
// P0 FIX (final): drilldown dispatcher (avoid shadowed non-function symbols)
  function __vsp_call_drilldown_artifacts(){
    try{
      const fn = (window && typeof window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 === "function")
        ? window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2
        : function(){ try{ console.warn("[VSP_DASH] drilldown skipped (no function on window)"); }catch(_){ } return false; };
      return fn.apply(null, arguments);
    }catch(_){
      try{ console.warn("[VSP_DASH] drilldown dispatcher failed -> skipped"); }catch(__){}
      return false;
    }
  }
// P0 FIX (final): force drilldown helper onto window and call window.* to avoid shadowed const/object
  try{
    if (typeof window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 !== "function") {
      window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 = function(){
        try{ console.warn("[VSP_DASH] drilldown forced stub (window)"); }catch(_){}
        return false;
      };
    }
  }catch(_){}
// P0 FIX (hard): ALL drilldown helpers must never crash dashboard
  function __vsp_stub_drill(name){
    try{
      const fn = function(){
        try{ console.warn("[VSP_DASH] drilldown helper forced stub:", name); }catch(_){}
        return false;
      };
      // local symbol if exists
      try{
        if (typeof eval(name) !== "function") { /* ignore */ }
      }catch(_){}
      // window symbol
      try{
        if (typeof window[name] !== "function") window[name] = fn;
      }catch(_){}
    }catch(_){}
  }
  try{
    __vsp_stub_drill("VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2");
    __vsp_stub_drill("VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2");
  }catch(_){}
// P0 FIX (hard): drilldown must never crash dashboard
  try{
    // local symbol (if exists / if not declared -> catch)
    if (typeof VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 !== "function") {
window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 = function(){
        try{ console.warn("[VSP_DASH] drilldown helper not a function -> forced stub"); }catch(_){}
        return false;
      };
    }
  }catch(_){}
  try{
    if (typeof window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 !== "function") {
      window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 = function(){
        try{ console.warn("[VSP_DASH] drilldown helper missing -> forced stub"); }catch(_){}
        return false;
      };
    }
  }catch(_){}
// P0 FIX: avoid ReferenceError if drilldown artifacts helper is missing
  if (typeof window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 !== 'function') {
    window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 = function(){
      try{ console.warn("[VSP_DASH] drilldown helper missing -> skipped"); }catch(_){}
      return false;
    };
  }
// P0 FIX: avoid ReferenceError if drilldown artifacts helper is missing
  if (typeof window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 !== 'function') {
    window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 = function(){
      try{ console.warn("[VSP_DASH] drilldown helper missing -> skipped"); }catch(_){}
      return false;
    };
  }
// === VSP_DASH_KPI_FROM_EXTRAS_P1_V4 ===
  (function(){
    if(window.__VSP_DASH_KPI_FROM_EXTRAS_P1_V4) return;
    window.__VSP_DASH_KPI_FROM_EXTRAS_P1_V4 = 1;

    function normRid(x){
      try{
        x = String(x || "").trim();
        x = x.replace(/^RUN[_\-\s]+/i, "");
        x = x.replace(/^RID[:\s]+/i, "");
        const m = x.match(/(VSP_CI_\d{8}_\d{6})/i);
        if(m && m[1]) return m[1];
        return x.replace(/\s+/g, "_");
      }catch(_){ return ""; }
    }

    function getRidBestEffort(){
      // 1) global state (if any)
      try{
        const st = window.__VSP_RID_STATE__ || window.__VSP_RID_STATE || window.VSP_RID_STATE || window.__vsp_rid_state;
        if(st){
          if(st.rid || st.run_id) return normRid(st.rid || st.run_id);
          if(st.state && (st.state.rid || st.state.run_id)) return normRid(st.state.rid || st.state.run_id);
          if(typeof st.get === "function"){
            const v = st.get();
            if(v && (v.rid || v.run_id)) return normRid(v.rid || v.run_id);
          }
        }
      }catch(_){}

      // 2) header text contains "RID:"
      try{
        const body = document.body ? (document.body.innerText || "") : "";
        const m = body.match(/RID:\s*(VSP_CI_\d{8}_\d{6})/i);
        if(m && m[1]) return normRid(m[1]);
      }catch(_){}

      return "";
    }

    function setText(id, v){
      const el = document.getElementById(id);
      if(!el) return false;
      el.textContent = (v===0) ? "0" : (v ? String(v) : "—");
      return true;
    }

    function fmtBySev(bySev){
      if(!bySev) return "";
      const order = ["CRITICAL","HIGH","MEDIUM","LOW","INFO","TRACE"];
      const out = [];
      for(const k of order){
        if(bySev[k] !== undefined) out.push(k + ":" + bySev[k]);
      }
      return out.join(" ");
    }

    function pickTool(byTool, want){
      if(!byTool) return null;
      if(byTool[want] !== undefined) return byTool[want];
      const key = Object.keys(byTool).find(k => String(k||"").toUpperCase() === want.toUpperCase());
      return key ? byTool[key] : null;
    }

    function applyExtras(rid, kpi){
      if(!kpi) return;
      const total = kpi.total ?? 0;
      const eff = kpi.effective ?? 0;
      const degr = kpi.degraded ?? 0;
      const unk = kpi.unknown_count ?? 0;
      const score = (kpi.score === undefined || kpi.score === null) ? "" : kpi.score;

      const status = (degr > 0) ? "DEGRADED" : (total > 0 ? "OK" : "EMPTY");

      // commercial 4tabs KPI ids (exist in template)
      setText("kpi-overall", score !== "" ? (score + "/100") : status);
      setText("kpi-overall-sub", `total ${total} | eff ${eff} | degr ${degr} | unk ${unk}`);

      setText("kpi-gate", status);
      setText("kpi-gate-sub", fmtBySev(kpi.by_sev));

      const gtl = pickTool(kpi.by_tool, "GITLEAKS");
      setText("kpi-gitleaks", (gtl === null) ? "NOT_RUN" : gtl);
      setText("kpi-gitleaks-sub", "GITLEAKS");

      const cql = pickTool(kpi.by_tool, "CODEQL");
      setText("kpi-codeql", (cql === null) ? "NOT_RUN" : cql);
      setText("kpi-codeql-sub", "CODEQL");

      // if dashboard_2025 ids exist, also fill
      setText("kpi-total", total);
      setText("kpi-effective", eff);
      setText("kpi-degraded", degr);
      setText("kpi-score", score);
    }

    function fetchExtras(rid){
      const u = "/api/vsp/dashboard_v3_extras_v1?rid=" + encodeURIComponent(rid || "");
      return fetch(u, {cache:"no-store"})
        .then(r => r.ok ? r.json() : null)
        .then(j => (j && j.ok && j.kpi) ? j.kpi : null)
        .catch(_ => null);
    }

    let lastRid = "";
    function hydrate(force){
      const rid = getRidBestEffort();
      if(!rid) return;
      if(!force && rid === lastRid) return;
      lastRid = rid;
      fetchExtras(rid).then(kpi => { if(kpi) applyExtras(rid, kpi); });
    }

    // run on navigation + periodic
    window.addEventListener("hashchange", () => setTimeout(() => hydrate(true), 120));
    setTimeout(() => hydrate(true), 300);
    setInterval(() => hydrate(false), 1500);
    setInterval(() => hydrate(true), 15000);
  })();
  // === /VSP_DASH_KPI_FROM_EXTRAS_P1_V4 ===


  // === VSP_DASHBOARD_KPI_WIRE_EXTRAS_P1_V2 ===
  (function(){
    if(window.__VSP_KPI_EXTRAS_WIRED_P1_V2) return;
    window.__VSP_KPI_EXTRAS_WIRED_P1_V2 = 1;

    function _ridFromState(){
      try{
        const candidates = [
          window.__vsp_rid_state,
          window.VSP_RID_STATE,
          window.VSP_RID_STATE_V1,
          window.__VSP_RID_STATE
        ].filter(Boolean);

        for(const st of candidates){
          if(typeof st.get === "function"){
            const r = st.get();
            if(r && (r.rid || r.run_id)) return (r.rid || r.run_id);
          }
          if(st && (st.rid || st.run_id)) return (st.rid || st.run_id);
          if(st && st.state && (st.state.rid || st.state.run_id)) return (st.state.rid || st.state.run_id);
        }
      }catch(_){}
      return "";
    }

    function getRidBestEffort(){
      const r0 = _ridFromState();
      if(r0) return String(r0).trim();

      // try DOM (some headers render RID: XXX)
      try{
        const body = document.body ? (document.body.innerText || "") : "";
        const m = body.match(/RID:\s*(VSP_[A-Z0-9_]+)/);
        if(m && m[1]) return m[1];
      }catch(_){}
      return "";
    }

    function setText(id, val){
      const el = document.getElementById(id);
      if(!el) return;
      el.textContent = (val===undefined || val===null || val==="") ? "—" : String(val);
    }

    function setSub(id, val){
      const el = document.getElementById(id);
      if(!el) return;
      el.textContent = (val===undefined || val===null) ? "" : String(val);
    }

    function fmtSev(bySev){
      if(!bySev) return "";
      const order = ["CRITICAL","HIGH","MEDIUM","LOW","INFO","TRACE"];
      const parts = [];
      for(const k of order){
        if(bySev[k]!==undefined && bySev[k]!==null) parts.push(k+":"+bySev[k]);
      }
      return parts.join(" ");
    }

    function pickTool(byTool, want){
      if(!byTool) return null;
      if(byTool[want]!==undefined) return byTool[want];
      try{
        const key = Object.keys(byTool).find(k => String(k||"").toUpperCase() === String(want).toUpperCase());
        if(key) return byTool[key];
      }catch(_){}
      return null;
    }

    function applyExtras(rid, kpi){
      if(!kpi) return;

      const total = kpi.total || 0;
      const eff = kpi.effective || 0;
      const degr = kpi.degraded || 0;
      const unk  = (kpi.unknown_count===undefined || kpi.unknown_count===null) ? "" : kpi.unknown_count;
      const score = (kpi.score===undefined || kpi.score===null) ? "" : kpi.score;

      const status = (degr>0) ? "DEGRADED" : (total>0 ? "OK" : "EMPTY");

      // These KPI ids are used by vsp_4tabs_commercial_v1.html (commercial panel)
      setText("kpi-overall", score!=="" ? (score + "/100") : status);
      setSub ("kpi-overall-sub", "total " + total + " | eff " + eff + " | degr " + degr + (unk!=="" ? (" | unk "+unk) : ""));

      setText("kpi-gate", status);
      setSub ("kpi-gate-sub", fmtSev(kpi.by_sev));

      const gtl = pickTool(kpi.by_tool, "GITLEAKS");
      setText("kpi-gitleaks", (gtl===null || gtl===undefined) ? "NOT_RUN" : gtl);
      setSub ("kpi-gitleaks-sub", (gtl===null || gtl===undefined) ? "tool=GITLEAKS missing" : ("tool=GITLEAKS | rid=" + rid));

      const cql = pickTool(kpi.by_tool, "CODEQL");
      setText("kpi-codeql", (cql===null || cql===undefined) ? "NOT_RUN" : cql);
      setSub ("kpi-codeql-sub", (cql===null || cql===undefined) ? "tool=CODEQL missing" : ("tool=CODEQL | rid=" + rid));
    }

    function fetchExtras(rid){
      const u = "/api/vsp/dashboard_v3_extras_v1?rid=" + encodeURIComponent(rid||"");
      return fetch(u, {cache:"no-store"})
        .then(r => r.ok ? r.json() : null)
        .then(j => (j && j.ok && j.kpi) ? j.kpi : null)
        .catch(_ => null);
    }

    let lastRid = "";
    function tick(force){
      const rid = getRidBestEffort();
      if(!rid) return;
      if(!force && rid === lastRid) return;
      lastRid = rid;

      fetchExtras(rid).then(kpi => {
        if(kpi) applyExtras(rid, kpi);
      });
    }

    window.addEventListener("hashchange", function(){ setTimeout(function(){ tick(true); }, 150); });
    document.addEventListener("visibilitychange", function(){ if(!document.hidden) setTimeout(function(){ tick(true); }, 150); });

    // first paint + periodic refresh
    setTimeout(function(){ tick(true); }, 300);
    setInterval(function(){ tick(false); }, 1500);
    setInterval(function(){ tick(true); }, 15000);
  })();


  // === VSP_DASHBOARD_USE_EXTRAS_P1_V2 ===
  function fetchDashboardExtras(rid){
    const u = `/api/vsp/dashboard_v3_extras_v1?rid=${encodeURIComponent(rid||"")}`;
    return fetch(u, {cache:"no-store"})
      .then(r => r.ok ? r.json() : null)
      .then(j => (j && j.ok && j.kpi) ? j.kpi : null)
      .catch(_ => null);
  }

  function setTextSafe(id, val){
    try{
      const el = document.getElementById(id);
      if(!el) return false;
      el.textContent = (val===null || val===undefined) ? "N/A" : String(val);
      return true;
    }catch(_){ return false; }
  }

  function applyKpiExtrasToDom(kpi){
    if(!kpi) return;
    // try common ids (non-breaking if missing)
    setTextSafe("kpi-total", kpi.total);
    setTextSafe("kpi-score", kpi.score);
    setTextSafe("kpi-effective", kpi.effective);
    setTextSafe("kpi-degraded", kpi.degraded);

    // also try a few other likely ids used in your UI patches
    setTextSafe("kpi-total-findings", kpi.total);
    setTextSafe("kpi-effective-findings", kpi.effective);
    setTextSafe("kpi-degraded-findings", kpi.degraded);
  }
  // === /VSP_DASHBOARD_USE_EXTRAS_P1_V2 ===


  // --- tiny utils ---
  const LOG_ONCE = new Set();
  function logOnce(k, ...a){ if(LOG_ONCE.has(k)) return; LOG_ONCE.add(k); console.log(...a); }
  function nowMs(){ try { return Date.now(); } catch(_){ return 0; } }

  function ridFromPage(){
    // best-effort: try globals, DOM attrs, URL params
    try {
      if (window.VSP_RID) return String(window.VSP_RID);
      if (window.__VSP_RID__) return String(window.__VSP_RID__);
    } catch(_){}
    try {
      const u = new URL(location.href);
      const rid = u.searchParams.get("rid") || u.searchParams.get("run_id") || u.searchParams.get("id");
    fetchDashboardExtras(rid).then(applyKpiExtrasToDom);
      if (rid) return String(rid);
    } catch(_){}
    try {
      const el = document.querySelector("[data-rid],[data-run-id],[data-runid]");
      const v = el && (el.getAttribute("data-rid") || el.getAttribute("data-run-id") || el.getAttribute("data-runid"));
      if (v) return String(v);
    } catch(_){}
    return null;
  }

  function openTab(tabId){
    // expects your 4-tabs router to exist; best-effort click
    try {
      // common patterns: button#tab-datasource / a[href='#datasource']
      const btn = document.querySelector("#tab-" + tabId + ", [data-tab='"+tabId+"'], a[href='#"+tabId+"']");
      if (btn) { btn.click(); return true; }
    } catch(_){}
    // fallback: try call existing router func if you have one
    try {
      if (typeof window.VSP_SWITCH_TAB === "function") { window.VSP_SWITCH_TAB(tabId); return true; }
      if (typeof window.vspSwitchTab === "function") { window.vspSwitchTab(tabId); return true; }
    } catch(_){}
    return false;
  }

  // --- datasource filter bus (localStorage + CustomEvent) ---
  const LS_KEY = "vsp_ds_filters_v1";

  function pushDatasourceFilters(filters, opts){
    opts = opts || {};
    const payload = {
      v: 1,
      ts: nowMs(),
      rid: opts.rid || ridFromPage(),
      filters: filters || {}
    };
    try { localStorage.setItem(LS_KEY, JSON.stringify(payload)); } catch(_){}
    try {
      window.dispatchEvent(new CustomEvent("vsp:datasource:setFilters", { detail: payload }));
    } catch(_){}
  }

  // public API for drilldown
  window.VSP_DRILL_TO_DATASOURCE = function(filters, opts){
    try {
      pushDatasourceFilters(filters || {}, opts || {});
      openTab("datasource");
    } catch(e) {
      console.warn("[VSP][DRILL] failed", e);
    }
  };

  // --- export probe: make it quiet + stop after first success ---
  async function probeExportOnce(url){
    // HEAD is often blocked/noisy in browser setups; fallback to GET safely.
    try {
      const r = await fetch(url, { method: "HEAD", cache: "no-store", credentials: "same-origin" });
      if (r && r.ok) return { ok:true, via:"HEAD", status:r.status, headers:r.headers };
    } catch(_){}
    try {
      const r = await fetch(url + (url.includes("?") ? "&" : "?") + "_probe=1", { method: "GET", cache: "no-store", credentials: "same-origin" });
      if (r && r.ok) return { ok:true, via:"GET", status:r.status, headers:r.headers };
      return { ok:false, via:"GET", status: (r && r.status) || 0, headers: r && r.headers };
    } catch(e){
      return { ok:false, via:"ERR", status:0, err:String(e) };
    }
  }

  async function commercialExportProbeQuiet(){
    // only run on pages that show export controls
    const rid = ridFromPage();
    if (!rid) return;

    // build canonical export URL once (commercial behavior)
    const base = (window.VSP_RUN_EXPORT_BASE || "/api/vsp/run_export_v3").replace(/\/+$/,"");
    const pdfUrl = base + "/" + encodeURIComponent(rid) + "?fmt=pdf";

    const key = "export-probe-" + rid;
    if (window.__VSP_EXPORT_PROBED__ && window.__VSP_EXPORT_PROBED__[rid]) return;
    window.__VSP_EXPORT_PROBED__ = window.__VSP_EXPORT_PROBED__ || {};
    window.__VSP_EXPORT_PROBED__[rid] = true;

    const res = await probeExportOnce(pdfUrl);
    // treat failures as non-fatal; do NOT spam console
    if (!res.ok){
      logOnce(key+"-fail", "[VSP][EXPORT][PROBE] pdf probe not OK (non-fatal)", { rid, url: pdfUrl, via: res.via, status: res.status });
      window.VSP_EXPORT_AVAILABLE = window.VSP_EXPORT_AVAILABLE || {};
      window.VSP_EXPORT_AVAILABLE.pdf = 0;
      return;
    }

    // success: set availability and stop further probes
    window.VSP_EXPORT_AVAILABLE = window.VSP_EXPORT_AVAILABLE || {};
    window.VSP_EXPORT_AVAILABLE.pdf = 1;
    logOnce(key+"-ok", "[VSP][EXPORT][PROBE] pdf available", { rid, via: res.via, status: res.status });

    // if you have UI pills/badges, update them quietly
    try {
      const pill = document.querySelector("[data-export='pdf'], #pill-export-pdf, #pill-pdf");
      if (pill) { pill.classList.add("is-ok"); pill.classList.remove("is-bad"); }
    } catch(_){}
  }

  // run once after DOM ready
  function onReady(fn){
    if (document.readyState === "complete" || document.readyState === "interactive") return setTimeout(fn, 0);
    document.addEventListener("DOMContentLoaded", fn, { once: true });
  }

  // --- attach drilldown click helpers (best-effort, non-breaking) ---
  function wireDrilldownClicks(){
    // opt-in attributes (recommended): data-vsp-drill-tool / data-vsp-drill-sev / data-vsp-drill-cwe
    const els = document.querySelectorAll("[data-vsp-drill-tool],[data-vsp-drill-sev],[data-vsp-drill-cwe]");
    els.forEach(el=>{
      if (el.__vsp_drilled__) return;
      el.__vsp_drilled__ = true;
      el.style.cursor = "pointer";
      el.addEventListener("click", ()=>{
        const tool = el.getAttribute("data-vsp-drill-tool");
        const sev  = el.getAttribute("data-vsp-drill-sev");
        const cwe  = el.getAttribute("data-vsp-drill-cwe");
        const filters = {};
        if (tool) filters.tool = tool;
        if (sev)  filters.severity = sev;
        if (cwe)  filters.cwe = cwe;
        window.VSP_DRILL_TO_DATASOURCE(filters);
      });
    });

    // fallback: gate summary pills often include tool/sev text
    const pills = document.querySelectorAll(".vsp-pill,[data-pill]");
    pills.forEach(p=>{
      if (p.__vsp_drilled__) return;
      const t = (p.textContent || "").trim();
      // simple patterns: "GITLEAKS", "SEMGREP", "CRITICAL", "HIGH", "CWE-79"
      // (intentionally empty; handled by wireFallbackPills)
    });
  }

  // NOTE: avoid python-style in JS; keep safe fallback only
  function wireFallbackPills(){
    const pills = document.querySelectorAll(".vsp-pill,[data-pill]");
    pills.forEach(p=>{
      if (p.__vsp_drilled__) return;
      const txt = (p.textContent || "").trim();
      if (!txt) return;

      const up = txt.toUpperCase();
      const filters = {};
      const toolSet = new Set(["GITLEAKS","SEMGREP","TRIVY","CODEQL","KICS","GRYPE","SYFT","BANDIT"]);
      const sevSet  = new Set(["CRITICAL","HIGH","MEDIUM","LOW","INFO","TRACE"]);
      if (toolSet.has(up)) filters.tool = up;
      if (sevSet.has(up))  filters.severity = up;
      if (/^CWE-\d+$/i.test(up)) filters.cwe = up;

      if (Object.keys(filters).length === 0) return;

      p.__vsp_drilled__ = true;
      p.style.cursor = "pointer";
      p.title = "Click to drilldown → Data Source";
      p.addEventListener("click", ()=> window.VSP_DRILL_TO_DATASOURCE(filters));
    });
  }

  onReady(()=>{
    try { commercialExportProbeQuiet(); } catch(e){ /* silent */ }
    try { wireDrilldownClicks(); } catch(e){ /* silent */ }
    try { wireFallbackPills(); } catch(e){ /* silent */ }
  });

})();


/* VSP_DASH_BADGES_P1_V1: Dashboard badges for Degraded tools + Rule Overrides delta (live RID) */
(function(){
  'use strict';

  async function _j(url, timeoutMs=6000){
    const ctrl = new AbortController();
    const t = setTimeout(()=>ctrl.abort(), timeoutMs);
    try{
      const r = await fetch(url, {signal: ctrl.signal, headers:{'Accept':'application/json'}});
      const ct = (r.headers.get('content-type')||'').toLowerCase();
      if(!ct.includes('application/json')) return null;
      return await r.json();
    }catch(e){
      return null;
    }finally{
      clearTimeout(t);
    }
  }

  function _getRidFromLocal(){
    const keys = ["vsp_selected_rid_v2","vsp_selected_rid","vsp_current_rid","VSP_RID","vsp_rid"];
    for(const k of keys){
      try{
        const v = localStorage.getItem(k);
        if(v && v !== "null" && v !== "undefined") return v;
      }catch(e){}
    }
    return null;
  }

  async function _getRid(){
    try{
      if(window.VSP_RID && typeof window.VSP_RID.get === "function"){
        const r = window.VSP_RID.get();
        if(r) return r;
      }
    }catch(e){}
    const l = _getRidFromLocal();
    if(l) return l;

    const x = await _j("/api/vsp/latest_rid_v1");
    if(x && x.ok && x.run_id) return x.run_id;
    return null;
  }

  function _findDashHost(){
    return document.getElementById("vsp4-dashboard")
      || document.querySelector("[data-tab='dashboard']")
      || document.querySelector("#tab-dashboard")
      || document.querySelector(".vsp-dashboard")
      || document.querySelector("main")
      || document.body;
  }

  function _ensureBar(){
    const host = _findDashHost();
    if(!host) return null;

    let bar = document.getElementById("vsp-dash-p1-badges");
    if(bar) return bar;

    bar = document.createElement("div");
    bar.id = "vsp-dash-p1-badges";
    bar.style.cssText = "margin:10px 0 12px 0;padding:10px 12px;border:1px solid rgba(148,163,184,.18);border-radius:14px;background:rgba(2,6,23,.35);display:flex;gap:10px;flex-wrap:wrap;align-items:center;";

    function pill(id, label){
      const a = document.createElement("a");
      a.href="#";
      a.id=id;
      a.style.cssText = "display:inline-flex;gap:8px;align-items:center;padding:7px 10px;border-radius:999px;border:1px solid rgba(148,163,184,.22);text-decoration:none;color:#cbd5e1;font-size:12px;white-space:nowrap;";
      a.innerHTML = `<b style="font-weight:700;color:#e2e8f0">${label}</b><span style="opacity:.9" data-val>loading…</span>`;
      return a;
    }

    bar.appendChild(pill("vsp-pill-degraded","Degraded"));
    bar.appendChild(pill("vsp-pill-overrides","Overrides"));
    bar.appendChild(pill("vsp-pill-rid","RID"));

    host.prepend(bar);
    return bar;
  }

  function _setPill(id, text){
    const a = document.getElementById(id);
    if(!a) return;
    const v = a.querySelector("[data-val]");
    if(v) v.textContent = text;
  }

  function _fmtDegraded(st){
    const arr = (st && st.degraded_tools) ? st.degraded_tools : [];
    if(!arr || !arr.length) return "none";
    const parts = [];
    for(const it of arr.slice(0,4)){
      const tool = it.tool || it.name || "tool";
      const rc = (it.rc !== undefined && it.rc !== null) ? `rc=${it.rc}` : "";
      const v  = it.verdict ? String(it.verdict) : "";
      const why = it.reason || it.error || it.note || "";
      const one = [tool, v, rc].filter(Boolean).join(":") + (why ? ` (${String(why).slice(0,30)})` : "");
      parts.push(one.trim());
    }
    return parts.join(" | ") + (arr.length>4 ? ` (+${arr.length-4})` : "");
  }

  function _fmtOverrides(eff){
    const d = (eff && eff.delta) ? eff.delta : {};
    const matched = d.matched_n ?? 0;
    const applied = d.applied_n ?? 0;
    const sup = d.suppressed_n ?? 0;
    const chg = d.changed_severity_n ?? 0;
    const exp = d.expired_match_n ?? 0;
    return `matched=${matched} applied=${applied} suppressed=${sup} changed=${chg} expired=${exp}`;
  }

  async function refresh(){
    _ensureBar();
    const rid = await _getRid();
    _setPill("vsp-pill-rid", rid || "n/a");
    if(!rid) return;

    const [st, eff] = await Promise.all([
      _j(`/api/vsp/run_status_v2/${encodeURIComponent(rid)}`),
      _j(`/api/vsp/findings_effective_v1/${encodeURIComponent(rid)}?limit=0`)
    ]);

    _setPill("vsp-pill-degraded", _fmtDegraded(st));
    _setPill("vsp-pill-overrides", _fmtOverrides(eff));
  }

  document.addEventListener("click", function(ev){
    const a = ev.target && ev.target.closest && ev.target.closest("#vsp-pill-degraded,#vsp-pill-overrides");
    if(!a) return;
    ev.preventDefault();
    try{
      if(window.VSP_DASH_DRILLDOWN && typeof window.VSP_DASH_DRILLDOWN.open === "function"){
        window.VSP_DASH_DRILLDOWN.open();
      }
    }catch(e){}
  }, true);

  window.addEventListener("vsp:rid_changed", function(){ refresh(); });
  window.addEventListener("hashchange", function(){ setTimeout(refresh, 120); });
  window.addEventListener("load", function(){ setTimeout(refresh, 200); });

  setTimeout(refresh, 250);
})();


/* VSP_DASH_BADGES_P1_V3_FIXEDBAR: ensure badges visible even if dashboard host selector mismatch */
(function(){
  'use strict';

  function _pickHost(){
    // 1) container that holds KPI cards
    const card = document.querySelector(".vsp-card, .dashboard-card, .card");
    if(card && card.parentElement) return card.parentElement;

    // 2) active tab pane (common patterns)
    const active = document.querySelector(".tab-pane.active, .tab-content .active, [role='tabpanel'][aria-hidden='false']");
    if(active) return active;

    // 3) main content region
    return document.querySelector("main") || document.body;
  }

  function _ensureFixedStyle(){
    if(document.getElementById("vsp-dash-fixed-style")) return;
    const st = document.createElement("style");
    st.id="vsp-dash-fixed-style";
    st.textContent = `
      #vsp-dash-p1-badges{ z-index:9999; }
      #vsp-dash-p1-badges.vsp-fixed{
        position: sticky;
        top: 0;
        backdrop-filter: blur(8px);
        background: rgba(2,6,23,.60) !important;
      }
    `;
    document.head.appendChild(st);
  }

  // override ensureBar from V1 (if exists) by recreating bar + sticky class
  function ensureBarV3(){
    _ensureFixedStyle();
    let bar = document.getElementById("vsp-dash-p1-badges");
    if(bar) {
      bar.classList.add("vsp-fixed");
      return bar;
    }
    const host = _pickHost();
    if(!host) return null;

    bar = document.createElement("div");
    bar.id = "vsp-dash-p1-badges";
    bar.className = "vsp-fixed";
    bar.style.cssText = "margin:0 0 12px 0;padding:10px 12px;border:1px solid rgba(148,163,184,.18);border-radius:14px;background:rgba(2,6,23,.35);display:flex;gap:10px;flex-wrap:wrap;align-items:center;";

    function pill(id, label){
      const a = document.createElement("a");
      a.href="#";
      a.id=id;
      a.style.cssText = "display:inline-flex;gap:8px;align-items:center;padding:7px 10px;border-radius:999px;border:1px solid rgba(148,163,184,.22);text-decoration:none;color:#cbd5e1;font-size:12px;white-space:nowrap;";
      a.innerHTML = `<b style="font-weight:700;color:#e2e8f0">${label}</b><span style="opacity:.9" data-val>loading…</span>`;
      return a;
    }

    bar.appendChild(pill("vsp-pill-degraded","Degraded"));
    bar.appendChild(pill("vsp-pill-overrides","Overrides"));
    bar.appendChild(pill("vsp-pill-rid","RID"));

    host.prepend(bar);
    return bar;
  }

  // kick once after load to guarantee visibility
  window.addEventListener("load", function(){
    setTimeout(()=>{ try{ ensureBarV3(); }catch(e){} }, 200);
  });
  window.addEventListener("hashchange", function(){
    setTimeout(()=>{ try{ ensureBarV3(); }catch(e){} }, 120);
  });
  window.addEventListener("vsp:rid_changed", function(){
    setTimeout(()=>{ try{ ensureBarV3(); }catch(e){} }, 50);
  });
})();


/* VSP_DASH_DRILLDOWN_P1_V1: openable drilldown panel for Degraded + Overrides */
(function(){
  'use strict';

  async function _j(url, timeoutMs=8000){
    const ctrl = new AbortController();
    const t = setTimeout(()=>ctrl.abort(), timeoutMs);
    try{
      const r = await fetch(url, {signal: ctrl.signal, headers:{'Accept':'application/json'}});
      const ct = (r.headers.get('content-type')||'').toLowerCase();
      if(!ct.includes('application/json')) return null;
      return await r.json();
    }catch(e){
      return null;
    }finally{
      clearTimeout(t);
    }
  }

  function _getRidFromLocal(){
    const keys = ["vsp_selected_rid_v2","vsp_selected_rid","vsp_current_rid","VSP_RID","vsp_rid"];
    for(const k of keys){
      try{
        const v = localStorage.getItem(k);
        if(v && v !== "null" && v !== "undefined") return v;
      }catch(e){}
    }
    return null;
  }

  async function _getRid(){
    try{
      if(window.VSP_RID && typeof window.VSP_RID.get === "function"){
        const r = window.VSP_RID.get();
        if(r) return r;
      }
    }catch(e){}
    const l = _getRidFromLocal();
    if(l) return l;
    const x = await _j("/api/vsp/latest_rid_v1");
    if(x && x.ok && x.run_id) return x.run_id;
    return null;
  }

  function _ensureUI(){
    if(document.getElementById("vsp-dd-overlay")) return;

    const st = document.createElement("style");
    st.id = "vsp-dd-style";
    st.textContent = `
      #vsp-dd-overlay{position:fixed;inset:0;z-index:10000;background:rgba(0,0,0,.55);display:none;}
      #vsp-dd-panel{position:fixed;top:60px;right:18px;bottom:18px;width:min(820px,calc(100vw - 36px));
        z-index:10001;background:rgba(2,6,23,.96);border:1px solid rgba(148,163,184,.18);border-radius:18px;
        box-shadow:0 20px 80px rgba(0,0,0,.55);display:none;overflow:hidden;}
      #vsp-dd-head{display:flex;align-items:center;justify-content:space-between;padding:14px 14px;border-bottom:1px solid rgba(148,163,184,.14);}
      #vsp-dd-title{font-weight:800;color:#e2e8f0;font-size:14px;letter-spacing:.2px}
      #vsp-dd-actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
      .vsp-dd-btn{padding:7px 10px;border-radius:12px;border:1px solid rgba(148,163,184,.22);background:rgba(15,23,42,.55);
        color:#cbd5e1;font-size:12px;cursor:pointer}
      .vsp-dd-btn:hover{filter:brightness(1.08)}
      #vsp-dd-body{padding:14px;overflow:auto;height:calc(100% - 56px);color:#cbd5e1}
      .vsp-dd-card{border:1px solid rgba(148,163,184,.14);border-radius:16px;background:rgba(15,23,42,.35);padding:12px 12px;margin-bottom:12px;}
      .vsp-dd-kv{display:grid;grid-template-columns:160px 1fr;gap:6px 12px;font-size:12px;}
      .vsp-dd-k{opacity:.85}
      .vsp-dd-v{color:#e2e8f0}
      .vsp-dd-table{width:100%;border-collapse:separate;border-spacing:0 8px;font-size:12px;}
      .vsp-dd-table td{padding:8px 10px;border:1px solid rgba(148,163,184,.14);background:rgba(2,6,23,.35);}
      .vsp-dd-table tr td:first-child{border-radius:12px 0 0 12px;}
      .vsp-dd-table tr td:last-child{border-radius:0 12px 12px 0;}
      .vsp-dd-muted{opacity:.75}
      .vsp-dd-link{color:#93c5fd;text-decoration:none}
      .vsp-dd-link:hover{text-decoration:underline}
      code.vsp-dd-code{background:rgba(2,6,23,.6);border:1px solid rgba(148,163,184,.16);padding:2px 6px;border-radius:8px}
    `;
    document.head.appendChild(st);

    const ov = document.createElement("div");
    ov.id="vsp-dd-overlay";
    ov.addEventListener("click", close);
    document.body.appendChild(ov);

    const panel = document.createElement("div");
    panel.id="vsp-dd-panel";
    panel.innerHTML = `
      <div id="vsp-dd-head">
        <div id="vsp-dd-title">Drilldown</div>
        <div id="vsp-dd-actions">
          <button class="vsp-dd-btn" id="vsp-dd-refresh">Refresh</button>
          <button class="vsp-dd-btn" id="vsp-dd-copy">Copy RID</button>
          <button class="vsp-dd-btn" id="vsp-dd-close">Close</button>
        </div>
      </div>
      <div id="vsp-dd-body">
        <div class="vsp-dd-card"><div class="vsp-dd-muted">Loading…</div></div>
      </div>
    `;
    document.body.appendChild(panel);

    document.getElementById("vsp-dd-close").addEventListener("click", close);
    document.getElementById("vsp-dd-refresh").addEventListener("click", render);
    document.getElementById("vsp-dd-copy").addEventListener("click", async ()=>{
      const rid = await _getRid();
      try{ await navigator.clipboard.writeText(rid||""); }catch(e){}
    });

    window.addEventListener("keydown", (e)=>{
      if(e.key === "Escape") close();
    });
  }

  function open(){
    _ensureUI();
    document.getElementById("vsp-dd-overlay").style.display="block";
    document.getElementById("vsp-dd-panel").style.display="block";
    render();
  }

  function close(){
    const ov=document.getElementById("vsp-dd-overlay");
    const pn=document.getElementById("vsp-dd-panel");
    if(ov) ov.style.display="none";
    if(pn) pn.style.display="none";
  }

  function _fmtOverrides(eff){
    const d = (eff && eff.delta) ? eff.delta : {};
    const matched = d.matched_n ?? 0;
    const applied = d.applied_n ?? 0;
    const sup = d.suppressed_n ?? 0;
    const chg = d.changed_severity_n ?? 0;
    const exp = d.expired_match_n ?? 0;
    return {matched, applied, sup, chg, exp, now_utc: d.now_utc || ""};
  }

  function _htmlEscape(x){
    return String(x||"").replace(/[&<>"]/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;" }[c]));
  }

  async function render(){
    _ensureUI();
    const body = document.getElementById("vsp-dd-body");
    const title = document.getElementById("vsp-dd-title");
    const rid = await _getRid();
    title.textContent = rid ? `Drilldown • ${rid}` : "Drilldown • (no RID)";

    if(!rid){
      body.innerHTML = `<div class="vsp-dd-card"><div class="vsp-dd-muted">No RID selected.</div></div>`;
      return;
    }

    body.innerHTML = `<div class="vsp-dd-card"><div class="vsp-dd-muted">Loading ${_htmlEscape(rid)}…</div></div>`;

    const [st, eff, art] = await Promise.all([
      _j(`/api/vsp/run_status_v2/${encodeURIComponent(rid)}`),
      _j(`/api/vsp/findings_effective_v1/${encodeURIComponent(rid)}?limit=0`),
      _j(`/api/vsp/run_artifacts_index_v1/${encodeURIComponent(rid)}`)
    ]);

    const degraded = (st && st.degraded_tools) ? st.degraded_tools : [];
    const ov = _fmtOverrides(eff);

    let artHtml = `<div class="vsp-dd-muted">Artifacts: n/a</div>`;
    if(art && (art.ok || art.items)){
      const items = art.items || [];
      const links = items.slice(0,10).map(it=>{
        const name = _htmlEscape(it.name || it.file || "artifact");
        const url  = it.url || it.href || it.download_url || "";
        if(url) return `<a class="vsp-dd-link" href="${_htmlEscape(url)}" target="_blank" rel="noopener">${name}</a>`;
        return `<span class="vsp-dd-muted">${name}</span>`;
      });
      artHtml = `<div class="vsp-dd-muted">Artifacts:</div><div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:6px;">${links.join(" ") || '<span class="vsp-dd-muted">empty</span>'}</div>`;
    }

    const degradedRows = (degraded||[]).map(it=>{
      const tool=_htmlEscape(it.tool || it.name || "");
      const verdict=_htmlEscape(it.verdict || "");
      const rc=(it.rc!==undefined && it.rc!==null) ? _htmlEscape(it.rc) : "";
      const reason=_htmlEscape(it.reason || it.error || it.note || "");
      return `<tr>
        <td><b>${tool}</b></td>
        <td>${verdict || '<span class="vsp-dd-muted">—</span>'}</td>
        <td>${rc || '<span class="vsp-dd-muted">—</span>'}</td>
        <td>${reason || '<span class="vsp-dd-muted">—</span>'}</td>
      </tr>`;
    }).join("");

    body.innerHTML = `
      <div class="vsp-dd-card">
        <div style="font-weight:800;color:#e2e8f0;margin-bottom:8px;">Overview</div>
        <div class="vsp-dd-kv">
          <div class="vsp-dd-k">RID</div><div class="vsp-dd-v"><code class="vsp-dd-code">${_htmlEscape(rid)}</code></div>
          <div class="vsp-dd-k">Overrides delta</div><div class="vsp-dd-v">matched=${ov.matched} • applied=${ov.applied} • suppressed=${ov.sup} • changed=${ov.chg} • expired=${ov.exp}</div>
          <div class="vsp-dd-k">Delta time</div><div class="vsp-dd-v">${_htmlEscape(ov.now_utc) || '<span class="vsp-dd-muted">—</span>'}</div>
          <div class="vsp-dd-k">Degraded tools</div><div class="vsp-dd-v">${(degraded||[]).length || 0}</div>
        </div>
        <div style="margin-top:10px;">${artHtml}</div>
      </div>

      <div class="vsp-dd-card">
        <div style="font-weight:800;color:#e2e8f0;margin-bottom:8px;">Degraded details</div>
        ${(degraded && degraded.length) ? `
          <table class="vsp-dd-table">
            <tr>
              <td><b>Tool</b></td><td><b>Verdict</b></td><td><b>RC</b></td><td><b>Reason</b></td>
            </tr>
            ${degradedRows}
          </table>
        ` : `<div class="vsp-dd-muted">No degraded tools.</div>`}
      </div>
    `;
  }

  window.VSP_DASH_DRILLDOWN = { open, close, render };
})();

VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2

/* VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2: pin important artifacts + quick-open buttons */
(function(){
  'use strict';
  if(!window.VSP_DASH_DRILLDOWN || typeof window.VSP_DASH_DRILLDOWN.render !== "function"){
    console.warn("[DRILL_ART_V2] VSP_DASH_DRILLDOWN missing; skip");
    return;
  }

  const PIN = [
    "kics/kics.log",
    "codeql/codeql.log",
    "trivy/trivy.json.err",
    "findings_effective.json",
    "findings_unified.json",
  ];

  function _pinSort(items){
    const byName = new Map((items||[]).map(x=>[x.name, x]));
    const out = [];
    for(const name of PIN){
      if(byName.has(name)) out.push(byName.get(name));
      else out.push({name, url:null, size:null, missing:true});
    }
    // append rest (non-duplicates)
    for(const it of (items||[])){
      if(!PIN.includes(it.name)) out.push(it);
    }
    return out;
  }

  function _qBtn(name, url){
    const disabled = !url;
    return `<a class="vsp-dd-btn" style="text-decoration:none;display:inline-flex;align-items:center;gap:6px;${disabled?'opacity:.55;pointer-events:none;':''}"
      href="${url?String(url).replace(/"/g,'&quot;'):'#'}" target="_blank" rel="noopener">
      Open <b style="color:#e2e8f0">${name}</b>
    </a>`;
  }

  // Monkey patch: wrap the existing render to decorate artifacts area after it renders
  const _origRender = window.VSP_DASH_DRILLDOWN.render;
  window.VSP_DASH_DRILLDOWN.render = async function(){
    await _origRender();

    try{
      const body = document.getElementById("vsp-dd-body");
      if(!body) return;

      // Fetch artifacts again to pin + show quick actions (cheap)
      const title = document.getElementById("vsp-dd-title");
      const rid = (title && title.textContent && title.textContent.includes("•")) ? title.textContent.split("•").pop().trim() : null;
      if(!rid) return;

      const r = await fetch(`/api/vsp/run_artifacts_index_v1/${encodeURIComponent(rid)}`, {headers:{'Accept':'application/json'}});
      const j = await r.json();
      const items = _pinSort((j && j.items) ? j.items : []);

      const quick = items.slice(0,5).map(it=>{
        const nm = it.name.split("/").pop();
        return _qBtn(nm, it.url);
      }).join("");

      // Inject a top "Quick open" strip
      let q = document.getElementById("vsp-dd-quickopen");
      if(!q){
        q = document.createElement("div");
        q.id = "vsp-dd-quickopen";
        q.className="vsp-dd-card";
        q.innerHTML = `<div style="font-weight:800;color:#e2e8f0;margin-bottom:8px;">Quick open</div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;">${quick}</div>`;
        body.prepend(q);
      } else {
        const _box = q.querySelector("div[style*=\"display:flex\"]");
      if(_box) _box.innerHTML = quick;
      }

      // Replace the artifacts section in Overview card (best-effort)
      const cards = body.querySelectorAll(".vsp-dd-card");
      let overview = null;
      for(const c of cards){
        if((c.textContent||"").includes("Overview")){ overview = c; break; }
      }
      if(overview){
        const links = items.slice(0,10).map(it=>{
          const nm = it.name;
          if(it.url) return `<a class="vsp-dd-link" href="${it.url}" target="_blank" rel="noopener">${nm}</a>`;
          return `<span class="vsp-dd-muted">${nm} (missing)</span>`;
        }).join(" ");
        // find "Artifacts:" label
        const html = overview.innerHTML;
        const rep = `<div class="vsp-dd-muted">Artifacts:</div><div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:6px;">${links || '<span class="vsp-dd-muted">empty</span>'}</div>`;
        overview.innerHTML = html.replace(/<div class="vsp-dd-muted">Artifacts:[\s\S]*?<\/div>\s*<\/div>\s*<\/div>/m, rep + "</div></div>")
                                .replace(/<div class="vsp-dd-muted">Artifacts:[\s\S]*?<\/div>/m, rep);
      }
    }catch(e){
      console.warn("[DRILL_ART_V2] err", e);
    }
  };

  console.log("[DRILL_ART_V2] installed");
})();

VSP_DASH_OPEN_REPORT_BTN_V1

/* VSP_DASH_OPEN_REPORT_BTN_V1: open CIO report for live RID */
(function(){
  'use strict';
  function normRid(x){
    if(!x) return "";
    return String(x).trim().replace(/^RID:\s*/i,'').replace(/^RUN_/i,'');
  }
  function getRid(){
    try{
      return normRid(localStorage.getItem("vsp_rid_selected_v2") || localStorage.getItem("vsp_rid_selected") || "");
    }catch(e){ return ""; }
  }

  function inject(){
    // try to attach near badges bar if exists; else top of body
    const host = document.getElementById("vsp-dash-p1-badges") || document.body;
    if(!host) return;

    if(document.getElementById("vsp-open-cio-report-btn")) return;

    const btn = document.createElement("button");
    btn.id = "vsp-open-cio-report-btn";
    btn.textContent = "Open CIO Report";
    btn.style.cssText = "margin-left:10px; padding:8px 10px; border-radius:10px; font-size:12px; border:1px solid rgba(148,163,184,.35); background:rgba(2,6,23,.55); color:#e2e8f0; cursor:pointer;";
    btn.addEventListener("click", function(){
      const rid = getRid();
      if(!rid){ alert("No RID selected"); return; }
      window.open("/vsp/report_cio_v1/" + encodeURIComponent(rid), "_blank", "noopener");
    });

    // put into badges bar if possible
    if(host && host.id === "vsp-dash-p1-badges"){
      host.appendChild(btn);
    }else{
      document.body.insertBefore(btn, document.body.firstChild);
    }
  }

  if(document.readyState === "loading") document.addEventListener("DOMContentLoaded", inject);
  else inject();
})();

VSP_DASH_KPI_EFFECTIVE_DEGRADED_P1_V4

/* VSP_DASH_KPI_EFFECTIVE_DEGRADED_P1_V4: show effective/raw + overrides delta + degraded clickable logs */
(function(){
  'use strict';

  function normRid(x){
    if(!x) return "";
    return String(x).trim().replace(/^RID:\s*/i,'').replace(/^RUN_/i,'');
  }
  function getRid(){
    try{
      return normRid(localStorage.getItem("vsp_rid_selected_v2") || localStorage.getItem("vsp_rid_selected") || "");
    }catch(e){ return ""; }
  }
  async function jget(url){
    const r = await fetch(url, {cache:"no-store"});
    const ct = (r.headers.get("content-type")||"");
    if(!r.ok) throw new Error("HTTP "+r.status+" "+url);
    if(ct.includes("application/json")) return await r.json();
    // tolerate non-json
    return {ok:false, _nonjson:true, text: await r.text()};
  }
  function ensureBar(){
    let bar = document.getElementById("vsp-dash-p1-badges");
    if(!bar){
      bar = document.createElement("div");
      bar.id="vsp-dash-p1-badges";
      bar.style.cssText="position:sticky;top:0;z-index:9999;margin:10px 0;padding:10px;border-radius:14px;border:1px solid rgba(148,163,184,.18);background:rgba(2,6,23,.45);backdrop-filter: blur(6px);display:flex;flex-wrap:wrap;gap:10px;align-items:center;";
      document.body.insertBefore(bar, document.body.firstChild);
    }
    return bar;
  }
  function pill(txt, tone){
    const map = {
      ok: "border:1px solid rgba(34,197,94,.35);",
      warn:"border:1px solid rgba(245,158,11,.35);",
      bad: "border:1px solid rgba(239,68,68,.35);",
      info:"border:1px solid rgba(148,163,184,.25);"
    };
    return `<span style="display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:rgba(2,6,23,.35);color:#e2e8f0;font-size:12px;${map[tone]||map.info}">${txt}</span>`;
  }
  function linkPill(label, url, tone){
    const map = {
      ok: "border:1px solid rgba(34,197,94,.35);",
      warn:"border:1px solid rgba(245,158,11,.35);",
      bad: "border:1px solid rgba(239,68,68,.35);",
      info:"border:1px solid rgba(148,163,184,.25);"
    };
    return `<a target="_blank" rel="noopener" href="${url}"
      style="display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:rgba(2,6,23,.35);color:#e2e8f0;font-size:12px;text-decoration:none;${map[tone]||map.info}">
      ${label}</a>`;
  }

  function pickLogRel(tool){
    const t = String(tool||"").toLowerCase();
    if(t.includes("kics")) return "kics/kics.log";
    if(t.includes("trivy")) return "trivy/trivy.json.err";
    if(t.includes("codeql")) return "codeql/codeql.log";
    if(t.includes("semgrep")) return "semgrep/semgrep.json";
    if(t.includes("gitleaks")) return "gitleaks/gitleaks.json";
    if(t.includes("bandit")) return "bandit/bandit.json";
    if(t.includes("syft")) return "syft/syft.json";
    if(t.includes("grype")) return "grype/grype.json";
    return "";
  }
  function artUrl(rid, rel){
    return "/api/vsp/run_artifact_raw_v1/" + encodeURIComponent(rid) + "?rel=" + encodeURIComponent(rel);
  }

  async function render(){
    const bar = ensureBar();
    const rid = getRid() || (await jget("/api/vsp/latest_rid_v1")).run_id;
    const ridN = normRid(rid||"");
    if(!ridN){
      bar.innerHTML = pill("RID: (none)", "warn") + pill("No RID selected", "warn");
      return;
    }

    let eff=null, st=null;
    try{
      eff = await jget("/api/vsp/findings_effective_v1/" + encodeURIComponent(ridN) + "?limit=0");
    }catch(e){
      eff = {ok:false, error:String(e)};
    }
    try{
      st = await jget("/api/vsp/run_status_v2/" + encodeURIComponent(ridN));
    }catch(e){
      st = {ok:false, error:String(e)};
    }

    const rawTotal = eff && typeof eff.raw_total==="number" ? eff.raw_total : null;
    const effTotal = eff && typeof eff.effective_total==="number" ? eff.effective_total : null;
    const d = (eff && eff.delta) ? eff.delta : {};
    const sup = (d && typeof d.suppressed_n==="number") ? d.suppressed_n : null;
    const chg = (d && typeof d.changed_severity_n==="number") ? d.changed_severity_n : null;
    const match = (d && typeof d.matched_n==="number") ? d.matched_n : null;
    const applied = (d && typeof d.applied_n==="number") ? d.applied_n : null;

    const degraded = (st && st.degraded_tools && Array.isArray(st.degraded_tools)) ? st.degraded_tools : [];
    const degrN = degraded.length;

    let html = "";
    html += pill("RID: "+ridN, "info");
    if(rawTotal!=null && effTotal!=null){
      const tone = (effTotal < rawTotal) ? "ok" : "info";
      html += pill(`Effective ${effTotal} / Raw ${rawTotal}`, tone);
    }else{
      html += pill("Effective/Raw: n/a", "warn");
    }

    if(match!=null) html += pill(`Overrides matched: ${match}`, "info");
    if(applied!=null) html += pill(`Overrides applied: ${applied}`, applied>0 ? "ok" : "info");
    if(sup!=null) html += pill(`Suppressed: ${sup}`, sup>0 ? "ok" : "info");
    if(chg!=null) html += pill(`Severity changed: ${chg}`, chg>0 ? "ok" : "info");

    // degraded clickable
    if(degrN>0){
      html += pill(`Degraded tools: ${degrN}`, "warn");
      degraded.slice(0,8).forEach(t=>{
        const rel = pickLogRel(t);
        if(rel) html += linkPill(`${t} log`, artUrl(ridN, rel), "warn");
        else html += pill(String(t), "warn");
      });
    }else{
      html += pill("Degraded: 0", "ok");
    }

    // quick links
    html += linkPill("CIO Report", "/vsp/report_cio_v1/"+encodeURIComponent(ridN), "info");
    html += linkPill("Unified.json", artUrl(ridN,"findings_unified.json"), "info");
    html += linkPill("Effective.json", artUrl(ridN,"findings_effective.json"), "info");

    bar.innerHTML = html;
  }

  // initial + refresh when RID changes (poll)
  let lastRid="";
  async function tick(){
    const rid=getRid();
    if(rid && rid!==lastRid){
      lastRid=rid;
      await render();
    }
  }

  if(document.readyState==="loading"){
    document.addEventListener("DOMContentLoaded", ()=>{ render(); setInterval(tick, 1200); });
  }else{
    render(); setInterval(tick, 1200);
  }
})();

/* VSP_DASH_TREND_SPARKLINE_V1_BEGIN */
(function(){
  'use strict';
  if (window.__VSP_DASH_TREND_SPARKLINE_V1_INSTALLED) return;
  window.__VSP_DASH_TREND_SPARKLINE_V1_INSTALLED = true;

  const LOGP = "[VSP_TREND]";
  const API = "/api/vsp/runs_index_v3_fs_resolved?limit=20&hide_empty=0&filter=1";

  function q(sel){ try{return document.querySelector(sel);}catch(e){return null;} }
  function mountPoint(){
    return (
      q("#vsp4-dashboard") ||
      q("#tab-dashboard") ||
      q("[data-tab='dashboard']") ||
      q("#dashboard") ||
      q(".vsp-dashboard") ||
      q("main") ||
      document.body
    );
  }
  function el(tag, attrs, children){
    const n=document.createElement(tag);
    if (attrs){
      for (const k of Object.keys(attrs)){
        if (k === "class") n.className = attrs[k];
        else if (k === "style") n.setAttribute("style", attrs[k]);
        else n.setAttribute(k, attrs[k]);
      }
    }
    (children||[]).forEach(c=>{
      if (c==null) return;
      if (typeof c === "string") n.appendChild(document.createTextNode(c));
      else n.appendChild(c);
    });
    return n;
  }

  function drawSpark(canvas, series){
    if (!canvas) return;
    const ctx = canvas.getContext("2d");
    const w = canvas.width, h = canvas.height;
    ctx.clearRect(0,0,w,h);

    if (!Array.isArray(series) || series.length < 2){
      ctx.globalAlpha = 0.6;
      ctx.fillText("no data", 6, 14);
      ctx.globalAlpha = 1;
      return;
    }
    let min=Infinity, max=-Infinity;
    for (const v of series){
      if (typeof v !== "number" || !isFinite(v)) continue;
      min = Math.min(min, v);
      max = Math.max(max, v);
    }
    if (!isFinite(min) || !isFinite(max)){ min=0; max=1; }
    if (max === min) max = min + 1;

    const pad = 6;
    const xStep = (w - pad*2) / (series.length - 1);
    function y(v){
      const t = (v - min) / (max - min);
      return (h - pad) - t * (h - pad*2);
    }

    // mid grid
    ctx.globalAlpha = 0.18;
    ctx.beginPath();
    ctx.moveTo(pad, Math.round(h/2)+0.5);
    ctx.lineTo(w-pad, Math.round(h/2)+0.5);
    ctx.stroke();
    ctx.globalAlpha = 1;

    // line
    ctx.beginPath();
    for (let i=0;i<series.length;i++){
      const v = (typeof series[i] === "number" && isFinite(series[i])) ? series[i] : 0;
      const xx = pad + i*xStep;
      const yy = y(v);
      if (i===0) ctx.moveTo(xx,yy);
      else ctx.lineTo(xx,yy);
    }
    ctx.lineWidth = 2;
    ctx.stroke();

    // last dot
    const lastV = (typeof series[series.length-1] === "number" && isFinite(series[series.length-1])) ? series[series.length-1] : 0;
    ctx.beginPath();
    ctx.arc(w-pad, y(lastV), 2.6, 0, Math.PI*2);
    ctx.fill();
  }

  function fmtInt(n){ try { return (Number(n)||0).toLocaleString(); } catch(e){ return String(n||0); } }

  async function run(){
    try{
      const res = await fetch(API, {cache:"no-store"});
      if (!res.ok) { console.warn(LOGP, "runs_index not ok", res.status); return; }
      const js = await res.json();
      const items = (js && js.items) ? js.items : [];
      if (!Array.isArray(items) || items.length === 0) return;

      const rows = items.slice().reverse(); // old->new
      const findings = rows.map(it => Number(it.total_findings ?? it.findings_total ?? it.total ?? 0) || 0);
      const degraded = rows.map(it => {
        const any = (it.degraded_any ?? it.is_degraded);
        const dn = Number(it.degraded_n ?? it.degraded_count ?? 0) || 0;
        return (any === true || dn > 0) ? 1 : 0;
      });

      const latest = rows[rows.length-1] || {};
      const latestRid = latest.run_id || latest.id || "";

      const root = mountPoint();
      if (!root) return;
      if (q("#vsp-trend-sparkline-card")) return;

      const card = el("div", {
        id: "vsp-trend-sparkline-card",
        class: "vsp-card vsp-card-trend",
        style: "margin-top:14px;border:1px solid rgba(148,163,184,.16);background:rgba(2,6,23,.72);border-radius:14px;padding:14px 14px 12px;box-shadow:0 10px 30px rgba(0,0,0,.25)"
      });

      const header = el("div", {style:"display:flex;justify-content:space-between;gap:12px;align-items:baseline;flex-wrap:wrap;"}, [
        el("div", null, [
          el("div", {style:"font-weight:700;font-size:14px;letter-spacing:.2px;"}, ["Trend (last 20 runs)"]),
          el("div", {style:"opacity:.75;font-size:12px;margin-top:4px;"}, [
            "Latest: ", latestRid ? latestRid : "(unknown)",
            " • Findings: ", fmtInt(findings[findings.length-1]),
            " • Degraded: ", degraded[degraded.length-1] ? "YES" : "NO"
          ])
        ])
      ]);

      const grid = el("div", {style:"display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px;"});
      function panel(title, id){
        const c = el("canvas", {id, width:"520", height:"88", style:"width:100%;height:88px;border-radius:12px;border:1px solid rgba(148,163,184,.12);background:rgba(15,23,42,.55);"});
        const box = el("div", {style:"padding:10px 10px 8px;border-radius:12px;background:rgba(15,23,42,.35);border:1px solid rgba(148,163,184,.10);"}, [
          el("div", {style:"font-size:12px;opacity:.8;margin-bottom:8px;font-weight:600;"}, [title]),
          c
        ]);
        return {box, c};
      }
      const p1 = panel("Total Findings", "vsp-trend-findings");
      const p2 = panel("Degraded (0/1)", "vsp-trend-degraded");
      grid.appendChild(p1.box); grid.appendChild(p2.box);

      card.appendChild(header);
      card.appendChild(grid);

      const anchor = q("#vsp-kpi-wrap") || q("#vsp-kpi-cards") || q(".vsp-kpi") || null;
      if (anchor && anchor.parentElement) anchor.parentElement.insertBefore(card, anchor.nextSibling);
      else root.appendChild(card);

      try{
        const css = window.getComputedStyle(card);
        [p1.c, p2.c].forEach(cv=>{
          const ctx=cv.getContext("2d");
          ctx.strokeStyle = css.color || "#e5e7eb";
          ctx.fillStyle = css.color || "#e5e7eb";
        });
      }catch(e){}

      drawSpark(p1.c, findings);
      drawSpark(p2.c, degraded);

      p1.c.title = "Total Findings (old→new): " + findings.join(", ");
      p2.c.title = "Degraded (old→new): " + degraded.join(", ");

      console.log(LOGP, "trend rendered", {points: rows.length});
    }catch(e){
      console.warn(LOGP, "trend error", e);
    }
  }

  if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", run);
  else run();
})();
 /* VSP_DASH_TREND_SPARKLINE_V1_END */

/* VSP_DASH_TREND_SPARKLINE_V2_BEGIN */
(function(){
  'use strict';

  function $(sel){ return document.querySelector(sel); }
  function el(tag, cls){ const e=document.createElement(tag); if(cls) e.className=cls; return e; }
  function sstr(x){ return (typeof x === 'string') ? x.trim() : ''; }

  function findKpiMount(){
    // try common containers (robust across templates)
    const cands = [
      '#vsp-kpi-row', '#kpi-row', '#kpi-cards', '.vsp-kpi-row', '.kpi-row',
      '.vsp-kpi-grid', '.kpi-grid', '.dashboard-kpis', '.dashboard-kpi-grid',
      '.vsp-main .vsp-grid', '.vsp-main'
    ];
    for (const sel of cands){
      const n = document.querySelector(sel);
      if (n) return n;
    }
    // fallback: first large section in dashboard pane
    return document.querySelector('#pane-dashboard, #tab-dashboard, main') || document.body;
  }

  async function fetchRuns(){
    try{
      const res = await fetch('/api/vsp/runs_index_v3_fs_resolved?limit=12&hide_empty=0&filter=1', {credentials:'same-origin'});
      if (!res.ok) return [];
      const js = await res.json();
      return js.items || [];
    }catch(_e){
      return [];
    }
  }

  function parseKeyFromRid(rid){
    rid = sstr(rid);
    const m = rid.match(/(\d{8})_(\d{6})/);
    if (!m) return null;
    return m[1] + m[2];
  }

  function buildSeries(items){
    // sort ascending by rid timestamp
    const arr = (items||[]).map(it=>{
      const rid = sstr(it.run_id || it.rid || '');
      const key = parseKeyFromRid(rid) || rid;
      const v = Number(it.total_findings ?? it.findings_total ?? it.total ?? 0) || 0;
      return {rid, key, v};
    }).filter(x=>x.rid && x.key).sort((a,b)=> (a.key>b.key?1:(a.key<b.key?-1:0)));
    // keep last 10
    return arr.slice(Math.max(0, arr.length-10));
  }

  function drawSpark(canvas, series){
    const ctx = canvas.getContext('2d');
    const w = canvas.width, h = canvas.height;
    ctx.clearRect(0,0,w,h);

    if (!series || series.length < 2){
      // empty state
      ctx.globalAlpha = 0.5;
      ctx.beginPath();
      ctx.moveTo(6, h/2);
      ctx.lineTo(w-6, h/2);
      ctx.stroke();
      ctx.globalAlpha = 1;
      return;
    }

    const vals = series.map(x=>x.v);
    let vmin = Math.min.apply(null, vals);
    let vmax = Math.max.apply(null, vals);
    if (vmax === vmin) vmax = vmin + 1;

    const pad = 6;
    const dx = (w - pad*2) / (series.length - 1);

    ctx.lineWidth = 2;
    ctx.beginPath();
    for (let i=0;i<series.length;i++){
      const v = series[i].v;
      const x = pad + i*dx;
      const y = pad + (h - pad*2) * (1 - (v - vmin) / (vmax - vmin));
      if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    }
    ctx.stroke();

    // end dot
    const last = series[series.length-1].v;
    const x = pad + (series.length-1)*dx;
    const y = pad + (h - pad*2) * (1 - (last - vmin) / (vmax - vmin));
    ctx.beginPath(); ctx.arc(x,y,3,0,Math.PI*2); ctx.fill();
  }

  function ensureCard(){
    const id = 'vsp-trend-spark-card-v2';
    let card = document.getElementById(id);
    if (card) return card;

    const mount = findKpiMount();

    card = el('div', 'vsp-card dashboard-card');
    card.id = id;
    card.style.maxWidth = '420px';
    card.style.padding = '12px 14px';
    card.style.borderRadius = '14px';
    card.style.margin = '8px 8px 8px 0';

    const h = el('div');
    h.style.display='flex';
    h.style.justifyContent='space-between';
    h.style.alignItems='baseline';
    h.style.gap='10px';

    const title = el('div');
    title.innerHTML = '<div style="font-weight:700;letter-spacing:.2px">Trend (last 10)</div><div style="opacity:.7;font-size:12px">Total findings by run</div>';

    const stat = el('div');
    stat.id = 'vsp-trend-spark-stat-v2';
    stat.style.textAlign='right';
    stat.style.fontWeight='700';

    h.appendChild(title);
    h.appendChild(stat);

    const canvas = el('canvas');
    canvas.id = 'vsp-trend-spark-cv-v2';
    canvas.width = 360;
    canvas.height = 64;
    canvas.style.width = '100%';
    canvas.style.height = '64px';
    canvas.style.marginTop = '10px';
    canvas.style.borderRadius = '10px';

    card.appendChild(h);
    card.appendChild(canvas);

    // prepend so it appears early
    if (mount && mount.firstChild) mount.insertBefore(card, mount.firstChild);
    else (mount || document.body).appendChild(card);

    return card;
  }

  async function render(){
    const card = ensureCard();
    if (!card) return;

    const items = await fetchRuns();
    const series = buildSeries(items);

    const stat = document.getElementById('vsp-trend-spark-stat-v2');
    const cv = document.getElementById('vsp-trend-spark-cv-v2');

    if (stat){
      const n = series.length;
      const last = n ? series[n-1].v : 0;
      const prev = n>1 ? series[n-2].v : 0;
      const delta = (n>1) ? (last - prev) : 0;
      const pct = (n>1 && prev) ? (delta * 100.0 / prev) : 0;
      stat.innerHTML = `<div style="font-size:16px">${last.toLocaleString()}</div><div style="opacity:.75;font-size:12px">${(delta>=0?'+':'')}${delta.toLocaleString()} (${(pct>=0?'+':'')}${pct.toFixed(1)}%)</div>`;
    }
    if (cv && cv.getContext) drawSpark(cv, series);
  }

  // run on dashboard load and also after refresh clicks
  document.addEventListener('DOMContentLoaded', function(){
    setTimeout(render, 650);
    document.addEventListener('click', function(ev){
      const t = ev.target;
      if (!t) return;
      const txt = (t.textContent||'').toLowerCase();
      if (txt.includes('refresh')) setTimeout(render, 400);
    }, true);
  });
})();
 /* VSP_DASH_TREND_SPARKLINE_V2_END */



/* ==== END static/js/vsp_dashboard_enhance_v1.js ==== */
;
;
/* ==== BEGIN static/js/vsp_dashboard_charts_pretty_v3.js ==== */

/* vsp_dashboard_charts_pretty_v3.js
 * CLEAN REBUILD (no Chart.js dependency)
 * - Exports: window.VSP_CHARTS_ENGINE_V3.initAll(dash)
 * - Auto-creates canvases inside placeholders:
 *     #vsp-chart-severity, #vsp-chart-trend, #vsp-chart-bytool, #vsp-chart-topcwe
 * - Dispatches: window event "vsp:charts-ready"
 */
(function () {
  "use strict";
  console.log("[VSP_CHARTS_V3] pretty charts loaded (CLEAN REBUILD v1)");

  if (window.__VSP_CHARTS_V3_REBUILD_LOADED) return;
  window.__VSP_CHARTS_V3_REBUILD_LOADED = true;

  var HOLDERS = {
    severity: "vsp-chart-severity",
    trend: "vsp-chart-trend",
    bytool: "vsp-chart-bytool",
    topcwe: "vsp-chart-topcwe"
  };

  function $(id) { return document.getElementById(id); }

  function ensureCanvasIn(holderId, canvasId) {
    var holder = $(holderId);
    if (!holder) return null;

    // if holder itself is a canvas
    if (holder.tagName && holder.tagName.toLowerCase() === "canvas") return holder;

    // existing canvas?
    var existing = holder.querySelector ? holder.querySelector("canvas") : null;
    if (existing) return existing;

    var c = document.createElement("canvas");
    c.id = canvasId;
    c.style.width = "100%";
    c.style.height = "100%";
    c.width = Math.max(480, holder.clientWidth || 480);
    c.height = Math.max(220, holder.clientHeight || 220);
    holder.appendChild(c);
    return c;
  }

  function resizeCanvasToHolder(canvas, holderId) {
    try {
      var holder = $(holderId);
      if (!holder || !canvas) return;
      var w = Math.max(480, holder.clientWidth || 480);
      var h = Math.max(220, holder.clientHeight || 220);
      if (canvas.width !== w) canvas.width = w;
      if (canvas.height !== h) canvas.height = h;
    } catch (e) {}
  }

  function clear(ctx) {
    ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
  }

  function drawText(ctx, text) {
    clear(ctx);
    ctx.save();
    ctx.fillStyle = "#cbd5e1";
    ctx.font = "14px Inter, system-ui, sans-serif";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText(text, ctx.canvas.width / 2, ctx.canvas.height / 2);
    ctx.restore();
  }

  function drawDonut(ctx, items) {
    // items: [{label, value}]
    clear(ctx);
    var W = ctx.canvas.width, H = ctx.canvas.height;
    var cx = W * 0.35, cy = H * 0.5;
    var rOuter = Math.min(W, H) * 0.28;
    var rInner = rOuter * 0.58;

    var sum = 0;
    for (var i=0;i<items.length;i++) sum += Math.max(0, +items[i].value || 0);
    if (!sum) return drawText(ctx, "No data");

    // palette (no hard theme dependency)
    var palette = ["#ef4444","#f97316","#f59e0b","#22c55e","#60a5fa","#a78bfa","#94a3b8"];
    var start = -Math.PI / 2;

    for (var j=0;j<items.length;j++) {
      var v = Math.max(0, +items[j].value || 0);
      var ang = (v / sum) * Math.PI * 2;
      ctx.beginPath();
      ctx.moveTo(cx, cy);
      ctx.arc(cx, cy, rOuter, start, start + ang, false);
      ctx.closePath();
      ctx.fillStyle = palette[j % palette.length];
      ctx.globalAlpha = 0.85;
      ctx.fill();
      start += ang;
    }
    ctx.globalAlpha = 1;

    // hole
    ctx.beginPath();
    ctx.arc(cx, cy, rInner, 0, Math.PI * 2);
    ctx.fillStyle = "#0b1020";
    ctx.fill();

    // total
    ctx.save();
    ctx.fillStyle = "#e5e7eb";
    ctx.font = "700 18px Inter, system-ui, sans-serif";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText(String(sum), cx, cy - 2);
    ctx.font = "12px Inter, system-ui, sans-serif";
    ctx.fillStyle = "#94a3b8";
    ctx.fillText("total", cx, cy + 18);
    ctx.restore();

    // legend
    var lx = W * 0.62, ly = H * 0.22;
    ctx.save();
    ctx.font = "12px Inter, system-ui, sans-serif";
    ctx.textAlign = "left";
    ctx.textBaseline = "middle";
    for (var k=0;k<items.length;k++) {
      var y = ly + k * 18;
      ctx.fillStyle = palette[k % palette.length];
      ctx.globalAlpha = 0.85;
      ctx.fillRect(lx, y - 6, 10, 10);
      ctx.globalAlpha = 1;
      ctx.fillStyle = "#cbd5e1";
      ctx.fillText(items[k].label + ": " + (items[k].value || 0), lx + 14, y);
    }
    ctx.restore();
  }

  function drawBar(ctx, items, title) {
    clear(ctx);
    var W = ctx.canvas.width, H = ctx.canvas.height;
    if (!items || !items.length) return drawText(ctx, "No data");

    var max = 0;
    for (var i=0;i<items.length;i++) max = Math.max(max, +items[i].value || 0);
    if (!max) return drawText(ctx, "No data");

    var padL=48, padR=16, padT=28, padB=28;
    var plotW = W - padL - padR;
    var plotH = H - padT - padB;

    ctx.save();
    ctx.fillStyle = "#94a3b8";
    ctx.font = "12px Inter, system-ui, sans-serif";
    ctx.textAlign = "left";
    ctx.fillText(title || "Bar", padL, 18);
    ctx.restore();

    // axes
    ctx.save();
    ctx.strokeStyle = "rgba(255,255,255,0.08)";
    ctx.beginPath();
    ctx.moveTo(padL, padT);
    ctx.lineTo(padL, padT + plotH);
    ctx.lineTo(padL + plotW, padT + plotH);
    ctx.stroke();
    ctx.restore();

    var n = items.length;
    var gap = Math.max(6, plotW * 0.02);
    var bw = (plotW - gap * (n - 1)) / n;

    for (var j=0;j<n;j++) {
      var v = +items[j].value || 0;
      var h = (v / max) * plotH;
      var x = padL + j * (bw + gap);
      var y = padT + (plotH - h);

      ctx.fillStyle = "rgba(96,165,250,0.75)";
      ctx.fillRect(x, y, bw, h);

      ctx.save();
      ctx.fillStyle = "#cbd5e1";
      ctx.font = "11px Inter, system-ui, sans-serif";
      ctx.textAlign = "center";
      ctx.textBaseline = "top";
      var lab = items[j].label;
      if (lab && lab.length > 10) lab = lab.slice(0, 9) + "…";
      ctx.fillText(lab || "", x + bw/2, padT + plotH + 6);
      ctx.restore();
    }
  }

  function drawLine(ctx, series, title) {
    clear(ctx);
    var W = ctx.canvas.width, H = ctx.canvas.height;
    if (!series || series.length < 2) return drawText(ctx, "No trend data");

    var padL=48, padR=16, padT=28, padB=28;
    var plotW = W - padL - padR;
    var plotH = H - padT - padB;

    var min=Infinity, max=-Infinity;
    for (var i=0;i<series.length;i++) {
      var v = +series[i].value || 0;
      min = Math.min(min, v);
      max = Math.max(max, v);
    }
    if (max === min) { max = min + 1; }

    ctx.save();
    ctx.fillStyle = "#94a3b8";
    ctx.font = "12px Inter, system-ui, sans-serif";
    ctx.textAlign = "left";
    ctx.fillText(title || "Trend", padL, 18);
    ctx.restore();

    // axes
    ctx.save();
    ctx.strokeStyle = "rgba(255,255,255,0.08)";
    ctx.beginPath();
    ctx.moveTo(padL, padT);
    ctx.lineTo(padL, padT + plotH);
    ctx.lineTo(padL + plotW, padT + plotH);
    ctx.stroke();
    ctx.restore();

    function px(i) {
      return padL + (i / (series.length - 1)) * plotW;
    }
    function py(v) {
      return padT + (1 - (v - min) / (max - min)) * plotH;
    }

    ctx.save();
    ctx.strokeStyle = "rgba(34,197,94,0.85)";
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(px(0), py(series[0].value));
    for (var j=1;j<series.length;j++) {
      ctx.lineTo(px(j), py(series[j].value));
    }
    ctx.stroke();

    // points
    ctx.fillStyle = "rgba(34,197,94,0.9)";
    for (var k=0;k<series.length;k++) {
      ctx.beginPath();
      ctx.arc(px(k), py(series[k].value), 3, 0, Math.PI*2);
      ctx.fill();
    }
    ctx.restore();
  }

  function normalizeSeverity(dash) {
    var s = (dash && dash.by_severity) ? dash.by_severity : {};
    // accept either VSP levels or generic
    var keys = ["CRITICAL","HIGH","MEDIUM","LOW","INFO","TRACE"];
    var out = [];
    for (var i=0;i<keys.length;i++) {
      var k = keys[i];
      var v = 0;
      if (typeof s[k] === "number") v = s[k];
      else if (s[k] && typeof s[k].count === "number") v = s[k].count;
      out.push({ label: k, value: v });
    }
    return out;
  }

  function normalizeByTool(dash) {
    var bt = (dash && dash.by_tool) ? dash.by_tool : {};
    var items = [];
    // bt could be {tool:count} or {tool:{total}} etc.
    for (var k in bt) {
      if (!Object.prototype.hasOwnProperty.call(bt, k)) continue;
      var v = bt[k];
      var n = (typeof v === "number") ? v :
              (v && typeof v.total === "number") ? v.total :
              (v && typeof v.count === "number") ? v.count : 0;
      items.push({ label: k, value: n });
    }
    items.sort(function(a,b){ return (b.value||0) - (a.value||0); });
    return items.slice(0, 6);
  }

  function normalizeTopCWE(dash) {
    var list = (dash && dash.top_cwe_list) ? dash.top_cwe_list : [];
    var items = [];
    for (var i=0;i<list.length;i++) {
      var x = list[i] || {};
      var lab = x.cwe || x.id || x.name || ("CWE-" + (i+1));
      var v = x.count || x.n || x.total || 0;
      items.push({ label: String(lab), value: +v || 0 });
    }
    items.sort(function(a,b){ return (b.value||0)-(a.value||0); });
    return items.slice(0, 6);
  }

  function normalizeTrend(dash) {
    // If no historical series, create a tiny synthetic series from totals
    var total = (dash && dash.total_findings) ? +dash.total_findings :
                (dash && dash.summary_all && dash.summary_all.total_findings) ? +dash.summary_all.total_findings :
                (dash && dash.totals && dash.totals.total) ? +dash.totals.total : 0;
    if (!total) total = 0;
    return [
      { label: "t-3", value: Math.max(0, Math.round(total*0.55)) },
      { label: "t-2", value: Math.max(0, Math.round(total*0.72)) },
      { label: "t-1", value: Math.max(0, Math.round(total*0.88)) },
      { label: "now", value: total }
    ];
  }

  function dispatchReady(detail) {
    try {
      window.dispatchEvent(new CustomEvent("vsp:charts-ready", { detail: detail || { engine:"V3", ts: Date.now() } }));
    } catch (e) {
      try {
        var ev = document.createEvent("Event");
        ev.initEvent("vsp:charts-ready", true, true);
        window.dispatchEvent(ev);
      } catch (_) {}
    }
  }

  window.VSP_CHARTS_ENGINE_V3 = {
    initAll: function (dash) {
      try {
        // create canvases and render
        var cSev = ensureCanvasIn(HOLDERS.severity, "vsp-severity-canvas");
        var cTr  = ensureCanvasIn(HOLDERS.trend, "vsp-trend-canvas");
        var cBt  = ensureCanvasIn(HOLDERS.bytool, "vsp-bytool-canvas");
        var cCwe = ensureCanvasIn(HOLDERS.topcwe, "vsp-topcwe-canvas");

        if (cSev) resizeCanvasToHolder(cSev, HOLDERS.severity);
        if (cTr)  resizeCanvasToHolder(cTr,  HOLDERS.trend);
        if (cBt)  resizeCanvasToHolder(cBt,  HOLDERS.bytool);
        if (cCwe) resizeCanvasToHolder(cCwe, HOLDERS.topcwe);

        if (cSev) drawDonut(cSev.getContext("2d"), normalizeSeverity(dash));
        if (cTr)  drawLine(cTr.getContext("2d"), normalizeTrend(dash), "Findings trend (synthetic)");
        if (cBt)  drawBar(cBt.getContext("2d"), normalizeByTool(dash), "Top tools");
        if (cCwe) drawBar(cCwe.getContext("2d"), normalizeTopCWE(dash), "Top CWE");

        console.log("[VSP_CHARTS_V3] initAll OK");
        return true;
      } catch (e) {
        console.warn("[VSP_CHARTS_V3] initAll failed", e);
        return false;
      }
    }
  };

  // Auto-init if dashboard already stored data
  try {
    if (window.__VSP_DASH_LAST_DATA_V3) {
      window.VSP_CHARTS_ENGINE_V3.initAll(window.__VSP_DASH_LAST_DATA_V3);
    }
  } catch (e) {}

  // Inform other modules (dashboard enhance) that charts engine is ready
  dispatchReady({ engine: "V3", ts: Date.now() });

  // Re-render on resize (lightweight)
  window.addEventListener("resize", function () {
    try {
      if (window.__VSP_DASH_LAST_DATA_V3) {
        window.VSP_CHARTS_ENGINE_V3.initAll(window.__VSP_DASH_LAST_DATA_V3);
      }
    } catch (e) {}
  });

})();

// === VSP_CHARTS_READY_EVENT_V1 ===

(function(){
  try{
    if (window.__VSP_CHARTS_READY_EVENT_V1) return;
    window.__VSP_CHARTS_READY_EVENT_V1 = true;
    window.dispatchEvent(new CustomEvent('vsp:charts-ready', { detail: { engine: 'V3' } }));
    console.log('[VSP_CHARTS] vsp:charts-ready dispatched (V3).');
  }catch(e){}
})();



/* ==== END static/js/vsp_dashboard_charts_pretty_v3.js ==== */
;
;
/* ==== BEGIN static/js/vsp_dashboard_charts_bootstrap_v1.js ==== */

/* VSP_DASHBOARD_CHARTS_BOOTSTRAP_V1 (P0 commercial v2)
 * - bounded retries
 * - always attempts initAll (even if container heuristic fails)
 * - empty-state has safe fallback mount (main/body) => no "missing chart container" warn
 */
(function(){
  'use strict';

  if (window.__VSP_CHARTS_BOOT_SAFE_V4) return;
  window.__VSP_CHARTS_BOOT_SAFE_V4 = true;

  const TAG = 'VSP_CHARTS_BOOT_SAFE_V4';
  const MAX_TRIES = 8;
  const BASE_DELAY_MS = 250;

  let tries = 0;
  let locked = false;
  let lastReason = '';
  let warnedOnce = false;

  const SELS = [
    '#vsp_charts_root',
    '#vsp_charts_container',
    '#vsp-dashboard-charts',
    '#dashboard_charts',
    '#charts_container',
    '#chart-container',
    '.vsp-charts',
    '[data-vsp-charts]',
    '[data-vsp-charts-root]'
  ];

  function nowISO(){ try { return new Date().toISOString(); } catch(_) { return ''; } }

  function esc(s){
    return String(s ?? '')
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'","&#039;");
  }

  function pickMount(){
    // 1) explicit known selectors
    for (const s of SELS){
      const el = document.querySelector(s);
      if (el) return el;
    }

    // 2) heuristic: find chart cards by common classes
    const card = document.querySelector('.vsp-card .chart, .dashboard-card .chart, .vsp-card, .dashboard-card');
    if (card) return card;

    // 3) safe fallback: main/app/root/body (commercial: always render somewhere)
    return document.querySelector('main') ||
           document.querySelector('#app') ||
           document.querySelector('#root') ||
           document.body;
  }

  function ensureStyles(){
    if (document.getElementById('vsp-charts-empty-style-v2')) return;
    const st = document.createElement('style');
    st.id = 'vsp-charts-empty-style-v2';
    st.textContent = `
      .vsp-charts-empty{border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.03);
        border-radius:14px;padding:14px;margin-top:10px}
      .vsp-charts-empty-hd{display:flex;align-items:center;justify-content:space-between;gap:10px}
      .vsp-charts-empty-title{font-weight:800;letter-spacing:.2px}
      .vsp-charts-empty-sub{margin-top:6px;font-size:12px;opacity:.85;display:grid;gap:4px}
      .vsp-charts-empty-reason{font-size:12px;opacity:.75}
      .vsp-charts-empty-btn{margin-top:10px;display:inline-flex;align-items:center;gap:8px;
        padding:7px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.14);
        background:rgba(255,255,255,.06);cursor:pointer;font-weight:700;font-size:12px}
      .vsp-charts-empty-btn:hover{background:rgba(255,255,255,.10)}
      .vsp-charts-empty-pill{font-size:12px;font-weight:900;padding:5px 10px;border-radius:999px;
        border:1px solid rgba(255,255,255,.12);background:rgba(255,190,0,.14)}
    `;
    document.head.appendChild(st);
  }

  function renderEmptyState(reason){
    ensureStyles();
    const mount = pickMount();

    const html = `
      <div class="vsp-charts-empty" data-vsp-charts-empty="1">
        <div class="vsp-charts-empty-hd">
          <div class="vsp-charts-empty-title">Charts</div>
          <div class="vsp-charts-empty-pill">WAITING</div>
        </div>
        <div class="vsp-charts-empty-sub">
          <div class="vsp-charts-empty-reason">${esc(reason || 'waiting for chart data')}</div>
          <div>Updated: ${esc(nowISO())}</div>
        </div>
        <button class="vsp-charts-empty-btn" type="button" id="vspChartsRetryBtn">Retry charts</button>
      </div>
    `;

    const existing = mount.querySelector ? mount.querySelector('[data-vsp-charts-empty="1"]') : null;
    if (existing){
      const rr = existing.querySelector('.vsp-charts-empty-reason');
      if (rr) rr.textContent = reason || 'waiting for chart data';
    } else if (mount && mount.prepend){
      const w = document.createElement('div');
      w.innerHTML = html;
      mount.prepend(w.firstElementChild);
    }

    const btn = (mount && mount.querySelector) ? mount.querySelector('#vspChartsRetryBtn') : null;
    if (btn && !btn.__bound){
      btn.__bound = true;
      btn.addEventListener('click', function(){
        tries = 0; locked = false;
        scheduleTry('manual retry');
      });
    }
  }

  function clearEmptyState(){
    const mount = pickMount();
    const el = (mount && mount.querySelector) ? mount.querySelector('[data-vsp-charts-empty="1"]') : null;
    if (el) el.remove();
  }

  function pickEngine(){
    if (window.VSP_CHARTS_ENGINE_V3 && typeof window.VSP_CHARTS_ENGINE_V3.initAll === 'function'){
      return { tag:'VSP_CHARTS_ENGINE_V3', eng: window.VSP_CHARTS_ENGINE_V3 };
    }
    if (window.VSP_CHARTS_ENGINE && typeof window.VSP_CHARTS_ENGINE.initAll === 'function'){
      return { tag:'VSP_CHARTS_ENGINE', eng: window.VSP_CHARTS_ENGINE };
    }
    if (typeof window.vspChartsInitAll === 'function'){
      return { tag:'window.vspChartsInitAll', eng: { initAll: window.vspChartsInitAll } };
    }
    return null;
  }

  function computeDelay(n){ return Math.min(1200, BASE_DELAY_MS + (n * 120)); }

  async function tryInit(reasonTag){
    if (locked) return false;
    locked = true;
    tries += 1;

    const pe = pickEngine();
    if (!pe){
      lastReason = 'charts module not loaded (engine missing)';
      locked = false;
      return false;
    }

    try{
      pe.eng.initAll(reasonTag || TAG);
      clearEmptyState();
      console.log(`[${TAG}] initAll OK via`, pe.tag, 'tries=', tries);
      return true;
    }catch(e){
      lastReason = `initAll failed: ${e && e.message ? e.message : String(e)}`;
      if (!warnedOnce){
        warnedOnce = true;
        console.warn(`[${TAG}] initAll failed (bounded retry)`, e);
      }
      locked = false;
      return false;
    }
  }

  function scheduleTry(tag){
    const delay = computeDelay(tries);
    setTimeout(async () => {
      const ok = await tryInit(tag);
      if (ok) return;

      if (tries >= MAX_TRIES){
        renderEmptyState(lastReason || `no chart data (tries=${tries}/${MAX_TRIES})`);
        console.log(`[${TAG}] done: empty-state shown; tries=${tries}/${MAX_TRIES}; reason=`, lastReason);
        return;
      }

      renderEmptyState(lastReason || `waiting for chart data (tries=${tries}/${MAX_TRIES})`);
      scheduleTry(tag);
    }, delay);
  }

  function boot(){
    tries = 0; locked = false; lastReason = ''; warnedOnce = false;
    scheduleTry('boot');
  }

  window.VSP_CHARTS_BOOT_SAFE_V4 = { boot, refresh: () => scheduleTry('refresh') };

  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', boot, { once:true });
  } else {
    boot();
  }

  window.addEventListener('vsp:rid_changed', () => scheduleTry('rid_changed'));
})();


/* ==== END static/js/vsp_dashboard_charts_bootstrap_v1.js ==== */
;
;
/* ==== BEGIN static/js/vsp_dashboard_charts_v1.js ==== */


function vspNormalizeTopModule(m) {
  if (!m) return 'N/A';
  if (typeof m === 'string') return m;
  try {
    if (m.label) return String(m.label);
    if (m.path) return String(m.path);
    if (m.id)   return String(m.id);
    return String(m);
  } catch (e) {
    return 'N/A';
  }
}

'use strict';

(function () {
  const LOG = '[VSP_DASHBOARD_CHARTS]';

  function percent(part, total) {
    if (!total || total <= 0) return 0;
    return Math.round((part * 100) / total);
  }

  function renderSeverity(model) {
    const host = document.getElementById('vsp-chart-severity');
    if (!host) return;

    const sev =
      model.severity_cards ||
      model.summary_by_severity ||
      {};
    const total =
      model.total_findings ??
      model.total ??
      0;

    const order = ['CRITICAL', 'HIGH', 'MEDIUM', 'LOW', 'INFO', 'TRACE'];
    const labels = {
      CRITICAL: 'Critical',
      HIGH: 'High',
      MEDIUM: 'Medium',
      LOW: 'Low',
      INFO: 'Info',
      TRACE: 'Trace'
    };

    const rows = order.map(k => {
      const v = sev[k] ?? 0;
      const p = percent(v, total);
      return `
        <div class="vsp-chart-row">
          <div class="vsp-chart-label">${labels[k]}</div>
          <div class="vsp-chart-bar-wrap">
            <div class="vsp-chart-bar" style="width:${p}%;"></div>
          </div>
          <div class="vsp-chart-value">${v} (${p}%)</div>
        </div>
      `;
    }).join('');

    host.innerHTML = rows || '<div class="vsp-chart-empty">Chưa có dữ liệu severity.</div>';
  }

  function renderTopTool(model) {
    const host = document.getElementById('vsp-chart-tool');
    if (!host) return;

    const top = model.top_risky_tool_detail || model.top_risky_tool;
    if (!top || typeof top === 'string') {
      host.innerHTML = '<div class="vsp-chart-empty">Dữ liệu chi tiết theo tool chưa sẵn có.</div>';
      return;
    }

    const entries = Array.isArray(top) ? top : Object.entries(top);

    const rows = entries.map(([name, count]) => {
      const v = typeof count === 'number' ? count : (count.total || 0);
      return `
        <div class="vsp-chart-row">
          <div class="vsp-chart-label">${name}</div>
          <div class="vsp-chart-bar-wrap">
            <div class="vsp-chart-bar" style="width:100%;"></div>
          </div>
          <div class="vsp-chart-value">${v}</div>
        </div>
      `;
    }).join('');

    host.innerHTML = rows || '<div class="vsp-chart-empty">Không có dữ liệu tool.</div>';
  }

  function renderTopCwe(model) {
    const host = document.getElementById('vsp-chart-cwe');
    if (!host) return;

    const top = model.top_cwe_detail || model.top_impacted_cwe;
    if (!top || typeof top === 'string') {
      host.innerHTML = '<div class="vsp-chart-empty">Dữ liệu chi tiết theo CWE chưa sẵn có.</div>';
      return;
    }

    const entries = Array.isArray(top) ? top : Object.entries(top);

    const rows = entries.map(([name, count]) => {
      const v = typeof count === 'number' ? count : (count.total || 0);
      return `
        <div class="vsp-chart-row">
          <div class="vsp-chart-label">${name}</div>
          <div class="vsp-chart-bar-wrap">
            <div class="vsp-chart-bar" style="width:100%;"></div>
          </div>
          <div class="vsp-chart-value">${v}</div>
        </div>
      `;
    }).join('');

    host.innerHTML = rows || '<div class="vsp-chart-empty">Không có dữ liệu CWE.</div>';
  }

  function render(model) {
    if (!model) return;
    console.log(LOG, 'Render charts from model');
    renderSeverity(model);
    renderTopTool(model);
    renderTopCwe(model);
  }

  window.vspRenderChartsFromDashboard = render;

  document.addEventListener('DOMContentLoaded', function () {
    if (window.VSP_DASHBOARD_MODEL) {
      render(window.VSP_DASHBOARD_MODEL);
    }
  });
})();


/* ==== END static/js/vsp_dashboard_charts_v1.js ==== */
;
;
/* ==== BEGIN static/js/vsp_dashboard_charts_v2.js ==== */

// VSP_DASHBOARD_CHARTS_V2_STUB
// Legacy charts_v2 đã được thay bằng pretty_v3.

(function () {
  console.log('[VSP_CHARTS_V2_STUB] legacy charts_v2 replaced by pretty_v3');

  function forwardToV3(dashboard) {
    if (window.VSP_DASHBOARD_CHARTS_V3 &&
        typeof window.VSP_DASHBOARD_CHARTS_V3.updateFromDashboard === 'function') {
      try {
        window.VSP_DASHBOARD_CHARTS_V3.updateFromDashboard(dashboard);
      } catch (e) {
        console.error('[VSP_CHARTS_V2_STUB] error in V3 charts', e);
      }
    } else {
      console.warn('[VSP_CHARTS_V2_STUB] V3 charts chưa sẵn, skip.');
    }
  }

  // Global API mà vsp_dashboard_enhance_v1.js dùng
  window.VSP_DASHBOARD_CHARTS = window.VSP_DASHBOARD_CHARTS || {};
  window.VSP_DASHBOARD_CHARTS.updateFromDashboard = forwardToV3;
  window.vspDashboardChartsUpdateFromDashboard = forwardToV3;
})();


/* ==== END static/js/vsp_dashboard_charts_v2.js ==== */
;
;
/* ==== BEGIN static/js/vsp_dashboard_cleanup_v1.js ==== */

// static/js/vsp_dashboard_cleanup_v1.js
// TẠM THỜI VÔ HIỆU – không ẩn gì hết, chỉ log cho dễ debug.

(function () {
  'use strict';
  console.log('[VSP_DASH_CLEANUP] disabled – no legacy block is hidden.');
})();


/* ==== END static/js/vsp_dashboard_cleanup_v1.js ==== */
;
;
/* ==== BEGIN static/js/vsp_dashboard_comm_enhance_v1.js ==== */

// VSP_SAFE_DRILLDOWN_HARDEN_P0_V6

  // VSP_DD_LOCAL_SAFE_VAR_V1: force local callable symbol (prevents TypeError forever)
  try{
    function __vsp_dd_stub_local(){
      try{ console.info("[VSP][DD] local-safe stub invoked"); }catch(_){}
      return {open:function(){},show:function(){},close:function(){},destroy:function(){}};
    }
    try{
      if (typeof window !== "undefined") {


/* VSP_FIX_DRILLDOWN_ARTIFACTS_NOT_FUNCTION_P0_V2
 * Fix: TypeError __VSP_DD_ART_CALL__(VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2, ...) is not a function
 * Normalize BEFORE first use:
 *   - if function: keep
 *   - if object with .open(): wrap as function(arg)->obj.open(arg)
 *   - else: no-op (never throw)
 */
(function(){
  'use strict';
  



/* VSP_FIX_DRILLDOWN_CALLSITE_P0_V5: safe-call drilldown artifacts (function OR object.open) */
function __VSP_DD_ART_CALL__(h, ...args) {
  try {
    if (typeof h === 'function') return h(...args);
    if (h && typeof h.open === 'function') return h.open(...args);
  } catch(e) { try{console.warn('[VSP][DD_SAFE]', e);}catch(_e){} }
  return null;
}

/* VSP_FIX_DRILLDOWN_CALLSITE_P0_V3: safe-call for drilldown artifacts (function OR object.open) */
function __VSP_DD_ART_CALL__(h, ...args) {
  try {
    if (typeof h === 'function') return h(...args);
    if (h && typeof h.open === 'function') return h.open(...args);
  } catch (e) {
    try { console.warn('[VSP][DD_SAFE] call failed', e); } catch (_e) {}
  }
  return null;
}

if (window.__VSP_FIX_DRILLDOWN_ARTIFACTS_NOT_FUNCTION_P0_V2) return;
  window.__VSP_FIX_DRILLDOWN_ARTIFACTS_NOT_FUNCTION_P0_V2 = 1;

  function normalize(v){
    if (typeof v === 'function') return v;
    if (v && typeof v.open === 'function') {
      const obj = v;
      const fn = function(arg){ try { return obj.open(arg); } catch(e){ console.warn('[VSP][DD_FIX] open() failed', e); return null; } };
      fn.__wrapped_from_object = true;
      return fn;
    }
    const noop = function(_arg){ return null; };
    noop.__noop = true;
    return noop;
  }

  try {
    // trap future assignments
    let _val = window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2;
    Object.defineProperty(window, 'VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2', {
      configurable: true, enumerable: true,
      get: function(){ return _val; },
      set: function(v){ _val = normalize(v); }
    });
    window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 = _val;
  } catch(e) {
    window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 = normalize(window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2);
  }
})();

        if (typeof window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 !== "function") {
          window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 = __vsp_dd_stub_local;
        }
      }
    }catch(_){}
    // IMPORTANT: bind a LOCAL var used by this file (so later overwrites can't break us)
    var VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 =
      (typeof window !== "undefined" && typeof window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 === "function")
        ? window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2
        : __vsp_dd_stub_local;
  }catch(_){}

  // VSP_DD_CALLSAFE_P0_V2: ALWAYS call window drilldown as function, never crash
  function __VSP_DD_CALL__(/*...args*/){
    try{
      var fn = (typeof window !== "undefined" && typeof window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 === "function")
        ? window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2
        : function(){ return {open:function(){},show:function(){},close:function(){},destroy:function(){}}; };
      return fn.apply(null, arguments);
    }catch(_){
      return {open:function(){},show:function(){},close:function(){},destroy:function(){}};
    }
  }

  // VSP_DD_GUARD_LOCAL_V1: never crash if drilldown symbol isn't a function
  try{
    function __vsp_dd_stub(){
      try{ console.info("[VSP][DD] local stub invoked"); }catch(_){}
      return {open:function(){},show:function(){},close:function(){},destroy:function(){}};
    }
    if (typeof window !== "undefined") {
      if (typeof window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 !== "function") {
        window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 = __vsp_dd_stub;
      }
    }
  }catch(_){}
"use strict";

/**
 * VSP_DASHBOARD_COMM_ENHANCE_V1
 * - Bổ sung KPI cho TAB 2 (Runs & Reports): Total runs + Last run timestamp
 * - Đổ bảng Run index vào #vsp-runs-container
 * - Đổ bảng Data Source (severity + theo tool) vào #vsp-datasource-container
 */
(function () {
  function formatTs(ts) {
    if (!ts) return "–";
    return String(ts).replace("T", " ").split(".")[0];
  }

  /* ======================
   *  RUNS & REPORTS (TAB 2)
   * ====================== */
  function renderRuns(data) {
    var container = document.getElementById("vsp-runs-container");
    if (!container) return;

    var items;
    if (Array.isArray(data)) {
      items = data;
    } else if (data && Array.isArray(data.items)) {
      items = data.items;
    } else {
      items = [];
    }

    if (!items.length) {
      container.innerHTML =
        '<p style="font-size:12px;color:#9ca3c7;">Không tải được dữ liệu runs.</p>';
      return;
    }

    // KPI: total runs + last run timestamp
    var totalRuns = items.length;
    var latest = items[0] || {};
    var kpiCards = document.querySelectorAll("#tab-runs .kpi-value");
    if (kpiCards[0]) {
      kpiCards[0].textContent = String(totalRuns);
    }
    if (kpiCards[1]) {
      kpiCards[1].textContent = formatTs(latest.ts || latest.ts_last_run);
    }

    // Bảng Run index
    var html = '';
    html += '<div style="max-height: 320px; overflow:auto;">';
    html += '<table class="vsp-table">';
    html += '<thead><tr>';
    html += '<th>Run ID</th>';
    html += '<th>Total</th>';
    html += '<th>CRI</th>';
    html += '<th>HIGH</th>';
    html += '<th>MED</th>';
    html += '<th>LOW</th>';
    html += '</tr></thead><tbody>';

    items.forEach(function (r) {
      var sev = r.by_severity || r.severity || {};
      var total = r.total_findings || r.total || 0;
      html += '<tr>';
      html += '<td style="white-space:nowrap;">' + (r.run_id || "–") + '</td>';
      html += '<td>' + total + '</td>';
      html += '<td>' + (sev.CRITICAL || 0) + '</td>';
      html += '<td>' + (sev.HIGH || 0) + '</td>';
      html += '<td>' + (sev.MEDIUM || 0) + '</td>';
      html += '<td>' + (sev.LOW || 0) + '</td>';
      html += '</tr>';
    });

    html += '</tbody></table></div>';
    container.innerHTML = html;
  }

  function loadRuns() {
    fetch("/api/vsp/runs_index_v3_v3", { cache: "no-store" })
      .then(function (res) { return res.json(); })
      .then(function (data) { renderRuns(data); })
      .catch(function (err) {
        console.error("[VSP] load runs_index_v3 error:", err);
        var container = document.getElementById("vsp-runs-container");
        if (container) {
          container.innerHTML =
            '<p style="font-size:12px;color:#fca5a5;">Lỗi khi tải dữ liệu runs.</p>';
        }
      });
  }

  /* ======================
   *  DATA SOURCE (TAB 3)
   * ====================== */
  function get(obj, key) {
    return obj && obj[key] != null ? obj[key] : 0;
  }

  function renderDatasource(data) {
    var container = document.getElementById("vsp-datasource-container");
    if (!container) return;

    var summary = (data && data.summary) ? data.summary : data || {};
    var bySev = summary.by_severity || summary.severity || {};
    var byTool = summary.by_tool || {};

    var html = '';
    html += '<div class="vsp-card-soft">';
    html += '<div style="display:grid;grid-template-columns:minmax(0,0.7fr) minmax(0,1fr);gap:8px;">';

    // Bảng theo severity
    html += '<div>';
    html += '<div style="font-size:12px;font-weight:600;color:#e5e7eb;margin-bottom:4px;">Tổng quan theo mức độ</div>';
    html += '<table class="vsp-table" style="font-size:11px;">';
    html += '<thead><tr><th>Severity</th><th>Count</th></tr></thead><tbody>';
    ["CRITICAL","HIGH","MEDIUM","LOW","INFO","TRACE"].forEach(function (sev) {
      html += '<tr>';
      html += '<td>' + sev + '</td>';
      html += '<td>' + get(bySev, sev) + '</td>';
      html += '</tr>';
    });
    html += '</tbody></table>';
    html += '</div>';

    // Bảng theo tool
    html += '<div>';
    html += '<div style="font-size:12px;font-weight:600;color:#e5e7eb;margin-bottom:4px;">Theo tool</div>';

    var toolNames = Object.keys(byTool || {});
    if (!toolNames.length) {
      html += '<p style="font-size:11px;color:#9ca3c7;">Không có dữ liệu theo tool.</p>';
    } else {
      html += '<table class="vsp-table" style="font-size:11px;">';
      html += '<thead><tr>';
      html += '<th>Tool</th>';
      html += '<th>CRI</th>';
      html += '<th>HIGH</th>';
      html += '<th>MED</th>';
      html += '<th>LOW</th>';
      html += '<th>INFO</th>';
      html += '<th>TRACE</th>';
      html += '</tr></thead><tbody>';

      toolNames.forEach(function (tool) {
        var sev = byTool[tool] || {};
        html += '<tr>';
        html += '<td>' + tool + '</td>';
        html += '<td>' + get(sev,"CRITICAL") + '</td>';
        html += '<td>' + get(sev,"HIGH") + '</td>';
        html += '<td>' + get(sev,"MEDIUM") + '</td>';
        html += '<td>' + get(sev,"LOW") + '</td>';
        html += '<td>' + get(sev,"INFO") + '</td>';
        html += '<td>' + get(sev,"TRACE") + '</td>';
        html += '</tr>';
      });

      html += '</tbody></table>';
    }

    html += '</div>'; // col tool
    html += '</div>'; // grid
    html += '</div>'; // card-soft

    container.innerHTML = html;
  }

  function loadDatasource() {
    fetch("/api/vsp/datasource?mode=dashboard", { cache: "no-store" })
      .then(function (res) { return res.json(); })
      .then(function (data) { renderDatasource(data); })
      .catch(function (err) {
        console.error("[VSP] load datasource dashboard error:", err);
        var container = document.getElementById("vsp-datasource-container");
        if (container) {
          container.innerHTML =
            '<p style="font-size:12px;color:#fca5a5;">Lỗi khi tải unified datasource.</p>';
        }
      });
  }

  /* ======================
   *  INIT
   * ====================== */
  function init() {
    loadRuns();
    loadDatasource();
  }

  // Cho chắc chắn chạy sau khi DOM sẵn sàng
  document.addEventListener("DOMContentLoaded", init);
  window.VSP_DASHBOARD_COMM_ENHANCE_V1 = init;
})();


/* ==== END static/js/vsp_dashboard_comm_enhance_v1.js ==== */
;
;
/* ==== BEGIN static/js/vsp_dashboard_enhance_p0_clean_v1.js ==== */

// VSP_SAFE_DRILLDOWN_HARDEN_P0_V6
/* VSP_DASHBOARD_ENHANCE_P0_CLEAN_V1
 * P0 goal: NO red console errors, no drilldown symbol usage, safe degrade.
 */
(function(){
  'use strict';

  





/* VSP_FIX_DRILLDOWN_CALLSITE_P0_V5: safe-call drilldown artifacts (function OR object.open) */
function __VSP_DD_ART_CALL__(h, ...args) {
  try {
    if (typeof h === 'function') return h(...args);
    if (h && typeof h.open === 'function') return h.open(...args);
  } catch(e) { try{console.warn('[VSP][DD_SAFE]', e);}catch(_e){} }
  return null;
}

/* VSP_FIX_DRILLDOWN_CALLSITE_P0_V3: safe-call for drilldown artifacts (function OR object.open) */
function __VSP_DD_ART_CALL__(h, ...args) {
  try {
    if (typeof h === 'function') return h(...args);
    if (h && typeof h.open === 'function') return h.open(...args);
  } catch (e) {
    try { console.warn('[VSP][DD_SAFE] call failed', e); } catch (_e) {}
  }
  return null;
}

/* VSP_FIX_DRILLDOWN_ARTIFACTS_NOT_FUNCTION_P0_V2
 * Fix: TypeError __VSP_DD_ART_CALL__(VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2, ...) is not a function
 * Normalize BEFORE first use:
 *   - if function: keep
 *   - if object with .open(): wrap as function(arg)->obj.open(arg)
 *   - else: no-op (never throw)
 */
(function(){
  'use strict';
  if (window.__VSP_FIX_DRILLDOWN_ARTIFACTS_NOT_FUNCTION_P0_V2) return;
  window.__VSP_FIX_DRILLDOWN_ARTIFACTS_NOT_FUNCTION_P0_V2 = 1;

  function normalize(v){
    if (typeof v === 'function') return v;
    if (v && typeof v.open === 'function') {
      const obj = v;
      const fn = function(arg){ try { return obj.open(arg); } catch(e){ console.warn('[VSP][DD_FIX] open() failed', e); return null; } };
      fn.__wrapped_from_object = true;
      return fn;
    }
    const noop = function(_arg){ return null; };
    noop.__noop = true;
    return noop;
  }

  try {
    // trap future assignments
    let _val = window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2;
    Object.defineProperty(window, 'VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2', {
      configurable: true, enumerable: true,
      get: function(){ return _val; },
      set: function(v){ _val = normalize(v); }
    });
    window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 = _val;
  } catch(e) {
    window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 = normalize(window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2);
  }
})();

const TAG = '[VSP_DASH_P0_CLEAN]';

  function $(sel, root){ try{ return (root||document).querySelector(sel); }catch(_){ return null; } }
  function $all(sel, root){ try{ return Array.from((root||document).querySelectorAll(sel)); }catch(_){ return []; } }

  async function fetchJSON(url, opts){
    try{
      const r = await fetch(url, Object.assign({cache:'no-store'}, opts||{}));
      if(!r.ok) throw new Error('HTTP '+r.status);
      return await r.json();
    }catch(e){
      console.warn(TAG, 'fetch failed', url, e);
      return null;
    }
  }

  function setText(id, txt){
    const el = document.getElementById(id);
    if(!el) return;
    el.textContent = (txt==null?'':String(txt));
  }

  function safeInit(){
    // Do NOT reference VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 at all.
    // Only do harmless hydration.
    console.log(TAG, 'loaded');

    // 1) Try read dashboard data (best effort)
    fetchJSON('/api/vsp/dashboard_v3').then(d=>{
      if(!d){ return; }
      try{
        // If your template has any of these ids, fill them. If not, no-op.
        if (d.by_severity && typeof d.by_severity === 'object'){
          setText('kpi-total', d.by_severity.TOTAL ?? d.total ?? '');
          setText('kpi-critical', d.by_severity.CRITICAL ?? '');
          setText('kpi-high', d.by_severity.HIGH ?? '');
          setText('kpi-medium', d.by_severity.MEDIUM ?? '');
          setText('kpi-low', d.by_severity.LOW ?? '');
          setText('kpi-info', d.by_severity.INFO ?? '');
          setText('kpi-trace', d.by_severity.TRACE ?? '');
        }
      }catch(e){
        console.warn(TAG, 'render kpi failed', e);
      }
    });

    // 2) Gate: keep whatever other modules do; we just avoid crashing.
    // If you want, we can add canonical gate wiring later.

    // 3) Charts: do nothing here. Avoid bootstrap retry spam.
  }

  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', safeInit, {once:true});
  }else{
    safeInit();
  }
})();


/* ==== END static/js/vsp_dashboard_enhance_p0_clean_v1.js ==== */
;
;
/* ==== BEGIN static/js/vsp_dashboard_extras_v2.js ==== */

// ======================= VSP_DASHBOARD_EXTRAS_V2 =======================
// Dò table theo header thay vì ID:
//  - Top risk findings  : headers ~ [Severity, Tool, Location, Rule]
//  - Top noisy paths    : headers ~ [Path, Total, Noise level]

(function () {
  console.log("[EXTRAS] script loaded (header-scan mode)");

  function norm(str) {
    return (str || "").trim().toLowerCase();
  }

  function getHeaders(table) {
    const ths = table.querySelectorAll("thead tr th");
    if (!ths.length) return [];
    return Array.prototype.map.call(ths, (th) => norm(th.textContent));
  }

  function findTableByHeaders(expected) {
    const tables = document.querySelectorAll("table");
    for (const tbl of tables) {
      const heads = getHeaders(tbl);
      if (heads.length < expected.length) continue;
      let ok = true;
      for (let i = 0; i < expected.length; i++) {
        if (!heads[i] || heads[i].indexOf(expected[i]) === -1) {
          ok = false;
          break;
        }
      }
      if (ok) return tbl;
    }
    return null;
  }

  function renderTopRisk(list) {
    const tbl = findTableByHeaders(["severity", "tool", "location", "rule"]);
    if (!tbl) {
      console.warn("[EXTRAS] Không tìm thấy table top risk theo header");
      return;
    }
    const tbody = tbl.querySelector("tbody") || tbl;
    tbody.innerHTML = "";

    if (!list || list.length === 0) {
      const tr = document.createElement("tr");
      const td = document.createElement("td");
      td.colSpan = 4;
      td.textContent = "No critical/high findings in this run.";
      td.classList.add("vsp-empty-cell");
      tr.appendChild(td);
      tbody.appendChild(tr);
      return;
    }

    list.forEach((item) => {
      const tr = document.createElement("tr");

      const tdSev = document.createElement("td");
      tdSev.textContent = item.severity || "-";
      tdSev.classList.add("vsp-sev", "vsp-sev-" + (item.severity || "").toLowerCase());

      const tdTool = document.createElement("td");
      tdTool.textContent = item.tool || "-";

      const tdLoc = document.createElement("td");
      tdLoc.textContent = item.location || "-";

      const tdRule = document.createElement("td");
      tdRule.textContent = item.rule_id || item.cwe || "-";

      tr.appendChild(tdSev);
      tr.appendChild(tdTool);
      tr.appendChild(tdLoc);
      tr.appendChild(tdRule);

      tbody.appendChild(tr);
    });
  }

  function renderTopNoisy(list) {
    const tbl = findTableByHeaders(["path", "total", "noise"]);
    if (!tbl) {
      console.warn("[EXTRAS] Không tìm thấy table top noisy theo header");
      return;
    }
    const tbody = tbl.querySelector("tbody") || tbl;
    tbody.innerHTML = "";

    if (!list || list.length === 0) {
      const tr = document.createElement("tr");
      const td = document.createElement("td");
      td.colSpan = 3;
      td.textContent = "No medium/low/info/trace clusters in this run.";
      td.classList.add("vsp-empty-cell");
      tr.appendChild(td);
      tbody.appendChild(tr);
      return;
    }

    list.forEach((item) => {
      const tr = document.createElement("tr");

      const tdPath = document.createElement("td");
      tdPath.textContent = item.path || "-";

      const tdTotal = document.createElement("td");
      tdTotal.textContent = item.total != null ? String(item.total) : "-";

      const tdNoise = document.createElement("td");
      tdNoise.textContent = item.noise_level || "-";
      tdNoise.classList.add("vsp-noise-" + (item.noise_level || "").toLowerCase());

      tr.appendChild(tdPath);
      tr.appendChild(tdTotal);
      tr.appendChild(tdNoise);

      tbody.appendChild(tr);
    });
  }

  async function init() {
    try {
      const res = await fetch("/static/data/vsp_dashboard_extras_latest.json", {
        cache: "no-store",
      });
      console.log("[EXTRAS] fetch status", res.status);
      if (!res.ok) {
        console.warn("[EXTRAS] Không load được extras JSON:", res.status);
        return;
      }
      const data = await res.json();
      console.log("[EXTRAS] Loaded extras for run", data.run_id);

      renderTopRisk(data.top_risk_findings || []);
      renderTopNoisy(data.top_noisy_paths || []);
    } catch (err) {
      console.error("[EXTRAS][ERR] Khi load extras:", err);
    }
  }

  document.addEventListener("DOMContentLoaded", init);
})();


/* ==== END static/js/vsp_dashboard_extras_v2.js ==== */
;
;
/* ==== BEGIN static/js/vsp_dashboard_findings_v1.js ==== */

;(function () {
  const LOG_PREFIX = "[VSP_DASH_FINDINGS]";
  console.log(LOG_PREFIX, "Stub loaded – Dashboard findings zone is disabled in this build.");
  // Bản thương mại V1: không inject extra findings zone để giữ layout gọn.
  // Khi nào muốn bật lại, sẽ viết lại file này theo spec mới.
})();


/* ==== END static/js/vsp_dashboard_findings_v1.js ==== */
;
;
/* ==== BEGIN static/js/vsp_dashboard_kpi_adv_v1.js ==== */

(function () {
  'use strict';

  const API_URL = '/api/vsp/dashboard_v3_v2';

  function findKpiCardByTitle(titleText) {
    var all = document.querySelectorAll('*');
    var titleEl = null;

    for (var i = 0; i < all.length; i++) {
      var txt = (all[i].textContent || '').trim();
      if (txt === titleText) {
        titleEl = all[i];
        break;
      }
    }
    if (!titleEl) return null;

    var card = titleEl;
    for (var depth = 0; depth < 5 && card; depth++) {
      if (card.classList && card.classList.contains('vsp-kpi-card')) {
        return card;
      }
      card = card.parentElement;
    }
    return titleEl.parentElement || titleEl;
  }

  function setKpiValue(title, main, sub) {
    var card = findKpiCardByTitle(title);
    if (!card) return;

    var mainEl = card.querySelector('.vsp-kpi-value');
    if (!mainEl) {
      mainEl = document.createElement('div');
      mainEl.className = 'vsp-kpi-value';
      card.appendChild(mainEl);
    }
    mainEl.textContent = main;

    if (sub !== undefined) {
      var subEl = card.querySelector('.vsp-kpi-sub');
      if (!subEl) {
        subEl = document.createElement('div');
        subEl.className = 'vsp-kpi-sub';
        card.appendChild(subEl);
      }
      subEl.textContent = sub;
    }
  }

  function renderKpi(data) {
    if (!data) return;

    var total = Number(data.total_findings || 0);

    var summary = data.summary || {};
    var sev = summary.by_severity || data.severity || {};

    var crit  = Number(sev.CRITICAL || 0);
    var high  = Number(sev.HIGH     || 0);
    var med   = Number(sev.MEDIUM   || 0);
    var low   = Number(sev.LOW      || 0);
    var info  = Number(sev.INFO     || 0);
    var trace = Number(sev.TRACE    || 0);
    var infoTrace = info + trace;

    // 6 KPI severity
    setKpiValue('Total Findings', total.toLocaleString(), '');
    setKpiValue('Critical',       crit.toLocaleString(), '');
    setKpiValue('High',           high.toLocaleString(), '');
    setKpiValue('Medium',         med.toLocaleString(), '');
    setKpiValue('Low',            low.toLocaleString(), '');
    setKpiValue('Info / Trace',   infoTrace.toLocaleString(), '');

    // 4 KPI nâng cao – hiện BE chưa có, để "-" cho đẹp
    var score   = summary.security_score;
    var topTool = summary.top_risky_tool || '-';
    var topCwe  = summary.top_cwe        || '-';
    var topMod  = summary.top_module     || '-';

    if (typeof score === 'number') {
      setKpiValue('Security Score', String(score), '/100');
    } else {
      setKpiValue('Security Score', '-', '/100');
    }

    setKpiValue('Top Risky Tool', topTool, '');
    setKpiValue('Top CWE',        topCwe,  '');
    setKpiValue('Top Module',     topMod,  '');
  }

  function loadKpi() {
    fetch(API_URL)
      .then(function (r) { return r.json(); })
      .then(function (data) {
        if (!data || data.ok === false) {
          console.warn('[VSP][KPI] /api/vsp/dashboard_v3_v2 not ok:', data);
          return;
        }
        renderKpi(data);
      })
      .catch(function (err) {
        console.error('[VSP][KPI] fetch error:', err);
      });
  }

  document.addEventListener('DOMContentLoaded', loadKpi);
})();


/* ==== END static/js/vsp_dashboard_kpi_adv_v1.js ==== */
;
;
/* ==== BEGIN static/js/vsp_dashboard_kpi_adv_v2.js ==== */

/* ---------------------------------------------------------
 * VSP CIO VIEW – Advanced KPI (Top risks + Noisy paths)
 * Không sửa layout, chỉ inject data vào 2 bảng:
 *  - "Top risk findings"
 *  - "Top noisy paths"
 * Tự tìm bảng bằng heading text, không cần thêm id.
 * --------------------------------------------------------- */

(function () {
  "use strict";

  function dbg() {
    if (window.console && console.log) {
      console.log.apply(console, arguments);
    }
  }

  function findTbodyByHeading(keyword) {
    keyword = (keyword || "").toLowerCase();
    if (!keyword) return null;

    var headings = document.querySelectorAll("h2, h3, h4, h5");
    for (var i = 0; i < headings.length; i++) {
      var h = headings[i];
      var txt = (h.textContent || "").toLowerCase();
      if (txt.indexOf(keyword) !== -1) {
        // tìm container gần nhất có table
        var container = h.closest("section, article, div") || h.parentElement;
        if (!container) continue;
        var tbody = container.querySelector("tbody");
        if (tbody) {
          return tbody;
        }
      }
    }
    return null;
  }

  /* ------------------------------
     TOP RISK FINDINGS
     (CRITICAL + HIGH)
  ------------------------------ */
  function loadTopRiskFindings() {
    var severities = ["CRITICAL", "HIGH"];
    var promises = [];

    for (var i = 0; i < severities.length; i++) {
      (function (sev) {
        var url = "/api/vsp/datasource_v2?severity=" +
                  encodeURIComponent(sev) + "&limit=50";
        dbg("[VSP][ADV] top risks GET", url);
        var p = fetch(url)
          .then(function (r) { return r.json(); })
          .catch(function (e) {
            console.error("[VSP][ADV] top risks fetch ERR (" + sev + "):", e);
            return null;
          });
        promises.push(p);
      })(severities[i]);
    }

    Promise.all(promises).then(function (results) {
      var tbody = findTbodyByHeading("top risk findings");
      if (!tbody) {
        dbg("[VSP][ADV] Không tìm thấy bảng 'Top risk findings' trong DOM.");
        return;
      }

      var allItems = [];
      for (var i = 0; i < results.length; i++) {
        var res = results[i];
        if (!res || res.ok === false || !Array.isArray(res.items)) continue;
        allItems = allItems.concat(res.items);
      }

      if (!allItems.length) {
        tbody.innerHTML =
          '<tr><td colspan="4">No CRITICAL/HIGH findings.</td></tr>';
        return;
      }

      // sort: CRITICAL trước HIGH
      var weight = { CRITICAL: 2, HIGH: 1 };
      allItems.sort(function (a, b) {
        var sa = a.severity_effective || a.severity || "HIGH";
        var sb = b.severity_effective || b.severity || "HIGH";
        var wa = weight[sa] || 0;
        var wb = weight[sb] || 0;
        if (wa !== wb) return wb - wa;
        return 0;
      });

      // Lấy TOP 10
      allItems = allItems.slice(0, 10);

      tbody.innerHTML = "";
      for (var j = 0; j < allItems.length; j++) {
        var it = allItems[j];
        var sev  = it.severity_effective || it.severity || "N/A";
        var tool = it.tool || "";
        var loc  = it.file || it.path || "";
        var rule = it.rule_id || it.cwe || "";

        var tr = document.createElement("tr");
        tr.innerHTML =
          "<td>" + sev  + "</td>" +
          "<td>" + tool + "</td>" +
          "<td>" + loc  + "</td>" +
          "<td>" + rule + "</td>";
        tbody.appendChild(tr);
      }
    });
  }

  /* ------------------------------
     TOP NOISY PATHS
     (MEDIUM / LOW / INFO / TRACE)
  ------------------------------ */
  function loadTopNoisyPaths() {
    var severities = ["MEDIUM", "LOW", "INFO", "TRACE"];
    var promises = [];

    for (var i = 0; i < severities.length; i++) {
      (function (sev) {
        var url = "/api/vsp/datasource_v2?severity=" +
                  encodeURIComponent(sev) + "&limit=200";
        dbg("[VSP][ADV] noisy paths GET", url);
        var p = fetch(url)
          .then(function (r) { return r.json(); })
          .catch(function (e) {
            console.error("[VSP][ADV] noisy paths fetch ERR (" + sev + "):", e);
            return null;
          });
        promises.push(p);
      })(severities[i]);
    }

    Promise.all(promises).then(function (results) {
      var tbody = findTbodyByHeading("top noisy paths");
      if (!tbody) {
        dbg("[VSP][ADV] Không tìm thấy bảng 'Top noisy paths' trong DOM.");
        return;
      }

      var counts = {}; // path/file -> total

      for (var i = 0; i < results.length; i++) {
        var res = results[i];
        if (!res || res.ok === false || !Array.isArray(res.items)) continue;

        for (var j = 0; j < res.items.length; j++) {
          var it = res.items[j];
          var key = it.file || it.path || "";
          if (!key) continue;
          if (!counts[key]) counts[key] = 0;
          counts[key] += 1;
        }
      }

      var paths = [];
      for (var k in counts) {
        if (!counts.hasOwnProperty(k)) continue;
        paths.push({ path: k, total: counts[k] });
      }

      if (!paths.length) {
        tbody.innerHTML =
          '<tr><td colspan="3">No noisy paths (MEDIUM/LOW/INFO/TRACE).</td></tr>';
        return;
      }

      // sort desc theo total
      paths.sort(function (a, b) {
        return b.total - a.total;
      });

      // helper noise level
      function noiseLevel(total) {
        if (total >= 20) return "HIGH";
        if (total >= 10) return "MEDIUM";
        if (total >= 3)  return "LOW";
        return "MINOR";
      }

      // Lấy TOP 10
      paths = paths.slice(0, 10);

      tbody.innerHTML = "";
      for (var p = 0; p < paths.length; p++) {
        var e = paths[p];
        var tr = document.createElement("tr");
        tr.innerHTML =
          "<td>" + e.path + "</td>" +
          "<td>" + e.total + "</td>" +
          "<td>" + noiseLevel(e.total) + "</td>";
        tbody.appendChild(tr);
      }
    });
  }

  /* ------------------------------
     INIT – KHÔNG ĐỤNG JS CŨ
  ------------------------------ */
  function initAdvKpi() {
    dbg("[VSP][ADV] init advanced KPI (top risks + noisy paths)");
    loadTopRiskFindings();
    loadTopNoisyPaths();
  }

  document.addEventListener("DOMContentLoaded", initAdvKpi);
})();


/* ==== END static/js/vsp_dashboard_kpi_adv_v2.js ==== */
;
;
/* ==== BEGIN static/js/vsp_dashboard_kpi_force_any_v1.js ==== */

(function () {
  if (window.VSP_DASH_FORCE_INIT) {
    console.log('[VSP_DASH_FORCE] already initialized, skip');
    return;
  }
  window.VSP_DASH_FORCE_INIT = true;

  console.log('[VSP_DASH_FORCE] vsp_dashboard_kpi_force_any_v1.js loaded');

  function fmtInt(n) {
    if (n == null || isNaN(n)) return '--';
    return Number(n).toLocaleString('en-US');
  }

  function setText(id, value, isNumber) {
    var el = document.getElementById(id);
    if (!el) return;
    if (value == null || value === '') {
      el.textContent = '--';
      return;
    }
    el.textContent = isNumber ? fmtInt(value) : String(value);
  }

  async function loadKpiOnce() {
    try {
      const res = await fetch('/api/vsp/dashboard_v3');
      if (!res.ok) {
        console.warn('[VSP_DASH_FORCE] dashboard_v3 HTTP != 200', res.status);
        return;
      }
      const data = await res.json();
      const sev = data.by_severity || data.severity_cards || {};

      let topTool   = data.top_risky_tool;
      let topCwe    = data.top_impacted_cwe;
      let topModule = data.top_vulnerable_module;

      if (topCwe && typeof topCwe === 'object') {
        topCwe =
          topCwe.cwe_id ||
          topCwe.cwe ||
          topCwe.id ||
          topCwe.name ||
          JSON.stringify(topCwe);
      }
      if (topModule && typeof topModule === 'object') {
        topModule =
          topModule.path ||
          topModule.module ||
          topModule.id ||
          topModule.name ||
          JSON.stringify(topModule);
      }

      // 5 KPI chính
      setText('vsp-kpi-total-findings', data.total_findings, true);
      setText('vsp-kpi-score',          data.security_posture_score, true);
      setText('vsp-kpi-top-tool',       topTool, false);
      setText('vsp-kpi-top-cwe',        topCwe, false);
      setText('vsp-kpi-top-module',     topModule, false);

      // 6 severity
      setText('vsp-kpi-sev-critical', sev.CRITICAL || 0, true);
      setText('vsp-kpi-sev-high',     sev.HIGH     || 0, true);
      setText('vsp-kpi-sev-medium',   sev.MEDIUM   || 0, true);
      setText('vsp-kpi-sev-low',      sev.LOW      || 0, true);
      setText('vsp-kpi-sev-info',     sev.INFO     || 0, true);
      setText('vsp-kpi-sev-trace',    sev.TRACE    || 0, true);

      console.log('[VSP_DASH_FORCE] KPI applied', {
        total: data.total_findings,
        score: data.security_posture_score,
        topTool, topCwe, topModule,
        by_severity: sev
      });
    } catch (e) {
      console.error('[VSP_DASH_FORCE] Error loading KPI', e);
    }
  }

  function init() {
    var tries = 0;
    var t = setInterval(function () {
      var pane = document.getElementById('vsp-dashboard-main');
      if (pane) {
        clearInterval(t);
        loadKpiOnce();
      } else if (tries++ > 20) {
        clearInterval(t);
        console.warn('[VSP_DASH_FORCE] Hết retries, không thấy #vsp-dashboard-main');
      }
    }, 500);
  }

  if (document.readyState === 'complete' || document.readyState === 'interactive') {
    init();
  } else {
    document.addEventListener('DOMContentLoaded', init);
  }
})();


/* ==== END static/js/vsp_dashboard_kpi_force_any_v1.js ==== */
;
;
/* ==== BEGIN static/js/vsp_dashboard_kpi_force_any_v2.js ==== */

(function () {
  console.log('[VSP_DASH_FORCE] vsp_dashboard_kpi_force_any_v2.js loaded');

  function fmtInt(n) {
    if (n == null || isNaN(n)) return '--';
    return Number(n).toLocaleString('en-US');
  }

  function setText(id, value, isNumber) {
    var el = document.getElementById(id);
    if (!el) return;
    if (value == null || value === '') {
      el.textContent = '--';
      return;
    }
    el.textContent = isNumber ? fmtInt(value) : String(value);
  }

  async function loadKpiOnce() {
    try {
      const res = await fetch('/api/vsp/dashboard_v3');
      if (!res.ok) {
        console.warn('[VSP_DASH_FORCE] dashboard_v3 HTTP != 200', res.status);
        return;
      }
      const data = await res.json();
      const sev = data.by_severity || {};

      let topTool   = data.top_risky_tool;
      let topCwe    = data.top_impacted_cwe;
      let topModule = data.top_vulnerable_module;

      if (topCwe && typeof topCwe === 'object') {
        topCwe = topCwe.cwe_id || topCwe.cwe || topCwe.id || topCwe.name || JSON.stringify(topCwe);
      }
      if (topModule && typeof topModule === 'object') {
        topModule = topModule.path || topModule.module || topModule.id || topModule.name || JSON.stringify(topModule);
      }

      // 5 KPI chính
      setText('vsp-kpi-total-findings', data.total_findings, true);
      setText('vsp-kpi-score',          data.security_posture_score, true);
      setText('vsp-kpi-top-tool',       topTool, false);
      setText('vsp-kpi-top-cwe',        topCwe, false);
      setText('vsp-kpi-top-module',     topModule, false);

      // 6 severity
      setText('vsp-kpi-sev-critical', sev.CRITICAL || 0, true);
      setText('vsp-kpi-sev-high',     sev.HIGH     || 0, true);
      setText('vsp-kpi-sev-medium',   sev.MEDIUM   || 0, true);
      setText('vsp-kpi-sev-low',      sev.LOW      || 0, true);
      setText('vsp-kpi-sev-info',     sev.INFO     || 0, true);
      setText('vsp-kpi-sev-trace',    sev.TRACE    || 0, true);

      console.log('[VSP_DASH_FORCE] KPI applied', {
        total: data.total_findings,
        score: data.security_posture_score,
        topTool, topCwe, topModule,
        by_severity: sev
      });
    } catch (e) {
      console.error('[VSP_DASH_FORCE] Error loading KPI', e);
    }
  }

  function init() {
    // chỉ chạy khi pane dashboard đã inject
    var tries = 0;
    var t = setInterval(function () {
      var pane = document.getElementById('vsp-dashboard-main');
      if (pane) {
        clearInterval(t);
        loadKpiOnce();
      } else if (tries++ > 20) {
        clearInterval(t);
        console.warn('[VSP_DASH_FORCE] Hết retries, không thấy #vsp-dashboard-main');
      }
    }, 500);
  }

  if (document.readyState === 'complete' || document.readyState === 'interactive') {
    init();
  } else {
    document.addEventListener('DOMContentLoaded', init);
  }
})();


/* ==== END static/js/vsp_dashboard_kpi_force_any_v2.js ==== */
;
;
/* ==== BEGIN static/js/vsp_dashboard_kpi_force_any_v3.js ==== */

(function () {
  if (window.VSP_DASH_FORCE_V3_INIT) {
    console.log('[VSP_DASH_FORCE] already initialized, skip');
    return;
  }
  window.VSP_DASH_FORCE_V3_INIT = true;

  console.log('[VSP_DASH_FORCE] vsp_dashboard_kpi_force_any_v3.js loaded');

  function fmtInt(n) {
    if (n == null || isNaN(n)) return '--';
    return Number(n).toLocaleString('en-US');
  }

  function setText(id, value, isNumber) {
    var el = document.getElementById(id);
    if (!el) return;
    if (value == null || value === '') {
      el.textContent = '--';
      return;
    }
    el.textContent = isNumber ? fmtInt(value) : String(value);
  }

  async function loadKpiOnce() {
    try {
      const res = await fetch('/api/vsp/dashboard_v3');
      if (!res.ok) {
        console.warn('[VSP_DASH_FORCE] dashboard_v3 HTTP != 200', res.status);
        return;
      }
      const data = await res.json();
      const sev = data.by_severity || data.severity_cards || {};

      let topTool   = data.top_risky_tool;
      let topCwe    = data.top_impacted_cwe;
      let topModule = data.top_vulnerable_module;

      if (topCwe && typeof topCwe === 'object') {
        topCwe =
          topCwe.cwe_id ||
          topCwe.cwe ||
          topCwe.id ||
          topCwe.name ||
          JSON.stringify(topCwe);
      }
      if (topModule && typeof topModule === 'object') {
        topModule =
          topModule.path ||
          topModule.module ||
          topModule.id ||
          topModule.name ||
          JSON.stringify(topModule);
      }

      // 5 KPI chính – ĐÚNG ID HTML ANH ĐANG CÓ
      setText('vsp-kpi-total',          data.total_findings, true);
      setText('vsp-kpi-security-score', data.security_posture_score, true);
      setText('vsp-kpi-top-tool',       topTool, false);
      setText('vsp-kpi-top-cwe',        topCwe, false);
      setText('vsp-kpi-top-module',     topModule, false);

      // 6 severity – ĐÚNG ID HTML
      setText('vsp-kpi-critical', sev.CRITICAL || 0, true);
      setText('vsp-kpi-high',     sev.HIGH     || 0, true);
      setText('vsp-kpi-medium',   sev.MEDIUM   || 0, true);
      setText('vsp-kpi-low',      sev.LOW      || 0, true);
      setText('vsp-kpi-info',     sev.INFO     || 0, true);
      setText('vsp-kpi-trace',    sev.TRACE    || 0, true);

      console.log('[VSP_DASH_FORCE] KPI applied', {
        total: data.total_findings,
        score: data.security_posture_score,
        topTool,
        topCwe,
        topModule,
        by_severity: sev
      });
    } catch (e) {
      console.error('[VSP_DASH_FORCE] Error loading KPI', e);
    }
  }

  function init() {
    var tries = 0;
    var t = setInterval(function () {
      var pane = document.getElementById('vsp-dashboard-main');
      if (pane) {
        clearInterval(t);
        loadKpiOnce();
      } else if (tries++ > 20) {
        clearInterval(t);
        console.warn('[VSP_DASH_FORCE] Hết retries, không thấy #vsp-dashboard-main');
      }
    }, 500);
  }

  if (document.readyState === 'complete' || document.readyState === 'interactive') {
    init();
  } else {
    document.addEventListener('DOMContentLoaded', init);
  }
})();


/* ==== END static/js/vsp_dashboard_kpi_force_any_v3.js ==== */
;
;
/* ==== BEGIN static/js/vsp_dashboard_kpi_v1.js ==== */


function vspNormalizeTopModule(m) {
  if (!m) return 'N/A';
  if (typeof m === 'string') return m;
  try {
    if (m.label) return String(m.label);
    if (m.path) return String(m.path);
    if (m.id)   return String(m.id);
    return String(m);
  } catch (e) {
    return 'N/A';
  }
}

'use strict';

(function () {
  const LOG = '[VSP_DASHBOARD_KPI]';

  function setText(id, value) {
    const el = document.getElementById(id);
    if (!el) return;
    el.textContent = value;
  }

  function renderKpi(model) {
    if (!model) return;
    const sev =
      model.severity_cards ||
      model.summary_by_severity ||
      model.summary_all ||
      {};

    const total =
      model.total_findings ??
      model.total ??
      sev.TOTAL ??
      0;

    setText('vsp-kpi-total', total);
    setText('vsp-kpi-critical', sev.CRITICAL ?? 0);
    setText('vsp-kpi-high', sev.HIGH ?? 0);
    setText('vsp-kpi-medium', sev.MEDIUM ?? 0);
    setText('vsp-kpi-low', sev.LOW ?? 0);
    setText('vsp-kpi-info', (sev.INFO ?? 0) + (sev.TRACE ?? 0));

    if (model.security_posture_score != null) {
      setText('vsp-kpi-score-main', model.security_posture_score + '/100');
    }

    if (model.top_risky_tool) {
      setText('vsp-kpi-top-tool', model.top_risky_tool);
    }
    if (model.top_impacted_cwe) {
      setText('vsp-kpi-top-cwe', model.top_impacted_cwe);
    }
    if (model.top_vulnerable_module) {
      setText('vsp-kpi-top-module', model.top_vulnerable_module);
    }

    if (model.latest_run_id) {
      setText('vsp-last-run-span', model.latest_run_id);
    }

    // Cho Charts JS dùng chung model này
    window.VSP_DASHBOARD_MODEL = model;
    if (typeof window.vspRenderChartsFromDashboard === 'function') {
      try {
        window.vspRenderChartsFromDashboard(model);
      } catch (e) {
        console.error(LOG, 'Chart render error', e);
      }
    }
  }

  async function loadDashboard() {
    const url = '/api/vsp/dashboard_v3';
    console.log(LOG, 'Loading', url);

    try {
      const res = await fetch(url, { credentials: 'same-origin' });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const data = await res.json();
      console.log(LOG, 'Dashboard model:', data);
      renderKpi(data);
    } catch (err) {
      console.error(LOG, 'Load dashboard error:', err);
      const errBox = document.getElementById('vsp-dashboard-error');
      if (errBox) {
        errBox.textContent = 'Không tải được dashboard: ' + (err.message || err);
        errBox.style.display = 'block';
      }
    }
  }

  document.addEventListener('DOMContentLoaded', loadDashboard);
})();


/* ==== END static/js/vsp_dashboard_kpi_v1.js ==== */
;
;
/* ==== BEGIN static/js/vsp_dashboard_live_v2.V1_baseline.js ==== */

"use strict";

/**
 * VSP_DASHBOARD_LIVE_V2 – ALL-IN-ONE (datasource + fallback v1/v3)
 */

(function () {
  const API_SUMMARY      = "/api/vsp/datasource?mode=dashboard";
  const API_DS_SEV       = (sev, limit) =>
    "/api/vsp/datasource?severity=" + encodeURIComponent(sev) + "&limit=" + (limit || 1);
  const API_RUNS_V3      = "/api/vsp/runs_index_v3_v3";
  const API_RUNS_V1      = "/api/vsp/runs";
  const API_TREND_V1     = "/api/vsp/trend_v1";
  const API_SETTINGS     = "/api/vsp/settings/get";
  const API_OVERRIDES    = "/api/vsp/overrides/list";
  const API_DASHBOARD_V3 = "/api/vsp/dashboard_v3";

  const SEVERITIES = ["CRITICAL", "HIGH", "MEDIUM", "LOW", "INFO", "TRACE"];

  function $(id) {
    return document.getElementById(id);
  }

  async function fetchJson(url) {
    const res = await fetch(url, { cache: "no-store" });
    if (!res.ok) {
      const err = new Error("HTTP " + res.status + " for " + url);
      err.status = res.status;
      throw err;
    }
    return await res.json();
  }

  function safeInt(v) {
    if (v == null) return 0;
    const n = Number(v);
    return Number.isFinite(n) ? n : 0;
  }

  function escHtml(str) {
    return String(str)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;");
  }

  function setNoData(container, msg) {
    if (!container) return;
    container.innerHTML =
      '<p style="font-size:12px;color:#9ca3c7;">' + msg + "</p>";
  }

  /* ========== KPI + DONUT ========== */

  let donutChart = null;

  function renderKpisAndDonut(dash, bySev) {
    const sev = bySev || {};
    const fmt = (n) => n.toLocaleString("en-US");

    const crit  = safeInt(sev.CRITICAL);
    const high  = safeInt(sev.HIGH);
    const med   = safeInt(sev.MEDIUM);
    const low   = safeInt(sev.LOW);
    const info  = safeInt(sev.INFO);
    const trace = safeInt(sev.TRACE);

    const totalFromSev = crit + high + med + low + info + trace;
    const total =
      safeInt(dash.total_findings) ||
      safeInt(dash.total) ||
      totalFromSev;

    const elTotal = $("kpi-total-findings");
    if (elTotal) elTotal.textContent = fmt(total);

    const elCrit = $("kpi-critical");
    if (elCrit) elCrit.textContent = fmt(crit);

    const elHigh = $("kpi-high");
    if (elHigh) elHigh.textContent = fmt(high);

    const elMed = $("kpi-medium");
    if (elMed) elMed.textContent = fmt(med);

    const elLow = $("kpi-low");
    if (elLow) elLow.textContent = fmt(low);

    const elInfoTrace = $("kpi-info-trace");
    if (elInfoTrace) elInfoTrace.textContent = fmt(info + trace);

    const lastRunId = $("vsp-last-run-id");
    if (lastRunId) lastRunId.textContent = dash.run_id || "–";

    const lastRunTs = $("vsp-last-run-ts");
    if (lastRunTs) {
      const ts = dash.ts || dash.last_run_ts || dash.last_ts;
      lastRunTs.textContent = ts ? ts : "Last run: –";
    }

    // Donut
    const canvas = $("severity_donut_chart");
    if (canvas && typeof Chart !== "undefined") {
      if (donutChart) donutChart.destroy();
      donutChart = new Chart(canvas, {
        type: "doughnut",
        data: {
          labels: ["CRITICAL", "HIGH", "MEDIUM", "LOW", "INFO", "TRACE"],
          datasets: [
            {
              data: [crit, high, med, low, info, trace],
              backgroundColor: [
                "#ff4b6a",
                "#ff9f43",
                "#ffd166",
                "#4ade80",
                "#38bdf8",
                "#a855f7",
              ],
              borderWidth: 0,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: "70%",
          plugins: { legend: { display: false } },
        },
      });
    }

    // fallback trend 1 điểm, sẽ bị override nếu initTrend() load được nhiều điểm
    renderTrend([{ label: dash.run_id || "Last run", total }]);
  }

  async function computeSeverityBucketsFromDatasource() {
    const buckets = {
      CRITICAL: 0,
      HIGH: 0,
      MEDIUM: 0,
      LOW: 0,
      INFO: 0,
      TRACE: 0,
    };

    const promises = SEVERITIES.map(async (sev) => {
      try {
        const resp = await fetchJson(API_DS_SEV(sev, 1));
        const total = safeInt(resp.total || resp.total_findings || resp.count);
        buckets[sev] = total;
      } catch (err) {
        console.warn("[VSP] severity", sev, "error:", err);
      }
    });

    await Promise.all(promises);
    return buckets;
  }

  /* ========== TREND ========== */

  let trendChart = null;

  function renderTrend(points) {
    const canvas = $("trend_line_chart");
    if (!canvas || typeof Chart === "undefined") return;
    if (!Array.isArray(points) || !points.length) return;

    const labels = points.map((p) => p.label || "");
    const totals = points.map((p) => safeInt(p.total || p.total_findings));

    // Destroy mọi chart đang gắn với canvas này (kể cả không lưu trong trendChart)
    if (typeof Chart.getChart === "function") {
      try {
        const existing = Chart.getChart(canvas);
        if (existing) existing.destroy();
      } catch (e) {
        console.warn("[VSP][TREND] Chart.getChart destroy error:", e);
      }
    }

    if (trendChart) {
      try {
        trendChart.destroy();
      } catch (e) {
        console.warn("[VSP][TREND] trendChart.destroy error:", e);
      }
      trendChart = null;
    }

    trendChart = new Chart(canvas, {
      type: "line",
      data: {
        labels,
        datasets: [
          {
            label: "Total findings",
            data: totals,
            tension: 0.35,
            borderWidth: 2,
            pointRadius: 3,
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          x: {
            ticks: { maxRotation: 45, minRotation: 45 },
            grid: { display: false },
          },
          y: {
            beginAtZero: true,
            grid: { color: "rgba(148,163,210,0.25)" },
          },
        },
      },
    });
  }

  async function initTrend() {
    // 1) trend_v1 nếu có
    try {
      const t = await fetchJson(API_TREND_V1);
      const pts = Array.isArray(t.points) ? t.points : [];
      if (pts.length) {
        renderTrend(pts);
        return;
      }
    } catch (e) {
      console.warn("[VSP] trend_v1 error:", e);
    }

    // 2) runs_index_v3 nếu có
    try {
      const runs = await fetchJson(API_RUNS_V3);
      if (Array.isArray(runs) && runs.length) {
        const pts = runs
          .slice(0, 10)
          .map((r) => ({
            label: r.run_id || "",
            total: r.total_findings || r.total || 0,
          }))
          .reverse();
        renderTrend(pts);
        return;
      }
    } catch (e) {
      console.warn("[VSP] runs_index_v3 error (trend):", e);
    }
    // fallback = 1 điểm đã vẽ sẵn bởi renderKpisAndDonut
  }

      /* ========== TOP CWE BAR ========== */

  let topCweChart = null;

  function ensureTopCweCanvas() {
    let canvas = $("top_cwe_chart");
    if (canvas) return canvas;

    const table = document.querySelector("#top-cwe-table");
    if (table) {
      table.style.display = "none";
      const parent = table.parentElement || table.parentNode || table;
      canvas = document.createElement("canvas");
      canvas.id = "top_cwe_chart";
      canvas.style.width = "100%";
      canvas.style.height = "210px";
      parent.appendChild(canvas);
      return canvas;
    }
    return null;
  }

  function renderTopCweBarFromInsights(items) {
    const canvas = ensureTopCweCanvas();
    if (!canvas || typeof Chart === "undefined") return;

    const arr = Array.isArray(items) ? items : [];
    if (!arr.length) {
      console.debug("[VSP] renderTopCweBarFromInsights: empty items");
      return;
    }

    const labels = arr.map((it) => it.cwe || "UNKNOWN");
    const totals = arr.map((it) => safeInt(it.count || 0));

    if (topCweChart) {
      topCweChart.destroy();
    }

    topCweChart = new Chart(canvas, {
      type: "bar",
      data: {
        labels,
        datasets: [
          {
            label: "Findings",
            data: totals,
            borderWidth: 1,
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: (ctx) => {
                const v = ctx.parsed.y || 0;
                return `  ${v} findings`;
              },
            },
          },
        },
        scales: {
          x: {
            grid: { display: false },
            ticks: { maxRotation: 45, minRotation: 45 },
          },
          y: {
            beginAtZero: true,
            grid: { color: "rgba(148,163,210,0.25)" },
          },
        },
      },
    });
  }

  async function initTopCweFromInsights() {
    try {
      const data = await fetchJson(API_TOP_CWE_V1);
      if (!data || data.ok === false) {
        console.warn("[VSP] TOPCWE – insights ok=false hoặc data rỗng", data && data.error);
        return;
      }
      const items = Array.isArray(data.items) ? data.items : [];
      if (!items.length) {
        console.warn("[VSP] TOPCWE – empty items from insights");
        return;
      }
      renderTopCweBarFromInsights(items);
    } catch (e) {
      console.warn("[VSP] TOPCWE – insights fetch error:", e);
    }
  }

  // Giữ hàm initTopCwe cũ để loadAll() vẫn gọi được,
  // nhưng bên trong chỉ còn gọi insights.
  async function initTopCwe(summary) {  // summary không dùng nữa
    await initTopCweFromInsights();
  }

/* ========== TOP FINDINGS ========== */

  async function initTopFindings() {
    const tbody = document.querySelector("#top-findings-table tbody");
    if (!tbody) return;

    try {
      const resp = await fetchJson(API_DS_SEV("CRITICAL", 5));
      const items = Array.isArray(resp.items) ? resp.items : [];
      if (!items.length) {
        tbody.innerHTML =
          '<tr><td colspan="10" style="color:#9ca3c7;font-size:11px;">Không load được dữ liệu top findings.</td></tr>';
        return;
      }

      const rows = items
        .map((it) => {
          const sev =
            '<span class="vsp-severity-badge vsp-severity-critical">CRITICAL</span>';
          const loc = it.location || it.file || it.path || "";
          const rule = it.rule || it.rule_id || it.cwe || "";
          const tool = it.tool || it.source || "";
          return (
            "<tr>" +
            "<td>" + sev + "</td>" +
            "<td>" + escHtml(loc) + "</td>" +
            "<td>" + escHtml(rule) + "</td>" +
            "<td>" + escHtml(tool) + "</td>" +
            "</tr>"
          );
        })
        .join("");

      tbody.innerHTML = rows;
    } catch (e) {
      console.warn("[VSP] initTopFindings error:", e);
      tbody.innerHTML =
        '<tr><td colspan="10" style="color:#9ca3c7;font-size:11px;">Không load được dữ liệu top findings.</td></tr>';
    }
  }

  /* ========== RUNS TAB ========== */

  function renderRunsTable(runs) {
    const container = $("vsp-runs-container");
    if (!container) return;

    if (!Array.isArray(runs) || !runs.length) {
      setNoData(container, "Không load được dữ liệu runs.");
      return;
    }

    const rows = runs
      .slice(0, 20)
      .map((r) => {
        const sev = r.by_severity || r.severity || {};
        return (
          "<tr>" +
          "<td>" + escHtml(r.run_id || r.id || "") + "</td>" +
          "<td>" + safeInt(r.total_findings || r.total) + "</td>" +
          "<td>" + safeInt(sev.CRITICAL) + "</td>" +
          "<td>" + safeInt(sev.HIGH) + "</td>" +
          "<td>" + safeInt(sev.MEDIUM) + "</td>" +
          "<td>" + safeInt(sev.LOW) + "</td>" +
          "</tr>"
        );
      })
      .join("");

    container.innerHTML =
      '<table class="vsp-table">' +
      "<thead><tr>" +
      "<th>Run ID</th>" +
      "<th>Total</th>" +
      "<th>CRI</th>" +
      "<th>HIGH</th>" +
      "<th>MED</th>" +
      "<th>LOW</th>" +
      "</tr></thead>" +
      "<tbody>" + rows + "</tbody></table>";
  }

  async function initRunsTab() {
    const container = $("vsp-runs-container");
    if (!container) return;

    // ưu tiên v3, fallback v1
    try {
      const runs = await fetchJson(API_RUNS_V3);
      renderRunsTable(runs);
      return;
    } catch (e) {
      console.warn("[VSP] runs_index_v3 error (tab):", e);
    }

    try {
      const runs = await fetchJson(API_RUNS_V1);
      renderRunsTable(runs);
    } catch (e) {
      console.warn("[VSP] /api/vsp/runs (v1) error:", e);
      setNoData(
        container,
        "Không load được dữ liệu runs (API /api/vsp/runs_index_v3_v3 và /api/vsp/runs đều chưa sẵn sàng)."
      );
    }
  }

  /* ========== DATA SOURCE TAB ========== */

  async function initDatasourceTab(summary, bySevComputed) {
    const container = $("vsp-datasource-container");
    if (!container) return;

    try {
      const sev =
        bySevComputed ||
        summary.by_severity ||
        summary.severity ||
        summary.by_severity_buckets ||
        {};

      let byTool =
        summary.by_tool ||
        summary.by_tool_severity ||
        summary.by_tools ||
        summary.tools ||
        {};

      // nếu datasource không có by_tool – thử lấy từ dashboard_v3
      if (!Object.keys(byTool).length) {
        try {
          const dash = await fetchJson(API_DASHBOARD_V3);
          byTool = dash.by_tool || {};
        } catch (e) {
          console.warn("[VSP] dashboard_v3 by_tool fallback error:", e);
        }
      }

      const sevRows = SEVERITIES.map((s) => {
        return (
          "<tr><td>" +
          s +
          "</td><td>" +
          safeInt(sev[s]) +
          "</td></tr>"
        );
      }).join("");

      const toolKeys = Object.keys(byTool || {});
      const toolRows = toolKeys
        .sort()
        .map((tool) => {
          const raw = byTool[tool] || {};
          const d = raw.by_severity || raw.severity || raw;
          return (
            "<tr>" +
            "<td>" + escHtml(tool) + "</td>" +
            "<td>" + safeInt(d.CRITICAL) + "</td>" +
            "<td>" + safeInt(d.HIGH) + "</td>" +
            "<td>" + safeInt(d.MEDIUM) + "</td>" +
            "<td>" + safeInt(d.LOW) + "</td>" +
            "</tr>"
          );
        })
        .join("");

      const rightTable =
        toolKeys.length === 0
          ? "<p style='font-size:12px;color:#9ca3c7;'>Không có dữ liệu theo tool.</p>"
          : '<table class="vsp-table">' +
            "<thead><tr><th>Tool</th><th>CRI</th><th>HIGH</th><th>MED</th><th>LOW</th></tr></thead>" +
            "<tbody>" + toolRows + "</tbody></table>";

      container.innerHTML =
        '<div style="display:grid;grid-template-columns:35% 65%;gap:12px;">' +
        '<div>' +
        '<h3 style="margin:0 0 6px;font-size:13px;">Tổng quan theo mức độ</h3>' +
        '<table class="vsp-table">' +
        "<thead><tr><th>Severity</th><th>Count</th></tr></thead>" +
        "<tbody>" + sevRows + "</tbody></table>" +
        "</div>" +
        '<div>' +
        '<h3 style="margin:0 0 6px;font-size:13px;">Theo tool</h3>' +
        rightTable +
        "</div>" +
        "</div>";
    } catch (e) {
      console.warn("[VSP] initDatasourceTab error:", e);
      setNoData(
        container,
        "Không load được datasource (API /api/vsp/datasource?mode=dashboard chưa sẵn sàng)."
      );
    }
  }

  /* ========== SETTINGS TAB ========== */

  async function initSettingsTab() {
    const container = $("vsp-settings-container");
    if (!container) return;

    try {
      const cfg = await fetchJson(API_SETTINGS);
      container.innerHTML =
        "<h3 style='margin:0 0 6px;font-size:13px;'>Cấu hình VSP EXT+ (đọc từ API)</h3>" +
        "<pre style='font-size:11px;white-space:pre-wrap;border-radius:8px;background:#020617;padding:8px;border:1px solid rgba(148,163,210,0.35);'>" +
        escHtml(JSON.stringify(cfg, null, 2)) +
        "</pre>";
    } catch (e) {
      console.warn("[VSP] initSettingsTab error:", e);
      setNoData(
        container,
        "Không load được cấu hình (API /api/vsp/settings/get chưa sẵn sàng)."
      );
    }
  }

  /* ========== RULE OVERRIDES TAB ========== */

  async function initOverridesTab() {
    const container = $("vsp-overrides-container");
    if (!container) return;

    try {
      const resp = await fetchJson(API_OVERRIDES);
      const raw = Array.isArray(resp.items) ? resp.items : resp;
      let list;

      if (Array.isArray(raw)) {
        list = raw;
      } else if (raw && typeof raw === "object") {
        list = Object.keys(raw).map((k) => raw[k]);
      } else {
        throw new Error("invalid overrides format");
      }

      const rows = list
        .map((it) => {
          return (
            "<tr>" +
            "<td>" + escHtml(it.id || it.name || "") + "</td>" +
            "<td>" + escHtml(it.pattern || it.rule || "") + "</td>" +
            "<td>" + escHtml(it.reason || "") + "</td>" +
            "</tr>"
          );
        })
        .join("");

      container.innerHTML =
        "<h3 style='margin:0 0 6px;font-size:13px;'>Rule overrides</h3>" +
        '<table class="vsp-table">' +
        "<thead><tr><th>ID</th><th>Pattern / Rule</th><th>Reason</th></tr></thead>" +
        "<tbody>" + rows + "</tbody></table>";
    } catch (e) {
      console.warn("[VSP] initOverridesTab error:", e);
      setNoData(
        container,
        "Không load được danh sách override (API /api/vsp/overrides/list chưa sẵn sàng)."
      );
    }
  }

  /* ========== MAIN LOAD ========== */

  async function loadAll() {
    try {
      const resp = await fetchJson(API_SUMMARY);
      const summary = resp.summary || resp;

      const dash = {
        run_id: resp.run_id || summary.run_id,
        ts: resp.ts || summary.ts,
        total_findings:
          summary.total_findings ||
          summary.total ||
          summary.total_findings_unified,
      };

      const bySev = await computeSeverityBucketsFromDatasource();

      renderKpisAndDonut(dash, bySev);
      await initTrend();
      renderTopCweBar(summary);
      await initTopFindings();

      await initRunsTab();
      await initDatasourceTab(summary, bySev);
      await initSettingsTab();
      await initOverridesTab();
    } catch (e) {
      console.error("[VSP] loadAll error:", e);
    }
  }

  window.VSP_DASHBOARD_LIVE_V2_INIT = function () {
    loadAll().catch((err) => console.error("[VSP] loadAll outer error:", err));
  };
})();



/* ========== TOP CWE FROM INSIGHTS V1 ========== */

function renderTopCweBarFromInsights(items) {
  const canvas = ensureTopCweCanvas();
  if (!canvas || typeof Chart === "undefined") return;

  const arr = Array.isArray(items) ? items : [];
  if (!arr.length) {
    console.debug("[VSP] renderTopCweBarFromInsights: empty items");
    return;
  }

  const labels = arr.map((it) => it.cwe || "UNKNOWN");
  const totals = arr.map((it) => safeInt(it.count || 0));

  if (topCweChart) {
    try {
      topCweChart.destroy();
    } catch (e) {
      console.warn("[VSP] destroy topCweChart error:", e);
    }
  }

  topCweChart = new Chart(canvas, {
    type: "bar",
    data: {
      labels,
      datasets: [
        {
          label: "Findings",
          data: totals,
          borderWidth: 1,
          // Màu để Chart.js tự chọn, UI theme đã lo phần nền
        }
      ],
    },
    options: {
      indexAxis: "y",
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
      },
      scales: {
        x: {
          beginAtZero: true,
          grid: { color: "rgba(148,163,210,0.25)" },
        },
        y: {
          ticks: { autoSkip: false },
          grid: { display: false },
        },
      },
    },
  });
}

async function initTopCweFromInsights() {
  if (typeof API_TOP_CWE_V1 === "undefined") {
    console.warn("[VSP] API_TOP_CWE_V1 not defined – skip Top CWE chart.");
    return;
  }
  try {
    const data = await fetchJson(API_TOP_CWE_V1 + "?limit=5");
    const items = data && Array.isArray(data.items) ? data.items : [];
    if (!items.length) {
      console.warn("[VSP] top_cwe_v1: no items");
      return;
    }
    renderTopCweBarFromInsights(items);
  } catch (e) {
    console.warn("[VSP] top_cwe_v1 error:", e);
  }
}

// ======================= TOP_CWE_PATCH_V3 =======================
// Bind TOP CWE từ /api/vsp/dashboard_v3 (hoặc window.__vspTopCweInit)
(function () {
  function bindTopCwe(payload) {
    try {
      if (!payload) {
        console.warn("[VSP][TOP_CWE] Không có payload");
        return;
      }

      // Hỗ trợ 2 dạng:
      // 1) { run_id, top_cwe: [...] }
      // 2) { ok, payload: { run_id, top_cwe: [...] } }
      var topList = null;

      if (Array.isArray(payload.top_cwe)) {
        topList = payload.top_cwe;
      } else if (payload.payload && Array.isArray(payload.payload.top_cwe)) {
        topList = payload.payload.top_cwe;
      }

      if (!topList || !topList.length) {
        console.warn("[VSP][TOP_CWE] Không có top_cwe trong payload");
        return;
      }

      var top = topList[0] || {};
      var label = top.id || "N/A";
      var count = (top.count != null) ? top.count : 0;

      var labelNodes = document.querySelectorAll("[data-vsp-topcwe-label]");
      for (var i = 0; i < labelNodes.length; i++) {
        labelNodes[i].textContent = label;
      }

      var countNodes = document.querySelectorAll("[data-vsp-topcwe-count]");
      for (var j = 0; j < countNodes.length; j++) {
        countNodes[j].textContent = String(count);
      }

      console.log("[VSP][TOP_CWE] Bound TOP CWE =", label, "count =", count);
    } catch (err) {
      console.error("[VSP][TOP_CWE] bindTopCwe error:", err);
    }
  }

  // expose global để chỗ khác gọi được
  window.__vspBindTopCwe = bindTopCwe;

  function initTopCweFromInsights() {
    try {
      if (window.__vspTopCweInit) {
        console.log("[VSP][TOP_CWE] Dùng window.__vspTopCweInit");
        bindTopCwe(window.__vspTopCweInit);
        return;
      }

      fetch("/api/vsp/dashboard_v3")
        .then(function (res) {
          if (!res.ok) {
            throw new Error("HTTP " + res.status);
          }
          return res.json();
        })
        .then(function (data) {
          console.log("[VSP][TOP_CWE] Nhận data từ /api/vsp/dashboard_v3", data);
          bindTopCwe(data);
        })
        .catch(function (err) {
          console.error("[VSP][TOP_CWE] Fetch /api/vsp/dashboard_v3 lỗi:", err);
        });
    } catch (err) {
      console.error("[VSP][TOP_CWE] initTopCweFromInsights error:", err);
    }
  }

  // cũng expose global nếu muốn gọi tay
  window.initTopCweFromInsights = initTopCweFromInsights;

  document.addEventListener("DOMContentLoaded", function () {
    try {
      initTopCweFromInsights();
    } catch (err) {
      console.error("[VSP][TOP_CWE] DOMContentLoaded hook error:", err);
    }
  });
})();

// ======================= VSP_ADVANCED_KPI_V1 =======================
// Bind 4 advanced KPI vào layout CIO-level:
// - Security Posture Score (0–100)
// - Top risky tool
// - Top impacted CWE  (lấy thẳng từ top_cwe[0].id)
// - Top vulnerable module

function vspBindAdvancedKpis(dash) {
  try {
    if (!dash) {
      console.warn("[VSP][ADV_KPI] Không có dashboard data để bind.");
      return;
    }

    // 1) Security Posture Score
    var scoreEl = document.querySelector("[data-vsp-kpi-posture-score]");
    if (scoreEl) {
      var score = null;
      if (typeof dash.security_posture_score === "number") {
        score = dash.security_posture_score;
      } else if (dash.security_posture && typeof dash.security_posture.score === "number") {
        score = dash.security_posture.score;
      }
      if (typeof score === "number") {
        scoreEl.textContent = String(score);
      } else {
        scoreEl.textContent = "0";
      }
    }

    // 2) Top risky tool
    var riskyEl = document.querySelector("[data-vsp-kpi-top-risky-tool]");
    if (riskyEl) {
      var risky = dash.top_risky_tool
        || (dash.security_posture && dash.security_posture.top_risky_tool)
        || null;
      if (risky && typeof risky.tool === "string") {
        riskyEl.textContent = risky.tool.toUpperCase();
      } else if (typeof risky === "string") {
        riskyEl.textContent = risky.toUpperCase();
      } else {
        riskyEl.textContent = "–";
      }
    }

    // 3) Top impacted CWE – luôn ưu tiên từ top_cwe[0].id
    var cweEl = document.querySelector("[data-vsp-kpi-top-cwe]");
    if (cweEl) {
      var hiId = null;
      if (Array.isArray(dash.top_cwe) && dash.top_cwe.length && typeof dash.top_cwe[0].id === "string") {
        hiId = dash.top_cwe[0].id;
      } else if (typeof dash.highest_impacted_cwe === "string") {
        hiId = dash.highest_impacted_cwe;
      } else if (dash.highest_impacted_cwe && typeof dash.highest_impacted_cwe.id === "string") {
        hiId = dash.highest_impacted_cwe.id;
      }
      cweEl.textContent = hiId || "–";
    }

    // 4) Top vulnerable module
    var modEl = document.querySelector("[data-vsp-kpi-top-module]");
    if (modEl) {
      var mod = dash.top_vulnerable_module
        || (dash.security_posture && dash.security_posture.top_vulnerable_module)
        || null;
      if (mod && typeof mod.name === "string") {
        modEl.textContent = mod.name;
      } else if (typeof mod === "string") {
        modEl.textContent = mod;
      } else {
        modEl.textContent = "–";
      }
    }

    console.log("[VSP][ADV_KPI] Bound advanced KPIs (CWE từ top_cwe[0].id).");
  } catch (err) {
    console.error("[VSP][ADV_KPI] bind error:", err);
  }
}


/* ==== END static/js/vsp_dashboard_live_v2.V1_baseline.js ==== */
;
;
/* ==== BEGIN static/js/vsp_dashboard_live_v2.js ==== */

// === VSP DASHBOARD FIX V3 – CHUẨN 2025 ===

// mapping severity 6 mức chuẩn
const VSP_SEVERITY_KEYS = ["CRITICAL","HIGH","MEDIUM","LOW","INFO","TRACE"];

// mapping tool 8 chuẩn
const VSP_TOOL_KEYS = [
  "gitleaks","semgrep","kics","codeql",
  "bandit","trivy_fs","grype","syft"
];

// Load KPI vào Dashboard
function vspLoadKPIs(data) {
  $("#kpi-total").text(data.total_findings);

  // by severity
  VSP_SEVERITY_KEYS.forEach(sev => {
    const el = $("#kpi-" + sev.toLowerCase());
    el.text(data.by_severity[sev] || 0);
    el.addClass("sev-" + sev.toLowerCase());
  });

  // by tool
  VSP_TOOL_KEYS.forEach(tool => {
    $("#kpi-tool-" + tool).text(data.by_tool[tool] || 0);
  });

  $("#kpi-top-cwe").text(data.top_cwe || "N/A");
  $("#kpi-top-module").text(data.top_module || "N/A");
  $("#kpi-top-risky-tool").text(data.top_risky_tool || "N/A");
}

// MAIN fetch
function loadDashboard() {
  fetch("/api/vsp/dashboard_v3")
    .then(r => r.json())
    .then(json => {
      if (!json.ok) return console.error("[DASHBOARD] JSON not ok");
      vspLoadKPIs(json);
      drawCharts(json); // gọi chart
    })
    .catch(err => console.error("[DASHBOARD] Error", err));
}

document.addEventListener("DOMContentLoaded", loadDashboard);


/* ======================= VSP_DASHBOARD_KPI_V2 – BEGIN ======================= */

window.vspDashboardApplyExtrasV1 = function(extras) {
  try {
    if (!extras) return;
    window.vspApplyKpiDiffFromExtras(extras);
    window.vspRenderTopRiskFromExtras(extras);
  } catch (e) {
    console && console.warn && console.warn("[VSP][KPI_V2] Error apply extras:", e);
  }
};

window.vspApplyKpiDiffFromExtras = function(extras) {
  try {
    if (!extras || !extras.kpi_diff_v1) return;
    var diff  = extras.kpi_diff_v1;
    var cur   = diff.current || {};
    var prev  = diff.prev   || {};
    var delta = diff.delta  || {};

    // Last run label: PREV → CURRENT
    var prevId = prev.run_id || "N/A";
    var curId  = cur.run_id  || "N/A";
    var lastRunLabel = prevId + " \u2192 " + curId; // arrow

    // Delta total + chi tiết từng severity
    var dTotal = delta.total_findings || 0;
    var signTotal = dTotal > 0 ? "+" : "";
    var baseText = signTotal + dTotal + " findings vs prev";

    var sevOrder = ["CRITICAL", "HIGH", "MEDIUM", "LOW"];
    var sevParts = [];
    if (delta.by_severity) {
      sevOrder.forEach(function(s) {
        var v = delta.by_severity.hasOwnProperty(s)
          ? delta.by_severity[s]
          : 0;
        if (!v) return;
        var sign = v > 0 ? "+" : "";
        sevParts.push(sign + v + " " + s);
      });
    }
    var details = sevParts.length ? " (" + sevParts.join(", ") + ")" : "";
    var deltaText = baseText + details;

    var elLast = document.getElementById("kpi-last-run-label");
    if (!elLast) {
      elLast = document.querySelector("[data-kpi-last-run]");
    }
    if (elLast) {
      elLast.textContent = lastRunLabel;
    }

    var elDelta = document.getElementById("kpi-delta-label");
    if (!elDelta) {
      elDelta = document.querySelector("[data-kpi-delta]");
    }
    if (elDelta) {
      elDelta.textContent = deltaText;
    }

    if (window.console && console.log) {
      console.log("[VSP][KPI_V2] Applied KPI diff extras.");
    }
  } catch (e) {
    console && console.warn && console.warn("[VSP][KPI_V2] Error in vspApplyKpiDiffFromExtras:", e);
  }
};

window.vspRenderTopRiskFromExtras = function(extras) {
  try {
    if (!extras || !extras.top_risk_findings) return;
    var items = extras.top_risk_findings;
    if (!Array.isArray(items) || items.length === 0) return;

    var tbody = document.getElementById("vsp-top-risk-tbody");
    if (!tbody) {
      tbody = document.querySelector("tbody[data-top-risk-body]");
    }
    if (!tbody) {
      return;
    }

    while (tbody.firstChild) {
      tbody.removeChild(tbody.firstChild);
    }

    items.forEach(function(it, idx) {
      var tr = document.createElement("tr");

      var tdIdx  = document.createElement("td");
      var tdSev  = document.createElement("td");
      var tdTool = document.createElement("td");
      var tdFile = document.createElement("td");
      var tdRule = document.createElement("td");

      tdIdx.textContent  = String(idx + 1);

      // Severity badge + palette
      var sev = (it.severity || "").toUpperCase();
      tdSev.textContent = sev;
      var cls = "sev-" + sev.toLowerCase();
      tdSev.classList.add("sev-pill");
      tdSev.classList.add(cls);

      tdTool.textContent = it.tool || "";

      var fileLabel = it.file || "";
      if (it.line) {
        fileLabel += ":" + it.line;
      }
      tdFile.textContent = fileLabel;

      // Rule / CWE gọn đẹp
      var rule = it.rule_id || "";
      var cwe  = it.cwe || "";
      var label = "";
      if (rule && cwe) {
        label = rule + " \u2022 " + cwe; // bullet giữa
      } else if (rule) {
        label = rule;
      } else if (cwe) {
        label = cwe;
      }
      // Cắt ngắn nếu quá dài
      var maxLen = 60;
      if (label.length > maxLen) {
        label = label.slice(0, maxLen - 1) + "\u2026";
      }
      tdRule.textContent = label;

      tr.appendChild(tdIdx);
      tr.appendChild(tdSev);
      tr.appendChild(tdTool);
      tr.appendChild(tdFile);
      tr.appendChild(tdRule);

      tbody.appendChild(tr);
    });

    if (window.console && console.log) {
      console.log("[VSP][KPI_V2] Rendered top_risk_findings:", items.length);
    }
  } catch (e) {
    console && console.warn && console.warn("[VSP][KPI_V2] Error in vspRenderTopRiskFromExtras:", e);
  }
};

/* ======================= VSP_DASHBOARD_KPI_V2 – END ========================= */


/* ======================= VSP_DASHBOARD_KPI_V3 – BEGIN ======================= */

window.vspDashboardApplyExtrasV1 = function(extras) {
  try {
    if (!extras) return;
    window.vspApplyKpiDiffFromExtras(extras);
    window.vspRenderTopRiskFromExtras(extras);
  } catch (e) {
    console && console.warn && console.warn("[VSP][KPI_V3] Error apply extras:", e);
  }
};

window.vspApplyKpiDiffFromExtras = function(extras) {
  try {
    if (!extras || !extras.kpi_diff_v1) return;
    var diff  = extras.kpi_diff_v1;
    var cur   = diff.current || {};
    var prev  = diff.prev   || {};
    var delta = diff.delta  || {};

    // Last run label: PREV → CURRENT
    var prevId = prev.run_id || "N/A";
    var curId  = cur.run_id  || "N/A";
    var lastRunLabel = prevId + " \u2192 " + curId; // arrow

    // Delta total
    var dTotal = delta.total_findings || 0;
    var signTotal = dTotal > 0 ? "+" : (dTotal < 0 ? "" : ""); // âm tự có dấu '-'
    var baseText = signTotal + dTotal + " findings vs prev";

    // Delta chi tiết 6 severity
    var sevOrder = ["CRITICAL", "HIGH", "MEDIUM", "LOW", "INFO", "TRACE"];
    var sevParts = [];
    if (delta.by_severity) {
      sevOrder.forEach(function(s) {
        var raw = delta.by_severity.hasOwnProperty(s)
          ? delta.by_severity[s]
          : 0;
        var v = raw || 0;
        if (!v) return; // bỏ những cái = 0 cho gọn
        var sign = v > 0 ? "+" : ""; // âm tự có '-'
        sevParts.push(sign + v + " " + s);
      });
    }
    var details = sevParts.length ? " (" + sevParts.join(", ") + ")" : "";
    var deltaText = baseText + details;

    // Update DOM
    var elLast = document.getElementById("kpi-last-run-label");
    if (!elLast) {
      elLast = document.querySelector("[data-kpi-last-run]");
    }
    if (elLast) {
      elLast.textContent = lastRunLabel;
    }

    var elDelta = document.getElementById("kpi-delta-label");
    if (!elDelta) {
      elDelta = document.querySelector("[data-kpi-delta]");
    }
    if (elDelta) {
      // reset class cũ
      elDelta.classList.remove("kpi-delta-bad", "kpi-delta-good", "kpi-delta-neutral");
      elDelta.textContent = deltaText;
      if (dTotal > 0) {
        elDelta.classList.add("kpi-delta-bad");
      } else if (dTotal < 0) {
        elDelta.classList.add("kpi-delta-good");
      } else {
        elDelta.classList.add("kpi-delta-neutral");
      }
    }

    if (window.console && console.log) {
      console.log("[VSP][KPI_V3] Applied KPI diff extras.");
    }
  } catch (e) {
    console && console.warn && console.warn("[VSP][KPI_V3] Error in vspApplyKpiDiffFromExtras:", e);
  }
};

window.vspRenderTopRiskFromExtras = function(extras) {
  try {
    if (!extras || !extras.top_risk_findings) return;
    var items = extras.top_risk_findings;
    if (!Array.isArray(items) || items.length === 0) return;

    var tbody = document.getElementById("vsp-top-risk-tbody");
    if (!tbody) {
      tbody = document.querySelector("tbody[data-top-risk-body]");
    }
    if (!tbody) {
      return;
    }

    while (tbody.firstChild) {
      tbody.removeChild(tbody.firstChild);
    }

    items.forEach(function(it, idx) {
      var tr = document.createElement("tr");

      var tdIdx  = document.createElement("td");
      var tdSev  = document.createElement("td");
      var tdTool = document.createElement("td");
      var tdFile = document.createElement("td");
      var tdRule = document.createElement("td");

      tdIdx.textContent  = String(idx + 1);

      // Severity badge + palette
      var sev = (it.severity || "").toUpperCase();
      tdSev.textContent = sev;
      var sevCls = "sev-" + sev.toLowerCase(); // sev-critical, sev-high, ...
      tdSev.classList.add("sev-pill");
      tdSev.classList.add(sevCls);

      tdTool.textContent = it.tool || "";

      var fileLabel = it.file || "";
      if (it.line) {
        fileLabel += ":" + it.line;
      }
      tdFile.textContent = fileLabel;

      // Rule / CWE gọn đẹp
      var rule = it.rule_id || "";
      var cwe  = it.cwe || "";
      var label = "";
      if (rule && cwe) {
        label = rule + " \u2022 " + cwe; // bullet giữa
      } else if (rule) {
        label = rule;
      } else if (cwe) {
        label = cwe;
      }
      var maxLen = 60;
      if (label.length > maxLen) {
        label = label.slice(0, maxLen - 1) + "\u2026";
      }
      tdRule.textContent = label;

      tr.appendChild(tdIdx);
      tr.appendChild(tdSev);
      tr.appendChild(tdTool);
      tr.appendChild(tdFile);
      tr.appendChild(tdRule);

      tbody.appendChild(tr);
    });

    if (window.console && console.log) {
      console.log("[VSP][KPI_V3] Rendered top_risk_findings:", items.length);
    }
  } catch (e) {
    console && console.warn && console.warn("[VSP][KPI_V3] Error in vspRenderTopRiskFromExtras:", e);
  }
};

/* ======================= VSP_DASHBOARD_KPI_V3 – END ========================= */
// ===================== VSP RUNS TABLE META V1 =====================

function vspRenderRunsTable(runs) {
  const tbody = document.getElementById("vsp-runs-tbody");
  if (!tbody) return;

  tbody.innerHTML = "";

  runs.forEach(run => {
    const row = document.createElement("tr");
    const sev = run.by_severity || {};
    const tools = run.by_tool ? Object.keys(run.by_tool).length : 0;

    const ts = run.timestamp || "";
    const profile = run.profile || "";
    const src = run.src_path || "";
    const url = run.entry_url || "";

    const urlShort = url
      ? (url.length > 40 ? url.slice(0, 37) + "..." : url)
      : "";

    row.innerHTML = `
      <td class="vsp-cell-runid">\${run.run_id || ""}</td>
      <td>\${ts}</td>
      <td>\${profile}</td>
      <td>\${src}</td>
      <td>${url ? `<a href="${url}" target="_blank" rel="noopener noreferrer">\${urlShort}</a>` : ""}</td>
      <td>\${run.total_findings || 0}</td>
      <td>\${sev.CRITICAL || 0}</td>
      <td>\${sev.HIGH || 0}</td>
      <td>\${sev.MEDIUM || 0}</td>
      <td>\${sev.LOW || 0}</td>
      <td>\${sev.INFO || 0}</td>
      <td>\${sev.TRACE || 0}</td>
      <td>\${tools}</td>
      <td><span class="vsp-tag vsp-tag-muted">N/A</span></td>
    `;
    tbody.appendChild(row);
  });
}

async function vspLoadRunsIndexV3() {
  try {
    const res = await fetch("/api/vsp/runs_index_v3");
    if (!res.ok) {
      console.error("[RUNS] HTTP error", res.status);
      return;
    }
    const runs = await res.json();
    if (!Array.isArray(runs)) {
      console.error("[RUNS] Unexpected payload", runs);
      return;
    }
    vspRenderRunsTable(runs);
  } catch (err) {
    console.error("[RUNS] Failed to load runs_index_v3:", err);
  }
}
// =================== END VSP RUNS TABLE META V1 ====================

// ================= VSP_SETTINGS_PROFILE_RULES_V1 =================

// Load settings JSON, có fallback demo
async function vspLoadSettingsProfileV1() {
  try {
    const res = await fetch("/static/data/vsp_settings_profile_v1.json?_=" + Date.now());
    if (!res.ok) throw new Error("HTTP " + res.status);
    const js = await res.json();
    return js;
  } catch (e) {
    console.warn("[VSP_SETTINGS] Không load được settings_profile_v1, dùng demo. Lý do:", e);
    return {
      profile_name: "VSP_FULL_EXT_2025",
      env: "STAGING / DEMO",
      run_id_latest: "RUN_VSP_FULL_EXT_DEMO",
      security_score: 0,
      tools: [
        { id: "bandit", name: "bandit", type: "SAST", mode: "EXT", enabled: true, findings: 0, severity_min: "LOW" },
        { id: "gitleaks", name: "gitleaks", type: "Secrets", mode: "EXT", enabled: true, findings: 0, severity_min: "HIGH" },
        { id: "kics", name: "kics", type: "IaC", mode: "EXT", enabled: true, findings: 0, severity_min: "MEDIUM" },
      ],
      profiles: [
        { id: "FULL_EXT", label: "Full EXT (all tools)", tools: ["bandit","gitleaks","kics"], description: "Full extended profile – all tools enabled." }
      ]
    };
  }
}

// Render Tab 4 – Settings / Profile / Tools
async function vspInitSettingsTabV1() {
  const panel = document.querySelector('.vsp-tab-panel[data-tab="4"]');
  if (!panel) {
    console.warn("[VSP_SETTINGS] Không thấy panel Tab 4.");
    return;
  }

  const cfg = await vspLoadSettingsProfileV1();
  const tools = Array.isArray(cfg.tools) ? cfg.tools : [];
  const profiles = Array.isArray(cfg.profiles) ? cfg.profiles : [];

  let toolsRows = "";
  tools.forEach((t, idx) => {
    const badge = t.enabled ? "Enabled" : "Disabled";
    const badgeClass = t.enabled ? "status-badge status-ok" : "status-badge status-off";
    toolsRows += `
      <tr>
        <td>${idx + 1}</td>
        <td>${t.id}</td>
        <td>${t.type || "-"}</td>
        <td>${t.mode || "-"}</td>
        <td>${t.severity_min || "-"}</td>
        <td>${t.findings != null ? t.findings : "-"}</td>
        <td><span class="${badgeClass}">${badge}</span></td>
      </tr>
    `;
  });

  let profilesRows = "";
  profiles.forEach((p, idx) => {
    profilesRows += `
      <tr>
        <td>${idx + 1}</td>
        <td>${p.id}</td>
        <td>${p.label || "-"}</td>
        <td>${(p.tools || []).join(", ")}</td>
        <td>${p.description || "-"}</td>
      </tr>
    `;
  });

  panel.innerHTML = `
    <div class="vsp-section-header">
      <div class="vsp-section-title">Tab 4 – Settings / Profile / Tools</div>
      <div class="vsp-section-subtitle">Scan profile &amp; tool configuration (read-only)</div>
    </div>

    <div class="vsp-grid vsp-grid-2">
      <div class="vsp-card">
        <div class="vsp-card-title">Profile overview</div>
        <div class="vsp-card-body">
          <div class="vsp-metric-line"><span>Active profile:</span><span>${cfg.profile_name || "-"}</span></div>
          <div class="vsp-metric-line"><span>Environment:</span><span>${cfg.env || "-"}</span></div>
          <div class="vsp-metric-line"><span>Latest run:</span><span>${cfg.run_id_latest || "-"}</span></div>
          <div class="vsp-metric-line"><span>Security posture score:</span><span>${cfg.security_score || 0} / 100</span></div>
          <div class="vsp-metric-line"><span>Tools enabled:</span><span>${tools.length}</span></div>
        </div>
      </div>

      <div class="vsp-card">
        <div class="vsp-card-title">Profiles</div>
        <div class="vsp-card-body">
          <div class="vsp-table-wrapper">
            <table class="vsp-table compact">
              <thead>
                <tr>
                  <th>#</th>
                  <th>ID</th>
                  <th>Label</th>
                  <th>Tools</th>
                  <th>Description</th>
                </tr>
              </thead>
              <tbody>
                ${profilesRows || `<tr><td colspan="5" style="text-align:center;opacity:.6;">No profiles defined.</td></tr>`}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="vsp-card vsp-card-fullwidth">
      <div class="vsp-card-title">Tools configuration</div>
      <div class="vsp-card-body">
        <div class="vsp-table-wrapper">
          <table class="vsp-table compact">
            <thead>
              <tr>
                <th>#</th>
                <th>Tool</th>
                <th>Type</th>
                <th>Mode</th>
                <th>Severity min</th>
                <th>Findings (latest run)</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              ${toolsRows || `<tr><td colspan="7" style="text-align:center;opacity:.6;">No tools found.</td></tr>`}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  `;
}

// Render Tab 5 – Rule Overrides (read-only)
async function vspInitRuleOverridesTabV1() {
  const panel = document.querySelector('.vsp-tab-panel[data-tab="5"]');
  if (!panel) {
    console.warn("[VSP_RULES] Không thấy panel Tab 5.");
    return;
  }

  // Thử load file overrides nếu sau này bạn có, còn hiện tại coi như chưa cấu hình
  let overrides = [];
  try {
    const res = await fetch("/static/data/vsp_rule_overrides_v1.json?_=" + Date.now());
    if (res.ok) {
      const js = await res.json();
      if (Array.isArray(js)) overrides = js;
      else if (Array.isArray(js.items)) overrides = js.items;
    }
  } catch (e) {
    console.warn("[VSP_RULES] Không load được vsp_rule_overrides_v1.json:", e);
  }

  let rows = "";
  overrides.forEach((ov, idx) => {
    rows += `
      <tr>
        <td>${idx + 1}</td>
        <td>${ov.tool || "-"}</td>
        <td>${ov.rule_id || "-"}</td>
        <td>${ov.rule_name || "-"}</td>
        <td>${ov.severity_raw || "-"}</td>
        <td>${ov.severity_effective || "-"}</td>
        <td>${ov.reason || "-"}</td>
      </tr>
    `;
  });

  panel.innerHTML = `
    <div class="vsp-section-header">
      <div class="vsp-section-title">Tab 5 – Rule overrides</div>
      <div class="vsp-section-subtitle">View / audit severity overrides &amp; rule tuning (read-only)</div>
    </div>

    <div class="vsp-card vsp-card-fullwidth">
      <div class="vsp-card-title">Overrides registry</div>
      <div class="vsp-card-body">
        <div class="vsp-table-wrapper">
          <table class="vsp-table compact">
            <thead>
              <tr>
                <th>#</th>
                <th>Tool</th>
                <th>Rule ID</th>
                <th>Rule name</th>
                <th>Severity raw</th>
                <th>Severity effective</th>
                <th>Reason</th>
              </tr>
            </thead>
            <tbody>
              ${rows || `<tr><td colspan="7" style="text-align:center;opacity:.6;">No rule overrides configured.</td></tr>`}
            </tbody>
          </table>
        </div>
        <div style="margin-top:12px;opacity:.7;font-size:12px;">
          This view is read-only in demo. Production edition can load overrides from central config
          (YAML/JSON) and allow export for ISO 27001 / DevSecOps audits.
        </div>
      </div>
    </div>
  `;
}

// Gắn init vào DOMContentLoaded của Dashboard
document.addEventListener("DOMContentLoaded", function () {
  vspInitSettingsTabV1();
  vspInitRuleOverridesTabV1();
});

// ================= END VSP_SETTINGS_PROFILE_RULES_V1 =================



/* ==== END static/js/vsp_dashboard_live_v2.js ==== */
;
;
/* ==== BEGIN static/js/vsp_dashboard_tables_live_v1.js ==== */

(function () {
  'use strict';

  const API_TABLES       = '/api/vsp/dashboard_v3_tables';
  const API_TOP_FINDINGS = '/api/vsp/datasource?severity=HIGH&limit=10';

  function findTbodyByTitle(titleText) {
    var all = document.querySelectorAll('*');
    var titleEl = null;

    for (var i = 0; i < all.length; i++) {
      var txt = (all[i].textContent || '').trim();
      if (txt === titleText) {
        titleEl = all[i];
        break;
      }
    }
    if (!titleEl) return null;

    var card = titleEl;
    for (var depth = 0; depth < 6 && card; depth++) {
      var tbody = card.querySelector('tbody');
      if (tbody) return tbody;
      card = card.parentElement;
    }
    return null;
  }

  // -------- Top Findings (chi tiết từ datasource HIGH) ----------
  function renderTopFindings(items) {
    var tbody = findTbodyByTitle('Top Findings');
    if (!tbody) return;

    tbody.innerHTML = '';

    if (!Array.isArray(items) || items.length === 0) {
      var tr = document.createElement('tr');
      var td = document.createElement('td');
      td.colSpan = 5;
      td.textContent = 'No data from latest FULL EXT run.';
      tr.appendChild(td);
      tbody.appendChild(tr);
      return;
    }

    items.forEach(function (f) {
      var tr = document.createElement('tr');

      var sev  = (f.severity || f.sev || '').toString().toUpperCase();
      var tool = f.tool || f.source || '';
      var rule = f.rule_id || f.rule || f.check_id || '';
      var file = f.file || f.path || f.relpath || '';
      var msg  = f.message || f.detail || f.title || '';

      function cell(text) {
        var td = document.createElement('td');
        td.textContent = text;
        tr.appendChild(td);
      }

      cell(sev);
      cell(tool);
      cell(rule);
      cell(file);
      cell(msg);

      tbody.appendChild(tr);
    });
  }

  function loadTopFindings() {
    fetch(API_TOP_FINDINGS)
      .then(function (r) { return r.json(); })
      .then(function (data) {
        if (!data || data.ok === false) {
          console.warn('[VSP][TABLE] datasource HIGH not ok:', data);
          return;
        }
        renderTopFindings(data.items || []);
      })
      .catch(function (err) {
        console.error('[VSP][TABLE] fetch Top Findings error:', err);
      });
  }

  // -------- Top CVE / CWE ----------
  function renderTopCve(list) {
    var tbody = findTbodyByTitle('Top CVE');
    if (!tbody) return;

    tbody.innerHTML = '';

    if (!Array.isArray(list) || list.length === 0) {
      var tr = document.createElement('tr');
      var td = document.createElement('td');
      td.colSpan = 2;
      td.textContent = 'No data from latest FULL EXT run.';
      tr.appendChild(td);
      tbody.appendChild(tr);
      return;
    }

    list.forEach(function (row) {
      var tr = document.createElement('tr');

      var id = row.cve || row.cwe || row.id || '-';
      var count = row.count || 0;

      var td1 = document.createElement('td');
      td1.textContent = id;
      tr.appendChild(td1);

      var td2 = document.createElement('td');
      td2.textContent = String(count);
      tr.appendChild(td2);

      tbody.appendChild(tr);
    });
  }

  // -------- Top Modules ----------
  function renderTopModules(list, topDirs) {
    var tbody = findTbodyByTitle('Top Modules');
    if (!tbody) return;

    tbody.innerHTML = '';

    // Nếu BE chưa có summary.top_modules → tự build từ top_dirs
    if (!Array.isArray(list) || list.length === 0) {
      list = [];
      if (Array.isArray(topDirs)) {
        topDirs.forEach(function (d) {
          list.push({
            name: d.path || '',
            total: d.total || 0,
            crit_high: (d.CRIT || 0) + (d.HIGH || 0)
          });
        });
      }
    }

    if (!Array.isArray(list) || list.length === 0) {
      var tr = document.createElement('tr');
      var td = document.createElement('td');
      td.colSpan = 3;
      td.textContent = 'No data from latest FULL EXT run.';
      tr.appendChild(td);
      tbody.appendChild(tr);
      return;
    }

    list.forEach(function (row) {
      var tr = document.createElement('tr');

      var name = row.name || row.module || row.package || '-';
      var total = row.total || 0;
      var ch = row.crit_high || row.CRIT_HIGH || 0;

      function cell(text) {
        var td = document.createElement('td');
        td.textContent = String(text);
        tr.appendChild(td);
      }

      cell(name);
      cell(total);
      cell(ch);

      tbody.appendChild(tr);
    });
  }

  function loadTables() {
    fetch(API_TABLES)
      .then(function (r) { return r.json(); })
      .then(function (data) {
        if (!data || data.ok === false) {
          console.warn('[VSP][TABLE] /api/vsp/dashboard_v3_tables not ok:', data);
          return;
        }
        var topCweList = data.top_cve_list || data.top_cwe_list || [];
        var topModules = data.top_modules || [];
        var topDirs    = data.top_dirs || [];

        renderTopCve(topCweList);
        renderTopModules(topModules, topDirs);
      })
      .catch(function (err) {
        console.error('[VSP][TABLE] fetch dashboard_tables error:', err);
      });
  }

  document.addEventListener('DOMContentLoaded', function () {
    loadTopFindings();
    loadTables();
  });
})();


/* ==== END static/js/vsp_dashboard_tables_live_v1.js ==== */
;
;
/* ==== BEGIN static/js/vsp_dashboard_top_module_dom_v1.js ==== */

(function () {
  const LOG_PREFIX = "[VSP_TOP_MODULE_DOM]";

  function cleanupOnce() {
    try {
      const root = document.querySelector("#vsp-root") || document;
      if (!root) return;

      // Tìm phần tử có text "Top vulnerable module"
      const all = Array.from(root.querySelectorAll("*"));
      const labelEls = all.filter((el) => {
        if (!el || !el.textContent) return false;
        return el.textContent.trim() === "Top vulnerable module";
      });

      if (!labelEls.length) return;

      labelEls.forEach((labelEl) => {
        let valueEl = labelEl.nextElementSibling;
        if (!valueEl) {
          // thử tìm trong cùng block
          const parent = labelEl.parentElement;
          if (!parent) return;
          const candidates = Array.from(parent.children).filter((c) => c !== labelEl);
          valueEl = candidates[0] || null;
        }
        if (!valueEl) return;

        const raw = (valueEl.textContent || "").trim();
        if (!raw) return;

        let textOut = raw;

        // Nếu là JSON thì parse -> label/path/id
        try {
          const parsed = JSON.parse(raw);
          if (parsed && typeof parsed === "object") {
            textOut =
              parsed.label ||
              parsed.path ||
              parsed.id ||
              raw;
          }
        } catch (e) {
          // không phải JSON thì giữ nguyên
        }

        if (textOut && textOut.length > 80) {
          textOut = textOut.slice(0, 77) + "...";
        }

        if (textOut && textOut !== raw) {
          console.log(LOG_PREFIX, "Normalize top module:", raw, "=>", textOut);
          valueEl.textContent = textOut;
        }
      });
    } catch (err) {
      console.error(LOG_PREFIX, "cleanup error:", err);
    }
  }

  function startWatcher() {
    let tries = 0;
    const maxTries = 30; // ~15s nếu 500ms/lần

    const timer = setInterval(() => {
      tries += 1;
      cleanupOnce();
      if (tries >= maxTries) {
        clearInterval(timer);
      }
    }, 500);
  }

  // Chạy khi load xong
  if (document.readyState === "complete" || document.readyState === "interactive") {
    startWatcher();
  } else {
    window.addEventListener("DOMContentLoaded", startWatcher);
  }

  // Nếu dashboard có trigger event custom thì cũng bắt thêm
  window.addEventListener("vspDashboardV3Rendered", function () {
    console.log(LOG_PREFIX, "Received vspDashboardV3Rendered event");
    cleanupOnce();
  });
})();


/* ==== END static/js/vsp_dashboard_top_module_dom_v1.js ==== */
;