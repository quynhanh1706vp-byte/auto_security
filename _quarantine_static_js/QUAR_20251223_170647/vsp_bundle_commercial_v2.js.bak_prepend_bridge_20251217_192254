
/* VSP_BUNDLE_COMMERCIAL_V2 (rebuilt) */
(function(){
  'use strict';
  try{ window.__VSP_BUNDLE_COMMERCIAL_V2 = true; }catch(_){}
  // safe drilldown + legacy symbols
  if (typeof window.VSP_DRILLDOWN !== "function") {
    window.VSP_DRILLDOWN = function(intent){
      try{
        try{ localStorage.setItem("vsp_last_drilldown_intent_v1", JSON.stringify(intent||{})); }catch(_){}
        try{ if (location && typeof location.hash==="string" && !location.hash.includes("datasource")) location.hash="#datasource"; }catch(_){}
        return true;
      }catch(e){ return false; }
    };
  }
  try{
    var dd = function(intent){ return window.VSP_DRILLDOWN(intent); };
    window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 = dd;
    window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V1 = dd;
    window.VSP_DASH_DRILLDOWN_ARTIFACTS = dd;
  }catch(_){}
})();

/* build_ts: 2025-12-17T18:17:26.085737 */


/* ==== BEGIN: static/js/vsp_tabs_hash_router_v1.js ==== */
(function(){
'use strict';
/* VSP_ROUTER_BUNDLE_GUARD_P0_V1 */
/* injected_at: 2025-12-17T16:53:25.900786 */
(function(){
  try{ if (window && window.__VSP_BUNDLE_COMMERCIAL_V1) {
    console.log('[VSP_TABS_ROUTER] commercial bundle present -> skip standalone router');
    return;
  }}catch(_){ }
})();

(function () {
  console.log('[VSP_TABS_ROUTER_V1] clean router + header bind loaded');

  const DEFAULT_TAB = 'dashboard';

  function $(id) {
    return document.getElementById(id);
  }

  function fmtInt(n) {
    if (n == null || isNaN(n)) return '--';
    return Number(n).toLocaleString('en-US');
  }

  function fmtDate(s) {
    if (!s) return '--';
    try {
      const d = new Date(s);
      if (isNaN(d.getTime())) return String(s);
      return d.toLocaleString();
    } catch (e) {
      return String(s);
    }
  }

  // ====== PANE SETUP ======
  const PANES = {
    dashboard: 'vsp-dashboard-main',
    runs:      'vsp-runs-main',
    datasource:'vsp-datasource-main',
    settings:  'vsp-settings-main',
    rules:     'panel-rules',
  };

  function ensureExtraPanes() {
    const dash = $(PANES.dashboard);
    if (!dash) {
      console.warn('[VSP_TABS_ROUTER_V1] Không thấy #' + PANES.dashboard + ' – chỉ dùng được dashboard.');
      return;
    }
    const parent = dash.parentNode;
    const baseStyle = dash.getAttribute('style') || '';

    function ensurePane(key) {
      const id = PANES[key];
      if (!$(id)) {
        const div = document.createElement('div');
        div.id = id;
        div.setAttribute('style', baseStyle);
        div.style.display = 'none';
        parent.appendChild(div);
        console.log('[VSP_TABS_ROUTER_V1] Created pane #' + id);
      }
    }

    ensurePane('runs');
    ensurePane('datasource');
    ensurePane('settings');
    ensurePane('rules');
  }

  // ====== HEADER TABS BIND ======

  function getTabNameFromButton(btn) {
    if (!btn) return '';

    let tab =
      btn.getAttribute('data-vsp-tab') ||
      btn.getAttribute('data-tab') ||
      (btn.dataset && (btn.dataset.vspTab || btn.dataset.tab)) ||
      '';

    if (!tab) {
      const href = btn.getAttribute('href');
      if (href && href.indexOf('#') === 0) {
        tab = href.slice(1);
      }
    }

    tab = (tab || '').trim();

    // Map một số tên thường gặp về chuẩn
    if (tab === 'home') tab = 'dashboard';
    if (tab === 'runs-report' || tab === 'runs_reports') tab = 'runs';
    if (tab === 'data') tab = 'datasource';

    return tab;
  }

  function updateActiveHeader(tab) {
    const buttons = document.querySelectorAll(
      '[data-vsp-tab], [data-tab], .vsp-tab-button, .vsp-tab-btn'
    );
    buttons.forEach(function (btn) {
      const t = getTabNameFromButton(btn);
      if (!t) return;
      if (t === tab) {
        btn.classList.add('vsp-tab-active');
      } else {
        btn.classList.remove('vsp-tab-active');
      }
    });
  }

  function bindHeaderTabs() {
    const buttons = document.querySelectorAll(
      '[data-vsp-tab], [data-tab], .vsp-tab-button, .vsp-tab-btn'
    );
    if (!buttons.length) {
      console.warn('[VSP_TABS_ROUTER_V1] Không tìm thấy header tab buttons để bind.');
      return;
    }
    let bound = 0;
    buttons.forEach(function (btn) {
      const tab = getTabNameFromButton(btn);
      if (!tab) return;

      btn.addEventListener('click', function (ev) {
        // Nếu là <a href="#..."> thì chặn default để khỏi nhảy lên đầu trang
        if (ev && typeof ev.preventDefault === 'function') {
          ev.preventDefault();
        }
        console.log('[VSP_TABS_ROUTER_V1] tab click ->', tab);
        window.location.hash = '#' + tab;
      });
      bound++;
    });
    console.log('[VSP_TABS_ROUTER_V1] Bound', bound, 'header tab buttons');
  }

  // ====== RENDER HELPERS ======

  async function fetchRuns(limit) {
    const url = `/api/vsp/runs_index_v3_fs?limit=${limit || 40}`;
    const res = await fetch(url);
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const data = await res.json();
    if (Array.isArray(data)) return data;
    if (Array.isArray(data.items)) return data.items;
    return [];
  }

  function renderRunsPane() {
    
    // === VSP_COMMERCIAL_RUNS_MASTER_GUARD_V1 ===
    if (window.VSP_COMMERCIAL_RUNS_MASTER) {
      console.log('[VSP_TABS_ROUTER_V1] commercial runs master enabled -> skip legacy runs hydrate');
      return;
    }
    // === END VSP_COMMERCIAL_RUNS_MASTER_GUARD_V1 ===
const pane = $(PANES.runs);
    if (!pane) return;
    pane.innerHTML = `
      <div style="padding:16px; font-size:12px; opacity:0.7;">
        Đang tải danh sách runs từ <code>/api/vsp/runs_index_v3</code>...
      </div>
    `;
    fetchRuns(40).then(items => {
      if (!items || items.length === 0) {
        pane.innerHTML = `
          <div style="padding:16px; font-size:13px; opacity:0.7;">
            Không có run nào trong lịch sử (runs_index_v3 trả về rỗng).
          </div>
        `;
        return;
      }

      const rows = items.map(item => {
        const runId   = item.run_id || item.id || '--';
        const runType = item.run_type || item.type || 'FULL_EXT';
        const created = item.started_at || item.created_at || item.created || '';
        const total   = item.total_findings != null ? item.total_findings : (item.total || 0);
        const status  = item.status || item.result || 'DONE';

        return `
          <tr style="border-bottom:1px solid rgba(148,163,184,0.2);">
            <td style="padding:8px 10px; font-size:12px; white-space:nowrap;">
              <code style="font-size:11px; opacity:0.9;">${runId}</code>
            </td>
            <td style="padding:8px 10px; font-size:12px; text-transform:uppercase; opacity:0.8;">
              ${runType}
            </td>
            <td style="padding:8px 10px; font-size:12px;">
              ${fmtDate(created)}
            </td>
            <td style="padding:8px 10px; font-size:12px; text-align:right;">
              ${fmtInt(total)}
            </td>
            <td style="padding:8px 10px; font-size:12px;">
              <span style="
                display:inline-block;
                padding:2px 8px;
                border-radius:999px;
                font-size:11px;
                text-transform:uppercase;
                letter-spacing:0.05em;
                background:rgba(34,197,94,0.12);
                border:1px solid rgba(34,197,94,0.5);
                color:#bbf7d0;
              ">
                ${status}
              </span>
            </td>
          </tr>
        `;
      }).join('');

      pane.innerHTML = `
        <div style="padding:16px 16px 8px 16px;">
          <div style="font-size:12px; text-transform:uppercase; letter-spacing:0.08em; opacity:0.7; margin-bottom:4px;">
            Runs &amp; Reports
          </div>
          <div style="font-size:12px; opacity:0.7; margin-bottom:12px;">
            Lịch sử scan mới nhất từ SECURITY_BUNDLE (runs_index_v3)
          </div>
        </div>
        <div style="padding:0 16px 16px 16px;">
          <div style="overflow:auto; border-radius:10px; border:1px solid rgba(148,163,184,0.25); background:rgba(15,23,42,0.95);">
            <table style="width:100%; border-collapse:collapse; font-family:system-ui, -apple-system, BlinkMacSystemFont, 'Inter', sans-serif; color:#e5e7eb;">
              <thead>
                <tr style="background:rgba(15,23,42,0.98);">
                  <th style="padding:8px 10px; font-size:11px; text-align:left; opacity:0.7; text-transform:uppercase;">Run ID</th>
                  <th style="padding:8px 10px; font-size:11px; text-align:left; opacity:0.7; text-transform:uppercase;">Type</th>
                  <th style="padding:8px 10px; font-size:11px; text-align:left; opacity:0.7; text-transform:uppercase;">Started</th>
                  <th style="padding:8px 10px; font-size:11px; text-align:right; opacity:0.7; text-transform:uppercase;">Total Findings</th>
                  <th style="padding:8px 10px; font-size:11px; text-align:left; opacity:0.7; text-transform:uppercase;">Status</th>
                </tr>
              </thead>
              <tbody>
                ${rows}
              </tbody>
            </table>
          </div>
        </div>
      `;
      console.log('[VSP_TABS_ROUTER_V1] Runs pane hydrated với', items.length, 'items');
    }).catch(e => {
      console.error('[VSP_TABS_ROUTER_V1] Lỗi khi load runs_index_v3', e);
      pane.innerHTML = `
        <div style="padding:16px; font-size:12px; color:#fecaca;">
          Lỗi khi tải runs_index_v3: ${e}
        </div>
      `;
    });
  }

  async function fetchDatasource(limit) {
    const url = `/api/vsp/datasource_v2?limit=${limit || 500}`;
    const res = await fetch(url);
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const data = await res.json();
    if (Array.isArray(data)) return data;
    if (Array.isArray(data.items)) return data.items;
    return [];
  }

  function renderDatasourcePane() {
    const pane = $(PANES.datasource);
    if (!pane) return;
    pane.innerHTML = `
      <div style="padding:16px; font-size:12px; opacity:0.7;">
        Đang tải findings từ <code>/api/vsp/datasource_v2</code>...
      </div>
    `;
    fetchDatasource(500).then(items => {
      if (!items || items.length === 0) {
        pane.innerHTML = `
          <div style="padding:16px; font-size:13px; opacity:0.7;">
            Không có finding nào (datasource_v2 rỗng).
          </div>
        `;
        return;
      }

      const rows = items.slice(0, 300).map((f, idx) => {
        const tool  = f.tool  || f.source || '--';
        const sev   = f.severity || f.level || 'INFO';
        const rule  = f.rule_id || f.check_id || f.rule || '--';
        const file  = f.file || f.path || '--';
        const line  = f.line || f.start_line || f.end_line || '';
        return `
          <tr style="border-bottom:1px solid rgba(148,163,184,0.15);">
            <td style="padding:6px 8px; font-size:11px; opacity:0.7;">${idx + 1}</td>
            <td style="padding:6px 8px; font-size:11px;">${sev}</td>
            <td style="padding:6px 8px; font-size:11px;">${tool}</td>
            <td style="padding:6px 8px; font-size:11px;">${rule}</td>
            <td style="padding:6px 8px; font-size:11px;">${file}</td>
            <td style="padding:6px 8px; font-size:11px; text-align:right;">${line}</td>
          </tr>
        `;
      }).join('');

      pane.innerHTML = `
        <div style="padding:16px 16px 8px 16px;">
          <div style="font-size:12px; text-transform:uppercase; letter-spacing:0.08em; opacity:0.7; margin-bottom:4px;">
            Data Source
          </div>
          <div style="font-size:12px; opacity:0.7; margin-bottom:12px;">
            Bảng unified findings (tối đa 300 dòng, từ datasource_v2)
          </div>
        </div>
        <div style="padding:0 16px 16px 16px;">
          <div style="overflow:auto; border-radius:10px; border:1px solid rgba(148,163,184,0.25); background:rgba(15,23,42,0.95);">
            <table style="width:100%; border-collapse:collapse; font-family:system-ui, -apple-system, BlinkMacSystemFont, 'Inter', sans-serif; color:#e5e7eb;">
              <thead>
                <tr style="background:rgba(15,23,42,0.98);">
                  <th style="padding:6px 8px; font-size:11px; text-align:left; opacity:0.7;">#</th>
                  <th style="padding:6px 8px; font-size:11px; text-align:left; opacity:0.7;">Sev</th>
                  <th style="padding:6px 8px; font-size:11px; text-align:left; opacity:0.7;">Tool</th>
                  <th style="padding:6px 8px; font-size:11px; text-align:left; opacity:0.7;">Rule</th>
                  <th style="padding:6px 8px; font-size:11px; text-align:left; opacity:0.7;">File</th>
                  <th style="padding:6px 8px; font-size:11px; text-align:right; opacity:0.7;">Line</th>
                </tr>
              </thead>
              <tbody>
                ${rows}
              </tbody>
            </table>
          </div>
        </div>
      `;
      console.log('[VSP_TABS_ROUTER_V1] Datasource pane hydrated với', items.length, 'items');
  if (window.vspInitDatasourceTab) {
    try { window.vspInitDatasourceTab(); }
    catch (e) {
      console.error('[VSP_TABS_ROUTER_V1] vspInitDatasourceTab error:', e);
    }
  }
    }).catch(e => {
      console.error('[VSP_TABS_ROUTER_V1] Lỗi khi load datasource_v2', e);
      pane.innerHTML = `
        <div style="padding:16px; font-size:12px; color:#fecaca;">
          Lỗi khi tải datasource_v2: ${e}
        </div>
      `;
    });
  }

  async function fetchJson(url) {
    const res = await fetch(url);
    if (!res.ok) throw new Error('HTTP ' + res.status);
    return await res.json();
  }

  function renderSettingsPane() {
    const pane = $(PANES.settings);
    if (!pane) return;
    pane.innerHTML = `
      <div style="padding:16px; font-size:12px; opacity:0.7;">
        Đang tải settings từ <code>/api/vsp/settings_ui_v1</code>...
      </div>
    `;
    fetchJson('/api/vsp/settings_ui_v1').then(data => {
      const pretty = JSON.stringify(data, null, 2);
      pane.innerHTML = `
        <div style="padding:16px 16px 8px 16px;">
          <div style="font-size:12px; text-transform:uppercase; letter-spacing:0.08em; opacity:0.7; margin-bottom:4px;">
            Settings
          </div>
          <div style="font-size:12px; opacity:0.7; margin-bottom:12px;">
            Cấu hình SECURITY_BUNDLE (settings_ui_v1)
          </div>
        </div>
        <div style="padding:0 16px 16px 16px;">
          <pre style="
            margin:0;
            padding:16px;
            border-radius:10px;
            border:1px solid rgba(148,163,184,0.25);
            background:rgba(15,23,42,0.96);
            font-size:11px;
            line-height:1.4;
            overflow:auto;
            color:#e5e7eb;
          ">${pretty}</pre>
        </div>
      `;
      console.log('[VSP_TABS_ROUTER_V1] Settings pane hydrated');
    }).catch(e => {
      console.error('[VSP_TABS_ROUTER_V1] Lỗi khi load settings_ui_v1', e);
      pane.innerHTML = `
        <div style="padding:16px; font-size:12px; color:#fecaca;">
          Lỗi khi tải settings_ui_v1: ${e}
        </div>
      `;
    });
  }

  function renderRulesPane() {
    const pane = $(PANES.rules);
    if (!pane) return;
    pane.innerHTML = `
      <div style="padding:16px; font-size:12px; opacity:0.7;">
        Đang tải rule overrides từ <code>/api/vsp/rule_overrides_ui_v1</code>...
      </div>
    `;
    fetchJson('/api/vsp/rule_overrides_ui_v1').then(data => {
      const pretty = JSON.stringify(data, null, 2);
      pane.innerHTML = `
        <div style="padding:16px 16px 8px 16px;">
          <div style="font-size:12px; text-transform:uppercase; letter-spacing:0.08em; opacity:0.7; margin-bottom:4px;">
            Rule Overrides
          </div>
          <div style="font-size:12px; opacity:0.7; margin-bottom:12px;">
            Mapping / override rule (rule_overrides_ui_v1)
          </div>
        </div>
        <div style="padding:0 16px 16px 16px;">
          <pre style="
            margin:0;
            padding:16px;
            border-radius:10px;
            border:1px solid rgba(148,163,184,0.25);
            background:rgba(15,23,42,0.96);
            font-size:11px;
            line-height:1.4;
            overflow:auto;
            color:#e5e7eb;
          ">${pretty}</pre>
        </div>
      `;
      console.log('[VSP_TABS_ROUTER_V1] Rules pane hydrated');
    }).catch(e => {
      console.error('[VSP_TABS_ROUTER_V1] Lỗi khi load rule_overrides_ui_v1', e);
      pane.innerHTML = `
        <div style="padding:16px; font-size:12px; color:#fecaca;">
          Lỗi khi tải rule_overrides_ui_v1: ${e}
        </div>
      `;
    });
  }

  // ====== ROUTER ======
  const hydrated = {
    runs: false,
    datasource: false,
    settings: false,
    rules: false,
  };

  function showTab(tab) {
    tab = tab || DEFAULT_TAB;
    console.log('[VSP_TABS_ROUTER_V1] handleHashChange ->', tab);

    Object.keys(PANES).forEach(key => {
      const el = $(PANES[key]);
      if (!el) return;
      el.style.display = (key === tab) ? '' : 'none';
    });

    updateActiveHeader(tab);

    if (tab === 'runs' && !hydrated.runs) {
      hydrated.runs = true;
      renderRunsPane();
    } else if (tab === 'datasource' && !hydrated.datasource) {
      hydrated.datasource = true;
      renderDatasourcePane();
    } else if (tab === 'settings' && !hydrated.settings) {
      hydrated.settings = true;
      renderSettingsPane();
    } else if (tab === 'rules' && !hydrated.rules) {
      hydrated.rules = true;
      renderRulesPane();
    }
  }

  function handleHashChange() {
    const raw = window.location.hash || '';
    const h = raw.replace('#', '') || DEFAULT_TAB;
    showTab(h);
  }

  function init() {
    ensureExtraPanes();
    bindHeaderTabs();
    window.addEventListener('hashchange', handleHashChange);
    handleHashChange();
  }

  if (document.readyState === 'complete' || document.readyState === 'interactive') {
    init();
  } else {
    document.addEventListener('DOMContentLoaded', init);
  }
})();

// === VSP_P2_NORMALIZE_TAB_HASH_V1 ===
(function(){
  try{
    var h = String(window.location.hash || "");
    var m = h.match(/^#tab=([a-z0-9_-]+)(.*)$/i);
    if(m){
      var tab = m[1];
      var rest = m[2] || "";
      window.location.hash = "#" + tab + rest;
    }
  }catch(e){}
})();

// ROUTE_RULES_V1: enabled 'rules' route


/* VSP_ROUTER_THROTTLE_P1_V1_BEGIN */
(function(){
  'use strict';

/* __VSP_DD_SAFE_CALL__ (P0 final): call handler as function OR {open: fn} */
(function(){
  'use strict';
  if (window.__VSP_DD_SAFE_CALL__) return;
  window.__VSP_DD_SAFE_CALL__ = function(handler){
    try{
      var args = Array.prototype.slice.call(arguments, 1);
      if (typeof handler === 'function') return handler.apply(null, args);
      if (handler && typeof handler.open === 'function') return handler.open.apply(handler, args);
    }catch(e){
      try{ console.warn('[VSP][DD_SAFE_CALL]', e); }catch(_){}
    }
    return null;
  };
})();


  if (window.__VSP_ROUTER_THROTTLE_P1_V1) return;
  window.__VSP_ROUTER_THROTTLE_P1_V1 = true;

  const W = window;
  const orig = W.handleHashChange || W.__vspHandleHashChange || null;

  // If file defines handleHashChange in local scope only, fallback: patch hashchange listener to throttle.
  let last = {h:"", t:0};
  function shouldSkip(){
    const h = String(location.hash || "");
    const now = Date.now();
    if (h === last.h && (now - last.t) < 600) return true;
    last = {h, t: now};
    return false;
  }

  // If global handleHashChange exists, wrap it
  if (typeof orig === "function"){
    W.__vspHandleHashChange = orig;
    W.handleHashChange = function(){
      if (shouldSkip()) return;
      return orig.apply(this, arguments);
    };
    console.log("[VSP_ROUTER_THROTTLE_P1_V1] wrapped global handleHashChange");
    return;
  }

  // Otherwise, add throttled listener (does not remove existing; only prevents rapid duplicates)
  W.addEventListener("hashchange", function(ev){
    if (shouldSkip()) return;
  }, true);

  console.log("[VSP_ROUTER_THROTTLE_P1_V1] installed hashchange throttle (capture)");
})();
/* VSP_ROUTER_THROTTLE_P1_V1_END */


})();
/* ==== END: static/js/vsp_tabs_hash_router_v1.js ==== */

/* ==== BEGIN: static/js/vsp_dashboard_enhance_p0_clean_v1.js ==== */
(function(){
'use strict';
// VSP_SAFE_DRILLDOWN_HARDEN_P0_V6
/* VSP_DASHBOARD_ENHANCE_P0_CLEAN_V1
 * P0 goal: NO red console errors, no drilldown symbol usage, safe degrade.
 */
(function(){
  'use strict';

  





/* VSP_FIX_DRILLDOWN_CALLSITE_P0_V5: safe-call drilldown artifacts (function OR object.open) */
function __VSP_DD_ART_CALL__(h, ...args) {
  try {
    if (typeof h === 'function') return h(...args);
    if (h && typeof h.open === 'function') return h.open(...args);
  } catch(e) { try{console.warn('[VSP][DD_SAFE]', e);}catch(_e){} }
  return null;
}

/* VSP_FIX_DRILLDOWN_CALLSITE_P0_V3: safe-call for drilldown artifacts (function OR object.open) */
function __VSP_DD_ART_CALL__(h, ...args) {
  try {
    if (typeof h === 'function') return h(...args);
    if (h && typeof h.open === 'function') return h.open(...args);
  } catch (e) {
    try { console.warn('[VSP][DD_SAFE] call failed', e); } catch (_e) {}
  }
  return null;
}

/* VSP_FIX_DRILLDOWN_ARTIFACTS_NOT_FUNCTION_P0_V2
 * Fix: TypeError __VSP_DD_ART_CALL__(VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2, ...) is not a function
 * Normalize BEFORE first use:
 *   - if function: keep
 *   - if object with .open(): wrap as function(arg)->obj.open(arg)
 *   - else: no-op (never throw)
 */
(function(){
  'use strict';
  if (window.__VSP_FIX_DRILLDOWN_ARTIFACTS_NOT_FUNCTION_P0_V2) return;
  window.__VSP_FIX_DRILLDOWN_ARTIFACTS_NOT_FUNCTION_P0_V2 = 1;

  function normalize(v){
    if (typeof v === 'function') return v;
    if (v && typeof v.open === 'function') {
      const obj = v;
      const fn = function(arg){ try { return obj.open(arg); } catch(e){ console.warn('[VSP][DD_FIX] open() failed', e); return null; } };
      fn.__wrapped_from_object = true;
      return fn;
    }
    const noop = function(_arg){ return null; };
    noop.__noop = true;
    return noop;
  }

  try {
    // trap future assignments
    let _val = window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2;
    Object.defineProperty(window, 'VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2', {
      configurable: true, enumerable: true,
      get: function(){ return _val; },
      set: function(v){ _val = normalize(v); }
    });
    window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 = _val;
  } catch(e) {
    window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 = normalize(window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2);
  }
})();

const TAG = '[VSP_DASH_P0_CLEAN]';

  function $(sel, root){ try{ return (root||document).querySelector(sel); }catch(_){ return null; } }
  function $all(sel, root){ try{ return Array.from((root||document).querySelectorAll(sel)); }catch(_){ return []; } }

  async function fetchJSON(url, opts){
    try{
      const r = await fetch(url, Object.assign({cache:'no-store'}, opts||{}));
      if(!r.ok) throw new Error('HTTP '+r.status);
      return await r.json();
    }catch(e){
      console.warn(TAG, 'fetch failed', url, e);
      return null;
    }
  }

  function setText(id, txt){
    const el = document.getElementById(id);
    if(!el) return;
    el.textContent = (txt==null?'':String(txt));
  }

  function safeInit(){
    // Do NOT reference VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 at all.
    // Only do harmless hydration.
    console.log(TAG, 'loaded');

    // 1) Try read dashboard data (best effort)
    fetchJSON('/api/vsp/dashboard_v3').then(d=>{
      if(!d){ return; }
      try{
        // If your template has any of these ids, fill them. If not, no-op.
        if (d.by_severity && typeof d.by_severity === 'object'){
          setText('kpi-total', d.by_severity.TOTAL ?? d.total ?? '');
          setText('kpi-critical', d.by_severity.CRITICAL ?? '');
          setText('kpi-high', d.by_severity.HIGH ?? '');
          setText('kpi-medium', d.by_severity.MEDIUM ?? '');
          setText('kpi-low', d.by_severity.LOW ?? '');
          setText('kpi-info', d.by_severity.INFO ?? '');
          setText('kpi-trace', d.by_severity.TRACE ?? '');
        }
      }catch(e){
        console.warn(TAG, 'render kpi failed', e);
      }
    });

    // 2) Gate: keep whatever other modules do; we just avoid crashing.
    // If you want, we can add canonical gate wiring later.

    // 3) Charts: do nothing here. Avoid bootstrap retry spam.
  }

  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', safeInit, {once:true});
  }else{
    safeInit();
  }
})();

})();
/* ==== END: static/js/vsp_dashboard_enhance_p0_clean_v1.js ==== */

/* ==== BEGIN: static/js/vsp_dashboard_enhance_v1.js ==== */
(function(){
'use strict';
// VSP_SAFE_DRILLDOWN_HARDEN_P0_V6
/* P0_DRILLDOWN_NUKE_V8 */

/* __VSP_DD_HANDLER_WRAP_P0_FINAL: normalize VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 to callable */
(function(){
  'use strict';

/* VSP_DD_ART_CALL_V1: commercial stable wrapper (fn OR {open:fn}) */
(function(){
  'use strict';
  if (window.VSP_DD_ART_CALL_V1) return;
  window.VSP_DD_ART_CALL_V1 = function(){
    var h = window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2;
    var args = Array.prototype.slice.call(arguments);
    try{
      if (typeof h === 'function') return h.apply(null, args);
      if (h && typeof h.open === 'function') return h.open.apply(h, args);
    }catch(e){
      try{ console.warn('[VSP][DD_CALL_V1]', e); }catch(_){}
    }
    return null;
  };
})();


  try{
    var h = window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2;
    if (h && typeof h !== 'function'){
      window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 = function(){
        return (window.__VSP_DD_SAFE_CALL__ || function(x){
          try{
            var a=[].slice.call(arguments,1);
            if (typeof x==='function') return x.apply(null,a);
            if (x && typeof x.open==='function') return x.open.apply(x,a);
          }catch(_){}
          return null;
        }).apply(null, [h].concat([].slice.call(arguments)));
      };
      try{ console.log('[VSP][P0] drilldown handler wrapped (obj->fn)'); }catch(_){}
    }
  }catch(e){}
})();

(function(){
  try{
    if (typeof window === "undefined") return;


/* VSP_FIX_DRILLDOWN_ARTIFACTS_NOT_FUNCTION_P0_V2
 * Fix: TypeError __VSP_DD_ART_CALL__(VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2, ...) is not a function
 * Normalize BEFORE first use:
 *   - if function: keep
 *   - if object with .open(): wrap as function(arg)->obj.open(arg)
 *   - else: no-op (never throw)
 */
(function(){
  'use strict';
  



/* VSP_FIX_DRILLDOWN_CALLSITE_P0_V5: safe-call drilldown artifacts (function OR object.open) */
function __VSP_DD_ART_CALL__(h, ...args) {
  try {
    if (typeof h === 'function') return h(...args);
    if (h && typeof h.open === 'function') return h.open(...args);
  } catch(e) { try{console.warn('[VSP][DD_SAFE]', e);}catch(_e){} }
  return null;
}

/* VSP_FIX_DRILLDOWN_CALLSITE_P0_V3: safe-call for drilldown artifacts (function OR object.open) */
function __VSP_DD_ART_CALL__(h, ...args) {
  try {
    if (typeof h === 'function') return h(...args);
    if (h && typeof h.open === 'function') return h.open(...args);
  } catch (e) {
    try { console.warn('[VSP][DD_SAFE] call failed', e); } catch (_e) {}
  }
  return null;
}

if (window.__VSP_FIX_DRILLDOWN_ARTIFACTS_NOT_FUNCTION_P0_V2) return;
  window.__VSP_FIX_DRILLDOWN_ARTIFACTS_NOT_FUNCTION_P0_V2 = 1;

  function normalize(v){
    if (typeof v === 'function') return v;
    if (v && typeof v.open === 'function') {
      const obj = v;
      const fn = function(arg){ try { return obj.open(arg); } catch(e){ console.warn('[VSP][DD_FIX] open() failed', e); return null; } };
      fn.__wrapped_from_object = true;
      return fn;
    }
    const noop = function(_arg){ return null; };
    noop.__noop = true;
    return noop;
  }

  try {
    // trap future assignments
    let _val = window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2;
    Object.defineProperty(window, 'VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2', {
      configurable: true, enumerable: true,
      get: function(){ return _val; },
      set: function(v){ _val = normalize(v); }
    });
    window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 = _val;
  } catch(e) {
    window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 = normalize(window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2);
  }
})();

    if (typeof window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 !== "function") {
      window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 = function(){
        try{ console.info("[VSP][P0] drilldown window stub called"); }catch(_){}
        return {open(){},show(){},close(){},destroy(){}};
      };
    }
  }catch(_){}
})();

/* P0_DRILLDOWN_STUB_V6 */
(function(){
  try{
    if (typeof window === "undefined") return;
    if (typeof window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 !== "function") {
      window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 = function(){
        try{ console.info("[VSP_DASH][P0] drilldown window stub called"); }catch(_){}
        return {open(){},show(){},close(){},destroy(){}};
      };
    }
  }catch(_){}
})();

/* P0_DRILLDOWN_CALL_V3 */
(function(){
  try{
    if (typeof window === "undefined") return;

    // Stub always returns an object with safe methods
    window.__VSP_P0_DRILLDOWN_STUB = window.__VSP_P0_DRILLDOWN_STUB || function(){
      try{ console.info("[VSP_DASH][P0] drilldown stub called"); }catch(_){}
      return { open(){}, show(){}, close(){}, destroy(){} };
    };

    // Ensure window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 is callable
    if (typeof window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 !== "function") {
      window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 = window.__VSP_P0_DRILLDOWN_STUB;
      try{ console.info("[VSP_DASH][P0] drilldown forced stub (window)"); }catch(_){}
    }

    // Stable call entry (never throws)
    window.__VSP_P0_DRILLDOWN_CALL = window.__VSP_P0_DRILLDOWN_CALL || function(){
      try{
        const fn = window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2;
        if (typeof fn === "function") return fn.apply(window, arguments);
      }catch(_){}
      try{
        return window.__VSP_P0_DRILLDOWN_STUB.apply(window, arguments);
      }catch(_){}
      return { open(){}, show(){}, close(){}, destroy(){} };
    };
  }catch(_){}
})();

/* VSP_P0_DRILLDOWN_CALL_V2: prevent red console when drilldown is missing */
(function(){
  try{
    if (typeof window === "undefined") return;

    // ensure window function exists early (before any local capture)
    if (typeof window.__VSP_P0_DRILLDOWN_STUB !== "function") {
      window.__VSP_P0_DRILLDOWN_STUB = function(){
        try{ console.info("[VSP_DASH][P0] drilldown stub called"); }catch(_){}
        return { open(){}, show(){}, close(){}, destroy(){} };
      };
    }
    if (typeof window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 !== "function") {
      window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 = window.__VSP_P0_DRILLDOWN_STUB;
      try{ console.info("[VSP_DASH][P0] drilldown forced stub (window)"); }catch(_){}
    }

    // stable caller: always a function
    if (typeof window.__VSP_P0_DRILLDOWN_CALL_V2 !== "function") {
      window.__VSP_P0_DRILLDOWN_CALL_V2 = function(){
        try{
          var fn = window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2;
          if (typeof fn === "function") return fn.apply(window, arguments);
        }catch(_){}
        try{
          var stub = window.__VSP_P0_DRILLDOWN_STUB;
          if (typeof stub === "function") return stub.apply(window, arguments);
        }catch(_){}
        return { open(){}, show(){}, close(){}, destroy(){} };
      };
    }
  }catch(_){}
})();

/* P0_GUARD_GLOBAL_V1 */
// Define global guard so any callsite can see it (prevents ReferenceError)
(function(){
  try{
    if (typeof window === "undefined") return;

    window.VSP_DASH_IS_ACTIVE_P0 = window.VSP_DASH_IS_ACTIVE_P0 || function(){
      try{
        const h = (location.hash || "").toLowerCase();
        if (!h || h === "#" || h === "#dashboard") return true;
        return false;
      }catch(_){ return false; }
    };

    window.VSP_DASH_P0_GUARD = window.VSP_DASH_P0_GUARD || function(reason){
      try{
        if (!window.VSP_DASH_IS_ACTIVE_P0()){
          try{ console.info("[VSP_DASH][P0] skip:", reason, "hash=", location.hash); }catch(_){}
          return false;
        }
        return true;
      }catch(_){ return true; }
    };

    // Also provide plain global function names (some code calls them directly)
    if (typeof window.VSP_DASH_P0_GUARD === "function") {
      window.VSP_DASH_P0_GUARD_NAME = "ok";
    }
  }catch(_){}
})();

// Plain-name wrappers (avoid ReferenceError even if code calls VSP_DASH_P0_GUARD directly)
function VSP_DASH_IS_ACTIVE_P0(){ try{ return (window && window.VSP_DASH_IS_ACTIVE_P0) ? window.VSP_DASH_IS_ACTIVE_P0() : true; }catch(_){ return true; } }
function VSP_DASH_P0_GUARD(reason){ try{ return (window && window.VSP_DASH_P0_GUARD) ? window.VSP_DASH_P0_GUARD(reason) : true; }catch(_){ return true; } }

// === VSP_CHARTS_ENGINE_SHIM_V1 ===
(function(){
  // Always provide a safe resolver so dashboard never crashes on missing symbol names.
  function _findChartsEngineShim(){
    return (
      window.VSP_CHARTS_ENGINE_V3 ||
      window.VSP_CHARTS_V3 ||
      window.VSP_CHARTS_PRETTY_V3 ||
      window.VSP_DASH_CHARTS_V3 ||
      window.VSP_CHARTS_ENGINE_V2 ||
      window.VSP_CHARTS_V2 ||
      window.VSP_CHARTS_ENGINE ||
      window.VSP_CHARTS ||
      null
    );
  }
  if (typeof window.findChartsEngine !== 'function') {
    window.findChartsEngine = _findChartsEngineShim;
  }
})();

// === VSP_FIND_CHARTS_ENGINE_FALLBACK_V1 ===
if (typeof window.findChartsEngine !== 'function') {
  window.findChartsEngine = function () {
    try {
      // Prefer explicit exported engines
      if (window.VSP_DASH_CHARTS_ENGINE) return window.VSP_DASH_CHARTS_ENGINE;
      if (window.VSP_DASH_CHARTS_V3) return window.VSP_DASH_CHARTS_V3;
      if (window.VSP_DASH_CHARTS_V2) return window.VSP_DASH_CHARTS_V2;

      // Heuristic: look for known globals from pretty charts scripts
      var cand = [
        window.vsp_dashboard_charts_v3,
        window.vsp_dashboard_charts_v2,
        window.VSP_CHARTS_V3,
        window.VSP_CHARTS_V2
      ].filter(Boolean)[0];

      return cand || null;
    } catch (e) { return null; }
  };
}
// === END VSP_FIND_CHARTS_ENGINE_FALLBACK_V1 ===
(function () {
  // VSP 2025 – Dashboard enhance V4 (clean, no patch lỗi)
  console.log('[VSP_DASH] vsp_dashboard_enhance_v1.js (V4 clean) loaded');

  function onReady(fn) {
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', fn);
    } else {
      fn();
    }
  }

  function safeText(id, value) {
    var el = document.getElementById(id);
    if (!el) return;
    el.textContent = value;
  }

  function fetchDashboard() {
    return fetch('/api/vsp/dashboard_v3', {
      credentials: 'same-origin'
    }).then(function (r) {
      if (!r.ok) throw new Error('HTTP ' + r.status);
      return r.json();
    });
  }

  function fillKpis(data) {
    if (!data || typeof data !== 'object') return;
    var bySeverity = data.by_severity || {};
    var total = data.total_findings != null
      ? data.total_findings
      : (bySeverity.CRITICAL || 0) + (bySeverity.HIGH || 0) +
        (bySeverity.MEDIUM || 0) + (bySeverity.LOW || 0) +
        (bySeverity.INFO || 0) + (bySeverity.TRACE || 0);

    safeText('vsp-kpi-total-findings', total);
    safeText('vsp-kpi-critical', bySeverity.CRITICAL != null ? bySeverity.CRITICAL : 0);
    safeText('vsp-kpi-high',     bySeverity.HIGH     != null ? bySeverity.HIGH     : 0);
    safeText('vsp-kpi-medium',   bySeverity.MEDIUM   != null ? bySeverity.MEDIUM   : 0);
    safeText('vsp-kpi-low',      bySeverity.LOW      != null ? bySeverity.LOW      : 0);
    safeText('vsp-kpi-info',     bySeverity.INFO     != null ? bySeverity.INFO     : 0);
    safeText('vsp-kpi-trace',    bySeverity.TRACE    != null ? bySeverity.TRACE    : 0);

    if (data.security_posture_score != null) {
      safeText('vsp-kpi-security-score', data.security_posture_score);
    }

    safeText('vsp-kpi-top-tool',   data.top_risky_tool       || 'N/A');
    safeText('vsp-kpi-top-cwe',    data.top_impacted_cwe     || data.top_cwe || 'N/A');
    safeText('vsp-kpi-top-module', data.top_vulnerable_module || 'N/A');

    var gate = data.ci_gate_status || data.ci_gate || {};
    var gateLabel = gate.label || gate.status || 'N/A';
    var gateDesc  = gate.description || 'Gate dựa trên CRITICAL/HIGH, score & coverage.';
    safeText('vsp-kpi-ci-gate-status',      gateLabel);
    safeText('vsp-kpi-ci-gate-status-desc', gateDesc);
  }

  function hydrateDashboard(data) {
    try {
      fillKpis(data);

      if (window.VSP_CHARTS_V3 && typeof window.VSP_CHARTS_V3.updateFromDashboard === 'function') {
        window.VSP_CHARTS_V3.updateFromDashboard(data);
      } else if (window.VSP_CHARTS_V2 && typeof window.VSP_CHARTS_V2.updateFromDashboard === 'function') {
        window.VSP_CHARTS_V2.updateFromDashboard(data);
      } else {
        console.debug('[VSP_DASH] No charts engine V2/V3 found – only KPIs filled. (will retry)');
      }

      console.log('[VSP_DASH] Dashboard hydrated OK (V4 clean).');
    } catch (e) {
      console.error('[VSP_DASH] Error hydrating dashboard:', e);
    }
  }

  window.hydrateDashboard = hydrateDashboard;

  onReady(function () {
    var pane = document.getElementById('vsp-dashboard-main');
    if (!pane) {
      console.log('[VSP_DASH] No dashboard pane found, skip auto fetch.');
      return;
    }
    console.log('[VSP_DASH] Hydrating dashboard (auto fetch)…');
  if (!VSP_DASH_P0_GUARD("hydrate")) { return; }
    fetchDashboard()
      .then(function (data) {
        console.log('[VSP_DASH] dashboard_v3 data =', data);
        hydrateDashboard(data);
      })
      .catch(function (err) {
        console.error('[VSP_DASH] Failed to load /api/vsp/dashboard_v3:', err);
      });
  });

})();


// === VSP_DASH_CHARTS_RETRY_V1 ===
(function(){
  try{
    let tries = 0;
    function tryHydrate(){
      tries++;
      const eng = window.VSP_CHARTS_V3 || window.VSP_CHARTS_PRETTY_V3 || window.VSP_CHARTS_ENGINE_V3;
      if (eng && typeof eng.hydrate === 'function' && window.__VSP_LAST_DASH_DATA__){
        eng.hydrate(window.__VSP_LAST_DASH_DATA__);
        console.log('[VSP_DASH] charts hydrated via retry');
        return;
      }
      if (tries < 8) setTimeout(tryHydrate, 300);
    }
    setTimeout(tryHydrate, 300);
  }catch(e){}
})();
// === END VSP_DASH_CHARTS_RETRY_V1 ===


// === VSP_DASH_CHARTS_RETRY_V2 ===
(function(){
  try{
    let tries = 0;
    function tick(){
      tries++;
      const eng = findChartsEngine();
      if (eng && window.__VSP_LAST_DASH_DATA__){
        try{
          eng.hydrate(window.__VSP_LAST_DASH_DATA__);
          console.log('[VSP_DASH] charts hydrated via retry v2');
          return;
        }catch(e){}
      }
      if (tries < 8) setTimeout(tick, 350);
    }
    setTimeout(tick, 350);
  }catch(e){}
})();
// === END VSP_DASH_CHARTS_RETRY_V2 ===


// === VSP_DASH_USE_DASH_V3_AND_INIT_CHARTS_V1 ===
(function(){
  try {
    if (window.__VSP_DASH_INIT_CHARTS_V1) return;
    window.__VSP_DASH_INIT_CHARTS_V1 = true;

    function _vspGetChartsEngine() {
      return window.VSP_CHARTS_ENGINE_V3 || window.VSP_CHARTS_ENGINE_V2 || null;
    }

    window.__VSP_DASH_TRY_INIT_CHARTS_V1 = function(dash, reason) {
      try {
        if (dash) window.__VSP_DASH_LAST_DATA_V3 = dash;
        var eng = _vspGetChartsEngine();
        if (!eng || !eng.initAll) return false;
        var d = dash || window.__VSP_DASH_LAST_DATA_V3;
        if (!d) return false;
        var ok = eng.initAll(d);
        console.log("[VSP_DASH] charts initAll via", reason || "unknown", "=>", ok);
        return !!ok;
      } catch (e) {
        console.warn("[VSP_DASH] charts init failed", e);
        return false;
      }
    };

    // Listen for charts-ready (late engine load)
    window.addEventListener("vsp:charts-ready", function(ev){
      setTimeout(function(){
        window.__VSP_DASH_TRY_INIT_CHARTS_V1(null, "charts-ready");
      }, 0);
    });
  } catch(e) {
    console.warn("[VSP_DASH] init-charts patch failed", e);
  }
})();

// === VSP_ENHANCE_WAIT_CHARTS_READY_V1 ===

(function(){
  try{
    if (window.__VSP_ENHANCE_WAIT_CHARTS_READY_V1) return;
    window.__VSP_ENHANCE_WAIT_CHARTS_READY_V1 = true;

    function pickEngine(){
      return window.VSP_CHARTS_ENGINE_V3 || window.VSP_CHARTS_ENGINE_V2 || window.VSP_CHARTS_ENGINE || null;
    }

    function tryInit(){
      var eng = pickEngine();
      var d = window.__VSP_DASH_LAST_DATA_V3 || window.__VSP_DASH_LAST_DATA || window.__VSP_DASH_LAST_DATA_ANY || null;
      if (!eng || !eng.initAll || !d) return false;
      try{
        eng.initAll(d);
        return true;
      }catch(e){
        return false;
      }
    }

    window.addEventListener('vsp:charts-ready', function(){
      // chỉ init khi đã có data (dashboard fetch xong)
      tryInit();
    });

    // nếu engine đã có sẵn thì thử init luôn (không warn)
    tryInit();
  }catch(e){}
})();



// === VSP_UI_KPI_DRILLDOWN_V1 ===
(function(){
  const KEY = "vsp_ds_drill_url_v1";

  async function loadDashLatest(){
    try{
      const r = await fetch("/api/vsp/dashboard_latest_v1", {credentials:"same-origin"});
      const j = await r.json();
      window.__VSP_DASH_LATEST_V1 = j;
      return j;
    }catch(e){
      console.warn("[KPI_DRILLDOWN] loadDashLatest failed", e);
      return null;
    }
  }

  function _setDrillUrl(url){
    try{ sessionStorage.setItem(KEY, url); }catch(e){}
  }

  function openDrill(url){
    if(!url) return;
    _setDrillUrl(url);

    // best-effort: switch tab by hash
    try{
      if(!String(location.hash||"").toLowerCase().includes("datasource")){
        location.hash = "#datasource";
        // kick router if it listens
        setTimeout(()=>{ try{ window.dispatchEvent(new Event("hashchange")); }catch(e){} }, 50);
      }
    }catch(e){}

    // if Data Source JS installed hook -> use it
    if(typeof window.VSP_DS_APPLY_DRILL_URL_V1 === "function"){
      try{ window.VSP_DS_APPLY_DRILL_URL_V1(url); return; }catch(e){}
    }

    // fallback: open API in new tab (always works)
    try{ window.open(url, "_blank"); }catch(e){}
  }

  function bindClicks(dash){
    if(!dash || !dash.links) return;

    const sevLinks = (dash.links.severity || {});
    const allUrl   = dash.links.all;

    const nodes = Array.from(document.querySelectorAll("a,button,div,section,article,span"))
      .filter(el=>{
        const txt = (el.innerText||"").trim();
        return txt && txt.length > 0 && txt.length < 160;
      });

    function attachByKeyword(keywordUpper, url, title){
      if(!url) return;
      for(const el of nodes){
        const txt = (el.innerText||"").toUpperCase();
        if(!txt.includes(keywordUpper)) continue;
        if(el.__vsp_drill_attached) continue;
        el.__vsp_drill_attached = true;
        el.style.cursor = "pointer";
        el.title = title;
        el.addEventListener("click", (ev)=>{
          // allow user open normally with ctrl/cmd
          if(ev && (ev.ctrlKey || ev.metaKey || ev.shiftKey)) return;
          try{ ev.preventDefault(); }catch(e){}
          openDrill(url);
        });
      }
    }

    // severity KPI cards (by keyword)
    ["CRITICAL","HIGH","MEDIUM","LOW","INFO","TRACE"].forEach(sev=>{
      attachByKeyword(sev, sevLinks[sev], `Drilldown → ${sev}`);
    });

    // total findings KPI (heuristic)
    if(allUrl){
      for(const el of nodes){
        const txt = (el.innerText||"").toUpperCase();
        const hit = (txt.includes("TOTAL") && (txt.includes("FIND") || txt.includes("FINDINGS"))) || txt.includes("TOTAL FINDINGS");
        if(!hit) continue;
        if(el.__vsp_drill_total) continue;
        el.__vsp_drill_total = true;
        el.style.cursor = "pointer";
        el.title = "Drilldown → ALL findings";
        el.addEventListener("click", (ev)=>{
          if(ev && (ev.ctrlKey || ev.metaKey || ev.shiftKey)) return;
          try{ ev.preventDefault(); }catch(e){}
          openDrill(allUrl);
        });
      }
    }

    // expose helper for manual use
    window.VSP_DASH_OPEN_DRILL_V1 = openDrill;
    console.log("[KPI_DRILLDOWN] bound", {rid: dash.rid, hasLinks: !!dash.links});
  }

  window.addEventListener("load", async ()=>{
    const dash = await loadDashLatest();
    // wait a bit so DOM cards exist
    setTimeout(()=>bindClicks(dash), 600);
  });
})();



// === VSP_UI_DRILL_PANEL_V1 ===
(function(){
  const KEY = "vsp_ds_drill_url_v1";

  function setDrillUrl(url){
    try{ sessionStorage.setItem(KEY, url); }catch(e){}
  }
  function gotoDatasource(){
    const h = String(location.hash||"");
    if(h.startsWith("#vsp4-")) location.hash = "#vsp4-datasource";
    else location.hash = "#datasource";
    try{ window.dispatchEvent(new Event("hashchange")); }catch(e){}
  }
  async function dashLatest(){
    const r = await fetch("/api/vsp/dashboard_latest_v1", {credentials:"same-origin"});
    return await r.json();
  }

  function ensurePanel(d){
    const id="vsp_drill_panel_v1";
    if(document.getElementById(id)) return;

    const wrap=document.createElement("div");
    wrap.id=id;
    wrap.style.position="fixed";
    wrap.style.right="18px";
    wrap.style.bottom="18px";
    wrap.style.zIndex="9999";
    wrap.style.padding="10px";
    wrap.style.borderRadius="14px";
    wrap.style.border="1px solid rgba(255,255,255,.10)";
    wrap.style.background="rgba(2,6,23,.78)";
    wrap.style.backdropFilter="blur(10px)";
    wrap.style.boxShadow="0 10px 30px rgba(0,0,0,.35)";
    wrap.style.fontSize="12px";
    wrap.style.color="rgba(255,255,255,.85)";
    wrap.innerHTML = `
      <div style="font-weight:700;margin-bottom:6px;">Drilldown</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        <button id="vsp_drill_total" style="padding:6px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);color:#fff;cursor:pointer;">TOTAL</button>
        <button id="vsp_drill_critical" style="padding:6px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);color:#fff;cursor:pointer;">CRITICAL</button>
        <button id="vsp_drill_high" style="padding:6px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);color:#fff;cursor:pointer;">HIGH</button>
      </div>
      <div style="opacity:.65;margin-top:6px;">(opens Data Source)</div>
    `;
    document.body.appendChild(wrap);

    const links = (d && d.links) ? d.links : {};
    const sev = (links.severity)||{};
    function bind(btnId, url){
      const b=document.getElementById(btnId);
      if(!b) return;
      b.onclick = ()=>{
        if(!url){ console.warn("[DRILL] missing url for", btnId); return; }
        setDrillUrl(url);
        gotoDatasource();
        if(typeof window.VSP_DS_APPLY_DRILL_URL_V1==="function"){
          try{ window.VSP_DS_APPLY_DRILL_URL_V1(url); }catch(e){}
        }
        console.log("[DRILL] open", url);
      };
    }
    bind("vsp_drill_total", links.all);
    bind("vsp_drill_critical", sev.CRITICAL);
    bind("vsp_drill_high", sev.HIGH);
  }

  window.addEventListener("load", async ()=>{
    try{
      const d = await dashLatest();
      window.__VSP_DASH_LATEST_V1 = d;
      ensurePanel(d);
    }catch(e){
      console.warn("[DRILL_PANEL] failed", e);
    }
  });
})();

// === VSP_P2_DRILL_ROUTER_V1 ===
// Drill router: click elements with data-drill -> switch tab datasource + apply filters
(function(){
  function parseHashParams(){
    let h = (location.hash || "").replace(/^#\/?/,"");
    if (!h) return {};
    const out = {};
    for (const part of h.split("&")){
      if (!part) continue;
      const [k,v] = part.split("=",2);
      if (!k) continue;
      out[decodeURIComponent(k)] = decodeURIComponent(v||"");
    }
    return out;
  }

  function buildHash(tab, filters){
    const sp = new URLSearchParams();
    sp.set("tab", tab || "datasource");
    for (const [k,v] of Object.entries(filters||{})){
      if (v === undefined || v === null) continue;
      const sv = String(v).trim();
      if (!sv) continue;
      sp.set(k, sv);
    }
    return "#" + sp.toString();
  }

  function switchToDatasourceTab(){
    // Try click datasource tab button if exists
    const btn = document.querySelector("#tab-datasource, [data-tab-btn='datasource'], a[href*='datasource']");
    if (btn && btn.click) btn.click();
  }

  function applyDatasource(filters){
    // Set hash first (so reload preserves)
    const h = buildHash("datasource", filters||{});
    if (location.hash !== h) location.hash = h;

    // then call sink if available
    const sink = window.VSP_DATASOURCE_APPLY_FILTERS_V1;
    if (typeof sink === "function"){
      try{ sink(filters||{}, {noHashSync:true}); }catch(e){}
    }
  }

  function handleDrillClick(e){
    const a = e.target.closest("[data-drill]");
    if (!a) return;
    e.preventDefault();
    let val = a.getAttribute("data-drill") || "";
    // accept JSON {"sev":"HIGH"} or query "sev=HIGH&tool=semgrep"
    let filters = {};
    try{
      if (val.trim().startsWith("{")) filters = JSON.parse(val);
      else{
        const sp = new URLSearchParams(val.replace(/^#\/?/,""));
        sp.forEach((v,k)=>{ filters[k]=v; });
      }
    }catch(_){
      filters = {};
    }
    switchToDatasourceTab();
    applyDatasource(filters);
  }

  function onHashChange(){
    const hp = parseHashParams();
    if ((hp.tab||"") !== "datasource") return;
    const f = Object.assign({}, hp);
    delete f.tab;
    const sink = window.VSP_DATASOURCE_APPLY_FILTERS_V1;
    if (typeof sink === "function"){
      sink(f, {noHashSync:true});
    }
  }

  function bind(){
    // delegate click drill
    if (!document.body._vspDrillBound){
      document.body._vspDrillBound = true;
      document.body.addEventListener("click", handleDrillClick);
    }
    window.addEventListener("hashchange", onHashChange);
    // initial
    onHashChange();
  }

  if (document.readyState === "loading"){
    document.addEventListener("DOMContentLoaded", bind);
  }else{
    bind();
  }
})();

// === VSP_P2_AUTOBIND_KPI_DRILL_V1 ===
// Auto bind drilldown for KPI cards (clickable commercial)
// - Uses dashboard_latest_v1.links if present
// - Fallback binds severity labels CRITICAL/HIGH/MEDIUM/LOW/INFO/TRACE
(function(){
  const SEVS = ["CRITICAL","HIGH","MEDIUM","LOW","INFO","TRACE"];

  function qs(sel, root){ return (root||document).querySelector(sel); }
  function qsa(sel, root){ return Array.from((root||document).querySelectorAll(sel)); }

  function norm(s){ return String(s||"").trim().toUpperCase(); }

  function parseDrillToQuery(drill){
    // drill may be absolute/relative url to datasource, or a query-like string
    if (!drill) return "";
    let s = String(drill).trim();
    // if full URL, take hash or query
    try{
      if (s.startsWith("http")){
        const u = new URL(s);
        if (u.hash && u.hash.length > 1) return u.hash.replace(/^#\/?/,"");
        if (u.search && u.search.length > 1) return u.search.replace(/^\?/,"");
      }
    }catch(_){}
    // if starts with #...
    s = s.replace(/^#\/?/,"");
    // remove leading vsp4 path fragments
    s = s.replace(/^\/?vsp4\??/,"").replace(/^\?/,"");
    return s;
  }

  async function fetchDash(){
    const r = await fetch("/api/vsp/dashboard_latest_v1", {cache:"no-store"});
    return await r.json();
  }

  function bindEl(el, query){
    if (!el || !query) return;
    // do not double bind
    if (el.getAttribute("data-drill")) return;
    el.setAttribute("data-drill", query);
    el.style.cursor = "pointer";
    el.title = el.title || "Click to drilldown";
  }

  function findKpiCandidates(){
    // broad selectors; harmless if none
    const sels = [
      ".vsp-kpi-card", ".kpi-card", ".kpi", ".vsp-card",
      "[data-kpi]", "[data-kpi-card]", "[data-role='kpi']"
    ];
    const out = [];
    for (const s of sels){
      qsa(s).forEach(x=>out.push(x));
    }
    // fallback: any card-like divs in dashboard area
    const dash = qs("#vsp-dashboard-main") || qs("#tab-dashboard") || document.body;
    qsa("div", dash).forEach(d=>{
      const txt = norm(d.innerText||"");
      if (SEVS.some(s=>txt.includes(s)) && (d.offsetWidth>80 && d.offsetHeight>40)){
        out.push(d);
      }
    });
    // unique
    return Array.from(new Set(out));
  }

  function bestEffortBindFromLinks(links){
    // expected shapes:
    // links: { severity: {HIGH:"tab=datasource&sev=HIGH"...}, all:"...", suppressed:"..." }
    if (!links || typeof links !== "object") return false;
    const kpis = findKpiCandidates();
    let bound = 0;

    // bind severity-based
    for (const sev of SEVS){
      const drill = links?.severity?.[sev] || links?.["severity."+sev] || links?.[sev] || null;
      if (!drill) continue;
      const q = parseDrillToQuery(drill);
      if (!q) continue;
      for (const el of kpis){
        const txt = norm(el.innerText||"");
        if (txt.includes(sev)){
          bindEl(el, q);
          bound++;
        }
      }
    }

    // bind "all" if present
    if (links.all){
      const q = parseDrillToQuery(links.all);
      if (q){
        for (const el of kpis){
          const txt = norm(el.innerText||"");
          if (txt.includes("TOTAL") || txt.includes("ALL") || txt.includes("FINDINGS")){
            bindEl(el, q);
            bound++;
          }
        }
      }
    }
    return bound > 0;
  }

  function fallbackBindSev(){
    const kpis = findKpiCandidates();
    let bound = 0;
    for (const sev of SEVS){
      const q = "tab=datasource&sev=" + encodeURIComponent(sev) + "&limit=200";
      for (const el of kpis){
        const txt = norm(el.innerText||"");
        if (txt.includes(sev)){
          bindEl(el, q);
          bound++;
        }
      }
    }
    return bound>0;
  }

  async function init(){
    try{
      const j = await fetchDash();
      const links = j?.links || j?.drilldown || j?.drill || null;
      const ok = bestEffortBindFromLinks(links);
      if (!ok) fallbackBindSev();
    }catch(e){
      fallbackBindSev();
    }
  }

  if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", init);
  else init();
})();



// === VSP_P2_FORCE_8TOOLS_V1 ===
// Force Gate Summary to show 8 tools (commercial). Missing tool => NOT_RUN/0.
// Also capture latest /api/vsp/run_status_v2 JSON via fetch clone.
(function(){
  try{
    if (window.__VSP_P2_FORCE_8TOOLS_V1_INSTALLED) return;
    window.__VSP_P2_FORCE_8TOOLS_V1_INSTALLED = true;

    const TOOL_ORDER = ["BANDIT","CODEQL","GITLEAKS","GRYPE","KICS","SEMGREP","SYFT","TRIVY"];
    window.__VSP_TOOL_ORDER = TOOL_ORDER;

    const origFetch = window.fetch;
    window.fetch = async function(){
      const resp = await origFetch.apply(this, arguments);
      try{
        const u = (typeof arguments[0] === "string") ? arguments[0] : (arguments[0] && arguments[0].url) || "";
        if (u.includes("/api/vsp/run_status_v2")) {
          resp.clone().json().then(j => {
            window.__VSP_LAST_STATUS_V2 = j;
            try { window.__VSP_RENDER_GATE_8TOOLS(); } catch(e){}
          }).catch(()=>{});
        }
      }catch(e){}
      return resp;
    };

    function pickToolObj(st, T){
      if (!st || typeof st !== "object") return null;
      const k = T.toLowerCase();
      return st[k + "_summary"] || st[k] || (st.tools && (st.tools[T] || st.tools[k])) || null;
    }

    function normVerdict(v){
      v = String(v || "").toUpperCase();
      if (!v) return "NOT_RUN";
      return v;
    }

    window.__VSP_RENDER_GATE_8TOOLS = function(){
      const st = window.__VSP_LAST_STATUS_V2;
      // find a plausible gate summary container
      const box =
        document.querySelector("#vsp-gate-summary") ||
        document.querySelector("#gate-summary") ||
        document.querySelector("[data-vsp-gate-summary]") ||
        document.querySelector(".vsp-gate-summary") ||
        document.querySelector("section#vsp-pane-dashboard .vsp-card .vsp-gate") ||
        null;
      if (!box) return;

      // create or find list container
      let list = box.querySelector(".vsp-gate-list");
      if (!list) {
        list = document.createElement("div");
        list.className = "vsp-gate-list";
        box.appendChild(list);
      }

      const rows = TOOL_ORDER.map(T => {
        const o = pickToolObj(st, T) || {};
        const verdict = normVerdict(o.verdict || o.status || o.result || (st && st[(T.toLowerCase()) + "_verdict"]) || "");
        const total = (o.total != null) ? Number(o.total) : Number((st && st[(T.toLowerCase()) + "_total"]) || 0) || 0;
        const pillCls = "vsp-pill vsp-pill-" + verdict.toLowerCase();

        return `
          <div class="vsp-gate-row" style="display:flex;align-items:center;justify-content:space-between;padding:6px 0;border-top:1px solid rgba(255,255,255,.06)">
            <div style="font-weight:650;letter-spacing:.2px">${T}</div>
            <div style="display:flex;gap:10px;align-items:center">
              <span class="${pillCls}">${verdict}</span>
              <span style="opacity:.75">total: ${total}</span>
            </div>
          </div>`;
      }).join("");

      list.innerHTML = rows;
    };

    // attempt render once later (in case status fetched before patch)
    setTimeout(()=>{ try{ window.__VSP_RENDER_GATE_8TOOLS(); }catch(e){} }, 1200);
  }catch(e){}
})();
 // === /VSP_P2_FORCE_8TOOLS_V1 ===




// === VSP_UI_DRILLDOWN_AND_EXPORTPROBE_V1 ===
(function(){
  'use strict';

  
  
  
  
  
  
  


/* VSP_DRILLDOWN_ARTIFACTS_NORMALIZE_P0_V1
 * Fix: Uncaught TypeError: __VSP_DD_ART_CALL__(VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2, ...) is not a function
 * Normalize window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2:
 *  - if function: keep
 *  - if object with .open(): wrap to function
 *  - if missing: provide no-op function (never throw)
 */
(function(){
  'use strict';
  if (window.__VSP_DRILLDOWN_ARTIFACTS_NORMALIZE_P0_V1) return;
  window.__VSP_DRILLDOWN_ARTIFACTS_NORMALIZE_P0_V1 = 1;

  function normalize(v){
    if (typeof v === 'function') return v;
    if (v && typeof v.open === 'function'){
      const obj = v;
      const fn = function(arg){
        try { return obj.open(arg); } catch(_e){ return null; }
      };
      fn.__wrapped_from_object = true;
      return fn;
    }
    // missing/unknown => no-op (never throw)
    const noop = function(_arg){ return null; };
    noop.__noop = true;
    return noop;
  }

  try{
    // Use defineProperty to normalize future assignments too (robust).
    let _val = window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2;
    Object.defineProperty(window, 'VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2', {
      configurable: true,
      enumerable: true,
      get: function(){ return _val; },
      set: function(v){ _val = normalize(v); }
    });
    // trigger normalization on current value
    window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 = _val;
  }catch(_e){
    // fallback if defineProperty is blocked
    window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 = normalize(window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2);
  }
})();

/* P0_DRILLDOWN_LOCAL_V4 */
  // P0: force local symbol to be FUNCTION (prevents "is not a function" even with shadowing)
  try{
    var __vsp_stub = function(){
      try{ console.info("[VSP_DASH][P0] drilldown stub called"); }catch(_){}
      return { open:function(){}, show:function(){}, close:function(){}, destroy:function(){} };
    };

    // local symbol (works even if calls are bare identifier)
    if (typeof VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 !== "function") {
      var VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 = __vsp_stub; // var is function-scoped in IIFE
      try{ console.info("[VSP_DASH][P0] drilldown local stub armed"); }catch(_){}
    }

    // window symbol too (for other modules)
    if (typeof window !== "undefined" && typeof window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 !== "function") {
      window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 = VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2;
      try{ console.info("[VSP_DASH][P0] drilldown window stub armed"); }catch(_){}
    }
  }catch(_){}

  // P0 FIX (final2): ensure drilldown helper exists on window (function)
  try{
    if (typeof window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 !== "function") {
      window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 = function(){
        try{ 
console.warn("[VSP_DASH] drilldown forced stub (window)");   // P0_DRILLDOWN_STUB: guarantee callable function
  if (typeof window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 !== "function") {
    window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 = function(){
      try{ console.warn("[VSP_DASH][P0] drilldown stub used (no-op)"); }catch(_){}
      return { open:function(){}, show:function(){}, destroy:function(){} };
    };
  }
}catch(_){}
        return false;
      };
    }
  }catch(_){}
// P0 FIX (final): drilldown dispatcher (avoid shadowed non-function symbols)
  function __vsp_call_drilldown_artifacts(){
    try{
      const fn = (window && typeof window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 === "function")
        ? window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2
        : function(){ try{ console.warn("[VSP_DASH] drilldown skipped (no function on window)"); }catch(_){ } return false; };
      return fn.apply(null, arguments);
    }catch(_){
      try{ console.warn("[VSP_DASH] drilldown dispatcher failed -> skipped"); }catch(__){}
      return false;
    }
  }
// P0 FIX (final): force drilldown helper onto window and call window.* to avoid shadowed const/object
  try{
    if (typeof window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 !== "function") {
      window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 = function(){
        try{ console.warn("[VSP_DASH] drilldown forced stub (window)"); }catch(_){}
        return false;
      };
    }
  }catch(_){}
// P0 FIX (hard): ALL drilldown helpers must never crash dashboard
  function __vsp_stub_drill(name){
    try{
      const fn = function(){
        try{ console.warn("[VSP_DASH] drilldown helper forced stub:", name); }catch(_){}
        return false;
      };
      // local symbol if exists
      try{
        if (typeof eval(name) !== "function") { /* ignore */ }
      }catch(_){}
      // window symbol
      try{
        if (typeof window[name] !== "function") window[name] = fn;
      }catch(_){}
    }catch(_){}
  }
  try{
    __vsp_stub_drill("VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2");
    __vsp_stub_drill("VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2");
  }catch(_){}
// P0 FIX (hard): drilldown must never crash dashboard
  try{
    // local symbol (if exists / if not declared -> catch)
    if (typeof VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 !== "function") {
window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 = function(){
        try{ console.warn("[VSP_DASH] drilldown helper not a function -> forced stub"); }catch(_){}
        return false;
      };
    }
  }catch(_){}
  try{
    if (typeof window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 !== "function") {
      window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 = function(){
        try{ console.warn("[VSP_DASH] drilldown helper missing -> forced stub"); }catch(_){}
        return false;
      };
    }
  }catch(_){}
// P0 FIX: avoid ReferenceError if drilldown artifacts helper is missing
  if (typeof window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 !== 'function') {
    window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 = function(){
      try{ console.warn("[VSP_DASH] drilldown helper missing -> skipped"); }catch(_){}
      return false;
    };
  }
// P0 FIX: avoid ReferenceError if drilldown artifacts helper is missing
  if (typeof window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 !== 'function') {
    window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 = function(){
      try{ console.warn("[VSP_DASH] drilldown helper missing -> skipped"); }catch(_){}
      return false;
    };
  }
// === VSP_DASH_KPI_FROM_EXTRAS_P1_V4 ===
  (function(){
    if(window.__VSP_DASH_KPI_FROM_EXTRAS_P1_V4) return;
    window.__VSP_DASH_KPI_FROM_EXTRAS_P1_V4 = 1;

    function normRid(x){
      try{
        x = String(x || "").trim();
        x = x.replace(/^RUN[_\-\s]+/i, "");
        x = x.replace(/^RID[:\s]+/i, "");
        const m = x.match(/(VSP_CI_\d{8}_\d{6})/i);
        if(m && m[1]) return m[1];
        return x.replace(/\s+/g, "_");
      }catch(_){ return ""; }
    }

    function getRidBestEffort(){
      // 1) global state (if any)
      try{
        const st = window.__VSP_RID_STATE__ || window.__VSP_RID_STATE || window.VSP_RID_STATE || window.__vsp_rid_state;
        if(st){
          if(st.rid || st.run_id) return normRid(st.rid || st.run_id);
          if(st.state && (st.state.rid || st.state.run_id)) return normRid(st.state.rid || st.state.run_id);
          if(typeof st.get === "function"){
            const v = st.get();
            if(v && (v.rid || v.run_id)) return normRid(v.rid || v.run_id);
          }
        }
      }catch(_){}

      // 2) header text contains "RID:"
      try{
        const body = document.body ? (document.body.innerText || "") : "";
        const m = body.match(/RID:\s*(VSP_CI_\d{8}_\d{6})/i);
        if(m && m[1]) return normRid(m[1]);
      }catch(_){}

      return "";
    }

    function setText(id, v){
      const el = document.getElementById(id);
      if(!el) return false;
      el.textContent = (v===0) ? "0" : (v ? String(v) : "—");
      return true;
    }

    function fmtBySev(bySev){
      if(!bySev) return "";
      const order = ["CRITICAL","HIGH","MEDIUM","LOW","INFO","TRACE"];
      const out = [];
      for(const k of order){
        if(bySev[k] !== undefined) out.push(k + ":" + bySev[k]);
      }
      return out.join(" ");
    }

    function pickTool(byTool, want){
      if(!byTool) return null;
      if(byTool[want] !== undefined) return byTool[want];
      const key = Object.keys(byTool).find(k => String(k||"").toUpperCase() === want.toUpperCase());
      return key ? byTool[key] : null;
    }

    function applyExtras(rid, kpi){
      if(!kpi) return;
      const total = kpi.total ?? 0;
      const eff = kpi.effective ?? 0;
      const degr = kpi.degraded ?? 0;
      const unk = kpi.unknown_count ?? 0;
      const score = (kpi.score === undefined || kpi.score === null) ? "" : kpi.score;

      const status = (degr > 0) ? "DEGRADED" : (total > 0 ? "OK" : "EMPTY");

      // commercial 4tabs KPI ids (exist in template)
      setText("kpi-overall", score !== "" ? (score + "/100") : status);
      setText("kpi-overall-sub", `total ${total} | eff ${eff} | degr ${degr} | unk ${unk}`);

      setText("kpi-gate", status);
      setText("kpi-gate-sub", fmtBySev(kpi.by_sev));

      const gtl = pickTool(kpi.by_tool, "GITLEAKS");
      setText("kpi-gitleaks", (gtl === null) ? "NOT_RUN" : gtl);
      setText("kpi-gitleaks-sub", "GITLEAKS");

      const cql = pickTool(kpi.by_tool, "CODEQL");
      setText("kpi-codeql", (cql === null) ? "NOT_RUN" : cql);
      setText("kpi-codeql-sub", "CODEQL");

      // if dashboard_2025 ids exist, also fill
      setText("kpi-total", total);
      setText("kpi-effective", eff);
      setText("kpi-degraded", degr);
      setText("kpi-score", score);
    }

    function fetchExtras(rid){
      const u = "/api/vsp/dashboard_v3_extras_v1?rid=" + encodeURIComponent(rid || "");
      return fetch(u, {cache:"no-store"})
        .then(r => r.ok ? r.json() : null)
        .then(j => (j && j.ok && j.kpi) ? j.kpi : null)
        .catch(_ => null);
    }

    let lastRid = "";
    function hydrate(force){
      const rid = getRidBestEffort();
      if(!rid) return;
      if(!force && rid === lastRid) return;
      lastRid = rid;
      fetchExtras(rid).then(kpi => { if(kpi) applyExtras(rid, kpi); });
    }

    // run on navigation + periodic
    window.addEventListener("hashchange", () => setTimeout(() => hydrate(true), 120));
    setTimeout(() => hydrate(true), 300);
    setInterval(() => hydrate(false), 1500);
    setInterval(() => hydrate(true), 15000);
  })();
  // === /VSP_DASH_KPI_FROM_EXTRAS_P1_V4 ===


  // === VSP_DASHBOARD_KPI_WIRE_EXTRAS_P1_V2 ===
  (function(){
    if(window.__VSP_KPI_EXTRAS_WIRED_P1_V2) return;
    window.__VSP_KPI_EXTRAS_WIRED_P1_V2 = 1;

    function _ridFromState(){
      try{
        const candidates = [
          window.__vsp_rid_state,
          window.VSP_RID_STATE,
          window.VSP_RID_STATE_V1,
          window.__VSP_RID_STATE
        ].filter(Boolean);

        for(const st of candidates){
          if(typeof st.get === "function"){
            const r = st.get();
            if(r && (r.rid || r.run_id)) return (r.rid || r.run_id);
          }
          if(st && (st.rid || st.run_id)) return (st.rid || st.run_id);
          if(st && st.state && (st.state.rid || st.state.run_id)) return (st.state.rid || st.state.run_id);
        }
      }catch(_){}
      return "";
    }

    function getRidBestEffort(){
      const r0 = _ridFromState();
      if(r0) return String(r0).trim();

      // try DOM (some headers render RID: XXX)
      try{
        const body = document.body ? (document.body.innerText || "") : "";
        const m = body.match(/RID:\s*(VSP_[A-Z0-9_]+)/);
        if(m && m[1]) return m[1];
      }catch(_){}
      return "";
    }

    function setText(id, val){
      const el = document.getElementById(id);
      if(!el) return;
      el.textContent = (val===undefined || val===null || val==="") ? "—" : String(val);
    }

    function setSub(id, val){
      const el = document.getElementById(id);
      if(!el) return;
      el.textContent = (val===undefined || val===null) ? "" : String(val);
    }

    function fmtSev(bySev){
      if(!bySev) return "";
      const order = ["CRITICAL","HIGH","MEDIUM","LOW","INFO","TRACE"];
      const parts = [];
      for(const k of order){
        if(bySev[k]!==undefined && bySev[k]!==null) parts.push(k+":"+bySev[k]);
      }
      return parts.join(" ");
    }

    function pickTool(byTool, want){
      if(!byTool) return null;
      if(byTool[want]!==undefined) return byTool[want];
      try{
        const key = Object.keys(byTool).find(k => String(k||"").toUpperCase() === String(want).toUpperCase());
        if(key) return byTool[key];
      }catch(_){}
      return null;
    }

    function applyExtras(rid, kpi){
      if(!kpi) return;

      const total = kpi.total || 0;
      const eff = kpi.effective || 0;
      const degr = kpi.degraded || 0;
      const unk  = (kpi.unknown_count===undefined || kpi.unknown_count===null) ? "" : kpi.unknown_count;
      const score = (kpi.score===undefined || kpi.score===null) ? "" : kpi.score;

      const status = (degr>0) ? "DEGRADED" : (total>0 ? "OK" : "EMPTY");

      // These KPI ids are used by vsp_4tabs_commercial_v1.html (commercial panel)
      setText("kpi-overall", score!=="" ? (score + "/100") : status);
      setSub ("kpi-overall-sub", "total " + total + " | eff " + eff + " | degr " + degr + (unk!=="" ? (" | unk "+unk) : ""));

      setText("kpi-gate", status);
      setSub ("kpi-gate-sub", fmtSev(kpi.by_sev));

      const gtl = pickTool(kpi.by_tool, "GITLEAKS");
      setText("kpi-gitleaks", (gtl===null || gtl===undefined) ? "NOT_RUN" : gtl);
      setSub ("kpi-gitleaks-sub", (gtl===null || gtl===undefined) ? "tool=GITLEAKS missing" : ("tool=GITLEAKS | rid=" + rid));

      const cql = pickTool(kpi.by_tool, "CODEQL");
      setText("kpi-codeql", (cql===null || cql===undefined) ? "NOT_RUN" : cql);
      setSub ("kpi-codeql-sub", (cql===null || cql===undefined) ? "tool=CODEQL missing" : ("tool=CODEQL | rid=" + rid));
    }

    function fetchExtras(rid){
      const u = "/api/vsp/dashboard_v3_extras_v1?rid=" + encodeURIComponent(rid||"");
      return fetch(u, {cache:"no-store"})
        .then(r => r.ok ? r.json() : null)
        .then(j => (j && j.ok && j.kpi) ? j.kpi : null)
        .catch(_ => null);
    }

    let lastRid = "";
    function tick(force){
      const rid = getRidBestEffort();
      if(!rid) return;
      if(!force && rid === lastRid) return;
      lastRid = rid;

      fetchExtras(rid).then(kpi => {
        if(kpi) applyExtras(rid, kpi);
      });
    }

    window.addEventListener("hashchange", function(){ setTimeout(function(){ tick(true); }, 150); });
    document.addEventListener("visibilitychange", function(){ if(!document.hidden) setTimeout(function(){ tick(true); }, 150); });

    // first paint + periodic refresh
    setTimeout(function(){ tick(true); }, 300);
    setInterval(function(){ tick(false); }, 1500);
    setInterval(function(){ tick(true); }, 15000);
  })();


  // === VSP_DASHBOARD_USE_EXTRAS_P1_V2 ===
  function fetchDashboardExtras(rid){
    const u = `/api/vsp/dashboard_v3_extras_v1?rid=${encodeURIComponent(rid||"")}`;
    return fetch(u, {cache:"no-store"})
      .then(r => r.ok ? r.json() : null)
      .then(j => (j && j.ok && j.kpi) ? j.kpi : null)
      .catch(_ => null);
  }

  function setTextSafe(id, val){
    try{
      const el = document.getElementById(id);
      if(!el) return false;
      el.textContent = (val===null || val===undefined) ? "N/A" : String(val);
      return true;
    }catch(_){ return false; }
  }

  function applyKpiExtrasToDom(kpi){
    if(!kpi) return;
    // try common ids (non-breaking if missing)
    setTextSafe("kpi-total", kpi.total);
    setTextSafe("kpi-score", kpi.score);
    setTextSafe("kpi-effective", kpi.effective);
    setTextSafe("kpi-degraded", kpi.degraded);

    // also try a few other likely ids used in your UI patches
    setTextSafe("kpi-total-findings", kpi.total);
    setTextSafe("kpi-effective-findings", kpi.effective);
    setTextSafe("kpi-degraded-findings", kpi.degraded);
  }
  // === /VSP_DASHBOARD_USE_EXTRAS_P1_V2 ===


  // --- tiny utils ---
  const LOG_ONCE = new Set();
  function logOnce(k, ...a){ if(LOG_ONCE.has(k)) return; LOG_ONCE.add(k); console.log(...a); }
  function nowMs(){ try { return Date.now(); } catch(_){ return 0; } }

  function ridFromPage(){
    // best-effort: try globals, DOM attrs, URL params
    try {
      if (window.VSP_RID) return String(window.VSP_RID);
      if (window.__VSP_RID__) return String(window.__VSP_RID__);
    } catch(_){}
    try {
      const u = new URL(location.href);
      const rid = u.searchParams.get("rid") || u.searchParams.get("run_id") || u.searchParams.get("id");
    fetchDashboardExtras(rid).then(applyKpiExtrasToDom);
      if (rid) return String(rid);
    } catch(_){}
    try {
      const el = document.querySelector("[data-rid],[data-run-id],[data-runid]");
      const v = el && (el.getAttribute("data-rid") || el.getAttribute("data-run-id") || el.getAttribute("data-runid"));
      if (v) return String(v);
    } catch(_){}
    return null;
  }

  function openTab(tabId){
    // expects your 4-tabs router to exist; best-effort click
    try {
      // common patterns: button#tab-datasource / a[href='#datasource']
      const btn = document.querySelector("#tab-" + tabId + ", [data-tab='"+tabId+"'], a[href='#"+tabId+"']");
      if (btn) { btn.click(); return true; }
    } catch(_){}
    // fallback: try call existing router func if you have one
    try {
      if (typeof window.VSP_SWITCH_TAB === "function") { window.VSP_SWITCH_TAB(tabId); return true; }
      if (typeof window.vspSwitchTab === "function") { window.vspSwitchTab(tabId); return true; }
    } catch(_){}
    return false;
  }

  // --- datasource filter bus (localStorage + CustomEvent) ---
  const LS_KEY = "vsp_ds_filters_v1";

  function pushDatasourceFilters(filters, opts){
    opts = opts || {};
    const payload = {
      v: 1,
      ts: nowMs(),
      rid: opts.rid || ridFromPage(),
      filters: filters || {}
    };
    try { localStorage.setItem(LS_KEY, JSON.stringify(payload)); } catch(_){}
    try {
      window.dispatchEvent(new CustomEvent("vsp:datasource:setFilters", { detail: payload }));
    } catch(_){}
  }

  // public API for drilldown
  window.VSP_DRILL_TO_DATASOURCE = function(filters, opts){
    try {
      pushDatasourceFilters(filters || {}, opts || {});
      openTab("datasource");
    } catch(e) {
      console.warn("[VSP][DRILL] failed", e);
    }
  };

  // --- export probe: make it quiet + stop after first success ---
  async function probeExportOnce(url){
    // HEAD is often blocked/noisy in browser setups; fallback to GET safely.
    try {
      const r = await fetch(url, { method: "HEAD", cache: "no-store", credentials: "same-origin" });
      if (r && r.ok) return { ok:true, via:"HEAD", status:r.status, headers:r.headers };
    } catch(_){}
    try {
      const r = await fetch(url + (url.includes("?") ? "&" : "?") + "_probe=1", { method: "GET", cache: "no-store", credentials: "same-origin" });
      if (r && r.ok) return { ok:true, via:"GET", status:r.status, headers:r.headers };
      return { ok:false, via:"GET", status: (r && r.status) || 0, headers: r && r.headers };
    } catch(e){
      return { ok:false, via:"ERR", status:0, err:String(e) };
    }
  }

  async function commercialExportProbeQuiet(){
    // only run on pages that show export controls
    const rid = ridFromPage();
    if (!rid) return;

    // build canonical export URL once (commercial behavior)
    const base = (window.VSP_RUN_EXPORT_BASE || "/api/vsp/run_export_v3").replace(/\/+$/,"");
    const pdfUrl = base + "/" + encodeURIComponent(rid) + "?fmt=pdf";

    const key = "export-probe-" + rid;
    if (window.__VSP_EXPORT_PROBED__ && window.__VSP_EXPORT_PROBED__[rid]) return;
    window.__VSP_EXPORT_PROBED__ = window.__VSP_EXPORT_PROBED__ || {};
    window.__VSP_EXPORT_PROBED__[rid] = true;

    const res = await probeExportOnce(pdfUrl);
    // treat failures as non-fatal; do NOT spam console
    if (!res.ok){
      logOnce(key+"-fail", "[VSP][EXPORT][PROBE] pdf probe not OK (non-fatal)", { rid, url: pdfUrl, via: res.via, status: res.status });
      window.VSP_EXPORT_AVAILABLE = window.VSP_EXPORT_AVAILABLE || {};
      window.VSP_EXPORT_AVAILABLE.pdf = 0;
      return;
    }

    // success: set availability and stop further probes
    window.VSP_EXPORT_AVAILABLE = window.VSP_EXPORT_AVAILABLE || {};
    window.VSP_EXPORT_AVAILABLE.pdf = 1;
    logOnce(key+"-ok", "[VSP][EXPORT][PROBE] pdf available", { rid, via: res.via, status: res.status });

    // if you have UI pills/badges, update them quietly
    try {
      const pill = document.querySelector("[data-export='pdf'], #pill-export-pdf, #pill-pdf");
      if (pill) { pill.classList.add("is-ok"); pill.classList.remove("is-bad"); }
    } catch(_){}
  }

  // run once after DOM ready
  function onReady(fn){
    if (document.readyState === "complete" || document.readyState === "interactive") return setTimeout(fn, 0);
    document.addEventListener("DOMContentLoaded", fn, { once: true });
  }

  // --- attach drilldown click helpers (best-effort, non-breaking) ---
  function wireDrilldownClicks(){
    // opt-in attributes (recommended): data-vsp-drill-tool / data-vsp-drill-sev / data-vsp-drill-cwe
    const els = document.querySelectorAll("[data-vsp-drill-tool],[data-vsp-drill-sev],[data-vsp-drill-cwe]");
    els.forEach(el=>{
      if (el.__vsp_drilled__) return;
      el.__vsp_drilled__ = true;
      el.style.cursor = "pointer";
      el.addEventListener("click", ()=>{
        const tool = el.getAttribute("data-vsp-drill-tool");
        const sev  = el.getAttribute("data-vsp-drill-sev");
        const cwe  = el.getAttribute("data-vsp-drill-cwe");
        const filters = {};
        if (tool) filters.tool = tool;
        if (sev)  filters.severity = sev;
        if (cwe)  filters.cwe = cwe;
        window.VSP_DRILL_TO_DATASOURCE(filters);
      });
    });

    // fallback: gate summary pills often include tool/sev text
    const pills = document.querySelectorAll(".vsp-pill,[data-pill]");
    pills.forEach(p=>{
      if (p.__vsp_drilled__) return;
      const t = (p.textContent || "").trim();
      // simple patterns: "GITLEAKS", "SEMGREP", "CRITICAL", "HIGH", "CWE-79"
      // (intentionally empty; handled by wireFallbackPills)
    });
  }

  // NOTE: avoid python-style in JS; keep safe fallback only
  function wireFallbackPills(){
    const pills = document.querySelectorAll(".vsp-pill,[data-pill]");
    pills.forEach(p=>{
      if (p.__vsp_drilled__) return;
      const txt = (p.textContent || "").trim();
      if (!txt) return;

      const up = txt.toUpperCase();
      const filters = {};
      const toolSet = new Set(["GITLEAKS","SEMGREP","TRIVY","CODEQL","KICS","GRYPE","SYFT","BANDIT"]);
      const sevSet  = new Set(["CRITICAL","HIGH","MEDIUM","LOW","INFO","TRACE"]);
      if (toolSet.has(up)) filters.tool = up;
      if (sevSet.has(up))  filters.severity = up;
      if (/^CWE-\d+$/i.test(up)) filters.cwe = up;

      if (Object.keys(filters).length === 0) return;

      p.__vsp_drilled__ = true;
      p.style.cursor = "pointer";
      p.title = "Click to drilldown → Data Source";
      p.addEventListener("click", ()=> window.VSP_DRILL_TO_DATASOURCE(filters));
    });
  }

  onReady(()=>{
    try { commercialExportProbeQuiet(); } catch(e){ /* silent */ }
    try { wireDrilldownClicks(); } catch(e){ /* silent */ }
    try { wireFallbackPills(); } catch(e){ /* silent */ }
  });

})();


/* VSP_DASH_BADGES_P1_V1: Dashboard badges for Degraded tools + Rule Overrides delta (live RID) */
(function(){
  'use strict';

  async function _j(url, timeoutMs=6000){
    const ctrl = new AbortController();
    const t = setTimeout(()=>ctrl.abort(), timeoutMs);
    try{
      const r = await fetch(url, {signal: ctrl.signal, headers:{'Accept':'application/json'}});
      const ct = (r.headers.get('content-type')||'').toLowerCase();
      if(!ct.includes('application/json')) return null;
      return await r.json();
    }catch(e){
      return null;
    }finally{
      clearTimeout(t);
    }
  }

  function _getRidFromLocal(){
    const keys = ["vsp_selected_rid_v2","vsp_selected_rid","vsp_current_rid","VSP_RID","vsp_rid"];
    for(const k of keys){
      try{
        const v = localStorage.getItem(k);
        if(v && v !== "null" && v !== "undefined") return v;
      }catch(e){}
    }
    return null;
  }

  async function _getRid(){
    try{
      if(window.VSP_RID && typeof window.VSP_RID.get === "function"){
        const r = window.VSP_RID.get();
        if(r) return r;
      }
    }catch(e){}
    const l = _getRidFromLocal();
    if(l) return l;

    const x = await _j("/api/vsp/latest_rid_v1");
    if(x && x.ok && x.run_id) return x.run_id;
    return null;
  }

  function _findDashHost(){
    return document.getElementById("vsp4-dashboard")
      || document.querySelector("[data-tab='dashboard']")
      || document.querySelector("#tab-dashboard")
      || document.querySelector(".vsp-dashboard")
      || document.querySelector("main")
      || document.body;
  }

  function _ensureBar(){
    const host = _findDashHost();
    if(!host) return null;

    let bar = document.getElementById("vsp-dash-p1-badges");
    if(bar) return bar;

    bar = document.createElement("div");
    bar.id = "vsp-dash-p1-badges";
    bar.style.cssText = "margin:10px 0 12px 0;padding:10px 12px;border:1px solid rgba(148,163,184,.18);border-radius:14px;background:rgba(2,6,23,.35);display:flex;gap:10px;flex-wrap:wrap;align-items:center;";

    function pill(id, label){
      const a = document.createElement("a");
      a.href="#";
      a.id=id;
      a.style.cssText = "display:inline-flex;gap:8px;align-items:center;padding:7px 10px;border-radius:999px;border:1px solid rgba(148,163,184,.22);text-decoration:none;color:#cbd5e1;font-size:12px;white-space:nowrap;";
      a.innerHTML = `<b style="font-weight:700;color:#e2e8f0">${label}</b><span style="opacity:.9" data-val>loading…</span>`;
      return a;
    }

    bar.appendChild(pill("vsp-pill-degraded","Degraded"));
    bar.appendChild(pill("vsp-pill-overrides","Overrides"));
    bar.appendChild(pill("vsp-pill-rid","RID"));

    host.prepend(bar);
    return bar;
  }

  function _setPill(id, text){
    const a = document.getElementById(id);
    if(!a) return;
    const v = a.querySelector("[data-val]");
    if(v) v.textContent = text;
  }

  function _fmtDegraded(st){
    const arr = (st && st.degraded_tools) ? st.degraded_tools : [];
    if(!arr || !arr.length) return "none";
    const parts = [];
    for(const it of arr.slice(0,4)){
      const tool = it.tool || it.name || "tool";
      const rc = (it.rc !== undefined && it.rc !== null) ? `rc=${it.rc}` : "";
      const v  = it.verdict ? String(it.verdict) : "";
      const why = it.reason || it.error || it.note || "";
      const one = [tool, v, rc].filter(Boolean).join(":") + (why ? ` (${String(why).slice(0,30)})` : "");
      parts.push(one.trim());
    }
    return parts.join(" | ") + (arr.length>4 ? ` (+${arr.length-4})` : "");
  }

  function _fmtOverrides(eff){
    const d = (eff && eff.delta) ? eff.delta : {};
    const matched = d.matched_n ?? 0;
    const applied = d.applied_n ?? 0;
    const sup = d.suppressed_n ?? 0;
    const chg = d.changed_severity_n ?? 0;
    const exp = d.expired_match_n ?? 0;
    return `matched=${matched} applied=${applied} suppressed=${sup} changed=${chg} expired=${exp}`;
  }

  async function refresh(){
    _ensureBar();
    const rid = await _getRid();
    _setPill("vsp-pill-rid", rid || "n/a");
    if(!rid) return;

    const [st, eff] = await Promise.all([
      _j(`/api/vsp/run_status_v2/${encodeURIComponent(rid)}`),
      _j(`/api/vsp/findings_effective_v1/${encodeURIComponent(rid)}?limit=0`)
    ]);

    _setPill("vsp-pill-degraded", _fmtDegraded(st));
    _setPill("vsp-pill-overrides", _fmtOverrides(eff));
  }

  document.addEventListener("click", function(ev){
    const a = ev.target && ev.target.closest && ev.target.closest("#vsp-pill-degraded,#vsp-pill-overrides");
    if(!a) return;
    ev.preventDefault();
    try{
      if(window.VSP_DASH_DRILLDOWN && typeof window.VSP_DASH_DRILLDOWN.open === "function"){
        window.VSP_DASH_DRILLDOWN.open();
      }
    }catch(e){}
  }, true);

  window.addEventListener("vsp:rid_changed", function(){ refresh(); });
  window.addEventListener("hashchange", function(){ setTimeout(refresh, 120); });
  window.addEventListener("load", function(){ setTimeout(refresh, 200); });

  setTimeout(refresh, 250);
})();


/* VSP_DASH_BADGES_P1_V3_FIXEDBAR: ensure badges visible even if dashboard host selector mismatch */
(function(){
  'use strict';

  function _pickHost(){
    // 1) container that holds KPI cards
    const card = document.querySelector(".vsp-card, .dashboard-card, .card");
    if(card && card.parentElement) return card.parentElement;

    // 2) active tab pane (common patterns)
    const active = document.querySelector(".tab-pane.active, .tab-content .active, [role='tabpanel'][aria-hidden='false']");
    if(active) return active;

    // 3) main content region
    return document.querySelector("main") || document.body;
  }

  function _ensureFixedStyle(){
    if(document.getElementById("vsp-dash-fixed-style")) return;
    const st = document.createElement("style");
    st.id="vsp-dash-fixed-style";
    st.textContent = `
      #vsp-dash-p1-badges{ z-index:9999; }
      #vsp-dash-p1-badges.vsp-fixed{
        position: sticky;
        top: 0;
        backdrop-filter: blur(8px);
        background: rgba(2,6,23,.60) !important;
      }
    `;
    document.head.appendChild(st);
  }

  // override ensureBar from V1 (if exists) by recreating bar + sticky class
  function ensureBarV3(){
    _ensureFixedStyle();
    let bar = document.getElementById("vsp-dash-p1-badges");
    if(bar) {
      bar.classList.add("vsp-fixed");
      return bar;
    }
    const host = _pickHost();
    if(!host) return null;

    bar = document.createElement("div");
    bar.id = "vsp-dash-p1-badges";
    bar.className = "vsp-fixed";
    bar.style.cssText = "margin:0 0 12px 0;padding:10px 12px;border:1px solid rgba(148,163,184,.18);border-radius:14px;background:rgba(2,6,23,.35);display:flex;gap:10px;flex-wrap:wrap;align-items:center;";

    function pill(id, label){
      const a = document.createElement("a");
      a.href="#";
      a.id=id;
      a.style.cssText = "display:inline-flex;gap:8px;align-items:center;padding:7px 10px;border-radius:999px;border:1px solid rgba(148,163,184,.22);text-decoration:none;color:#cbd5e1;font-size:12px;white-space:nowrap;";
      a.innerHTML = `<b style="font-weight:700;color:#e2e8f0">${label}</b><span style="opacity:.9" data-val>loading…</span>`;
      return a;
    }

    bar.appendChild(pill("vsp-pill-degraded","Degraded"));
    bar.appendChild(pill("vsp-pill-overrides","Overrides"));
    bar.appendChild(pill("vsp-pill-rid","RID"));

    host.prepend(bar);
    return bar;
  }

  // kick once after load to guarantee visibility
  window.addEventListener("load", function(){
    setTimeout(()=>{ try{ ensureBarV3(); }catch(e){} }, 200);
  });
  window.addEventListener("hashchange", function(){
    setTimeout(()=>{ try{ ensureBarV3(); }catch(e){} }, 120);
  });
  window.addEventListener("vsp:rid_changed", function(){
    setTimeout(()=>{ try{ ensureBarV3(); }catch(e){} }, 50);
  });
})();


/* VSP_DASH_DRILLDOWN_P1_V1: openable drilldown panel for Degraded + Overrides */
(function(){
  'use strict';

  async function _j(url, timeoutMs=8000){
    const ctrl = new AbortController();
    const t = setTimeout(()=>ctrl.abort(), timeoutMs);
    try{
      const r = await fetch(url, {signal: ctrl.signal, headers:{'Accept':'application/json'}});
      const ct = (r.headers.get('content-type')||'').toLowerCase();
      if(!ct.includes('application/json')) return null;
      return await r.json();
    }catch(e){
      return null;
    }finally{
      clearTimeout(t);
    }
  }

  function _getRidFromLocal(){
    const keys = ["vsp_selected_rid_v2","vsp_selected_rid","vsp_current_rid","VSP_RID","vsp_rid"];
    for(const k of keys){
      try{
        const v = localStorage.getItem(k);
        if(v && v !== "null" && v !== "undefined") return v;
      }catch(e){}
    }
    return null;
  }

  async function _getRid(){
    try{
      if(window.VSP_RID && typeof window.VSP_RID.get === "function"){
        const r = window.VSP_RID.get();
        if(r) return r;
      }
    }catch(e){}
    const l = _getRidFromLocal();
    if(l) return l;
    const x = await _j("/api/vsp/latest_rid_v1");
    if(x && x.ok && x.run_id) return x.run_id;
    return null;
  }

  function _ensureUI(){
    if(document.getElementById("vsp-dd-overlay")) return;

    const st = document.createElement("style");
    st.id = "vsp-dd-style";
    st.textContent = `
      #vsp-dd-overlay{position:fixed;inset:0;z-index:10000;background:rgba(0,0,0,.55);display:none;}
      #vsp-dd-panel{position:fixed;top:60px;right:18px;bottom:18px;width:min(820px,calc(100vw - 36px));
        z-index:10001;background:rgba(2,6,23,.96);border:1px solid rgba(148,163,184,.18);border-radius:18px;
        box-shadow:0 20px 80px rgba(0,0,0,.55);display:none;overflow:hidden;}
      #vsp-dd-head{display:flex;align-items:center;justify-content:space-between;padding:14px 14px;border-bottom:1px solid rgba(148,163,184,.14);}
      #vsp-dd-title{font-weight:800;color:#e2e8f0;font-size:14px;letter-spacing:.2px}
      #vsp-dd-actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
      .vsp-dd-btn{padding:7px 10px;border-radius:12px;border:1px solid rgba(148,163,184,.22);background:rgba(15,23,42,.55);
        color:#cbd5e1;font-size:12px;cursor:pointer}
      .vsp-dd-btn:hover{filter:brightness(1.08)}
      #vsp-dd-body{padding:14px;overflow:auto;height:calc(100% - 56px);color:#cbd5e1}
      .vsp-dd-card{border:1px solid rgba(148,163,184,.14);border-radius:16px;background:rgba(15,23,42,.35);padding:12px 12px;margin-bottom:12px;}
      .vsp-dd-kv{display:grid;grid-template-columns:160px 1fr;gap:6px 12px;font-size:12px;}
      .vsp-dd-k{opacity:.85}
      .vsp-dd-v{color:#e2e8f0}
      .vsp-dd-table{width:100%;border-collapse:separate;border-spacing:0 8px;font-size:12px;}
      .vsp-dd-table td{padding:8px 10px;border:1px solid rgba(148,163,184,.14);background:rgba(2,6,23,.35);}
      .vsp-dd-table tr td:first-child{border-radius:12px 0 0 12px;}
      .vsp-dd-table tr td:last-child{border-radius:0 12px 12px 0;}
      .vsp-dd-muted{opacity:.75}
      .vsp-dd-link{color:#93c5fd;text-decoration:none}
      .vsp-dd-link:hover{text-decoration:underline}
      code.vsp-dd-code{background:rgba(2,6,23,.6);border:1px solid rgba(148,163,184,.16);padding:2px 6px;border-radius:8px}
    `;
    document.head.appendChild(st);

    const ov = document.createElement("div");
    ov.id="vsp-dd-overlay";
    ov.addEventListener("click", close);
    document.body.appendChild(ov);

    const panel = document.createElement("div");
    panel.id="vsp-dd-panel";
    panel.innerHTML = `
      <div id="vsp-dd-head">
        <div id="vsp-dd-title">Drilldown</div>
        <div id="vsp-dd-actions">
          <button class="vsp-dd-btn" id="vsp-dd-refresh">Refresh</button>
          <button class="vsp-dd-btn" id="vsp-dd-copy">Copy RID</button>
          <button class="vsp-dd-btn" id="vsp-dd-close">Close</button>
        </div>
      </div>
      <div id="vsp-dd-body">
        <div class="vsp-dd-card"><div class="vsp-dd-muted">Loading…</div></div>
      </div>
    `;
    document.body.appendChild(panel);

    document.getElementById("vsp-dd-close").addEventListener("click", close);
    document.getElementById("vsp-dd-refresh").addEventListener("click", render);
    document.getElementById("vsp-dd-copy").addEventListener("click", async ()=>{
      const rid = await _getRid();
      try{ await navigator.clipboard.writeText(rid||""); }catch(e){}
    });

    window.addEventListener("keydown", (e)=>{
      if(e.key === "Escape") close();
    });
  }

  function open(){
    _ensureUI();
    document.getElementById("vsp-dd-overlay").style.display="block";
    document.getElementById("vsp-dd-panel").style.display="block";
    render();
  }

  function close(){
    const ov=document.getElementById("vsp-dd-overlay");
    const pn=document.getElementById("vsp-dd-panel");
    if(ov) ov.style.display="none";
    if(pn) pn.style.display="none";
  }

  function _fmtOverrides(eff){
    const d = (eff && eff.delta) ? eff.delta : {};
    const matched = d.matched_n ?? 0;
    const applied = d.applied_n ?? 0;
    const sup = d.suppressed_n ?? 0;
    const chg = d.changed_severity_n ?? 0;
    const exp = d.expired_match_n ?? 0;
    return {matched, applied, sup, chg, exp, now_utc: d.now_utc || ""};
  }

  function _htmlEscape(x){
    return String(x||"").replace(/[&<>"]/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;" }[c]));
  }

  async function render(){
    _ensureUI();
    const body = document.getElementById("vsp-dd-body");
    const title = document.getElementById("vsp-dd-title");
    const rid = await _getRid();
    title.textContent = rid ? `Drilldown • ${rid}` : "Drilldown • (no RID)";

    if(!rid){
      body.innerHTML = `<div class="vsp-dd-card"><div class="vsp-dd-muted">No RID selected.</div></div>`;
      return;
    }

    body.innerHTML = `<div class="vsp-dd-card"><div class="vsp-dd-muted">Loading ${_htmlEscape(rid)}…</div></div>`;

    const [st, eff, art] = await Promise.all([
      _j(`/api/vsp/run_status_v2/${encodeURIComponent(rid)}`),
      _j(`/api/vsp/findings_effective_v1/${encodeURIComponent(rid)}?limit=0`),
      _j(`/api/vsp/run_artifacts_index_v1/${encodeURIComponent(rid)}`)
    ]);

    const degraded = (st && st.degraded_tools) ? st.degraded_tools : [];
    const ov = _fmtOverrides(eff);

    let artHtml = `<div class="vsp-dd-muted">Artifacts: n/a</div>`;
    if(art && (art.ok || art.items)){
      const items = art.items || [];
      const links = items.slice(0,10).map(it=>{
        const name = _htmlEscape(it.name || it.file || "artifact");
        const url  = it.url || it.href || it.download_url || "";
        if(url) return `<a class="vsp-dd-link" href="${_htmlEscape(url)}" target="_blank" rel="noopener">${name}</a>`;
        return `<span class="vsp-dd-muted">${name}</span>`;
      });
      artHtml = `<div class="vsp-dd-muted">Artifacts:</div><div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:6px;">${links.join(" ") || '<span class="vsp-dd-muted">empty</span>'}</div>`;
    }

    const degradedRows = (degraded||[]).map(it=>{
      const tool=_htmlEscape(it.tool || it.name || "");
      const verdict=_htmlEscape(it.verdict || "");
      const rc=(it.rc!==undefined && it.rc!==null) ? _htmlEscape(it.rc) : "";
      const reason=_htmlEscape(it.reason || it.error || it.note || "");
      return `<tr>
        <td><b>${tool}</b></td>
        <td>${verdict || '<span class="vsp-dd-muted">—</span>'}</td>
        <td>${rc || '<span class="vsp-dd-muted">—</span>'}</td>
        <td>${reason || '<span class="vsp-dd-muted">—</span>'}</td>
      </tr>`;
    }).join("");

    body.innerHTML = `
      <div class="vsp-dd-card">
        <div style="font-weight:800;color:#e2e8f0;margin-bottom:8px;">Overview</div>
        <div class="vsp-dd-kv">
          <div class="vsp-dd-k">RID</div><div class="vsp-dd-v"><code class="vsp-dd-code">${_htmlEscape(rid)}</code></div>
          <div class="vsp-dd-k">Overrides delta</div><div class="vsp-dd-v">matched=${ov.matched} • applied=${ov.applied} • suppressed=${ov.sup} • changed=${ov.chg} • expired=${ov.exp}</div>
          <div class="vsp-dd-k">Delta time</div><div class="vsp-dd-v">${_htmlEscape(ov.now_utc) || '<span class="vsp-dd-muted">—</span>'}</div>
          <div class="vsp-dd-k">Degraded tools</div><div class="vsp-dd-v">${(degraded||[]).length || 0}</div>
        </div>
        <div style="margin-top:10px;">${artHtml}</div>
      </div>

      <div class="vsp-dd-card">
        <div style="font-weight:800;color:#e2e8f0;margin-bottom:8px;">Degraded details</div>
        ${(degraded && degraded.length) ? `
          <table class="vsp-dd-table">
            <tr>
              <td><b>Tool</b></td><td><b>Verdict</b></td><td><b>RC</b></td><td><b>Reason</b></td>
            </tr>
            ${degradedRows}
          </table>
        ` : `<div class="vsp-dd-muted">No degraded tools.</div>`}
      </div>
    `;
  }

  window.VSP_DASH_DRILLDOWN = { open, close, render };
})();

VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2

/* VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2: pin important artifacts + quick-open buttons */
(function(){
  'use strict';
  if(!window.VSP_DASH_DRILLDOWN || typeof window.VSP_DASH_DRILLDOWN.render !== "function"){
    console.warn("[DRILL_ART_V2] VSP_DASH_DRILLDOWN missing; skip");
    return;
  }

  const PIN = [
    "kics/kics.log",
    "codeql/codeql.log",
    "trivy/trivy.json.err",
    "findings_effective.json",
    "findings_unified.json",
  ];

  function _pinSort(items){
    const byName = new Map((items||[]).map(x=>[x.name, x]));
    const out = [];
    for(const name of PIN){
      if(byName.has(name)) out.push(byName.get(name));
      else out.push({name, url:null, size:null, missing:true});
    }
    // append rest (non-duplicates)
    for(const it of (items||[])){
      if(!PIN.includes(it.name)) out.push(it);
    }
    return out;
  }

  function _qBtn(name, url){
    const disabled = !url;
    return `<a class="vsp-dd-btn" style="text-decoration:none;display:inline-flex;align-items:center;gap:6px;${disabled?'opacity:.55;pointer-events:none;':''}"
      href="${url?String(url).replace(/"/g,'&quot;'):'#'}" target="_blank" rel="noopener">
      Open <b style="color:#e2e8f0">${name}</b>
    </a>`;
  }

  // Monkey patch: wrap the existing render to decorate artifacts area after it renders
  const _origRender = window.VSP_DASH_DRILLDOWN.render;
  window.VSP_DASH_DRILLDOWN.render = async function(){
    await _origRender();

    try{
      const body = document.getElementById("vsp-dd-body");
      if(!body) return;

      // Fetch artifacts again to pin + show quick actions (cheap)
      const title = document.getElementById("vsp-dd-title");
      const rid = (title && title.textContent && title.textContent.includes("•")) ? title.textContent.split("•").pop().trim() : null;
      if(!rid) return;

      const r = await fetch(`/api/vsp/run_artifacts_index_v1/${encodeURIComponent(rid)}`, {headers:{'Accept':'application/json'}});
      const j = await r.json();
      const items = _pinSort((j && j.items) ? j.items : []);

      const quick = items.slice(0,5).map(it=>{
        const nm = it.name.split("/").pop();
        return _qBtn(nm, it.url);
      }).join("");

      // Inject a top "Quick open" strip
      let q = document.getElementById("vsp-dd-quickopen");
      if(!q){
        q = document.createElement("div");
        q.id = "vsp-dd-quickopen";
        q.className="vsp-dd-card";
        q.innerHTML = `<div style="font-weight:800;color:#e2e8f0;margin-bottom:8px;">Quick open</div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;">${quick}</div>`;
        body.prepend(q);
      } else {
        const _box = q.querySelector("div[style*=\"display:flex\"]");
      if(_box) _box.innerHTML = quick;
      }

      // Replace the artifacts section in Overview card (best-effort)
      const cards = body.querySelectorAll(".vsp-dd-card");
      let overview = null;
      for(const c of cards){
        if((c.textContent||"").includes("Overview")){ overview = c; break; }
      }
      if(overview){
        const links = items.slice(0,10).map(it=>{
          const nm = it.name;
          if(it.url) return `<a class="vsp-dd-link" href="${it.url}" target="_blank" rel="noopener">${nm}</a>`;
          return `<span class="vsp-dd-muted">${nm} (missing)</span>`;
        }).join(" ");
        // find "Artifacts:" label
        const html = overview.innerHTML;
        const rep = `<div class="vsp-dd-muted">Artifacts:</div><div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:6px;">${links || '<span class="vsp-dd-muted">empty</span>'}</div>`;
        overview.innerHTML = html.replace(/<div class="vsp-dd-muted">Artifacts:[\s\S]*?<\/div>\s*<\/div>\s*<\/div>/m, rep + "</div></div>")
                                .replace(/<div class="vsp-dd-muted">Artifacts:[\s\S]*?<\/div>/m, rep);
      }
    }catch(e){
      console.warn("[DRILL_ART_V2] err", e);
    }
  };

  console.log("[DRILL_ART_V2] installed");
})();

VSP_DASH_OPEN_REPORT_BTN_V1

/* VSP_DASH_OPEN_REPORT_BTN_V1: open CIO report for live RID */
(function(){
  'use strict';
  function normRid(x){
    if(!x) return "";
    return String(x).trim().replace(/^RID:\s*/i,'').replace(/^RUN_/i,'');
  }
  function getRid(){
    try{
      return normRid(localStorage.getItem("vsp_rid_selected_v2") || localStorage.getItem("vsp_rid_selected") || "");
    }catch(e){ return ""; }
  }

  function inject(){
    // try to attach near badges bar if exists; else top of body
    const host = document.getElementById("vsp-dash-p1-badges") || document.body;
    if(!host) return;

    if(document.getElementById("vsp-open-cio-report-btn")) return;

    const btn = document.createElement("button");
    btn.id = "vsp-open-cio-report-btn";
    btn.textContent = "Open CIO Report";
    btn.style.cssText = "margin-left:10px; padding:8px 10px; border-radius:10px; font-size:12px; border:1px solid rgba(148,163,184,.35); background:rgba(2,6,23,.55); color:#e2e8f0; cursor:pointer;";
    btn.addEventListener("click", function(){
      const rid = getRid();
      if(!rid){ alert("No RID selected"); return; }
      window.open("/vsp/report_cio_v1/" + encodeURIComponent(rid), "_blank", "noopener");
    });

    // put into badges bar if possible
    if(host && host.id === "vsp-dash-p1-badges"){
      host.appendChild(btn);
    }else{
      document.body.insertBefore(btn, document.body.firstChild);
    }
  }

  if(document.readyState === "loading") document.addEventListener("DOMContentLoaded", inject);
  else inject();
})();

VSP_DASH_KPI_EFFECTIVE_DEGRADED_P1_V4

/* VSP_DASH_KPI_EFFECTIVE_DEGRADED_P1_V4: show effective/raw + overrides delta + degraded clickable logs */
(function(){
  'use strict';

  function normRid(x){
    if(!x) return "";
    return String(x).trim().replace(/^RID:\s*/i,'').replace(/^RUN_/i,'');
  }
  function getRid(){
    try{
      return normRid(localStorage.getItem("vsp_rid_selected_v2") || localStorage.getItem("vsp_rid_selected") || "");
    }catch(e){ return ""; }
  }
  async function jget(url){
    const r = await fetch(url, {cache:"no-store"});
    const ct = (r.headers.get("content-type")||"");
    if(!r.ok) throw new Error("HTTP "+r.status+" "+url);
    if(ct.includes("application/json")) return await r.json();
    // tolerate non-json
    return {ok:false, _nonjson:true, text: await r.text()};
  }
  function ensureBar(){
    let bar = document.getElementById("vsp-dash-p1-badges");
    if(!bar){
      bar = document.createElement("div");
      bar.id="vsp-dash-p1-badges";
      bar.style.cssText="position:sticky;top:0;z-index:9999;margin:10px 0;padding:10px;border-radius:14px;border:1px solid rgba(148,163,184,.18);background:rgba(2,6,23,.45);backdrop-filter: blur(6px);display:flex;flex-wrap:wrap;gap:10px;align-items:center;";
      document.body.insertBefore(bar, document.body.firstChild);
    }
    return bar;
  }
  function pill(txt, tone){
    const map = {
      ok: "border:1px solid rgba(34,197,94,.35);",
      warn:"border:1px solid rgba(245,158,11,.35);",
      bad: "border:1px solid rgba(239,68,68,.35);",
      info:"border:1px solid rgba(148,163,184,.25);"
    };
    return `<span style="display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:rgba(2,6,23,.35);color:#e2e8f0;font-size:12px;${map[tone]||map.info}">${txt}</span>`;
  }
  function linkPill(label, url, tone){
    const map = {
      ok: "border:1px solid rgba(34,197,94,.35);",
      warn:"border:1px solid rgba(245,158,11,.35);",
      bad: "border:1px solid rgba(239,68,68,.35);",
      info:"border:1px solid rgba(148,163,184,.25);"
    };
    return `<a target="_blank" rel="noopener" href="${url}"
      style="display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:rgba(2,6,23,.35);color:#e2e8f0;font-size:12px;text-decoration:none;${map[tone]||map.info}">
      ${label}</a>`;
  }

  function pickLogRel(tool){
    const t = String(tool||"").toLowerCase();
    if(t.includes("kics")) return "kics/kics.log";
    if(t.includes("trivy")) return "trivy/trivy.json.err";
    if(t.includes("codeql")) return "codeql/codeql.log";
    if(t.includes("semgrep")) return "semgrep/semgrep.json";
    if(t.includes("gitleaks")) return "gitleaks/gitleaks.json";
    if(t.includes("bandit")) return "bandit/bandit.json";
    if(t.includes("syft")) return "syft/syft.json";
    if(t.includes("grype")) return "grype/grype.json";
    return "";
  }
  function artUrl(rid, rel){
    return "/api/vsp/run_artifact_raw_v1/" + encodeURIComponent(rid) + "?rel=" + encodeURIComponent(rel);
  }

  async function render(){
    const bar = ensureBar();
    const rid = getRid() || (await jget("/api/vsp/latest_rid_v1")).run_id;
    const ridN = normRid(rid||"");
    if(!ridN){
      bar.innerHTML = pill("RID: (none)", "warn") + pill("No RID selected", "warn");
      return;
    }

    let eff=null, st=null;
    try{
      eff = await jget("/api/vsp/findings_effective_v1/" + encodeURIComponent(ridN) + "?limit=0");
    }catch(e){
      eff = {ok:false, error:String(e)};
    }
    try{
      st = await jget("/api/vsp/run_status_v2/" + encodeURIComponent(ridN));
    }catch(e){
      st = {ok:false, error:String(e)};
    }

    const rawTotal = eff && typeof eff.raw_total==="number" ? eff.raw_total : null;
    const effTotal = eff && typeof eff.effective_total==="number" ? eff.effective_total : null;
    const d = (eff && eff.delta) ? eff.delta : {};
    const sup = (d && typeof d.suppressed_n==="number") ? d.suppressed_n : null;
    const chg = (d && typeof d.changed_severity_n==="number") ? d.changed_severity_n : null;
    const match = (d && typeof d.matched_n==="number") ? d.matched_n : null;
    const applied = (d && typeof d.applied_n==="number") ? d.applied_n : null;

    const degraded = (st && st.degraded_tools && Array.isArray(st.degraded_tools)) ? st.degraded_tools : [];
    const degrN = degraded.length;

    let html = "";
    html += pill("RID: "+ridN, "info");
    if(rawTotal!=null && effTotal!=null){
      const tone = (effTotal < rawTotal) ? "ok" : "info";
      html += pill(`Effective ${effTotal} / Raw ${rawTotal}`, tone);
    }else{
      html += pill("Effective/Raw: n/a", "warn");
    }

    if(match!=null) html += pill(`Overrides matched: ${match}`, "info");
    if(applied!=null) html += pill(`Overrides applied: ${applied}`, applied>0 ? "ok" : "info");
    if(sup!=null) html += pill(`Suppressed: ${sup}`, sup>0 ? "ok" : "info");
    if(chg!=null) html += pill(`Severity changed: ${chg}`, chg>0 ? "ok" : "info");

    // degraded clickable
    if(degrN>0){
      html += pill(`Degraded tools: ${degrN}`, "warn");
      degraded.slice(0,8).forEach(t=>{
        const rel = pickLogRel(t);
        if(rel) html += linkPill(`${t} log`, artUrl(ridN, rel), "warn");
        else html += pill(String(t), "warn");
      });
    }else{
      html += pill("Degraded: 0", "ok");
    }

    // quick links
    html += linkPill("CIO Report", "/vsp/report_cio_v1/"+encodeURIComponent(ridN), "info");
    html += linkPill("Unified.json", artUrl(ridN,"findings_unified.json"), "info");
    html += linkPill("Effective.json", artUrl(ridN,"findings_effective.json"), "info");

    bar.innerHTML = html;
  }

  // initial + refresh when RID changes (poll)
  let lastRid="";
  async function tick(){
    const rid=getRid();
    if(rid && rid!==lastRid){
      lastRid=rid;
      await render();
    }
  }

  if(document.readyState==="loading"){
    document.addEventListener("DOMContentLoaded", ()=>{ render(); setInterval(tick, 1200); });
  }else{
    render(); setInterval(tick, 1200);
  }
})();

/* VSP_DASH_TREND_SPARKLINE_V1_BEGIN */
(function(){
  'use strict';
  if (window.__VSP_DASH_TREND_SPARKLINE_V1_INSTALLED) return;
  window.__VSP_DASH_TREND_SPARKLINE_V1_INSTALLED = true;

  const LOGP = "[VSP_TREND]";
  const API = "/api/vsp/runs_index_v3_fs_resolved?limit=20&hide_empty=0&filter=1";

  function q(sel){ try{return document.querySelector(sel);}catch(e){return null;} }
  function mountPoint(){
    return (
      q("#vsp4-dashboard") ||
      q("#tab-dashboard") ||
      q("[data-tab='dashboard']") ||
      q("#dashboard") ||
      q(".vsp-dashboard") ||
      q("main") ||
      document.body
    );
  }
  function el(tag, attrs, children){
    const n=document.createElement(tag);
    if (attrs){
      for (const k of Object.keys(attrs)){
        if (k === "class") n.className = attrs[k];
        else if (k === "style") n.setAttribute("style", attrs[k]);
        else n.setAttribute(k, attrs[k]);
      }
    }
    (children||[]).forEach(c=>{
      if (c==null) return;
      if (typeof c === "string") n.appendChild(document.createTextNode(c));
      else n.appendChild(c);
    });
    return n;
  }

  function drawSpark(canvas, series){
    if (!canvas) return;
    const ctx = canvas.getContext("2d");
    const w = canvas.width, h = canvas.height;
    ctx.clearRect(0,0,w,h);

    if (!Array.isArray(series) || series.length < 2){
      ctx.globalAlpha = 0.6;
      ctx.fillText("no data", 6, 14);
      ctx.globalAlpha = 1;
      return;
    }
    let min=Infinity, max=-Infinity;
    for (const v of series){
      if (typeof v !== "number" || !isFinite(v)) continue;
      min = Math.min(min, v);
      max = Math.max(max, v);
    }
    if (!isFinite(min) || !isFinite(max)){ min=0; max=1; }
    if (max === min) max = min + 1;

    const pad = 6;
    const xStep = (w - pad*2) / (series.length - 1);
    function y(v){
      const t = (v - min) / (max - min);
      return (h - pad) - t * (h - pad*2);
    }

    // mid grid
    ctx.globalAlpha = 0.18;
    ctx.beginPath();
    ctx.moveTo(pad, Math.round(h/2)+0.5);
    ctx.lineTo(w-pad, Math.round(h/2)+0.5);
    ctx.stroke();
    ctx.globalAlpha = 1;

    // line
    ctx.beginPath();
    for (let i=0;i<series.length;i++){
      const v = (typeof series[i] === "number" && isFinite(series[i])) ? series[i] : 0;
      const xx = pad + i*xStep;
      const yy = y(v);
      if (i===0) ctx.moveTo(xx,yy);
      else ctx.lineTo(xx,yy);
    }
    ctx.lineWidth = 2;
    ctx.stroke();

    // last dot
    const lastV = (typeof series[series.length-1] === "number" && isFinite(series[series.length-1])) ? series[series.length-1] : 0;
    ctx.beginPath();
    ctx.arc(w-pad, y(lastV), 2.6, 0, Math.PI*2);
    ctx.fill();
  }

  function fmtInt(n){ try { return (Number(n)||0).toLocaleString(); } catch(e){ return String(n||0); } }

  async function run(){
    try{
      const res = await fetch(API, {cache:"no-store"});
      if (!res.ok) { console.warn(LOGP, "runs_index not ok", res.status); return; }
      const js = await res.json();
      const items = (js && js.items) ? js.items : [];
      if (!Array.isArray(items) || items.length === 0) return;

      const rows = items.slice().reverse(); // old->new
      const findings = rows.map(it => Number(it.total_findings ?? it.findings_total ?? it.total ?? 0) || 0);
      const degraded = rows.map(it => {
        const any = (it.degraded_any ?? it.is_degraded);
        const dn = Number(it.degraded_n ?? it.degraded_count ?? 0) || 0;
        return (any === true || dn > 0) ? 1 : 0;
      });

      const latest = rows[rows.length-1] || {};
      const latestRid = latest.run_id || latest.id || "";

      const root = mountPoint();
      if (!root) return;
      if (q("#vsp-trend-sparkline-card")) return;

      const card = el("div", {
        id: "vsp-trend-sparkline-card",
        class: "vsp-card vsp-card-trend",
        style: "margin-top:14px;border:1px solid rgba(148,163,184,.16);background:rgba(2,6,23,.72);border-radius:14px;padding:14px 14px 12px;box-shadow:0 10px 30px rgba(0,0,0,.25)"
      });

      const header = el("div", {style:"display:flex;justify-content:space-between;gap:12px;align-items:baseline;flex-wrap:wrap;"}, [
        el("div", null, [
          el("div", {style:"font-weight:700;font-size:14px;letter-spacing:.2px;"}, ["Trend (last 20 runs)"]),
          el("div", {style:"opacity:.75;font-size:12px;margin-top:4px;"}, [
            "Latest: ", latestRid ? latestRid : "(unknown)",
            " • Findings: ", fmtInt(findings[findings.length-1]),
            " • Degraded: ", degraded[degraded.length-1] ? "YES" : "NO"
          ])
        ])
      ]);

      const grid = el("div", {style:"display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px;"});
      function panel(title, id){
        const c = el("canvas", {id, width:"520", height:"88", style:"width:100%;height:88px;border-radius:12px;border:1px solid rgba(148,163,184,.12);background:rgba(15,23,42,.55);"});
        const box = el("div", {style:"padding:10px 10px 8px;border-radius:12px;background:rgba(15,23,42,.35);border:1px solid rgba(148,163,184,.10);"}, [
          el("div", {style:"font-size:12px;opacity:.8;margin-bottom:8px;font-weight:600;"}, [title]),
          c
        ]);
        return {box, c};
      }
      const p1 = panel("Total Findings", "vsp-trend-findings");
      const p2 = panel("Degraded (0/1)", "vsp-trend-degraded");
      grid.appendChild(p1.box); grid.appendChild(p2.box);

      card.appendChild(header);
      card.appendChild(grid);

      const anchor = q("#vsp-kpi-wrap") || q("#vsp-kpi-cards") || q(".vsp-kpi") || null;
      if (anchor && anchor.parentElement) anchor.parentElement.insertBefore(card, anchor.nextSibling);
      else root.appendChild(card);

      try{
        const css = window.getComputedStyle(card);
        [p1.c, p2.c].forEach(cv=>{
          const ctx=cv.getContext("2d");
          ctx.strokeStyle = css.color || "#e5e7eb";
          ctx.fillStyle = css.color || "#e5e7eb";
        });
      }catch(e){}

      drawSpark(p1.c, findings);
      drawSpark(p2.c, degraded);

      p1.c.title = "Total Findings (old→new): " + findings.join(", ");
      p2.c.title = "Degraded (old→new): " + degraded.join(", ");

      console.log(LOGP, "trend rendered", {points: rows.length});
    }catch(e){
      console.warn(LOGP, "trend error", e);
    }
  }

  if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", run);
  else run();
})();
 /* VSP_DASH_TREND_SPARKLINE_V1_END */

/* VSP_DASH_TREND_SPARKLINE_V2_BEGIN */
(function(){
  'use strict';

  function $(sel){ return document.querySelector(sel); }
  function el(tag, cls){ const e=document.createElement(tag); if(cls) e.className=cls; return e; }
  function sstr(x){ return (typeof x === 'string') ? x.trim() : ''; }

  function findKpiMount(){
    // try common containers (robust across templates)
    const cands = [
      '#vsp-kpi-row', '#kpi-row', '#kpi-cards', '.vsp-kpi-row', '.kpi-row',
      '.vsp-kpi-grid', '.kpi-grid', '.dashboard-kpis', '.dashboard-kpi-grid',
      '.vsp-main .vsp-grid', '.vsp-main'
    ];
    for (const sel of cands){
      const n = document.querySelector(sel);
      if (n) return n;
    }
    // fallback: first large section in dashboard pane
    return document.querySelector('#pane-dashboard, #tab-dashboard, main') || document.body;
  }

  async function fetchRuns(){
    try{
      const res = await fetch('/api/vsp/runs_index_v3_fs_resolved?limit=12&hide_empty=0&filter=1', {credentials:'same-origin'});
      if (!res.ok) return [];
      const js = await res.json();
      return js.items || [];
    }catch(_e){
      return [];
    }
  }

  function parseKeyFromRid(rid){
    rid = sstr(rid);
    const m = rid.match(/(\d{8})_(\d{6})/);
    if (!m) return null;
    return m[1] + m[2];
  }

  function buildSeries(items){
    // sort ascending by rid timestamp
    const arr = (items||[]).map(it=>{
      const rid = sstr(it.run_id || it.rid || '');
      const key = parseKeyFromRid(rid) || rid;
      const v = Number(it.total_findings ?? it.findings_total ?? it.total ?? 0) || 0;
      return {rid, key, v};
    }).filter(x=>x.rid && x.key).sort((a,b)=> (a.key>b.key?1:(a.key<b.key?-1:0)));
    // keep last 10
    return arr.slice(Math.max(0, arr.length-10));
  }

  function drawSpark(canvas, series){
    const ctx = canvas.getContext('2d');
    const w = canvas.width, h = canvas.height;
    ctx.clearRect(0,0,w,h);

    if (!series || series.length < 2){
      // empty state
      ctx.globalAlpha = 0.5;
      ctx.beginPath();
      ctx.moveTo(6, h/2);
      ctx.lineTo(w-6, h/2);
      ctx.stroke();
      ctx.globalAlpha = 1;
      return;
    }

    const vals = series.map(x=>x.v);
    let vmin = Math.min.apply(null, vals);
    let vmax = Math.max.apply(null, vals);
    if (vmax === vmin) vmax = vmin + 1;

    const pad = 6;
    const dx = (w - pad*2) / (series.length - 1);

    ctx.lineWidth = 2;
    ctx.beginPath();
    for (let i=0;i<series.length;i++){
      const v = series[i].v;
      const x = pad + i*dx;
      const y = pad + (h - pad*2) * (1 - (v - vmin) / (vmax - vmin));
      if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    }
    ctx.stroke();

    // end dot
    const last = series[series.length-1].v;
    const x = pad + (series.length-1)*dx;
    const y = pad + (h - pad*2) * (1 - (last - vmin) / (vmax - vmin));
    ctx.beginPath(); ctx.arc(x,y,3,0,Math.PI*2); ctx.fill();
  }

  function ensureCard(){
    const id = 'vsp-trend-spark-card-v2';
    let card = document.getElementById(id);
    if (card) return card;

    const mount = findKpiMount();

    card = el('div', 'vsp-card dashboard-card');
    card.id = id;
    card.style.maxWidth = '420px';
    card.style.padding = '12px 14px';
    card.style.borderRadius = '14px';
    card.style.margin = '8px 8px 8px 0';

    const h = el('div');
    h.style.display='flex';
    h.style.justifyContent='space-between';
    h.style.alignItems='baseline';
    h.style.gap='10px';

    const title = el('div');
    title.innerHTML = '<div style="font-weight:700;letter-spacing:.2px">Trend (last 10)</div><div style="opacity:.7;font-size:12px">Total findings by run</div>';

    const stat = el('div');
    stat.id = 'vsp-trend-spark-stat-v2';
    stat.style.textAlign='right';
    stat.style.fontWeight='700';

    h.appendChild(title);
    h.appendChild(stat);

    const canvas = el('canvas');
    canvas.id = 'vsp-trend-spark-cv-v2';
    canvas.width = 360;
    canvas.height = 64;
    canvas.style.width = '100%';
    canvas.style.height = '64px';
    canvas.style.marginTop = '10px';
    canvas.style.borderRadius = '10px';

    card.appendChild(h);
    card.appendChild(canvas);

    // prepend so it appears early
    if (mount && mount.firstChild) mount.insertBefore(card, mount.firstChild);
    else (mount || document.body).appendChild(card);

    return card;
  }

  async function render(){
    const card = ensureCard();
    if (!card) return;

    const items = await fetchRuns();
    const series = buildSeries(items);

    const stat = document.getElementById('vsp-trend-spark-stat-v2');
    const cv = document.getElementById('vsp-trend-spark-cv-v2');

    if (stat){
      const n = series.length;
      const last = n ? series[n-1].v : 0;
      const prev = n>1 ? series[n-2].v : 0;
      const delta = (n>1) ? (last - prev) : 0;
      const pct = (n>1 && prev) ? (delta * 100.0 / prev) : 0;
      stat.innerHTML = `<div style="font-size:16px">${last.toLocaleString()}</div><div style="opacity:.75;font-size:12px">${(delta>=0?'+':'')}${delta.toLocaleString()} (${(pct>=0?'+':'')}${pct.toFixed(1)}%)</div>`;
    }
    if (cv && cv.getContext) drawSpark(cv, series);
  }

  // run on dashboard load and also after refresh clicks
  document.addEventListener('DOMContentLoaded', function(){
    setTimeout(render, 650);
    document.addEventListener('click', function(ev){
      const t = ev.target;
      if (!t) return;
      const txt = (t.textContent||'').toLowerCase();
      if (txt.includes('refresh')) setTimeout(render, 400);
    }, true);
  });
})();
 /* VSP_DASH_TREND_SPARKLINE_V2_END */


})();
/* ==== END: static/js/vsp_dashboard_enhance_v1.js ==== */

/* ==== BEGIN: static/js/vsp_dashboard_charts_bootstrap_v1.js ==== */
(function(){
'use strict';
/* VSP_DASHBOARD_CHARTS_BOOTSTRAP_V1 (P0 commercial v2)
 * - bounded retries
 * - always attempts initAll (even if container heuristic fails)
 * - empty-state has safe fallback mount (main/body) => no "missing chart container" warn
 */
(function(){
  'use strict';

  if (window.__VSP_CHARTS_BOOT_SAFE_V4) return;
  window.__VSP_CHARTS_BOOT_SAFE_V4 = true;

  const TAG = 'VSP_CHARTS_BOOT_SAFE_V4';
  const MAX_TRIES = 8;
  const BASE_DELAY_MS = 250;

  let tries = 0;
  let locked = false;
  let lastReason = '';
  let warnedOnce = false;

  const SELS = [
    '#vsp_charts_root',
    '#vsp_charts_container',
    '#vsp-dashboard-charts',
    '#dashboard_charts',
    '#charts_container',
    '#chart-container',
    '.vsp-charts',
    '[data-vsp-charts]',
    '[data-vsp-charts-root]'
  ];

  function nowISO(){ try { return new Date().toISOString(); } catch(_) { return ''; } }

  function esc(s){
    return String(s ?? '')
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'","&#039;");
  }

  function pickMount(){
    // 1) explicit known selectors
    for (const s of SELS){
      const el = document.querySelector(s);
      if (el) return el;
    }

    // 2) heuristic: find chart cards by common classes
    const card = document.querySelector('.vsp-card .chart, .dashboard-card .chart, .vsp-card, .dashboard-card');
    if (card) return card;

    // 3) safe fallback: main/app/root/body (commercial: always render somewhere)
    return document.querySelector('main') ||
           document.querySelector('#app') ||
           document.querySelector('#root') ||
           document.body;
  }

  function ensureStyles(){
    if (document.getElementById('vsp-charts-empty-style-v2')) return;
    const st = document.createElement('style');
    st.id = 'vsp-charts-empty-style-v2';
    st.textContent = `
      .vsp-charts-empty{border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.03);
        border-radius:14px;padding:14px;margin-top:10px}
      .vsp-charts-empty-hd{display:flex;align-items:center;justify-content:space-between;gap:10px}
      .vsp-charts-empty-title{font-weight:800;letter-spacing:.2px}
      .vsp-charts-empty-sub{margin-top:6px;font-size:12px;opacity:.85;display:grid;gap:4px}
      .vsp-charts-empty-reason{font-size:12px;opacity:.75}
      .vsp-charts-empty-btn{margin-top:10px;display:inline-flex;align-items:center;gap:8px;
        padding:7px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.14);
        background:rgba(255,255,255,.06);cursor:pointer;font-weight:700;font-size:12px}
      .vsp-charts-empty-btn:hover{background:rgba(255,255,255,.10)}
      .vsp-charts-empty-pill{font-size:12px;font-weight:900;padding:5px 10px;border-radius:999px;
        border:1px solid rgba(255,255,255,.12);background:rgba(255,190,0,.14)}
    `;
    document.head.appendChild(st);
  }

  function renderEmptyState(reason){
    ensureStyles();
    const mount = pickMount();

    const html = `
      <div class="vsp-charts-empty" data-vsp-charts-empty="1">
        <div class="vsp-charts-empty-hd">
          <div class="vsp-charts-empty-title">Charts</div>
          <div class="vsp-charts-empty-pill">WAITING</div>
        </div>
        <div class="vsp-charts-empty-sub">
          <div class="vsp-charts-empty-reason">${esc(reason || 'waiting for chart data')}</div>
          <div>Updated: ${esc(nowISO())}</div>
        </div>
        <button class="vsp-charts-empty-btn" type="button" id="vspChartsRetryBtn">Retry charts</button>
      </div>
    `;

    const existing = mount.querySelector ? mount.querySelector('[data-vsp-charts-empty="1"]') : null;
    if (existing){
      const rr = existing.querySelector('.vsp-charts-empty-reason');
      if (rr) rr.textContent = reason || 'waiting for chart data';
    } else if (mount && mount.prepend){
      const w = document.createElement('div');
      w.innerHTML = html;
      mount.prepend(w.firstElementChild);
    }

    const btn = (mount && mount.querySelector) ? mount.querySelector('#vspChartsRetryBtn') : null;
    if (btn && !btn.__bound){
      btn.__bound = true;
      btn.addEventListener('click', function(){
        tries = 0; locked = false;
        scheduleTry('manual retry');
      });
    }
  }

  function clearEmptyState(){
    const mount = pickMount();
    const el = (mount && mount.querySelector) ? mount.querySelector('[data-vsp-charts-empty="1"]') : null;
    if (el) el.remove();
  }

  function pickEngine(){
    if (window.VSP_CHARTS_ENGINE_V3 && typeof window.VSP_CHARTS_ENGINE_V3.initAll === 'function'){
      return { tag:'VSP_CHARTS_ENGINE_V3', eng: window.VSP_CHARTS_ENGINE_V3 };
    }
    if (window.VSP_CHARTS_ENGINE && typeof window.VSP_CHARTS_ENGINE.initAll === 'function'){
      return { tag:'VSP_CHARTS_ENGINE', eng: window.VSP_CHARTS_ENGINE };
    }
    if (typeof window.vspChartsInitAll === 'function'){
      return { tag:'window.vspChartsInitAll', eng: { initAll: window.vspChartsInitAll } };
    }
    return null;
  }

  function computeDelay(n){ return Math.min(1200, BASE_DELAY_MS + (n * 120)); }

  async function tryInit(reasonTag){
    if (locked) return false;
    locked = true;
    tries += 1;

    const pe = pickEngine();
    if (!pe){
      lastReason = 'charts module not loaded (engine missing)';
      locked = false;
      return false;
    }

    try{
      pe.eng.initAll(reasonTag || TAG);
      clearEmptyState();
      console.log(`[${TAG}] initAll OK via`, pe.tag, 'tries=', tries);
      return true;
    }catch(e){
      lastReason = `initAll failed: ${e && e.message ? e.message : String(e)}`;
      if (!warnedOnce){
        warnedOnce = true;
        console.warn(`[${TAG}] initAll failed (bounded retry)`, e);
      }
      locked = false;
      return false;
    }
  }

  function scheduleTry(tag){
    const delay = computeDelay(tries);
    setTimeout(async () => {
      const ok = await tryInit(tag);
      if (ok) return;

      if (tries >= MAX_TRIES){
        renderEmptyState(lastReason || `no chart data (tries=${tries}/${MAX_TRIES})`);
        console.log(`[${TAG}] done: empty-state shown; tries=${tries}/${MAX_TRIES}; reason=`, lastReason);
        return;
      }

      renderEmptyState(lastReason || `waiting for chart data (tries=${tries}/${MAX_TRIES})`);
      scheduleTry(tag);
    }, delay);
  }

  function boot(){
    tries = 0; locked = false; lastReason = ''; warnedOnce = false;
    scheduleTry('boot');
  }

  window.VSP_CHARTS_BOOT_SAFE_V4 = { boot, refresh: () => scheduleTry('refresh') };

  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', boot, { once:true });
  } else {
    boot();
  }

  window.addEventListener('vsp:rid_changed', () => scheduleTry('rid_changed'));
})();

})();
/* ==== END: static/js/vsp_dashboard_charts_bootstrap_v1.js ==== */

/* ==== BEGIN: static/js/vsp_dashboard_charts_pretty_v3.js ==== */
(function(){
'use strict';
/* vsp_dashboard_charts_pretty_v3.js
 * CLEAN REBUILD (no Chart.js dependency)
 * - Exports: window.VSP_CHARTS_ENGINE_V3.initAll(dash)
 * - Auto-creates canvases inside placeholders:
 *     #vsp-chart-severity, #vsp-chart-trend, #vsp-chart-bytool, #vsp-chart-topcwe
 * - Dispatches: window event "vsp:charts-ready"
 */
(function () {
  "use strict";
  console.log("[VSP_CHARTS_V3] pretty charts loaded (CLEAN REBUILD v1)");

  if (window.__VSP_CHARTS_V3_REBUILD_LOADED) return;
  window.__VSP_CHARTS_V3_REBUILD_LOADED = true;

  var HOLDERS = {
    severity: "vsp-chart-severity",
    trend: "vsp-chart-trend",
    bytool: "vsp-chart-bytool",
    topcwe: "vsp-chart-topcwe"
  };

  function $(id) { return document.getElementById(id); }

  function ensureCanvasIn(holderId, canvasId) {
    var holder = $(holderId);
    if (!holder) return null;

    // if holder itself is a canvas
    if (holder.tagName && holder.tagName.toLowerCase() === "canvas") return holder;

    // existing canvas?
    var existing = holder.querySelector ? holder.querySelector("canvas") : null;
    if (existing) return existing;

    var c = document.createElement("canvas");
    c.id = canvasId;
    c.style.width = "100%";
    c.style.height = "100%";
    c.width = Math.max(480, holder.clientWidth || 480);
    c.height = Math.max(220, holder.clientHeight || 220);
    holder.appendChild(c);
    return c;
  }

  function resizeCanvasToHolder(canvas, holderId) {
    try {
      var holder = $(holderId);
      if (!holder || !canvas) return;
      var w = Math.max(480, holder.clientWidth || 480);
      var h = Math.max(220, holder.clientHeight || 220);
      if (canvas.width !== w) canvas.width = w;
      if (canvas.height !== h) canvas.height = h;
    } catch (e) {}
  }

  function clear(ctx) {
    ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
  }

  function drawText(ctx, text) {
    clear(ctx);
    ctx.save();
    ctx.fillStyle = "#cbd5e1";
    ctx.font = "14px Inter, system-ui, sans-serif";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText(text, ctx.canvas.width / 2, ctx.canvas.height / 2);
    ctx.restore();
  }

  function drawDonut(ctx, items) {
    // items: [{label, value}]
    clear(ctx);
    var W = ctx.canvas.width, H = ctx.canvas.height;
    var cx = W * 0.35, cy = H * 0.5;
    var rOuter = Math.min(W, H) * 0.28;
    var rInner = rOuter * 0.58;

    var sum = 0;
    for (var i=0;i<items.length;i++) sum += Math.max(0, +items[i].value || 0);
    if (!sum) return drawText(ctx, "No data");

    // palette (no hard theme dependency)
    var palette = ["#ef4444","#f97316","#f59e0b","#22c55e","#60a5fa","#a78bfa","#94a3b8"];
    var start = -Math.PI / 2;

    for (var j=0;j<items.length;j++) {
      var v = Math.max(0, +items[j].value || 0);
      var ang = (v / sum) * Math.PI * 2;
      ctx.beginPath();
      ctx.moveTo(cx, cy);
      ctx.arc(cx, cy, rOuter, start, start + ang, false);
      ctx.closePath();
      ctx.fillStyle = palette[j % palette.length];
      ctx.globalAlpha = 0.85;
      ctx.fill();
      start += ang;
    }
    ctx.globalAlpha = 1;

    // hole
    ctx.beginPath();
    ctx.arc(cx, cy, rInner, 0, Math.PI * 2);
    ctx.fillStyle = "#0b1020";
    ctx.fill();

    // total
    ctx.save();
    ctx.fillStyle = "#e5e7eb";
    ctx.font = "700 18px Inter, system-ui, sans-serif";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText(String(sum), cx, cy - 2);
    ctx.font = "12px Inter, system-ui, sans-serif";
    ctx.fillStyle = "#94a3b8";
    ctx.fillText("total", cx, cy + 18);
    ctx.restore();

    // legend
    var lx = W * 0.62, ly = H * 0.22;
    ctx.save();
    ctx.font = "12px Inter, system-ui, sans-serif";
    ctx.textAlign = "left";
    ctx.textBaseline = "middle";
    for (var k=0;k<items.length;k++) {
      var y = ly + k * 18;
      ctx.fillStyle = palette[k % palette.length];
      ctx.globalAlpha = 0.85;
      ctx.fillRect(lx, y - 6, 10, 10);
      ctx.globalAlpha = 1;
      ctx.fillStyle = "#cbd5e1";
      ctx.fillText(items[k].label + ": " + (items[k].value || 0), lx + 14, y);
    }
    ctx.restore();
  }

  function drawBar(ctx, items, title) {
    clear(ctx);
    var W = ctx.canvas.width, H = ctx.canvas.height;
    if (!items || !items.length) return drawText(ctx, "No data");

    var max = 0;
    for (var i=0;i<items.length;i++) max = Math.max(max, +items[i].value || 0);
    if (!max) return drawText(ctx, "No data");

    var padL=48, padR=16, padT=28, padB=28;
    var plotW = W - padL - padR;
    var plotH = H - padT - padB;

    ctx.save();
    ctx.fillStyle = "#94a3b8";
    ctx.font = "12px Inter, system-ui, sans-serif";
    ctx.textAlign = "left";
    ctx.fillText(title || "Bar", padL, 18);
    ctx.restore();

    // axes
    ctx.save();
    ctx.strokeStyle = "rgba(255,255,255,0.08)";
    ctx.beginPath();
    ctx.moveTo(padL, padT);
    ctx.lineTo(padL, padT + plotH);
    ctx.lineTo(padL + plotW, padT + plotH);
    ctx.stroke();
    ctx.restore();

    var n = items.length;
    var gap = Math.max(6, plotW * 0.02);
    var bw = (plotW - gap * (n - 1)) / n;

    for (var j=0;j<n;j++) {
      var v = +items[j].value || 0;
      var h = (v / max) * plotH;
      var x = padL + j * (bw + gap);
      var y = padT + (plotH - h);

      ctx.fillStyle = "rgba(96,165,250,0.75)";
      ctx.fillRect(x, y, bw, h);

      ctx.save();
      ctx.fillStyle = "#cbd5e1";
      ctx.font = "11px Inter, system-ui, sans-serif";
      ctx.textAlign = "center";
      ctx.textBaseline = "top";
      var lab = items[j].label;
      if (lab && lab.length > 10) lab = lab.slice(0, 9) + "…";
      ctx.fillText(lab || "", x + bw/2, padT + plotH + 6);
      ctx.restore();
    }
  }

  function drawLine(ctx, series, title) {
    clear(ctx);
    var W = ctx.canvas.width, H = ctx.canvas.height;
    if (!series || series.length < 2) return drawText(ctx, "No trend data");

    var padL=48, padR=16, padT=28, padB=28;
    var plotW = W - padL - padR;
    var plotH = H - padT - padB;

    var min=Infinity, max=-Infinity;
    for (var i=0;i<series.length;i++) {
      var v = +series[i].value || 0;
      min = Math.min(min, v);
      max = Math.max(max, v);
    }
    if (max === min) { max = min + 1; }

    ctx.save();
    ctx.fillStyle = "#94a3b8";
    ctx.font = "12px Inter, system-ui, sans-serif";
    ctx.textAlign = "left";
    ctx.fillText(title || "Trend", padL, 18);
    ctx.restore();

    // axes
    ctx.save();
    ctx.strokeStyle = "rgba(255,255,255,0.08)";
    ctx.beginPath();
    ctx.moveTo(padL, padT);
    ctx.lineTo(padL, padT + plotH);
    ctx.lineTo(padL + plotW, padT + plotH);
    ctx.stroke();
    ctx.restore();

    function px(i) {
      return padL + (i / (series.length - 1)) * plotW;
    }
    function py(v) {
      return padT + (1 - (v - min) / (max - min)) * plotH;
    }

    ctx.save();
    ctx.strokeStyle = "rgba(34,197,94,0.85)";
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(px(0), py(series[0].value));
    for (var j=1;j<series.length;j++) {
      ctx.lineTo(px(j), py(series[j].value));
    }
    ctx.stroke();

    // points
    ctx.fillStyle = "rgba(34,197,94,0.9)";
    for (var k=0;k<series.length;k++) {
      ctx.beginPath();
      ctx.arc(px(k), py(series[k].value), 3, 0, Math.PI*2);
      ctx.fill();
    }
    ctx.restore();
  }

  function normalizeSeverity(dash) {
    var s = (dash && dash.by_severity) ? dash.by_severity : {};
    // accept either VSP levels or generic
    var keys = ["CRITICAL","HIGH","MEDIUM","LOW","INFO","TRACE"];
    var out = [];
    for (var i=0;i<keys.length;i++) {
      var k = keys[i];
      var v = 0;
      if (typeof s[k] === "number") v = s[k];
      else if (s[k] && typeof s[k].count === "number") v = s[k].count;
      out.push({ label: k, value: v });
    }
    return out;
  }

  function normalizeByTool(dash) {
    var bt = (dash && dash.by_tool) ? dash.by_tool : {};
    var items = [];
    // bt could be {tool:count} or {tool:{total}} etc.
    for (var k in bt) {
      if (!Object.prototype.hasOwnProperty.call(bt, k)) continue;
      var v = bt[k];
      var n = (typeof v === "number") ? v :
              (v && typeof v.total === "number") ? v.total :
              (v && typeof v.count === "number") ? v.count : 0;
      items.push({ label: k, value: n });
    }
    items.sort(function(a,b){ return (b.value||0) - (a.value||0); });
    return items.slice(0, 6);
  }

  function normalizeTopCWE(dash) {
    var list = (dash && dash.top_cwe_list) ? dash.top_cwe_list : [];
    var items = [];
    for (var i=0;i<list.length;i++) {
      var x = list[i] || {};
      var lab = x.cwe || x.id || x.name || ("CWE-" + (i+1));
      var v = x.count || x.n || x.total || 0;
      items.push({ label: String(lab), value: +v || 0 });
    }
    items.sort(function(a,b){ return (b.value||0)-(a.value||0); });
    return items.slice(0, 6);
  }

  function normalizeTrend(dash) {
    // If no historical series, create a tiny synthetic series from totals
    var total = (dash && dash.total_findings) ? +dash.total_findings :
                (dash && dash.summary_all && dash.summary_all.total_findings) ? +dash.summary_all.total_findings :
                (dash && dash.totals && dash.totals.total) ? +dash.totals.total : 0;
    if (!total) total = 0;
    return [
      { label: "t-3", value: Math.max(0, Math.round(total*0.55)) },
      { label: "t-2", value: Math.max(0, Math.round(total*0.72)) },
      { label: "t-1", value: Math.max(0, Math.round(total*0.88)) },
      { label: "now", value: total }
    ];
  }

  function dispatchReady(detail) {
    try {
      window.dispatchEvent(new CustomEvent("vsp:charts-ready", { detail: detail || { engine:"V3", ts: Date.now() } }));
    } catch (e) {
      try {
        var ev = document.createEvent("Event");
        ev.initEvent("vsp:charts-ready", true, true);
        window.dispatchEvent(ev);
      } catch (_) {}
    }
  }

  window.VSP_CHARTS_ENGINE_V3 = {
    initAll: function (dash) {
      try {
        // create canvases and render
        var cSev = ensureCanvasIn(HOLDERS.severity, "vsp-severity-canvas");
        var cTr  = ensureCanvasIn(HOLDERS.trend, "vsp-trend-canvas");
        var cBt  = ensureCanvasIn(HOLDERS.bytool, "vsp-bytool-canvas");
        var cCwe = ensureCanvasIn(HOLDERS.topcwe, "vsp-topcwe-canvas");

        if (cSev) resizeCanvasToHolder(cSev, HOLDERS.severity);
        if (cTr)  resizeCanvasToHolder(cTr,  HOLDERS.trend);
        if (cBt)  resizeCanvasToHolder(cBt,  HOLDERS.bytool);
        if (cCwe) resizeCanvasToHolder(cCwe, HOLDERS.topcwe);

        if (cSev) drawDonut(cSev.getContext("2d"), normalizeSeverity(dash));
        if (cTr)  drawLine(cTr.getContext("2d"), normalizeTrend(dash), "Findings trend (synthetic)");
        if (cBt)  drawBar(cBt.getContext("2d"), normalizeByTool(dash), "Top tools");
        if (cCwe) drawBar(cCwe.getContext("2d"), normalizeTopCWE(dash), "Top CWE");

        console.log("[VSP_CHARTS_V3] initAll OK");
        return true;
      } catch (e) {
        console.warn("[VSP_CHARTS_V3] initAll failed", e);
        return false;
      }
    }
  };

  // Auto-init if dashboard already stored data
  try {
    if (window.__VSP_DASH_LAST_DATA_V3) {
      window.VSP_CHARTS_ENGINE_V3.initAll(window.__VSP_DASH_LAST_DATA_V3);
    }
  } catch (e) {}

  // Inform other modules (dashboard enhance) that charts engine is ready
  dispatchReady({ engine: "V3", ts: Date.now() });

  // Re-render on resize (lightweight)
  window.addEventListener("resize", function () {
    try {
      if (window.__VSP_DASH_LAST_DATA_V3) {
        window.VSP_CHARTS_ENGINE_V3.initAll(window.__VSP_DASH_LAST_DATA_V3);
      }
    } catch (e) {}
  });

})();

// === VSP_CHARTS_READY_EVENT_V1 ===

(function(){
  try{
    if (window.__VSP_CHARTS_READY_EVENT_V1) return;
    window.__VSP_CHARTS_READY_EVENT_V1 = true;
    window.dispatchEvent(new CustomEvent('vsp:charts-ready', { detail: { engine: 'V3' } }));
    console.log('[VSP_CHARTS] vsp:charts-ready dispatched (V3).');
  }catch(e){}
})();


})();
/* ==== END: static/js/vsp_dashboard_charts_pretty_v3.js ==== */

/* ==== BEGIN: static/js/vsp_dashboard_charts_v1.js ==== */
(function(){
'use strict';

function vspNormalizeTopModule(m) {
  if (!m) return 'N/A';
  if (typeof m === 'string') return m;
  try {
    if (m.label) return String(m.label);
    if (m.path) return String(m.path);
    if (m.id)   return String(m.id);
    return String(m);
  } catch (e) {
    return 'N/A';
  }
}

'use strict';

(function () {
  const LOG = '[VSP_DASHBOARD_CHARTS]';

  function percent(part, total) {
    if (!total || total <= 0) return 0;
    return Math.round((part * 100) / total);
  }

  function renderSeverity(model) {
    const host = document.getElementById('vsp-chart-severity');
    if (!host) return;

    const sev =
      model.severity_cards ||
      model.summary_by_severity ||
      {};
    const total =
      model.total_findings ??
      model.total ??
      0;

    const order = ['CRITICAL', 'HIGH', 'MEDIUM', 'LOW', 'INFO', 'TRACE'];
    const labels = {
      CRITICAL: 'Critical',
      HIGH: 'High',
      MEDIUM: 'Medium',
      LOW: 'Low',
      INFO: 'Info',
      TRACE: 'Trace'
    };

    const rows = order.map(k => {
      const v = sev[k] ?? 0;
      const p = percent(v, total);
      return `
        <div class="vsp-chart-row">
          <div class="vsp-chart-label">${labels[k]}</div>
          <div class="vsp-chart-bar-wrap">
            <div class="vsp-chart-bar" style="width:${p}%;"></div>
          </div>
          <div class="vsp-chart-value">${v} (${p}%)</div>
        </div>
      `;
    }).join('');

    host.innerHTML = rows || '<div class="vsp-chart-empty">Chưa có dữ liệu severity.</div>';
  }

  function renderTopTool(model) {
    const host = document.getElementById('vsp-chart-tool');
    if (!host) return;

    const top = model.top_risky_tool_detail || model.top_risky_tool;
    if (!top || typeof top === 'string') {
      host.innerHTML = '<div class="vsp-chart-empty">Dữ liệu chi tiết theo tool chưa sẵn có.</div>';
      return;
    }

    const entries = Array.isArray(top) ? top : Object.entries(top);

    const rows = entries.map(([name, count]) => {
      const v = typeof count === 'number' ? count : (count.total || 0);
      return `
        <div class="vsp-chart-row">
          <div class="vsp-chart-label">${name}</div>
          <div class="vsp-chart-bar-wrap">
            <div class="vsp-chart-bar" style="width:100%;"></div>
          </div>
          <div class="vsp-chart-value">${v}</div>
        </div>
      `;
    }).join('');

    host.innerHTML = rows || '<div class="vsp-chart-empty">Không có dữ liệu tool.</div>';
  }

  function renderTopCwe(model) {
    const host = document.getElementById('vsp-chart-cwe');
    if (!host) return;

    const top = model.top_cwe_detail || model.top_impacted_cwe;
    if (!top || typeof top === 'string') {
      host.innerHTML = '<div class="vsp-chart-empty">Dữ liệu chi tiết theo CWE chưa sẵn có.</div>';
      return;
    }

    const entries = Array.isArray(top) ? top : Object.entries(top);

    const rows = entries.map(([name, count]) => {
      const v = typeof count === 'number' ? count : (count.total || 0);
      return `
        <div class="vsp-chart-row">
          <div class="vsp-chart-label">${name}</div>
          <div class="vsp-chart-bar-wrap">
            <div class="vsp-chart-bar" style="width:100%;"></div>
          </div>
          <div class="vsp-chart-value">${v}</div>
        </div>
      `;
    }).join('');

    host.innerHTML = rows || '<div class="vsp-chart-empty">Không có dữ liệu CWE.</div>';
  }

  function render(model) {
    if (!model) return;
    console.log(LOG, 'Render charts from model');
    renderSeverity(model);
    renderTopTool(model);
    renderTopCwe(model);
  }

  window.vspRenderChartsFromDashboard = render;

  document.addEventListener('DOMContentLoaded', function () {
    if (window.VSP_DASHBOARD_MODEL) {
      render(window.VSP_DASHBOARD_MODEL);
    }
  });
})();

})();
/* ==== END: static/js/vsp_dashboard_charts_v1.js ==== */

/* ==== BEGIN: static/js/vsp_dashboard_charts_v2.js ==== */
(function(){
'use strict';
// VSP_DASHBOARD_CHARTS_V2_STUB
// Legacy charts_v2 đã được thay bằng pretty_v3.

(function () {
  console.log('[VSP_CHARTS_V2_STUB] legacy charts_v2 replaced by pretty_v3');

  function forwardToV3(dashboard) {
    if (window.VSP_DASHBOARD_CHARTS_V3 &&
        typeof window.VSP_DASHBOARD_CHARTS_V3.updateFromDashboard === 'function') {
      try {
        window.VSP_DASHBOARD_CHARTS_V3.updateFromDashboard(dashboard);
      } catch (e) {
        console.error('[VSP_CHARTS_V2_STUB] error in V3 charts', e);
      }
    } else {
      console.warn('[VSP_CHARTS_V2_STUB] V3 charts chưa sẵn, skip.');
    }
  }

  // Global API mà vsp_dashboard_enhance_v1.js dùng
  window.VSP_DASHBOARD_CHARTS = window.VSP_DASHBOARD_CHARTS || {};
  window.VSP_DASHBOARD_CHARTS.updateFromDashboard = forwardToV3;
  window.vspDashboardChartsUpdateFromDashboard = forwardToV3;
})();

})();
/* ==== END: static/js/vsp_dashboard_charts_v2.js ==== */

/* ==== BEGIN: static/js/vsp_degraded_panel_hook_v1.js ==== */
(function(){
'use strict';
/* === VSP_DEGRADED_PANEL_HOOK_V1 ===
   - Hooks fetch() to detect /api/vsp/run_status_v1/<RID>
   - Renders a "Degraded Tools" panel inside Runs tab (if #vsp-tab-runs exists), else attaches to body.
*/
(function () {
  if (window.VSP_DEGRADED_PANEL_HOOK_V1) return;
  window.VSP_DEGRADED_PANEL_HOOK_V1 = true;

  function ensurePanel() {
    var host = document.getElementById('vsp-tab-runs') || document.body;
    var panel = document.getElementById('vsp-degraded-tools-panel-v1');
    if (!panel) {
      panel = document.createElement('div');
      panel.id = 'vsp-degraded-tools-panel-v1';
      panel.style.margin = '12px 0';
      panel.style.padding = '12px';
      panel.style.border = '1px solid rgba(255,255,255,0.08)';
      panel.style.borderRadius = '14px';
      panel.style.background = 'rgba(255,255,255,0.03)';
      panel.style.color = '#e5e7eb';
      panel.style.fontFamily = 'Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial';
      panel.style.fontSize = '13px';
      panel.innerHTML = '<div style="font-weight:700; font-size:14px; margin-bottom:8px;">Degraded Tools</div><div id="vsp-degraded-tools-body-v1">No data yet.</div>';
      host.appendChild(panel);
    }
    return panel;
  }

  function esc(s) {
    return String(s ?? '').replace(/[&<>"']/g, function (c) {
      return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]);
    });
  }

  function normalizeList(dt) {
    // dt may be: null | [] | {tool:{...}} | {items:[...]}
    if (!dt) return [];
    if (Array.isArray(dt)) return dt;
    if (Array.isArray(dt.items)) return dt.items;
    if (typeof dt === 'object') {
      // map -> list
      var out = [];
      Object.keys(dt).forEach(function (k) {
        var v = dt[k];
        if (v && typeof v === 'object' && !Array.isArray(v)) {
          var row = Object.assign({ tool: k }, v);
          out.push(row);
        }
      });
      return out;
    }
    return [];
  }

  function render(status) {
    var panel = ensurePanel();
    var body = document.getElementById('vsp-degraded-tools-body-v1');
    if (!body) return;

    var rid = status && (status.request_id || status.req_id || status.rid) || '';
    var finish = status && status.finish_reason;
    var stage = status && status.stage_sig;
    var prog = status && (status.progress_pct ?? null);

    var list = normalizeList(status && status.degraded_tools);

    var meta = '<div style="opacity:.9;margin-bottom:8px;">'
      + '<span style="opacity:.7">RID:</span> <code style="opacity:.95">' + esc(rid) + '</code>'
      + (finish ? ' &nbsp; <span style="opacity:.7">finish:</span> <b>' + esc(finish) + '</b>' : '')
      + (stage ? ' &nbsp; <span style="opacity:.7">stage:</span> <b>' + esc(stage) + '</b>' : '')
      + (prog !== null ? ' &nbsp; <span style="opacity:.7">progress:</span> <b>' + esc(prog) + '%</b>' : '')
      + '</div>';

    if (!list.length) {
      body.innerHTML = meta + '<div style="opacity:.8">No degraded tools reported.</div>';
      return;
    }

    var rows = list.map(function (x) {
      var tool = x.tool || x.name || x.tool_name || '';
      var reason = x.reason || x.status || x.error || '';
      var tsec = x.timeout_sec || x.timeout || x.timeout_seconds || '';
      var log = x.log || x.log_path || x.log_file || '';
      return '<tr>'
        + '<td style="padding:6px 8px; border-top:1px solid rgba(255,255,255,0.06);"><b>' + esc(tool) + '</b></td>'
        + '<td style="padding:6px 8px; border-top:1px solid rgba(255,255,255,0.06);">' + esc(reason) + '</td>'
        + '<td style="padding:6px 8px; border-top:1px solid rgba(255,255,255,0.06); text-align:right;">' + esc(tsec) + '</td>'
        + '<td style="padding:6px 8px; border-top:1px solid rgba(255,255,255,0.06);"><code>' + esc(log) + '</code></td>'
        + '</tr>';
    }).join('');

    body.innerHTML = meta
      + '<table style="width:100%; border-collapse:collapse;">'
      + '<thead><tr>'
      + '<th style="text-align:left; padding:6px 8px; opacity:.8;">Tool</th>'
      + '<th style="text-align:left; padding:6px 8px; opacity:.8;">Reason</th>'
      + '<th style="text-align:right; padding:6px 8px; opacity:.8;">Timeout(s)</th>'
      + '<th style="text-align:left; padding:6px 8px; opacity:.8;">Log</th>'
      + '</tr></thead><tbody>' + rows + '</tbody></table>';
  }

  // Hook fetch
  var _fetch = window.fetch;
  if (typeof _fetch !== 'function') return;

  window.fetch = function () {
    return _fetch.apply(this, arguments).then(function (resp) {
      try {
        var url = (arguments[0] && arguments[0].url) ? arguments[0].url : String(arguments[0] || '');
        if (url.indexOf('/api/vsp/run_status_v1/') >= 0) {
          resp.clone().json().then(function (data) {
            if (data && typeof data === 'object') render(data);
          }).catch(function(){});
        }
      } catch (e) {}
      return resp;
    });
  };

  // Ensure panel exists even before first fetch (Runs tab open)
  try { ensurePanel(); } catch(e) {}
})();

})();
/* ==== END: static/js/vsp_degraded_panel_hook_v1.js ==== */

/* ==== BEGIN: static/js/vsp_degraded_panel_hook_v3.js ==== */
(function(){
'use strict';

(function () {
  async function fetchJson(url) {
    const r = await fetch(url, { cache: "no-store" });
    if (!r.ok) throw new Error("HTTP " + r.status);
    return await r.json();
  }
  function ce(tag, cls) { var e = document.createElement(tag); if (cls) e.className = cls; return e; }
  function qs(sel, root) { return (root || document).querySelector(sel); }

  function ridFromUrl() {
    try { return new URL(location.href).searchParams.get("rid"); } catch (e) { return null; }
  }

  async function pickLatestRidSmart() {
    // take first RID that status_v2 can resolve
    const idx = await fetchJson("/api/vsp/runs_index_v3_fs?limit=10&hide_empty=0");
    const items = Array.isArray(idx.items) ? idx.items : [];
    for (const it of items) {
      const rid = it.req_id || it.request_id || it.run_id;
      if (!rid) continue;
      try {
        const st = await fetchJson("/api/vsp/run_status_v2/" + encodeURIComponent(rid));
        if (st && st.ok) return rid;
      } catch (e) {}
    }
    // fallback
    return (items[0] && (items[0].req_id || items[0].request_id || items[0].run_id)) || null;
  }

  function artifactUrlV2(rid, relPath) {
    return "/api/vsp/run_artifact_v2/" + encodeURIComponent(rid) + "?path=" + encodeURIComponent(relPath);
  }

  function toolLogPath(tool) {
    const t = (tool || "").toLowerCase();
    if (t === "kics") return "kics/kics.log";
    if (t === "semgrep") return "semgrep/semgrep.log";
    if (t === "codeql") return "codeql/codeql.log";
    if (t === "gitleaks") return "gitleaks/gitleaks.log";
    return "runner.log";
  }

  function pill(text, href) {
    var a = ce("a");
    a.textContent = text;
    a.href = href;
    a.target = "_blank";
    a.style.cssText = "opacity:.9; text-decoration:none; border:1px solid rgba(255,255,255,.12); padding:4px 8px; border-radius:10px;";
    return a;
  }

  function render(host, rid, st) {
    host = host || document.body;
    var panel = qs(".vsp-degraded-panel-v3", host);
    if (!panel) {
      panel = ce("div", "vsp-degraded-panel-v3");
      panel.style.cssText = "margin:12px 0; padding:12px; border:1px solid rgba(255,255,255,.08); border-radius:14px; background:rgba(255,255,255,.02)";
      host.prepend(panel);
    }

    const degraded = Array.isArray(st.degraded_tools) ? st.degraded_tools : [];
    const gate = degraded.length ? "AMBER" : (st.ok ? "GREEN" : "RED");

    panel.innerHTML = "";
    var top = ce("div");
    top.style.cssText = "display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:8px; flex-wrap:wrap;";
    var title = ce("div");
    title.innerHTML =
      "<b>Degraded tools</b> <span style='opacity:.7'>(" + gate + ")</span> " +
      "<span style='opacity:.55'>rid=" + (rid || "?") + "</span> " +
      "<span style='opacity:.55'>ci=" + (st.ci_run_dir ? "ok" : "null") + "</span>";
    var actions = ce("div");
    actions.style.cssText = "display:flex; gap:8px; align-items:center;";
    actions.appendChild(pill("degraded_tools.json", artifactUrlV2(rid, "degraded_tools.json")));
    actions.appendChild(pill("artifacts index", "/api/vsp/run_artifacts_index_v1/" + encodeURIComponent(rid)));
actions.appendChild(pill("runner.log", artifactUrlV2(rid, "runner.log")));
    top.appendChild(title);
    top.appendChild(actions);
    panel.appendChild(top);

    if (!st.ok) {
      var err = ce("div");
      err.style.opacity = ".85";
      err.textContent = "Status resolve failed: " + (st.error || "unknown");
      panel.appendChild(err);
      return;
    }

    if (!degraded.length) {
      var ok = ce("div");
      ok.style.opacity = ".8";
      ok.textContent = "No degraded tool detected.";
      panel.appendChild(ok);
      return;
    }

    degraded.forEach(function (d) {
      var row = ce("div");
      row.style.cssText = "display:flex; align-items:center; justify-content:space-between; gap:10px; padding:8px 0; border-top:1px solid rgba(255,255,255,.06)";
      var left = ce("div");
      left.innerHTML =
        "<b>" + (d.tool || "UNKNOWN") + "</b> — " + (d.reason || "degraded") +
        " <span style='opacity:.7'>(rc=" + (d.rc ?? "?") + ", ts=" + (d.ts ?? "?") + ")</span>";
      var right = ce("div");
      right.appendChild(pill("open log", artifactUrlV2(rid, toolLogPath(d.tool))));
      row.appendChild(left);
      row.appendChild(right);
      panel.appendChild(row);
    });
  }

  async function tick() {
    try {
      var rid = ridFromUrl() || await pickLatestRidSmart();
      if (!rid) return;
      var st = await fetchJson("/api/vsp/run_status_v2/" + encodeURIComponent(rid));
      render(document.body, rid, st);
    } catch (e) {}
  }

  window.addEventListener("DOMContentLoaded", function () {
    tick();
    setInterval(tick, 5000);
  });
})();

})();
/* ==== END: static/js/vsp_degraded_panel_hook_v3.js ==== */

/* ==== BEGIN: static/js/vsp_runs_commercial_panel_v1.js ==== */
(function(){
'use strict';
// === VSP_FIX_STRING_NEWLINES_V1 ===
// === VSP_FIX_EFFLIMIT_REDECLARE_V1 ===
(function(){
  try {
    if (window.__VSP_GUARD__ && window.__VSP_GUARD__.RUNS_COMMERCIAL_PANEL_V1) return;
    window.__VSP_GUARD__ = window.__VSP_GUARD__ || {};
    window.__VSP_GUARD__.RUNS_COMMERCIAL_PANEL_V1 = true;
  } catch(e) {}

// VSP_WRAP_RUNS_COMMERCIAL_PANEL_V1
(function(){
  try {
    if (window.__VSP_GUARD__ && window.__VSP_GUARD__[tag]) return;
    window.__VSP_GUARD__ = window.__VSP_GUARD__ || {};
    window.__VSP_GUARD__[tag] = true;
  } catch(e) {}

(function () {
  'use strict';

  // VSP_ROUTE_GUARD_RUNS_ONLY_V1
  function __vsp_is_runs_only_v1(){
    try {
      const h = (location.hash||"").toLowerCase();
      return h.startsWith("#runs") || h.includes("#runs/");
    } catch(_) { return false; }
  }
  if(!__vsp_is_runs_only_v1()){
    try{ console.info("[VSP_ROUTE_GUARD_RUNS_ONLY_V1] skip", "vsp_runs_commercial_panel_v1.js", "hash=", location.hash); }catch(_){}
    return;
  }


// === VSP_RUNS_TOGGLE_CFG_V1 (limit/hide_empty via localStorage) ===
(function(){
  try {
    var lim = parseInt(localStorage.getItem('vsp_runs_limit') || '0', 10);
    if (lim && lim > 0) window.VSP_RUNS_LIMIT = lim;
    var he = localStorage.getItem('vsp_runs_hide_empty');
    if (he !== null && he !== undefined) window.VSP_RUNS_HIDE_EMPTY = parseInt(he, 10) || 0;
  } catch (e) {}
})();
// === END VSP_RUNS_TOGGLE_CFG_V1 ===
  // Commercial Runs Master (single source of truth)
  window.VSP_COMMERCIAL_RUNS_MASTER = true;

  if (window.VSP_RUNS_COMMERCIAL_PANEL_V1) return;
  window.VSP_RUNS_COMMERCIAL_PANEL_V1 = true;

  const qs = (s, r=document) => r.querySelector(s);

  function htmlesc(s){
    return String(s ?? '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  function sumTotals(t){
    if (!t || typeof t !== 'object') return 0;
    let s = 0;
    for (const k of Object.keys(t)){
      const v = t[k];
      const n = Number(v);
      if (!Number.isNaN(n)) s += n;
    }
    return s;
  }

  function gateStatus(totals){
    const c = Number(totals?.CRITICAL || 0);
    const h = Number(totals?.HIGH || 0);
    // align with your CI gate default (MAX_CRITICAL=0, MAX_HIGH=10)
    if (c > 0 || h > 10) return {label:'FAIL', cls:'vsp-gate-red'};
    return {label:'PASS', cls:'vsp-gate-green'};
  }

  function findRunsHost(){
    return qs('#vsp-runs-main');
  }

  function ensureShell(host){
    if (host.querySelector('.vsp-commercial-runs-shell')) return;

    const shell = document.createElement('div');
    shell.className = 'vsp-commercial-runs-shell';
    shell.innerHTML = `
      <div class="vsp-panel" style="margin-top:12px;">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;">
          <div>
            <div class="vsp-h2" style="margin:0;">Runs & Reports</div>
            <div class="vsp-subtle" style="margin-top:4px;">Commercial master panel (FS endpoint) • Fast • No legacy overlays</div>
          </div>
          <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
            <label class="vsp-subtle" style="display:flex; align-items:center; gap:6px;">
              <input type="checkbox" id="vsp-cm-hide-empty" checked />
              Hide empty
            </label>
            <select class="vsp-select" id="vsp-cm-limit">
              <option value="50">Last 50</option>
              <option value="100">Last 100</option>
              <option value="200" selected>Last 200</option>
              <option value="400">Last 400</option>
            </select>
            <input class="vsp-input" id="vsp-cm-search" placeholder="Search run_id…" style="min-width:240px;" />
            <button class="vsp-btn" id="vsp-cm-refresh">Refresh</button>
          </div>
        </div>

        <div style="display:flex; gap:10px; margin-top:10px; flex-wrap:wrap;">
          <div class="vsp-kpi-card" style="min-width:180px;">
            <div class="vsp-kpi-label">
        <!-- === VSP_COMMERCIAL_RUN_SCAN_BOX_V1 === -->
        <div class="vsp-panel" style="margin-top:10px;">
          <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end;">
            <div style="min-width:260px;">
              <div class="vsp-subtle" style="margin-bottom:6px;">Target (path)</div>
              <input class="vsp-input" id="vsp-cm-target" value="/home/test/Data/SECURITY-10-10-v4" />
            </div>
            <div style="min-width:160px;">
              <div class="vsp-subtle" style="margin-bottom:6px;">Profile</div>
              <select class="vsp-select" id="vsp-cm-profile">
                <option value="FULL_EXT" selected>FULL_EXT</option>
                <option value="FAST">FAST</option>
              </select>
            </div>
            <div style="min-width:120px;">
              <div class="vsp-subtle" style="margin-bottom:6px;">MAX_CRITICAL</div>
              <input class="vsp-input" id="vsp-cm-maxc" value="0" />
            </div>
            <div style="min-width:120px;">
              <div class="vsp-subtle" style="margin-bottom:6px;">MAX_HIGH</div>
              <input class="vsp-input" id="vsp-cm-maxh" value="10" />
            </div>
            <button class="vsp-btn" id="vsp-cm-run-now">Run Scan Now</button>
            <span class="vsp-subtle" id="vsp-cm-run-badge">Idle</span>
          </div>

          <div style="margin-top:10px; display:grid; grid-template-columns: 1fr; gap:8px;">
            <pre class="vsp-mono" id="vsp-cm-run-tail" style="max-height:220px; overflow:auto; font-size:11px; white-space:pre-wrap; border:1px solid rgba(255,255,255,0.08); padding:10px; border-radius:10px;"></pre>
          </div>
        </div>
        <!-- === END VSP_COMMERCIAL_RUN_SCAN_BOX_V1 === -->
Shown runs</div>
            <div class="vsp-kpi-value" id="vsp-cm-kpi-count">-</div>
          </div>
          <div class="vsp-kpi-card" style="min-width:180px;">
            <div class="vsp-kpi-label">PASS / FAIL</div>
            <div class="vsp-kpi-value" id="vsp-cm-kpi-passfail">-</div>
          </div>
          <div class="vsp-kpi-card" style="min-width:180px;">
            <div class="vsp-kpi-label">Latest run</div>
            <div class="vsp-kpi-value" id="vsp-cm-kpi-latest" style="font-size:12px;">-</div>
          </div>
          <div class="vsp-kpi-card" style="min-width:180px;">
            <div class="vsp-kpi-label">Data source</div>
            <div class="vsp-kpi-value" id="vsp-cm-kpi-source">fs</div>
          </div>
        </div>

        <div class="vsp-subtle" id="vsp-cm-status" style="margin-top:10px;">Ready.</div>

        <div style="overflow:auto; margin-top:10px;">
          <table class="vsp-table" style="min-width:980px;">
            <thead>
              <tr>
                <th style="width:170px;">Created</th>
                <th>Run ID</th>
                <th style="width:90px;">Gate</th>
                <th style="width:110px; text-align:right;">Total</th>
                <th style="width:90px; text-align:right;">CRIT</th>
                <th style="width:90px; text-align:right;">HIGH</th>
                <th style="width:90px; text-align:right;">MED</th>
                <th style="width:90px; text-align:right;">LOW</th>
                <th style="width:90px; text-align:right;">INFO</th>
                <th style="width:170px;">Actions</th>
              </tr>
            </thead>
            <tbody id="vsp-cm-tbody"></tbody>
          </table>
        </div>
      </div>
    `;
    host.prepend(shell);
  }

  async function fetchRuns(limit, hideEmpty){
    var effLimit = (window.VSP_RUNS_LIMIT ? Number(window.VSP_RUNS_LIMIT) : limit) || 50;
    const effShowEmpty = !!window.VSP_RUNS_SHOW_EMPTY;
    // === VSP_RUNS_URL_GLOBALS_V1 ===
    var effLimit = (typeof window.VSP_RUNS_LIMIT === 'number' && window.VSP_RUNS_LIMIT > 0) ? window.VSP_RUNS_LIMIT : limit;
    const effHide  = (typeof window.VSP_RUNS_HIDE_EMPTY === 'number') ? window.VSP_RUNS_HIDE_EMPTY : (hideEmpty ? 1 : 0);
    const url = `/api/vsp/runs_index_v3_fs?limit=${encodeURIComponent(effLimit)}&hide_empty=${encodeURIComponent(effHide)}`;
    // === END VSP_RUNS_URL_GLOBALS_V1 ===
    const res = await fetch(url, {cache:'no-store'});
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    return res.json();
  }

  function renderRows(items){
    const tb = qs('#vsp-cm-tbody');
    const q = (qs('#vsp-cm-search')?.value || '').trim().toLowerCase();
    tb.innerHTML = '';

    let pass = 0, fail = 0;
    let shown = 0;

    for (const it of (items || [])){
      const runId = it.run_id || '';
      if (q && !runId.toLowerCase().includes(q)) continue;

      const totals = it.totals || {};
      const total = Number(it.total_findings ?? sumTotals(totals)) || 0;
      const g = gateStatus(totals);

      if (g.label === 'PASS') pass++; else fail++;
      shown++;

      const created = it.created_at ? String(it.created_at).replace('T',' ').slice(0,19) : '-';

      const html = `
        <tr>
          <td class="vsp-mono">${htmlesc(created)}</td>
          <td class="vsp-mono">${htmlesc(runId)}</td>
          <td><span class="vsp-gate-badge ${g.cls}">${g.label}</span></td>
          <td class="vsp-mono" style="text-align:right;">${total.toLocaleString()}</td>
          <td class="vsp-mono" style="text-align:right;">${Number(totals.CRITICAL||0).toLocaleString()}</td>
          <td class="vsp-mono" style="text-align:right;">${Number(totals.HIGH||0).toLocaleString()}</td>
          <td class="vsp-mono" style="text-align:right;">${Number(totals.MEDIUM||0).toLocaleString()}</td>
          <td class="vsp-mono" style="text-align:right;">${Number(totals.LOW||0).toLocaleString()}</td>
          <td class="vsp-mono" style="text-align:right;">${Number(totals.INFO||0).toLocaleString()}</td>
          <td>
            <button class="vsp-btn vsp-btn-ghost" data-act="html" data-run="${htmlesc(runId)}">HTML</button>
            <button class="vsp-btn vsp-btn-ghost" data-act="zip" data-run="${htmlesc(runId)}">ZIP</button>
          </td>
        </tr>
      `;
      tb.insertAdjacentHTML('beforeend', html);
    }

    qs('#vsp-cm-kpi-count').textContent = String(shown);
    qs('#vsp-cm-kpi-passfail').textContent = `${pass} / ${fail}`;

    // latest run (first shown)
    const first = (items || []).find(it => {
      const runId = (it.run_id||'').toLowerCase();
      const q2 = (qs('#vsp-cm-search')?.value || '').trim().toLowerCase();
      return (!q2 || runId.includes(q2));
    });
    qs('#vsp-cm-kpi-latest').textContent = first?.run_id || '-';
  }

  function wireActions(){
    const host = findRunsHost();
    if (!host) return;

    host.addEventListener('click', (e) => {
      const btn = e.target && e.target.closest && e.target.closest('button[data-act]');
      if (!btn) return;
      const act = btn.getAttribute('data-act');
      const runId = btn.getAttribute('data-run');
      if (!runId) return;

      // Try common export endpoint
      const fmt = (act === 'zip') ? 'zip' : 'html';
      const url = `/api/vsp/run_export_v3?run_id=${encodeURIComponent(runId)}&fmt=${encodeURIComponent(fmt)}`;
      window.open(url, '_blank');
    }, {passive:true});
  }

  let lastItems = [];

  
  async function startScan(){
    const badge = qs('#vsp-cm-run-badge');
    const tailEl = qs('#vsp-cm-run-tail');
    const btn = qs('#vsp-cm-run-now');

    const target = (qs('#vsp-cm-target')?.value || '').trim();
    const profile = (qs('#vsp-cm-profile')?.value || 'FULL_EXT').trim();
    const maxc = parseInt((qs('#vsp-cm-maxc')?.value || '0').trim(), 10) || 0;
    const maxh = parseInt((qs('#vsp-cm-maxh')?.value || '10').trim(), 10) || 10;

    if (!target) {
      badge.textContent = 'ERR: target empty';
      return;
    }

    badge.textContent = 'Submitting…';
    tailEl.textContent = '';
    btn && (btn.disabled = true);

    let reqId = '';
    try{
      const res = await fetch('/api/vsp/run_v1', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({mode:'local', profile, target_type:'path', target, max_critical:maxc, max_high:maxh})
      });
      const js = await res.json();
      if (!js.ok) throw new Error(js.error || ('HTTP ' + res.status));
      reqId = js.req_id;
      badge.textContent = 'RUNNING: ' + reqId;
    }catch(err){
      badge.textContent = 'ERR: ' + (err && err.message ? err.message : String(err));
      btn && (btn.disabled = false);
      return;
    }

    async function poll(){
      try{
        const r = await fetch('/api/vsp/run_status_v1/' + encodeURIComponent(reqId), {cache:'no-store'});
        const st = await r.json();
        tailEl.textContent = st.tail || '';
        const g = st.gate || 'UNKNOWN';
        const s = st.status || 'RUNNING';
        badge.textContent = `${s} • gate=${g} • ${reqId}`;

        if (st.final){
          btn && (btn.disabled = false);
          // refresh runs table after finish
          refresh();
          return;
        }
      }catch(err){
        badge.textContent = 'POLL_ERR: ' + (err && err.message ? err.message : String(err));
      }
      setTimeout(poll, 2000);
    }
    poll();
  }
async function refresh(){
    const host = findRunsHost();
    if (!host) return;
    ensureShell(host);

    const limit = Number(qs('#vsp-cm-limit')?.value || 200) || 200;
    const hideEmpty = !!qs('#vsp-cm-hide-empty')?.checked;
    const st = qs('#vsp-cm-status');
    st.textContent = 'Loading…';

    try{
      const data = await fetchRuns(limit, hideEmpty);
      lastItems = data.items || [];
      qs('#vsp-cm-kpi-source').textContent = data.source || 'fs';
      renderRows(lastItems);
      st.textContent = `Loaded ${lastItems.length} items from ${data.source || 'fs'}.`;
    }catch(err){
      st.textContent = `ERROR: ${String(err && err.message || err)}`;
    }
  }

  function mount(){
    const host = findRunsHost();
    if (!host) return;

    ensureShell(host);
    wireActions();

    const btn = qs('#vsp-cm-refresh');
    const search = qs('#vsp-cm-search');
    const limit = qs('#vsp-cm-limit');
    const hide = qs('#vsp-cm-hide-empty');

    if (btn && !btn.__bound){
      btn.__bound = true;
      btn.addEventListener('click', refresh);
    }
    
    const runNow = qs("#vsp-cm-run-now");
    if (runNow && !runNow.__bound) {
      runNow.__bound = true;
      runNow.addEventListener("click", startScan);
    }
if (search && !search.__bound){
      search.__bound = true;
      search.addEventListener('input', () => renderRows(lastItems));
    }
    if (limit && !limit.__bound){
      limit.__bound = true;
      limit.addEventListener('change', refresh);
    }
    if (hide && !hide.__bound){
      hide.__bound = true;
      hide.addEventListener('change', refresh);
    }

    console.log('[VSP_RUNS_COMMERCIAL_PANEL_V1] mounted into #vsp-runs-main (MASTER)');
    refresh();
  }

  // mount on ready + whenever user switches tabs
  function onReady(fn){
    if (document.readyState === 'complete' || document.readyState === 'interactive') setTimeout(fn, 0);
    else document.addEventListener('DOMContentLoaded', fn);
  }

  onReady(() => {
    mount();
    window.addEventListener('hashchange', () => setTimeout(mount, 50));
  });


  // === VSP_RUNS_COMMERCIAL_WIRE_RUN_V1 ===
  async function apiPostJSON(url, data) {
    const res = await fetch(url, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(data || {})
    });
    const t = await res.text();
    let j = null;
    try { j = JSON.parse(t); } catch(e) {}
    return { ok: res.ok, status: res.status, json: j, text: t };
  }

  async function apiGetJSON(url) {
    const res = await fetch(url, { cache: 'no-store' });
    const t = await res.text();
    let j = null;
    try { j = JSON.parse(t); } catch(e) {}
    return { ok: res.ok, status: res.status, json: j, text: t };
  }

  function ensurePanel(host) {
    let box = host.querySelector('#vsp-commercial-runbox');
    if (box) return box;

    const wrap = document.createElement('div');
    wrap.id = 'vsp-commercial-runbox';
    wrap.style.cssText = 'margin:12px 0; padding:12px; border:1px solid rgba(255,255,255,.08); border-radius:14px; background:rgba(255,255,255,.02)';

    wrap.innerHTML = `
      <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
        <div style="font-weight:700;">Run Scan Now</div>
        <span id="vsp-run-badge" class="vsp-badge" style="padding:4px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.12); opacity:.9;">IDLE</span>
        <span id="vsp-run-req" class="vsp-mono" style="opacity:.85;"></span>
        <span id="vsp-run-vspid" class="vsp-mono" style="opacity:.85;"></span>
      </div>

      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
        <select id="vsp-run-profile" class="vsp-select" style="min-width:160px;">
          <option value="FULL_EXT">FULL_EXT</option>
          <option value="FAST">FAST</option>
        </select>
        <input id="vsp-run-target" class="vsp-input" style="min-width:420px; flex:1;"
          placeholder="/path/to/repo or url..." />
        <button id="vsp-run-go" class="vsp-btn" style="min-width:140px;">Run</button>
        <button id="vsp-run-refresh" class="vsp-btn" style="min-width:140px;">Refresh Runs</button>
      </div>

      <pre id="vsp-run-tail" class="vsp-mono" style="margin-top:10px; max-height:220px; overflow:auto; font-size:11px; white-space:pre-wrap; opacity:.92; border-top:1px dashed rgba(255,255,255,.10); padding-top:10px;"></pre>
    `;

    // Insert near top of runs pane
    host.insertBefore(wrap, host.firstChild);
    return wrap;
  }

  function setBadge(text, kind) {
    const b = document.querySelector('#vsp-run-badge');
    if (!b) return;
    b.textContent = text;
    // lightweight "kind" styling
    const map = {
      IDLE: 'rgba(255,255,255,.12)',
      RUNNING: 'rgba(255,193,7,.25)',
      DONE: 'rgba(34,197,94,.25)',
      FAILED: 'rgba(239,68,68,.25)',
      ERROR: 'rgba(239,68,68,.25)'
    };
    b.style.background = map[kind || text] || 'rgba(255,255,255,.12)';
  }

  function setText(sel, s) {
    const el = document.querySelector(sel);
    if (el) el.textContent = s || '';
  }

  function setTail(s) {
    const el = document.querySelector('#vsp-run-tail');
    if (el) el.textContent = s || '';
  }

  async function refreshRuns() {
    // If runs table loader exists, trigger it
    try {
      if (window.VSP_RUNS_TAB_SIMPLE_V2 && typeof window.VSP_RUNS_TAB_SIMPLE_V2.loadRuns === 'function') {
        await window.VSP_RUNS_TAB_SIMPLE_V2.loadRuns();
        return;
      }
    } catch(e) {}
    // fallback: reload page data (router will re-render)
    try { location.hash = '#runs'; } catch(e) {}
  }

  async function pollStatus(reqId) {
    const url = `/api/vsp/run_status_v1/${encodeURIComponent(reqId)}`;
    while (true) {
      const r = await apiGetJSON(url);
      if (!r.ok || !r.json) {
        setBadge('ERROR', 'ERROR');
        setTail(r.text || `Failed to fetch ${url}`);
        return;
      }
      const st = r.json;
      setBadge(st.status || 'RUNNING', st.status || 'RUNNING');
      setText('#vsp-run-req', st.req_id ? `REQ: ${st.req_id}` : '');
      setText('#vsp-run-vspid', st.vsp_run_id ? `VSP: ${st.vsp_run_id}` : '');
      setTail(st.tail || '');

      if (st.final === true) {
        // auto refresh list once final
        await refreshRuns();
        return;
      }
      await new Promise(res => setTimeout(res, 2000));
    }
  }

  async function bindRunActions(panel) {
    const btn = panel.querySelector('#vsp-run-go');
    const btnR = panel.querySelector('#vsp-run-refresh');
    const inpT = panel.querySelector('#vsp-run-target');
    const selP = panel.querySelector('#vsp-run-profile');

    // defaults
    if (inpT && !inpT.value) inpT.value = '/home/test/Data/SECURITY-10-10-v4';

    btnR && btnR.addEventListener('click', async () => {
      setBadge('IDLE','IDLE');
      await refreshRuns();
    });

    btn && btn.addEventListener('click', async () => {
      setBadge('RUNNING','RUNNING');
      setTail('[UI] Spawning scan...\\n');
      setText('#vsp-run-req','');
      setText('#vsp-run-vspid','');

      const payload = {
        mode: 'local',
        profile: (selP && selP.value) ? selP.value : 'FULL_EXT',
        target_type: 'path',
        target: (inpT && inpT.value) ? inpT.value.trim() : '/home/test/Data/SECURITY-10-10-v4'
      };

      const r = await apiPostJSON('/api/vsp/run_v1', payload);
      if (!r.ok || !r.json || !r.json.req_id) {
        setBadge('ERROR','ERROR');
        setTail(r.text || '[UI] Run spawn failed');
        return;
      }
      const reqId = r.json.req_id;
      setText('#vsp-run-req', `REQ: ${reqId}`);
      setTail(`[UI] Spawned: ${reqId}
[UI] Polling status...
`);
      await pollStatus(reqId);
    });
  }
  // === END VSP_RUNS_COMMERCIAL_WIRE_RUN_V1 ===

})();


/* === VSP_COMMERCIAL_RUNS_UI_TOGGLE_V1 === */
(function () {
  if (window.VSP_COMMERCIAL_RUNS_UI_TOGGLE_V1) return;
  window.VSP_COMMERCIAL_RUNS_UI_TOGGLE_V1 = true;

  function injectControls() {
    var root = document.getElementById('vsp-runs-main');
    if (!root) return;

    if (root.querySelector('#vsp-runs-show-empty')) return;

    var bar = document.createElement('div');
    bar.style.cssText = "display:flex;gap:14px;align-items:center;justify-content:flex-end;margin:8px 0 12px 0;padding:8px 10px;border:1px solid rgba(255,255,255,.08);border-radius:12px;background:rgba(255,255,255,.03)";

    var showEmpty = !!window.VSP_RUNS_SHOW_EMPTY;
    var limit = (window.VSP_RUNS_LIMIT ? Number(window.VSP_RUNS_LIMIT) : 50) || 50;

    bar.innerHTML =
      '<label style="display:flex;gap:8px;align-items:center;font-size:12px;opacity:.95;cursor:pointer">' +
        '<input id="vsp-runs-show-empty" type="checkbox" ' + (showEmpty ? 'checked' : '') + ' />' +
        '<span>Show empty runs</span>' +
      '</label>' +
      '<label style="display:flex;gap:8px;align-items:center;font-size:12px;opacity:.95">' +
        '<span>Limit</span>' +
        '<select id="vsp-runs-limit" style="background:rgba(255,255,255,.06);color:inherit;border:1px solid rgba(255,255,255,.10);border-radius:10px;padding:4px 8px;">' +
          '<option value="50">50</option>' +
          '<option value="200">200</option>' +
          '<option value="500">500</option>' +
        '</select>' +
      '</label>';

    root.prepend(bar);
    var cb = bar.querySelector('#vsp-runs-show-empty');
    var sel = bar.querySelector('#vsp-runs-limit');
    sel.value = String(limit);

    function apply() {
      window.VSP_RUNS_SHOW_EMPTY = !!cb.checked;
      window.VSP_RUNS_LIMIT = Number(sel.value) || 50;

      // try soft refresh hooks first
      if (typeof window.VSP_RUNS_REFRESH === 'function') { window.VSP_RUNS_REFRESH(); return; }

      // try click refresh button if present
      var btn = root.querySelector('[data-action="refresh"], .vsp-btn-refresh, button[title*="Refresh"], button[title*="reload"]');
      if (btn) { btn.click(); return; }

      // fallback: reload hash/page
      try { location.hash = '#runs'; } catch (e) {}
      setTimeout(function(){ try{ location.hash = '#runs'; }catch(e){} }, 50);
      setTimeout(function(){ try{ location.reload(); }catch(e){} }, 150);
    }

    cb.addEventListener('change', apply);
    sel.addEventListener('change', apply);
  }

  document.addEventListener('DOMContentLoaded', function(){ setTimeout(injectControls, 200); });
  window.addEventListener('hashchange', function(){ setTimeout(injectControls, 120); });
  setTimeout(injectControls, 400);
})();


// === VSP_RUNS_TOGGLE_UI_V1 (inject controls; reload on change for stability) ===
(function(){
  if (window.VSP_RUNS_TOGGLE_UI_V1) return;
  window.VSP_RUNS_TOGGLE_UI_V1 = true;

  function qs(sel){ try { return document.querySelector(sel); } catch(e){ return null; } }
  function create(tag, html){
    var el = document.createElement(tag);
    if (html) el.innerHTML = html;
    return el;
  }

  function inject(){
    var host = qs('#vsp-runs-main');
    if (!host) return false;

    // Prefer header if exists
    var header = qs('#vsp-runs-main .vsp-card-header') || host;
    if (qs('#vsp-runs-toggle-box')) return true;

    var lim = (typeof window.VSP_RUNS_LIMIT === 'number' && window.VSP_RUNS_LIMIT > 0) ? window.VSP_RUNS_LIMIT : 200;
    var he  = (typeof window.VSP_RUNS_HIDE_EMPTY === 'number') ? window.VSP_RUNS_HIDE_EMPTY : 1;

    var box = create('div', `
      <div id="vsp-runs-toggle-box" style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:8px">
        <div style="font-size:12px;opacity:.85">Runs view:</div>
        <label style="display:flex;gap:6px;align-items:center;font-size:12px;cursor:pointer">
          <input id="vsp-runs-hide-empty" type="checkbox" ${he ? 'checked' : ''}/>
          Hide empty
        </label>
        <label style="display:flex;gap:6px;align-items:center;font-size:12px">
          Limit
          <select id="vsp-runs-limit" style="background:rgba(255,255,255,.06);color:inherit;border:1px solid rgba(255,255,255,.12);border-radius:8px;padding:4px 8px">
            <option value="50">50</option>
            <option value="200">200</option>
            <option value="500">500</option>
          </select>
        </label>
        <button id="vsp-runs-toggle-apply" style="background:rgba(99,102,241,.18);color:inherit;border:1px solid rgba(99,102,241,.35);border-radius:10px;padding:6px 10px;font-size:12px;cursor:pointer">
          Apply
        </button>
      </div>
    `);

    header.appendChild(box);

    var sel = qs('#vsp-runs-limit');
    if (sel) sel.value = String(lim);

    function apply(){
      try {
        var newLim = parseInt((qs('#vsp-runs-limit')||{}).value || '200', 10) || 200;
        var newHe  = (qs('#vsp-runs-hide-empty')||{}).checked ? 1 : 0;
        localStorage.setItem('vsp_runs_limit', String(newLim));
        localStorage.setItem('vsp_runs_hide_empty', String(newHe));
      } catch(e) {}
      // reload to ensure *all* runs widgets pick up new query params consistently
      try { window.location.reload(); } catch(e) {}
    }

    var btn = qs('#vsp-runs-toggle-apply');
    if (btn) btn.addEventListener('click', apply);
    var cb = qs('#vsp-runs-hide-empty');
    if (cb) cb.addEventListener('change', function(){ /* no-op until Apply */ });
    return true;
  }

  // try now + retry a few times
  var tries = 0;
  var t = setInterval(function(){
    tries++;
    if (inject() || tries > 20) clearInterval(t);
  }, 500);
})();
// === END VSP_RUNS_TOGGLE_UI_V1 ===

})();

})();

})();
/* ==== END: static/js/vsp_runs_commercial_panel_v1.js ==== */

/* ==== BEGIN: static/js/vsp_runs_exports_v1.js ==== */
(function(){
'use strict';
/**
 * VSP Runs Export – v1
 *
 * Gắn onclick cho các nút Export trên TAB 2 – RUNS & REPORTS.
 *
 * Yêu cầu HTML:
 *   <button id="vsp-runs-btn-export-index-csv">Export run index (CSV)</button>
 *   <button id="vsp-runs-btn-export-findings-json">Export findings (JSON)</button>
 *   <button id="vsp-runs-btn-export-sbom">Export SBOM</button>
 *   <button id="vsp-runs-btn-export-license">Export License report</button>
 *
 * Các API phía server:
 *   GET /api/vsp/export/runs_index_csv
 *   GET /api/vsp/export/findings_json
 *   GET /api/vsp/export/sbom
 *   GET /api/vsp/export/license
 *
 * Mặc định: không truyền run_id => server export run mới nhất.
 * Nếu muốn export theo run cụ thể, bạn có thể sửa hàm buildUrl
 * để thêm query ?run_id=... khi cần.
 */

(function () {

  // VSP_ROUTE_GUARD_RUNS_ONLY_V1
  function __vsp_is_runs_only_v1(){
    try {
      const h = (location.hash||"").toLowerCase();
      return h.startsWith("#runs") || h.includes("#runs/");
    } catch(_) { return false; }
  }
  if(!__vsp_is_runs_only_v1()){
    try{ console.info("[VSP_ROUTE_GUARD_RUNS_ONLY_V1] skip", "vsp_runs_exports_v1.js", "hash=", location.hash); }catch(_){}
    return;
  }

  console.log("[VSP_RUNS_EXPORT] vsp_runs_exports_v1.js loaded.");

  function bindClick(buttonId, buildUrl) {
    var btn = document.getElementById(buttonId);
    if (!btn) {
      console.warn("[VSP_RUNS_EXPORT] Button not found:", buttonId);
      return;
    }
    btn.addEventListener("click", function (evt) {
      evt.preventDefault();
      var url = buildUrl();
      if (!url) {
        console.error("[VSP_RUNS_EXPORT] No URL for button:", buttonId);
        return;
      }
      console.log("[VSP_RUNS_EXPORT] Download ->", url);
      // Cách đơn giản nhất: mở URL => trình duyệt tự download.
      window.location.href = url;
    });
  }

  // Nếu sau này bạn muốn export theo run cụ thể,
  // có thể tìm run_id từ dòng được chọn trên bảng:
  function getSelectedRunIdFromTable() {
    // Placeholder, hiện tại không dùng.
    // Bạn có thể gắn class "is-selected" cho <tr> rồi đọc dataset.runId.
    return null;
  }

  // 1) Export run index (CSV)
  bindClick("vsp-runs-btn-export-index-csv", function () {
    // Nếu cần run_id cụ thể:
    // var runId = getSelectedRunIdFromTable();
    // return runId ? "/api/vsp/export/runs_index_csv?run_id=" + encodeURIComponent(runId)
    //              : "/api/vsp/export/runs_index_csv";
    return "/api/vsp/export/runs_index_csv";
  });

  // 2) Export findings_unified.json
  bindClick("vsp-runs-btn-export-findings-json", function () {
    // var runId = getSelectedRunIdFromTable();
    // return runId ? "/api/vsp/export/findings_json?run_id=" + encodeURIComponent(runId)
    //              : "/api/vsp/export/findings_json";
    return "/api/vsp/export/findings_json";
  });

  // 3) Export SBOM
  bindClick("vsp-runs-btn-export-sbom", function () {
    // var runId = getSelectedRunIdFromTable();
    // return runId ? "/api/vsp/export/sbom?run_id=" + encodeURIComponent(runId)
    //              : "/api/vsp/export/sbom";
    return "/api/vsp/export/sbom";
  });

  // 4) Export License report
  bindClick("vsp-runs-btn-export-license", function () {
    // var runId = getSelectedRunIdFromTable();
    // return runId ? "/api/vsp/export/license?run_id=" + encodeURIComponent(runId)
    //              : "/api/vsp/export/license";
    return "/api/vsp/export/license";
  });
})();

})();
/* ==== END: static/js/vsp_runs_exports_v1.js ==== */

/* ==== BEGIN: static/js/vsp_runs_filters_advanced_v1.js ==== */
(function(){
'use strict';
(function(){

  // VSP_ROUTE_GUARD_RUNS_ONLY_V1
  function __vsp_is_runs_only_v1(){
    try {
      const h = (location.hash||"").toLowerCase();
      return h.startsWith("#runs") || h.includes("#runs/");
    } catch(_) { return false; }
  }
  if(!__vsp_is_runs_only_v1()){
    try{ console.info("[VSP_ROUTE_GUARD_RUNS_ONLY_V1] skip", "vsp_runs_filters_advanced_v1.js", "hash=", location.hash); }catch(_){}
    return;
  }

  // === VSP_DISABLE_RUNS_FILTER_ADV_V1_BY_MASTER ===
  if (window.VSP_COMMERCIAL_RUNS_MASTER) return;
  // === END VSP_DISABLE_RUNS_FILTER_ADV_V1_BY_MASTER ===
})();
(function(){/*VSP_DISABLE_RUNS_FILTERS_V1*/return;})();
(function(){return;})();
(function () {
  console.log("[VSP_RUNS_FILTER] vsp_runs_filters_advanced_v1.js loaded");

  function findRunsPane() {
    var pane =
      document.getElementById("vsp-tab-runs-main") ||
      document.querySelector("[data-vsp-pane='runs']") ||
      document.querySelector("#vsp-tab-runs") ||
      document.querySelector(".vsp-pane-runs");

    if (pane) return pane;

    // fallback: tìm theo text "Runs & Reports"
    var all = Array.from(document.querySelectorAll("section,div,main"));
    var marker = all.find(function (el) {
      var t = (el.textContent || "").toUpperCase();
      return t.includes("RUNS & REPORTS") && t.includes("/API/VSP/RUNS_INDEX_V3");
    });
    if (marker) {
      return marker.closest(".vsp-pane") || marker.closest("section") || marker.closest("div");
    }
    return null;
  }

  function applyFilters() {
    var pane = findRunsPane();
    if (!pane) return;

    var tbody = pane.querySelector("tbody");
    if (!tbody) return;

    var rows = Array.from(tbody.querySelectorAll("tr"));
    if (!rows.length) return;

    var idFilter = (document.getElementById("vsp-runs-filter-id") || {}).value || "";
    var statusFilter = (document.getElementById("vsp-runs-filter-status") || {}).value || "";
    var dateFrom = (document.getElementById("vsp-runs-filter-date-from") || {}).value || "";
    var dateTo = (document.getElementById("vsp-runs-filter-date-to") || {}).value || "";

    idFilter = idFilter.trim().toLowerCase();
    statusFilter = statusFilter.trim().toUpperCase();

    rows.forEach(function (tr) {
      var tds = tr.querySelectorAll("td");
      if (!tds.length) return;

      var runId = (tds[0].textContent || "").toLowerCase();   // Run ID
      var started = (tds[2] && tds[2].textContent) || "";      // Started
      var status = (tds[4] && tds[4].textContent) || "";       // Status

      var visible = true;

      if (idFilter && !runId.includes(idFilter)) visible = false;

      if (statusFilter && status.toUpperCase().indexOf(statusFilter) === -1) visible = false;

      if (dateFrom) {
        var m = started.match(/(\d{2})\/(\d{2})\/(\d{4})/);
        if (m) {
          var d = m[3] + "-" + m[2] + "-" + m[1];
          if (d < dateFrom) visible = false;
        }
      }

      if (dateTo) {
        var m2 = started.match(/(\d{2})\/(\d{2})\/(\d{4})/);
        if (m2) {
          var d2 = m2[3] + "-" + m2[2] + "-" + m2[1];
          if (d2 > dateTo) visible = false;
        }
      }

      tr.style.display = visible ? "" : "none";
    });
  }

  function initFilters() {
    var pane = findRunsPane();
    if (!pane) {
      console.warn("[VSP_RUNS_FILTER] Không tìm thấy pane Runs.");
      return;
    }
    if (pane.querySelector("#vsp-runs-filter-bar")) return;

    var wrapper = document.createElement("div");
    wrapper.id = "vsp-runs-filter-bar";
    wrapper.className = "vsp-card";
    wrapper.style.margin = "16px 0";

    wrapper.innerHTML = `
      <div class="vsp-card-title">Filters</div>
      <div class="vsp-grid vsp-grid-4" style="gap:12px; margin-top:8px;">
        <div>
          <label>Run ID / profile / target</label>
          <input id="vsp-runs-filter-id" type="text" placeholder="search..." style="width:100%;">
        </div>
        <div>
          <label>Status</label>
          <select id="vsp-runs-filter-status" style="width:100%;">
            <option value="">Any</option>
            <option value="DONE">DONE</option>
            <option value="FAILED">FAILED</option>
            <option value="RUNNING">RUNNING</option>
          </select>
        </div>
        <div>
          <label>Date from</label>
          <input id="vsp-runs-filter-date-from" type="date" style="width:100%;">
        </div>
        <div>
          <label>Date to</label>
          <input id="vsp-runs-filter-date-to" type="date" style="width:100%;">
        </div>
      </div>
    `;

    var header = pane.querySelector("h2, h3, .vsp-section-title");
    if (header && header.parentNode) {
      header.parentNode.insertBefore(wrapper, header.nextSibling);
    } else {
      pane.insertBefore(wrapper, pane.firstChild);
    }

    ["vsp-runs-filter-id", "vsp-runs-filter-status",
     "vsp-runs-filter-date-from", "vsp-runs-filter-date-to"].forEach(function (id) {
      var el = document.getElementById(id);
      if (!el) return;
      el.addEventListener("input", applyFilters);
      el.addEventListener("change", applyFilters);
    });
  }

  document.addEventListener("DOMContentLoaded", function () {
    if (location.hash === "#runs") {
      setTimeout(function () {
        initFilters();
        applyFilters();
      }, 400);
    }
  });

  window.addEventListener("hashchange", function () {
    if (location.hash === "#runs") {
      setTimeout(function () {
        initFilters();
        applyFilters();
      }, 400);
    }
  });
})();

})();
/* ==== END: static/js/vsp_runs_filters_advanced_v1.js ==== */

/* ==== BEGIN: static/js/vsp_runs_fullscan_panel_v1.js ==== */
(function(){
'use strict';
;(function () {

  // VSP_ROUTE_GUARD_RUNS_ONLY_V1
  function __vsp_is_runs_only_v1(){
    try {
      const h = (location.hash||"").toLowerCase();
      return h.startsWith("#runs") || h.includes("#runs/");
    } catch(_) { return false; }
  }
  if(!__vsp_is_runs_only_v1()){
    try{ console.info("[VSP_ROUTE_GUARD_RUNS_ONLY_V1] skip", "vsp_runs_fullscan_panel_v1.js", "hash=", location.hash); }catch(_){}
    return;
  }

  const LOG_PREFIX = "[VSP_RUN_FULLSCAN_PANEL]";

  function $(id) {
    return document.getElementById(id);
  }

  function injectRunPanel() {
    const pane = document.getElementById("vsp-tab-runs");
    if (!pane) {
      console.log(LOG_PREFIX, "Không tìm thấy #vsp-tab-runs – skip inject.");
      return null;
    }

    if (document.getElementById("vsp-run-fullscan-zone")) {
      console.log(LOG_PREFIX, "Run panel đã tồn tại – bỏ qua inject.");
      return $("vsp-run-fullscan-zone");
    }

    const zone = document.createElement("section");
    zone.id = "vsp-run-fullscan-zone";
    zone.className = "vsp-section vsp-section-stack vsp-run-fullscan-zone";

    zone.innerHTML = `
      <div class="vsp-section-header">
        <div>
          <h2 class="vsp-section-title">Run full scan</h2>
          <p class="vsp-section-subtitle">
            Chạy full scan (EXT/FULL) cho một thư mục source và target URL. Kết quả sẽ xuất hiện trong tab Runs &amp; Data Source.
          </p>
        </div>
        <div class="vsp-section-meta">
          <span class="vsp-chip vsp-chip-soft" id="vsp-run-fullscan-last-status">
            Ready
          </span>
        </div>
      </div>

      <div class="vsp-card vsp-card-soft">
        <div class="vsp-card-body vsp-form vsp-grid vsp-grid-3 vsp-run-fullscan-grid">
          <label class="vsp-field vsp-field-wide">
            <span class="vsp-field-label">Source root (thư mục scan)</span>
            <input type="text" id="vsp-run-src-root" class="vsp-input"
                   placeholder="/home/test/Data/khach6">
          </label>

          <label class="vsp-field vsp-field-wide">
            <span class="vsp-field-label">Target URL (app URL)</span>
            <input type="text" id="vsp-run-target-url" class="vsp-input"
                   placeholder="https://demo.demasterpro.com">
          </label>

          <label class="vsp-field">
            <span class="vsp-field-label">Profile</span>
            <select id="vsp-run-profile" class="vsp-input">
              <option value="FULL_EXT">FULL_EXT</option>
              <option value="EXT">EXT</option>
              <option value="FAST">FAST</option>
            </select>
          </label>
        </div>

        <div class="vsp-card-footer vsp-flex vsp-justify-between vsp-items-center vsp-gap-2">
          <div class="vsp-text-xs vsp-text-subtle">
            Profile &amp; mặc định có thể chỉnh trong tab Settings.
          </div>
          <button type="button" class="vsp-btn vsp-btn-primary" id="vsp-run-fullscan-btn">
            Run full scan
          </button>
        </div>
      </div>
    `;

    // Đặt panel lên đầu tab Runs (trước bảng runs)
    if (pane.firstChild) {
      pane.insertBefore(zone, pane.firstChild);
    } else {
      pane.appendChild(zone);
    }

    console.log(LOG_PREFIX, "Injected Run full scan panel.");
    return zone;
  }

  async function loadDefaultsFromSettings() {
    let resp, data;
    try {
      resp = await fetch("/api/vsp/settings_ui_v1", { method: "GET" });
    } catch (e) {
      console.error(LOG_PREFIX, "fetch settings error", e);
      return;
    }

    try {
      data = await resp.json();
    } catch (e) {
      console.error(LOG_PREFIX, "settings JSON parse error", e);
      return;
    }

    if (!data) return;

    let settings = null;
    if (data.ok && data.settings) {
      settings = data.settings;
    } else {
      settings = data;
    }
    if (!settings) return;

    const srcRoot = settings.src_root || settings.source_root || "";
    const runRoot = settings.run_root || settings.out_root || settings.run_dir_root || "";
    const defProfile = settings.default_profile || settings.profile_default || "FULL_EXT";

    const elSrc = $("vsp-run-src-root");
    const elUrl = $("vsp-run-target-url");
    const elProf = $("vsp-run-profile");

    if (elSrc && srcRoot) elSrc.value = srcRoot;
    // target_url không lấy từ settings, người dùng tự nhập theo app
    if (elProf && defProfile) {
      for (const opt of elProf.options) {
        if (opt.value === defProfile) {
          elProf.value = defProfile;
          break;
        }
      }
    }

    console.log(LOG_PREFIX, "Filled defaults from settings.");
  }

  function setStatus(text, mode) {
    const el = $("vsp-run-fullscan-last-status");
    if (!el) return;
    el.textContent = text;
    el.classList.remove("vsp-chip-ok", "vsp-chip-warn", "vsp-chip-error");

    if (mode === "ok") el.classList.add("vsp-chip-ok");
    if (mode === "warn") el.classList.add("vsp-chip-warn");
    if (mode === "err") el.classList.add("vsp-chip-error");
  }

  async function doRunFullScan() {
    const btn = $("vsp-run-fullscan-btn");
    const elSrc = $("vsp-run-src-root");
    const elUrl = $("vsp-run-target-url");
    const elProf = $("vsp-run-profile");

    const srcRoot = elSrc ? elSrc.value.trim() : "";
    const targetUrl = elUrl ? elUrl.value.trim() : "";
    const profile = elProf ? elProf.value.trim() : "FULL_EXT";

    if (!srcRoot) {
      alert("Vui lòng nhập Source root (thư mục scan).");
      return;
    }
    if (!targetUrl) {
      alert("Vui lòng nhập Target URL.");
      return;
    }

    const payload = {
      profile: profile,
      source_root: srcRoot,
      target_url: targetUrl,
    };

    console.log(LOG_PREFIX, "POST /api/vsp/run_full_scan", payload);
    setStatus("Running...", "warn");
    if (btn) {
      btn.disabled = true;
      btn.textContent = "Running...";
    }

    let resp, data;
    try {
      resp = await fetch("/api/vsp/run_full_scan", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });
    } catch (e) {
      console.error(LOG_PREFIX, "run_full_scan network error", e);
      setStatus("Error (network)", "err");
      if (btn) {
        btn.disabled = false;
        btn.textContent = "Run full scan";
      }
      alert("Lỗi network khi gọi run_full_scan. Xem console.");
      return;
    }

    try {
      data = await resp.json();
    } catch (e) {
      console.error(LOG_PREFIX, "run_full_scan response JSON error", e);
      setStatus("Error (response)", "err");
      if (btn) {
        btn.disabled = false;
        btn.textContent = "Run full scan";
      }
      alert("Scan đã chạy nhưng không đọc được phản hồi JSON.");
      return;
    }

    if (data && data.ok === false) {
      console.error(LOG_PREFIX, "API error", data.error);
      setStatus("Failed: " + (data.error || "unknown"), "err");
      if (btn) {
        btn.disabled = false;
        btn.textContent = "Run full scan";
      }
      alert("Run full scan FAILED: " + (data.error || "unknown"));
      return;
    }

    const runId = data.run_id || data.id || "(unknown)";
    console.log(LOG_PREFIX, "Run started, run_id =", runId);
    setStatus("Started: " + runId, "ok");
    if (btn) {
      btn.disabled = false;
      btn.textContent = "Run full scan";
    }
    alert("Run full scan started: " + runId + "\nBạn có thể xem tiến trình ở tab Runs & Reports / Data Source.");
  }

  function bindRunButton() {
    const btn = $("vsp-run-fullscan-btn");
    if (!btn) {
      console.log(LOG_PREFIX, "Không thấy nút Run full scan.");
      return;
    }
    btn.addEventListener("click", function () {
      doRunFullScan().catch((err) =>
        console.error(LOG_PREFIX, "doRunFullScan error", err)
      );
    });
  }

  async function init() {
    const pane = document.getElementById("vsp-tab-runs");
    if (!pane) {
      console.log(LOG_PREFIX, "Không trong layout Runs – skip init.");
      return;
    }
    injectRunPanel();
    await loadDefaultsFromSettings();
    bindRunButton();
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", init);
  } else {
    init();
  }

  console.log(LOG_PREFIX, "vsp_runs_fullscan_panel_v1.js loaded.");
})();

})();
/* ==== END: static/js/vsp_runs_fullscan_panel_v1.js ==== */

/* ==== BEGIN: static/js/vsp_runs_kpi_reports_v1.js ==== */
(function(){
'use strict';
(function(){

  // VSP_ROUTE_GUARD_RUNS_ONLY_V1
  function __vsp_is_runs_only_v1(){
    try {
      const h = (location.hash||"").toLowerCase();
      return h.startsWith("#runs") || h.includes("#runs/");
    } catch(_) { return false; }
  }
  if(!__vsp_is_runs_only_v1()){
    try{ console.info("[VSP_ROUTE_GUARD_RUNS_ONLY_V1] skip", "vsp_runs_kpi_reports_v1.js", "hash=", location.hash); }catch(_){}
    return;
  }

  // === VSP_DISABLE_RUNS_KPI_V1_BY_MASTER ===
  if (window.VSP_COMMERCIAL_RUNS_MASTER) return;
  // === END VSP_DISABLE_RUNS_KPI_V1_BY_MASTER ===
})();
(function () {
  console.log('[VSP_RUNS_KPI_V1] loaded');

  function ensureStyle() {
    if (document.getElementById('vsp-runs-kpi-style')) return;
    var s = document.createElement('style');
    s.id = 'vsp-runs-kpi-style';
    s.textContent = `
      .vsp-runs-kpi-grid {
        display: grid;
        grid-template-columns: repeat(4, minmax(0, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
      }
      .vsp-runs-kpi-card {
        background: rgba(15,23,42,0.9);
        border-radius: 0.75rem;
        padding: 0.9rem 1rem;
        border: 1px solid rgba(148,163,184,0.25);
      }
      .vsp-runs-kpi-label {
        font-size: 0.75rem;
        letter-spacing: 0.12em;
        text-transform: uppercase;
        color: #9ca3af;
        margin-bottom: 0.25rem;
      }
      .vsp-runs-kpi-value {
        font-size: 1.25rem;
        font-weight: 600;
        color: #e5e7eb;
      }
      .vsp-runs-kpi-sub {
        font-size: 0.75rem;
        color: #6b7280;
        margin-top: 0.15rem;
      }
      th.vsp-runs-report-header {
        text-align: right;
      }
      td.vsp-runs-report-cell {
        text-align: right;
        white-space: nowrap;
        font-size: 0.75rem;
      }
      td.vsp-runs-report-cell a {
        color: #38bdf8;
        text-decoration: none;
        margin-left: 0.25rem;
      }
      td.vsp-runs-report-cell a:hover {
        text-decoration: underline;
      }
    `;
    document.head.appendChild(s);
  }

  function computeKpi(data) {
    var items = Array.isArray(data.items) ? data.items : [];
    var kpi = data.kpi || {};
    var totalRuns = kpi.total_runs || data.total || items.length;

    var lastN = kpi.last_n || Math.min(items.length, 10);
    var lastItems = items.slice(0, lastN);

    var done = 0, fail = 0;
    lastItems.forEach(function (r) {
      var st = (r.status || '').toUpperCase();
      if (st === 'DONE' || st === 'SUCCESS' || st === 'OK') done++;
      else if (st && st !== 'RUNNING') fail++;
    });

    var avgFindings = kpi.avg_findings_per_run_last_n;
    if (avgFindings == null && items.length) {
      var sum = items.reduce(function (acc, r) {
        return acc + (r.total_findings || r.total || 0);
      }, 0);
      avgFindings = sum / items.length;
    }

    var toolSet = new Set();
    var totalToolEntries = 0;
    items.forEach(function (r) {
      var tools = r.tools_enabled || r.tools || r.tool_list;
      if (Array.isArray(tools)) {
        totalToolEntries += tools.length;
        tools.forEach(function (t) { toolSet.add(t); });
      }
    });
    var avgToolsPerRun = items.length ? (totalToolEntries / items.length) : 0;

    return {
      totalRuns: totalRuns,
      lastN: lastN,
      doneLastN: done,
      failLastN: fail,
      avgFindings: avgFindings || 0,
      distinctTools: Array.from(toolSet),
      avgToolsPerRun: avgToolsPerRun
    };
  }

  function renderKpi(pane, k) {
    ensureStyle();
    if (!pane) return;

    var existing = document.getElementById('vsp-runs-kpi-row');
    if (existing) existing.remove();

    var wrap = document.createElement('div');
    wrap.id = 'vsp-runs-kpi-row';
    wrap.className = 'vsp-runs-kpi-grid';

    function card(label, value, sub) {
      return (
        '<div class="vsp-runs-kpi-card">' +
          '<div class="vsp-runs-kpi-label">' + label + '</div>' +
          '<div class="vsp-runs-kpi-value">' + value + '</div>' +
          (sub ? '<div class="vsp-runs-kpi-sub">' + sub + '</div>' : '') +
        '</div>'
      );
    }

    var toolsLabel = k.distinctTools.length
      ? k.distinctTools.join(', ')
      : 'N/A';

    wrap.innerHTML =
      card('Total runs', k.totalRuns, 'Tổng số lần scan đã chạy') +
      card('Last ' + k.lastN + ' runs',
           k.doneLastN + ' DONE / ' + k.failLastN + ' FAIL',
           'Trạng thái các run gần nhất') +
      card('Avg findings / run',
           Math.round(k.avgFindings).toLocaleString('en-US'),
           'Dựa trên ' + k.lastN + ' run gần nhất') +
      card('Tools per run',
           k.avgToolsPerRun ? k.avgToolsPerRun.toFixed(1) : 'N/A',
           toolsLabel);

    // chèn vào đầu pane (trước bảng)
    pane.insertBefore(wrap, pane.firstChild);
  }

  function enhanceReports(pane, data) {
    var table = pane.querySelector('table');
    if (!table) return;

    var theadRow = table.querySelector('thead tr');
    if (theadRow && !theadRow.querySelector('.vsp-runs-report-header')) {
      var th = document.createElement('th');
      th.textContent = 'Reports';
      th.className = 'vsp-runs-report-header';
      theadRow.appendChild(th);
    }

    var tbody = table.querySelector('tbody');
    if (!tbody) return;

    var items = Array.isArray(data.items) ? data.items : [];
    var rows = Array.from(tbody.rows);

    rows.forEach(function (tr, idx) {
      var item = items[idx] || {};
      var runId = item.run_id || (tr.cells[0] && tr.cells[0].textContent.trim());
      if (!runId) return;

      var td = document.createElement('td');
      td.className = 'vsp-runs-report-cell';
      td.innerHTML =
        '<a href="/api/vsp/run_export_v3?run_id=' + encodeURIComponent(runId) + '&fmt=html" target="_blank">HTML</a>' +
        '<a href="/api/vsp/run_export_v3?run_id=' + encodeURIComponent(runId) + '&fmt=pdf" target="_blank">PDF</a>' +
        '<a href="/api/vsp/run_export_v3?run_id=' + encodeURIComponent(runId) + '&fmt=zip" target="_blank">ZIP</a>';
      tr.appendChild(td);
    });
  }

  function hydrateRunsKpi() {
    var pane = document.getElementById('vsp-runs-main');
    if (!pane) {
      console.warn('[VSP_RUNS_KPI_V1] Không thấy #vsp-runs-main');
      return;
    }

    fetch('/api/vsp/runs_index_v3_fs?limit=40')
      .then(function (r) { return r.json(); })
      .then(function (data) {
        var k = computeKpi(data);
        renderKpi(pane, k);
        enhanceReports(pane, data);
        console.log('[VSP_RUNS_KPI_V1] hydrated', k);
      })
      .catch(function (err) {
        console.error('[VSP_RUNS_KPI_V1] error', err);
      });
  }

  function onReady(fn) {
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', fn);
    } else {
      fn();
    }
  }

  onReady(function () {
    // chạy 1 lần; nếu sau này router thay đổi DOM, có thể gọi lại
    setTimeout(hydrateRunsKpi, 800);
  });
})();

})();
/* ==== END: static/js/vsp_runs_kpi_reports_v1.js ==== */

/* ==== BEGIN: static/js/vsp_runs_overall_from_gate_shim_p0_v1.js ==== */
(function(){
'use strict';
/* VSP_RUNS_OVERALL_FROM_GATE_SHIM_P0_V1
 * Goal: replace "N/A" overall in Runs table using canonical gate summary endpoint.
 * Works even if runs panel JS is bundled/unknown.
 */
(function(){
  'use strict';

  // VSP_ROUTE_GUARD_RUNS_ONLY_V1
  function __vsp_is_runs_only_v1(){
    try {
      const h = (location.hash||"").toLowerCase();
      return h.startsWith("#runs") || h.includes("#runs/");
    } catch(_) { return false; }
  }
  if(!__vsp_is_runs_only_v1()){
    try{ console.info("[VSP_ROUTE_GUARD_RUNS_ONLY_V1] skip", "vsp_runs_overall_from_gate_shim_p0_v1.js", "hash=", location.hash); }catch(_){}
    return;
  }

  if (window.__VSP_RUNS_OVERALL_SHIM_P0_V1) return;
  window.__VSP_RUNS_OVERALL_SHIM_P0_V1 = true;

  const TAG = 'VSP_RUNS_OVERALL_SHIM_P0_V1';
  const RID_RE = /\bVSP_[A-Z0-9]+_\d{8}_\d{6}\b/;
  const CACHE = new Map(); // rid -> overall

  function esc(s){
    return String(s ?? '')
      .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
      .replaceAll('"','&quot;').replaceAll("'","&#039;");
  }

  function ensureStyle(){
    if (document.getElementById('vsp-runs-overall-shim-style')) return;
    const st = document.createElement('style');
    st.id = 'vsp-runs-overall-shim-style';
    st.textContent = `
      .vsp-ov-bdg{display:inline-flex;align-items:center;justify-content:center;
        padding:4px 10px;border-radius:999px;font-size:12px;font-weight:900;
        border:1px solid rgba(255,255,255,.14);letter-spacing:.2px}
      .vsp-ov-green{background:rgba(0,255,140,.12)}
      .vsp-ov-amber{background:rgba(255,190,0,.14)}
      .vsp-ov-red{background:rgba(255,70,70,.14)}
      .vsp-ov-na{background:rgba(160,160,160,.14)}
    `;
    document.head.appendChild(st);
  }

  async function fetchGateOverall(rid){
    if (!rid) return '';
    if (CACHE.has(rid)) return CACHE.get(rid) || '';
    try{
      const r = await fetch(`/api/vsp/run_gate_summary_v1/${encodeURIComponent(rid)}`, { credentials:'same-origin' });
      const j = await r.json().catch(()=>null);
      const ov = (j && (j.overall || (j.overall && j.overall.status))) ? String(j.overall || j.overall.status).toUpperCase() : '';
      CACHE.set(rid, ov);
      return ov;
    }catch(e){
      CACHE.set(rid, '');
      return '';
    }
  }

  function verdictClass(ov){
    const v = String(ov||'').toUpperCase();
    if (v === 'GREEN' || v === 'OK') return 'vsp-ov-green';
    if (v === 'AMBER' || v === 'DEGRADED') return 'vsp-ov-amber';
    if (v === 'RED' || v === 'FAIL') return 'vsp-ov-red';
    return 'vsp-ov-na';
  }

  function findRunsRoot(){
    // from your console log: mounted into #vsp-runs-main
    return document.querySelector('#vsp-runs-main')
      || document.querySelector('[data-vsp-runs]')
      || document.querySelector('#runs_panel')
      || document.body;
  }

  function findRowRid(el){
    if (!el) return '';
    // walk up a bit and search text for RID
    let cur = el;
    for (let i=0;i<6 && cur;i++){
      const txt = (cur.innerText || '').match(RID_RE);
      if (txt && txt[0]) return txt[0];
      cur = cur.parentElement;
    }
    return '';
  }

  async function patchOnce(){
    ensureStyle();
    const root = findRunsRoot();
    if (!root) return;

    // Find "N/A" chips inside runs area
    const nodes = Array.from(root.querySelectorAll('*'))
      .filter(n => n && n.childElementCount === 0)
      .filter(n => (n.textContent || '').trim() === 'N/A');

    if (!nodes.length) return;

    let changed = 0;
    for (const n of nodes){
      // only patch visible ones
      const rid = findRowRid(n);
      if (!rid) continue;

      const ov = await fetchGateOverall(rid);
      const v = ov || 'N/A';

      n.classList.add('vsp-ov-bdg');
      n.classList.remove('vsp-ov-green','vsp-ov-amber','vsp-ov-red','vsp-ov-na');
      n.classList.add(verdictClass(v));

      // keep same width-ish but show real verdict
      n.textContent = (v === 'OK' ? 'GREEN' : v);
      n.title = `RID=${rid}`;
      changed += 1;
    }

    if (changed) console.log(`[${TAG}] patched overall badges:`, changed);
  }

  function boot(){
    let ticks = 0;
    const iv = setInterval(async () => {
      ticks += 1;
      await patchOnce();
      // stop after ~12s (commercial: no infinite polling)
      if (ticks >= 24) clearInterval(iv);
    }, 500);
  }

  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', boot, { once:true });
  } else {
    boot();
  }
})();

})();
/* ==== END: static/js/vsp_runs_overall_from_gate_shim_p0_v1.js ==== */

/* ==== BEGIN: static/js/vsp_runs_overall_from_gate_shim_p0_v2.js ==== */
(function(){
'use strict';
(function(){
  'use strict';

  // VSP_ROUTE_GUARD_RUNS_ONLY_V1
  function __vsp_is_runs_only_v1(){
    try {
      const h = (location.hash||"").toLowerCase();
      return h.startsWith("#runs") || h.includes("#runs/");
    } catch(_) { return false; }
  }
  if(!__vsp_is_runs_only_v1()){
    try{ console.info("[VSP_ROUTE_GUARD_RUNS_ONLY_V1] skip", "vsp_runs_overall_from_gate_shim_p0_v2.js", "hash=", location.hash); }catch(_){}
    return;
  }

  if (window.__VSP_RUNS_OVERALL_SHIM_P0_V2) return;
  window.__VSP_RUNS_OVERALL_SHIM_P0_V2 = true;

  const TAG='VSP_RUNS_OVERALL_SHIM_P0_V2';
  const RID_RE=/\bVSP_[A-Z0-9]+_\d{8}_\d{6}\b/;
  const cache=new Map(); // rid->overall

  function ensureStyle(){
    if (document.getElementById('vsp-ov-style-v2')) return;
    const st=document.createElement('style');
    st.id='vsp-ov-style-v2';
    st.textContent=`
      .vsp-ov-bdg{display:inline-flex;align-items:center;justify-content:center;
        padding:4px 10px;border-radius:999px;font-size:12px;font-weight:900;
        border:1px solid rgba(255,255,255,.14);letter-spacing:.2px}
      .vsp-ov-green{background:rgba(0,255,140,.12)}
      .vsp-ov-amber{background:rgba(255,190,0,.14)}
      .vsp-ov-red{background:rgba(255,70,70,.14)}
      .vsp-ov-na{background:rgba(160,160,160,.14)}
    `;
    document.head.appendChild(st);
  }

  function normOverall(v){
    v=String(v||'').toUpperCase();
    if (v==='OK') return 'GREEN';
    if (v==='FAIL') return 'RED';
    if (v==='DEGRADED') return 'AMBER';
    return v || 'N/A';
  }
  function cls(v){
    v=normOverall(v);
    if (v==='GREEN') return 'vsp-ov-green';
    if (v==='AMBER') return 'vsp-ov-amber';
    if (v==='RED') return 'vsp-ov-red';
    return 'vsp-ov-na';
  }

  async function fetchOverall(rid){
    if (!rid) return '';
    if (cache.has(rid)) return cache.get(rid)||'';
    try{
      const r=await fetch(`/api/vsp/run_gate_summary_v1/${encodeURIComponent(rid)}`, {credentials:'same-origin'});
      const j=await r.json().catch(()=>null);
      const ov = j ? (j.overall?.status || j.overall || '') : '';
      const v = normOverall(ov);
      cache.set(rid, v);
      return v;
    }catch(_){
      cache.set(rid,'');
      return '';
    }
  }

  function findRunsTable(){
    // pick the first big table in view (runs list)
    const tables=[...document.querySelectorAll('table')];
    return tables.find(t => (t.innerText||'').includes('RUN ID') && (t.innerText||'').includes('OVERALL')) || tables[0] || null;
  }

  function headerIndex(table, name){
    const ths=[...table.querySelectorAll('thead th, thead td, th')];
    for (let i=0;i<ths.length;i++){
      const tx=(ths[i].innerText||'').trim().toUpperCase();
      if (tx===name) return i;
    }
    return -1;
  }

  function cellAt(row, idx){
    const tds=[...row.querySelectorAll('td')];
    return (idx>=0 && idx<tds.length) ? tds[idx] : null;
  }

  async function patchOnce(){
    ensureStyle();
    const table=findRunsTable();
    if (!table) return;

    const idxOverall = headerIndex(table,'OVERALL');
    if (idxOverall < 0) return;

    const rows=[...table.querySelectorAll('tbody tr')];
    let changed=0;

    for (const tr of rows){
      const txt=(tr.innerText||'').match(RID_RE);
      const rid=txt && txt[0] ? txt[0] : '';
      if (!rid) continue;

      const td=cellAt(tr, idxOverall);
      if (!td) continue;

      const cur=(td.innerText||'').trim().toUpperCase();
      if (cur && cur !== 'N/A') continue;

      const ov=await fetchOverall(rid);
      if (!ov) continue;

      td.classList.add('vsp-ov-bdg');
      td.classList.remove('vsp-ov-green','vsp-ov-amber','vsp-ov-red','vsp-ov-na');
      td.classList.add(cls(ov));
      td.innerText = ov;
      td.title = `RID=${rid}`;
      changed++;
    }

    if (changed) console.log(`[${TAG}] patched`, changed, 'overall cells');
  }

  function boot(){
    let ticks=0;
    const iv=setInterval(async ()=>{
      ticks++;
      await patchOnce();
      if (ticks>=30) clearInterval(iv); // ~15s max
    }, 500);
  }

  if (document.readyState==='loading') document.addEventListener('DOMContentLoaded', boot, {once:true});
  else boot();
})();

})();
/* ==== END: static/js/vsp_runs_overall_from_gate_shim_p0_v2.js ==== */

/* ==== BEGIN: static/js/vsp_runs_overall_from_gate_shim_p0_v3.js ==== */
(function(){
'use strict';
(function(){
  'use strict';

  // VSP_ROUTE_GUARD_RUNS_ONLY_V1
  function __vsp_is_runs_only_v1(){
    try {
      const h = (location.hash||"").toLowerCase();
      return h.startsWith("#runs") || h.includes("#runs/");
    } catch(_) { return false; }
  }
  if(!__vsp_is_runs_only_v1()){
    try{ console.info("[VSP_ROUTE_GUARD_RUNS_ONLY_V1] skip", "vsp_runs_overall_from_gate_shim_p0_v3.js", "hash=", location.hash); }catch(_){}
    return;
  }

  if (window.__VSP_RUNS_OVERALL_SHIM_P0_V3) return;
  window.__VSP_RUNS_OVERALL_SHIM_P0_V3 = true;

  const TAG='VSP_RUNS_OVERALL_SHIM_P0_V3';
  const RID_RE=/\bVSP_[A-Z0-9]+_\d{8}_\d{6}\b/;
  const cache=new Map(); // rid->overall

  function ensureStyle(){
    if (document.getElementById('vsp-ov-style-v3')) return;
    const st=document.createElement('style');
    st.id='vsp-ov-style-v3';
    st.textContent=`
      .vsp-ov-bdg{display:inline-flex;align-items:center;justify-content:center;
        padding:4px 10px;border-radius:999px;font-size:12px;font-weight:900;
        border:1px solid rgba(255,255,255,.14)}
      .vsp-ov-green{background:rgba(0,255,140,.12)}
      .vsp-ov-amber{background:rgba(255,190,0,.14)}
      .vsp-ov-red{background:rgba(255,70,70,.14)}
      .vsp-ov-na{background:rgba(160,160,160,.14)}
    `;
    document.head.appendChild(st);
  }

  function norm(v){
    v=String(v||'').toUpperCase();
    if (v==='OK') return 'GREEN';
    if (v==='FAIL') return 'RED';
    if (v==='DEGRADED') return 'AMBER';
    return v || 'N/A';
  }
  function cls(v){
    v=norm(v);
    if (v==='GREEN') return 'vsp-ov-green';
    if (v==='AMBER') return 'vsp-ov-amber';
    if (v==='RED') return 'vsp-ov-red';
    return 'vsp-ov-na';
  }

  async function fetchOverall(rid){
    if (!rid) return '';
    if (cache.has(rid)) return cache.get(rid)||'';
    try{
      const r=await fetch(`/api/vsp/run_gate_summary_v1/${encodeURIComponent(rid)}`,{credentials:'same-origin'});
      const j=await r.json().catch(()=>null);
      const ov = j ? (j.overall?.status || j.overall || '') : '';
      const v = norm(ov);
      cache.set(rid, v);
      return v;
    }catch(_){
      cache.set(rid,'');
      return '';
    }
  }

  function findRunsTable(){
    const tables=[...document.querySelectorAll('table')];
    return tables.find(t => (t.innerText||'').includes('RUN ID') && (t.innerText||'').includes('OVERALL')) || null;
  }
  function headerIndex(table, name){
    const ths=[...table.querySelectorAll('thead th, thead td, th')];
    for (let i=0;i<ths.length;i++){
      const tx=(ths[i].innerText||'').trim().toUpperCase();
      if (tx===name) return i;
    }
    return -1;
  }
  function cellAt(row, idx){
    const tds=[...row.querySelectorAll('td')];
    return (idx>=0 && idx<tds.length) ? tds[idx] : null;
  }

  async function patchOnce(){
    ensureStyle();
    const table=findRunsTable();
    if (!table) return 0;

    const idxOverall = headerIndex(table,'OVERALL');
    if (idxOverall < 0) return 0;

    const rows=[...table.querySelectorAll('tbody tr')];
    let changed=0;

    for (const tr of rows){
      const m=(tr.innerText||'').match(RID_RE);
      const rid=m && m[0] ? m[0] : '';
      if (!rid) continue;

      const td=cellAt(tr, idxOverall);
      if (!td) continue;

      const cur=(td.innerText||'').trim().toUpperCase();
      if (cur && cur !== 'N/A') continue;

      const ov=await fetchOverall(rid);
      if (!ov) continue;

      td.classList.add('vsp-ov-bdg');
      td.classList.remove('vsp-ov-green','vsp-ov-amber','vsp-ov-red','vsp-ov-na');
      td.classList.add(cls(ov));
      td.innerText=ov;
      td.title=`RID=${rid}`;
      changed++;
    }
    return changed;
  }

  function boot(){
    let ticks=0;
    const iv=setInterval(async ()=>{
      ticks++;
      const n=await patchOnce();
      if (n) console.log(`[${TAG}] patched`, n, 'cells');
      if (ticks>=120) clearInterval(iv); // ~2 phút
    }, 500);

    // mutation observer: runs render async
    const mo=new MutationObserver(()=>{ patchOnce(); });
    mo.observe(document.documentElement || document.body, {subtree:true, childList:true});
    setTimeout(()=>{ try{mo.disconnect();}catch(_){ } }, 120000);
  }

  if (document.readyState==='loading') document.addEventListener('DOMContentLoaded', boot, {once:true});
  else boot();
})();

})();
/* ==== END: static/js/vsp_runs_overall_from_gate_shim_p0_v3.js ==== */

/* ==== BEGIN: static/js/vsp_runs_overview_layout_v1.js ==== */
(function(){
'use strict';
// VSP_RUNS_OVERVIEW_LAYOUT_V3
// Gom 3 KPI Runs overview thành grid + hiển thị Last run chip (fix insertBefore).

(function() {

  // VSP_ROUTE_GUARD_RUNS_ONLY_V1
  function __vsp_is_runs_only_v1(){
    try {
      const h = (location.hash||"").toLowerCase();
      return h.startsWith("#runs") || h.includes("#runs/");
    } catch(_) { return false; }
  }
  if(!__vsp_is_runs_only_v1()){
    try{ console.info("[VSP_ROUTE_GUARD_RUNS_ONLY_V1] skip", "vsp_runs_overview_layout_v1.js", "hash=", location.hash); }catch(_){}
    return;
  }

  const LOG = "[VSP_RUNS_LAYOUT]";
  let applied = false;

  function findCards() {
    const tab = document.querySelector("#vsp-tab-runs");
    if (!tab) return null;

    const titles = ["TOTAL RUNS", "CRITICAL + HIGH", "AVG FINDINGS / RUN"];
    const map = {};
    const els = tab.querySelectorAll("*");

    for (const el of els) {
      const text = (el.textContent || "").trim().toUpperCase();
      if (!text) continue;
      for (const t of titles) {
        if (!map[t] && text === t) {
          let card = el.closest(".vsp-kpi-card");
          if (!card) card = el.closest("div");
          if (card) map[t] = card;
        }
      }
    }

    const cards = titles.map((t) => map[t]).filter(Boolean);
    if (cards.length !== 3) return null;
    return { tab, cards };
  }

  function buildLastRunChip(tab, grid) {
    if (tab.querySelector(".vsp-runs-last-run")) return;

    fetch("/api/vsp/runs_index_v3_fs?limit=1")
      .then((r) => r.json())
      .then((data) => {
        const items = data.items || [];
        const last = items[0];
        if (!last) {
          console.log(LOG, "Không có run nào để render Last run chip.");
          return;
        }

        const runId = last.run_id || last.id || "N/A";
        const started = last.started_at || last.start_time || "";
        const findings =
          last.total_findings !== undefined
            ? last.total_findings
            : last.findings_total !== undefined
            ? last.findings_total
            : null;

        const chip = document.createElement("div");
        chip.className = "vsp-runs-last-run";
        chip.innerHTML =
          '<div class="vsp-runs-last-run-label">Last run</div>' +
          '<div class="vsp-runs-last-run-meta">' +
          `<span>${runId}</span>` +
          `<span>${started || "time: N/A"}</span>` +
          `<span>${findings != null ? findings + " findings" : "findings: N/A"}</span>` +
          "</div>";

        const parent = grid.parentElement || tab;
        if (grid.nextSibling && grid.nextSibling.parentNode === parent) {
          parent.insertBefore(chip, grid.nextSibling);
        } else {
          parent.appendChild(chip);
        }

        console.log(LOG, "Đã render Last run chip.");
      })
      .catch((e) => {
        console.warn(LOG, "Lỗi fetch runs_index_v3:", e);
      });
  }

  function applyLayout() {
    if (applied) return true;
    const res = findCards();
    if (!res) return false;
    const { tab, cards } = res;

    let grid = tab.querySelector(".vsp-runs-overview-grid");
    if (!grid) {
      grid = document.createElement("div");
      grid.className = "vsp-runs-overview-grid";
      const parent = cards[0].parentElement || tab;
      parent.insertBefore(grid, cards[0]);
    }

    cards.forEach((c) => grid.appendChild(c));
    applied = true;
    console.log(LOG, "Applied grid layout cho Runs overview.");
    buildLastRunChip(tab, grid);
    return true;
  }

  function start() {
    let tries = 0;
    const maxTries = 30;
    const timer = setInterval(() => {
      if (applyLayout()) {
        clearInterval(timer);
      } else if (++tries >= maxTries) {
        clearInterval(timer);
        console.warn(LOG, "Give up sau", tries, "lần, không tìm đủ 3 KPI card.");
      }
    }, 400);
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", start);
  } else {
    start();
  }
})();

})();
/* ==== END: static/js/vsp_runs_overview_layout_v1.js ==== */

/* ==== BEGIN: static/js/vsp_runs_reports_v2.js ==== */
(function(){
'use strict';
/*
 * VSP 2025 – Runs & Reports legacy stub
 * File này CHỈ để tránh crash từ các template cũ còn gọi loadRunsTable().
 * Tuyệt đối không dùng logic VSP_RUNS_UI_V1 nữa.
 */
const VSP_RUNS_REPORTS_LOG = "[VSP_RUNS_REPORTS_STUB]";

console.log(VSP_RUNS_REPORTS_LOG, "loaded – legacy runs-report features are disabled.");

window.loadRunsTable = function () {
  // Nếu template cũ còn gọi loadRunsTable(), chỉ log 1 dòng nhẹ rồi bỏ qua.
  console.log(VSP_RUNS_REPORTS_LOG, "loadRunsTable() called – ignoring legacy implementation.");
};

})();
/* ==== END: static/js/vsp_runs_reports_v2.js ==== */

/* ==== BEGIN: static/js/vsp_runs_scan_panel_commercial_v1.js ==== */
(function(){
'use strict';
(function(){

  // VSP_ROUTE_GUARD_RUNS_ONLY_V1
  function __vsp_is_runs_only_v1(){
    try {
      const h = (location.hash||"").toLowerCase();
      return h.startsWith("#runs") || h.includes("#runs/");
    } catch(_) { return false; }
  }
  if(!__vsp_is_runs_only_v1()){
    try{ console.info("[VSP_ROUTE_GUARD_RUNS_ONLY_V1] skip", "vsp_runs_scan_panel_commercial_v1.js", "hash=", location.hash); }catch(_){}
    return;
  }

  if (window.__VSP_RUNSCAN_COMM_V1__) return;
  window.__VSP_RUNSCAN_COMM_V1__ = true;

  function qs(sel, root){ return (root||document).querySelector(sel); }
  function qsa(sel, root){ return Array.from((root||document).querySelectorAll(sel)); }
  function esc(s){ return String(s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }

  function ensureCss(){
    if (document.getElementById("vsp-runscan-css-v1")) return;
    var l = document.createElement("link");
    l.id = "vsp-runscan-css-v1";
    l.rel = "stylesheet";
    l.href = "/static/css/vsp_runscan_commercial_v1.css";
    document.head.appendChild(l);
  }

  function findRunsPane(){
    return document.getElementById("vsp-runs-main") || qs("#vsp-runs-main") || qs("[data-pane='runs']");
  }

  function makePanel(){
    var wrap = document.createElement("div");
    wrap.className = "vsp-runscan-wrap";
    wrap.id = "vsp-runscan-comm-v1";

    wrap.innerHTML = ''
      + '<div class="vsp-runscan-head">'
      + '  <div>'
      + '    <div class="vsp-runscan-title"><span class="vsp-runscan-dot"></span><span>Run Scan Now</span></div>'
      + '    <div class="vsp-runscan-sub">Trigger FULL_EXT pipeline (VSP_CI_OUTER) + poll run status</div>'
      + '  </div>'
      + '  <div class="vsp-runscan-actions">'
      + '    <button class="vsp-runscan-btn primary" id="vsp-runscan-btn-run">Run Scan Now</button>'
      + '    <button class="vsp-runscan-btn" id="vsp-runscan-btn-refresh">Refresh Status</button>'
      + '  </div>'
      + '</div>'
      + '<div class="vsp-runscan-body">'
      + '  <div class="vsp-runscan-grid">'
      + '    <div class="vsp-runscan-field">'
      + '      <div class="vsp-runscan-label">Target path</div>'
      + '      <input class="vsp-runscan-input" id="vsp-runscan-target" value="/home/test/Data/SECURITY-10-10-v4" />'
      + '      <div class="vsp-runscan-kv">'
      + '        <div class="k">Profile</div><div class="v"><select class="vsp-runscan-select" id="vsp-runscan-profile">'
      + '          <option value="FULL_EXT" selected>FULL_EXT</option>'
      + '          <option value="EXT">EXT</option>'
      + '        </select></div>'
      + '        <div class="k">Mode</div><div class="v"><select class="vsp-runscan-select" id="vsp-runscan-mode">'
      + '          <option value="local" selected>local</option>'
      + '          <option value="ci">ci</option>'
      + '        </select></div>'
      + '      </div>'
      + '      <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap">'
      + '        <span class="vsp-runscan-pill info" id="vsp-runscan-pill-status"><span class="k">status</span><span id="vsp-runscan-status">IDLE</span></span>'
      + '        <span class="vsp-runscan-pill" id="vsp-runscan-pill-req"><span class="k">request</span><span id="vsp-runscan-req">-</span></span>'
      + '        <span class="vsp-runscan-pill" id="vsp-runscan-pill-run"><span class="k">ci_run</span><span id="vsp-runscan-run">-</span></span>'
      + '        <span class="vsp-runscan-pill" id="vsp-runscan-pill-gate"><span class="k">gate</span><span id="vsp-runscan-gate">-</span></span>'
      + '        <span class="vsp-runscan-pill" id="vsp-runscan-pill-find"><span class="k">has_findings</span><span id="vsp-runscan-find">-</span></span>'
      + '      </div>'
      + '    </div>'
      + '    <div>'
      + '      <div class="vsp-runscan-log">'
      + '        <div class="vsp-runscan-log-head">'
      + '          <div>Pipeline tail</div>'
      + '          <div id="vsp-runscan-last">-</div>'
      + '        </div>'
      + '        <div class="vsp-runscan-log-body" id="vsp-runscan-tail">(no data)</div>'
      + '      </div>'
      + '    </div>'
      + '  </div>'
      + '</div>';

    return wrap;
  }

  var POLL_TIMER = null;
  var CURRENT_REQ = null;

  function setPillClass(pill, kind){
    pill.classList.remove("good","warn","bad","info");
    pill.classList.add(kind);
  }

  function renderStatus(js){
    var st = (js && js.status) ? String(js.status) : "UNKNOWN";
    var gate = (js && js.gate) ? String(js.gate) : "-";
    var req = (js && js.request_id) ? String(js.request_id) : (CURRENT_REQ||"-");
    var run = (js && js.ci_run_id) ? String(js.ci_run_id) : "-";
    var hasF = (js && js.flag && (js.flag.has_findings!==undefined)) ? String(js.flag.has_findings) : "-";
    var fin = (js && js.final!==undefined) ? String(js.final) : "-";

    qs("#vsp-runscan-status").textContent = st;
    qs("#vsp-runscan-req").textContent = req;
    qs("#vsp-runscan-run").textContent = run;
    qs("#vsp-runscan-gate").textContent = gate + " / rc=" + fin;
    qs("#vsp-runscan-find").textContent = hasF;

    var pill = qs("#vsp-runscan-pill-status");
    if (st === "DONE" || st === "PASSED" || st === "SUCCESS") setPillClass(pill, "good");
    else if (st === "FAILED" || st === "ERROR") setPillClass(pill, "bad");
    else if (st === "RUNNING" || st === "PENDING") setPillClass(pill, "warn");
    else setPillClass(pill, "info");

    var tail = (js && js.tail && Array.isArray(js.tail)) ? js.tail : null;
    if (tail && tail.length){
      qs("#vsp-runscan-tail").textContent = tail.join("\n");
    } else {
      qs("#vsp-runscan-tail").textContent = "(no tail)";
    }
    qs("#vsp-runscan-last").textContent = new Date().toLocaleString();
  }

  async function apiRun(){
    var target = qs("#vsp-runscan-target").value.trim();
    var profile = qs("#vsp-runscan-profile").value;
    var mode = qs("#vsp-runscan-mode").value;

    if (!target) {
      alert("Target path is empty.");
      return;
    }

    renderStatus({status:"PENDING", gate:"-", request_id:"...", ci_run_id:"-", flag:{has_findings:"-"}, tail:["[UI] sending POST /api/vsp/run ..."]});

    var payload = { mode: mode, profile: profile, target_type: "path", target: target };

    var r = await fetch("/api/vsp/run", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });

    var js = null;
    try{ js = await r.json(); }catch(e){}

    if (!r.ok || !js || !js.ok){
      renderStatus({status:"ERROR", gate:"-", request_id:"-", ci_run_id:"-", flag:{has_findings:"-"}, tail:[
        "[UI] run failed",
        "HTTP=" + r.status,
        (js && js.error) ? String(js.error) : "(no json error)"
      ]});
      return;
    }

    CURRENT_REQ = js.request_id;
    renderStatus({status:"PENDING", gate:"-", request_id: js.request_id, ci_run_id:"-", flag:{has_findings:"-"}, tail:[
      "[UI] Scan request accepted.",
      "request_id=" + js.request_id,
      "profile=" + js.profile,
      "target=" + js.target,
      "ci_mode=" + js.ci_mode
    ]});

    startPoll(js.request_id);
  }

  async function apiStatus(reqId){
    var r = await fetch("/api/vsp/run_status/" + encodeURIComponent(reqId), {method:"GET"});
    if (!r.ok) {
      renderStatus({status:"ERROR", gate:"-", request_id:reqId, ci_run_id:"-", flag:{has_findings:"-"}, tail:["[UI] run_status HTTP="+r.status]});
      return;
    }
    var js = await r.json();
    renderStatus(js);

    var st = String(js.status || "");
    if (st === "DONE" || st === "FAILED" || st === "ERROR") stopPoll();
  }

  function startPoll(reqId){
    stopPoll();
    if (!reqId) return;
    POLL_TIMER = setInterval(function(){ apiStatus(reqId).catch(function(){}); }, 1500);
    // immediate
    apiStatus(reqId).catch(function(){});
  }

  function stopPoll(){
    if (POLL_TIMER){ clearInterval(POLL_TIMER); POLL_TIMER = null; }
  }

  function wire(panel){
    qs("#vsp-runscan-btn-run", panel).addEventListener("click", function(){
      apiRun().catch(function(e){
        renderStatus({status:"ERROR", gate:"-", request_id:"-", ci_run_id:"-", flag:{has_findings:"-"}, tail:["[UI] exception", String(e)]});
      });
    });
    qs("#vsp-runscan-btn-refresh", panel).addEventListener("click", function(){
      if (CURRENT_REQ) apiStatus(CURRENT_REQ).catch(function(){});
      else renderStatus({status:"IDLE", gate:"-", request_id:"-", ci_run_id:"-", flag:{has_findings:"-"}, tail:["[UI] no request_id yet"]});
    });
  }

  function mount(){
    ensureCss();
    var pane = findRunsPane();
    if (!pane) return false;

    // ensure only one
    var existed = document.getElementById("vsp-runscan-comm-v1");
    if (existed) return true;

    // insert on top of Runs pane (below its header KPI row if exists)
    var panel = makePanel();

    // Prefer placing after the filters row (search/select) if exists
    var anchor = qs(".vsp-runs-toolbar", pane) || qs(".vsp-filter-row", pane) || qs(".vsp-runs-header", pane);
    if (anchor && anchor.parentNode) {
      anchor.parentNode.insertBefore(panel, anchor.nextSibling);
    } else {
      pane.insertBefore(panel, pane.firstChild);
    }

    wire(panel);
    return true;
  }

  // Expose for external hook
  window.VSP_RUNSCAN_MOUNT = mount;

  // retry mount
  var n=0, it=setInterval(function(){
    n++;
    if (mount()) { clearInterval(it); return; }
    if (n>120) clearInterval(it);
  }, 200);

})();

})();
/* ==== END: static/js/vsp_runs_scan_panel_commercial_v1.js ==== */

/* ==== BEGIN: static/js/vsp_runs_scan_panel_hook_v1.js ==== */
(function(){
'use strict';
(function(){

  // VSP_ROUTE_GUARD_RUNS_ONLY_V1
  function __vsp_is_runs_only_v1(){
    try {
      const h = (location.hash||"").toLowerCase();
      return h.startsWith("#runs") || h.includes("#runs/");
    } catch(_) { return false; }
  }
  if(!__vsp_is_runs_only_v1()){
    try{ console.info("[VSP_ROUTE_GUARD_RUNS_ONLY_V1] skip", "vsp_runs_scan_panel_hook_v1.js", "hash=", location.hash); }catch(_){}
    return;
  }

  if (window.__VSP_RUNSCAN_HOOK_V1__) return;
  window.__VSP_RUNSCAN_HOOK_V1__ = true;

  function isRunsHash() {
    return (location.hash || "").toLowerCase().includes("runs");
  }

  function loadPanelOnce() {
    if (window.__VSP_RUNSCAN_PANEL_LOADED__) return;
    window.__VSP_RUNSCAN_PANEL_LOADED__ = true;

    // nếu panel đã được include bằng script tag thì không cần load lại
    var already = Array.from(document.scripts || []).some(function(s){
      return (s.src || "").includes("vsp_runs_scan_panel_ui_v1.js");
    });
    if (already) {
      console.log("[VSP_RUNSCAN_HOOK] panel js already in DOM");
      return;
    }

    var s = document.createElement("script");
    s.src = "/static/js/vsp_runs_scan_panel_ui_v1.js";
    s.defer = true;
    s.onload = function(){ console.log("[VSP_RUNSCAN_HOOK] panel js loaded"); };
    s.onerror = function(){ console.warn("[VSP_RUNSCAN_HOOK] failed to load panel js"); };
    document.head.appendChild(s);
  }

  function bindTabs() {
    // bắt click những element có text/id liên quan runs
    var nodes = Array.from(document.querySelectorAll("a,button,div"));
    nodes.forEach(function(x){
      var t = (x.textContent||"").trim().toLowerCase();
      var id = (x.id||"").toLowerCase();
      if (t === "runs & reports" || t === "runs" || id.includes("runs")) {
        if (x.__VSP_RUNSCAN_BOUND__) return;
        x.__VSP_RUNSCAN_BOUND__ = true;
        x.addEventListener("click", function(){
          setTimeout(function(){
            if (isRunsHash()) loadPanelOnce();
          }, 50);
        }, {passive:true});
      }
    });
  }

  window.addEventListener("hashchange", function(){
    if (isRunsHash()) loadPanelOnce();
  });

  window.addEventListener("load", function(){
    bindTabs();
    if (isRunsHash()) loadPanelOnce();
  });

  // retry vài lần vì router render chậm
  var n = 0;
  var it = setInterval(function(){
    n++;
    bindTabs();
    if (isRunsHash()) {
      loadPanelOnce();
      clearInterval(it);
    }
    if (n > 50) clearInterval(it);
  }, 200);
})();

})();
/* ==== END: static/js/vsp_runs_scan_panel_hook_v1.js ==== */

/* ==== BEGIN: static/js/vsp_runs_scan_panel_ui_v1.js ==== */
(function(){
'use strict';
/* VSP 2025 – Runs Scan Panel UI v1
 * - Form: target/profile/mode
 * - POST /api/vsp/run
 * - Poll /api/vsp/run_status/{

  // VSP_ROUTE_GUARD_RUNS_ONLY_V1
  function __vsp_is_runs_only_v1(){
    try {
      const h = (location.hash||"").toLowerCase();
      return h.startsWith("#runs") || h.includes("#runs/");
    } catch(_) { return false; }
  }
  if(!__vsp_is_runs_only_v1()){
    try{ console.info("[VSP_ROUTE_GUARD_RUNS_ONLY_V1] skip", "vsp_runs_scan_panel_ui_v1.js", "hash=", location.hash); }catch(_){}
    return;
  }
REQ_ID}
 * - Render Gate/FinalRC/ci_run_id/has_findings + tail log
 */
(function () {
  if (window.__VSP_RUNS_SCAN_PANEL_UI_V1__) return;
  window.__VSP_RUNS_SCAN_PANEL_UI_V1__ = true;

  function $(sel, root) { return (root || document).querySelector(sel); }
  function el(tag, attrs, html) {
    var e = document.createElement(tag);
    if (attrs) Object.keys(attrs).forEach(function (k) { e.setAttribute(k, attrs[k]); });
    if (html != null) e.innerHTML = html;
    return e;
  }

  function safeText(s) {
    return String(s == null ? "" : s)
      .replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
  }

  function nowTS() {
    var d = new Date();
    function p(n){return (n<10?"0":"")+n;}
    return d.getFullYear()+"-"+p(d.getMonth()+1)+"-"+p(d.getDate())+" "+p(d.getHours())+":"+p(d.getMinutes())+":"+p(d.getSeconds());
  }

  function apiJson(url, opts) {
    opts = opts || {};
    opts.headers = Object.assign({ "Accept": "application/json" }, opts.headers || {});
    return fetch(url, opts).then(function (r) {
      return r.text().then(function (t) {
        var j = null;
        try { j = JSON.parse(t); } catch (e) {}
        if (!r.ok) {
          var msg = (j && (j.error || j.message)) ? (j.error || j.message) : (t || ("HTTP " + r.status));
          var err = new Error(msg);
          err.status = r.status;
          err.body = t;
          throw err;
        }
        return j != null ? j : {};
      });
    });
  }

  function wait(ms) { return new Promise(function (res) { setTimeout(res, ms); }); }

  function findRunsPane() {
    // ưu tiên đúng id tab runs
    return document.getElementById("vsp-tab-runs")
      || document.getElementById("vsp-pane-runs")
      || document.querySelector("[data-tab='runs']")
      || document.querySelector("#runs")
      || null;
  }

  function ensurePanel(root) {
    var existing = root.querySelector("#vsp-runs-scan-panel-ui-v1");
    if (existing) return existing;

    var panel = el("div", { id: "vsp-runs-scan-panel-ui-v1" });
    panel.style.cssText = [
      "margin:14px 0 18px 0",
      "background:linear-gradient(180deg, rgba(19,24,50,.72), rgba(11,16,32,.62))",
      "border:1px solid rgba(255,255,255,.08)",
      "border-radius:16px",
      "padding:14px 14px",
      "box-shadow:0 12px 32px rgba(0,0,0,.35)"
    ].join(";");

    panel.innerHTML = [
      '<div style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;">',
      '  <div>',
      '    <div style="font-weight:700; letter-spacing:.2px; font-size:14px;">Run Scan Now</div>',
      '    <div style="opacity:.75; font-size:12px; margin-top:2px;">Trigger FULL_EXT pipeline (UI → CI OUTER) and poll status.</div>',
      '  </div>',
      '  <div id="vsp-runs-scan-badges" style="display:flex; gap:8px; flex-wrap:wrap;"></div>',
      '</div>',
      '<div style="height:10px"></div>',

      '<div style="display:grid; grid-template-columns: 1.4fr .8fr .7fr auto; gap:10px; align-items:end;">',
      '  <div>',
      '    <div style="font-size:12px; opacity:.75; margin-bottom:6px;">Target Path</div>',
      '    <input id="vsp-scan-target" style="width:100%; padding:10px 10px; border-radius:12px; border:1px solid rgba(255,255,255,.10); background:rgba(5,8,20,.55); color:#E5E7EB; outline:none;" placeholder="/home/test/Data/SECURITY-10-10-v4" />',
      '  </div>',
      '  <div>',
      '    <div style="font-size:12px; opacity:.75; margin-bottom:6px;">Profile</div>',
      '    <select id="vsp-scan-profile" style="width:100%; padding:10px 10px; border-radius:12px; border:1px solid rgba(255,255,255,.10); background:rgba(5,8,20,.55); color:#E5E7EB; outline:none;">',
      '      <option value="FULL_EXT">FULL_EXT</option>',
      '      <option value="EXT">EXT</option>',
      '    </select>',
      '  </div>',
      '  <div>',
      '    <div style="font-size:12px; opacity:.75; margin-bottom:6px;">Mode</div>',
      '    <select id="vsp-scan-mode" style="width:100%; padding:10px 10px; border-radius:12px; border:1px solid rgba(255,255,255,.10); background:rgba(5,8,20,.55); color:#E5E7EB; outline:none;">',
      '      <option value="local">LOCAL (UI)</option>',
      '      <option value="ci">CI (future)</option>',
      '    </select>',
      '  </div>',
      '  <div style="display:flex; gap:10px; justify-content:flex-end;">',
      '    <button id="vsp-scan-run" style="padding:10px 14px; border-radius:12px; border:1px solid rgba(255,255,255,.14); background:rgba(99,102,241,.20); color:#E5E7EB; font-weight:700; cursor:pointer;">Run Scan Now</button>',
      '    <button id="vsp-scan-stop" style="padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.10); background:rgba(148,163,184,.10); color:#E5E7EB; font-weight:700; cursor:pointer;" title="Stop polling only">Stop</button>',
      '  </div>',
      '</div>',

      '<div style="height:12px"></div>',
      '<div id="vsp-scan-msg" style="font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; font-size:12px; opacity:.9;"></div>',

      '<div style="height:10px"></div>',
      '<div style="display:grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap:10px;">',
      '  <div class="vsp-kpi-mini" id="vsp-mini-status"></div>',
      '  <div class="vsp-kpi-mini" id="vsp-mini-gate"></div>',
      '  <div class="vsp-kpi-mini" id="vsp-mini-final"></div>',
      '  <div class="vsp-kpi-mini" id="vsp-mini-runid"></div>',
      '</div>',

      '<div style="height:12px"></div>',
      '<details open style="border:1px solid rgba(255,255,255,.08); border-radius:14px; padding:10px 12px; background:rgba(0,0,0,.18);">',
      '  <summary style="cursor:pointer; font-weight:700; font-size:12px; opacity:.9;">Live Log Tail</summary>',
      '  <div style="height:10px"></div>',
      '  <pre id="vsp-scan-tail" style="margin:0; white-space:pre-wrap; word-break:break-word; font-size:11px; line-height:1.35; opacity:.92;"></pre>',
      '</details>'
    ].join("");

    // mini KPI style
    var style = el("style");
    style.textContent = [
      "#vsp-runs-scan-panel-ui-v1 .vsp-kpi-mini{",
      "  border:1px solid rgba(255,255,255,.08); border-radius:14px; padding:10px 12px;",
      "  background:rgba(5,8,20,.35);",
      "}",
      "#vsp-runs-scan-panel-ui-v1 .vsp-kpi-mini .k{font-size:11px; opacity:.72; margin-bottom:4px}",
      "#vsp-runs-scan-panel-ui-v1 .vsp-kpi-mini .v{font-size:14px; font-weight:800; letter-spacing:.2px}",
      "#vsp-runs-scan-panel-ui-v1 .pill{padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.10); font-size:11px; font-weight:800; opacity:.95}",
      "#vsp-runs-scan-panel-ui-v1 .pill.ok{background:rgba(16,185,129,.12)}",
      "#vsp-runs-scan-panel-ui-v1 .pill.warn{background:rgba(245,158,11,.12)}",
      "#vsp-runs-scan-panel-ui-v1 .pill.bad{background:rgba(239,68,68,.12)}",
      "#vsp-runs-scan-panel-ui-v1 .pill.neu{background:rgba(148,163,184,.10)}"
    ].join("\n");
    panel.appendChild(style);

    root.prepend(panel);
    return panel;
  }

  function setMini(id, key, val) {
    var box = document.getElementById(id);
    if (!box) return;
    box.innerHTML = '<div class="k">' + safeText(key) + '</div><div class="v">' + safeText(val) + '</div>';
  }

  function setBadges(data) {
    var wrap = document.getElementById("vsp-runs-scan-badges");
    if (!wrap) return;
    wrap.innerHTML = "";
    var gate = (data && data.gate) ? String(data.gate) : "—";
    var st = (data && data.status) ? String(data.status) : "—";
    var hf = (data && data.flag && data.flag.has_findings != null) ? ("has_findings=" + data.flag.has_findings) : "has_findings=?";
    function pill(txt, cls){ var p=el("div",{class:"pill "+cls}); p.textContent=txt; return p; }

    var clsGate = gate === "PASS" ? "ok" : (gate === "FAIL" ? "bad" : "neu");
    var clsSt = (st === "DONE" || st === "SUCCESS") ? "ok" : (st === "FAILED" ? "bad" : "warn");
    wrap.appendChild(pill("GATE: " + gate, clsGate));
    wrap.appendChild(pill("STATUS: " + st, clsSt));
    wrap.appendChild(pill(hf, (String(hf).endsWith("=1") ? "warn" : "neu")));
  }

  var pollCtl = { stop:false, timer:null, reqId:null };

  function stopPolling(msg) {
    pollCtl.stop = true;
    pollCtl.reqId = null;
    if (pollCtl.timer) { clearTimeout(pollCtl.timer); pollCtl.timer = null; }
    var m = document.getElementById("vsp-scan-msg");
    if (m && msg) m.innerHTML = '<span style="opacity:.8">['+safeText(nowTS())+']</span> ' + safeText(msg);
  }

  async function poll(reqId) {
    pollCtl.stop = false;
    pollCtl.reqId = reqId;

    while (!pollCtl.stop) {
      try {
        var data = await apiJson("/api/vsp/run_status/" + encodeURIComponent(reqId));
        setBadges(data);

        setMini("vsp-mini-status", "STATUS", data.status || "—");
        setMini("vsp-mini-gate", "GATE", data.gate || "—");
        setMini("vsp-mini-final", "FINAL RC", (data.final != null ? String(data.final) : "—"));
        setMini("vsp-mini-runid", "CI RUN_ID", data.ci_run_id || "—");

        var tail = document.getElementById("vsp-scan-tail");
        if (tail) {
          var lines = Array.isArray(data.tail) ? data.tail : [];
          tail.textContent = lines.join("\n");
        }

        var msg = document.getElementById("vsp-scan-msg");
        if (msg) {
          msg.innerHTML = '<span style="opacity:.8">['+safeText(nowTS())+']</span> '
            + 'Polling <b>' + safeText(reqId) + '</b>'
            + (data.ci_run_id ? (' → <b>'+safeText(data.ci_run_id)+'</b>') : '');
        }

        // terminal conditions
        var st = String(data.status || "").toUpperCase();
        if (st === "DONE" || st === "SUCCESS" || st === "FAILED") {
          // stop polling automatically
          stopPolling("Terminal status: " + st);
          return;
        }

      } catch (e) {
        var msg2 = document.getElementById("vsp-scan-msg");
        if (msg2) msg2.innerHTML = '<span style="opacity:.8">['+safeText(nowTS())+']</span> '
          + '<span style="color:#FCA5A5; font-weight:800">Polling error:</span> ' + safeText(e.message || String(e));
      }

      await wait(2000);
    }
  }

  async function runScan() {
    var target = (document.getElementById("vsp-scan-target") || {}).value || "";
    var profile = (document.getElementById("vsp-scan-profile") || {}).value || "FULL_EXT";
    var mode = (document.getElementById("vsp-scan-mode") || {}).value || "local";

    // defaults
    if (!target.trim()) target = "/home/test/Data/SECURITY-10-10-v4";

    // persist
    try {
      localStorage.setItem("vsp_scan_target", target);
      localStorage.setItem("vsp_scan_profile", profile);
      localStorage.setItem("vsp_scan_mode", mode);
    } catch (e) {}

    stopPolling(); // stop previous polling
    var msg = document.getElementById("vsp-scan-msg");
    if (msg) msg.innerHTML = '<span style="opacity:.8">['+safeText(nowTS())+']</span> Triggering scan...';

    var body = {
      mode: mode,
      profile: profile,
      target_type: "path",
      target: target
    };

    try {
      var res = await apiJson("/api/vsp/run", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });

      var reqId = res.request_id || res.req_id || res.id;
      if (!reqId) {
        throw new Error("No request_id returned from /api/vsp/run");
      }

      if (msg) {
        msg.innerHTML = '<span style="opacity:.8">['+safeText(nowTS())+']</span> '
          + '<b>Accepted</b> → request_id=<b>' + safeText(reqId) + '</b>'
          + (res.ci_mode ? (' • ci_mode=' + safeText(res.ci_mode)) : '')
          + (res.message ? (' • ' + safeText(res.message)) : '');
      }

      // immediate poll
      poll(reqId);

    } catch (e) {
      if (msg) msg.innerHTML = '<span style="opacity:.8">['+safeText(nowTS())+']</span> '
        + '<span style="color:#FCA5A5; font-weight:800">Run error:</span> ' + safeText(e.message || String(e));
    }
  }

  function boot() {
    var pane = findRunsPane();
    if (!pane) return false;

    var panel = ensurePanel(pane);

    // load saved defaults
    try {
      var t = localStorage.getItem("vsp_scan_target");
      var p = localStorage.getItem("vsp_scan_profile");
      var m = localStorage.getItem("vsp_scan_mode");
      if (t) $("#vsp-scan-target", panel).value = t;
      else $("#vsp-scan-target", panel).value = "/home/test/Data/SECURITY-10-10-v4";
      if (p) $("#vsp-scan-profile", panel).value = p;
      if (m) $("#vsp-scan-mode", panel).value = m;
    } catch (e) {
      $("#vsp-scan-target", panel).value = "/home/test/Data/SECURITY-10-10-v4";
    }

    // bind events
    var btn = $("#vsp-scan-run", panel);
    var stop = $("#vsp-scan-stop", panel);
    if (btn) btn.addEventListener("click", function(){ runScan(); });
    if (stop) stop.addEventListener("click", function(){ stopPolling("Stopped polling by user."); });

    // init minis
    setMini("vsp-mini-status", "STATUS", "—");
    setMini("vsp-mini-gate", "GATE", "—");
    setMini("vsp-mini-final", "FINAL RC", "—");
    setMini("vsp-mini-runid", "CI RUN_ID", "—");
    setBadges({status:"—", gate:"—", flag:{has_findings:"?"}});

    return true;
  }

  // Run now + on hash changes (tab switch)
  function tryBootLoop() {
    if (boot()) return;
    // keep trying a bit (router loads panes async)
    var n = 0;
    var it = setInterval(function(){
      n++;
      if (boot() || n > 50) clearInterval(it);
    }, 200);
  }

  window.addEventListener("hashchange", function(){ tryBootLoop(); });
  window.addEventListener("load", function(){ tryBootLoop(); });
  // also run immediately if DOM already there
  tryBootLoop();

})();

})();
/* ==== END: static/js/vsp_runs_scan_panel_ui_v1.js ==== */

/* ==== BEGIN: static/js/vsp_runs_tab_8tools_v1.js ==== */
(function(){
'use strict';
/* VSP_RUNS_TAB_8TOOLS_V1 STUB (COMMERCIAL P0) */
(function(){
  'use strict';
  try{
    // Keep API surface so older code won't crash
    window.VSP_RUNS_TAB_8TOOLS_V1 = window.VSP_RUNS_TAB_8TOOLS_V1 || function(){ return true; };
  }catch(_){}
})();

})();
/* ==== END: static/js/vsp_runs_tab_8tools_v1.js ==== */

/* ==== BEGIN: static/js/vsp_runs_tab_force_v3.js ==== */
(function(){
'use strict';
'use strict';

  // VSP_ROUTE_GUARD_RUNS_ONLY_V1
  function __vsp_is_runs_only_v1(){
    try {
      const h = (location.hash||"").toLowerCase();
      return h.startsWith("#runs") || h.includes("#runs/");
    } catch(_) { return false; }
  }
  if(!__vsp_is_runs_only_v1()){
    try{ console.info("[VSP_ROUTE_GUARD_RUNS_ONLY_V1] skip", "vsp_runs_tab_force_v3.js", "hash=", location.hash); }catch(_){}
    return;
  }


(function () {
  const LOG = '[VSP_RUNS_FORCE_V3]';
  const ROOT_ID = 'vsp-runs-root';

  function $(id) {
    return document.getElementById(id);
  }

  function fmtDate(s) {
    if (!s) return '';
    try {
      // chấp mọi format ISO cơ bản
      const d = new Date(s);
      if (Number.isNaN(d.getTime())) return s;
      return d.toLocaleString();
    } catch (e) {
      return s;
    }
  }

  function renderError(msg) {
    const root = $(ROOT_ID);
    if (!root) return;
    root.innerHTML = `
      <div class="vsp-empty vsp-error">
        <div class="vsp-empty-title">Không tải được danh sách runs</div>
        <div class="vsp-empty-subtitle">${msg}</div>
      </div>
    `;
  }

  function renderEmpty() {
    const root = $(ROOT_ID);
    if (!root) return;
    root.innerHTML = `
      <div class="vsp-empty">
        <div class="vsp-empty-title">Chưa có run nào</div>
        <div class="vsp-empty-subtitle">Hãy chạy VSP FULL / QUICK rồi refresh tab Runs &amp; Reports.</div>
      </div>
    `;
  }

  function renderRuns(model) {
    const root = $(ROOT_ID);
    if (!root) return;

    const items = model && (model.items || model.runs || model.data || []);
    if (!items || !items.length) {
      renderEmpty();
      return;
    }

    const rows = items.map((r, idx) => {
      const id = r.run_id || r.id || `(run #${idx + 1})`;
      const dtStart = fmtDate(r.dt_started || r.dt_started_utc || r.started_at);
      const dtEnd   = fmtDate(r.dt_finished || r.dt_finished_utc || r.finished_at);
      const total   =
        (r.total_findings !== undefined ? r.total_findings :
        r.total ||
        (r.summary && (r.summary.total_findings || r.summary.total)) ||
        '');
      const gate =
        r.gate_color || r.gate || r.status || r.result || '';

      return `
        <tr class="vsp-table-row">
          <td class="vsp-cell-mono">${id}</td>
          <td>${dtStart || '-'}</td>
          <td>${dtEnd || '-'}</td>
          <td class="vsp-cell-number">${total === '' ? '-' : total}</td>
          <td>${gate || '-'}</td>
        </tr>
      `;
    }).join('');

    root.innerHTML = `
      <div class="vsp-table-wrapper">
        <table class="vsp-table">
          <thead>
            <tr>
              <th>Run ID</th>
              <th>Bắt đầu</th>
              <th>Kết thúc</th>
              <th>Tổng findings</th>
              <th>Gate / Status</th>
            </tr>
          </thead>
          <tbody>
            ${rows}
          </tbody>
        </table>
      </div>
    `;
  }

  async function loadRuns() {
    const root = $(ROOT_ID);
    if (!root) {
      console.warn(LOG, 'Không thấy #'+ROOT_ID+' – bỏ qua.');
      return;
    }

    root.innerHTML = `
      <div class="vsp-empty">
        <div class="vsp-empty-title">Đang tải Runs &amp; Reports...</div>
        <div class="vsp-empty-subtitle">Gọi /api/vsp/runs_index_v3_fs?limit=50</div>
      </div>
    `;

    const url = '/api/vsp/runs_index_v3_fs?limit=50';
    console.log(LOG, 'Fetching', url);
    try {
      const res = await fetch(url, { credentials: 'same-origin' });
      if (!res.ok) {
        throw new Error('HTTP ' + res.status);
      }
      const data = await res.json();
      console.log(LOG, 'Model:', data);
      renderRuns(data);
    } catch (err) {
      console.error(LOG, 'Load runs error:', err);
      renderError(err.message || String(err));
    }
  }

  document.addEventListener('DOMContentLoaded', function () {
    const root = $(ROOT_ID);
    if (!root) {
      console.warn(LOG, 'DOMContentLoaded nhưng không thấy #'+ROOT_ID);
      return;
    }
    console.log(LOG, 'initialized, auto load runs.');
    loadRuns();
    // cho phép console / script khác gọi lại nếu cần
    window.vspReloadRuns = loadRuns;
  });
})();

})();
/* ==== END: static/js/vsp_runs_tab_force_v3.js ==== */

/* ==== BEGIN: static/js/vsp_runs_tab_kpi_inject_v1.js ==== */
(function(){
'use strict';
;(function () {

  // VSP_ROUTE_GUARD_RUNS_ONLY_V1
  function __vsp_is_runs_only_v1(){
    try {
      const h = (location.hash||"").toLowerCase();
      return h.startsWith("#runs") || h.includes("#runs/");
    } catch(_) { return false; }
  }
  if(!__vsp_is_runs_only_v1()){
    try{ console.info("[VSP_ROUTE_GUARD_RUNS_ONLY_V1] skip", "vsp_runs_tab_kpi_inject_v1.js", "hash=", location.hash); }catch(_){}
    return;
  }

  const LOG_PREFIX = "[VSP_RUNS_KPI_INJECT]";

  function injectRunsKpiZone() {
    const pane = document.getElementById("vsp-tab-runs");
    if (!pane) {
      console.log(LOG_PREFIX, "Không tìm thấy #vsp-tab-runs – skip.");
      return;
    }

    // Tránh chèn trùng nhiều lần
    if (document.getElementById("vsp-runs-kpi-zone")) {
      console.log(LOG_PREFIX, "KPI zone đã tồn tại – bỏ qua.");
      return;
    }

    const wrapper = document.createElement("section");
    wrapper.id = "vsp-runs-kpi-zone";
    wrapper.className = "vsp-section vsp-section-stack vsp-runs-kpi-zone";

    wrapper.innerHTML = `
      <div class="vsp-section-header">
        <div>
          <h2 class="vsp-section-title">Runs overview</h2>
          <p class="vsp-section-subtitle">
            Tổng quan số lần scan, CRIT/HIGH và trung bình findings mỗi run.
          </p>
        </div>
      </div>

      <div class="vsp-grid vsp-grid-3">
        <div class="vsp-card vsp-card-soft">
          <div class="vsp-kpi-label">Total runs</div>
          <div class="vsp-kpi-value" id="vsp-runs-kpi-total">0</div>
        </div>

        <div class="vsp-card vsp-card-soft">
          <div class="vsp-kpi-label">Critical + High</div>
          <div class="vsp-kpi-value" id="vsp-runs-kpi-crit-high">0</div>
        </div>

        <div class="vsp-card vsp-card-soft">
          <div class="vsp-kpi-label">Avg findings / run</div>
          <div class="vsp-kpi-value" id="vsp-runs-kpi-avg">0.0</div>
        </div>
      </div>
    `;

    // Chèn lên đầu nội dung tab Runs (trước bảng, filter đang có)
    if (pane.firstChild) {
      pane.insertBefore(wrapper, pane.firstChild);
    } else {
      pane.appendChild(wrapper);
    }

    console.log(LOG_PREFIX, "Injected KPI zone vào #vsp-tab-runs.");
  }

  function init() {
    injectRunsKpiZone();
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", init);
  } else {
    init();
  }

  console.log(LOG_PREFIX, "vsp_runs_tab_kpi_inject_v1.js loaded.");
})();

})();
/* ==== END: static/js/vsp_runs_tab_kpi_inject_v1.js ==== */

/* ==== BEGIN: static/js/vsp_runs_tab_loader_v1.js ==== */
(function(){
'use strict';
(function () {

  // VSP_ROUTE_GUARD_RUNS_ONLY_V1
  function __vsp_is_runs_only_v1(){
    try {
      const h = (location.hash||"").toLowerCase();
      return h.startsWith("#runs") || h.includes("#runs/");
    } catch(_) { return false; }
  }
  if(!__vsp_is_runs_only_v1()){
    try{ console.info("[VSP_ROUTE_GUARD_RUNS_ONLY_V1] skip", "vsp_runs_tab_loader_v1.js", "hash=", location.hash); }catch(_){}
    return;
  }

  const LOG_PREFIX = "[VSP_RUNS_TAB2]";
  const API_URL = "/api/vsp/runs_index_v3";
  const TBODY_ID = "vsp-runs-tbody";

  function log() {
    console.log(LOG_PREFIX, ...arguments);
  }
  function warn() {
    console.warn(LOG_PREFIX, ...arguments);
  }

  function sev(run, key) {
    if (!run) return 0;
    const by = run.by_severity || run.severity_buckets || {};
    return by[key] || 0;
  }

  function buildRow(run, idx) {
    const tr = document.createElement('tr');

    const runId   = run.run_id || run.id || ("RUN_" + (idx + 1));
    const ts      = run.ts_start || run.started_at || run.start_time || run.created_at || "";
    const profile = run.profile || run.scan_profile || run.mode || run.run_profile || run.kind || "–";
    const srcPath = run.src_path || run.source_folder || run.source_root || run.module || run.project || "–";
    const url     = run.target_url || run.target || run.app_origin || run.url || run.repo || "–";

    const crit  = sev(run, "CRITICAL") || "–";
    const high  = sev(run, "HIGH")     || "–";
    const med   = sev(run, "MEDIUM")   || "–";
    const low   = sev(run, "LOW")      || "–";
    const info  = sev(run, "INFO")     || "–";
    const trace = sev(run, "TRACE")    || "–";

    let total;
    if (typeof run.total_findings === "number") {
      total = run.total_findings;
    } else {
      const by = run.by_severity || {};
      total = Object.values(by).reduce(
        (a, v) => a + (typeof v === "number" ? v : 0),
        0
      );
      if (!total) total = "–";
    }

    const toolsArr = run.tools_enabled || run.tools || run.enabled_tools || run.profiles_tools || [];
    const tools =
      Array.isArray(toolsArr) ? (toolsArr.length ? toolsArr.join(", ") : "–")
                              : (toolsArr || "–");

    tr.innerHTML =
      '<td><span class="mono">' + runId + '</span></td>' +
      '<td>' + (ts || '–') + '</td>' +
      '<td>' + profile + '</td>' +
      '<td>' + srcPath + '</td>' +
      '<td>' + url + '</td>' +
      '<td>' + crit + '</td>' +
      '<td>' + high + '</td>' +
      '<td>' + med + '</td>' +
      '<td>' + low + '</td>' +
      '<td>' + info + '</td>' +
      '<td>' + trace + '</td>' +
      '<td>' + total + '</td>' +
      '<td>' + tools + '</td>' +
      '<td>HTML · PDF · CSV</td>';

    return tr;
  }

  async function loadRunsTable() {
    const tbody = document.getElementById(TBODY_ID);
    if (!tbody) {
      warn("Không tìm thấy tbody#" + TBODY_ID);
      return;
    }

    tbody.innerHTML =
      '<tr><td colspan="14" style="color:#fff;padding:8px;">Đang tải RUN history...</td></tr>';

    let resp;
    try {
      resp = await fetch(API_URL, {
        headers: { Accept: "application/json" },
      });
    } catch (e) {
      warn("Lỗi fetch:", e);
      tbody.innerHTML =
        '<tr><td colspan="14" style="color:#fff;padding:8px;">Không kết nối được tới API runs_index_v3.</td></tr>';
      return;
    }

    if (!resp.ok) {
      warn("API error", resp.status, resp.statusText);
      tbody.innerHTML =
        '<tr><td colspan="14" style="color:#fff;padding:8px;">API runs_index_v3 trả lỗi ' +
        resp.status +
        '.</td></tr>';
      return;
    }

    let data;
    try {
      data = await resp.json();
    } catch (e) {
      warn("Lỗi parse JSON:", e);
      tbody.innerHTML =
        '<tr><td colspan="14" style="color:#fff;padding:8px;">Lỗi parse JSON từ API runs_index_v3.</td></tr>';
      return;
    }

    let runs = data && (data.items || data.runs || data);
    if (!Array.isArray(runs)) {
      warn("Định dạng bất ngờ:", data);
      runs = [];
    }

    tbody.innerHTML = "";

    if (!runs.length) {
      tbody.innerHTML =
        '<tr><td colspan="14" style="color:#fff;padding:8px;">Chưa có RUN nào trong hệ thống.</td></tr>';
      log("No runs.");
      return;
    }

    runs.forEach((run, idx) => {
      tbody.appendChild(buildRow(run, idx));
    });

    log("Rendered", runs.length, "runs.");
  }

  window.addEventListener("load", function () {
    log("window.load → loadRunsTable()");
    loadRunsTable();
  });

  window.VSP_RUNS = window.VSP_RUNS || {};
  window.VSP_RUNS.loadRunsTable = loadRunsTable;
})();

})();
/* ==== END: static/js/vsp_runs_tab_loader_v1.js ==== */

/* ==== BEGIN: static/js/vsp_runs_tab_resolved_v1.js ==== */
(function(){
'use strict';
// VSP_SAFE_DRILLDOWN_HARDEN_P0_V6
/* VSP_RUNS_TAB_RESOLVED_V3 (P1 commercial): use runs_index flags only (NO per-row status fetch) */

/* __VSP_DD_HANDLER_WRAP_P0_FINAL: normalize VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 to callable */
(function(){
  'use strict';

/* VSP_DD_ART_CALL_V1: commercial stable wrapper (fn OR {open:fn}) */
(function(){
  'use strict';
  if (window.VSP_DD_ART_CALL_V1) return;
  window.VSP_DD_ART_CALL_V1 = function(){
    var h = window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2;
    var args = Array.prototype.slice.call(arguments);
    try{
      if (typeof h === 'function') return h.apply(null, args);
      if (h && typeof h.open === 'function') return h.open.apply(h, args);
    }catch(e){
      try{ console.warn('[VSP][DD_CALL_V1]', e); }catch(_){}
    }
    return null;
  };
})();


  try{
    var h = window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2;
    if (h && typeof h !== 'function'){
      window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 = function(){
        return (window.__VSP_DD_SAFE_CALL__ || function(x){
          try{
            var a=[].slice.call(arguments,1);
            if (typeof x==='function') return x.apply(null,a);
            if (x && typeof x.open==='function') return x.open.apply(x,a);
          }catch(_){}
          return null;
        }).apply(null, [h].concat([].slice.call(arguments)));
      };
      try{ console.log('[VSP][P0] drilldown handler wrapped (obj->fn)'); }catch(_){}
    }
  }catch(e){}
})();

(function(){
  'use strict';

  // VSP_ROUTE_GUARD_RUNS_ONLY_V1
  function __vsp_is_runs_only_v1(){
    try {
      const h = (location.hash||"").toLowerCase();
      return h.startsWith("#runs") || h.includes("#runs/");
    } catch(_) { return false; }
  }
  if(!__vsp_is_runs_only_v1()){
    try{ console.info("[VSP_ROUTE_GUARD_RUNS_ONLY_V1] skip", "vsp_runs_tab_resolved_v1.js", "hash=", location.hash); }catch(_){}
    return;
  }


  if (window.__VSP_RUNS_V3_INITED) return;
  window.__VSP_RUNS_V3_INITED = true;

  const API_RUNS = "/api/vsp/runs_index_v3_fs_resolved";
  const API_STATUS = "/api/vsp/run_status_v2"; // link only
  const EXPORT_BASE = "/api/vsp/run_export_v3";
  const ART_BASE = "/api/vsp/artifacts_index_v1";

  function $(sel, root){ return (root||document).querySelector(sel); }
  function $all(sel, root){ return Array.from((root||document).querySelectorAll(sel)); }
  function esc(s){ return String(s ?? "").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
  function visibleEl(el){
    if (!el) return false;
    const r = el.getBoundingClientRect();
    return !!(el.offsetParent !== null && r.width > 240 && r.height > 160);
  }
  function pickBestContainer(){
    const cands = [
      "#tab-runs","#vsp4-runs","[data-tab='runs']","#runs",
      "#tabpane-runs","#pane-runs","#panel-runs",
      ".tab-pane.active",".tab-pane.is-active",
      ".vsp-main",".vsp-content","main",".content","#content",".page-content",
      "body"
    ];
    let best = document.body, bestArea = 0;
    for (const sel of cands){
      for (const el of $all(sel)){
        if (!visibleEl(el)) continue;
        const r = el.getBoundingClientRect();
        const area = r.width * r.height;
        if (area > bestArea){
          bestArea = area;
          best = el;
        }
      }
    }
    return best || document.body;
  }

  function boolAttr(v){
    if (v === true) return "1";
    if (v === false) return "0";
    return "?";
  }

  function normalizeItems(json){
    const items = (json && (json.items || json.data || json.runs)) || [];
    return Array.isArray(items) ? items : [];
  }

  function ensureUI(root){
    let tb = $("#vsp-runs-toolbar", root);
    if (!tb){
      tb = document.createElement("div");
      tb.id = "vsp-runs-toolbar";
      tb.className = "vsp-card vsp-card--tight";
      tb.style.marginBottom = "10px";
      tb.innerHTML = `
        <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
          <div style="display:flex; gap:8px; align-items:center;">
            <label style="opacity:.9">Limit</label>
            <select id="vsp-runs-limit" class="vsp-input">
              <option value="10">10</option>
              <option value="20">20</option>
              <option value="50" selected>50</option>
              <option value="100">100</option>
              <option value="200">200</option>
            </select>
          </div>

          <div style="display:flex; gap:8px; align-items:center;">
            <label style="opacity:.9">Has findings</label>
            <select id="vsp-runs-filter-hf" class="vsp-input">
              <option value="all" selected>All</option>
              <option value="1">Yes</option>
              <option value="0">No</option>
              <option value="?">Unknown</option>
            </select>
          </div>

          <div style="display:flex; gap:8px; align-items:center;">
            <label style="opacity:.9">Degraded</label>
            <select id="vsp-runs-filter-deg" class="vsp-input">
              <option value="all" selected>All</option>
              <option value="1">Yes</option>
              <option value="0">No</option>
              <option value="?">Unknown</option>
            </select>
          </div>

          <div style="display:flex; gap:8px; align-items:center; flex:1; min-width:240px;">
            <label style="opacity:.9">Search</label>
            <input id="vsp-runs-search" class="vsp-input" placeholder="run_id / target / status..." style="flex:1; min-width:180px;" />
          </div>

          <button id="vsp-runs-refresh" class="vsp-btn">Refresh</button>
          <span id="vsp-runs-meta" style="opacity:.8"></span>
        </div>
      `;
      root.prepend(tb);
    }

    let table = $("#vsp-runs-table", root);
    if (!table){
      table = document.createElement("table");
      table.id = "vsp-runs-table";
      table.className = "vsp-table";
      table.style.width = "100%";
      table.innerHTML = `
        <thead>
          <tr>
            <th style="width:200px;">Time</th>
            <th>Run ID</th>
            <th style="width:140px;">Target</th>
            <th style="width:120px;">Status</th>
            <th style="width:140px;">Findings</th>
            <th style="width:140px;">Degraded</th>
            <th style="width:220px;">Actions</th>
          </tr>
        </thead>
        <tbody id="vsp-runs-tbody"></tbody>
      `;
      root.insertBefore(table, tb.nextSibling);
    }

    const tbody = $("#vsp-runs-tbody", root) || table.querySelector("tbody");
    return {tb, table, tbody};
  }

  function renderRow(item){
    const rid = String(item.run_id || item.rid || item.id || "");
    const created = item.ts || item.created_at || item.created || item.time || item.started_at || "";
    const target = item.target_id || item.target || item.profile || item.app || "";
    const status = item.status || item.stage || item.state || "";

    const total = (typeof item.total_findings === "number") ? item.total_findings : null;
    const hasF = (typeof item.has_findings === "boolean") ? item.has_findings : (total !== null ? total > 0 : null);
    const dn = (typeof item.degraded_n === "number") ? item.degraded_n : null;
    const da = (typeof item.degraded_any === "boolean") ? item.degraded_any : (dn !== null ? dn > 0 : null);

    const hfAttr = boolAttr(hasF);
    const dgAttr = boolAttr(da);

    const hfText =
      hfAttr === "1" ? `YES${(typeof total === "number") ? ` (${total})` : ""}` :
      hfAttr === "0" ? `NO${(typeof total === "number") ? " (0)" : ""}` :
      "UNKNOWN";

    const dgText =
      dgAttr === "1" ? `YES${(typeof dn === "number") ? ` (${dn})` : ""}` :
      dgAttr === "0" ? `NO${(typeof dn === "number") ? " (0)" : ""}` :
      "UNKNOWN";

    const tr = document.createElement("tr");
    tr.dataset.rid = rid;
    tr.setAttribute("data-has-findings", hfAttr);
    tr.setAttribute("data-degraded", dgAttr);

    tr.innerHTML = `
      <td>${esc(created)}</td>
      <td><code>${esc(rid)}</code></td>
      <td>${esc(target)}</td>
      <td>${esc(status)}</td>
      <td><span class="vsp-pill" data-role="hf">${esc(hfText)}</span></td>
      <td><span class="vsp-pill" data-role="deg">${esc(dgText)}</span></td>
      <td style="display:flex; gap:8px; flex-wrap:wrap;">
        <a class="vsp-btn vsp-btn--ghost" href="${esc(API_STATUS + "/" + encodeURIComponent(rid))}" target="_blank" rel="noopener">status</a>
        <a class="vsp-btn vsp-btn--ghost" href="${esc(ART_BASE + "/" + encodeURIComponent(rid))}" target="_blank" rel="noopener">artifacts</a>
        <a class="vsp-btn vsp-btn--ghost" href="${esc("/api/vsp/run_export_cio_v2/" + encodeURIComponent(rid) + "?fmt=html")}" target="_blank" rel="noopener">cio</a>
<a class="vsp-btn vsp-btn--ghost" href="${esc(EXPORT_BASE + "/" + encodeURIComponent(rid) + "?fmt=html")}" target="_blank" rel="noopener">html</a>
        <a class="vsp-btn vsp-btn--ghost" href="${esc(EXPORT_BASE + "/" + encodeURIComponent(rid) + "?fmt=zip")}" target="_blank" rel="noopener">zip</a>
        <a class="vsp-btn vsp-btn--ghost" href="${esc(EXPORT_BASE + "/" + encodeURIComponent(rid) + "?fmt=pdf")}" target="_blank" rel="noopener">pdf</a>
      </td>
    `;
    return tr;
  }

  function applyFilters(root){
    const hf = $("#vsp-runs-filter-hf", root)?.value || "all";
    const dg = $("#vsp-runs-filter-deg", root)?.value || "all";
    const q  = ($("#vsp-runs-search", root)?.value || "").trim().toLowerCase();

    const rows = $all("#vsp-runs-tbody tr", root);
    let shown = 0;

    for (const tr of rows){
      const rhf = tr.getAttribute("data-has-findings") || "?";
      const rdg = tr.getAttribute("data-degraded") || "?";

      let ok = true;
      if (hf !== "all" && rhf !== hf) ok = false;
      if (dg !== "all" && rdg !== dg) ok = false;

      if (ok && q){
        const hay = (tr.textContent || "").toLowerCase();
        if (!hay.includes(q)) ok = false;
      }

      tr.hidden = !ok;
      if (ok) shown++;
    }

    const meta = $("#vsp-runs-meta", root);
    if (meta) meta.textContent = `Showing ${shown}/${rows.length}`;
  }

  async function loadRuns(root){
    const limit = parseInt($("#vsp-runs-limit", root)?.value || "50", 10) || 50;
    const url = `${API_RUNS}?limit=${encodeURIComponent(String(limit))}&hide_empty=0&filter=1`;

    const meta = $("#vsp-runs-meta", root);
    if (meta) meta.textContent = "Loading runs...";

    const r = await fetch(url, {credentials:"same-origin"});
    const json = await r.json().catch(() => ({}));
    const items = normalizeItems(json);

    window.__vspRunsItems = items;

    const {tbody} = ensureUI(root);
    tbody.innerHTML = "";
    for (const it of items){
      tbody.appendChild(renderRow(it));
    }

    applyFilters(root);
    if (meta) meta.textContent = `Loaded ${items.length} (flags from runs_index).`;
  }

  function bind(root){
    $("#vsp-runs-refresh", root)?.addEventListener("click", () => loadRuns(root).catch(e => console.error("[VSP_RUNS] load error", e)));
    $("#vsp-runs-limit", root)?.addEventListener("change", () => loadRuns(root).catch(e => console.error("[VSP_RUNS] load error", e)));

    const onFilter = () => applyFilters(root);
    $("#vsp-runs-filter-hf", root)?.addEventListener("change", onFilter);
    $("#vsp-runs-filter-deg", root)?.addEventListener("change", onFilter);
    $("#vsp-runs-search", root)?.addEventListener("input", onFilter);
  }

  function init(){
    const root = pickBestContainer();
    ensureUI(root);
    bind(root);
    loadRuns(root).catch(e => console.error("[VSP_RUNS] init load error", e));
  }

  if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", init);
  else init();
})();

})();
/* ==== END: static/js/vsp_runs_tab_resolved_v1.js ==== */

/* ==== BEGIN: static/js/vsp_runs_tab_simple_v1.js ==== */
(function(){
'use strict';
(function () {

  // VSP_ROUTE_GUARD_RUNS_ONLY_V1
  function __vsp_is_runs_only_v1(){
    try {
      const h = (location.hash||"").toLowerCase();
      return h.startsWith("#runs") || h.includes("#runs/");
    } catch(_) { return false; }
  }
  if(!__vsp_is_runs_only_v1()){
    try{ console.info("[VSP_ROUTE_GUARD_RUNS_ONLY_V1] skip", "vsp_runs_tab_simple_v1.js", "hash=", location.hash); }catch(_){}
    return;
  }

  const LOG_PREFIX = "[VSP_RUNS_TAB_SIMPLE_V1]";

  function log(msg, extra) {
    if (extra !== undefined) console.log(LOG_PREFIX, msg, extra);
    else console.log(LOG_PREFIX, msg);
  }

  function ensureContainer() {
    let container = document.getElementById("vsp-runs-overlay");
    if (container) return container;

    container = document.createElement("div");
    container.id = "vsp-runs-overlay";

    Object.assign(container.style, {
      position: "absolute",
      top: "140px",
      left: "260px",
      right: "24px",
      maxHeight: "360px",
      overflow: "auto",
      padding: "16px",
      borderRadius: "12px",
      background: "rgba(15,23,42,0.96)",
      border: "1px solid rgba(148,163,184,0.45)",
      backdropFilter: "blur(10px)",
      color: "#e5e7eb",
      zIndex: 9999
    });

    document.body.appendChild(container);
    return container;
  }

  function injectStyles() {
    if (document.getElementById("vsp-runs-tab-simple-style")) return;

    const css = `
      #vsp-runs-overlay h3 {
        margin: 0 0 12px 0;
        font-size: 14px;
        letter-spacing: .06em;
        text-transform: uppercase;
        color: #e5e7eb;
        opacity: .9;
      }
      #vsp-runs-overlay table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
      }
      #vsp-runs-overlay thead {
        border-bottom: 1px solid rgba(55,65,81,0.9);
      }
      #vsp-runs-overlay th,
      #vsp-runs-overlay td {
        padding: 8px 10px;
        text-align: left;
        white-space: nowrap;
      }
      #vsp-runs-overlay th {
        font-weight: 500;
        color: #9ca3af;
        text-transform: uppercase;
        font-size: 11px;
        letter-spacing: .08em;
      }
      #vsp-runs-overlay tbody tr:nth-child(even) {
        background: rgba(15,23,42,0.8);
      }
      #vsp-runs-overlay tbody tr:hover {
        background: rgba(30,64,175,0.45);
      }
      #vsp-runs-overlay .run-id {
        font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
        font-size: 12px;
        color: #e5e7eb;
      }
      #vsp-runs-overlay .badge {
        display: inline-flex;
        align-items: center;
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 10px;
        font-weight: 600;
        letter-spacing: .06em;
        text-transform: uppercase;
      }
      #vsp-runs-overlay .badge-ci {
        background: rgba(248,113,113,0.15);
        color: #fecaca;
        border: 1px solid rgba(248,113,113,0.7);
      }
      #vsp-runs-overlay .badge-full {
        background: rgba(52,211,153,0.15);
        color: #bbf7d0;
        border: 1px solid rgba(52,211,153,0.7);
      }
      #vsp-runs-overlay .score-pill {
        padding: 2px 10px;
        border-radius: 999px;
        font-size: 11px;
        border: 1px solid rgba(148,163,184,0.8);
        color: #e5e7eb;
      }
      #vsp-runs-overlay .score-pill-empty {
        opacity: .7;
        font-style: italic;
      }
    `;
    const style = document.createElement("style");
    style.id = "vsp-runs-tab-simple-style";
    style.textContent = css;
    document.head.appendChild(style);
  }

  function formatDate(iso) {
    if (!iso) return "-";
    const d = new Date(iso);
    if (Number.isNaN(d.getTime())) return iso;
    return d.toLocaleString();
  }

  function detectBadge(item) {
    const id = String(item.run_id || "");
    if (id.startsWith("RUN_VSP_CI_")) return { label: "CI", className: "badge badge-ci" };
    return { label: "FULL_EXT", className: "badge badge-full" };
  }

  function renderTable(container, items) {
    injectStyles();
    container.innerHTML = "";

    const title = document.createElement("h3");
    title.textContent = "Runs history (overlay simple view)";
    container.appendChild(title);

    if (!items || !items.length) {
      const empty = document.createElement("div");
      empty.textContent = "No runs found.";
      empty.style.fontSize = "13px";
      empty.style.color = "#9ca3af";
      container.appendChild(empty);
      return;
    }

    const table = document.createElement("table");
    const thead = document.createElement("thead");
    thead.innerHTML = `
      <tr>
        <th>Run ID</th>
        <th>Type</th>
        <th>Total findings</th>
        <th>Score</th>
        <th>Started at</th>
      </tr>
    `;
    table.appendChild(thead);

    const tbody = document.createElement("tbody");

    items.forEach((item, idx) => {
      const tr = document.createElement("tr");

      const tdId = document.createElement("td");
      tdId.innerHTML = `<span class="run-id">${item.run_id || "-"}</span>`;
      tr.appendChild(tdId);

      const tdType = document.createElement("td");
      const badge = detectBadge(item);
      tdType.innerHTML = `<span class="${badge.className}">${badge.label}</span>`;
      tr.appendChild(tdType);

      const tdTotal = document.createElement("td");
      tdTotal.textContent = item.total_findings != null ? item.total_findings : "-";
      tr.appendChild(tdTotal);

      const tdScore = document.createElement("td");
      const scoreVal = item.security_posture_score;
      if (typeof scoreVal === "number") {
        tdScore.innerHTML = `<span class="score-pill">${scoreVal}</span>`;
      } else {
        tdScore.innerHTML = `<span class="score-pill score-pill-empty">n/a</span>`;
      }
      tr.appendChild(tdScore);

      const tdStarted = document.createElement("td");
      tdStarted.textContent = formatDate(item.started_at);
      tr.appendChild(tdStarted);

      tbody.appendChild(tr);
    });

    table.appendChild(tbody);
    container.appendChild(table);
  }

  async function loadRunsSimple() {
    const container = ensureContainer();
    try {
      const resp = await fetch("/api/vsp/runs_index_v3_fs?limit=20");
      if (!resp.ok) throw new Error("HTTP " + resp.status);
      const data = await resp.json();
      if (!data || !data.ok) {
        log("API error", data);
        container.textContent = "Failed to load runs (API error).";
        return;
      }
      const items = Array.isArray(data.items) ? data.items : [];
      log("Loaded runs", { count: items.length });
      renderTable(container, items);
    } catch (err) {
      console.error(LOG_PREFIX, "Fetch error", err);
      const c = ensureContainer();
      c.textContent = "Failed to load runs (network error).";
    }
  }

  document.addEventListener("DOMContentLoaded", loadRunsSimple);
  window.vspRunsSimpleReload = loadRunsSimple;
})();

})();
/* ==== END: static/js/vsp_runs_tab_simple_v1.js ==== */

/* ==== BEGIN: static/js/vsp_runs_tab_simple_v2.js ==== */
(function(){
'use strict';

// === VSP_UI_DEGRADED_PANEL_V1 ===
function vspRenderDegradedToolsPanel(degraded) {

  // VSP_ROUTE_GUARD_RUNS_ONLY_V1
  function __vsp_is_runs_only_v1(){
    try {
      const h = (location.hash||"").toLowerCase();
      return h.startsWith("#runs") || h.includes("#runs/");
    } catch(_) { return false; }
  }
  if(!__vsp_is_runs_only_v1()){
    try{ console.info("[VSP_ROUTE_GUARD_RUNS_ONLY_V1] skip", "vsp_runs_tab_simple_v2.js", "hash=", location.hash); }catch(_){}
    return;
  }

  try {
    if (!degraded || (typeof degraded !== 'object')) return '';
    var keys = Object.keys(degraded);
    if (!keys.length) return '';
    var rows = keys.map(function(k){
      var v = degraded[k] || {};
      var reason = (v.reason || v.status || v.error || 'degraded');
      var tsec = (v.timeout_sec || v.timeout || '');
      return '<tr>' +
        '<td style="padding:6px 8px;border-bottom:1px solid rgba(255,255,255,.06)">' + String(k) + '</td>' +
        '<td style="padding:6px 8px;border-bottom:1px solid rgba(255,255,255,.06)">' + String(reason) + '</td>' +
        '<td style="padding:6px 8px;border-bottom:1px solid rgba(255,255,255,.06)">' + String(tsec) + '</td>' +
      '</tr>';
    }).join('');
    return '' +
      '<div style="margin:10px 0;padding:12px;border:1px solid rgba(255,255,255,.08);border-radius:14px;background:rgba(255,255,255,.03)">' +
        '<div style="font-weight:700;margin-bottom:8px">Degraded tools</div>' +
        '<table style="width:100%;border-collapse:collapse;font-size:13px">' +
          '<thead><tr>' +
            '<th style="text-align:left;padding:6px 8px;border-bottom:1px solid rgba(255,255,255,.10)">Tool</th>' +
            '<th style="text-align:left;padding:6px 8px;border-bottom:1px solid rgba(255,255,255,.10)">Reason</th>' +
            '<th style="text-align:left;padding:6px 8px;border-bottom:1px solid rgba(255,255,255,.10)">Timeout (sec)</th>' +
          '</tr></thead>' +
          '<tbody>' + rows + '</tbody>' +
        '</table>' +
      '</div>';
  } catch (e) { return ''; }
}
// === END VSP_UI_DEGRADED_PANEL_V1 ===

(function(){
  // === VSP_DISABLE_RUNS_TAB_SIMPLE_V2_BY_MASTER ===
  if (window.VSP_COMMERCIAL_RUNS_MASTER) return;
  // === END VSP_DISABLE_RUNS_TAB_SIMPLE_V2_BY_MASTER ===
})();
(function () {
  console.log("[VSP_RUNS] vsp_runs_tab_simple_v2.js loaded");

  const tbody = document.getElementById("vsp-runs-tbody");
  const btnApply = document.getElementById("vsp-runs-apply");
  const btnReset = document.getElementById("vsp-runs-reset");
  const inputFrom = document.getElementById("vsp-runs-from");
  const inputTo = document.getElementById("vsp-runs-to");
  const selectSeverity = document.getElementById("vsp-runs-severity");
  const inputTool = document.getElementById("vsp-runs-tool");
  const inputProfile = document.getElementById("vsp-runs-profile");

  let allRuns = [];

  async function loadRuns() {
    try {
      const resp = await fetch("/api/vsp/runs_index_v3_fs?limit=200");
      const data = await resp.json();
      if (!resp.ok || !data.items) {
        console.error("[VSP_RUNS] load error", data);
        return;
      }
      allRuns = data.items;
      renderRuns(allRuns);
    } catch (err) {
      console.error("[VSP_RUNS] loadRuns error", err);
    }
  }

  function getSelectedSeverities() {
    if (!selectSeverity) return [];
    return Array.from(selectSeverity.options)
      .filter(o => o.selected)
      .map(o => o.value);
  }

  function renderRuns(runs) {
    if (!tbody) return;
    tbody.innerHTML = "";
    runs.forEach(item => {
      const tr = document.createElement("tr");
      const runId = item.run_id || "";
      const createdAt = item.created_at || "";
      const profile = item.profile || "";
      const total = item.totals ? item.totals.total_findings || item.totals.total || "" : "";
      const gate = item.ci_gate_status || item.gate_status || "";
      tr.innerHTML = `
        <td>${runId}</td>
        <td>${createdAt}</td>
        <td>${profile}</td>
        <td>${total}</td>
        <td>${gate}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function applyFilter() {
    let filtered = [...allRuns];
    const from = inputFrom && inputFrom.value ? inputFrom.value : null;
    const to = inputTo && inputTo.value ? inputTo.value : null;
    const severities = getSelectedSeverities();
    const tool = (inputTool && inputTool.value || "").trim().toLowerCase();
    const profile = (inputProfile && inputProfile.value || "").trim().toLowerCase();

    filtered = filtered.filter(item => {
      const created = (item.created_at || "").slice(0, 10); // YYYY-MM-DD
      if (from && created && created < from) return false;
      if (to && created && created > to) return false;

      if (profile) {
        const p = (item.profile || "").toLowerCase();
        if (!p.includes(profile)) return false;
      }

      if (tool) {
        const byTool = item.by_tool || {};
        const toolNames = Object.keys(byTool).map(x => x.toLowerCase());
        if (!toolNames.some(x => x.includes(tool))) return false;
      }

      if (severities.length > 0) {
        const totals = item.by_severity || item.totals_by_severity || {};
        const hasAny = severities.some(sev => (totals[sev] || 0) > 0);
        if (!hasAny) return false;
      }

      return true;
    });

    renderRuns(filtered);
  }

  function resetFilter() {
    if (inputFrom) inputFrom.value = "";
    if (inputTo) inputTo.value = "";
    if (inputTool) inputTool.value = "";
    if (inputProfile) inputProfile.value = "";
    if (selectSeverity) {
      Array.from(selectSeverity.options).forEach(o => o.selected = false);
    }
    renderRuns(allRuns);
  }

  if (btnApply) btnApply.addEventListener("click", applyFilter);
  if (btnReset) btnReset.addEventListener("click", resetFilter);

  document.addEventListener("DOMContentLoaded", loadRuns);
})();

})();
/* ==== END: static/js/vsp_runs_tab_simple_v2.js ==== */

/* ==== BEGIN: static/js/vsp_runs_tab_v1.js ==== */
(function(){
'use strict';
// vsp_runs_tab_v1.js
// [VSP_RUNS_TAB] Commercial Runs & Reports - history + export V2 (DOM fallback)

(function () {
  'use strict';

  // VSP_ROUTE_GUARD_RUNS_ONLY_V1
  function __vsp_is_runs_only_v1(){
    try {
      const h = (location.hash||"").toLowerCase();
      return h.startsWith("#runs") || h.includes("#runs/");
    } catch(_) { return false; }
  }
  if(!__vsp_is_runs_only_v1()){
    try{ console.info("[VSP_ROUTE_GUARD_RUNS_ONLY_V1] skip", "vsp_runs_tab_v1.js", "hash=", location.hash); }catch(_){}
    return;
  }


  const LOG_PREFIX = '[VSP_RUNS_TAB]';
  const RUNS_API   = '/api/vsp/runs_index_v3';
  const EXPORT_API = '/api/vsp/run_export_v3';

  let currentRunId = null;
  let currentRunItem = null;

  function log() {
    console.log.apply(console, [LOG_PREFIX].concat(Array.from(arguments)));
  }

  function $(sel) {
    return document.querySelector(sel);
  }

  function setText(sel, val) {
    const el = $(sel);
    if (!el) return;
    el.textContent = val;
  }

  function getRunsTbody() {
    // Ưu tiên ID chuẩn
    let tbody = document.querySelector('#vsp-runs-table-body');
    if (tbody) return tbody;

    // Thử tìm tbody trong tab Runs
    const tab = document.querySelector('#vsp-tab-runs');
    if (!tab) return null;

    tbody = tab.querySelector('table tbody') || tab.querySelector('tbody');
    return tbody;
  }

  function computeKpi(items) {
    const totalRuns = items.length;

    let totalFindings = 0;
    let runsWithCriticalHigh = 0;

    items.forEach(function (item) {
      const total =
        item.total_findings ??
        item.total ??
        item.findings_total ??
        0;

      totalFindings += Number(total) || 0;

      const maxSev =
        item.severity_max ||
        item.max_severity ||
        item.max_severity_level ||
        '';

      if (typeof maxSev === 'string' &&
          (maxSev.includes('CRITICAL') || maxSev.includes('HIGH'))) {
        runsWithCriticalHigh += 1;
      }
    });

    const avgFindings = totalRuns > 0
      ? Math.round(totalFindings / totalRuns)
      : 0;

    return {
      totalRuns: totalRuns,
      totalFindings: totalFindings,
      runsWithCriticalHigh: runsWithCriticalHigh,
      avgFindings: avgFindings
    };
  }

  function selectRun(runId, item, tr) {
    currentRunId = runId;
    currentRunItem = item || null;

    document.querySelectorAll('.vsp-run-row.vsp-run-selected').forEach(function (row) {
      row.classList.remove('vsp-run-selected');
    });

    if (tr) {
      tr.classList.add('vsp-run-selected');
    }

    log('Selected run', runId);
  }

  function attachRowEvents(tr, runId, item) {
    tr.addEventListener('click', function () {
      selectRun(runId, item, tr);
    });

    tr.addEventListener('dblclick', function () {
      selectRun(runId, item, tr);
      doExport('html');
    });
  }

  function renderRunsTable(items) {
    const tbody = getRunsTbody();
    if (!tbody) {
      log('Không tìm thấy tbody Runs – skip render');
      return;
    }

    tbody.innerHTML = '';

    items.forEach(function (item, idx) {
      const tr = document.createElement('tr');
      tr.classList.add('vsp-run-row');

      if (idx === 0) {
        tr.classList.add('vsp-run-latest');
      }

      const runId =
        item.run_id ||
        item.id ||
        item.name ||
        '-';

      const profile =
        item.profile ||
        item.scan_profile ||
        item.run_profile ||
        '-';

      const posture =
        item.posture_score ??
        item.posture ??
        item.security_posture ??
        '';

      const total =
        item.total_findings ??
        item.total ??
        item.findings_total ??
        0;

      const maxSev =
        item.severity_max ||
        item.max_severity ||
        item.max_severity_level ||
        '-';

      const startedAt =
        item.started_at ||
        item.started ||
        item.created_at ||
        '';

      const cells = [
        runId,
        profile,
        posture === '' ? '-' : posture,
        total,
        maxSev,
        startedAt
      ];

      cells.forEach(function (text) {
        const td = document.createElement('td');
        td.textContent = text;
        tr.appendChild(td);
      });

      attachRowEvents(tr, runId, item);

      tbody.appendChild(tr);

      if (idx === 0) {
        selectRun(runId, item, tr);
      }
    });
  }

  function doExport(fmt) {
    if (!currentRunId) {
      alert('Hãy chọn 1 run trong bảng trước khi export.');
      return;
    }

    const url = new URL(EXPORT_API, window.location.origin);
    url.searchParams.set('run_id', currentRunId);
    url.searchParams.set('fmt', fmt);

    log('Export', fmt, 'run', currentRunId, '->', url.toString());

    if (fmt === 'html') {
      window.open(url.toString(), '_blank');
    } else {
      window.location.href = url.toString();
    }
  }

  function ensureExportToolbar() {
    const root =
      document.querySelector('#vsp-tab-runs') ||
      document.querySelector('#vsp-runs-panel') ||
      document.querySelector('#vsp-runs');

    if (!root) {
      log('Không tìm thấy container Runs tab để gắn toolbar export – skip');
      return;
    }

    if (root.querySelector('#vsp-run-export-html')) {
      return;
    }

    const toolbar = document.createElement('div');
    toolbar.className = 'vsp-runs-toolbar';

    const btnHtml = document.createElement('button');
    btnHtml.type = 'button';
    btnHtml.id = 'vsp-run-export-html';
    btnHtml.textContent = 'Export HTML';
    btnHtml.addEventListener('click', function () {
      doExport('html');
    });

    const btnZip = document.createElement('button');
    btnZip.type = 'button';
    btnZip.id = 'vsp-run-export-zip';
    btnZip.textContent = 'Export ZIP';
    btnZip.addEventListener('click', function () {
      doExport('zip');
    });

    const btnCsv = document.createElement('button');
    btnCsv.type = 'button';
    btnCsv.id = 'vsp-run-export-csv';
    btnCsv.textContent = 'Export CSV';
    btnCsv.addEventListener('click', function () {
      doExport('csv');
    });

    toolbar.appendChild(btnHtml);
    toolbar.appendChild(btnZip);
    toolbar.appendChild(btnCsv);

    root.insertBefore(toolbar, root.firstChild);

    log('Export toolbar attached vào Runs tab');
  }

  async function loadRunsHistory() {
    const tbody = getRunsTbody();
    if (!tbody) {
      log('Không có DOM Runs tbody – skip init history');
      return;
    }

    try {
      const url = new URL(RUNS_API, window.location.origin);
      url.searchParams.set('limit', '50');

      log('Fetching runs from', url.toString());

      const res = await fetch(url.toString(), {
        method: 'GET',
        headers: {
          Accept: 'application/json'
        }
      });

      if (!res.ok) {
        log('Fetch runs thất bại, status =', res.status);
        return;
      }

      const data = await res.json();
      if (!data || !Array.isArray(data.items)) {
        log('Payload không hợp lệ (không có items[])', data);
        return;
      }

      const items = data.items;
      log('Nhận được', items.length, 'runs');

      const k = computeKpi(items);
      setText('#vsp-runs-kpi-total', String(k.totalRuns));
      setText('#vsp-runs-kpi-critical-high', String(k.runsWithCriticalHigh));
      setText('#vsp-runs-kpi-avg-findings', String(k.avgFindings));

      renderRunsTable(items);
      ensureExportToolbar();
    } catch (err) {
      console.error(LOG_PREFIX, 'Lỗi loadRunsHistory:', err);
    }
  }

  function init() {
    if (window.__VSP_RUNS_TAB_HISTORY_EXPORT_INITED__) {
      return;
    }
    window.__VSP_RUNS_TAB_HISTORY_EXPORT_INITED__ = true;

    log('initialized (history + export V2)');
    loadRunsHistory();
    ensureExportToolbar();
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    setTimeout(init, 0);
  }

  window.vspReloadRuns = loadRunsHistory;

})();

})();
/* ==== END: static/js/vsp_runs_tab_v1.js ==== */

/* ==== BEGIN: static/js/vsp_runs_trigger_scan_mount_hook_v1.js ==== */
(function(){
'use strict';
(function(){

  // VSP_ROUTE_GUARD_RUNS_ONLY_V1
  function __vsp_is_runs_only_v1(){
    try {
      const h = (location.hash||"").toLowerCase();
      return h.startsWith("#runs") || h.includes("#runs/");
    } catch(_) { return false; }
  }
  if(!__vsp_is_runs_only_v1()){
    try{ console.info("[VSP_ROUTE_GUARD_RUNS_ONLY_V1] skip", "vsp_runs_trigger_scan_mount_hook_v1.js", "hash=", location.hash); }catch(_){}
    return;
  }
/*VSP_DISABLE_LEGACY_RUNSCAN_V1*/return;})();
(function(){/*VSP_DISABLE_DUP_SCAN_V1*/return;})();
(function(){
  if (window.__VSP_RUNSCAN_MOUNT_HOOK_V1__) return;
  window.__VSP_RUNSCAN_MOUNT_HOOK_V1__ = true;

  function log(){ try{ console.log.apply(console, arguments); }catch(e){} }

  function tryMount(){
    if (typeof window.VSP_RUNSCAN_MOUNT === "function") {
      var ok = false;
      try { ok = window.VSP_RUNSCAN_MOUNT(); } catch(e){ log("[RUNSCAN_HOOK] mount error", e); }
      if (ok) log("[RUNSCAN_HOOK] mounted (or already mounted)");
      return ok;
    }
    return false;
  }

  // 1) hash/router changes
  window.addEventListener("hashchange", function(){
    setTimeout(tryMount, 50);
    setTimeout(tryMount, 250);
    setTimeout(tryMount, 800);
  });

  // 2) click on Runs tab button
  document.addEventListener("click", function(ev){
    var btn = ev.target && ev.target.closest ? ev.target.closest(".vsp-tab-btn[data-tab='runs']") : null;
    if (!btn) return;
    setTimeout(tryMount, 10);
    setTimeout(tryMount, 200);
    setTimeout(tryMount, 800);
  }, true);

  // 3) fallback retries at startup
  var n=0, it=setInterval(function(){
    n++;
    if (tryMount()) { clearInterval(it); return; }
    if (n>120) clearInterval(it);
  }, 200);

  log("[RUNSCAN_HOOK] mount hook ready");
})();

})();
/* ==== END: static/js/vsp_runs_trigger_scan_mount_hook_v1.js ==== */

/* ==== BEGIN: static/js/vsp_runs_trigger_scan_ui_v1.js ==== */
(function(){
'use strict';
/* VSP Runs & Reports – Run Scan Now UI (v1)
 * POST /api/vsp/run
 * Poll /api/vsp/run_status/<req_id>
 */
(function () {

  // VSP_ROUTE_GUARD_RUNS_ONLY_V1
  function __vsp_is_runs_only_v1(){
    try {
      const h = (location.hash||"").toLowerCase();
      return h.startsWith("#runs") || h.includes("#runs/");
    } catch(_) { return false; }
  }
  if(!__vsp_is_runs_only_v1()){
    try{ console.info("[VSP_ROUTE_GUARD_RUNS_ONLY_V1] skip", "vsp_runs_trigger_scan_ui_v1.js", "hash=", location.hash); }catch(_){}
    return;
  }

  if (window.VSP_RUN_SCAN_UI_V1_LOADED) return;
  window.VSP_RUN_SCAN_UI_V1_LOADED = true;

  function el(tag, attrs, children) {
    var n = document.createElement(tag);
    attrs = attrs || {};
    Object.keys(attrs).forEach(function (k) {
      if (k === "class") n.className = attrs[k];
      else if (k === "html") n.innerHTML = attrs[k];
      else if (k === "text") n.textContent = attrs[k];
      else n.setAttribute(k, attrs[k]);
    });
    (children || []).forEach(function (c) {
      if (c == null) return;
      if (typeof c === "string") n.appendChild(document.createTextNode(c));
      else n.appendChild(c);
    });
    return n;
  }
  function qs(sel, root) { return (root || document).querySelector(sel); }

  function badge(status) {
    var map = {
      PENDING: "vsp-badge vsp-badge-warn",
      RUNNING: "vsp-badge vsp-badge-info",
      DONE: "vsp-badge vsp-badge-ok",
      FAILED: "vsp-badge vsp-badge-bad",
      UNKNOWN: "vsp-badge"
    };
    var cls = map[status] || "vsp-badge";
    return el("span", { class: cls, text: status || "UNKNOWN" });
  }

  async function postJson(url, data) {
    var r = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data)
    });
    var t = await r.text();
    var j;
    try { j = JSON.parse(t); } catch (e) { j = { ok: false, error: "Non-JSON response", raw: t }; }
    if (!r.ok) { j.ok = false; j.http_status = r.status; }
    return j;
  }
  async function getJson(url) {
    var r = await fetch(url, { method: "GET" });
    var t = await r.text();
    var j;
    try { j = JSON.parse(t); } catch (e) { j = { ok: false, error: "Non-JSON response", raw: t }; }
    if (!r.ok) { j.ok = false; j.http_status = r.status; }
    return j;
  }

  function installStylesOnce() {
    if (document.getElementById("vsp-runscan-ui-v1-style")) return;
    var css = `
      .vsp-runscan-wrap{margin:16px 0;padding:16px;border:1px solid rgba(255,255,255,.08);border-radius:14px;background:rgba(255,255,255,.03)}
      .vsp-runscan-head{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px}
      .vsp-runscan-title{font-weight:700;font-size:14px;letter-spacing:.3px}
      .vsp-runscan-sub{opacity:.72;font-size:12px;margin-top:4px}
      .vsp-runscan-grid{display:grid;grid-template-columns:repeat(12,1fr);gap:10px}
      .vsp-field{grid-column:span 4;display:flex;flex-direction:column;gap:6px}
      .vsp-field label{font-size:12px;opacity:.8}
      .vsp-field input,.vsp-field select{padding:10px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.25);color:inherit;outline:none}
      .vsp-field input:focus,.vsp-field select:focus{border-color:rgba(99,102,241,.55)}
      .vsp-field.wide{grid-column:span 8}
      .vsp-runscan-actions{grid-column:span 12;display:flex;gap:10px;align-items:center;margin-top:6px}
      .vsp-btn{padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.10);background:rgba(99,102,241,.18);color:inherit;cursor:pointer;font-weight:650}
      .vsp-btn:hover{background:rgba(99,102,241,.28)}
      .vsp-btn.secondary{background:rgba(255,255,255,.06)}
      .vsp-btn.secondary:hover{background:rgba(255,255,255,.10)}
      .vsp-btn:disabled{opacity:.5;cursor:not-allowed}
      .vsp-hline{height:1px;background:rgba(255,255,255,.08);margin:14px 0}
      .vsp-kv{display:grid;grid-template-columns:140px 1fr;gap:6px 12px;font-size:12px}
      .vsp-kv .k{opacity:.72}
      .vsp-box{padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,.08);background:rgba(0,0,0,.18)}
      .vsp-badge{padding:4px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.12);font-size:11px;opacity:.95}
      .vsp-badge-ok{background:rgba(16,185,129,.15);border-color:rgba(16,185,129,.35)}
      .vsp-badge-bad{background:rgba(239,68,68,.15);border-color:rgba(239,68,68,.35)}
      .vsp-badge-info{background:rgba(59,130,246,.15);border-color:rgba(59,130,246,.35)}
      .vsp-badge-warn{background:rgba(245,158,11,.15);border-color:rgba(245,158,11,.35)}
      .vsp-mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
      .vsp-log{white-space:pre-wrap;font-size:11px;line-height:1.45;max-height:220px;overflow:auto}
      @media (max-width: 1100px){ .vsp-field{grid-column:span 6} .vsp-field.wide{grid-column:span 12} }
    `;
    var st = document.createElement("style");
    st.id = "vsp-runscan-ui-v1-style";
    st.textContent = css;
    document.head.appendChild(st);
  }

  function findRunsPane() {
    return (
      document.getElementById("vsp-tab-runs") ||
      document.querySelector("[data-tab='runs']") ||
      document.querySelector("#tab-runs") ||
      null
    );
  }

  function ensureMountPoint(runsPane) {
    var mp = qs("#vsp-runscan-ui-v1", runsPane);
    if (mp) return mp;
    mp = el("div", { id: "vsp-runscan-ui-v1" });
    runsPane.insertBefore(mp, runsPane.firstChild);
    return mp;
  }

  async function pollStatus(reqId, ui) {
    ui.status.innerHTML = "";
    ui.status.appendChild(badge("RUNNING"));
    ui.reqId.textContent = reqId;

    var stopped = false;
    ui.stopBtn.disabled = false;
    ui.stopBtn.onclick = function () {
      stopped = true;
      ui.status.innerHTML = "";
      ui.status.appendChild(badge("UNKNOWN"));
      ui.note.textContent = "Polling stopped (manual).";
      ui.stopBtn.disabled = true;
    };

    async function tick() {
      if (stopped) return;
      var j = await getJson("/api/vsp/run_status/" + encodeURIComponent(reqId));
      if (!j || !j.ok) {
        ui.note.textContent = "Status API error: " + (j && (j.error || j.raw || j.http_status) || "unknown");
        setTimeout(tick, 3000);
        return;
      }

      ui.status.innerHTML = "";
      ui.status.appendChild(badge(j.status));

      ui.ciRunId.textContent = j.ci_run_id || "-";
      ui.gate.textContent = j.gate || "-";
      ui.finalRc.textContent = j.final || "-";
      ui.log.textContent = (j.tail || []).join("\n");

      if (j.flag && typeof j.flag.has_findings !== "undefined") ui.hasFindings.textContent = String(j.flag.has_findings);
      else ui.hasFindings.textContent = "-";

      if (j.status === "DONE" || j.status === "FAILED") {
        ui.note.textContent = "Run finished.";
        ui.stopBtn.disabled = true;
        return;
      }
      setTimeout(tick, 3000);
    }
    tick();
  }

  async function onRunClick(ui) {
    ui.note.textContent = "";
    ui.err.textContent = "";
    ui.runBtn.disabled = true;

    var payload = {
      mode: ui.mode.value,
      profile: ui.profile.value,
      target_type: "path",
      target: ui.target.value
    };

    ui.payload.textContent = JSON.stringify(payload, null, 2);

    try {
      var j = await postJson("/api/vsp/run", payload);
      if (!j || !j.ok) {
        ui.err.textContent = "Run API failed: " + JSON.stringify(j, null, 2);
        ui.runBtn.disabled = false;
        return;
      }
      var reqId = j.request_id || "";
      if (!reqId) {
        ui.err.textContent = "No request_id returned: " + JSON.stringify(j, null, 2);
        ui.runBtn.disabled = false;
        return;
      }
      ui.note.textContent = j.message || "Scan accepted.";
      await pollStatus(reqId, ui);
    } catch (e) {
      ui.err.textContent = "Exception: " + (e && e.message ? e.message : String(e));
    } finally {
      ui.runBtn.disabled = false;
    }
  }

  function render(runsPane) {
    installStylesOnce();
    var mount = ensureMountPoint(runsPane);

    var ui = {};

    var head = el("div", { class: "vsp-runscan-head" }, [
      el("div", {}, [
        el("div", { class: "vsp-runscan-title", text: "RUN SCAN NOW" }),
        el("div", { class: "vsp-runscan-sub", text: "Trigger FULL_EXT pipeline and track status (UIREQ → VSP_CI_*)." })
      ]),
      el("div", { class: "vsp-runscan-actions" }, [])
    ]);

    var grid = el("div", { class: "vsp-runscan-grid" });

    ui.mode = el("select", {}, [
      el("option", { value: "local", text: "local (LOCAL_UI)" }),
      el("option", { value: "github_ci", text: "github_ci (GITHUB_CI/UI)" }),
      el("option", { value: "jenkins_ci", text: "jenkins_ci (JENKINS_CI/UI)" })
    ]);
    ui.profile = el("select", {}, [
      el("option", { value: "FULL_EXT", text: "FULL_EXT" }),
      el("option", { value: "EXT", text: "EXT" })
    ]);
    ui.target = el("input", { value: "/home/test/Data/SECURITY-10-10-v4", spellcheck: "false" });

    grid.appendChild(el("div", { class: "vsp-field" }, [el("label", { text: "Mode" }), ui.mode]));
    grid.appendChild(el("div", { class: "vsp-field" }, [el("label", { text: "Profile" }), ui.profile]));
    grid.appendChild(el("div", { class: "vsp-field wide" }, [el("label", { text: "Target path" }), ui.target]));

    ui.runBtn = el("button", { class: "vsp-btn", text: "Run Scan Now" });
    ui.stopBtn = el("button", { class: "vsp-btn secondary", text: "Stop Poll" });
    ui.stopBtn.disabled = true;
    ui.runBtn.onclick = function () { onRunClick(ui); };

    var actions = el("div", { class: "vsp-runscan-actions" }, [
      ui.runBtn, ui.stopBtn,
      el("div", { style: "margin-left:auto; display:flex; gap:10px; align-items:center;" }, [
        el("div", { class: "vsp-mono", text: "Status:" }),
        (ui.status = el("div", {}, [badge("UNKNOWN")]))
      ])
    ]);
    grid.appendChild(actions);

    ui.reqId = el("span", { class: "vsp-mono", text: "-" });
    ui.ciRunId = el("span", { class: "vsp-mono", text: "-" });
    ui.hasFindings = el("span", { class: "vsp-mono", text: "-" });
    ui.gate = el("span", { class: "vsp-mono", text: "-" });
    ui.finalRc = el("span", { class: "vsp-mono", text: "-" });

    var kv = el("div", { class: "vsp-kv vsp-box" }, [
      el("div", { class: "k", text: "request_id" }), ui.reqId,
      el("div", { class: "k", text: "ci_run_id" }), ui.ciRunId,
      el("div", { class: "k", text: "has_findings" }), ui.hasFindings,
      el("div", { class: "k", text: "gate" }), ui.gate,
      el("div", { class: "k", text: "final_rc" }), ui.finalRc
    ]);

    ui.note = el("div", { style: "margin-top:10px; font-size:12px; opacity:.8" });
    ui.err = el("div", { style: "margin-top:8px; font-size:12px; color: rgba(239,68,68,.95)" });

    ui.payload = el("div", { class: "vsp-box vsp-mono vsp-log", text: "" });
    ui.log = el("div", { class: "vsp-box vsp-mono vsp-log", text: "" });

    mount.innerHTML = "";
    mount.appendChild(el("div", { class: "vsp-runscan-wrap" }, [
      head,
      grid,
      el("div", { class: "vsp-hline" }),
      kv,
      ui.note,
      ui.err,
      el("div", { class: "vsp-hline" }),
      el("div", { class: "vsp-runscan-sub", text: "Request payload" }),
      ui.payload,
      el("div", { style: "height:10px" }),
      el("div", { class: "vsp-runscan-sub", text: "Status log tail (from /api/vsp/run_status/<req_id>)" }),
      ui.log
    ]));
  }

  function boot() {
    var pane = findRunsPane();
    if (!pane) return;
    render(pane);
    console.log("[VSP_RUNSCAN_UI_V1] mounted");
  }

  var tries = 0;
  var iv = setInterval(function () {
    tries++;
    boot();
    if (qs("#vsp-runscan-ui-v1")) clearInterval(iv);
    if (tries > 60) clearInterval(iv);
  }, 300);
})();

})();
/* ==== END: static/js/vsp_runs_trigger_scan_ui_v1.js ==== */

/* ==== BEGIN: static/js/vsp_runs_trigger_scan_ui_v2.js ==== */
(function(){
'use strict';
(function () {

  // VSP_ROUTE_GUARD_RUNS_ONLY_V1
  function __vsp_is_runs_only_v1(){
    try {
      const h = (location.hash||"").toLowerCase();
      return h.startsWith("#runs") || h.includes("#runs/");
    } catch(_) { return false; }
  }
  if(!__vsp_is_runs_only_v1()){
    try{ console.info("[VSP_ROUTE_GUARD_RUNS_ONLY_V1] skip", "vsp_runs_trigger_scan_ui_v2.js", "hash=", location.hash); }catch(_){}
    return;
  }

  if (window.VSP_RUN_SCAN_UI_V2_LOADED) return;
  window.VSP_RUN_SCAN_UI_V2_LOADED = true;

  function el(tag, attrs, children) {
    var n = document.createElement(tag);
    attrs = attrs || {};
    Object.keys(attrs).forEach(function (k) {
      if (k === "class") n.className = attrs[k];
      else if (k === "html") n.innerHTML = attrs[k];
      else if (k === "text") n.textContent = attrs[k];
      else n.setAttribute(k, attrs[k]);
    });
    (children || []).forEach(function (c) {
      if (c == null) return;
      if (typeof c === "string") n.appendChild(document.createTextNode(c));
      else n.appendChild(c);
    });
    return n;
  }
  function qs(sel, root) { return (root || document).querySelector(sel); }
  function qsa(sel, root) { return Array.prototype.slice.call((root || document).querySelectorAll(sel)); }

  function installStylesOnce() {
    if (document.getElementById("vsp-runscan-ui-style-v2")) return;
    var css = `
      .vsp-runscan-wrap{margin:16px 0;padding:16px;border:1px solid rgba(255,255,255,.08);border-radius:14px;background:rgba(255,255,255,.03)}
      .vsp-runscan-head{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px}
      .vsp-runscan-title{font-weight:700;font-size:14px;letter-spacing:.3px}
      .vsp-runscan-sub{opacity:.72;font-size:12px;margin-top:4px}
      .vsp-runscan-grid{display:grid;grid-template-columns:repeat(12,1fr);gap:10px}
      .vsp-field{grid-column:span 4;display:flex;flex-direction:column;gap:6px}
      .vsp-field label{font-size:12px;opacity:.8}
      .vsp-field input,.vsp-field select{padding:10px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.25);color:inherit;outline:none}
      .vsp-field input:focus,.vsp-field select:focus{border-color:rgba(99,102,241,.55)}
      .vsp-field.wide{grid-column:span 8}
      .vsp-runscan-actions{grid-column:span 12;display:flex;gap:10px;align-items:center;margin-top:6px}
      .vsp-btn{padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.10);background:rgba(99,102,241,.18);color:inherit;cursor:pointer;font-weight:650}
      .vsp-btn:hover{background:rgba(99,102,241,.28)}
      .vsp-btn.secondary{background:rgba(255,255,255,.06)}
      .vsp-btn.secondary:hover{background:rgba(255,255,255,.10)}
      .vsp-btn:disabled{opacity:.5;cursor:not-allowed}
      .vsp-hline{height:1px;background:rgba(255,255,255,.08);margin:14px 0}
      .vsp-kv{display:grid;grid-template-columns:140px 1fr;gap:6px 12px;font-size:12px}
      .vsp-kv .k{opacity:.72}
      .vsp-box{padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,.08);background:rgba(0,0,0,.18)}
      .vsp-badge{padding:4px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.12);font-size:11px;opacity:.95}
      .vsp-badge-ok{background:rgba(16,185,129,.15);border-color:rgba(16,185,129,.35)}
      .vsp-badge-bad{background:rgba(239,68,68,.15);border-color:rgba(239,68,68,.35)}
      .vsp-badge-info{background:rgba(59,130,246,.15);border-color:rgba(59,130,246,.35)}
      .vsp-badge-warn{background:rgba(245,158,11,.15);border-color:rgba(245,158,11,.35)}
      .vsp-mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
      .vsp-log{white-space:pre-wrap;font-size:11px;line-height:1.45;max-height:220px;overflow:auto}
      @media (max-width: 1100px){ .vsp-field{grid-column:span 6} .vsp-field.wide{grid-column:span 12} }
    `;
    var st = document.createElement("style");
    st.id = "vsp-runscan-ui-style-v2";
    st.textContent = css;
    document.head.appendChild(st);
  }

  function badge(status) {
    var map = {PENDING:"vsp-badge vsp-badge-warn",RUNNING:"vsp-badge vsp-badge-info",DONE:"vsp-badge vsp-badge-ok",FAILED:"vsp-badge vsp-badge-bad",UNKNOWN:"vsp-badge"};
    return el("span", { class: map[status] || "vsp-badge", text: status || "UNKNOWN" });
  }

  async function postJson(url, data) {
    var r = await fetch(url, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(data) });
    var t = await r.text();
    var j; try { j = JSON.parse(t); } catch(e) { j = { ok:false, error:"Non-JSON response", raw:t }; }
    if (!r.ok) { j.ok=false; j.http_status=r.status; }
    return j;
  }
  async function getJson(url) {
    var r = await fetch(url);
    var t = await r.text();
    var j; try { j = JSON.parse(t); } catch(e) { j = { ok:false, error:"Non-JSON response", raw:t }; }
    if (!r.ok) { j.ok=false; j.http_status=r.status; }
    return j;
  }

  function isVisible(node) {
    if (!node) return false;
    var s = window.getComputedStyle(node);
    if (s.display === "none" || s.visibility === "hidden" || Number(s.opacity) === 0) return false;
    if (node.offsetParent === null && s.position !== "fixed") return false;
    return true;
  }

  function findRunsPaneSmart() {
    // 1) direct known ids
    var direct = document.getElementById("vsp-tab-runs") || document.querySelector("[data-tab='runs']") || document.querySelector("#tab-runs");
    if (direct) return direct;

    // 2) look for active pane by hash/router (common patterns)
    var hash = (location.hash || "").toLowerCase();
    var candidates = qsa("[id*='run'], [class*='run'], [data-tab], section, main, div");
    // Prefer visible nodes whose text hints "Runs" or contains a Runs table header
    var best = null, bestScore = -1;
    for (var i=0;i<candidates.length;i++){
      var n = candidates[i];
      if (!isVisible(n)) continue;
      var id = (n.id || "").toLowerCase();
      var cls = (n.className || "").toLowerCase();
      var txt = (n.textContent || "").toLowerCase();

      var score = 0;
      if (hash.includes("run") || hash.includes("report")) score += 1;
      if (id.includes("run")) score += 3;
      if (cls.includes("run")) score += 2;
      if (txt.includes("runs") || txt.includes("reports")) score += 2;
      if (txt.includes("run id") || txt.includes("export") || txt.includes("report")) score += 1;
      // penalize huge containers (avoid mounting into whole page)
      if (txt.length > 20000) score -= 2;

      if (score > bestScore) { bestScore = score; best = n; }
    }
    return best;
  }

  function ensureMount(pane) {
    var mp = qs("#vsp-runscan-ui-v2", pane);
    if (mp) return mp;
    mp = el("div", { id: "vsp-runscan-ui-v2" });
    pane.insertBefore(mp, pane.firstChild);
    return mp;
  }

  async function poll(reqId, ui) {
    ui.reqId.textContent = reqId;
    ui.status.innerHTML = ""; ui.status.appendChild(badge("RUNNING"));
    var stopped = false;
    ui.stopBtn.disabled = false;
    ui.stopBtn.onclick = function(){ stopped=true; ui.status.innerHTML=""; ui.status.appendChild(badge("UNKNOWN")); ui.note.textContent="Polling stopped."; ui.stopBtn.disabled=true; };

    async function tick(){
      if (stopped) return;
      var j = await getJson("/api/vsp/run_status/" + encodeURIComponent(reqId));
      if (!j || !j.ok){
        ui.note.textContent = "Status API error: " + (j && (j.error || j.raw || j.http_status) || "unknown");
        return setTimeout(tick, 3000);
      }
      ui.status.innerHTML = ""; ui.status.appendChild(badge(j.status));
      ui.ciRunId.textContent = j.ci_run_id || "-";
      ui.hasFindings.textContent = (j.flag && typeof j.flag.has_findings !== "undefined") ? String(j.flag.has_findings) : "-";
      ui.gate.textContent = j.gate || "-";
      ui.finalRc.textContent = (typeof j.final !== "undefined") ? String(j.final) : "-";
      ui.log.textContent = (j.tail || []).join("\n");
      if (j.status === "DONE" || j.status === "FAILED") { ui.note.textContent = "Run finished."; ui.stopBtn.disabled=true; return; }
      setTimeout(tick, 3000);
    }
    tick();
  }

  async function onRun(ui) {
    ui.err.textContent = "";
    ui.note.textContent = "";
    ui.runBtn.disabled = true;

    var payload = { mode: ui.mode.value, profile: ui.profile.value, target_type: "path", target: ui.target.value };
    ui.payload.textContent = JSON.stringify(payload, null, 2);

    try{
      var j = await postJson("/api/vsp/run", payload);
      if (!j || !j.ok) { ui.err.textContent = "Run API failed: " + JSON.stringify(j, null, 2); return; }
      if (!j.request_id) { ui.err.textContent = "No request_id returned: " + JSON.stringify(j, null, 2); return; }
      ui.note.textContent = j.message || "Scan accepted.";
      await poll(j.request_id, ui);
    } finally {
      ui.runBtn.disabled = false;
    }
  }

  function render(pane) {
    installStylesOnce();
    var mount = ensureMount(pane);
    if (mount.dataset.mounted === "1") return;
    mount.dataset.mounted = "1";

    var ui = {};
    ui.mode = el("select", {}, [
      el("option", { value: "local", text: "local (LOCAL_UI)" }),
      el("option", { value: "github_ci", text: "github_ci" }),
      el("option", { value: "jenkins_ci", text: "jenkins_ci" })
    ]);
    ui.profile = el("select", {}, [
      el("option", { value: "FULL_EXT", text: "FULL_EXT" }),
      el("option", { value: "EXT", text: "EXT" })
    ]);
    ui.target = el("input", { value: "/home/test/Data/SECURITY-10-10-v4", spellcheck:"false" });

    ui.runBtn = el("button", { class:"vsp-btn", text:"Run Scan Now" });
    ui.stopBtn = el("button", { class:"vsp-btn secondary", text:"Stop Poll" }); ui.stopBtn.disabled = true;
    ui.status = el("div", {}, [badge("UNKNOWN")]);

    ui.reqId = el("span", { class:"vsp-mono", text:"-" });
    ui.ciRunId = el("span", { class:"vsp-mono", text:"-" });
    ui.hasFindings = el("span", { class:"vsp-mono", text:"-" });
    ui.gate = el("span", { class:"vsp-mono", text:"-" });
    ui.finalRc = el("span", { class:"vsp-mono", text:"-" });

    ui.note = el("div", { style:"margin-top:10px;font-size:12px;opacity:.8" });
    ui.err  = el("div", { style:"margin-top:8px;font-size:12px;color:rgba(239,68,68,.95)" });

    ui.payload = el("div", { class:"vsp-box vsp-mono vsp-log", text:"" });
    ui.log     = el("div", { class:"vsp-box vsp-mono vsp-log", text:"" });

    ui.runBtn.onclick = function(){ onRun(ui); };

    mount.innerHTML = "";
    mount.appendChild(el("div", { class:"vsp-runscan-wrap" }, [
      el("div", { class:"vsp-runscan-head" }, [
        el("div", {}, [
          el("div", { class:"vsp-runscan-title", text:"RUN SCAN NOW" }),
          el("div", { class:"vsp-runscan-sub", text:"Trigger FULL_EXT pipeline and track status (UIREQ → VSP_CI_*)." })
        ]),
        el("div", { style:"display:flex;gap:10px;align-items:center" }, [
          el("div", { class:"vsp-mono", text:"Status:" }),
          ui.status
        ])
      ]),
      el("div", { class:"vsp-runscan-grid" }, [
        el("div", { class:"vsp-field" }, [ el("label",{text:"Mode"}), ui.mode ]),
        el("div", { class:"vsp-field" }, [ el("label",{text:"Profile"}), ui.profile ]),
        el("div", { class:"vsp-field wide" }, [ el("label",{text:"Target path"}), ui.target ]),
        el("div", { class:"vsp-runscan-actions" }, [ ui.runBtn, ui.stopBtn ])
      ]),
      el("div", { class:"vsp-hline" }),
      el("div", { class:"vsp-kv vsp-box" }, [
        el("div",{class:"k",text:"request_id"}), ui.reqId,
        el("div",{class:"k",text:"ci_run_id"}), ui.ciRunId,
        el("div",{class:"k",text:"has_findings"}), ui.hasFindings,
        el("div",{class:"k",text:"gate"}), ui.gate,
        el("div",{class:"k",text:"final_rc"}), ui.finalRc
      ]),
      ui.note, ui.err,
      el("div", { class:"vsp-hline" }),
      el("div", { class:"vsp-runscan-sub", text:"Request payload" }),
      ui.payload,
      el("div", { style:"height:10px" }),
      el("div", { class:"vsp-runscan-sub", text:"Status log tail (from /api/vsp/run_status/<req_id>)" }),
      ui.log
    ]));

    console.log("[VSP_RUNSCAN_UI_V2] mounted into:", pane);
  }

  function bootOnce() {
    var pane = findRunsPaneSmart();
    if (!pane) {
      console.warn("[VSP_RUNSCAN_UI_V2] runs pane not found yet");
      return false;
    }
    render(pane);
    return true;
  }

  // retry + also on hashchange (tab router)
  var tries = 0;
  var iv = setInterval(function(){
    tries++;
    if (bootOnce()) clearInterval(iv);
    if (tries > 80) clearInterval(iv);
  }, 250);

  window.addEventListener("hashchange", function(){ setTimeout(bootOnce, 200); });
})();

})();
/* ==== END: static/js/vsp_runs_trigger_scan_ui_v2.js ==== */

/* ==== BEGIN: static/js/vsp_runs_trigger_scan_ui_v3.js ==== */
(function(){
'use strict';
(function(){

  // VSP_ROUTE_GUARD_RUNS_ONLY_V1
  function __vsp_is_runs_only_v1(){
    try {
      const h = (location.hash||"").toLowerCase();
      return h.startsWith("#runs") || h.includes("#runs/");
    } catch(_) { return false; }
  }
  if(!__vsp_is_runs_only_v1()){
    try{ console.info("[VSP_ROUTE_GUARD_RUNS_ONLY_V1] skip", "vsp_runs_trigger_scan_ui_v3.js", "hash=", location.hash); }catch(_){}
    return;
  }
/*VSP_DISABLE_LEGACY_RUNSCAN_V1*/return;})();
(function(){/*VSP_DISABLE_DUP_SCAN_V1*/return;})();
(function(){
  if (window.__VSP_RUNSCAN_UI_V3__) return;
  window.__VSP_RUNSCAN_UI_V3__ = true;

  function $(sel, root){ return (root||document).querySelector(sel); }
  function el(tag, attrs, children){
    var n = document.createElement(tag);
    attrs = attrs || {};
    Object.keys(attrs).forEach(function(k){
      if (k === "class") n.className = attrs[k];
      else if (k === "html") n.innerHTML = attrs[k];
      else n.setAttribute(k, attrs[k]);
    });
    (children||[]).forEach(function(c){
      if (c == null) return;
      if (typeof c === "string") n.appendChild(document.createTextNode(c));
      else n.appendChild(c);
    });
    return n;
  }

  function fmtJson(o){
    try { return JSON.stringify(o, null, 2); } catch(e){ return String(o); }
  }

  function mount(){
    var runsPane = document.getElementById("vsp-runs-main");
    if (!runsPane) return false;

    // tránh mount trùng
    if (document.getElementById("vsp-runscan-panel-v3")) return true;

    // panel container
    var panel = el("div", { id: "vsp-runscan-panel-v3", class: "vsp-card", style:
      "margin:12px 0; padding:14px; border:1px solid rgba(255,255,255,.08); background:rgba(255,255,255,.03); border-radius:14px;"
    });

    var titleRow = el("div", {style:"display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;"}, [
      el("div", {style:"font-weight:700; letter-spacing:.2px;"}, ["Run Scan Now (LOCAL/CI)"]),
      el("div", {style:"opacity:.75; font-size:12px;"}, ["POST /api/vsp/run  →  poll /api/vsp/run_status/<REQ_ID>"])
    ]);

    var row = el("div", {style:"display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; align-items:flex-end;"});

    var modeSel = el("select", {class:"vsp-select", id:"vsp-runscan-mode", style:"min-width:160px;"}, [
      el("option", {value:"local"}, ["local (UI)"]),
      el("option", {value:"ci"}, ["ci (future)"])
    ]);

    var profileSel = el("select", {class:"vsp-select", id:"vsp-runscan-profile", style:"min-width:170px;"}, [
      el("option", {value:"FULL_EXT"}, ["FULL_EXT"]),
      el("option", {value:"FULL"}, ["FULL"]),
      el("option", {value:"EXT"}, ["EXT"])
    ]);

    var targetTypeSel = el("select", {class:"vsp-select", id:"vsp-runscan-target-type", style:"min-width:160px;"}, [
      el("option", {value:"path"}, ["path"])
    ]);

    var targetInput = el("input", {
      class:"vsp-input",
      id:"vsp-runscan-target",
      placeholder:"/home/test/Data/SECURITY-10-10-v4",
      value:"/home/test/Data/SECURITY-10-10-v4",
      style:"min-width:420px;"
    });

    var btn = el("button", {class:"vsp-btn vsp-btn-primary", id:"vsp-runscan-btn", style:"min-width:160px;"}, ["Run Scan Now"]);
    var btn2 = el("button", {class:"vsp-btn", id:"vsp-runscan-refresh", style:"min-width:160px;"}, ["Refresh Status"]);

    row.appendChild(el("div", {}, [el("div",{style:"font-size:12px;opacity:.7;margin-bottom:4px;"} ,["Mode"]), modeSel]));
    row.appendChild(el("div", {}, [el("div",{style:"font-size:12px;opacity:.7;margin-bottom:4px;"} ,["Profile"]), profileSel]));
    row.appendChild(el("div", {}, [el("div",{style:"font-size:12px;opacity:.7;margin-bottom:4px;"} ,["Target type"]), targetTypeSel]));
    row.appendChild(el("div", {style:"flex:1; min-width:320px;"}, [el("div",{style:"font-size:12px;opacity:.7;margin-bottom:4px;"} ,["Target"]), targetInput]));
    row.appendChild(btn);
    row.appendChild(btn2);

    var statusBox = el("pre", {
      id:"vsp-runscan-status",
      style:"margin-top:10px; padding:10px; border-radius:12px; border:1px solid rgba(255,255,255,.08); background:rgba(0,0,0,.25); max-height:240px; overflow:auto; font-size:12px;"
    }, ["(idle)"]);

    var hint = el("div",{style:"margin-top:8px; font-size:12px; opacity:.75;"}, [
      "Tip: Bạn có thể copy REQ_ID từ log UI triggers và gọi: /api/vsp/run_status/<REQ_ID>."
    ]);

    panel.appendChild(titleRow);
    panel.appendChild(row);
    panel.appendChild(statusBox);
    panel.appendChild(hint);

    // chèn panel lên đầu Runs pane (trước KPI cards)
    runsPane.insertBefore(panel, runsPane.firstChild);

    // state
    var currentReq = null;
    var pollTimer = null;

    function setStatus(objOrText){
      if (typeof objOrText === "string") statusBox.textContent = objOrText;
      else statusBox.textContent = fmtJson(objOrText);
    }

    async function apiRun(){
      btn.disabled = true;
      try{
        setStatus("Submitting /api/vsp/run ...");
        var payload = {
          mode: modeSel.value,
          profile: profileSel.value,
          target_type: targetTypeSel.value,
          target: targetInput.value || "/home/test/Data/SECURITY-10-10-v4"
        };

        var r = await fetch("/api/vsp/run", {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify(payload)
        });

        var txt = await r.text();
        var data;
        try { data = JSON.parse(txt); } catch(e){ data = {raw: txt}; }

        if (!r.ok) {
          setStatus({ok:false, http:r.status, response:data});
          return;
        }

        currentReq = data.request_id || null;
        setStatus(data);

        if (currentReq) startPoll(currentReq);
      } catch(e){
        setStatus({ok:false, error:String(e)});
      } finally{
        btn.disabled = false;
      }
    }

    async function apiStatus(req){
      try{
        var r = await fetch("/api/vsp/run_status/" + encodeURIComponent(req));
        var txt = await r.text();
        var data;
        try { data = JSON.parse(txt); } catch(e){ data = {raw: txt}; }

        if (!r.ok){
          setStatus({ok:false, http:r.status, response:data});
          return null;
        }
        setStatus(data);
        return data;
      } catch(e){
        setStatus({ok:false, error:String(e)});
        return null;
      }
    }

    function startPoll(req){
      if (pollTimer) clearInterval(pollTimer);
      pollTimer = setInterval(async function(){
        var data = await apiStatus(req);
        if (!data) return;

        // dừng poll khi xong
        var st = (data.status || "").toUpperCase();
        if (st === "DONE" || st === "FAILED" || st === "PASS" || st === "FAIL") {
          clearInterval(pollTimer);
          pollTimer = null;
        }
      }, 1500);
    }

    btn.addEventListener("click", apiRun);
    btn2.addEventListener("click", function(){
      if (currentReq) apiStatus(currentReq);
      else setStatus("No REQ_ID yet. Click Run Scan Now first.");
    });

    // auto mount: nếu hash đang ở runs thì ok; còn không thì vẫn mount trong DOM runs pane
    console.log("[VSP_RUNSCAN_UI_V3] mounted into #vsp-runs-main");
    return true;
  }

  // retry mount vài lần vì router load pane chậm

  // Expose mount for hook re-mounting
  window.VSP_RUNSCAN_MOUNT = mount;

  var n=0, it=setInterval(function(){
    n++;
    if (mount()) { clearInterval(it); return; }
    if (n>80) clearInterval(it);
  }, 200);

})();

})();
/* ==== END: static/js/vsp_runs_trigger_scan_ui_v3.js ==== */

/* ==== BEGIN: static/js/vsp_runs_trigger_scan_v1.js ==== */
(function(){
'use strict';
// === VSP 2025 – RUN SCAN NOW Button ===
// Gắn nút vào tab Runs & Reports

document.addEventListener("DOMContentLoaded", function () {
  try {
    const runsHeader = document.querySelector("#vsp-runs-main .vsp-card-header");
    if (!runsHeader) {
      console.warn("[VSP_RUN_BTN] Không tìm thấy header của tab Runs.");
      return;
    }

    // Tránh gắn trùng nút nếu script load lại
    if (runsHeader.querySelector("[data-vsp-run-btn]")) {
      console.log("[VSP_RUN_BTN] Button đã tồn tại, bỏ qua.");
      return;
    }

    // Tạo nút Run Scan Now
    const btn = document.createElement("button");
    btn.textContent = "Run Scan Now";
    btn.className = "vsp-btn";
    btn.dataset.vspRunBtn = "1";
    btn.style.marginLeft = "10px";

    btn.addEventListener("click", function () {
      openRunScanModal();
    });

    runsHeader.appendChild(btn);
    console.log("[VSP_RUN_BTN] Đã gắn nút Run Scan Now vào tab Runs.");
  } catch (e) {
    console.error("[VSP_RUN_BTN] Lỗi khi khởi tạo nút:", e);
  }
});


// === Modal tạo request scan ===
function openRunScanModal() {
  // Nếu đã có modal thì không tạo thêm
  if (document.getElementById("vsp-run-modal")) return;

  const html = `
    <div id="vsp-run-modal" style="
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.6);
      display:flex; align-items:center; justify-content:center;
      z-index: 9999;
    ">
      <div style="
        background:#0b1020; padding:20px; border-radius:12px;
        width:360px; box-shadow:0 0 30px rgba(0,0,0,0.4);
        color:#E5E7EB; font-family:Inter, system-ui, sans-serif;
      ">
        <h3 style="margin:0 0 12px 0; font-size:16px;">Run Scan Now</h3>

        <label style="font-size:12px; color:#9CA3AF;">Profile</label>
        <select id="vsp-run-profile" style="
          width:100%; margin-bottom:12px; padding:6px 10px;
          border-radius:8px; background:#111827; color:white;
          border:1px solid #334155; font-size:12px;
        ">
          <option value="FULL_EXT">FULL_EXT</option>
          <option value="FAST">FAST</option>
        </select>

        <label style="font-size:12px; color:#9CA3AF;">Target Path</label>
        <input id="vsp-run-target" value="/home/test/Data/SECURITY-10-10-v4" style="
          width:100%; margin-bottom:16px; padding:6px 10px;
          border-radius:8px; background:#111827; color:white;
          border:1px solid #334155; font-size:12px;
        " />

        <div style="display:flex; justify-content:flex-end; gap:10px;">
          <button type="button" onclick="closeRunScanModal()" class="vsp-btn-secondary">
            Cancel
          </button>
          <button type="button" onclick="submitRunScan()" class="vsp-btn">
            Run
          </button>
        </div>
      </div>
    </div>
  `;
  document.body.insertAdjacentHTML("beforeend", html);
}

function closeRunScanModal() {
  const m = document.getElementById("vsp-run-modal");
  if (m) m.remove();
}


// === Gửi request scan ===
async function submitRunScan() {
  const profileEl = document.getElementById("vsp-run-profile");
  const targetEl  = document.getElementById("vsp-run-target");

  if (!profileEl || !targetEl) {
    alert("Form không hợp lệ, vui lòng reload trang.");
    return;
  }

  const profile = profileEl.value;
  const target  = targetEl.value.trim();

  if (!target) {
    alert("Vui lòng nhập Target Path.");
    return;
  }

  const payload = {
    mode: "local",
    profile: profile,
    target_type: "path",
    target: target
  };

  try {
    const resp = await fetch("/api/vsp/run", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify(payload)
    });

    const data = await resp.json();

    if (data && data.ok) {
      const reqId = data.request_id || "(no id)";
      alert("Scan started!\nRequest ID: " + reqId);
      console.log("[VSP_RUN_BTN] Scan accepted:", data);
      closeRunScanModal();

      // Refresh bảng runs nếu hàm loader tồn tại
      if (window.VSP_RUNS_LOAD_TABLE) {
        setTimeout(() => {
          try {
            window.VSP_RUNS_LOAD_TABLE();
          } catch (e) {
            console.error("[VSP_RUN_BTN] Lỗi khi reload bảng Runs:", e);
          }
        }, 1500);
      }
    } else {
      const msg = (data && (data.error || data.message)) || "unknown error";
      alert("Failed to trigger scan: " + msg);
      console.error("[VSP_RUN_BTN] API trả lỗi:", data);
    }

  } catch (err) {
    alert("Error calling API: " + err);
    console.error("[VSP_RUN_BTN] Exception khi gọi /api/vsp/run:", err);
  }
}

})();
/* ==== END: static/js/vsp_runs_trigger_scan_v1.js ==== */

/* ==== BEGIN: static/js/vsp_runs_v1.js ==== */
(function(){
'use strict';
/* VSP_GATE_RUNS_WRAPPER_V2_SAFE */
(function(){
  'use strict';
  function __vsp_is_runs(){
    try {
      const h = (location.hash || '').toLowerCase();
      return h.startsWith('#runs') || h.includes('#runs/');
    } catch(e) {
      return false;
    }
  }
  if(!__vsp_is_runs()){
    try{ console.info('[VSP_GATE_RUNS_WRAPPER_V2_SAFE] skip', 'vsp_runs_v1.js', 'hash=', location.hash); }catch(_e){}
    return;
  }

// VSP_RUNS_V1_REAL – dùng data thật từ /api/vsp/runs_index_v3
// API trả về ARRAY các run, không phải { runs: [...] } nữa.

(function () {
  const LOG = "[VSP_RUNS_TAB]";
  const RUNS_API = "/api/vsp/runs_index_v3";

  function fmtInt(x) {
    if (x === null || x === undefined) return "-";
    const n = Number(x);
    if (!Number.isFinite(n)) return "-";
    return n.toLocaleString("en-US");
  }

  function fmtDate(s) {
    if (!s) return "-";
    return s;
  }

  async function fetchRunsIndex() {
    console.log(LOG, "Fetch", RUNS_API);
    const res = await fetch(RUNS_API, { cache: "no-store" });
    if (!res.ok) {
      console.error(LOG, "HTTP error", res.status, res.statusText);
      return [];
    }
    const data = await res.json();

    if (Array.isArray(data)) {
      console.log(LOG, "Got array runs:", data.length);
      return data;
    }

    if (Array.isArray(data.runs)) {
      console.warn(LOG, "Got legacy object with .runs – dùng .runs", data.runs.length);
      return data.runs;
    }

    console.error(LOG, "Không nhận diện được format runs_index_v3:", data);
    return [];
  }

  function renderKpi(runs) {
    const totalRuns = runs.length;
    const totalFindings = runs.reduce((acc, r) => acc + (Number(r.total_findings) || 0), 0);
    const last10 = runs.slice(-10);
    const totalFindLast10 = last10.reduce((acc, r) => acc + (Number(r.total_findings) || 0), 0);
    const avgLast10 = last10.length ? Math.round(totalFindLast10 / last10.length) : 0;

    const elTotalRuns = document.querySelector("[data-vsp-runs-kpi='total-runs']");
    const elLast10Avg = document.querySelector("[data-vsp-runs-kpi='avg-last10']");
    const elLast10Count = document.querySelector("[data-vsp-runs-kpi='last10-count']");

    if (elTotalRuns) elTotalRuns.textContent = fmtInt(totalRuns);
    if (elLast10Avg) elLast10Avg.textContent = avgLast10 ? fmtInt(avgLast10) : "-";
    if (elLast10Count) elLast10Count.textContent = fmtInt(last10.length);

    console.log(LOG, "KPI updated. totalRuns =", totalRuns, "avgLast10 =", avgLast10);
  }

  function renderRunsTable(runs) {
    const tbody = document.getElementById("vsp-runs-tbody");
    if (!tbody) {
      console.warn(LOG, "Không tìm thấy #vsp-runs-tbody – bỏ qua render bảng.");
      return;
    }

    tbody.innerHTML = "";

    runs.forEach((run, idx) => {
      const tr = document.createElement("tr");

      const colIndex = document.createElement("td");
      colIndex.textContent = String(idx + 1);
      tr.appendChild(colIndex);

      const colRunId = document.createElement("td");
      colRunId.textContent = run.run_id || "-";
      tr.appendChild(colRunId);

      const colProfile = document.createElement("td");
      colProfile.textContent = run.profile || "UNKNOWN";
      tr.appendChild(colProfile);

      const colTotal = document.createElement("td");
      colTotal.textContent = fmtInt(run.total_findings);
      tr.appendChild(colTotal);

      const colCrit = document.createElement("td");
      colCrit.textContent = fmtInt(run.total_critical);
      tr.appendChild(colCrit);

      const colHigh = document.createElement("td");
      colHigh.textContent = fmtInt(run.total_high);
      tr.appendChild(colHigh);

      const colMedium = document.createElement("td");
      colMedium.textContent = fmtInt(run.total_medium);
      tr.appendChild(colMedium);

      const colLow = document.createElement("td");
      colLow.textContent = fmtInt(run.total_low);
      tr.appendChild(colLow);

      const colInfo = document.createElement("td");
      colInfo.textContent = fmtInt(run.total_info);
      tr.appendChild(colInfo);

      const colTrace = document.createElement("td");
      colTrace.textContent = fmtInt(run.total_trace);
      tr.appendChild(colTrace);

      const colStarted = document.createElement("td");
      colStarted.textContent = fmtDate(run.started_at);
      tr.appendChild(colStarted);

      const colFinished = document.createElement("td");
      colFinished.textContent = fmtDate(run.finished_at);
      tr.appendChild(colFinished);

      tbody.appendChild(tr);
    });

    console.log(LOG, "Rendered", runs.length, "runs vào #vsp-runs-tbody");
  }

  async function loadRunsTab() {
    try {
      const runs = await fetchRunsIndex();
      renderKpi(runs);
      renderRunsTable(runs);
    } catch (err) {
      console.error(LOG, "Lỗi loadRunsTab:", err);
    }
  }

  // Expose để script khác có thể gọi lại nếu cần
  window.vspLoadRunsTab = loadRunsTab;

  document.addEventListener("DOMContentLoaded", function () {
    // Auto-load nếu TAB Runs đang active sẵn
    const tabPane = document.getElementById("tab-runs");
    if (tabPane && tabPane.classList.contains("tab-pane") && tabPane.classList.contains("active")) {
      console.log(LOG, "tab-runs active sẵn – auto loadRunsTab()");
      loadRunsTab();
    }

    // Bind nút TAB 2 – Runs & Reports
    const tabBtn = document.querySelector("[data-tab-target='tab-runs']");
    if (tabBtn) {
      tabBtn.addEventListener("click", function () {
        console.log(LOG, "switch to TAB Runs – loadRunsTab()");
        loadRunsTab();
      });
    } else {
      console.warn(LOG, "Không tìm thấy nút TAB 2 (data-tab-target='tab-runs').");
    }
  });
})();

})();

})();
/* ==== END: static/js/vsp_runs_v1.js ==== */

/* ==== BEGIN: static/js/vsp_runs_v3.js ==== */
(function(){
'use strict';
// === VSP RUNS & REPORTS – FIX V3 ===

function loadRuns() {
  fetch("/api/vsp/runs_index_v3")
    .then(r => r.json())
    .then(json => {
      if (!json.ok) return;
      const tbody = $("#runs-table-body");
      tbody.empty();

      json.items.forEach(run => {
        const tr = $(`
          <tr class="run-row">
            <td>${run.run_id}</td>
            <td>${run.timestamp}</td>
            <td>${run.tool_count}</td>
            <td>${run.total_findings}</td>
            <td>
              <button class="btn-export" data-id="${run.run_id}">
                Export
              </button>
            </td>
          </tr>
        `);
        tbody.append(tr);
      });
    })
    .catch(err => console.error("[RUNS] Error:", err));
}

// Export RUN
$(document).on("click",".btn-export",function(){
  const id = $(this).data("id");
  window.location.href = `/api/vsp/run_export_html?run_id=${id}`;
});

document.addEventListener("DOMContentLoaded", loadRuns);

})();
/* ==== END: static/js/vsp_runs_v3.js ==== */

/* ==== BEGIN: static/js/vsp_runs_verdict_badges_v1.js ==== */
(function(){
'use strict';
/* VSP_RUNS_VERDICT_BADGES_V2 (batch + gate_policy_v3) */
(function () {

  // VSP_ROUTE_GUARD_RUNS_ONLY_V1
  function __vsp_is_runs_only_v1(){
    try {
      const h = (location.hash||"").toLowerCase();
      return h.startsWith("#runs") || h.includes("#runs/");
    } catch(_) { return false; }
  }
  if(!__vsp_is_runs_only_v1()){
    try{ console.info("[VSP_ROUTE_GUARD_RUNS_ONLY_V1] skip", "vsp_runs_verdict_badges_v1.js", "hash=", location.hash); }catch(_){}
    return;
  }

  const RID_RE = /(RUN_[A-Za-z0-9_]+_\d{8}_\d{6}|VSP_CI_\d{8}_\d{6}|VSP_[A-Z0-9]+_\d{8}_\d{6}|REQ_[A-Za-z0-9_\-]{6,})/;

  function el(tag, props = {}, children = []) {
    const e = document.createElement(tag);
    Object.assign(e, props);
    children.forEach(c => e.appendChild(typeof c === "string" ? document.createTextNode(c) : c));
    return e;
  }

  function ensureModal() {
    let m = document.getElementById("vsp-gate-modal-v1");
    if (m) return m;

    const overlay = el("div", { id: "vsp-gate-modal-v1" });
    overlay.style.position = "fixed";
    overlay.style.inset = "0";
    overlay.style.zIndex = "99999";
    overlay.style.background = "rgba(0,0,0,0.55)";
    overlay.style.display = "none";
    overlay.addEventListener("click", (e) => { if (e.target === overlay) overlay.style.display = "none"; });

    const card = el("div");
    card.style.position = "absolute";
    card.style.top = "10%";
    card.style.left = "50%";
    card.style.transform = "translateX(-50%)";
    card.style.width = "min(900px, 92vw)";
    card.style.maxHeight = "80vh";
    card.style.overflow = "auto";
    card.style.borderRadius = "16px";
    card.style.border = "1px solid rgba(255,255,255,0.16)";
    card.style.background = "rgba(2,6,23,0.96)";
    card.style.padding = "14px 14px";
    card.style.color = "rgba(255,255,255,0.92)";
    card.style.boxShadow = "0 18px 60px rgba(0,0,0,0.45)";

    const header = el("div");
    header.style.display = "flex";
    header.style.alignItems = "center";
    header.style.justifyContent = "space-between";
    header.style.gap = "10px";

    const title = el("div", { id: "vsp-gate-modal-title-v1" });
    title.style.fontWeight = "800";
    title.style.fontSize = "14px";

    const close = el("button", { innerText: "Close" });
    close.style.cursor = "pointer";
    close.style.padding = "6px 10px";
    close.style.borderRadius = "999px";
    close.style.border = "1px solid rgba(255,255,255,0.16)";
    close.style.background = "rgba(15,23,42,0.6)";
    close.style.color = "rgba(255,255,255,0.92)";
    close.addEventListener("click", () => overlay.style.display = "none");

    header.appendChild(title);
    header.appendChild(close);

    const body = el("div", { id: "vsp-gate-modal-body-v1" });
    body.style.marginTop = "10px";
    body.style.fontSize = "12px";
    body.style.lineHeight = "1.5";
    body.style.whiteSpace = "pre-wrap";

    card.appendChild(header);
    card.appendChild(body);
    overlay.appendChild(card);
    document.body.appendChild(overlay);
    return overlay;
  }

  function badgeStyle(verdict) {
    const v = (verdict || "UNKNOWN").toUpperCase();
    const base = {
      display: "inline-flex",
      alignItems: "center",
      gap: "8px",
      fontSize: "11px",
      fontWeight: "800",
      padding: "4px 10px",
      borderRadius: "999px",
      border: "1px solid rgba(255,255,255,0.16)",
      background: "rgba(15,23,42,0.65)",
      cursor: "pointer",
      userSelect: "none",
      whiteSpace: "nowrap",
    };
    if (v.includes("RED") || v.includes("FAIL")) base.boxShadow = "0 0 0 1px rgba(239,68,68,0.25) inset";
    else if (v.includes("AMBER") || v.includes("WARN")) base.boxShadow = "0 0 0 1px rgba(245,158,11,0.25) inset";
    else if (v.includes("GREEN") || v.includes("PASS")) base.boxShadow = "0 0 0 1px rgba(34,197,94,0.25) inset";
    else base.boxShadow = "0 0 0 1px rgba(148,163,184,0.25) inset";
    return base;
  }

  function attachBadge(target, rid, gp) {
    if (!target || !rid || !gp) return;
    if (target.querySelector?.(`[data-vsp-gate-badge="1"][data-rid="${rid}"]`)) return;

    const verdict = (gp.verdict || "UNKNOWN").toUpperCase();
    const degN = Number(gp.degraded_n || 0);

    const b = el("span");
    b.dataset.vspGateBadge = "1";
    b.dataset.rid = rid;
    b.innerText = `VERDICT: ${verdict}${degN ? ` · DEG:${degN}` : ""}`;
    Object.assign(b.style, badgeStyle(verdict));

    b.addEventListener("click", () => {
      const overlay = ensureModal();
      const title = document.getElementById("vsp-gate-modal-title-v1");
      const body = document.getElementById("vsp-gate-modal-body-v1");
      title.textContent = `Run: ${rid} · Verdict: ${verdict}${degN ? ` · DEG:${degN}` : ""}`;

      const reasons = Array.isArray(gp.reasons) ? gp.reasons : (gp.reasons ? [String(gp.reasons)] : []);
      const degItems = Array.isArray(gp.degraded_items) ? gp.degraded_items : [];

      const lines = [];
      lines.push(`Source: ${gp.source || "unknown"}`);
      lines.push("");
      lines.push("Reasons:");
      if (reasons.length) reasons.forEach((x) => lines.push(`- ${x}`));
      else lines.push("- (none)");
      lines.push("");
      lines.push("Degraded:");
      if (degItems.length) degItems.forEach((x) => lines.push(`- ${x}`));
      else lines.push("- (none)");

      body.textContent = lines.join("\n");
      overlay.style.display = "block";
    });

    target.appendChild(document.createTextNode(" "));
    target.appendChild(b);
  }

  function extractRidFromNode(node) {
    const txt = (node?.innerText || node?.textContent || "").trim();
    const m1 = txt.match(RID_RE);
    if (m1) return m1[1];
    const a = node?.querySelector?.("a[href]") || null;
    if (a) {
      const m2 = a.getAttribute("href").match(RID_RE);
      if (m2) return m2[1];
    }
    return null;
  }

  async function loadRunsIndexMap() {
    try {
      const r = await fetch("/api/vsp/runs_index_v3_fs_resolved?limit=80&hide_empty=0&filter=1");
      if (!r.ok) return new Map();
      const j = await r.json();
      const items = j?.items || [];
      const m = new Map();
      items.forEach((it) => {
        const rid = it.run_id || it.id || it.rid;
        const ci = it.ci_run_dir || it.ci || it.run_dir;
        if (rid && ci) m.set(String(rid), String(ci));
      });
      return m;
    } catch {
      return new Map();
    }
  }

  async function fetchBatch(ridToCi) {
    const items = Array.from(ridToCi.entries()).map(([rid, ci_run_dir]) => ({ rid, ci_run_dir }));
    const r = await fetch("/api/vsp/gate_policy_batch_v1", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ items })
    });
    if (!r.ok) return [];
    const j = await r.json();
    return j?.items || [];
  }

  async function patchDashboardHeader() {
    const anchor =
      document.querySelector(".vsp-page-title") ||
      document.querySelector("h1") ||
      document.querySelector(".dashboard-title") ||
      null;
    if (!anchor) return;

    try {
      const dRes = await fetch("/api/vsp/dashboard_v3");
      if (!dRes.ok) return;
      const d = await dRes.json();
      const rid = d?.run_id || d?.latest_run_id || d?.current_run_id;
      if (!rid) return;

      // resolve ci_run_dir via run_status_v2 (cheap, 1 call)
      const sRes = await fetch(`/api/vsp/run_status_v2/${encodeURIComponent(rid)}`);
      const st = sRes.ok ? await sRes.json() : {};
      const ci = st?.ci_run_dir || null;

      const u = `/api/vsp/gate_policy_v3/${encodeURIComponent(rid)}${ci ? `?ci_run_dir=${encodeURIComponent(ci)}` : ""}`;
      const gRes = await fetch(u);
      if (!gRes.ok) return;
      const gp = await gRes.json();
      if (!gp || gp.ok === false) return;

      attachBadge(anchor.parentElement || anchor, rid, gp);
    } catch {}
  }

  async function patchRunsTable() {
    const roots = Array.from(document.querySelectorAll("table, .vsp-table, .runs-table, .vsp-runs, #tab-runs, [data-tab='runs']"));
    const scope = roots.length ? roots : [document.body];

    const ridToTargets = new Map();
    scope.forEach((root) => {
      const rows = root.querySelectorAll("tr, .row, .vsp-row, li, .vsp-run-item");
      rows.forEach((row) => {
        const rid = extractRidFromNode(row);
        if (!rid) return;
        if (!ridToTargets.has(rid)) ridToTargets.set(rid, []);
        ridToTargets.get(rid).push(row);
      });
    });

    const rids = Array.from(ridToTargets.keys()).slice(0, 50);
    if (!rids.length) return;

    const idx = await loadRunsIndexMap();
    const ridToCi = new Map();
    rids.forEach((rid) => {
      const ci = idx.get(rid) || idx.get(rid.replace(/^RUN_/, "")) || null;
      ridToCi.set(rid, ci);
    });

    const items = await fetchBatch(ridToCi);
    const byRid = new Map();
    items.forEach((it) => byRid.set(it.run_id, it));

    rids.forEach((rid) => {
      const gp = byRid.get(rid) || null;
      if (!gp) return;
      (ridToTargets.get(rid) || []).forEach((row) => {
        const place = row.querySelector("td") || row.querySelector(".title") || row.querySelector("a") || row;
        attachBadge(place, rid, gp);
      });
    });
  }

  window.addEventListener("DOMContentLoaded", () => {
    patchDashboardHeader();
    setTimeout(patchRunsTable, 600);
    setTimeout(patchRunsTable, 1600);
  });
})();

})();
/* ==== END: static/js/vsp_runs_verdict_badges_v1.js ==== */

/* ==== BEGIN: static/js/vsp_settings_advanced_v1.js ==== */
(function(){
'use strict';
(function () {
  console.log("[VSP_SETTINGS] vsp_settings_advanced_v1.js loaded (CLEAN v3)");

  var injected = false;
  var WRAPPER_ID = "vsp-settings-run-dast-wrapper";

  function showToast(msg) {
    alert(msg); // TODO: nâng cấp toast sau
  }

  function findSettingsPane() {
    var pane =
      document.getElementById("vsp-tab-settings-main") ||
      document.querySelector("[data-vsp-pane='settings']") ||
      document.querySelector("#vsp-tab-settings") ||
      document.querySelector(".vsp-pane-settings");

    if (pane) {
      console.log("[VSP_SETTINGS] Found settings pane (by id/class).");
      return pane;
    }

    // fallback nhẹ theo text (chỉ dùng lúc đang ở tab Settings)
    var all = Array.from(document.querySelectorAll("section,div,main"));
    var marker = all.find(function (el) {
      var t = (el.textContent || "").toUpperCase();
      return t.includes("SETTINGS") && t.includes("SETTINGS_UI_V1");
    });
    if (marker) {
      pane = marker.closest(".vsp-pane") || marker.closest("section") || marker.closest("div");
      if (pane) {
        console.log("[VSP_SETTINGS] Found settings pane via text marker.");
        return pane;
      }
    }

    console.warn("[VSP_SETTINGS] Chưa tìm được settings pane – sẽ thử lại.");
    return null;
  }

  function setWrapperVisibility() {
    var wrapper = document.getElementById(WRAPPER_ID);
    if (!wrapper) return;
    if (location.hash === "#settings") {
      wrapper.style.display = "";
    } else {
      wrapper.style.display = "none";
    }
  }

  async function callApiRun(target, profile) {
    const resp = await fetch("/api/vsp/run", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({
        mode: "local",
        profile: profile || "FULL_EXT",
        target_type: "path",
        target: target
      })
    });
    const data = await resp.json();
    if (!resp.ok || !data.ok) {
      throw new Error(data.error || resp.statusText);
    }
    return data;
  }

  async function callApiDast(url) {
    const resp = await fetch("/api/vsp/dast/scan", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({url: url})
    });
    const data = await resp.json();
    if (!resp.ok || !data.ok) {
      throw new Error(data.error || resp.statusText);
    }
    return data;
  }

  function injectSettingsExtras() {
    if (injected) return;
    if (location.hash !== "#settings") return;

    var pane = findSettingsPane();
    if (!pane) return;

    if (document.getElementById(WRAPPER_ID)) {
      injected = true;
      setWrapperVisibility();
      return;
    }

    injected = true;
// VSP_SETTINGS_DISABLE_RUNDAST_V1
return;
    console.log("[VSP_SETTINGS] Injecting RUN/DAST block into Settings pane.");

    const wrapper = document.createElement("div");
    wrapper.id = WRAPPER_ID;
    wrapper.innerHTML = `
      <div class="vsp-grid vsp-grid-2" style="margin-top:24px; gap:24px;">
        <div class="vsp-card">
          <div class="vsp-card-title">RUN SCAN NOW (LOCAL)</div>
          <div class="vsp-card-subtitle">Gọi /api/vsp/run → run_vsp_full_ext.sh hoặc VSP_CI_OUTER</div>
          <div class="vsp-form-row">
            <label>Target path</label>
            <input id="vsp-settings-target-path" type="text" placeholder="/path/to/project" style="width:100%;">
          </div>
          <div class="vsp-form-row" style="margin-top:8px;">
            <label>Profile</label>
            <select id="vsp-settings-profile">
              <option value="FULL_EXT">FULL_EXT</option>
              <option value="QUICK">QUICK</option>
            </select>
          </div>
          <div style="margin-top:12px;">
            <button id="vsp-settings-run-local" class="vsp-btn-primary">Run scan now (LOCAL)</button>
          </div>
          <p style="margin-top:8px; font-size:12px; opacity:0.7;">
            Nút này chỉ trigger RUN; trạng thái & gate xem trong tab Dashboard / Runs & Reports.
          </p>
        </div>

        <div class="vsp-card">
          <div class="vsp-card-title">DAST – Scan URL/Domain</div>
          <div class="vsp-card-subtitle">Gọi /api/vsp/dast/scan (engine ZAP/Nessus… tùy cấu hình)</div>
          <div class="vsp-form-row">
            <label>Target URL</label>
            <input id="vsp-dast-url" type="text" placeholder="https://example.com" style="width:100%;">
          </div>
          <div style="margin-top:12px;">
            <button id="vsp-dast-start" class="vsp-btn-primary">Start DAST (stub/real)</button>
          </div>
          <p style="margin-top:8px; font-size:12px; opacity:0.7;">
            Đây là DAST engine riêng (ZAP/Nessus/...),
            không phải engine AATE/ANY-URL UI test.
          </p>
        </div>
      </div>
    `;
    pane.appendChild(wrapper);
    setWrapperVisibility();

    const runBtn = document.getElementById("vsp-settings-run-local");
    const targetInput = document.getElementById("vsp-settings-target-path");
    const profileSelect = document.getElementById("vsp-settings-profile");
    const dastBtn = document.getElementById("vsp-dast-start");
    const dastUrlInput = document.getElementById("vsp-dast-url");

    if (runBtn) {
      runBtn.addEventListener("click", async function () {
        const target = (targetInput && targetInput.value.trim()) || "";
        const profile = profileSelect ? profileSelect.value : "FULL_EXT";
        if (!target) {
          showToast("Bạn chưa nhập target path.");
          return;
        }
        runBtn.disabled = true;
        runBtn.innerText = "Running...";
        try {
          const data = await callApiRun(target, profile);
          showToast("Đã gửi RUN: RUN_ID=" + data.run_id);
        } catch (err) {
          console.error(err);
          showToast("RUN thất bại: " + err.message);
        } finally {
          runBtn.disabled = false;
          runBtn.innerText = "Run scan now (LOCAL)";
        }
      });
    }

    if (dastBtn) {
      dastBtn.addEventListener("click", async function () {
        const url = (dastUrlInput && dastUrlInput.value.trim()) || "";
        if (!url) {
          showToast("Bạn chưa nhập URL DAST.");
          return;
        }
        dastBtn.disabled = true;
        dastBtn.innerText = "Starting...";
        try {
          const data = await callApiDast(url);
          showToast("Đã gửi DAST: RUN_ID=" + data.run_id);
        } catch (err) {
          console.error(err);
          showToast("DAST thất bại: " + err.message);
        } finally {
          dastBtn.disabled = false;
          dastBtn.innerText = "Start DAST (stub/real)";
        }
      });
    }
  }

  function scheduleInjectOnSettings() {
    // chỉ chạy khi đang ở tab settings
    if (location.hash !== "#settings") {
      setWrapperVisibility();
      return;
    }
    var attempts = 0;
    var timer = setInterval(function () {
      if (location.hash !== "#settings") {
        clearInterval(timer);
        setWrapperVisibility();
        return;
      }
      attempts += 1;
      injectSettingsExtras();
      setWrapperVisibility();
      if (injected || attempts >= 20) {
        clearInterval(timer);
      }
    }, 100);
  }

  document.addEventListener("DOMContentLoaded", function () {
    scheduleInjectOnSettings();
  });

  window.addEventListener("hashchange", function () {
    scheduleInjectOnSettings();
  });
})();

})();
/* ==== END: static/js/vsp_settings_advanced_v1.js ==== */

/* ==== BEGIN: static/js/vsp_settings_bind_v1.js ==== */
(function(){
'use strict';
(function () {
  function onReady(fn) {
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", fn);
    } else {
      fn();
    }
  }

  function $(id) {
    return document.getElementById(id);
  }

  async function loadSettings() {
    console.log("[VSP_SETTINGS] init loadSettings()");

    // Nếu tab 4 không có trong DOM thì thôi, tránh lỗi khi dùng template khác
    var profileEl = $("vsp-settings-profile-label");
    if (!profileEl) {
      console.log("[VSP_SETTINGS] Không thấy #vsp-settings-profile-label trong DOM, bỏ qua.");
      return;
    }

    try {
      var resp = await fetch("/api/vsp/settings/get", { credentials: "same-origin" });
      console.log("[VSP_SETTINGS] fetch /api/vsp/settings/get →", resp.status);
      if (!resp.ok) {
        throw new Error("HTTP " + resp.status);
      }

      var data = await resp.json();
      console.log("[VSP_SETTINGS] Loaded settings JSON:", data);

      // ==== Raw JSON preview ====
      var rawPre = $("vsp-settings-raw-json");
      if (rawPre) {
        try {
          rawPre.textContent = JSON.stringify(data, null, 2);
        } catch (e) {
          rawPre.textContent = String(e);
        }
      }

      var envPre = $("vsp-settings-env-json");
      if (envPre && data && data.env) {
        try {
          envPre.textContent = JSON.stringify(data.env, null, 2);
        } catch (e) {
          envPre.textContent = String(e);
        }
      }

      // ==== Profile / root_dir / security_score ====
      if (data && data.env) {
        if (data.env.profile && profileEl) {
          profileEl.textContent = data.env.profile;
        }
        var rootEl = $("vsp-settings-root-dir");
        if (rootEl && data.env.root_dir) {
          rootEl.textContent = data.env.root_dir;
        }
      }

      var scoreEl = $("vsp-settings-security-score");
      var score =
        (data && data.security_score !== undefined ? data.security_score : null) ||
        (data && data.env && data.env.security_score !== undefined ? data.env.security_score : null);

      if (scoreEl && score !== null && score !== undefined) {
        scoreEl.textContent = String(score);
      }

      // ==== Tools table ====
      if (data && data.tools) {
        var table = $("vsp-settings-tools-table");
        if (table) {
          var tbody = table.querySelector("tbody");
          if (tbody) {
            tbody.innerHTML = "";

            Object.entries(data.tools).forEach(function (entry) {
              var toolId = entry[0];
              var cfg = entry[1] || {};

              var label = cfg.label || cfg.name || "";
              var enabled =
                typeof cfg.enabled === "boolean"
                  ? (cfg.enabled ? "ON" : "OFF")
                  : "—";
              var notes =
                cfg.notes || cfg.comment || cfg.description || "";

              var tr = document.createElement("tr");
              tr.innerHTML =
                '<td><code>' + toolId + "</code></td>" +
                "<td>" + label + "</td>" +
                "<td>" + enabled + "</td>" +
                "<td>" + notes + "</td>";

              tbody.appendChild(tr);
            });

            if (!Object.keys(data.tools).length) {
              var trEmpty = document.createElement("tr");
              trEmpty.className = "vsp-settings-row-placeholder";
              trEmpty.innerHTML =
                '<td colspan="4"><span class="vsp-muted">' +
                "Không có tool nào trong cấu hình hiện tại." +
                "</span></td>";
              tbody.appendChild(trEmpty);
            }
          }
        }
      }
    } catch (err) {
      console.warn("[VSP_SETTINGS] Lỗi khi load /api/vsp/settings/get:", err);
    }
  }

  onReady(loadSettings);
})();

})();
/* ==== END: static/js/vsp_settings_bind_v1.js ==== */

/* ==== BEGIN: static/js/vsp_settings_cicd_mode_v1.js ==== */
(function(){
'use strict';
(function(){
  console.log("[VSP_SETTINGS] cicd mode loaded");

  document.addEventListener("DOMContentLoaded", function(){
    const sel = document.getElementById("sel-cicd-mode");
    if (!sel) return;

    fetch("/api/vsp/settings_ui_v1")
      .then(r => r.json())
      .then(cfg => {
        if (cfg.settings && cfg.settings.cicd_mode)
          sel.value = cfg.settings.cicd_mode;
      });

    sel.onchange = function(){
      fetch("/api/vsp/settings_update", {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ cicd_mode: sel.value })
      });
    };
  });
})();

})();
/* ==== END: static/js/vsp_settings_cicd_mode_v1.js ==== */

/* ==== BEGIN: static/js/vsp_settings_render.js ==== */
(function(){
'use strict';
/**
 * VSP SETTINGS – PROFILE + LAST RUN + TOOL STACK
 * - Chỉ áp dụng cho tab #tab-settings
 * - Không tạo thanh cuộn bên trong; dùng layout 2 cột, full màn hình.
 */

(function () {
  if (!window.VSP) window.VSP = {};

  // Helper: tạo 1 element
  function el(tag, className, text) {
    var node = document.createElement(tag);
    if (className) node.className = className;
    if (typeof text === "string") node.textContent = text;
    return node;
  }

  // Render chính
  function renderSettings(root, settings) {
    if (!root) return;
    if (!settings) settings = {};

    var profile = settings.profile || "EXT";
    var runId   = settings.last_run_id || "N/A";
    var tools   = Array.isArray(settings.tools) ? settings.tools : [];

    // Layout tổng
    var wrap = el("div", "vsp-settings-layout");

    // --- Cột trái: PROFILE + LAST RUN ---
    var colLeft = el("div", "vsp-settings-col-left");
    var cardInfo = el("div", "vsp-card vsp-settings-card");

    var profileLabel = el("div", "vsp-label", "PROFILE");
    var profileVal   = el("div", "vsp-value", profile);

    var runLabel = el("div", "vsp-label mt-32", "LAST RUN ID");
    var runVal   = el("div", "vsp-value", runId);

    cardInfo.appendChild(profileLabel);
    cardInfo.appendChild(profileVal);
    cardInfo.appendChild(runLabel);
    cardInfo.appendChild(runVal);
    colLeft.appendChild(cardInfo);

    // --- Cột phải: TOOL STACK TABLE ---
    var colRight = el("div", "vsp-settings-col-right");
    var cardTools = el("div", "vsp-card vsp-settings-card");

    var header = el("div", "vsp-card-header");
    var title = el("div", "vsp-card-title", "Tool Stack (" + tools.length + " tools)");
    header.appendChild(title);
    cardTools.appendChild(header);

    // Table wrapper (không tạo scroll riêng)
    var tableWrap = el("div", "vsp-table-wrapper");
    var table = el("table", "vsp-table");

    var thead = el("thead");
    var trHead = el("tr");
    ["Tool", "Type", "Enabled"].forEach(function (h) {
      var th = el("th", "", h.toUpperCase());
      trHead.appendChild(th);
    });
    thead.appendChild(trHead);
    table.appendChild(thead);

    var tbody = el("tbody");
    tools.forEach(function (t) {
      var tr = el("tr");
      var tdTool = el("td", "", t.name || t.key || "");
      var tdType = el("td", "", t.type || "");
      var tdEn   = el("td", "", (t.enabled === false || t.enabled === "OFF") ? "OFF" : "ON");
      tr.appendChild(tdTool);
      tr.appendChild(tdType);
      tr.appendChild(tdEn);
      tbody.appendChild(tr);
    });
    table.appendChild(tbody);

    tableWrap.appendChild(table);
    cardTools.appendChild(tableWrap);
    colRight.appendChild(cardTools);

    wrap.appendChild(colLeft);
    wrap.appendChild(colRight);

    // Ghi vào tab-settings
    root.innerHTML = "";
    root.appendChild(wrap);
  }

  // Gọi API settings rồi render
  function fetchAndRender() {
    var root = document.getElementById("tab-settings");
    if (!root) return;

    fetch("/api/vsp/settings")
      .then(function (resp) { return resp.json(); })
      .then(function (data) {
        renderSettings(root, data || {});
      })
      .catch(function (e) {
        if (window.console && console.error) {
          console.error("[VSP][SETTINGS] Lỗi gọi API /api/vsp/settings:", e);
        }
      });
  }

  document.addEventListener("DOMContentLoaded", function () {
    // Đợi DOM sẵn sàng, sau đó render
    setTimeout(fetchAndRender, 300);
  });
})();

})();
/* ==== END: static/js/vsp_settings_render.js ==== */

/* ==== BEGIN: static/js/vsp_settings_runlocal_v1.js ==== */
(function(){
'use strict';
(function(){
  console.log("[VSP_SETTINGS] run-local handler loaded");

  document.addEventListener("DOMContentLoaded", function(){
    const btn = document.getElementById("btn-run-local");
    if (!btn) return;

    btn.onclick = function(){
      fetch("/api/vsp/run", {method:"POST"})
      .then(r => r.json())
      .then(x => {
        alert("Run started: " + x.run_id);
      })
      .catch(e => alert("Error: "+e));
    };
  });
})();

})();
/* ==== END: static/js/vsp_settings_runlocal_v1.js ==== */

/* ==== BEGIN: static/js/vsp_settings_simple_v1.js ==== */
(function(){
'use strict';
const VSP_SETTINGS_SIMPLE_LOG = "[VSP_SETTINGS_SIMPLE]";

function vspSimpSel(id) {
  const el = document.getElementById(id);
  if (!el) {
    console.warn(VSP_SETTINGS_SIMPLE_LOG, "Missing element", id);
  }
  return el;
}

async function vspSimpFetch(url, options = {}) {
  const resp = await fetch(url, options);
  const data = await resp.json().catch(() => null);
  if (!data) throw new Error("Invalid JSON from " + url);
  return data;
}

function vspSimpFill(settings) {
  settings = settings || {};
  const profileDefault = settings.profile_default || "FULL_EXT";
  const severityGate = settings.severity_gate_min || "MEDIUM";
  const toolsEnabled = settings.tools_enabled || {};
  const general = settings.general || {};
  const integrations = settings.integrations || {};

  // Thanh trên
  const selProfile = vspSimpSel("vsp-settings-profile-default");
  if (selProfile) selProfile.value = profileDefault;

  const selSeverity = vspSimpSel("vsp-settings-severity-gate");
  if (selSeverity) selSeverity.value = severityGate;

  document.querySelectorAll("input.vsp-settings-tool[type=checkbox]").forEach(cb => {
    const key = cb.dataset.tool;
    if (!key) return;
    cb.checked = !!toolsEnabled[key];
  });

  // General
  const inpSrcRoot = vspSimpSel("vsp-settings-src-root");
  if (inpSrcRoot) inpSrcRoot.value = general.default_src_root || "/home/test/Data/khach6";

  const inpRunDir = vspSimpSel("vsp-settings-run-dir");
  if (inpRunDir) inpRunDir.value = general.default_run_dir || "out/RUN_YYYYmmdd_HHMMSS";

  const selExportType = vspSimpSel("vsp-settings-export-type");
  if (selExportType) selExportType.value = general.default_export_type || "HTML+CSV";

  const inpMaxRows = vspSimpSel("vsp-settings-max-rows");
  if (inpMaxRows) inpMaxRows.value = general.ui_table_max_rows || 5000;

  // Integrations
  const inpWebhook = vspSimpSel("vsp-settings-webhook-url");
  if (inpWebhook) inpWebhook.value = integrations.webhook_url || "";

  const inpSlack = vspSimpSel("vsp-settings-slack-channel");
  if (inpSlack) inpSlack.value = integrations.slack_channel || "";

  const inpDeptrack = vspSimpSel("vsp-settings-deptrack-url");
  if (inpDeptrack) inpDeptrack.value = integrations.dependency_track_url || "";
}

function vspSimpCollect() {
  const profileDefault = vspSimpSel("vsp-settings-profile-default")?.value || "FULL_EXT";
  const severityGate = vspSimpSel("vsp-settings-severity-gate")?.value || "MEDIUM";

  const toolsEnabled = {};
  document.querySelectorAll("input.vsp-settings-tool[type=checkbox]").forEach(cb => {
    const key = cb.dataset.tool;
    if (!key) return;
    toolsEnabled[key] = cb.checked;
  });

  const general = {
    default_src_root: vspSimpSel("vsp-settings-src-root")?.value || "",
    default_run_dir: vspSimpSel("vsp-settings-run-dir")?.value || "",
    default_export_type: vspSimpSel("vsp-settings-export-type")?.value || "HTML+CSV",
    ui_table_max_rows: parseInt(vspSimpSel("vsp-settings-max-rows")?.value || "5000", 10),
  };

  const integrations = {
    webhook_url: vspSimpSel("vsp-settings-webhook-url")?.value || "",
    slack_channel: vspSimpSel("vsp-settings-slack-channel")?.value || "",
    dependency_track_url: vspSimpSel("vsp-settings-deptrack-url")?.value || "",
  };

  return {
    profile_default: profileDefault,
    severity_gate_min: severityGate,
    tools_enabled: toolsEnabled,
    general: general,
    integrations: integrations,
  };
}

async function vspSimpLoad() {
  try {
    console.log(VSP_SETTINGS_SIMPLE_LOG, "Loading /api/vsp/settings_v1 ...");
    const data = await vspSimpFetch("/api/vsp/settings_v1");
    if (!data.ok) {
      console.warn(VSP_SETTINGS_SIMPLE_LOG, "settings_v1.ok = false", data);
    }
    vspSimpFill(data.settings || {});
    console.log(VSP_SETTINGS_SIMPLE_LOG, "Loaded.");
  } catch (e) {
    console.error(VSP_SETTINGS_SIMPLE_LOG, "Load failed", e);
  }
}

async function vspSimpSave() {
  const payload = vspSimpCollect();
  console.log(VSP_SETTINGS_SIMPLE_LOG, "Saving ...", payload);
  try {
    const resp = await vspSimpFetch("/api/vsp/settings_v1", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });
    if (!resp.ok) {
      console.warn(VSP_SETTINGS_SIMPLE_LOG, "Save not ok", resp);
      alert("Save settings failed – check console.");
      return;
    }
    console.log(VSP_SETTINGS_SIMPLE_LOG, "Save OK.");
    const btn = vspSimpSel("vsp-settings-save-btn");
    if (btn) {
      const old = btn.textContent;
      btn.textContent = "Saved!";
      setTimeout(() => (btn.textContent = old), 1500);
    }
  } catch (e) {
    console.error(VSP_SETTINGS_SIMPLE_LOG, "Save error", e);
    alert("Error saving settings – check console.");
  }
}

// Auto init khi page load
document.addEventListener("DOMContentLoaded", () => {
  console.log(VSP_SETTINGS_SIMPLE_LOG, "Init on DOMContentLoaded.");
  const btn = vspSimpSel("vsp-settings-save-btn");
  if (btn && !btn.dataset.vspSimpBound) {
    btn.addEventListener("click", (e) => {
      e.preventDefault();
      vspSimpSave();
    });
    btn.dataset.vspSimpBound = "1";
  }
  vspSimpLoad();
});

})();
/* ==== END: static/js/vsp_settings_simple_v1.js ==== */

/* ==== BEGIN: static/js/vsp_settings_tab_simple_v1.js ==== */
(function(){
'use strict';
(function () {
  var API_URL = "/api/vsp/settings_ui_v1";
  var hydrated = false;

  function hydratePane() {
    if (hydrated) return;
    var pane = document.getElementById("vsp-tab-settings");
    if (!pane) return;

    hydrated = true;

    pane.innerHTML =
      '<div class="vsp-section-header">' +
        '<div>' +
          '<h2 class="vsp-section-title">Settings</h2>' +
          '<p class="vsp-section-subtitle">Cấu hình SECURITY_BUNDLE (settings_ui_v1)</p>' +
        '</div>' +
      '</div>' +
      '<div class="vsp-card">' +
        '<pre id="vsp-settings-pre">{\n  "ok": false,\n  "settings": {}\n}</pre>' +
      '</div>';

    var pre = document.getElementById("vsp-settings-pre");
    if (!pre) return;

    fetch(API_URL, { cache: "no-store" })
      .then(function (res) { return res.json(); })
      .then(function (data) {
        console.log("[VSP_SETTINGS_TAB_V2] settings_ui_v1 loaded.", data);
        try {
          pre.textContent = JSON.stringify(data, null, 2);
        } catch (e) {
          pre.textContent = "Lỗi format JSON settings_ui_v1.";
        }
      })
      .catch(function (err) {
        console.error("[VSP_SETTINGS_TAB_V2] Failed to load settings_ui_v1:", err);
        pre.textContent = "Lỗi gọi API settings_ui_v1.";
      });
  }

  window.vspInitSettingsTab = hydratePane;

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", hydratePane);
  } else {
    hydratePane();
  }
})();




/* VSP_SETTINGS_COMMERCIAL_POLICY_SIMPLE_V2_BEGIN */
(function(){
  'use strict';

  const API_SETTINGS = "/api/vsp/settings_v1";
  const API_DASH     = "/api/vsp/dashboard_v3";

  function $(sel, root){ return (root||document).querySelector(sel); }
  function $all(sel, root){ return Array.from((root||document).querySelectorAll(sel)); }
  function esc(s){ return String(s ?? "").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
  function visibleEl(el){
    if (!el) return false;
    const r = el.getBoundingClientRect();
    return !!(el.offsetParent !== null && r.width > 240 && r.height > 160);
  }

  function pickBestSettingsContainer(){
    const cands = [
      "#tab-settings","#vsp4-settings","[data-tab='settings']","#settings",
      "#tabpane-settings","#pane-settings","#panel-settings",
      ".tab-pane.active",".tab-pane.is-active",
      ".vsp-main",".vsp-content","main",".content","#content",".page-content",
      "body"
    ];
    let best = document.body, bestArea = 0;
    for (const sel of cands){
      const els = $all(sel);
      for (const el of els){
        if (!visibleEl(el)) continue;
        const r = el.getBoundingClientRect();
        const area = r.width * r.height;
        if (area > bestArea){
          bestArea = area;
          best = el;
        }
      }
    }
    return best || document.body;
  }

  function ensureHost(root){
    let host = $("#vsp-settings-commercial-policy", root);
    if (!host){
      host = document.createElement("div");
      host.id = "vsp-settings-commercial-policy";
      host.className = "vsp-card";
      host.style.marginTop = "12px";
      root.appendChild(host);
    }
    return host;
  }

  async function safeJson(url){
    try{
      const r = await fetch(url, { credentials: "same-origin" });
      return await r.json();
    }catch(_e){
      return {};
    }
  }

  function pick(obj, keys){
    for (const k of keys){
      if (obj && Object.prototype.hasOwnProperty.call(obj, k)) return obj[k];
    }
    return undefined;
  }

  function render(host, ctx){
    const tools = [
      ["Bandit","SAST (Python)"],["Semgrep","SAST"],["Gitleaks","Secrets"],["KICS","IaC"],
      ["Trivy","Vuln (FS)"],["Syft","SBOM"],["Grype","Vuln (SBOM)"],["CodeQL","SAST (deep)"]
    ];
    host.innerHTML = `
      <h3 style="margin:0 0 6px 0;">Commercial Operational Policy</h3>
      <div style="opacity:.8; margin-bottom:10px;">8 tools + timeout/degraded governance + exports/artifacts + ISO note (CIO readable).</div>

      <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:10px;">
        ${tools.map(t => `
          <div class="vsp-card vsp-card--tight">
            <div style="font-weight:700;">${esc(t[0])}</div>
            <div style="opacity:.85;">${esc(t[1])}</div>
          </div>
        `).join("")}
      </div>

      <hr style="opacity:.15; margin:12px 0;" />
      <h4 style="margin:0 0 8px 0;">Timeout & Degraded</h4>
      <ul style="margin:0; padding-left:18px; opacity:.92; line-height:1.5;">
        <li>Timeout/missing tool ⇒ <b>DEGRADED</b> (pipeline không treo).</li>
        <li>Degraded = tool không hoàn tất nhưng có log/artifact + run kết thúc FINAL.</li>
      </ul>

      <hr style="opacity:.15; margin:12px 0;" />
      <h4 style="margin:0 0 8px 0;">Current Flags</h4>
      <div class="vsp-card vsp-card--tight" style="opacity:.92; line-height:1.6;">
        <div>FS_FALLBACK: <b>${esc(ctx.flags.FS_FALLBACK)}</b></div>
        <div>EXPORT_FORCE_BIND: <b>${esc(ctx.flags.EXPORT_FORCE_BIND)}</b></div>
        <div>OVERRIDES_ENABLED: <b>${esc(ctx.flags.OVERRIDES_ENABLED)}</b></div>
      </div>

      <hr style="opacity:.15; margin:12px 0;" />
      <h4 style="margin:0 0 8px 0;">Key Endpoints</h4>
      <div style="opacity:.92; line-height:1.6;">
        <div><code>/api/vsp/runs_index_v3_fs_resolved</code></div>
        <div><code>/api/vsp/run_status_v2/&lt;rid&gt;</code></div>
        <div><code>/api/vsp/artifacts_index_v1/&lt;rid&gt;</code></div>
        <div><code>/api/vsp/run_export_v3/&lt;rid&gt;?fmt=html|zip|pdf</code></div>
      </div>

      <hr style="opacity:.15; margin:12px 0;" />
      <h4 style="margin:0 0 8px 0;">ISO 27001 Note</h4>
      <div style="opacity:.92; line-height:1.5;">
        ISO mapping phục vụ governance/traceability (không phải chứng nhận).
      </div>
    `;
  }

  async function init(){
    const root = pickBestSettingsContainer();
    const host = ensureHost(root);

    const settings = await safeJson(API_SETTINGS);
    const dash = await safeJson(API_DASH);

    const flags = {
      FS_FALLBACK: String(pick(settings, ["fs_fallback","FS_FALLBACK"]) ?? pick(dash, ["fs_fallback","FS_FALLBACK"]) ?? "UNKNOWN"),
      EXPORT_FORCE_BIND: String(pick(settings, ["export_force_bind","EXPORT_FORCE_BIND"]) ?? "UNKNOWN"),
      OVERRIDES_ENABLED: String(pick(settings, ["overrides_enabled","OVERRIDES_ENABLED"]) ?? "UNKNOWN"),
    };

    render(host, { flags });
  }

  if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", init);
  else init();
})();
/* VSP_SETTINGS_COMMERCIAL_POLICY_SIMPLE_V2_END */


})();
/* ==== END: static/js/vsp_settings_tab_simple_v1.js ==== */

/* ==== BEGIN: static/js/vsp_settings_tab_v1.js ==== */
(function(){
'use strict';
(function () {
  const API_URL = '/api/vsp/settings_ui_v1';
  const INIT_DELAY_MS = 1200;

  function esc(s) {
    if (s == null) return '';
    return String(s)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;');
  }

  function renderSkeleton(tab) {
    tab.innerHTML = `
      <div class="vsp-tab-inner vsp-tab-settings">
        <div class="vsp-tab-header">
          <h2>Settings</h2>
          <p class="vsp-tab-subtitle">
            Cấu hình chính sách gate, tool và tham số scan. Hiện tại ở chế độ xem (read-only).
          </p>
        </div>

        <div class="vsp-card-grid">
          <div class="vsp-card">
            <h3>Gate policy</h3>
            <p class="vsp-muted">
              Điều kiện để job CI đánh FAIL / PASS. Mặc định: FAIL nếu CRITICAL &gt; 0 hoặc HIGH &gt; 10.
            </p>
            <ul class="vsp-list" id="vsp-settings-gate-list">
              <li>Loading gate policy…</li>
            </ul>
          </div>

          <div class="vsp-card">
            <h3>Tools</h3>
            <p class="vsp-muted">
              Các công cụ security hiện được kích hoạt trong gói VSP (Semgrep, CodeQL, KICS,…).
            </p>
            <ul class="vsp-list" id="vsp-settings-tools-list">
              <li>Loading tools…</li>
            </ul>
          </div>

          <div class="vsp-card">
            <h3>Profiles &amp; thresholds</h3>
            <p class="vsp-muted">
              Một số tham số nâng cao (timeout, max files, profile FULL_EXT/SMOKE…).
            </p>
            <ul class="vsp-list" id="vsp-settings-extra-list">
              <li>Loading…</li>
            </ul>
          </div>
        </div>

        <div class="vsp-card vsp-card-note">
          <h3>Editing roadmap</h3>
          <p>
            Phiên bản hiện tại cho phép xem cấu hình. Bản thương mại tiếp theo sẽ bật:
          </p>
          <ul class="vsp-list">
            <li>Chỉnh gate policy trực tiếp và lưu xuống server.</li>
            <li>Bật/tắt từng tool theo repo hoặc theo pipeline.</li>
            <li>Lưu và restore cấu hình theo profile (STRICT / BALANCED / RELAXED).</li>
          </ul>
        </div>
      </div>
    `;
  }

  async function bindSettings(tab) {
    renderSkeleton(tab);

    const gateList = tab.querySelector('#vsp-settings-gate-list');
    const toolsList = tab.querySelector('#vsp-settings-tools-list');
    const extraList = tab.querySelector('#vsp-settings-extra-list');

    let data;
    try {
      const res = await fetch(API_URL, { cache: 'no-store' });
      data = await res.json();
    } catch (e) {
      console.error('[VSP_SETTINGS_TAB] Failed to load settings_ui_v1', e);
      if (gateList) gateList.innerHTML = '<li class="vsp-error">Không tải được settings từ API.</li>';
      if (toolsList) toolsList.innerHTML = '';
      if (extraList) extraList.innerHTML = '';
      return;
    }

    const settings = data.settings || {};

    // Gate policy
    if (gateList) {
      if (!settings.gate_policy) {
        gateList.innerHTML = `
          <li><strong>Mode:</strong> Default</li>
          <li><strong>Fail if CRITICAL &gt; 0</strong></li>
          <li><strong>Fail if HIGH &gt; 10</strong></li>
          <li>MEDIUM/LOW chỉ cảnh báo, không fail job.</li>
        `;
      } else {
        const gp = settings.gate_policy;
        const lines = [];
        if (gp.mode) lines.push(`<li><strong>Mode:</strong> ${esc(gp.mode)}</li>`);
        if (gp.critical_threshold != null) {
          lines.push(`<li>Fail nếu CRITICAL &gt; ${esc(gp.critical_threshold)}</li>`);
        }
        if (gp.high_threshold != null) {
          lines.push(`<li>Fail nếu HIGH &gt; ${esc(gp.high_threshold)}</li>`);
        }
        if (gp.description) {
          lines.push(`<li>${esc(gp.description)}</li>`);
        }
        gateList.innerHTML = lines.join('') || '<li>Gate policy đang để trống.</li>';
      }
    }

    // Tools
    if (toolsList) {
      const tools = settings.tools || settings.tools_enabled || {};
      const names = Object.keys(tools);
      if (!names.length) {
        toolsList.innerHTML = `
          <li>Semgrep</li>
          <li>Gitleaks</li>
          <li>KICS</li>
          <li>CodeQL</li>
          <li>Trivy / Syft / Grype</li>
        `;
      } else {
        toolsList.innerHTML = names
          .map(name => {
            const v = tools[name];
            const enabled = v === true || v === 'on' || v === 'enabled';
            return `<li><strong>${esc(name)}</strong> – ${enabled ? 'enabled' : 'disabled'}</li>`;
          })
          .join('');
      }
    }

    // Extra
    if (extraList) {
      const extras = settings.extras || settings.profiles || {};
      const keys = Object.keys(extras);
      if (!keys.length) {
        extraList.innerHTML = `
          <li>Profile FULL_EXT: full scan toàn hệ thống.</li>
          <li>Profile SMOKE: scan nhanh (~10–20% trọng tâm) cho mỗi push CI.</li>
          <li>Timeout, số file tối đa: sử dụng giá trị mặc định an toàn.</li>
        `;
      } else {
        extraList.innerHTML = keys
          .map(name => `<li><strong>${esc(name)}:</strong> ${esc(JSON.stringify(extras[name]))}</li>`)
          .join('');
      }
    }

    console.log('[VSP_SETTINGS_TAB] Rendered settings.');
  }

  let initialized = false;

  function tryInit() {
    if (initialized) return;
    const tab = document.querySelector('#vsp-tab-settings');
    if (!tab) {
      setTimeout(tryInit, 500);
      return;
    }
    initialized = true;
    setTimeout(() => bindSettings(tab), INIT_DELAY_MS);
  }

  tryInit();
})();

/* VSP_SETTINGS_COMMERCIAL_POLICY_V3_BEGIN */
(function(){
  'use strict';

  const API_SETTINGS = "/api/vsp/settings_v1";
  const API_DASH     = "/api/vsp/dashboard_v3";

  function $(sel, root){ return (root||document).querySelector(sel); }
  function esc(s){ return String(s ?? "").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

  function findSettingsRoot(){
    return (
      $("#tab-settings") ||
      $("#vsp4-settings") ||
      $("[data-tab='settings']") ||
      $("#settings") ||
      document.body
    );
  }

  function ensureHost(root){
    let host = $("#vsp-settings-commercial-policy", root);
    if (!host){
      host = document.createElement("div");
      host.id = "vsp-settings-commercial-policy";
      host.className = "vsp-card";
      host.style.marginTop = "12px";

      // insert near top (after first card) if possible
      const firstCard = root.querySelector(".vsp-card");
      if (firstCard && firstCard.parentNode === root){
        if (firstCard.nextSibling) root.insertBefore(host, firstCard.nextSibling);
        else root.appendChild(host);
      } else {
        root.appendChild(host);
      }
    }
    return host;
  }

  async function safeJson(url){
    try{
      const r = await fetch(url, { credentials: "same-origin" });
      return await r.json();
    }catch(_e){
      return {};
    }
  }

  function pick(obj, keys){
    for (const k of keys){
      if (obj && Object.prototype.hasOwnProperty.call(obj, k)) return obj[k];
    }
    return undefined;
  }

  function render(host, ctx){
    const tools = [
      ["Bandit",   "SAST (Python)"],
      ["Semgrep",  "SAST (multi-lang)"],
      ["Gitleaks", "Secrets"],
      ["KICS",     "IaC"],
      ["Trivy",    "Vuln (FS)"],
      ["Syft",     "SBOM"],
      ["Grype",    "Vuln (SBOM)"],
      ["CodeQL",   "SAST (deep)"],
    ];

    const endpoints = [
      ["Runs index",    "/api/vsp/runs_index_v3_fs_resolved"],
      ["Run status",    "/api/vsp/run_status_v2/<rid>"],
      ["Artifacts",     "/api/vsp/artifacts_index_v1/<rid>"],
      ["Export",        "/api/vsp/run_export_v3/<rid>?fmt=html|zip|pdf"],
      ["Dashboard KPI", "/api/vsp/dashboard_v3"],
      ["Overrides",     "/api/vsp/rule_overrides_v1"],
    ];

    host.innerHTML = `
      <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap;">
        <div>
          <h3 style="margin:0 0 6px 0;">Commercial Operational Policy</h3>
          <div style="opacity:.8;">8 tools + timeout/degraded governance + exports/artifacts + ISO note (CIO readable).</div>
        </div>
        <span class="vsp-pill">P1 Commercial</span>
      </div>

      <hr style="opacity:.15; margin:12px 0;" />

      <h4 style="margin:0 0 8px 0;">8 Tools</h4>
      <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:10px;">
        ${tools.map(t => `
          <div class="vsp-card vsp-card--tight">
            <div style="font-weight:700;">${esc(t[0])}</div>
            <div style="opacity:.85;">${esc(t[1])}</div>
          </div>
        `).join("")}
      </div>

      <hr style="opacity:.15; margin:12px 0;" />

      <h4 style="margin:0 0 8px 0;">Timeout & Degraded Policy</h4>
      <ul style="margin:0; padding-left:18px; opacity:.92; line-height:1.5;">
        <li><b>Timeout/missing tool</b> ⇒ lane đánh dấu <b>DEGRADED</b> (pipeline không treo).</li>
        <li><b>Degraded</b> = tool không hoàn tất chuẩn nhưng vẫn có log/artifact + run kết thúc “FINAL”.</li>
        <li><b>KPI</b> phải phân biệt “effective vs degraded” (dashboard KPI bar đã patch).</li>
        <li><b>Gating</b> có thể soft-pass theo policy nhưng phải ghi rõ degraded reason trong run status/log.</li>
      </ul>

      <hr style="opacity:.15; margin:12px 0;" />

      <h4 style="margin:0 0 8px 0;">Current Modes / Flags</h4>
      <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:10px;">
        <div class="vsp-card vsp-card--tight">
          <div style="font-weight:700;">Runtime</div>
          <div style="opacity:.9; margin-top:6px;">
            <div>FS_FALLBACK: <b>${esc(ctx.flags.FS_FALLBACK)}</b></div>
            <div>EXPORT_FORCE_BIND: <b>${esc(ctx.flags.EXPORT_FORCE_BIND)}</b></div>
            <div>OVERRIDES_ENABLED: <b>${esc(ctx.flags.OVERRIDES_ENABLED)}</b></div>
          </div>
        </div>
        <div class="vsp-card vsp-card--tight">
          <div style="font-weight:700;">Tool Execution Mode</div>
          <div style="opacity:.9; margin-top:6px;">
            <div>KICS: <b>${esc(ctx.mode.kics)}</b></div>
            <div>CodeQL: <b>${esc(ctx.mode.codeql)}</b></div>
            <div>Trivy/Syft/Grype: <b>${esc(ctx.mode.sbom)}</b></div>
          </div>
        </div>
      </div>

      <hr style="opacity:.15; margin:12px 0;" />

      <h4 style="margin:0 0 8px 0;">Exports & Artifacts</h4>
      <div style="opacity:.92; line-height:1.5;">
        <div><b>Artifacts location</b>: theo <code>ci_run_dir</code> trong <code>run_status_v2</code>.</div>
        <div><b>Exports</b>: HTML/ZIP/PDF qua export endpoint (PDF có thể bật/tắt theo policy).</div>
      </div>

      <div style="margin-top:10px; overflow:auto;">
        <table class="vsp-table" style="width:100%;">
          <thead><tr><th style="width:180px;">Item</th><th>Endpoint</th></tr></thead>
          <tbody>
            ${endpoints.map(e => `<tr><td>${esc(e[0])}</td><td><code>${esc(e[1])}</code></td></tr>`).join("")}
          </tbody>
        </table>
      </div>

      <hr style="opacity:.15; margin:12px 0;" />

      <h4 style="margin:0 0 8px 0;">ISO 27001 Mapping Note</h4>
      <div style="opacity:.92; line-height:1.5;">
        ISO mapping nhằm <b>governance + traceability</b> (không phải chứng nhận). Report có thể render coverage matrix nếu backend có <code>iso_controls</code>.
      </div>
    `;
  }

  async function init(){
    const root = findSettingsRoot();
    const host = ensureHost(root);

    const settings = await safeJson(API_SETTINGS);
    const dash = await safeJson(API_DASH);

    const flags = {
      FS_FALLBACK:       String(pick(settings, ["fs_fallback","FS_FALLBACK"]) ?? pick(dash, ["fs_fallback","FS_FALLBACK"]) ?? "UNKNOWN"),
      EXPORT_FORCE_BIND: String(pick(settings, ["export_force_bind","EXPORT_FORCE_BIND"]) ?? "UNKNOWN"),
      OVERRIDES_ENABLED: String(pick(settings, ["overrides_enabled","OVERRIDES_ENABLED"]) ?? "UNKNOWN"),
    };
    const mode = {
      kics:   String(pick(settings, ["kics_mode","KICS_MODE"]) ?? "UNKNOWN"),
      codeql: String(pick(settings, ["codeql_mode","CODEQL_MODE"]) ?? "UNKNOWN"),
      sbom:   String(pick(settings, ["sbom_mode","SBOM_MODE"]) ?? "UNKNOWN"),
    };

    render(host, { flags, mode });
  }

  if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", init);
  else init();
})();
/* VSP_SETTINGS_COMMERCIAL_POLICY_V3_END */


})();
/* ==== END: static/js/vsp_settings_tab_v1.js ==== */

/* ==== BEGIN: static/js/vsp_settings_v1.js ==== */
(function(){
'use strict';
(function () {
  const LOG = "[VSP_SETTINGS]";
  const API_URL = "/api/vsp/settings_v1";

  function log(...args) {
    console.log(LOG, ...args);
  }

  function el(tag, className, text) {
    const e = document.createElement(tag);
    if (className) e.className = className;
    if (text != null) e.textContent = text;
    return e;
  }

  function renderForm(container, data) {
    container.innerHTML = "";

    const wrapper = el("div", "vsp-settings-wrapper");

    const title = el("h3", "vsp-settings-title", "VSP Settings");
    wrapper.appendChild(title);

    // Profile default
    const profileRow = el("div", "vsp-settings-row");
    profileRow.appendChild(el("label", "vsp-settings-label", "Default profile"));
    const profileSelect = el("select", "vsp-settings-input");
    profileSelect.id = "vsp-settings-profile-default";

    ["ANY", "FAST", "EXT", "FULL_EXT"].forEach(v => {
      const opt = el("option", null, v);
      opt.value = v;
      if (data.profile_default === v) opt.selected = true;
      profileSelect.appendChild(opt);
    });

    profileRow.appendChild(profileSelect);
    wrapper.appendChild(profileRow);

    // Severity gate
    const sevRow = el("div", "vsp-settings-row");
    sevRow.appendChild(el("label", "vsp-settings-label", "Severity gate"));
    const sevSelect = el("select", "vsp-settings-input");
    sevSelect.id = "vsp-settings-severity-gate";

    ["CRITICAL", "HIGH", "MEDIUM", "LOW", "INFO", "TRACE"].forEach(v => {
      const opt = el("option", null, v);
      opt.value = v;
      if (data.severity_gate === v) opt.selected = true;
      sevSelect.appendChild(opt);
    });

    sevRow.appendChild(sevSelect);
    wrapper.appendChild(sevRow);

    // Tools toggle
    const tools = data.tools || {};
    const toolsRow = el("div", "vsp-settings-row");
    toolsRow.appendChild(el("label", "vsp-settings-label", "Tools enabled"));

    const toolsBox = el("div", "vsp-settings-tools");
    const TOOL_LIST = [
      "semgrep",
      "gitleaks",
      "bandit",
      "trivy_fs",
      "grype",
      "syft",
      "kics",
      "codeql"
    ];

    TOOL_LIST.forEach(tool => {
      const item = el("label", "vsp-settings-tool-item");
      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.value = tool;
      cb.id = "vsp-settings-tool-" + tool;
      cb.checked = tools[tool] !== false; // default true
      item.appendChild(cb);
      item.appendChild(document.createTextNode(" " + tool));
      toolsBox.appendChild(item);
    });

    toolsRow.appendChild(toolsBox);
    wrapper.appendChild(toolsRow);

    const btnRow = el("div", "vsp-settings-row vsp-settings-actions");
    const saveBtn = el("button", "vsp-btn vsp-btn-primary", "Save settings");
    saveBtn.type = "button";
    saveBtn.addEventListener("click", saveSettings);
    btnRow.appendChild(saveBtn);

    const statusSpan = el("span", "vsp-settings-status");
    statusSpan.id = "vsp-settings-status";
    btnRow.appendChild(statusSpan);

    wrapper.appendChild(btnRow);

    container.appendChild(wrapper);
  }

  async function loadSettings() {
    const panel = document.getElementById("vsp-settings-panel");
    if (!panel) {
      log("Không tìm thấy #vsp-settings-panel, bỏ qua init.");
      return;
    }
    panel.innerHTML = "<p>Loading settings...</p>";

    try {
      const res = await fetch(API_URL, { method: "GET" });
      const data = await res.json();
      if (!data.ok) {
        panel.innerHTML = "<p>Cannot load settings: " + (data.error || "unknown error") + "</p>";
        return;
      }
      renderForm(panel, data.settings || {});
      log("Loaded settings:", data.settings);
    } catch (err) {
      console.error(LOG, "Error loadSettings", err);
      panel.innerHTML = "<p>Error loading settings.</p>";
    }
  }

  async function saveSettings() {
    const status = document.getElementById("vsp-settings-status");
    if (status) status.textContent = "Saving...";

    const profileSel = document.getElementById("vsp-settings-profile-default");
    const sevSel = document.getElementById("vsp-settings-severity-gate");

    const TOOL_LIST = [
      "semgrep",
      "gitleaks",
      "bandit",
      "trivy_fs",
      "grype",
      "syft",
      "kics",
      "codeql"
    ];

    const tools = {};
    TOOL_LIST.forEach(tool => {
      const cb = document.getElementById("vsp-settings-tool-" + tool);
      if (cb) tools[tool] = !!cb.checked;
    });

    const payload = {
      settings: {
        profile_default: profileSel ? profileSel.value : "FULL_EXT",
        severity_gate: sevSel ? sevSel.value : "MEDIUM",
        tools: tools
      }
    };

    try {
      const res = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      if (!data.ok) {
        if (status) status.textContent = "Save failed: " + (data.error || "error");
        return;
      }
      if (status) status.textContent = "Saved.";
      log("Saved settings:", payload.settings);
    } catch (err) {
      console.error(LOG, "Error saveSettings", err);
      if (status) status.textContent = "Save error.";
    }
  }

  window.vspSettingsInit = function () {
    log("Init...");
    loadSettings();
  };

  document.addEventListener("DOMContentLoaded", function () {
    if (document.getElementById("vsp-settings-panel")) {
      window.vspSettingsInit();
    }
  });
})();

})();
/* ==== END: static/js/vsp_settings_v1.js ==== */

/* ==== BEGIN: static/js/vsp_rule_overrides_tab_v1.js ==== */
(function(){
'use strict';
/* VSP_RULE_OVERRIDES_GUARD_V2_BEGIN */
(function(){
  'use strict';
  if (typeof window === 'undefined') return;

  window.__vspGetRidSafe = async function(){
    try{
      if (typeof window.VSP_RID_PICKLATEST_OVERRIDE_V1 === 'function'){
        const rid = await window.VSP_RID_PICKLATEST_OVERRIDE_V1();
        if (rid) return rid;
      }
    }catch(_e){}
    try{
      if (window.VSP_RID_STATE && typeof window.VSP_RID_STATE.pickLatest === 'function'){
        const rid = await window.VSP_RID_STATE.pickLatest();
        if (rid) return rid;
      }
    }catch(_e){}
    return null;
  };
})();
 /* VSP_RULE_OVERRIDES_GUARD_V2_END */

/* VSP_RULEOVERRIDES_GUARD_V1_BEGIN */
// commercial safety: don't crash if rid override hook not present
try {
  if (!window.VSP_RID_PICKLATEST_OVERRIDE_V1) {
    window.VSP_RID_PICKLATEST_OVERRIDE_V1 = function(items) {
      return (items && items[0]) ? items[0] : null;
    };
  }
} catch(e) {}
/* VSP_RULEOVERRIDES_GUARD_V1_END */
/* VSP_RULE_OVERRIDES_TAB_V1: clean + CRUD (GET/POST) */
(function(){

const API = "/api/vsp/rule_overrides_v1";
  const $ = (id)=>document.getElementById(id);

  function esc(s){
    return String(s==null?'':s)
      .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;").replace(/'/g,"&#39;");
  }
  function nowIsoDate(){
    const d=new Date(); const y=d.getFullYear();
    const m=String(d.getMonth()+1).padStart(2,'0');
    const day=String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${day}`;
  }
  function msg(t, kind){
    const el=$("rules-msg");
    if(!el) return;
    el.textContent = t || "";
    el.style.opacity = t ? "1" : "0.85";
    el.style.color = kind==="err" ? "rgba(248,113,113,0.95)" : "rgba(148,163,184,0.95)";
  }

  function normalizeFromApi(obj){
    // Accept: {version,items:[...]} OR {meta,overrides:[...]}
    if(!obj || typeof obj!=='object') return {version:1, items:[]};
    if(Array.isArray(obj.items)) return {version: obj.version||1, items: obj.items||[]};
    if(Array.isArray(obj.overrides)) return {version: 1, items: obj.overrides||[]};
    if(obj.meta && Array.isArray(obj.meta.overrides)) return {version: 1, items: obj.meta.overrides||[]};
    return {version: 1, items: []};
  }

  function toPostPayload(state){
    // Prefer commercial schema you already used:
    // {meta:{version:"v1"}, overrides:[{match:{...}, set:{...}, action, justification, expires_at, id}]}
    return { meta:{version:"v1"}, overrides: (state.items||[]).map(x=>x||{}) };
  }

  async function apiGet(){
    const r = await fetch(API, { cache:"no-store", credentials:"same-origin" });
    if(!r.ok) throw new Error("GET failed: "+r.status);
    return await r.json();
  }
  async function apiSave(payload){
    const r = await fetch(API, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(payload),
      credentials:"same-origin",
    });
    if(!r.ok){
      const t = await r.text().catch(()=> "");
      throw new Error("POST failed: "+r.status+" "+t.slice(0,200));
    }
    return await r.json();
  }

  function render(container, state){
    const items = Array.isArray(state.items) ? state.items : [];
    const html = `
      <div class="vsp-card" style="margin:12px 0; padding:14px;">
        <div style="display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;">
          <div>
            <div style="font-weight:800; font-size:16px;">Rule Overrides</div>
            <div style="opacity:.75; font-size:12px;">API: <code>${esc(API)}</code></div>
          </div>
          <div style="display:flex; gap:8px; align-items:center;">
            <button class="vsp-btn vsp-btn-soft" id="rules-reload">Reload</button>
            <button class="vsp-btn vsp-btn-soft" id="rules-add">Add</button>
            <button class="vsp-btn vsp-btn-primary" id="rules-save">Save</button>
          </div>
        </div>
        <div id="rules-msg" style="margin-top:10px; font-size:12px; opacity:.9;"></div>
      </div>

      <div class="vsp-card" style="padding:0; overflow:auto;">
        <table style="width:100%; border-collapse:collapse;">
          <thead>
            <tr style="text-align:left; font-size:12px; opacity:.85;">
              <th style="padding:10px 12px; border-bottom:1px solid rgba(255,255,255,.06);">ID</th>
              <th style="padding:10px 12px; border-bottom:1px solid rgba(255,255,255,.06);">Match (JSON)</th>
              <th style="padding:10px 12px; border-bottom:1px solid rgba(255,255,255,.06);">Action</th>
              <th style="padding:10px 12px; border-bottom:1px solid rgba(255,255,255,.06);">Set (JSON)</th>
              <th style="padding:10px 12px; border-bottom:1px solid rgba(255,255,255,.06);">Justification</th>
              <th style="padding:10px 12px; border-bottom:1px solid rgba(255,255,255,.06);">Expires</th>
              <th style="padding:10px 12px; border-bottom:1px solid rgba(255,255,255,.06);">Ops</th>
            </tr>
          </thead>
          <tbody id="rules-body"></tbody>
        </table>
      </div>

      <div class="vsp-card" style="margin:12px 0; padding:14px;">
        <div style="font-weight:700; margin-bottom:8px;">Raw JSON editor</div>
        <textarea id="rules-json" spellcheck="false"
          style="width:100%; min-height:240px; font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
          font-size:12px; padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,.08);
          background:rgba(255,255,255,.03); color:inherit;"></textarea>
        <div style="margin-top:8px; opacity:.75; font-size:12px;">
          Tip: bạn có thể sửa JSON trực tiếp rồi bấm <b>Save</b>.
        </div>
      </div>
    `;
    container.innerHTML = html;

    const tb = $("rules-body");
    const tx = $("rules-json");

    function rowToInputs(it, idx){
      const id = it.id || (`ovr_${idx+1}`);
      const match = it.match || {};
      const action = it.action || (it.set && Object.keys(it.set).length ? "set" : "suppress");
      const setObj = it.set || {};
      const justification = it.justification || "";
      const expires_at = it.expires_at || (new Date().getFullYear()+1)+"-12-31";

      return `
        <tr data-idx="${idx}" style="border-bottom:1px solid rgba(255,255,255,.06); font-size:13px;">
          <td style="padding:10px 12px; white-space:nowrap;">
            <input data-k="id" value="${esc(id)}"
              style="width:160px; padding:8px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.08);
              background:rgba(255,255,255,.03); color:inherit;">
          </td>
          <td style="padding:10px 12px; min-width:260px;">
            <textarea data-k="match" spellcheck="false"
              style="width:360px; min-height:64px; padding:8px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.08);
              background:rgba(255,255,255,.03); color:inherit; font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; font-size:12px;">${esc(JSON.stringify(match, null, 2))}</textarea>
          </td>
          <td style="padding:10px 12px; white-space:nowrap;">
            <select data-k="action" style="padding:8px 10px; border-radius:10px;">
              ${["suppress","set"].map(x=>`<option value="${x}" ${x===action?"selected":""}>${x}</option>`).join("")}
            </select>
          </td>
          <td style="padding:10px 12px; min-width:260px;">
            <textarea data-k="set" spellcheck="false"
              style="width:260px; min-height:64px; padding:8px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.08);
              background:rgba(255,255,255,.03); color:inherit; font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; font-size:12px;">${esc(JSON.stringify(setObj, null, 2))}</textarea>
          </td>
          <td style="padding:10px 12px;">
            <input data-k="justification" value="${esc(justification)}"
              style="width:260px; padding:8px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.08);
              background:rgba(255,255,255,.03); color:inherit;">
          </td>
          <td style="padding:10px 12px; white-space:nowrap;">
            <input data-k="expires_at" value="${esc(expires_at)}" placeholder="${nowIsoDate()}"
              style="width:140px; padding:8px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.08);
              background:rgba(255,255,255,.03); color:inherit;">
          </td>
          <td style="padding:10px 12px; white-space:nowrap;">
            <button class="vsp-btn vsp-btn-soft" data-act="del">Delete</button>
          </td>
        </tr>
      `;
    }

    function syncTextAreaFromState(){
      if(!tx) return;
      tx.value = JSON.stringify(toPostPayload(state), null, 2);
    }

    function syncStateFromTable(){
      const rows = Array.from(tb.querySelectorAll("tr"));
      const out = [];
      for(const r of rows){
        const get = (k)=>r.querySelector(`[data-k="${k}"]`);
        const it = {};
        it.id = (get("id")?.value || "").trim() || undefined;
        it.action = (get("action")?.value || "").trim() || "suppress";
        it.justification = (get("justification")?.value || "").trim() || "";
        it.expires_at = (get("expires_at")?.value || "").trim() || "";

        // JSON fields
        try { it.match = JSON.parse(get("match")?.value || "{}"); }
        catch(e){ throw new Error("Bad JSON in match for row id="+(it.id||"(no id)")); }
        try { it.set = JSON.parse(get("set")?.value || "{}"); }
        catch(e){ throw new Error("Bad JSON in set for row id="+(it.id||"(no id)")); }

        // normalize: if action=suppress => set can be empty
        if(it.action === "suppress") {
          if(!it.match || typeof it.match!=="object") it.match = {};
          // keep set but it's ok if empty
        }
        out.push(it);
      }
      state.items = out;
      syncTextAreaFromState();
    }

    function syncTableFromState(){
      tb.innerHTML = items.map((it, idx)=>rowToInputs(it, idx)).join("");
      syncTextAreaFromState();
    }

    syncTableFromState();
    msg("Loaded "+items.length+" overrides.", "ok");

    // events
    $("rules-add")?.addEventListener("click", ()=>{
      state.items = state.items || [];
      state.items.push({
        id: "ovr_" + (state.items.length+1),
        match: { tool: "KICS" },
        action: "set",
        set: { severity: "LOW" },
        justification: "False positive / accepted risk",
        expires_at: (new Date().getFullYear()+1) + "-12-31"
      });
      syncTableFromState();
      msg("Added draft override. Edit then Save.", "ok");
    });

    $("rules-reload")?.addEventListener("click", async ()=>{
      msg("Reloading…", "ok");
      try{
        const j = normalizeFromApi(await apiGet());
        state.items = j.items || [];
        syncTableFromState();
        msg("Reloaded "+state.items.length+" overrides.", "ok");
      }catch(e){
        msg(String(e), "err");
      }
    });

    $("rules-save")?.addEventListener("click", async ()=>{
      try{
        // If user edited raw JSON, prefer that
        if(tx && tx.value && tx.value.trim().startsWith("{")){
          let raw;
          try { raw = JSON.parse(tx.value); }
          catch(e){ throw new Error("Raw JSON invalid: "+e); }
          // accept either {meta,overrides} or {version,items}
          let st = normalizeFromApi(raw);
          if(raw && raw.meta && Array.isArray(raw.overrides)) st = {version:1, items: raw.overrides};
          state.items = st.items || [];
          // re-render table from state to keep consistent
          syncTableFromState();
        } else {
          syncStateFromTable();
        }

        const payload = toPostPayload(state);
        msg("Saving…", "ok");
        const res = await apiSave(payload);
        msg("Saved OK. File: " + (res.file||"(unknown)"), "ok");
      }catch(e){
        msg(String(e && e.message ? e.message : e), "err");
      }
    });

    tb.addEventListener("click", (ev)=>{
      const t = ev.target;
      if(!(t instanceof Element)) return;
      const btn = t.closest ? t.closest('[data-act="del"]') : null;
      if(!btn) return;
      const tr = btn.closest("tr");
      if(!tr) return;
      tr.remove();
      try{
        syncStateFromTable();
        msg("Deleted row (not saved yet). Click Save.", "ok");
      }catch(e){
        msg(String(e), "err");
      }
    });
  }

  async function init(){
    const root = $("vsp-rules-main") || $("panel-rules") || document.querySelector('[data-panel="rules"]');
    if(!root){ console.warn("[VSP_RULES] rules pane not found"); return; }

    // Avoid double init
    if(root.getAttribute("data-vsp-rules-inited")==="1") return;
    root.setAttribute("data-vsp-rules-inited","1");

    root.innerHTML = '<div class="vsp-card" style="margin:12px 0; padding:14px;">Loading rule overrides…</div>';

    let state = { version: 1, items: [] };
    try{
      const j = normalizeFromApi(await apiGet());
      state.items = j.items || [];
      render(root, state);
    }catch(e){
      root.innerHTML = '<div class="vsp-card" style="margin:12px 0; padding:14px;">' +
        '<div style="font-weight:800;">Rule Overrides load failed</div>' +
        '<pre style="white-space:pre-wrap; opacity:.85; font-size:12px;">'+esc(String(e && e.stack ? e.stack : e))+'</pre>' +
        '</div>';
    }
  }

  // Public hook for router
  window.VSP_RULES_TAB_INIT = init;

  // Init only when hash is #rules
  function maybe(){
    const h = (location.hash||"").toLowerCase();
    if(h.includes("rules")) init();
  }
  window.addEventListener("hashchange", maybe);
  document.addEventListener("DOMContentLoaded", maybe);

  console.log("[VSP_RULE_OVERRIDES_TAB_V1] loaded");
})();

})();
/* ==== END: static/js/vsp_rule_overrides_tab_v1.js ==== */

/* ==== BEGIN: static/js/vsp_rule_overrides_v1.js ==== */
(function(){
'use strict';
(function () {
  const LOG = "[VSP_RULE_OVERRIDES]";
  const API_URL = "/api/vsp/rule_overrides_v1";

  function log(...args) {
    console.log(LOG, ...args);
  }

  function el(tag, className, text) {
    const e = document.createElement(tag);
    if (className) e.className = className;
    if (text != null) e.textContent = text;
    return e;
  }

  function asStringTags(tags) {
    if (Array.isArray(tags)) return tags.join(",");
    if (typeof tags === "string") return tags;
    return "";
  }

  function renderTable(container, items) {
    container.innerHTML = "";

    const wrapper = el("div", "vsp-rules-wrapper");

    const title = el("h3", "vsp-rules-title", "Rule overrides");
    wrapper.appendChild(title);

    const desc = el(
      "p",
      "vsp-rules-desc",
      "Override severity / behavior cho từng rule của từng tool."
    );
    wrapper.appendChild(desc);

    const table = el("table", "vsp-table vsp-rules-table");
    const thead = document.createElement("thead");
    const headRow = document.createElement("tr");
    [
      "Tool",
      "Rule ID",
      "Rule name",
      "Severity raw",
      "Severity effective",
      "Tags",
      "Reason",
      ""
    ].forEach(h => {
      const th = el("th", null, h);
      headRow.appendChild(th);
    });
    thead.appendChild(headRow);
    table.appendChild(thead);

    const tbody = document.createElement("tbody");
    tbody.id = "vsp-rules-tbody";

    (items || []).forEach(item => {
      tbody.appendChild(makeRow(item));
    });

    table.appendChild(tbody);
    wrapper.appendChild(table);

    const actions = el("div", "vsp-rules-actions");

    const addBtn = el("button", "vsp-btn vsp-btn-secondary", "Add row");
    addBtn.type = "button";
    addBtn.addEventListener("click", () => {
      const row = makeRow({
        tool: "",
        rule_id: "",
        rule_name: "",
        severity_raw: "",
        severity_effective: "",
        tags: "",
        reason: ""
      });
      tbody.appendChild(row);
    });
    actions.appendChild(addBtn);

    const saveBtn = el("button", "vsp-btn vsp-btn-primary", "Save overrides");
    saveBtn.type = "button";
    saveBtn.addEventListener("click", saveOverrides);
    actions.appendChild(saveBtn);

    const status = el("span", "vsp-rules-status");
    status.id = "vsp-rules-status";
    actions.appendChild(status);

    wrapper.appendChild(actions);

    container.appendChild(wrapper);
  }

  function makeRow(item) {
    const tr = document.createElement("tr");

    function cellInput(field, value, placeholder) {
      const td = document.createElement("td");
      const input = document.createElement("input");
      input.type = "text";
      input.className = "vsp-input vsp-input-xs";
      input.dataset.field = field;
      input.value = value || "";
      if (placeholder) input.placeholder = placeholder;
      td.appendChild(input);
      return td;
    }

    tr.appendChild(cellInput("tool", item.tool, "semgrep"));
    tr.appendChild(cellInput("rule_id", item.rule_id, "rule id"));
    tr.appendChild(cellInput("rule_name", item.rule_name, "short name"));
    tr.appendChild(cellInput("severity_raw", item.severity_raw, "HIGH"));
    tr.appendChild(
      cellInput("severity_effective", item.severity_effective, "CRITICAL / MEDIUM / ...")
    );
    tr.appendChild(cellInput("tags", asStringTags(item.tags), "cwe:79,owasp:a1"));
    tr.appendChild(cellInput("reason", item.reason, "why override"));

    const tdDel = document.createElement("td");
    const delBtn = el("button", "vsp-btn vsp-btn-xs vsp-btn-danger", "×");
    delBtn.type = "button";
    delBtn.addEventListener("click", () => {
      tr.remove();
    });
    tdDel.appendChild(delBtn);
    tr.appendChild(tdDel);

    return tr;
  }

  async function loadOverrides() {
    const panel = document.getElementById("vsp-rule-overrides-panel");
    if (!panel) {
      log("Không tìm thấy #vsp-rule-overrides-panel, bỏ qua init.");
      return;
    }
    panel.innerHTML = "<p>Loading rule overrides...</p>";

    try {
      const res = await fetch(API_URL, { method: "GET" });
      const data = await res.json();
      if (!data.ok) {
        panel.innerHTML = "<p>Cannot load overrides: " + (data.error || "unknown error") + "</p>";
        return;
      }
      renderTable(panel, data.items || []);
      log("Loaded rule overrides:", data.items);
    } catch (err) {
      console.error(LOG, "Error loadOverrides", err);
      panel.innerHTML = "<p>Error loading rule overrides.</p>";
    }
  }

  async function saveOverrides() {
    const status = document.getElementById("vsp-rules-status");
    if (status) status.textContent = "Saving...";

    const tbody = document.getElementById("vsp-rules-tbody");
    if (!tbody) {
      if (status) status.textContent = "No table body.";
      return;
    }

    const items = [];
    const rows = Array.from(tbody.querySelectorAll("tr"));
    rows.forEach(tr => {
      const obj = {};
      const inputs = tr.querySelectorAll("input[data-field]");
      inputs.forEach(input => {
        const field = input.dataset.field;
        let val = input.value.trim();
        if (field === "tags") {
          // tags lưu dạng string, backend / tool khác có thể parse tiếp
          obj[field] = val;
        } else {
          obj[field] = val;
        }
      });

      // bỏ qua row trống
      const nonEmpty = Object.values(obj).some(v => v && v.length > 0);
      if (nonEmpty) items.append
    });

    // Array.push bị gõ nhầm, sửa:
    const fixedItems = [];
    rows.forEach(tr => {
      const obj = {};
      const inputs = tr.querySelectorAll("input[data-field]");
      inputs.forEach(input => {
        const field = input.dataset.field;
        let val = input.value.trim();
        if (field === "tags") {
          obj[field] = val;
        } else {
          obj[field] = val;
        }
      });
      const nonEmpty = Object.values(obj).some(v => v && v.length > 0);
      if (nonEmpty) fixedItems.push(obj);
    });

    const payload = { items: fixedItems };

    try {
      const res = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      if (!data.ok) {
        if (status) status.textContent = "Save failed: " + (data.error || "error");
        return;
      }
      if (status) status.textContent = "Saved.";
      log("Saved rule overrides:", payload.items.length);
    } catch (err) {
      console.error(LOG, "Error saveOverrides", err);
      if (status) status.textContent = "Save error.";
    }
  }

  window.vspRuleOverridesInit = function () {
    log("Init...");
    loadOverrides();
  };

  document.addEventListener("DOMContentLoaded", function () {
    if (document.getElementById("vsp-rule-overrides-panel")) {
      window.vspRuleOverridesInit();
    }
  });
})();

})();
/* ==== END: static/js/vsp_rule_overrides_v1.js ==== */

/* ==== BEGIN: static/js/vsp_datasource.js ==== */
(function(){
'use strict';
(function () {
  function $(id) { return document.getElementById(id); }

  function renderTotal(summary) {
    var el = $("ds-total");
    if (!el || !summary) return;
    el.textContent = summary.total || 0;
  }

  function renderSeverityChart(counts) {
    var canvas = $("ds-severity-chart");
    if (!canvas || !window.Chart || !counts) return;
    var ctx = canvas.getContext("2d");
    if (!ctx) return;

    var labels = Object.keys(counts);
    var values = labels.map(function (k) { return counts[k]; });

    new Chart(ctx, {
      type: "doughnut",
      data: { labels: labels, datasets: [{ data: values }] },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: "bottom" },
          title: { display: true, text: "Severity distribution (current run)" }
        }
      }
    });
  }

  function renderToolsChart(counts) {
    var canvas = $("ds-tools-chart");
    if (!canvas || !window.Chart || !counts) return;
    var ctx = canvas.getContext("2d");
    if (!ctx) return;

    var pairs = Object.keys(counts).map(function (k) {
      return { tool: k, value: counts[k] };
    }).sort(function (a, b) { return b.value - a.value; });

    var labels = pairs.map(function (p) { return p.tool; });
    var values = pairs.map(function (p) { return p.value; });

    new Chart(ctx, {
      type: "bar",
      data: { labels: labels, datasets: [{ data: values }] },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        indexAxis: "y",
        plugins: {
          legend: { display: false },
          title: { display: true, text: "Findings by tool" }
        },
        scales: { x: { beginAtZero: true } }
      }
    });
  }

  function renderTable(rows) {
    var tbody = $("ds-table-body");
    if (!tbody) return;
    tbody.innerHTML = "";

    if (!Array.isArray(rows) || rows.length === 0) {
      var tr = document.createElement("tr");
      var td = document.createElement("td");
      td.colSpan = 7;
      td.textContent = "No findings.";
      tr.appendChild(td);
      tbody.appendChild(tr);
      return;
    }

    var limited = rows.slice(0, 200);
    limited.forEach(function (row, idx) {
      var tr = document.createElement("tr");
      function td(text) {
        var c = document.createElement("td");
        c.textContent = text == null ? "" : String(text);
        return c;
      }
      tr.appendChild(td(idx + 1));
      tr.appendChild(td(row.severity || row.SEVERITY || ""));
      tr.appendChild(td(row.tool || row.TOOL || ""));
      tr.appendChild(td(row.rule || row.RULE_ID || row.rule_id || ""));
      var fileText = (row.file || row.FILE || "") + (row.line || row.LINE ? (":" + (row.line || row.LINE)) : "");
      tr.appendChild(td(fileText));
      tr.appendChild(td(row.cwe || row.CWE || ""));
      tr.appendChild(td(row.message || row.MESSAGE || ""));
      tbody.appendChild(tr);
    });
  }

  function normalizeRows(data) {
    // Nếu BE trả sẵn rows thì dùng luôn
    if (Array.isArray(data.rows) && data.rows.length > 0) return data.rows;
    // Nếu không, nhưng có findings dạng list thì map sang rows
    if (Array.isArray(data.findings)) {
      return data.findings.map(function (item) {
        return {
          severity: (item.severity || "").toUpperCase(),
          tool: (item.tool || "").toLowerCase(),
          rule: item.rule_id || item.rule || "",
          file: item.file || "",
          line: item.line || 0,
          cwe: item.cwe || item.cve || "",
          message: item.message || item.description || ""
        };
      });
    }
    return [];
  }

  function loadDataSource() {
    fetch("/api/vsp/datasource")
      .then(function (resp) { return resp.json(); })
      .then(function (data) {
        if (!data) {
          console.warn("[VSP][DATASOURCE] empty response");
          return;
        }
        // Không còn if (!data.ok) return nữa, BE có thể không gửi field ok
        var summary = data.summary || {
          total: data.total || 0,
          severity_counts: data.severity_counts || {},
          tool_counts: data.tool_counts || {}
        };

        console.info("[VSP][DATASOURCE] run:", data.run_id, "total:", summary.total);

        renderTotal(summary);
        renderSeverityChart(summary.severity_counts);
        renderToolsChart(summary.tool_counts);

        var rows = normalizeRows(data);
        renderTable(rows);
      })
      .catch(function (err) {
        console.error("[VSP][DATASOURCE] fetch error:", err);
      });
  }

  document.addEventListener("DOMContentLoaded", function () {
    loadDataSource();
  });
})();

})();
/* ==== END: static/js/vsp_datasource.js ==== */

/* ==== BEGIN: static/js/vsp_datasource_charts_v1.js ==== */
(function(){
'use strict';
// VSP_DS_MINI_ANALYTICS_LIST_V1
// Data Source – mini charts (V1):
//  - Không dùng Chart.js.
//  - Hiển thị 2 card list:
//      + Top tools theo số lượng findings
//      + Top directories theo số lượng findings

(function() {
  const LOG = "[VSP_DS_MINI_LIST]";

  async function loadData() {
    const res = await fetch("/api/vsp/datasource_v2?limit=1000");
    const data = await res.json();
    console.log(LOG, "Loaded datasource_v2", data);
    return data.items || [];
  }

  function aggregate(items) {
    const severityOrder = ["CRITICAL","HIGH","MEDIUM","LOW","INFO","TRACE"];
    const byTool = {};
    const byDir  = {};

    for (const f of items) {
      const tool = (f.tool || "unknown").toString();
      let sev = (f.severity || "INFO").toString().toUpperCase();
      if (!severityOrder.includes(sev)) sev = "INFO";

      if (!byTool[tool]) {
        byTool[tool] = { total: 0 };
        severityOrder.forEach(s => (byTool[tool][s] = 0));
      }
      byTool[tool][sev] = (byTool[tool][sev] || 0) + 1;
      byTool[tool].total += 1;

      const path =
        f.path ||
        f.file ||
        f.filepath ||
        (f.location && (f.location.path || f.location.file)) ||
        f.relpath ||
        "";
      if (path) {
        const parts = String(path).split("/");
        const dir = parts.slice(0, 3).join("/") + (parts.length > 3 ? "/..." : "");
        byDir[dir] = (byDir[dir] || 0) + 1;
      }
    }

    const toolsSorted = Object.entries(byTool)
      .sort((a,b) => b[1].total - a[1].total)
      .slice(0, 8);
    const dirsSorted = Object.entries(byDir)
      .sort((a,b) => b[1] - a[1])
      .slice(0, 8);

    console.log(LOG, "Agg result", { byTool, toolsSorted, dirsSorted });
    return { byTool, toolsSorted, dirsSorted };
  }

  function ensureSection() {
    const tab = document.querySelector("#vsp-tab-datasource");
    if (!tab) return null;

    let section = document.getElementById("vsp-ds-mini-section");
    if (!section) {
      section = document.createElement("section");
      section.id = "vsp-ds-mini-section";
      section.style.marginTop = "24px";
      section.style.marginBottom = "24px";

      section.innerHTML = `
        <div style="margin-bottom: 12px;">
          <div style="font-size: 14px; font-weight: 600; letter-spacing: .08em; text-transform: uppercase; color: #e5e7eb;">
            Data Source – mini analytics
          </div>
          <div style="font-size: 12px; color: #9ca3af;">
            Top tools & top directories suy ra từ <code>findings_unified</code> đang load. 
            Chế độ list cho V1 (biểu đồ sẽ bật trong bản Enterprise+).
          </div>
        </div>
        <div style="display: grid; grid-template-columns: repeat(2,minmax(0,1fr)); gap: 16px; max-width: 100%;">
          <div id="vsp-ds-card-tools"
               style="border-radius: 16px; border: 1px solid rgba(148,163,184,0.25);
                      padding: 12px 14px 10px; background: radial-gradient(circle at top left, rgba(15,23,42,0.95), rgba(15,23,42,0.9));">
            <div style="font-size: 13px; font-weight: 600; letter-spacing: .08em; text-transform: uppercase; color: #e5e7eb;">
              Severity by tool
            </div>
            <div style="font-size: 11px; color: #9ca3af; margin-bottom: 6px;">
              Top tools theo số lượng findings (CRIT/HIGH/MED/LOW/INFO/TRACE).
            </div>
            <div id="vsp-ds-tools-list"></div>
          </div>
          <div id="vsp-ds-card-dirs"
               style="border-radius: 16px; border: 1px solid rgba(148,163,184,0.25);
                      padding: 12px 14px 10px; background: radial-gradient(circle at top left, rgba(15,23,42,0.95), rgba(15,23,42,0.9));">
            <div style="font-size: 13px; font-weight: 600; letter-spacing: .08em; text-transform: uppercase; color: #e5e7eb;">
              Top directories
            </div>
            <div style="font-size: 11px; color: #9ca3af; margin-bottom: 6px;">
              Thư mục có nhiều findings nhất (từ <code>path</code>).
            </div>
            <div id="vsp-ds-dirs-list"></div>
          </div>
        </div>
      `;
      tab.appendChild(section);
      console.log(LOG, "Đã tạo section mini analytics trong Data Source.");
    }
    return section;
  }

  function renderToolsList(container, agg) {
    if (!container) return;
    container.innerHTML = "";
    const { toolsSorted, byTool } = agg;
    if (!toolsSorted.length) {
      container.innerHTML =
        '<div style="font-size: 11px; color: #9ca3af;">Không có findings nào để tổng hợp theo tool.</div>';
      return;
    }
    toolsSorted.forEach(([tool, obj], idx) => {
      const row = document.createElement("div");
      row.style.display = "flex";
      row.style.alignItems = "center";
      row.style.justifyContent = "space-between";
      row.style.fontSize = "11px";
      row.style.color = "#e5e7eb";
      row.style.padding = "3px 0";

      const sevText =
        `C:${byTool[tool].CRITICAL||0} · ` +
        `H:${byTool[tool].HIGH||0} · ` +
        `M:${byTool[tool].MEDIUM||0} · ` +
        `L:${byTool[tool].LOW||0}`;

      row.innerHTML =
        `<span style="opacity:.6; min-width:18px;">${idx + 1}.</span>` +
        `<span style="flex:1; margin-right:8px;">${tool}</span>` +
        `<span style="opacity:.75; margin-right:8px;">${sevText}</span>` +
        `<span style="font-variant-numeric: tabular-nums;">${obj.total}</span>`;
      container.appendChild(row);
    });
  }

  function renderDirsList(container, agg) {
    if (!container) return;
    container.innerHTML = "";
    const { dirsSorted } = agg;
    if (!dirsSorted.length) {
      container.innerHTML =
        '<div style="font-size: 11px; color: #9ca3af;">Không có findings nào để tổng hợp theo thư mục.</div>';
      return;
    }
    dirsSorted.forEach(([dir, count], idx) => {
      const row = document.createElement("div");
      row.style.display = "flex";
      row.style.alignItems = "center";
      row.style.justifyContent = "space-between";
      row.style.fontSize = "11px";
      row.style.color = "#e5e7eb";
      row.style.padding = "3px 0";

      row.innerHTML =
        `<span style="opacity:.6; min-width:18px;">${idx + 1}.</span>` +
        `<span style="flex:1; margin-right:8px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${dir}</span>` +
        `<span style="font-variant-numeric: tabular-nums;">${count}</span>`;
      container.appendChild(row);
    });
  }

  async function init() {
    const section = ensureSection();
    if (!section) {
      console.warn(LOG, "Không tìm thấy tab Data Source.");
      return;
    }

    let items;
    try {
      items = await loadData();
    } catch (e) {
      console.warn(LOG, "Lỗi load datasource_v2:", e);
      return;
    }

    if (!items.length) {
      console.log(LOG, "Không có findings để hiển thị mini analytics.");
      return;
    }

    const agg = aggregate(items);

    renderToolsList(
      document.getElementById("vsp-ds-tools-list"),
      agg
    );
    renderDirsList(
      document.getElementById("vsp-ds-dirs-list"),
      agg
    );
  }

  function start() {
    let tries = 0;
    const maxTries = 30;
    const timer = setInterval(() => {
      const tab = document.querySelector("#vsp-tab-datasource");
      if (tab) {
        clearInterval(timer);
        init();
      } else if (++tries >= maxTries) {
        clearInterval(timer);
        console.warn(LOG, "Give up sau", tries, "lần – không thấy tab Data Source.");
      }
    }, 400);
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", start);
  } else {
    start();
  }
})();

})();
/* ==== END: static/js/vsp_datasource_charts_v1.js ==== */

/* ==== BEGIN: static/js/vsp_datasource_export_v1.js ==== */
(function(){
'use strict';
;(function () {
  const LOG_PREFIX = "[VSP_DS_EXPORT]";

  function $(id) {
    return document.getElementById(id);
  }

  function createButton(text, id) {
    const btn = document.createElement("button");
    btn.id = id;
    btn.type = "button";
    btn.className = "vsp-btn vsp-btn-pill";
    btn.textContent = text;
    return btn;
  }

  function injectButtons() {
    // Tìm toolbar Data Source nếu có
    let toolbar = $("vsp-ds-toolbar");
    const pane = document.getElementById("vsp-tab-datasource");

    if (!toolbar && pane) {
      // Nếu template chưa có toolbar riêng, tạo 1 div nhỏ ở đầu tab Data Source
      toolbar = document.createElement("div");
      toolbar.id = "vsp-ds-toolbar";
      toolbar.className = "vsp-ds-toolbar vsp-flex vsp-justify-between vsp-items-center vsp-mb-3";

      // Đưa toolbar lên đầu tab Data Source
      if (pane.firstChild) {
        pane.insertBefore(toolbar, pane.firstChild);
      } else {
        pane.appendChild(toolbar);
      }
    }

    if (!toolbar) {
      console.log(LOG_PREFIX, "Không thấy Data Source toolbar / pane – skip inject.");
      return;
    }

    // Tránh chèn trùng
    if (document.getElementById("vsp-ds-export-json")) {
      console.log(LOG_PREFIX, "Export buttons đã tồn tại – bỏ qua.");
      return;
    }

    const rightBox = document.createElement("div");
    rightBox.className = "vsp-ds-export-group";

    const btnJson = createButton("Export JSON", "vsp-ds-export-json");
    const btnCsv = createButton("Export CSV", "vsp-ds-export-csv");

    rightBox.appendChild(btnJson);
    rightBox.appendChild(btnCsv);
    toolbar.appendChild(rightBox);

    // Bind click
    btnJson.addEventListener("click", function () {
      const url = "/api/vsp/datasource_export_v1?fmt=json";
      console.log(LOG_PREFIX, "Export JSON:", url);
      window.open(url, "_blank");
    });

    btnCsv.addEventListener("click", function () {
      const url = "/api/vsp/datasource_export_v1?fmt=csv";
      console.log(LOG_PREFIX, "Export CSV:", url);
      window.open(url, "_blank");
    });

    console.log(LOG_PREFIX, "Injected Export JSON/CSV buttons.");
  }

  function init() {
    const pane = document.getElementById("vsp-tab-datasource");
    if (!pane) {
      console.log(LOG_PREFIX, "Không trong layout có Data Source tab – skip.");
      return;
    }
    injectButtons();
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", init);
  } else {
    init();
  }

  console.log(LOG_PREFIX, "vsp_datasource_export_v1.js loaded.");
})();

})();
/* ==== END: static/js/vsp_datasource_export_v1.js ==== */

/* ==== BEGIN: static/js/vsp_datasource_ext_columns_v1.js ==== */
(function(){
'use strict';
(function () {
  const BASE_URL = '/api/vsp/datasource_v2';
  const INIT_DELAY_MS = 1200;

  function fmtInt(n) {
    if (n == null || isNaN(n)) return '-';
    return Number(n).toLocaleString('en-US');
  }

  function esc(s) {
    if (s == null) return '';
    return String(s)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;');
  }

  function getSeverity(f) {
    return (f.severity || f.raw_severity || '').toUpperCase() || 'INFO';
  }

  function buildRow(f) {
    const sev = getSeverity(f);
    const tool = f.tool || f.source || '-';
    const cwe = f.cwe || f.cwe_id || f.rule_id || '-';
    const modulePath = f.module || f.file || f.path || f.location || '-';
    const message = f.message || f.title || f.short_message || '-';
    const runId = f.run_id || '-';

    return `
      <tr>
        <td><span class="vsp-badge vsp-badge-sev vsp-sev-${sev.toLowerCase()}">${sev}</span></td>
        <td>${esc(tool)}</td>
        <td>${esc(cwe)}</td>
        <td class="vsp-mono">${esc(modulePath)}</td>
        <td>${esc(message)}</td>
        <td class="vsp-mono">${esc(runId)}</td>
      </tr>
    `;
  }

  function renderSkeleton(tab) {
    tab.innerHTML = `
      <div class="vsp-tab-inner vsp-tab-datasource">
        <div class="vsp-tab-header">
          <h2>Data Source</h2>
          <p class="vsp-tab-subtitle">
            Nguồn dữ liệu chi tiết của tất cả findings sau khi unify. Có thể lọc theo severity, tool, CWE.
          </p>
        </div>

        <div class="vsp-filter-row">
          <select id="vsp-ds-filter-sev" class="vsp-input">
            <option value="">Severity: All</option>
            <option value="CRITICAL">Critical</option>
            <option value="HIGH">High</option>
            <option value="MEDIUM">Medium</option>
            <option value="LOW">Low</option>
            <option value="INFO">Info</option>
            <option value="TRACE">Trace</option>
          </select>

          <input id="vsp-ds-filter-tool" class="vsp-input" placeholder="Tool (semgrep, kics,…)" />

          <input id="vsp-ds-filter-cwe" class="vsp-input" placeholder="CWE / Rule ID" />

          <input id="vsp-ds-filter-text" class="vsp-input vsp-flex" placeholder="Search message / path…" />

          <button id="vsp-ds-refresh" class="vsp-btn vsp-btn-secondary">Reload</button>
          <button id="vsp-ds-export-json" class="vsp-btn vsp-btn-ghost">Export JSON</button>
        </div>

        <div class="vsp-card vsp-table-card">
          <div class="vsp-table-header">
            <div>
              <h3>Findings table</h3>
              <p class="vsp-table-subtitle">
                Tối đa 200 bản ghi mới nhất theo filter. Dùng để drill-down nhanh trước khi mở báo cáo chi tiết.
              </p>
            </div>
            <div class="vsp-table-kpi">
              <span id="vsp-ds-kpi-total">0</span> records
            </div>
          </div>

          <div class="vsp-table-wrapper">
            <table class="vsp-table" id="vsp-ds-table">
              <thead>
                <tr>
                  <th>Severity</th>
                  <th>Tool</th>
                  <th>CWE / Rule</th>
                  <th>Module / Path</th>
                  <th>Message</th>
                  <th>Run</th>
                </tr>
              </thead>
              <tbody>
                <tr><td colspan="6" class="vsp-table-loading">Đang tải dữ liệu findings…</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    `;
  }

  async function bindDatasource(tab) {
    renderSkeleton(tab);

    const selSev = tab.querySelector('#vsp-ds-filter-sev');
    const inpTool = tab.querySelector('#vsp-ds-filter-tool');
    const inpCwe = tab.querySelector('#vsp-ds-filter-cwe');
    const inpText = tab.querySelector('#vsp-ds-filter-text');
    const btnReload = tab.querySelector('#vsp-ds-refresh');
    const btnExportJson = tab.querySelector('#vsp-ds-export-json');
    const tbody = tab.querySelector('#vsp-ds-table tbody');
    const kpiTotal = tab.querySelector('#vsp-ds-kpi-total');

    async function fetchAndRender() {
      if (!tbody) return;
      tbody.innerHTML = `<tr><td colspan="6" class="vsp-table-loading">Đang tải dữ liệu findings…</td></tr>`;

      const params = new URLSearchParams();
      params.set('limit', '200');
      if (selSev && selSev.value) params.set('severity', selSev.value);
      if (inpTool && inpTool.value.trim()) params.set('tool', inpTool.value.trim());
      if (inpCwe && inpCwe.value.trim()) params.set('cwe', inpCwe.value.trim());
      if (inpText && inpText.value.trim()) params.set('q', inpText.value.trim());

      let data;
      try {
        const res = await fetch(`${BASE_URL}?${params.toString()}`, { cache: 'no-store' });
        data = await res.json();
      } catch (e) {
        console.error('[VSP_DS_TAB] Failed to load datasource_v2', e);
        tbody.innerHTML = `<tr><td colspan="6" class="vsp-table-error">
          Không tải được dữ liệu Data Source từ API.
        </td></tr>`;
        if (kpiTotal) kpiTotal.textContent = '0';
        return;
      }

      const items = Array.isArray(data.items) ? data.items : Array.isArray(data) ? data : [];
      if (kpiTotal) kpiTotal.textContent = fmtInt(items.length);

      if (!items.length) {
        tbody.innerHTML = `<tr><td colspan="6" class="vsp-table-empty">
          Không có bản ghi nào phù hợp với filter hiện tại.
        </td></tr>`;
        return;
      }

      tbody.innerHTML = items.map(buildRow).join('');
      console.log('[VSP_DS_TAB] Rendered Data Source with', items.length, 'items');
    }

    if (btnReload) {
      btnReload.addEventListener('click', () => {
        fetchAndRender();
      });
    }

    if (btnExportJson) {
      btnExportJson.addEventListener('click', () => {
        const params = new URLSearchParams();
        params.set('limit', '2000');
        if (selSev && selSev.value) params.set('severity', selSev.value);
        if (inpTool && inpTool.value.trim()) params.set('tool', inpTool.value.trim());
        if (inpCwe && inpCwe.value.trim()) params.set('cwe', inpCwe.value.trim());
        if (inpText && inpText.value.trim()) params.set('q', inpText.value.trim());

        const url = `${BASE_URL}?${params.toString()}`;
        window.open(url, '_blank');
      });
    }

    [inpTool, inpCwe, inpText].forEach(inp => {
      if (!inp) return;
      inp.addEventListener('keydown', e => {
        if (e.key === 'Enter') {
          e.preventDefault();
          fetchAndRender();
        }
      });
    });

    fetchAndRender();
  }

  let initialized = false;

  function tryInit() {
    if (initialized) return;
    const tab = document.querySelector('#vsp-tab-datasource');
    if (!tab) {
      setTimeout(tryInit, 500);
      return;
    }
    initialized = true;
    setTimeout(() => bindDatasource(tab), INIT_DELAY_MS);
  }

  tryInit();
})();

})();
/* ==== END: static/js/vsp_datasource_ext_columns_v1.js ==== */

/* ==== BEGIN: static/js/vsp_datasource_filters_advanced_v1.js ==== */
(function(){
'use strict';
(function () {
  console.log("[VSP_DS_FILTER] vsp_datasource_filters_advanced_v1.js loaded");

  function findDatasourcePane() {
    var pane =
      document.getElementById("vsp-tab-datasource-main") ||
      document.querySelector("[data-vsp-pane='datasource']") ||
      document.querySelector("#vsp-tab-datasource") ||
      document.querySelector(".vsp-pane-datasource");

    if (pane) return pane;

    // fallback theo text "DATA SOURCE" + "/api/vsp/datasource_v2"
    var all = Array.from(document.querySelectorAll("section,div,main"));
    var marker = all.find(function (el) {
      var t = (el.textContent || "").toUpperCase();
      return t.includes("DATA SOURCE") && t.includes("/API/VSP/DATASOURCE_V2");
    });
    if (marker) {
      return marker.closest(".vsp-pane") || marker.closest("section") || marker.closest("div");
    }
    return null;
  }

  function applyFilters() {
    var pane = findDatasourcePane();
    if (!pane) return;

    var tbody = pane.querySelector("tbody");
    if (!tbody) return;

    var rows = Array.from(tbody.querySelectorAll("tr"));
    if (!rows.length) return;

    var sev = (document.getElementById("vsp-ds-filter-sev") || {}).value || "";
    var tool = (document.getElementById("vsp-ds-filter-tool") || {}).value || "";
    var q = (document.getElementById("vsp-ds-filter-q") || {}).value || "";

    sev = sev.toUpperCase();
    tool = tool.toLowerCase();
    q = q.toLowerCase();

    rows.forEach(function (tr) {
      var tds = tr.querySelectorAll("td");
      if (!tds.length) return;

      var sevCell = (tds[1] && tds[1].textContent) || "";  // Sev
      var toolCell = (tds[2] && tds[2].textContent) || ""; // Tool
      var rowText = tr.textContent || "";

      var visible = true;

      if (sev && sevCell.toUpperCase() !== sev) visible = false;

      if (tool && toolCell.toLowerCase() !== tool) visible = false;

      if (q && rowText.toLowerCase().indexOf(q) === -1) visible = false;

      tr.style.display = visible ? "" : "none";
    });
  }

  function collectToolsOptions(pane) {
    var tbody = pane.querySelector("tbody");
    if (!tbody) return [];
    var tools = new Set();
    Array.from(tbody.querySelectorAll("tr")).forEach(function (tr) {
      var tds = tr.querySelectorAll("td");
      if (tds[2]) {
        var t = (tds[2].textContent || "").trim();
        if (t) tools.add(t);
      }
    });
    return Array.from(tools).sort();
  }

  function initFilters() {
    var pane = findDatasourcePane();
    if (!pane) {
      console.warn("[VSP_DS_FILTER] Không tìm thấy pane Data Source.");
      return;
    }

    if (pane.querySelector("#vsp-ds-filter-bar")) return;

    var wrapper = document.createElement("div");
    wrapper.id = "vsp-ds-filter-bar";
    wrapper.className = "vsp-card";
    wrapper.style.margin = "16px 0";

    var tools = collectToolsOptions(pane);
    var toolsOptions = ['<option value="">Any</option>'].concat(
      tools.map(function (t) {
        return '<option value="' + t + '">' + t + "</option>";
      })
    ).join("");

    wrapper.innerHTML = `
      <div class="vsp-card-title">Filters</div>
      <div class="vsp-grid vsp-grid-3" style="gap:12px; margin-top:8px;">
        <div>
          <label>Severity</label>
          <select id="vsp-ds-filter-sev" style="width:100%;">
            <option value="">Any</option>
            <option value="CRITICAL">CRITICAL</option>
            <option value="HIGH">HIGH</option>
            <option value="MEDIUM">MEDIUM</option>
            <option value="LOW">LOW</option>
            <option value="INFO">INFO</option>
            <option value="TRACE">TRACE</option>
          </select>
        </div>
        <div>
          <label>Tool</label>
          <select id="vsp-ds-filter-tool" style="width:100%;">
            ${toolsOptions}
          </select>
        </div>
        <div>
          <label>Search (rule / path / CWE)</label>
          <input id="vsp-ds-filter-q" type="text" placeholder="text contains…" style="width:100%;">
        </div>
      </div>
    `;

    var header = pane.querySelector("h2, h3, .vsp-section-title");
    if (header && header.parentNode) {
      header.parentNode.insertBefore(wrapper, header.nextSibling);
    } else {
      pane.insertBefore(wrapper, pane.firstChild);
    }

    ["vsp-ds-filter-sev", "vsp-ds-filter-tool", "vsp-ds-filter-q"].forEach(function (id) {
      var el = document.getElementById(id);
      if (!el) return;
      el.addEventListener("input", applyFilters);
      el.addEventListener("change", applyFilters);
    });
  }

  document.addEventListener("DOMContentLoaded", function () {
    if (location.hash === "#datasource") {
      setTimeout(function () {
        initFilters();
        applyFilters();
      }, 400);
    }
  });

  window.addEventListener("hashchange", function () {
    if (location.hash === "#datasource") {
      setTimeout(function () {
        initFilters();
        applyFilters();
      }, 400);
    }
  });
})();

})();
/* ==== END: static/js/vsp_datasource_filters_advanced_v1.js ==== */

/* ==== BEGIN: static/js/vsp_datasource_filters_v2.js ==== */
(function(){
'use strict';
// VSP_DATASOURCE_REAL_V3 – bind Data Source tab với /api/vsp/dashboard_v3 + /api/vsp/datasource_v2
(function() {
  const LOG_PREFIX = "[VSP_DATA_TAB]";

  function log() {
    if (window.console && console.log) {
      console.log.apply(console, [LOG_PREFIX].concat(Array.from(arguments)));
    }
  }

  async function getLatestRunId() {
    try {
      const resp = await fetch('/api/vsp/dashboard_v3');
      if (!resp.ok) {
        log('dashboard_v3 HTTP error', resp.status);
        return null;
      }
      const data = await resp.json();
      log('/api/vsp/dashboard_v3 =>', data);
      return data.run_id || null;
    } catch (e) {
      log('getLatestRunId error', e);
      return null;
    }
  }

  async function fetchDatasourceItems(runId, limit) {
    const runDir = '/home/test/Data/SECURITY_BUNDLE/out/' + runId;
    const qs = new URLSearchParams({
      run_dir: runDir,
      limit: String(limit || 500)
    });

    const url = '/api/vsp/datasource_v2?' + qs.toString();
    log('Fetch datasource_v2 với', url);

    const resp = await fetch(url);
    if (!resp.ok) {
      log('datasource_v2 HTTP error', resp.status);
      throw new Error('HTTP ' + resp.status);
    }
    const data = await resp.json();
    log('datasource_v2 payload', data);

    if (Array.isArray(data.items)) {
      return data.items;
    }
    if (Array.isArray(data.data)) {
      return data.data;
    }
    return [];
  }

  function getDatasourceTbody() {
    const tab = document.getElementById('tab-data');
    if (!tab) return null;
    const table = tab.querySelector('table.vsp-table');
    if (!table) return null;
    return table.querySelector('tbody');
  }

  function renderDatasourceTable(items) {
    const tbody = getDatasourceTbody();
    if (!tbody) {
      log('Không tìm thấy tbody trong TAB Data Source');
      return;
    }

    tbody.innerHTML = '';

    if (!items.length) {
      const tr = document.createElement('tr');
      const td = document.createElement('td');
      td.colSpan = 11;
      td.textContent = 'Không có findings cho run hiện tại.';
      tr.appendChild(td);
      tbody.appendChild(tr);
      return;
    }

    items.forEach(function(it) {
      const tr = document.createElement('tr');

      function td(text) {
        const el = document.createElement('td');
        el.textContent = (text === null || text === undefined) ? '' : String(text);
        return el;
      }

      const sev    = it.severity_norm || it.severity || '';
      const tool   = it.tool || '';
      const file   = it.file || it.path || '';
      const line   = it.line || '';
      const rule   = it.rule_id || it.rule || '';
      const msg    = it.message || '';
      const cwe    = it.cwe || '';
      const cve    = Array.isArray(it.cves) ? it.cves.join(',') : (it.cve || '');
      const module = it.module || '';
      const fix    = it.fix || it.recommendation || '';
      const tags   = Array.isArray(it.tags) ? it.tags.join(',') : (it.tags || '');

      tr.appendChild(td(sev));
      tr.appendChild(td(tool));
      tr.appendChild(td(file));
      tr.appendChild(td(line));
      tr.appendChild(td(rule));
      tr.appendChild(td(msg));
      tr.appendChild(td(cwe));
      tr.appendChild(td(cve));
      tr.appendChild(td(module));
      tr.appendChild(td(fix));
      tr.appendChild(td(tags));

      tbody.appendChild(tr);
    });
  }

  async function loadDataTabOnce() {
    try {
      log('Bắt đầu load Data Source tab...');
      const runId = await getLatestRunId();
      if (!runId) {
        log('Không lấy được run_id từ dashboard_v3, bỏ qua.');
        return;
      }
      log('Dùng run_id =', runId);

      const items = await fetchDatasourceItems(runId, 500);
      log('Nhận được', items.length, 'items từ datasource_v2');
      renderDatasourceTable(items);
    } catch (e) {
      log('Lỗi loadDataTabOnce', e);
    }
  }

  function bindTabHook() {
    const btn = document.querySelector('.vsp-tab-btn[data-tab="tab-data"]');
    if (!btn) {
      log('Không tìm thấy tab button cho TAB Data Source');
      return;
    }

    let loaded = false;
    btn.addEventListener('click', function() {
      if (loaded) return;
      loaded = true;
      log('switch to tab-data → trigger loadDataTabOnce');
      loadDataTabOnce();
    });
  }

  document.addEventListener('DOMContentLoaded', bindTabHook);
})();

})();
/* ==== END: static/js/vsp_datasource_filters_v2.js ==== */

/* ==== BEGIN: static/js/vsp_datasource_live_v3.js ==== */
(function(){
'use strict';
/**
 * VSP 2025 – Data Source Live (v3 – simple)
 * Không phụ thuộc tab id. Chỉ cần có table #tblTopRisk là sẽ tự fetch
 * /api/vsp/datasource_v2 và render 1 lần sau khi page load.
 */

(function () {
  const API_URL = "/api/vsp/datasource_v2";

  function log(...args) {
    console.log("[VSP][DATASOURCE_V3]", ...args);
  }

  function mapSeverityClass(sev) {
    const s = (sev || "").toUpperCase();
    switch (s) {
      case "CRITICAL": return "critical";
      case "HIGH":     return "high";
      case "MEDIUM":   return "medium";
      case "LOW":      return "low";
      case "INFO":     return "info";
      case "TRACE":    return "trace";
      default:         return "info";
    }
  }

  function shortenPath(path) {
    if (!path) return "–";
    const s = String(path);
    if (s.length <= 70) return s;
    return "…" + s.slice(-70);
  }

  function safe(obj, path, fallback = null) {
    try {
      return path.split(".").reduce(
        (acc, key) => (acc && acc[key] != null ? acc[key] : null),
        obj
      ) ?? fallback;
    } catch {
      return fallback;
    }
  }

  async function fetchDataSource(params) {
    const url = new URL(API_URL, window.location.origin);
    url.searchParams.set("limit", params?.limit || "200");
    if (params?.severity) url.searchParams.set("severity", params.severity);
    if (params?.tool)     url.searchParams.set("tool", params.tool);
    if (params?.text)     url.searchParams.set("text", params.text);

    log("Fetch", url.toString());
    const res = await fetch(url.toString(), { method: "GET" });
    if (!res.ok) throw new Error("HTTP " + res.status);
    return res.json();
  }

  function renderTable(items) {
    const table = document.getElementById("tblTopRisk");
    if (!table) {
      log("Không tìm thấy #tblTopRisk, bỏ qua render.");
      return;
    }
    const tbody = table.querySelector("tbody") || table.createTBody();

    if (!Array.isArray(items) || items.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="11" style="text-align:center; font-size:11px; color:#9ca3af;">
            Không có findings (hoặc filter đang loại hết kết quả).
          </td>
        </tr>`;
      return;
    }

    const rows = items.map((it) => {
      const sevEff = it.severity_effective || it.severity || it.severity_raw || "INFO";
      const sevRaw = it.severity_raw || sevEff;
      const sevClass = mapSeverityClass(sevEff);

      const tool = it.tool || "–";
      const file = shortenPath(it.file);
      const line = it.line != null ? it.line : "–";

      const extra = it.extra || {};
      const ruleId =
        extra.rule_id ||
        extra.RuleID ||
        extra.rule ||
        extra.ruleID ||
        extra.check_id ||
        extra.id ||
        "–";

      const message = it.message || it.title || "–";
      const cwe = it.cwe || safe(extra, "cwe_id", "–");
      const cve = safe(it, "vuln.cve_id", safe(extra, "cve_id", "–"));
      const moduleName = it.module || safe(extra, "module", "–");
      const fixShort = safe(it, "fix_guide.short_title") || "–";

      const tags = [];
      if (it.overridden) {
        tags.push(`Overridden (${it.override_rule_id || "rule"})`);
      }
      if (safe(it, "vuln.cvss_score") != null) {
        tags.push(`CVSS ${safe(it, "vuln.cvss_score")}`);
      }
      if (safe(it, "asset.package_name")) {
        tags.push("Pkg");
      }

      const sevBadge = `
        <span class="badge-sev ${sevClass}">
          ${sevEff}
        </span>
        ${
          sevEff !== sevRaw
            ? `<span style="display:inline-block; margin-left:4px; font-size:9px; color:#9ca3af;">
                 raw: ${sevRaw}
               </span>`
            : ""
        }
      `;

      const tagsHtml = tags.length
        ? tags
            .map(
              (t) =>
                `<span class="tag-soft" style="padding:2px 6px; font-size:9px;">${t}</span>`
            )
            .join(" ")
        : "–";

      return `
        <tr>
          <td>${sevBadge}</td>
          <td>${tool}</td>
          <td title="${it.file || ""}">${file}</td>
          <td>${line}</td>
          <td>${ruleId}</td>
          <td title="${message}">${message}</td>
          <td>${cwe}</td>
          <td>${cve}</td>
          <td>${moduleName}</td>
          <td>${fixShort}</td>
          <td>${tagsHtml}</td>
        </tr>
      `;
    });

    tbody.innerHTML = rows.join("");
  }

  async function initOnce() {
    const table = document.getElementById("tblTopRisk");
    if (!table) {
      log("Chưa thấy #tblTopRisk (có thể layout chưa render tab Data Source).");
      return;
    }

    const tbody = table.querySelector("tbody") || table.createTBody();
    tbody.innerHTML = `
      <tr>
        <td colspan="11" style="text-align:center; font-size:11px; color:#9ca3af;">
          Đang tải dữ liệu unified findings từ VSP backend...
        </td>
      </tr>`;

    try {
      const json = await fetchDataSource({ limit: 200 });
      log("API datasource_v2:", json);
      const items = Array.isArray(json.items) ? json.items : [];
      renderTable(items);
    } catch (e) {
      console.error("[VSP][DATASOURCE_V3] Error:", e);
      tbody.innerHTML = `
        <tr>
          <td colspan="11" style="text-align:center; font-size:11px; color:#f97373;">
            Lỗi tải Data Source: ${(e && e.message) || e}. Kiểm tra /api/vsp/datasource_v2.
          </td>
        </tr>`;
    }
  }

  function start() {
    // Đợi một chút cho layout render xong (table xuất hiện)
    setTimeout(initOnce, 1000);
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", start);
  } else {
    start();
  }
})();

})();
/* ==== END: static/js/vsp_datasource_live_v3.js ==== */

/* ==== BEGIN: static/js/vsp_datasource_mini_charts_v1.js ==== */
(function(){
'use strict';
(function () {
  console.log('[VSP_DS_MINI_CHARTS_V1] loaded');

  if (typeof Chart === 'undefined') {
    console.warn('[VSP_DS_MINI_CHARTS_V1] Chart.js not available, skip mini charts.');
    return;
  }

  var charts = {};

  function ensureStyle() {
    if (document.getElementById('vsp-ds-mini-style')) return;
    var s = document.createElement('style');
    s.id = 'vsp-ds-mini-style';
    s.textContent = `
      #vsp-ds-mini-charts {
        margin-top: 1.5rem;
        display: grid;
        grid-template-columns: minmax(0, 280px) minmax(0, 1fr);
        gap: 1.5rem;
      }
      #vsp-ds-mini-charts-card {
        grid-column: span 2 / span 2;
      }
      .vsp-ds-mini-card {
        background: rgba(15,23,42,0.9);
        border-radius: 0.75rem;
        border: 1px solid rgba(148,163,184,0.25);
        padding: 0.75rem 1rem;
      }
      .vsp-ds-mini-title {
        font-size: 0.8rem;
        letter-spacing: 0.14em;
        text-transform: uppercase;
        color: #9ca3af;
        margin-bottom: 0.4rem;
      }
      .vsp-ds-mini-chart {
        width: 100%;
        height: 220px;
      }
    `;
    document.head.appendChild(s);
  }

  function aggregate(items) {
    var sev = { CRITICAL: 0, HIGH: 0, MEDIUM: 0, LOW: 0, INFO: 0, TRACE: 0 };
    var byTool = {};

    items.forEach(function (it) {
      var s = (it.severity || it.level || '').toUpperCase();
      if (!sev.hasOwnProperty(s)) {
        if (s === 'WARN' || s === 'WARNING') s = 'LOW';
        else if (s === 'ERROR') s = 'HIGH';
      }
      if (sev.hasOwnProperty(s)) sev[s]++;

      var tool = it.tool || it.source || 'N/A';
      byTool[tool] = (byTool[tool] || 0) + 1;
    });

    return { sev: sev, byTool: byTool };
  }

  function buildSevDonut(ctx, sevAgg) {
    if (charts.severity) { charts.severity.destroy(); }

    var keys = ['CRITICAL', 'HIGH', 'MEDIUM', 'LOW', 'INFO', 'TRACE'];
    var data = keys.map(function (k) { return sevAgg[k] || 0; });

    charts.severity = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: ['Critical', 'High', 'Medium', 'Low', 'Info', 'Trace'],
        datasets: [{
          data: data,
          backgroundColor: [
            '#f97373',
            '#fb923c',
            '#facc15',
            '#22c55e',
            '#38bdf8',
            '#a855f7'
          ],
          borderWidth: 0
        }]
      },
      options: {
        responsive: true,
        cutout: '60%',
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              color: '#e5e7eb',
              usePointStyle: true,
              boxWidth: 10
            }
          }
        }
      }
    });
  }

  function buildByTool(ctx, byToolMap) {
    if (charts.byTool) { charts.byTool.destroy(); }

    var entries = Object.keys(byToolMap).map(function (k) {
      return { tool: k, count: byToolMap[k] };
    }).sort(function (a, b) {
      return b.count - a.count;
    }).slice(0, 8);

    if (!entries.length) return;

    var labels = entries.map(function (x) { return x.tool; });
    var data = entries.map(function (x) { return x.count; });

    charts.byTool = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Findings',
          data: data,
          backgroundColor: '#38bdf8'
        }]
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        plugins: {
          legend: { display: false }
        },
        scales: {
          x: {
            grid: { color: 'rgba(148,163,184,0.18)' },
            ticks: { color: '#9ca3af' }
          },
          y: {
            grid: { display: false },
            ticks: { color: '#e5e7eb' }
          }
        }
      }
    });
  }

  function hydrateDs() {
    var pane = document.getElementById('vsp-datasource-main');
    if (!pane) {
      console.warn('[VSP_DS_MINI_CHARTS_V1] Không thấy #vsp-datasource-main');
      return;
    }

    fetch('/api/vsp/datasource_v2?limit=500')
      .then(function (r) { return r.json(); })
      .then(function (data) {
        var items = Array.isArray(data.items) ? data.items : data.data || [];
        if (!Array.isArray(items)) items = [];

        ensureStyle();

        var existing = document.getElementById('vsp-ds-mini-charts');
        if (existing) existing.remove();

        var wrap = document.createElement('div');
        wrap.id = 'vsp-ds-mini-charts';

        wrap.innerHTML =
          '<div class="vsp-ds-mini-card">' +
            '<div class="vsp-ds-mini-title">Severity breakdown</div>' +
            '<canvas id="vsp-ds-mini-sev" class="vsp-ds-mini-chart"></canvas>' +
          '</div>' +
          '<div class="vsp-ds-mini-card">' +
            '<div class="vsp-ds-mini-title">Findings by tool</div>' +
            '<canvas id="vsp-ds-mini-tool" class="vsp-ds-mini-chart"></canvas>' +
          '</div>';

        // chèn sau bảng data source (hoặc cuối pane)
        var table = pane.querySelector('table');
        if (table && table.parentNode) {
          table.parentNode.parentNode.insertBefore(wrap, table.parentNode.nextSibling);
        } else {
          pane.appendChild(wrap);
        }

        var agg = aggregate(items);
        var ctxSev = document.getElementById('vsp-ds-mini-sev').getContext('2d');
        var ctxTool = document.getElementById('vsp-ds-mini-tool').getContext('2d');

        buildSevDonut(ctxSev, agg.sev);
        buildByTool(ctxTool, agg.byTool);

        console.log('[VSP_DS_MINI_CHARTS_V1] hydrated mini charts');
      })
      .catch(function (err) {
        console.error('[VSP_DS_MINI_CHARTS_V1] error', err);
      });
  }

  function onReady(fn) {
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', fn);
    } else {
      fn();
    }
  }

  onReady(function () {
    // đợi pane + table simple V1 dựng xong rồi mới vẽ
    setTimeout(hydrateDs, 1000);
  });
})();

})();
/* ==== END: static/js/vsp_datasource_mini_charts_v1.js ==== */

/* ==== BEGIN: static/js/vsp_datasource_tab_simple_v1.js ==== */
(function(){
'use strict';
(function () {
  console.log("[VSP_DS] vsp_datasource_tab_simple_v1.js loaded");

  const tbody = document.getElementById("vsp-ds-tbody");
  const inputSeverity = document.getElementById("vsp-ds-severity");
  const inputTool = document.getElementById("vsp-ds-tool");
  const inputCwe = document.getElementById("vsp-ds-cwe");
  const inputPath = document.getElementById("vsp-ds-path");
  const btnApply = document.getElementById("vsp-ds-apply");
  const btnReset = document.getElementById("vsp-ds-reset");

  let allFindings = [];

  async function loadData() {
    try {
      const resp = await fetch("/api/vsp/datasource_v2?limit=500");
      const data = await resp.json();
      if (!resp.ok || !data.items) {
        console.error("[VSP_DS] load error", data);
        return;
      }
      allFindings = data.items;
      render(allFindings);
    } catch (err) {
      console.error("[VSP_DS] loadData error", err);
    }
  }

  function render(items) {
    if (!tbody) return;
    tbody.innerHTML = "";
    items.forEach(f => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${f.run_id || ""}</td>
        <td>${f.tool || ""}</td>
        <td>${f.severity || ""}</td>
        <td>${f.cwe_id || ""}</td>
        <td>${f.file_path || ""}</td>
        <td>${f.rule_id || ""}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function applyFilter() {
    const sev = (inputSeverity && inputSeverity.value || "").trim().toUpperCase();
    const tool = (inputTool && inputTool.value || "").trim().toLowerCase();
    const cwe = (inputCwe && inputCwe.value || "").trim().toUpperCase();
    const path = (inputPath && inputPath.value || "").trim().toLowerCase();

    const filtered = allFindings.filter(f => {
      if (sev && (f.severity || "").toUpperCase() !== sev) return false;
      if (tool && !(f.tool || "").toLowerCase().includes(tool)) return false;
      if (cwe && !(f.cwe_id || "").toUpperCase().includes(cwe)) return false;
      if (path && !(f.file_path || "").toLowerCase().includes(path)) return false;
      return true;
    });

    render(filtered);
  }

  function resetFilter() {
    if (inputSeverity) inputSeverity.value = "";
    if (inputTool) inputTool.value = "";
    if (inputCwe) inputCwe.value = "";
    if (inputPath) inputPath.value = "";
    render(allFindings);
  }

  if (btnApply) btnApply.addEventListener("click", applyFilter);
  if (btnReset) btnReset.addEventListener("click", resetFilter);

  document.addEventListener("DOMContentLoaded", loadData);
})();


// === VSP_DS_DRILLDOWN_SINK_V1 ===
(function(){
  const KEY = "vsp_ds_drill_url_v1";

  function hostEl(){
    return (
      document.querySelector("#tab-datasource") ||
      document.querySelector("#tab_datasource") ||
      document.querySelector("#datasource") ||
      document.querySelector("[data-tab='datasource']") ||
      document.body
    );
  }

  function ensurePre(){
    let pre = document.getElementById("vsp_ds_pre_v1");
    if(!pre){
      pre = document.createElement("pre");
      pre.id = "vsp_ds_pre_v1";
      pre.style.whiteSpace = "pre-wrap";
      pre.style.wordBreak = "break-word";
      pre.style.fontSize = "12px";
      pre.style.lineHeight = "1.35";
      pre.style.marginTop = "12px";
      pre.style.padding = "10px";
      pre.style.borderRadius = "12px";
      pre.style.border = "1px solid rgba(255,255,255,.10)";
      pre.style.background = "rgba(0,0,0,.25)";
      hostEl().appendChild(pre);
    }
    return pre;
  }

  async function refreshFromUrl(url){
    if(!url) return;
    const pre = ensurePre();
    pre.textContent = "Loading drilldown…\n" + url;

    try{
      const r = await fetch(url, {credentials:"same-origin"});
      const ct = (r.headers.get("content-type")||"").toLowerCase();
      if(!ct.includes("application/json")){
        const tx = await r.text();
        pre.textContent = "Non-JSON response\n\n" + tx.slice(0, 4000);
        return;
      }
      const j = await r.json();
      pre.textContent = JSON.stringify(j, null, 2);
    }catch(e){
      pre.textContent = "ERR: " + String(e);
    }
  }

  // called by dashboard click
  window.VSP_DS_APPLY_DRILL_URL_V1 = function(url){
    try{ sessionStorage.setItem(KEY, url); }catch(e){}
    refreshFromUrl(url);
  };

  // auto-apply when entering datasource tab (or on load)
  window.addEventListener("load", ()=>{
    let url = null;
    try{ url = sessionStorage.getItem(KEY); }catch(e){}
    if(url){
      setTimeout(()=>refreshFromUrl(url), 400);
    }
  });
})();


})();
/* ==== END: static/js/vsp_datasource_tab_simple_v1.js ==== */

/* ==== BEGIN: static/js/vsp_datasource_tab_simple_v2.js ==== */
(function(){
'use strict';
(function () {
  var API_URL = "/api/vsp/datasource_v2?limit=500";
  var ALL_ITEMS = [];
  var hydrated = false;

  function severityClass(sev) {
    if (!sev) return "vsp-badge vsp-badge-sev-info";
    var s = String(sev).toUpperCase();
    if (s === "CRITICAL") return "vsp-badge vsp-badge-sev-critical";
    if (s === "HIGH") return "vsp-badge vsp-badge-sev-high";
    if (s === "MEDIUM") return "vsp-badge vsp-badge-sev-medium";
    if (s === "LOW") return "vsp-badge vsp-badge-sev-low";
    if (s === "INFO") return "vsp-badge vsp-badge-sev-info";
    if (s === "TRACE") return "vsp-badge vsp-badge-sev-trace";
    return "vsp-badge vsp-badge-sev-info";
  }

  function severityLabel(sev) {
    return sev || "INFO";
  }

  function applyFilters() {
    var tbody = document.getElementById("vsp-ds-tbody");
    if (!tbody) return;

    if (!ALL_ITEMS || !ALL_ITEMS.length) {
      tbody.innerHTML = '<tr><td colspan="6" class="vsp-table-empty">Không có findings nào trong datasource_v2.</td></tr>';
      return;
    }

    var sevSel = document.getElementById("vsp-ds-filter-severity");
    var toolSel = document.getElementById("vsp-ds-filter-tool");
    var searchInp = document.getElementById("vsp-ds-filter-search");

    var sevVal = sevSel ? sevSel.value : "ALL";
    var toolVal = toolSel ? toolSel.value : "ALL";
    var q = searchInp ? (searchInp.value || "").toLowerCase() : "";

    var filtered = [];
    for (var i = 0; i < ALL_ITEMS.length; i++) {
      var it = ALL_ITEMS[i] || {};
      var sev = (it.severity || "").toString().toUpperCase();
      var tool = (it.tool || "").toString();
      var rule = (it.rule || "").toString();
      var file = (it.file || it.path || "").toString();

      if (sevVal !== "ALL" && sev !== sevVal) continue;
      if (toolVal !== "ALL" && tool !== toolVal) continue;

      if (q) {
        var hay = (rule + " " + file).toLowerCase();
        if (hay.indexOf(q) === -1) continue;
      }

      filtered.push(it);
    }

    if (!filtered.length) {
      tbody.innerHTML = '<tr><td colspan="6" class="vsp-table-empty">Không có findings nào khớp bộ lọc.</td></tr>';
      return;
    }

    var html = "";
    for (var j = 0; j < filtered.length; j++) {
      var f = filtered[j] || {};
      var idx = j + 1;
      var sev2 = f.severity || "";
      var tool2 = f.tool || "";
      var rule2 = f.rule || "";
      var file2 = f.file || f.path || "";
      var line2 = f.line != null ? f.line : "";

      html += '<tr>' +
        '<td>' + idx + '</td>' +
        '<td><span class="' + severityClass(sev2) + '">' + severityLabel(sev2) + '</span></td>' +
        '<td>' + tool2 + '</td>' +
        '<td title="' + rule2 + '">' + rule2 + '</td>' +
        '<td class="vsp-col-filename" title="' + file2 + '">' + file2 + '</td>' +
        '<td>' + line2 + '</td>' +
      '</tr>';
    }

    tbody.innerHTML = html;
  }

  function initFilters(items) {
    var toolSel = document.getElementById("vsp-ds-filter-tool");
    if (!toolSel) return;

    var toolsMap = {};
    for (var i = 0; i < items.length; i++) {
      var t = (items[i] && items[i].tool) || "";
      if (!t) continue;
      toolsMap[t] = true;
    }

    var tools = Object.keys(toolsMap).sort();
    var html = '<option value="ALL">Tất cả tool</option>';
    for (var j = 0; j < tools.length; j++) {
      html += '<option value="' + tools[j] + '">' + tools[j] + '</option>';
    }
    toolSel.innerHTML = html;
  }

  function loadDatasource() {
    var tbody = document.getElementById("vsp-ds-tbody");
    if (tbody) {
      tbody.innerHTML = '<tr><td colspan="6" class="vsp-table-empty">Đang tải unified findings...</td></tr>';
    }

    fetch(API_URL, { cache: "no-store" })
      .then(function (res) { return res.json(); })
      .then(function (data) {
        console.log("[VSP_DS_TAB_V2] datasource_v2 loaded.", data);
        var items = (data && data.items) || (data && data.data) || [];
        ALL_ITEMS = items || [];
        initFilters(ALL_ITEMS);
        applyFilters();
      })
      .catch(function (err) {
        console.error("[VSP_DS_TAB_V2] Failed to load datasource_v2:", err);
        if (tbody) {
          tbody.innerHTML = '<tr><td colspan="6" class="vsp-table-empty">Lỗi tải datasource_v2.</td></tr>';
        }
      });
  }

  function hydratePane() {
    if (hydrated) return;
    var pane = document.getElementById("vsp-tab-datasource");
    if (!pane) return;

    hydrated = true;

    pane.innerHTML =
      '<div class="vsp-section-header">' +
        '<div>' +
          '<h2 class="vsp-section-title">Data Source</h2>' +
          '<p class="vsp-section-subtitle">Bảng unified findings (tối đa 500 dòng, từ datasource_v2)</p>' +
        '</div>' +
        '<div class="vsp-section-actions">' +
          '<button class="vsp-btn" id="vsp-ds-refresh-btn">Refresh</button>' +
        '</div>' +
      '</div>' +
      '<div class="vsp-card">' +
        '<div class="vsp-ds-filters">' +
          '<div>' +
            '<label for="vsp-ds-filter-severity">Severity</label>' +
            '<select id="vsp-ds-filter-severity" class="vsp-select">' +
              '<option value="ALL">Tất cả mức</option>' +
              '<option value="CRITICAL">CRITICAL</option>' +
              '<option value="HIGH">HIGH</option>' +
              '<option value="MEDIUM">MEDIUM</option>' +
              '<option value="LOW">LOW</option>' +
              '<option value="INFO">INFO</option>' +
              '<option value="TRACE">TRACE</option>' +
            '</select>' +
          '</div>' +
          '<div>' +
            '<label for="vsp-ds-filter-tool">Tool</label>' +
            '<select id="vsp-ds-filter-tool" class="vsp-select">' +
              '<option value="ALL">Đang tải...</option>' +
            '</select>' +
          '</div>' +
          '<div style="flex:1; min-width:200px;">' +
            '<label for="vsp-ds-filter-search">Search</label>' +
            '<input id="vsp-ds-filter-search" class="vsp-input" type="text" placeholder="Tìm theo rule hoặc file...">' +
          '</div>' +
        '</div>' +
        '<div class="vsp-card-table" style="margin-bottom:0;">' +
          '<div class="vsp-table-wrapper">' +
            '<table class="vsp-table vsp-table-datasource">' +
              '<thead>' +
                '<tr>' +
                  '<th style="width:5%;">#</th>' +
                  '<th style="width:10%;">SEV</th>' +
                  '<th style="width:10%;">TOOL</th>' +
                  '<th style="width:25%;">RULE</th>' +
                  '<th style="width:40%;">FILE</th>' +
                  '<th style="width:10%;">LINE</th>' +
                '</tr>' +
              '</thead>' +
              '<tbody id="vsp-ds-tbody">' +
                '<tr><td colspan="6" class="vsp-table-empty">Đang tải unified findings...</td></tr>' +
              '</tbody>' +
            '</table>' +
          '</div>' +
        '</div>' +
      '</div>';

    var btn = document.getElementById("vsp-ds-refresh-btn");
    if (btn) btn.addEventListener("click", loadDatasource);

    var sevSel = document.getElementById("vsp-ds-filter-severity");
    var toolSel = document.getElementById("vsp-ds-filter-tool");
    var searchInp = document.getElementById("vsp-ds-filter-search");

    if (sevSel) sevSel.addEventListener("change", applyFilters);
    if (toolSel) toolSel.addEventListener("change", applyFilters);
    if (searchInp) {
      searchInp.addEventListener("input", function () {
        clearTimeout(searchInp._vspTimer);
        searchInp._vspTimer = setTimeout(applyFilters, 150);
      });
    }

    loadDatasource();
  }

  window.vspInitDatasourceTab = hydratePane;

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", hydratePane);
  } else {
    hydratePane();
  }
})();

})();
/* ==== END: static/js/vsp_datasource_tab_simple_v2.js ==== */

/* ==== BEGIN: static/js/vsp_datasource_tab_v1.js ==== */
(function(){
'use strict';
/* VSP_DATASOURCE_TAB_V1 (commercial P1): RID -> findings_unified API + filters + paging */
(function(){
  'use strict';

  function normalizeRid(x){
    x = String(x||"").trim();
    // common: RUN_<RID>
    x = x.replace(/^RUN[_\s]+/i, "");
    // try extract canonical VSP_CI_YYYYmmdd_HHMMSS
    const m = x.match(/(VSP_CI_\d{8}_\d{6})/i);
    if (m) return m[1];
    // fallback: collapse spaces -> underscores
    x = x.replace(/\s+/g, "_");
    return x;
  }



  const $ = (sel, root=document) => root.querySelector(sel);

  async function getActiveRid(){
    // Prefer rid state injected by vsp_rid_state_v1.js (your template already loads it)
    try{
      if (window.VSP_RID_STATE && typeof window.VSP_RID_STATE.get === "function"){
        const r = window.VSP_RID_STATE.get();
        if (r) return r;
      }
    }catch(_){}

    // Fallback: dashboard_v3 run_id (best-effort)
    try{
      const j = await fetch("/api/vsp/dashboard_v3").then(r=>r.json());
      if (j && j.run_id) return j.run_id;
    }catch(_){}

    return null;
  }

  function esc(s){
    return String(s ?? "").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  function renderTable(items){
    const host = $("#vsp4-datasource-table") || $("#datasource-table") || $("#tab-datasource");
    if (!host) return;

    const rows = (items||[]).map(it=>{
      const sev = esc(it.severity||"");
      const tool = esc(it.tool||"");
      const title = esc(it.title||"");
      const file = esc(it.file||"");
      const line = esc(it.line||"");
      const cwe = Array.isArray(it.cwe) ? esc(it.cwe[0]||"") : esc(it.cwe||"");
      return `<tr>
        <td class="vsp-mono">${sev}</td>
        <td class="vsp-mono">${tool}</td>
        <td>${title}</td>
        <td class="vsp-mono">${cwe}</td>
        <td class="vsp-mono">${file}:${line}</td>
      </tr>`;
    }).join("");

    host.innerHTML = `
      <div class="vsp-row" style="gap:10px; align-items:center; margin:10px 0;">
        <input id="ds-q" class="vsp-input" style="min-width:260px" placeholder="search title/file/id..." />
        <input id="ds-file" class="vsp-input" style="min-width:220px" placeholder="file contains..." />
        <select id="ds-sev" class="vsp-input">
          <option value="">SEV (all)</option>
          <option>CRITICAL</option><option>HIGH</option><option>MEDIUM</option>
          <option>LOW</option><option>INFO</option><option>TRACE</option>
        </select>
        <select id="ds-tool" class="vsp-input" style="min-width:180px"><option value="">TOOL (all)</option></select>
        <input id="ds-cwe" class="vsp-input" style="min-width:140px" placeholder="CWE-79" />
        <button id="ds-go" class="vsp-btn">Apply</button>
        <span id="ds-meta" class="vsp-muted" style="margin-left:auto;"></span>
      </div>
      <div class="vsp-row" style="gap:10px; align-items:center; margin:10px 0;">
        <button id="ds-prev" class="vsp-btn vsp-btn-ghost">Prev</button>
        <button id="ds-next" class="vsp-btn vsp-btn-ghost">Next</button>
        <input id="ds-limit" class="vsp-input" style="width:90px" value="50" />
        <span class="vsp-muted">limit (1..500)</span>
      </div>
      <div class="vsp-card" style="overflow:auto;">
        <table class="vsp-table" style="min-width:1100px">
          <thead><tr>
            <th>Severity</th><th>Tool</th><th>Title</th><th>CWE</th><th>File:Line</th>
          </tr></thead>
          <tbody>${rows || `<tr><td colspan="5" class="vsp-muted">No items</td></tr>`}</tbody>
        </table>
      </div>
    `;
  }

  function populateToolOptions(byTool){
    const sel = document.querySelector('#ds-tool');
    if(!sel) return;
    const cur = sel.value || '';
    const keys = Object.keys(byTool||{}).sort((a,b)=>String(a).localeCompare(String(b)));
    sel.innerHTML = '<option value="">TOOL (all)</option>' + keys.map(k=>`<option value="${k}">${k} (${byTool[k]})</option>`).join('');
    if(cur) sel.value = cur;
  }

  async function load(page){
    const rid = normalizeRid(normalizeRid(await getActiveRid()));
    const meta = $("#ds-meta");
    if (!rid){
      renderTable([]);
      if (meta) meta.textContent = "RID: (missing)";
      return;
    }

    const q = ($("#ds-q")?.value || "").trim();
    const fileq = ($("#ds-file")?.value || "").trim();
    const sev = ($("#ds-sev")?.value || "").trim();
    const tool = ($("#ds-tool")?.value || "").trim();
    const cwe = ($("#ds-cwe")?.value || "").trim();
    const limit = parseInt(($("#ds-limit")?.value || "50"), 10) || 50;

    const params = new URLSearchParams();
    params.set("page", String(page||1));
    params.set("limit", String(limit));
    if (q) params.set("q", q);
    if (fileq) params.set("file", fileq);
    if (sev) params.set("sev", sev);
    if (tool) params.set("tool", tool);
    if (cwe) params.set("cwe", cwe);

    const url = `/api/vsp/findings_unified_v2/${encodeURIComponent(rid)}?` + params.toString();
    const j = await fetch(url).then(r=>r.json()).catch(()=>null);

    if (!j){
      renderTable([]);
      if (meta) meta.textContent = `RID=${rid} | fetch failed`;
      return;
    }

    if (j.warning && j.warning.includes("run_dir_not_found")){
      renderTable([]);
      if (meta) meta.textContent = `RID=${rid} | run_dir_not_found (RID state not persisted?)`;
      return;
    }

    renderTable(j.items || []);
    try{ populateToolOptions((j.counts||{}).by_tool||{}); }catch(_){ }

    const total = j.total ?? 0;
    const p = j.page ?? 1;
    const l = j.limit ?? limit;
    const start = total ? ((p-1)*l + 1) : 0;
    const end = Math.min(total, (p*l));
    const src = j.resolve_source || "-";
    const warn = j.warning ? ` | ${j.warning}` : "";
    const sevCounts = (j.counts||{}).by_sev||{};
const sevMini = Object.keys(sevCounts).sort().map(k=>`${k}:${sevCounts[k]}`).join(" ");
if ($("#ds-meta")) $("#ds-meta").textContent = `RID=${rid} | ${start}-${end}/${total} | ${sevMini} | src=${src}${warn}`;

    // wire buttons
    $("#ds-go")?.addEventListener("click", ()=>load(1));
    $("#ds-prev")?.addEventListener("click", ()=>load(Math.max(1, (p-1))));
    $("#ds-next")?.addEventListener("click", ()=>load((p+1)));
  }

  // expose for debugging
  window.VSP_DS_P1 = { reload: ()=>load(1) };

  // auto-load when tab exists
  document.addEventListener("DOMContentLoaded", ()=> {
    // First render shell then load data
    renderTable([]);
    load(1);
  });
})();

})();
/* ==== END: static/js/vsp_datasource_tab_v1.js ==== */

/* ==== BEGIN: static/js/vsp_datasource_tab_v2.js ==== */
(function(){
'use strict';
// static/js/vsp_datasource_tab_v2.js
// V2 – Data Source tab, bảng unified findings + filter severity + search

(function () {
  'use strict';

  if (window.VSP_DATASOURCE_TAB_V2) return;
  window.VSP_DATASOURCE_TAB_V2 = true;

  var LOG_PREFIX = '[VSP_DS]';
  var loaded = false;
  var allItems = [];
  var currentSeverity = '';
  var currentSearch = '';

  function $(sel) { return document.querySelector(sel); }

  async function fetchDatasource() {
    try {
      var res = await fetch('/api/vsp/datasource_v2?limit=300', { cache: 'no-store' });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      return await res.json();
    } catch (e) {
      console.error(LOG_PREFIX, 'fetch error:', e);
      return null;
    }
  }

  function normalizeSeverity(s) {
    if (!s) return '';
    return String(s).toUpperCase();
  }

  function escapeHtml(str) {
    if (str === null || str === undefined) return '';
    return String(str)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;');
  }

  function itemMatchesFilters(item) {
    var sev = normalizeSeverity(item.severity || item.level || item.priority);

    if (currentSeverity && sev !== currentSeverity) return false;

    if (currentSearch) {
      var q = currentSearch.toLowerCase();
      var fields = [
        item.tool,
        item.rule_id,
        item.rule,
        item.check_id,
        item.file,
        item.file_path,
        item.target,
        item.message,
        item.summary
      ];
      for (var i = 0; i < fields.length; i++) {
        if (!fields[i]) continue;
        if (String(fields[i]).toLowerCase().indexOf(q) !== -1) return true;
      }
      return false;
    }

    return true;
  }

  function buildRows(items) {
    if (!items || !items.length) {
      return '<tr><td colspan="7" class="col-empty">Không có bản ghi nào.</td></tr>';
    }

    return items.map(function (f, idx) {
      var sev = normalizeSeverity(f.severity || f.level || f.priority);
      var tool = f.tool || f.scanner || '—';
      var rule = f.rule_id || f.rule || f.check_id || '—';
      var file = f.file || f.file_path || f.target || '—';
      var line = f.line || f.start_line || (f.location && f.location.line) || '—';
      var msg = f.message || f.summary || '';

      return [
        '<tr>',
        '  <td class="col-idx">' + (idx + 1) + '</td>',
        '  <td class="col-sev"><span class="vsp-badge vsp-badge-' + sev.toLowerCase() + '">' + (sev || '—') + '</span></td>',
        '  <td class="col-tool">' + escapeHtml(tool) + '</td>',
        '  <td class="col-rule"><code>' + escapeHtml(rule) + '</code></td>',
        '  <td class="col-file">' + escapeHtml(file) + '</td>',
        '  <td class="col-line">' + escapeHtml(line) + '</td>',
        '  <td class="col-msg">' + escapeHtml(msg) + '</td>',
        '</tr>'
      ].join('');
    }).join('\n');
  }

  function renderTable() {
    var pane = document.getElementById('vsp-datasource-main') ||
               document.getElementById('vsp-tab-datasource');
    if (!pane) {
      console.warn(LOG_PREFIX, 'Không tìm thấy pane #vsp-datasource-main hoặc #vsp-tab-datasource');
      return;
    }

    var filtered = allItems.filter(itemMatchesFilters);
    var tbody = pane.querySelector('tbody.vsp-ds-body');
    if (!tbody) return;
    tbody.innerHTML = buildRows(filtered);

    var countEl = pane.querySelector('#vsp-ds-count');
    if (countEl) {
      countEl.textContent = filtered.length + ' / ' + allItems.length;
    }
  }

  function renderPane(data) {
    var pane = document.getElementById('vsp-datasource-main') ||
               document.getElementById('vsp-tab-datasource');
    if (!pane) {
      console.warn(LOG_PREFIX, 'Không tìm thấy pane datasource.');
      return;
    }

    pane.innerHTML = '';

    if (!data) {
      pane.innerHTML = '<div class="vsp-error">Không tải được /api/vsp/datasource_v2.</div>';
      return;
    }
    if (data.ok === false && data.error) {
      pane.innerHTML = '<div class="vsp-error">' + data.error + '</div>';
      return;
    }

    allItems = data.items || data.findings || [];

    var html = [
      '<div class="vsp-card vsp-ds-card">',
      '  <div class="vsp-card-header">',
      '    <h2 class="vsp-card-title">Data Source</h2>',
      '    <p class="vsp-card-subtitle">Danh sách unified findings từ tất cả các tool.</p>',
      '  </div>',
      '  <div class="vsp-ds-filters">',
      '    <div class="vsp-ds-sev-filters">',
      '      <button type="button" class="vsp-ds-sev-btn" data-sev="">All</button>',
      '      <button type="button" class="vsp-ds-sev-btn" data-sev="CRITICAL">CRITICAL</button>',
      '      <button type="button" class="vsp-ds-sev-btn" data-sev="HIGH">HIGH</button>',
      '      <button type="button" class="vsp-ds-sev-btn" data-sev="MEDIUM">MEDIUM</button>',
      '      <button type="button" class="vsp-ds-sev-btn" data-sev="LOW">LOW</button>',
      '      <button type="button" class="vsp-ds-sev-btn" data-sev="INFO">INFO</button>',
      '      <button type="button" class="vsp-ds-sev-btn" data-sev="TRACE">TRACE</button>',
      '    </div>',
      '    <div class="vsp-ds-search">',
      '      <input type="search" id="vsp-ds-search-input" placeholder="Tìm theo rule / file / message..." />',
      '      <span class="vsp-ds-count" id="vsp-ds-count"></span>',
      '    </div>',
      '  </div>',
      '  <div class="vsp-table-wrapper vsp-ds-table-wrapper">',
      '    <table class="vsp-table vsp-table-datasource">',
      '      <thead>',
      '        <tr>',
      '          <th>#</th>',
      '          <th>Severity</th>',
      '          <th>Tool</th>',
      '          <th>Rule</th>',
      '          <th>File</th>',
      '          <th>Line</th>',
      '          <th>Message</th>',
      '        </tr>',
      '      </thead>',
      '      <tbody class="vsp-ds-body">',
      '      </tbody>',
      '    </table>',
      '  </div>',
      '</div>'
    ].join('\n');

    pane.innerHTML = html;

    // Gắn event filter
    var buttons = pane.querySelectorAll('.vsp-ds-sev-btn');
    buttons.forEach(function (btn) {
      btn.addEventListener('click', function () {
        buttons.forEach(function (b) { b.classList.remove('active'); });
        btn.classList.add('active');
        currentSeverity = btn.getAttribute('data-sev') || '';
        renderTable();
      });
    });

    var searchInput = pane.querySelector('#vsp-ds-search-input');
    if (searchInput) {
      searchInput.addEventListener('input', function () {
        currentSearch = searchInput.value.trim();
        renderTable();
      });
    }

    // Init state
    currentSeverity = '';
    currentSearch = '';
    if (buttons[0]) buttons[0].classList.add('active');
    renderTable();
  }

  async function hydrateDatasource() {
    if (loaded) return;
    var pane = document.getElementById('vsp-datasource-main') ||
               document.getElementById('vsp-tab-datasource');
    if (!pane) {
      console.warn(LOG_PREFIX, 'Pane datasource chưa sẵn sàng, bỏ qua.');
      return;
    }

    console.log(LOG_PREFIX, 'Hydrating datasource tab...');
    pane.innerHTML = '<div class="vsp-loading">Đang tải unified findings...</div>';

    var data = await fetchDatasource();
    renderPane(data);

    loaded = true;
    console.log(LOG_PREFIX, 'Datasource tab hydrated.');
  }

  function shouldHydrateNow() {
    return (window.location.hash === '#datasource');
  }

  function onReady() {
    console.log(LOG_PREFIX, 'vsp_datasource_tab_v2.js loaded');
    if (shouldHydrateNow()) {
      hydrateDatasource();
    }
  }

  function onHashChange() {
    if (shouldHydrateNow()) {
      hydrateDatasource();
    }
  }

  window.addEventListener('DOMContentLoaded', onReady);
  window.addEventListener('hashchange', onHashChange);
})();

})();
/* ==== END: static/js/vsp_datasource_tab_v2.js ==== */

/* ==== BEGIN: static/js/vsp_datasource_v1.js ==== */
(function(){
'use strict';
// ======================= VSP_DATASOURCE_V1 – DATA SOURCE =======================
// Dùng /api/vsp/datasource_v2 để:
// - Đổ bảng unified findings
// - Vẽ donut severity
// - Vẽ horizontal bar top CWE

(function () {
  "use strict";

  function qs(sel) { return document.querySelector(sel); }

  function selectDsTbody() {
    return qs("[data-vsp-ds-tbody]") ||
           qs("#vsp-ds-tbody") ||
           (function () {
              var tbl = qs("#vsp-ds-table");
              return tbl ? tbl.querySelector("tbody") : null;
            })();
  }

  function renderTable(items) {
    var tbody = selectDsTbody();
    if (!tbody) {
      console.warn("[VSP][DS] Không tìm thấy tbody unified findings.");
      return;
    }

    tbody.innerHTML = "";
    if (!Array.isArray(items) || !items.length) {
      var trEmpty = document.createElement("tr");
      var tdEmpty = document.createElement("td");
      tdEmpty.colSpan = 10;
      tdEmpty.textContent = "No findings.";
      trEmpty.appendChild(tdEmpty);
      tbody.appendChild(trEmpty);
      return;
    }

    items.forEach(function (f) {
      var tr = document.createElement("tr");
      function td(text) {
        var cell = document.createElement("td");
        cell.textContent = text;
        return cell;
      }

      tr.appendChild(td(f.severity || "–"));
      tr.appendChild(td(f.tool || "–"));
      tr.appendChild(td(f.file || f.path || "–"));
      tr.appendChild(td(f.line != null ? String(f.line) : "–"));
      tr.appendChild(td(f.rule_id || f.rule || "–"));
      tr.appendChild(td(f.message || "–"));
      tr.appendChild(td(f.cwe || "–"));
      tr.appendChild(td(f.cve || "–"));
      tr.appendChild(td(f.module || "–"));
      tr.appendChild(td(Array.isArray(f.tags) ? f.tags.join(",") : (f.tags || "–")));

      tbody.appendChild(tr);
    });
  }

  function buildSeveritySummary(items) {
    var sev = { CRITICAL:0, HIGH:0, MEDIUM:0, LOW:0, INFO:0, TRACE:0 };
    items.forEach(function (f) {
      var s = (f.severity || "").toUpperCase();
      if (sev.hasOwnProperty(s)) sev[s]++;
    });
    return sev;
  }

  function buildTopCwe(items, limit) {
    var map = {};
    items.forEach(function (f) {
      var c = f.cwe || f.cwe_id;
      if (!c) return;
      map[c] = (map[c] || 0) + 1;
    });
    var arr = Object.keys(map).map(function (id) {
      return { id: id, count: map[id] };
    });
    arr.sort(function (a, b) { return b.count - a.count; });
    return arr.slice(0, limit || 8);
  }

  function renderSeverityDonut(sev) {
    var canvas = qs("#vsp-ds-severity-donut");
    if (!canvas || typeof Chart === "undefined") {
      if (!canvas) console.warn("[VSP][DS] Không tìm thấy canvas donut.");
      if (typeof Chart === "undefined") console.warn("[VSP][DS] Chart.js chưa được load.");
      return;
    }

    var labels = ["CRITICAL","HIGH","MEDIUM","LOW","INFO","TRACE"];
    var data   = labels.map(function (k) { return sev[k] || 0; });

    new Chart(canvas.getContext("2d"), {
      type: "doughnut",
      data: {
        labels: labels,
        datasets: [{
          data: data
        }]
      },
      options: {
        plugins: { legend: { display: true } }
      }
    });
  }

  function renderTopCweBar(topCwe) {
    var canvas = qs("#vsp-ds-topcwe");
    if (!canvas || typeof Chart === "undefined") {
      if (!canvas) console.warn("[VSP][DS] Không tìm thấy canvas top CWE.");
      if (typeof Chart === "undefined") console.warn("[VSP][DS] Chart.js chưa được load.");
      return;
    }

    var labels = topCwe.map(function (c) { return c.id; });
    var counts = topCwe.map(function (c) { return c.count; });

    new Chart(canvas.getContext("2d"), {
      type: "bar",
      data: {
        labels: labels,
        datasets: [{
          label: "Findings",
          data: counts
        }]
      },
      options: {
        indexAxis: "y",
        plugins: { legend: { display: false } }
      }
    });
  }

  function loadDataSource() {
    var url = "/api/vsp/datasource_v2?limit=500";
    console.log("[VSP][DS] Fetching datasource from", url);

    fetch(url)
      .then(function (res) {
        if (!res.ok) throw new Error("HTTP " + res.status);
        return res.json();
      })
      .then(function (data) {
        console.log("[VSP][DS] Loaded datasource_v2:", data);
        var items = Array.isArray(data.items) ? data.items : [];
        renderTable(items);

        var sev = buildSeveritySummary(items);
        renderSeverityDonut(sev);

        var topCwe = buildTopCwe(items, 8);
        renderTopCweBar(topCwe);
      })
      .catch(function (err) {
        console.error("[VSP][DS] Error loading datasource_v2:", err);
      });
  }

  document.addEventListener("DOMContentLoaded", function () {
    try {
      loadDataSource();
    } catch (err) {
      console.error("[VSP][DS] DOMContentLoaded error:", err);
    }
  });
})();

})();
/* ==== END: static/js/vsp_datasource_v1.js ==== */

/* ==== BEGIN: static/js/vsp_datasource_v2.js ==== */
(function(){
'use strict';
// === VSP DATASOURCE – FIX V3 ===

function loadDataSource() {
  fetch("/api/vsp/datasource_v2?limit=5000")
    .then(r => r.json())
    .then(json => {
      if (!json.ok) return;
      const tbody = $("#datasource-body");
      tbody.empty();

      json.items.forEach(item => {
        const sev = (item.severity_effective || "INFO").toLowerCase();
        const row = `
          <tr>
            <td class="sev-${sev}">${item.severity_effective}</td>
            <td>${item.tool}</td>
            <td>${item.file}</td>
            <td>${item.line || "-"}</td>
            <td>${item.cwe || "-"}</td>
            <td>${item.description || "-"}</td>
          </tr>
        `;
        tbody.append(row);
      });
    })
    .catch(err => console.error("[DATASOURCE] Error:", err));
}

document.addEventListener("DOMContentLoaded", loadDataSource);

})();
/* ==== END: static/js/vsp_datasource_v2.js ==== */

/* ==== BEGIN: static/js/vsp_ui_4tabs_commercial_v1.freeze.js ==== */
(function(){
'use strict';
/* VSP_UI_FREEZE build=20251216_224121 */
/* === VSP_GLOBAL_KPI_GUARDS_P1_V2 ===
   Ensure _vspSetTextK/_vspSetHTMLK exist in GLOBAL scope (file has multiple IIFEs/modules).
*/
var _vspKpiEl = (typeof _vspKpiEl === "function") ? _vspKpiEl : function(id){
  try{ return document.getElementById(id); }catch(_){ return null; }
};
var _vspKpiHasValue = (typeof _vspKpiHasValue === "function") ? _vspKpiHasValue : function(el){
  try{
    var t = (el && (el.textContent||"") || "").trim();
    if(!t) return false;
    var u = t.toUpperCase();
    return (t !== "…" && t !== "—" && u !== "N/A");
  }catch(_){ return false; }
};
var _vspKpiLocked = (typeof _vspKpiLocked === "function") ? _vspKpiLocked : function(id){
  var el=_vspKpiEl(id);
  try{ return !!(el && el.getAttribute("data-vsp-kpi-lock")==="1"); }catch(_){ return false; }
};
var _vspKpiLock = (typeof _vspKpiLock === "function") ? _vspKpiLock : function(id){
  var el=_vspKpiEl(id);
  try{ if(el) el.setAttribute("data-vsp-kpi-lock","1"); }catch(_){}
};
var _vspSetTextK = (typeof _vspSetTextK === "function") ? _vspSetTextK : function(id, v){
  var el=_vspKpiEl(id);
  if(!el) return false;
  if(_vspKpiLocked(id) && _vspKpiHasValue(el)) return false;
  try{
    el.textContent = (v===0) ? "0" : (v ? String(v) : "—");
    return true;
  }catch(_){ return false; }
};
var _vspSetHTMLK = (typeof _vspSetHTMLK === "function") ? _vspSetHTMLK : function(id, html){
  var el=_vspKpiEl(id);
  if(!el) return false;
  if(_vspKpiLocked(id) && _vspKpiHasValue(el)) return false;
  try{
    el.innerHTML = (html===0) ? "0" : (html ? String(html) : "—");
    return true;
  }catch(_){ return false; }
};
/* === END VSP_GLOBAL_KPI_GUARDS_P1_V2 === */

/* === VSP_GLOBAL_KPI_HYDRATOR_FROM_EXTRAS_P1_V1 ===
   Purpose: hydrate KPI cards from /api/vsp/dashboard_v3_extras_v1 regardless of internal module function names.
   Requires: global _vspSetTextK/_vspSetHTMLK/_vspKpiLock from VSP_GLOBAL_KPI_GUARDS_P1_V2.
*/
(function(){
  function _normRid(x){
    try{
      x = String(x||"").trim();
      x = x.replace(/^RUN[_\-\s]+/i,"").replace(/^RID[:\s]+/i,"");
      const m = x.match(/(VSP_CI_\d{8}_\d{6})/i);
      if(m && m[1]) return m[1].toUpperCase();
      return x.replace(/\s+/g,"_");
    }catch(_){ return ""; }
  }
  function _getRid(){
    // 1) shared rid state
    try{
      const st = window.__VSP_RID_STATE__ || window.__VSP_RID_STATE || window.VSP_RID_STATE || window.__vsp_rid_state;
      if(st){
        if(st.rid || st.run_id) return _normRid(st.rid || st.run_id);
        if(st.state && (st.state.rid || st.state.run_id)) return _normRid(st.state.rid || st.state.run_id);
        if(typeof st.get === "function"){
          const v = st.get();
          if(v && (v.rid || v.run_id)) return _normRid(v.rid || v.run_id);
        }
      }
    }catch(_){}
    // 2) scan page text
    try{
      const txt = (document && document.body && document.body.innerText) ? document.body.innerText : "";
      const m = txt.match(/(VSP_CI_\d{8}_\d{6})/i);
      if(m && m[1]) return _normRid(m[1]);
    }catch(_){}
    return "";
  }

  // === VSP_KPI_HYDRATOR_RID_FALLBACK_P1_V1 ===
  async function _fetchLatestRid(){
    try{
      const u="/api/vsp/runs_index_v3_fs_resolved?limit=1&hide_empty=0&filter=1";
      const r=await fetch(u,{cache:"no-store"});
      if(!r.ok) return "";
      const j=await r.json();
      const it = (j && j.items && j.items[0]) ? j.items[0] : null;
      const rid = it ? (it.run_id || it.rid || "") : "";
      return _normRid(rid);
    }catch(_){ return ""; }
  }

  function _hasKpiDom(){
    try{ return !!(document.getElementById("kpi-overall") && document.getElementById("kpi-gate")); }
    catch(_){ return false; }
  }
  function _fmtBySev(bySev){
    try{
      if(!bySev) return "";
      const order=["CRITICAL","HIGH","MEDIUM","LOW","INFO","TRACE"];
      const out=[];
      for(const k of order){
        if(bySev[k]!==undefined) out.push(k[0]+":"+bySev[k]);
      }
      return out.join(" ");
    }catch(_){ return ""; }
  }
  async function _fetchExtras(rid){
    if(!rid) return null;
    const u="/api/vsp/dashboard_v3_extras_v1?rid="+encodeURIComponent(rid);
    try{
      const r=await fetch(u,{cache:"no-store"});
      if(!r.ok) return null;
      const j=await r.json();
      return (j && j.ok && j.kpi) ? j : null;
    }catch(_){ return null; }
  }
  function _apply(j){
    try{
      if(!j || !j.kpi) return false;
      const k=j.kpi||{};
      const total = (k.total ?? 0);
      const eff   = (k.effective ?? 0);
      const degr  = (k.degraded ?? 0);
      const unk   = (k.unknown_count ?? 0);
      const score = (k.score===undefined || k.score===null) ? "" : k.score;

      const verdict = (degr>0) ? "DEGRADED" : (total>0 ? "OK" : "EMPTY");
      const gateTxt = (score!=="") ? (String(score)+"/100") : verdict;

      // set + lock so status_v2 won't overwrite
      _vspSetTextK("kpi-overall", verdict);
      _vspSetTextK("kpi-overall-sub", `total ${total} | eff ${eff} | degr ${degr} | unk ${unk}`);
      _vspKpiLock("kpi-overall"); _vspKpiLock("kpi-overall-sub");

      _vspSetTextK("kpi-gate", gateTxt);
      // by_sev may not exist; keep safe
      const bySev = k.by_sev || k.bySev || null;
      _vspSetTextK("kpi-gate-sub", bySev ? _fmtBySev(bySev) : "");
      _vspKpiLock("kpi-gate"); _vspKpiLock("kpi-gate-sub");

      return true;
    }catch(_){ return false; }
  }

  async function _run(){
    try{
      if(!_hasKpiDom()) return;
      let rid=_getRid();
      if(!rid) rid = await _fetchLatestRid();
      if(!rid) return;
const j=await _fetchExtras(rid);
      if(!j) return;
      _apply(j);
    }catch(_){}
  }

  function _install(){
    try{
      if(window.__VSP_GLOBAL_KPI_HYDRATOR_INSTALLED__) return;
      window.__VSP_GLOBAL_KPI_HYDRATOR_INSTALLED__ = 1;

      // immediate + retry
      _run(); setTimeout(_run,200); setTimeout(_run,800); setTimeout(_run,1600);

      // observe pane mount / route change
      const obs = new MutationObserver(()=>{ if(_hasKpiDom()) _run(); });
      obs.observe(document.documentElement || document.body, {subtree:true, childList:true});

      // periodic safety
      setInterval(_run, 3000);
    }catch(_){}
  }

  if(document.readyState==="loading"){
    document.addEventListener("DOMContentLoaded", _install);
  }else{
    _install();
  }
})();




// === VSP_EXPORT_HEAD_NOISE_PATCH_V1 ===
(function(){
  'use strict';

  // === VSP_KPI_LOCK_PREFER_EXTRAS_P1_V1 ===
  function _vspKpiEl(id){ try{return document.getElementById(id);}catch(_){return null;} }
  function _vspKpiHasValue(el){
    try{
      const t = (el && (el.textContent||"") || "").trim();
      if(!t) return false;
      const u = t.toUpperCase();
      return (t !== "…" && t !== "—" && u !== "N/A");
    }catch(_){ return false; }
  }
  function _vspKpiLocked(id){
    const el=_vspKpiEl(id);
    return !!(el && el.getAttribute("data-vsp-kpi-lock")==="1");
  }
  function _vspKpiLock(id){
    const el=_vspKpiEl(id);
    if(el) el.setAttribute("data-vsp-kpi-lock","1");
  }
  function _vspSetTextK(id, v){
    const el=_vspKpiEl(id);
    if(el && _vspKpiLocked(id) && _vspKpiHasValue(el)) return;
    setText(id, v);
  }
  function _vspSetHTMLK(id, v){
    const el=_vspKpiEl(id);
    if(el && _vspKpiLocked(id) && _vspKpiHasValue(el)) return;
    setHTML(id, v);
  }


/* === VSP_4TABS_KPI_FROM_EXTRAS_P1_V1 === */
(function(){
  if(window.__VSP_4TABS_KPI_FROM_EXTRAS_P1_V1) return;
  window.__VSP_4TABS_KPI_FROM_EXTRAS_P1_V1 = 1;

  function normRid(x){
    try{
      x = String(x||"").trim();
      x = x.replace(/^RUN[_\-\s]+/i, "");
      x = x.replace(/^RID[:\s]+/i, "");
      const m = x.match(/(VSP_CI_\d{8}_\d{6})/i);
      if(m && m[1]) return m[1];
      return x.replace(/\s+/g,"_");
    }catch(_){ return ""; }
  }

  function getRid(){
    try{
      const st = window.__VSP_RID_STATE__ || window.__VSP_RID_STATE || window.VSP_RID_STATE;
      if(st){
        if(st.rid || st.run_id) return normRid(st.rid || st.run_id);
        if(st.state && (st.state.rid || st.state.run_id)) return normRid(st.state.rid || st.state.run_id);
        if(typeof st.get === "function"){
          const v = st.get();
          if(v && (v.rid || v.run_id)) return normRid(v.rid || v.run_id);
        }
      }
    }catch(_){}

    try{
      const t = document.body ? (document.body.innerText || "") : "";
      const m = t.match(/RID:\s*(VSP_CI_\d{8}_\d{6})/i);
      if(m && m[1]) return normRid(m[1]);
    }catch(_){}

    return "";
  }

  function setText(id, v){
    const el = document.getElementById(id);
    if(!el) return false;
    el.textContent = (v===0) ? "0" : (v ? String(v) : "—");
    return true;
  }

  function fmtBySev(bySev){
    if(!bySev) return "";
    const order = ["CRITICAL","HIGH","MEDIUM","LOW","INFO","TRACE"];
    const out = [];
    for(const k of order){
      if(bySev[k] !== undefined) out.push(k[0] + ":" + bySev[k]);
    }
    return out.join(" ");
  }

  async function fetchExtras(rid){
    if(!rid) return null;
    const u = "/api/vsp/dashboard_v3_extras_v1?rid=" + encodeURIComponent(rid);
    try{
      const r = await fetch(u, {cache:"no-store"});
      if(!r.ok) return null;
      const j = await r.json();
      if(j && j.ok) return j;
    }catch(_){}
    return null;
  }

  function applyExtras(j){
    const k = (j && j.kpi) ? j.kpi : {};
    const byTool = j.by_tool || {};
    const bySev  = j.by_sev  || {};

    const total = k.total ?? 0;
    const eff   = k.effective ?? 0;
    const degr  = k.degraded ?? 0;
    const unk   = k.unknown_count ?? 0;
    const score = (k.score===undefined || k.score===null) ? "" : k.score;

    const verdict = (degr > 0) ? "DEGRADED" : (total > 0 ? "OK" : "EMPTY");
    const gateTxt = (score !== "") ? (String(score) + "/100") : verdict;

    _vspSetTextK("kpi-overall", verdict);
    _vspSetTextK("kpi-overall-sub", `total ${total} | eff ${eff} | degr ${degr} | unk ${unk}`);
    
    // --- VSP_KPI_LOCK_AFTER_EXTRAS_P1 ---
    _vspKpiLock("kpi-overall");
    _vspKpiLock("kpi-overall-sub");
    _vspKpiLock("kpi-gate");
    _vspKpiLock("kpi-gate-sub");
    _vspKpiLock("kpi-gitleaks");
    _vspKpiLock("kpi-gitleaks-sub");
    _vspKpiLock("kpi-codeql");
    _vspKpiLock("kpi-codeql-sub");
_vspSetTextK("kpi-gate", gateTxt);
    _vspSetTextK("kpi-gate-sub", fmtBySev(bySev));

    const gtl = (byTool.GITLEAKS !== undefined) ? byTool.GITLEAKS : null;
    const cql = (byTool.CODEQL  !== undefined) ? byTool.CODEQL  : null;
    _vspSetTextK("kpi-gitleaks", (gtl===null) ? "NOT_RUN" : gtl);
    _vspSetTextK("kpi-gitleaks-sub", "GITLEAKS");
    _vspSetTextK("kpi-codeql", (cql===null) ? "NOT_RUN" : cql);
    _vspSetTextK("kpi-codeql-sub", "CODEQL");
  }

  let lastRid = "";
  async function hydrate(force){
    const rid = getRid();
    if(!rid) return;
    if(!force && rid === lastRid) return;
    lastRid = rid;

    const j = await fetchExtras(rid);
    if(j) applyExtras(j);
  }

  window.addEventListener("hashchange", () => setTimeout(() => hydrate(true), 120));
  setTimeout(() => hydrate(true), 200);
  setInterval(() => hydrate(false), 1500);
})();


  // 1) QUIET export probe:
  // Browser HEAD to /api/vsp/run_export_v3/...fmt=pdf may fail/noisy (DevTools shows "Fetch failed loading: HEAD ...")
  // We short-circuit ONLY that exact pattern to a synthetic 200 so UI stops spamming.
  if (!window.__VSP_EXPORT_HEAD_NOISE_PATCH_V1__) {
    window.__VSP_EXPORT_HEAD_NOISE_PATCH_V1__ = true;
    const _fetch = (window.fetch && window.fetch.bind(window)) ? window.fetch.bind(window) : null;

    if (_fetch) {
      window.fetch = function(input, init){
        try {
          const method = (init && init.method)
            ? String(init.method).toUpperCase()
            : (input && input.method ? String(input.method).toUpperCase() : "GET");
          const url = (typeof input === "string")
            ? input
            : (input && input.url ? String(input.url) : "");
          if (method === "HEAD"
              && url.includes("/api/vsp/run_export_v3/")
              && url.includes("fmt=pdf")) {
            // pretend "available" without real network HEAD (removes noisy HEAD errors)
            return Promise.resolve(new Response("", {
              status: 200,
              headers: { "X-VSP-EXPORT-AVAILABLE": "1" }
            }));
          }
        } catch(_e) {}
        return _fetch(input, init);
      };
      console.log("[VSP][EXPORT] installed HEAD-noise patch for fmt=pdf");
    }
  }

  // 2) DRILLDOWN bus (Dashboard/Gate Summary click -> Data Source auto filter)
  const LS_KEY = "vsp_ds_filters_v1";

  function emitFilters(filters){
    const payload = { v:1, ts: Date.now(), filters: (filters||{}) };
    try { localStorage.setItem(LS_KEY, JSON.stringify(payload)); } catch(_){}
    try { window.dispatchEvent(new CustomEvent("vsp:datasource:setFilters", { detail: payload })); } catch(_){}
  }

  window.VSP_DRILL_TO_DATASOURCE = function(filters){
    emitFilters(filters || {});
    // switch to datasource tab via hash (your router logs show hash-based router)
    try { location.hash = "#datasource"; } catch(_){}
  };

  // datasource side: best-effort apply by label text (Severity/Tool/CWE/Text/Limit)
  function findControlByLabelText(labelText, preferTags){
    labelText = String(labelText||"").toLowerCase();
    preferTags = preferTags || ["select","input","textarea"];
    const nodes = Array.from(document.querySelectorAll("div,span,label,strong,b,small,h1,h2,h3,h4,h5,h6"));
    for (const n of nodes) {
      const t = (n.textContent || "").trim().toLowerCase();
      if (!t) continue;
      if (t === labelText || t.includes(labelText)) {
        // search within same parent first
        let base = n.parentElement || n;
        for (let hop=0; hop<3 && base; hop++){
          for (const tg of preferTags){
            const c = base.querySelector(tg);
            if (c) return c;
          }
          base = base.parentElement;
        }
      }
    }
    return null;
  }

  function fire(el){
    try { el.dispatchEvent(new Event("input", { bubbles:true })); } catch(_){}
    try { el.dispatchEvent(new Event("change", { bubbles:true })); } catch(_){}
  }

  function applyFilters(filters){
    filters = filters || {};
    // only apply when datasource pane is active-ish
    const h = String(location.hash||"");
    if (!h.includes("datasource")) return;

    const sev = findControlByLabelText("Severity", ["select","input"]);
    const tool = findControlByLabelText("Tool", ["select","input"]);
    const cwe = findControlByLabelText("CWE", ["input","select"]);
    const txt = findControlByLabelText("Text", ["input","textarea"]);
    const lim = findControlByLabelText("Limit", ["input","select"]);

    if (filters.severity && sev) { sev.value = String(filters.severity); fire(sev); }
    if (filters.tool && tool) { tool.value = String(filters.tool); fire(tool); }
    if (filters.cwe && cwe) { cwe.value = String(filters.cwe); fire(cwe); }
    if (filters.text && txt) { txt.value = String(filters.text); fire(txt); }
    if (filters.limit && lim) { lim.value = String(filters.limit); fire(lim); }

    // try click "Load" if exists (your UI has Load/Clear buttons)
    try {
      const btn = Array.from(document.querySelectorAll("button"))
        .find(b => (b.textContent||"").trim().toLowerCase() === "load");
      if (btn) btn.click();
    } catch(_){}
  }

  function consumePending(){
    try {
      const raw = localStorage.getItem(LS_KEY);
      if (!raw) return;
      const p = JSON.parse(raw);
      if (!p || !p.filters) return;
      const age = Date.now() - Number(p.ts || 0);
      if (!(age >= 0 && age <= 5*60*1000)) return;
      localStorage.removeItem(LS_KEY);
      applyFilters(p.filters);
    } catch(_){}
  }

  window.addEventListener("vsp:datasource:setFilters", (e)=>{
    try { applyFilters((e.detail && e.detail.filters) || {}); } catch(_){}
  });
  window.addEventListener("hashchange", ()=>{ try { consumePending(); } catch(_){} });

  // Gate Summary pills click -> drilldown
  function wireGateSummaryClicks(){
    const toolSet = new Set(["GITLEAKS","SEMGREP","TRIVY","CODEQL","KICS","GRYPE","SYFT","BANDIT"]);
    const sevSet  = new Set(["CRITICAL","HIGH","MEDIUM","LOW","INFO","TRACE"]);
    const pills = Array.from(document.querySelectorAll(".vsp-pill, [data-pill], td, th, span, div"));

    for (const el of pills) {
      if (!el || el.__vsp_drilled__) continue;
      const txt = (el.textContent || "").trim();
      if (!txt) continue;
      const up = txt.toUpperCase();

      const filters = {};
      if (toolSet.has(up)) filters.tool = up;
      if (sevSet.has(up)) filters.severity = up;
      if (/^CWE-\d+$/i.test(up)) filters.cwe = up;

      if (Object.keys(filters).length === 0) continue;

      // limit to dashboard area if possible
      const inDash = !!el.closest("#vsp-dashboard-main") || String(location.hash||"").includes("dashboard");
      if (!inDash) continue;

      el.__vsp_drilled__ = true;
      el.style.cursor = "pointer";
      el.title = "Click → drilldown Data Source";
      el.addEventListener("click", ()=> window.VSP_DRILL_TO_DATASOURCE(filters));
    }
  }

  function onReady(fn){
    if (document.readyState === "complete" || document.readyState === "interactive") return setTimeout(fn, 0);
    document.addEventListener("DOMContentLoaded", fn, { once:true });
  }

  onReady(()=>{ try { wireGateSummaryClicks(); } catch(_){} });
  onReady(()=>{ try { consumePending(); } catch(_){} });

})();



// === VSP_P2_UI_NULL_GUARD_V1 ===
(function(){
  window.VSP_UI_SAFE_EL_V1 = function(id, parentSel){
    try{
      var el = document.getElementById(id);
      if (el) return el;
      var host = document.querySelector(parentSel || "#vsp4-main") ||
                 document.querySelector("#vsp-content") ||
                 document.body;
      el = document.createElement("div");
      el.id = id;
      host.appendChild(el);
      return el;
    }catch(e){
      var el2 = document.createElement("div");
      el2.id = id;
      document.body.appendChild(el2);
      return el2;
    }
  };
})();

/* === VSP_UI_EXPORT_CI_AND_8TOOLS_V1 === */
window.__VSP_STATUS_CACHE = window.__VSP_STATUS_CACHE || {};
/* === VSP_UI_FIX_ARTLIST_NULL_V1 === */
/* === VSP_UI_4TABS_COMMERCIAL_V1 === */
(function(){
  const API = {
    runsIndex: "/api/vsp/runs_index_v3_fs_resolved?limit=20&hide_empty=0&filter=1",
    statusV2: (rid) => `/api/vsp/run_status_v2/${encodeURIComponent(rid)}`,
    artIndex: (rid) => `/api/vsp/run_artifacts_index_v1/${encodeURIComponent(rid)}`
  };

  const $ = (s, r=document) => r.querySelector(s);
  const $all = (s, r=document) => Array.from(r.querySelectorAll(s));

  async function fetchJSON(url){
    const r = await fetch(url, {headers: {"Accept":"application/json"}});
    if (!r.ok) throw new Error(`HTTP ${r.status} ${url}`);
    return await r.json();
  }

  function normRid(runId){
    if (!runId) return "";
    runId = String(runId).trim();
    if (runId.startsWith("RUN_")) return runId;
    if (runId.startsWith("VSP_CI_")) return "RUN_" + runId;
    return runId;
  }

  function badge(verdict, label){
    const v = (verdict||"").toUpperCase();
    let cls="vsp-badge-muted", dot="vsp-dot-muted", text=v||"N/A";
    if (v==="GREEN"){cls="vsp-badge-green";dot="vsp-dot-green";}
    else if (v==="AMBER"||v==="YELLOW"){cls="vsp-badge-amber";dot="vsp-dot-amber";text="AMBER";}
    else if (v==="RED"){cls="vsp-badge-red";dot="vsp-dot-red";}
    else if (v==="DISABLED"||v==="NOT_RUN"||v==="DEGRADED"){cls="vsp-badge-muted";dot="vsp-dot-muted";text=v;}
    return `<span class="vsp-badge ${cls}" title="${label||""}"><span class="vsp-dot ${dot}"></span>${text}</span>`;
  }

  function setHTML(id, html){ const el=document.getElementById(id); if (el) el.innerHTML=html; }
  function setText(id, txt){ const el=document.getElementById(id); if (el) el.textContent=txt; }

  function tabSwitch(name){
    const tabs = ["dashboard","runs","settings","data"];
    tabs.forEach(t=>{
      const sec = document.getElementById(`tab-${t}`);
      if (sec) sec.style.display = (t===name) ? "" : "none";
    });
    $all("#nav button").forEach(b=>b.classList.toggle("active", b.dataset.tab===name));
    const titleMap = {dashboard:"Dashboard", runs:"Runs & Reports", settings:"Settings", data:"Data Source"};
    setText("page-title", titleMap[name] || "VSP");
  }

  function renderGateByTool(s){
    const rg = s.run_gate_summary || {};
    const bt = rg.by_tool || {};
    const rows = Object.keys(bt).sort().map(k=>{
      const o = bt[k]||{};
      const v = o.verdict || "N/A";
      const total = o.total ?? 0;
      return `<div class="vsp-row" style="margin:8px 0">
        <div style="min-width:92px;font-weight:800">${k}</div>
        <div>${badge(v, k)}</div>
        <div class="vsp-muted">total: <span class="vsp-mono">${total}</span></div>
      </div>`;
    }).join("");
    $("#gate-bytool").innerHTML = rows || `<div class="vsp-muted">No gate summary</div>`;
    setText("gate-ts", rg.ts ? `ts: ${rg.ts}` : "ts: -");
  }

  function updateKpis(s){
    const overall = s.overall_verdict || s.overall || (s.run_gate_summary && s.run_gate_summary.overall) || "N/A";
    const gateOverall = (s.run_gate_summary && (s.run_gate_summary.overall_verdict || s.run_gate_summary.overall)) || overall || "N/A";

    const glV = s.gitleaks_verdict || "NOT_RUN";
    const glT = Number(s.gitleaks_total || 0);

    let cqV = s.codeql_verdict || (s.has_codeql ? "AMBER" : "DISABLED");
    let cqT = Number(s.codeql_total || 0);
    if (!s.has_codeql && (cqV==="GREEN"||cqV==="AMBER"||cqV==="RED")) cqV="DISABLED";

    _vspSetHTMLK("kpi-overall", badge(overall,"status_v2.overall_verdict"));
    _vspSetTextK("kpi-overall-sub", s.rid_norm ? `RID: ${s.rid_norm}` : "");
    _vspSetHTMLK("kpi-gate", badge(gateOverall,"run_gate_summary.overall"));
    _vspSetTextK("kpi-gate-sub", s.run_gate_summary && s.run_gate_summary.ts ? `ts: ${s.run_gate_summary.ts}` : "");
    _vspSetHTMLK("kpi-gitleaks", badge(glV,"gitleaks_verdict"));
    _vspSetTextK("kpi-gitleaks-sub", `total: ${glT}`);
    _vspSetHTMLK("kpi-codeql", badge(cqV,"codeql_verdict"));
    _vspSetTextK("kpi-codeql-sub", `total: ${cqT}`);

    setHTML("pill-overall", badge(overall));
  }

  function updateMeta(s){
    const lines = [
      `rid: ${s.rid || "-"}`,
      `rid_norm: ${s.rid_norm || "-"}`,
      `ci_run_dir: ${s.ci_run_dir || "-"}`,
      `status: ${s.status || "-"}`,
      `stage: ${s.stage_name || "-"}`,
      `degraded_n: ${s.degraded_n ?? (Array.isArray(s.degraded_tools) ? s.degraded_tools.length : 0)}`
    ];
    $("#run-meta").textContent = lines.join("\n");
  }

  async function renderArtifacts(rid){
    try{
      const j = await fetchJSON(API.artIndex(rid));
      const items = j.items || j.artifacts || j.files || [];
      setText("art-count", `count: ${items.length}`);
      const __pa = $("#pill-art"); if(__pa) __pa.textContent = String(items.length);
      const __al=$("#art-list"); if(__al) __al.textContent = items.slice(0,300).map(x=>{
        if (typeof x === "string") return x;
        return x.path || x.name || JSON.stringify(x);
      }).join("\n");
    }catch(e){
      setText("art-count", "count: -");
      const __al=$("#art-list"); if(__al) __al.textContent = String(e);
  }
  }

  async function loadRuns(){
    const idx = await fetchJSON(API.runsIndex);
    const items = idx.items || idx.runs || idx.data || [];
    $("#pill-runs").textContent = String(items.length || 0);

    // build picker
    const optHtml = items.map(it=>{
      const runId = it.run_id || it.id || it.rid || it.rid_norm || it.name || "";
      const rid = normRid(runId);
      return `<option value="${rid}">${rid}</option>`;
    }).join("");
    $("#run-picker").innerHTML = optHtml || `<option value="">(no runs)</option>`;

    // build runs table (with status_v2)
    const tbody = $("#runs-tbody");
    tbody.innerHTML = "";
    for (const it of items.slice(0,20)){
      const runId = it.run_id || it.id || it.rid || it.rid_norm || it.name || "";
      const rid = normRid(runId);
      if (!rid.startsWith("RUN_")) continue;

      let s = null;
      try { s = await fetchJSON(API.statusV2(rid)); } catch(e){ s = null; }

      const overall = s ? (s.overall_verdict || (s.run_gate_summary && s.run_gate_summary.overall) || "N/A") : "N/A";
      const gate = s && s.run_gate_summary ? (s.run_gate_summary.overall || "N/A") : "N/A";
      const glV = s ? (s.gitleaks_verdict || "NOT_RUN") : "N/A";
      const cqV = s ? (s.codeql_verdict || (s.has_codeql ? "AMBER" : "DISABLED")) : "N/A";
      const deg = s ? (s.degraded_n ?? (Array.isArray(s.degraded_tools)?s.degraded_tools.length:0)) : "-";

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="vsp-mono">${rid}</td>
        <td>${badge(overall)}</td>
        <td>${badge(gate)}</td>
        <td>${badge(glV)} <span class="vsp-muted">(t=${(function(){const a=_vsp_pickTool(s,"semgrep");const b=_vsp_pickTool(s,"trivy");const c=_vsp_pickTool(s,"kics");const d=_vsp_pickTool(s,"gitleaks");
      return _vsp_toolBadge("SEMGREP",a.verdict,a.total)+" "+_vsp_toolBadge("TRIVY",b.verdict,b.total)+" "+_vsp_toolBadge("KICS",c.verdict,c.total)+" "+_vsp_toolBadge("GITLEAKS",d.verdict,d.total);})()})</span></td>
        <td>${badge(cqV)} <span class="vsp-muted">(t=${(function(){const a=_vsp_pickTool(s,"codeql");const b=_vsp_pickTool(s,"bandit");const c=_vsp_pickTool(s,"syft");const d=_vsp_pickTool(s,"grype");
      return _vsp_toolBadge("CODEQL",a.verdict,a.total)+" "+_vsp_toolBadge("BANDIT",b.verdict,b.total)+" "+_vsp_toolBadge("SYFT",c.verdict,c.total)+" "+_vsp_toolBadge("GRYPE",d.verdict,d.total);})()})</span></td>
        <td class="vsp-mono">${deg}</td>
      `;
      tr.style.cursor="pointer";
      tr.addEventListener("click", async ()=>{
        $("#run-picker").value = rid;
        await loadOne(rid);
        tabSwitch("dashboard");
      });
      tbody.appendChild(tr);
    }
  }

  async function loadOne(rid){
    if (!rid) return;
    let s = null;
    try { s = await fetchJSON(API.statusV2(rid)); } catch(e){ s = null; }
    if (!s){
      setText("run-meta", "cannot load status_v2");
      return;
    }
    updateKpis(s);
    renderGateByTool(s);
    updateMeta(s);
    window.__VSP_STATUS_CACHE[rid]=s;
await renderArtifacts(rid);
    await _vsp_setup_export_links(rid);
    await _vsp_render_datasource(rid, s);
  }

  function loadSettingsUi(){
    const key = (k)=>`vsp_ui_set_${k}`;
    const enable = localStorage.getItem(key("ENABLE_CODEQL")) ?? "1";
    const tCodeql = localStorage.getItem(key("TIMEOUT_CODEQL")) ?? "3600s";
    const tKics = localStorage.getItem(key("TIMEOUT_KICS")) ?? "1800s";
    $("#set-enable-codeql").value = enable;
    $("#set-timeout-codeql").value = tCodeql;
    $("#set-timeout-kics").value = tKics;

    $("#set-enable-codeql").addEventListener("change", ()=>localStorage.setItem(key("ENABLE_CODEQL"), $("#set-enable-codeql").value));
    $("#set-timeout-codeql").addEventListener("change", ()=>localStorage.setItem(key("TIMEOUT_CODEQL"), $("#set-timeout-codeql").value));
    $("#set-timeout-kics").addEventListener("change", ()=>localStorage.setItem(key("TIMEOUT_KICS"), $("#set-timeout-kics").value));
  }

  function bootNav(){
    $all("#nav button").forEach(b=>{
      b.addEventListener("click", ()=>{
        tabSwitch(b.dataset.tab);
      });
    });
    $("#btn-refresh").addEventListener("click", async ()=>{
      await loadRuns();
      const rid = $("#run-picker").value;
      if (rid) await loadOne(rid);
    await _vsp_setup_export_links(rid);
  });
    $("#run-picker").addEventListener("change", async ()=>{
      const rid = $("#run-picker").value;
      if (rid) await loadOne(rid);
    });
  }

/* === VSP_UI_4TABS_EXPORT_DS_V1 === */
async function _vsp_try_head(url){
  try{
    const r = await fetch(url, {method:"HEAD"});
    if (r.ok) return true;
  }catch(e){}
  try{
    const r2 = await fetch(url, {method:"GET", headers: {"Range":"bytes=0-0"}});
    if (r2.ok) return true;
  }catch(e){}
  return false;
}

async function _vsp_probe_first(urls){
  for (const u of urls){
    if (await _vsp_try_head(u)) return u;
  }
  return null;
}

function _vsp_disable_link(a, reason){
  if (!a) return;
  a.href = "#";
  a.style.opacity = "0.45";
  a.style.pointerEvents = "none";
  if (reason) a.title = reason;
}

function _vsp_pretty(obj){
  try { return JSON.stringify(obj, null, 2); } catch(e){ return String(obj); }
}

// try to fetch an artifact file by probing common endpoints
async function _vsp_fetch_artifact_text(rid, path){
  const qp = encodeURIComponent(path);
  const cands = [
    `/api/vsp/run_artifact_v1/${encodeURIComponent(rid)}?path=${qp}`,
    `/api/vsp/run_artifact_get_v1/${encodeURIComponent(rid)}?path=${qp}`,
    `/api/vsp/run_artifacts_get_v1/${encodeURIComponent(rid)}?path=${qp}`,
    `/api/vsp/artifact_get_v1/${encodeURIComponent(rid)}?path=${qp}`,
    `/api/vsp/run_artifact_v1/${encodeURIComponent(rid)}?p=${qp}`,
    `/api/vsp/run_artifact_get_v1/${encodeURIComponent(rid)}?p=${qp}`,
  ];
  for (const u of cands){
    try{
      const r = await fetch(u, {headers: {"Accept":"text/plain,application/json,*/*"}});
      if (!r.ok) continue;
      const txt = await r.text();
      // heuristic: not an HTML error page
      if ((txt||"").trim().startsWith("<!DOCTYPE html") || (txt||"").includes("HTTP_404")) continue;
      return {ok:true, url:u, text:txt};
    }catch(e){}
  }
  return {ok:false, url:null, text:null};
}

function _vsp_parse_csv_preview(csvText, limitRows=50){
  const lines = (csvText||"").split(/\r?\n/).filter(x=>x.trim().length>0);
  if (!lines.length) return {cols:[], rows:[]};
  // naive CSV split (good enough for preview)
  const split = (s)=> {
    const out=[]; let cur=""; let q=false;
    for (let i=0;i<s.length;i++){
      const ch=s[i];
      if (ch === '"' ){ q = !q; continue; }
      if (ch === "," && !q){ out.push(cur); cur=""; continue; }
      cur+=ch;
    }
    out.push(cur);
    return out.map(x=>x.trim());
  };
  const cols = split(lines[0]).slice(0,40);
  const rows = [];
  for (let i=1;i<lines.length && rows.length<limitRows;i++){
    rows.push(split(lines[i]).slice(0,40));
  }
  return {cols, rows};
}

function _vsp_render_findings_table(cols, rows){
  const head = document.getElementById("ds-findings-head");
  const body = document.getElementById("ds-findings-body");
  if (!head || !body) return;

  head.innerHTML = "";
  body.innerHTML = "";

  cols.slice(0,14).forEach(c=>{
    const th = document.createElement("th");
    th.textContent = c;
    head.appendChild(th);
  });

  rows.slice(0,80).forEach(r=>{
    const tr = document.createElement("tr");
    cols.slice(0,14).forEach((_,i)=>{
      const td = document.createElement("td");
      td.textContent = (r[i] ?? "");
      tr.appendChild(td);
    });
    body.appendChild(tr);
  });
}

async function _vsp_setup_export_links(selectedRid){
  const aHtml = document.getElementById("btn-exp-html");
  const aPdf  = document.getElementById("btn-exp-pdf");
  const aZip  = document.getElementById("btn-exp-zip");
  const aArt  = document.getElementById("btn-open-artindex");
  const hint  = document.getElementById("exp-hint");

  if (!aHtml && !aPdf && !aZip) return;

  if (!selectedRid){
    _vsp_disable_link(aHtml,"no run");
    _vsp_disable_link(aPdf,"no run");
    _vsp_disable_link(aZip,"no run");
    _vsp_disable_link(aArt,"no run");
    if (hint) hint.textContent = "no selected run";
    return;
  }

  
  const __st = (window.__VSP_STATUS_CACHE||{})[selectedRid] || null;
  const __ci = (__st && (__st.ci_run_dir || __st.ci || __st.run_dir)) ? String(__st.ci_run_dir || __st.ci || __st.run_dir) : "";
  const __ciQ = __ci ? `&ci=${encodeURIComponent(__ci)}` : "";
// artifacts index always exists
  if (aArt){
    aArt.href = `/api/vsp/run_artifacts_index_v1/${encodeURIComponent(selectedRid)}`;
    aArt.style.opacity = "1";
    aArt.style.pointerEvents = "auto";
  }

  // probe export endpoints (several shapes)
  const mk = (fmt)=>[
    `/api/vsp/run_export_v3/${encodeURIComponent(selectedRid)}?fmt=${fmt}${String(__ciQ||"").replace(/^\?/, "&")}`,
    `/api/vsp/run_export_v3/${encodeURIComponent(selectedRid)}?format=${fmt}${String(__ciQ||"").replace(/^\?/, "&")}`,
    `/api/vsp/run_export_v3?rid=${encodeURIComponent(selectedRid)}&fmt=${fmt}${String(__ciQ||"").replace(/^\?/, "&")}`,
    `/api/vsp/run_export_v3?run_id=${encodeURIComponent(selectedRid)}&fmt=${fmt}${String(__ciQ||"").replace(/^\?/, "&")}`,
    `/api/vsp/run_export_v3?rid=${encodeURIComponent(selectedRid)}&format=${fmt}${String(__ciQ||"").replace(/^\?/, "&")}`,
  ];

  const uHtml = await _vsp_probe_first(mk("html"));
  const uPdf  = await _vsp_probe_first(mk("pdf"));
  const uZip  = await _vsp_probe_first(mk("zip"));

  if (uHtml){ aHtml.href=uHtml; aHtml.style.opacity="1"; aHtml.style.pointerEvents="auto"; }
  else _vsp_disable_link(aHtml,"export html not available");

  if (uPdf){ aPdf.href=uPdf; aPdf.style.opacity="1"; aPdf.style.pointerEvents="auto"; }
  else _vsp_disable_link(aPdf,"export pdf not available");

  if (uZip){ aZip.href=uZip; aZip.style.opacity="1"; aZip.style.pointerEvents="auto"; }
  else _vsp_disable_link(aZip,"export zip not available");

  if (hint){
    hint.textContent = `rid=${selectedRid} • export: ${uHtml?'HTML':'-'} ${uPdf?'PDF':'-'} ${uZip?'ZIP':'-'}`
  }
}

async function _vsp_render_datasource(rid, statusV2Obj){
  const boxS = document.getElementById("ds-statusv2");
  const boxA = document.getElementById("ds-artjson");
  const hint = document.getElementById("ds-findings-hint");

  if (boxS) boxS.textContent = _vsp_pretty(statusV2Obj || {});
  if (!rid) return;

  // artifacts index JSON
  let art = null;
  try{
    art = await fetchJSON(`/api/vsp/run_artifacts_index_v1/${encodeURIComponent(rid)}`);
    if (boxA) boxA.textContent = _vsp_pretty(art);
  }catch(e){
    if (boxA) boxA.textContent = String(e);
    if (hint) hint.textContent = "cannot load artifacts index";
    return;
  }

  // find candidate findings files from artifacts list
  const items = art.items || art.artifacts || art.files || [];
  const paths = items.map(x => (typeof x === "string") ? x : (x.path || x.name || "")).filter(Boolean);

  const pick = (needle)=> paths.find(p => p.toLowerCase().includes(needle));
  const csvPath = pick("findings_unified.csv") || pick("findings.csv") || pick("findings_unified");
  const jsonPath = pick("findings_unified.json") || pick("findings.json");

  if (!csvPath && !jsonPath){
    if (hint) hint.textContent = "no findings_unified.* in artifacts index";
    return;
  }

  // try csv first for table preview
  if (csvPath){
    if (hint) hint.textContent = `trying csv: ${csvPath}`;
    const r = await _vsp_fetch_artifact_text(rid, csvPath);
    if (r.ok){
      const pv = _vsp_parse_csv_preview(r.text, 60);
      _vsp_render_findings_table(pv.cols, pv.rows);
      if (hint) hint.textContent = `preview from CSV ✓ via ${r.url}`;
      return;
    }
  }

  // fallback json
  if (jsonPath){
    if (hint) hint.textContent = `trying json: ${jsonPath}`;
    const r = await _vsp_fetch_artifact_text(rid, jsonPath);
    if (r.ok){
      let obj = null;
      try{ obj = JSON.parse(r.text); }catch(e){ obj=null; }
      if (obj && Array.isArray(obj.items)) obj = obj.items;
      // render columns from first item keys
      const rows = Array.isArray(obj) ? obj.slice(0,60) : [];
      const cols = rows[0] ? Object.keys(rows[0]).slice(0,14) : [];
      const tableRows = rows.map(o => cols.map(c => (o && o[c] !== undefined) ? String(o[c]) : ""));
      _vsp_render_findings_table(cols, tableRows);
      if (hint) hint.textContent = `preview from JSON ✓ via ${r.url}`;
      return;
    }
  }

  if (hint) hint.textContent = "cannot fetch findings file (no artifact download endpoint found)";
}

function _vsp_normVerd(v){
  const s = (v||"").toString().toUpperCase();
  if (!s) return "N/A";
  return s;
}
function _vsp_toolBadge(name, verdict, total){
  const v = _vsp_normVerd(verdict);
  const cls = (v==="RED"||v==="CRITICAL"||v==="HIGH") ? "pill red"
            : (v==="AMBER"||v==="MEDIUM") ? "pill amber"
            : (v==="GREEN"||v==="LOW"||v==="OK") ? "pill green"
            : (v==="DEGRADED") ? "pill amber"
            : (v==="DISABLED"||v==="NOT_RUN") ? "pill gray"
            : "pill gray";
  const tt = `${name}: ${v} (${total??0})`;
  return `<span class="${cls}" title="${tt}">${name} <span class="vsp-muted">(${total??0})</span></span>`;
}
function _vsp_pickTool(s, key){
  // allow either flat fields or *_summary
  if (!s) return {verdict:"N/A", total:0};
  const up = key.toUpperCase();
  // run_gate_summary.by_tool preferred
  const gate = (s.run_gate_summary && s.run_gate_summary.by_tool) ? s.run_gate_summary.by_tool : null;
  if (gate && gate[up]) return {verdict: gate[up].verdict||"N/A", total: gate[up].total||0};
  // direct fields
  const v1 = s[`${key}_verdict`];
  const t1 = s[`${key}_total`];
  if (v1 !== undefined || t1 !== undefined) return {verdict: v1||"N/A", total: (t1||0)};
  // summary object
  const sum = s[`${key}_summary`];
  if (sum && typeof sum === "object") return {verdict: sum.verdict||sum.status||"N/A", total: sum.total||0};
  // special known: codeql in our wrapper
  if (key==="codeql"){
    return {verdict: s.codeql_verdict||"NOT_RUN", total: s.codeql_total||0};
  }
  if (key==="gitleaks"){
    return {verdict: s.gitleaks_verdict||"NOT_RUN", total: s.gitleaks_total||0};
  }
  return {verdict:"NOT_RUN", total:0};
}


async function boot(){
    bootNav();
    loadSettingsUi();
    await loadRuns();
    const rid = $("#run-picker").value;
    if (rid) await loadOne(rid);
  }

  if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", boot);
  else boot();
})();

// === VSP_P2_FIX_EXPORT_CIQ_V1 ===
// patched run_export_v3 candidate URLs to normalize __ciQ leading '?'



// === VSP_UI_GATE_SUMMARY_ALWAYS8_V1 ===
(function(){
  'use strict';

  const CANON = ["SEMGREP","GITLEAKS","TRIVY","CODEQL","KICS","GRYPE","SYFT","BANDIT"];

  function esc(s){ return String(s||"").replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c])); }
  function pick(obj, keys){ for(const k of keys){ if(obj && obj[k] != null) return obj[k]; } return null; }

  function normalizeToolEntry(t, entry){
    entry = entry || {};
    const verdict = String(pick(entry, ["verdict","status"]) || "NOT_RUN").toUpperCase();
    const total = Number(pick(entry, ["total","n","count"]) || 0) || 0;
    return { tool: t, verdict, total };
  }

  function buildListFromStatus(status){
    status = status || {};
    const tools = status.tools || null;
    const order = status.tools_order || CANON;
    const out = [];

    // Prefer .tools (new backend)
    if (tools && typeof tools === "object") {
      for (const t of order) out.push(normalizeToolEntry(t, tools[t]));
      return out;
    }

    // Fallback: legacy run_gate_summary
    const gs = status.run_gate_summary || {};
    if (gs && typeof gs === "object") {
      for (const t of order) out.push(normalizeToolEntry(t, gs[t]));
      return out;
    }

    // Last fallback: legacy 4 tools flat fields
    const legacyMap = {
      "SEMGREP": { verdict: status.semgrep_verdict, total: status.semgrep_total },
      "GITLEAKS": { verdict: status.gitleaks_verdict, total: status.gitleaks_total },
      "TRIVY": { verdict: status.trivy_verdict, total: status.trivy_total },
      "CODEQL": { verdict: status.codeql_verdict, total: status.codeql_total }
    };
    for (const t of CANON) out.push(normalizeToolEntry(t, legacyMap[t] || {}));
    return out;
  }

  function badgeClass(v){
    v = String(v||"").toUpperCase();
    if (v === "RED" || v === "FAIL" || v === "CRITICAL") return "vsp-badge vsp-badge-red";
    if (v === "AMBER" || v === "WARN" || v === "HIGH") return "vsp-badge vsp-badge-amber";
    if (v === "GREEN" || v === "OK" || v === "PASS") return "vsp-badge vsp-badge-green";
    if (v === "DEGRADED") return "vsp-badge vsp-badge-amber";
    return "vsp-badge vsp-badge-gray";
  }

  function renderGateSummaryAlways8(status){
    const host = document.querySelector("#vsp-gate-summary, #gate-summary, [data-vsp='gate-summary']");
    if (!host) return false;

    const list = buildListFromStatus(status);
    const rows = list.map(x => {
      const t = esc(x.tool);
      const v = esc(x.verdict);
      const n = esc(x.total);
      return `
        <div class="vsp-gs-row" data-vsp-drill-tool="${t}">
          <div class="vsp-gs-tool vsp-pill" data-vsp-drill-tool="${t}">${t}</div>
          <div class="${badgeClass(v)} vsp-pill" data-vsp-drill-tool="${t}">${v}</div>
          <div class="vsp-gs-total vsp-pill" data-vsp-drill-tool="${t}">${n}</div>
        </div>
      `;
    }).join("");

    host.innerHTML = `
      <div class="vsp-gs-head">
        <div class="vsp-gs-col">TOOL</div>
        <div class="vsp-gs-col">VERDICT</div>
        <div class="vsp-gs-col">TOTAL</div>
      </div>
      <div class="vsp-gs-body">${rows}</div>
    `;

    return true;
  }

  // Hook: if your code already has a function that receives status JSON, we wrap it.
  function wrapStatusConsumer(){
    const names = ["VSP_UI_APPLY_STATUS", "vspApplyStatus", "renderRunStatus", "updateStatusUI"];
    for (const n of names){
      if (typeof window[n] === "function" && !window[n].__vsp_wrapped__) {
        const orig = window[n];
        window[n] = function(status){
          try { renderGateSummaryAlways8(status); } catch(_){}
          return orig.apply(this, arguments);
        };
        window[n].__vsp_wrapped__ = true;
        console.log("[VSP][UI] wrapped status consumer:", n);
        return;
      }
    }
    // fallback: poll global last status if exists
    try {
      if (window.VSP_LAST_STATUS && !window.__VSP_GATE8_TICK__) {
        window.__VSP_GATE8_TICK__ = setInterval(()=>{ try { renderGateSummaryAlways8(window.VSP_LAST_STATUS); } catch(_){} }, 1200);
      }
    } catch(_){}
  }

  // Ensure a container exists (non-breaking)
  function ensureHost(){
    let host = document.querySelector("#vsp-gate-summary");
    if (host) return;
    const dash = document.querySelector("#vsp-dashboard-main");
    if (!dash) return;
    host = document.createElement("div");
    host.id = "vsp-gate-summary";
    host.style.marginTop = "10px";
    dash.appendChild(host);
  }

  function onReady(fn){
    if (document.readyState === "complete" || document.readyState === "interactive") return setTimeout(fn, 0);
    document.addEventListener("DOMContentLoaded", fn, { once:true });
  }

  onReady(()=>{ try { ensureHost(); } catch(_){} });
  onReady(()=>{ try { wrapStatusConsumer(); } catch(_){} });

})();


/* === VSP_SILENCE_EXPORT_HEAD_PROBE_V1 ===
 * Fix commercial UX: stop console noise caused by HEAD probes to /api/vsp/run_export_v3/*
 * We only intercept HEAD (probe). Real export clicks (usually GET via navigation) are not touched.
 */
(function(){
  try{
    const _fetch = window.fetch ? window.fetch.bind(window) : null;
    if (!_fetch) return;

    window.fetch = function(input, init){
      try{
        const url = String(input || "");
        const method = String((init && init.method) || "GET").toUpperCase();
        if (method === "HEAD" && url.indexOf("/api/vsp/run_export_v3/") >= 0){
          // Return 200 + header available=0 so UI can hide/disable without throwing 404.
          return Promise.resolve(new Response("", {
            status: 200,
            headers: {
              "X-VSP-EXPORT-AVAILABLE": "0",
              "Content-Type": "application/json"
            }
          }));
        }
      }catch(e){}
      return _fetch(input, init);
    };
  }catch(e){}
})();
 /* === /VSP_SILENCE_EXPORT_HEAD_PROBE_V1 === */

/* VSP_FETCH_DEDUPE_SHIM_P1_V1_BEGIN */
(function(){
  'use strict';
  if (window.__VSP_FETCH_DEDUPE_SHIM_P1_V1) return;
  window.__VSP_FETCH_DEDUPE_SHIM_P1_V1 = true;

  const origFetch = window.fetch ? window.fetch.bind(window) : null;
  if (!origFetch) return;

  const cache = new Map();     // url -> {status, ctype, body}
  const inflight = new Map();  // url -> Promise<{status,ctype,body}>

  function urlOf(input){
    try { return (typeof input === "string") ? input : (input && input.url) ? input.url : ""; }
    catch(_e){ return ""; }
  }

  function shouldCache(url){
    if (!url) return false;
    if (url.includes("__nocache=1")) return false;
    // cache/dedupe only the noisy + safe GET JSON endpoints
    return (
      url.includes("/api/vsp/runs_index_v3_fs_resolved") ||
      url.includes("/api/vsp/run_status_v2/") ||
      url.includes("/api/vsp/dashboard_v3")
    );
  }

  function cloneResponseFrom(entry){
    return new Response(entry.body, {
      status: entry.status || 200,
      headers: { "Content-Type": entry.ctype || "application/json" }
    });
  }

  async function fetchAndStore(input, init, url){
    const res = await origFetch(input, init);
    try{
      const c = res.clone();
      const body = await c.text();
      const ctype = c.headers.get("content-type") || "application/json";
      const entry = { status: c.status, ctype, body };
      cache.set(url, entry);
      return entry;
    }catch(_e){
      // if clone fails, don't cache
      return null;
    }
  }

  window.fetch = function(input, init){
    const url = urlOf(input);
    const method = (init && init.method) ? String(init.method).toUpperCase() : "GET";
    if (method !== "GET" || !shouldCache(url)) {
      return origFetch(input, init);
    }

    if (cache.has(url)) {
      return Promise.resolve(cloneResponseFrom(cache.get(url)));
    }

    if (inflight.has(url)) {
      return inflight.get(url).then(entry => entry ? cloneResponseFrom(entry) : origFetch(input, init));
    }

    const p = fetchAndStore(input, init, url)
      .finally(() => inflight.delete(url));

    inflight.set(url, p);

    return origFetch(input, init); // return real response for first caller
  };

  console.log("[VSP_FETCH_DEDUPE_SHIM_P1_V1] enabled");
})();
/* VSP_FETCH_DEDUPE_SHIM_P1_V1_END */




/* === VSP_4TABS_KPI_FROM_EXTRAS_P1_V2 (observer+retry) === */
(function(){
  if(window.__VSP_4TABS_KPI_FROM_EXTRAS_P1_V2) return;
  window.__VSP_4TABS_KPI_FROM_EXTRAS_P1_V2 = 1;

  function normRid(x){
    try{
      x = String(x||"").trim();
      x = x.replace(/^RUN[_\-\s]+/i, "");
      x = x.replace(/^RID[:\s]+/i, "");
      const m = x.match(/(VSP_CI_\d{8}_\d{6})/i);
      if(m && m[1]) return m[1];
      return x.replace(/\s+/g,"_");
    }catch(_){ return ""; }
  }

  function getRid(){
    try{
      const st = window.__VSP_RID_STATE__ || window.__VSP_RID_STATE || window.VSP_RID_STATE || window.__vsp_rid_state;
      if(st){
        if(st.rid || st.run_id) return normRid(st.rid || st.run_id);
        if(st.state && (st.state.rid || st.state.run_id)) return normRid(st.state.rid || st.state.run_id);
        if(typeof st.get === "function"){
          const v = st.get();
          if(v && (v.rid || v.run_id)) return normRid(v.rid || v.run_id);
        }
      }
    }catch(_){}
    try{
      const t = document.body ? (document.body.innerText || "") : "";
      const m = t.match(/RID:\s*(VSP_CI_\d{8}_\d{6})/i);
      if(m && m[1]) return normRid(m[1]);
    }catch(_){}
    return "";
  }

  function setText(id, v){
    const el = document.getElementById(id);
    if(!el) return false;
    el.textContent = (v===0) ? "0" : (v ? String(v) : "—");
    return true;
  }

  function fmtBySev(bySev){
    if(!bySev) return "";
    const order = ["CRITICAL","HIGH","MEDIUM","LOW","INFO","TRACE"];
    const out = [];
    for(const k of order){
      if(bySev[k] !== undefined) out.push(k[0] + ":" + bySev[k]);
    }
    return out.join(" ");
  }

  function pickTool(byTool, want){
    if(!byTool) return null;
    if(byTool[want] !== undefined) return byTool[want];
    const key = Object.keys(byTool).find(k => String(k||"").toUpperCase() === want.toUpperCase());
    return key ? byTool[key] : null;
  }

  function tryApply(j){
    if(!j || !j.kpi) return false;
    // === VSP_EXTRAS_READER_USE_KPI_ROOT_P1_V1 ===
    const k = (j && j.kpi) ? j.kpi : {};
    // prefer kpi.* (our API returns only {ok,rid,sources,kpi})
    const byTool = (k && (k.by_tool || k.byTool)) || (j && (j.by_tool || j.byTool)) || {};
    const bySev  = (k && (k.by_sev  || k.bySev))  || (j && (j.by_sev  || j.bySev))  || {};
    const topCwe = (k && (k.top_cwe || k.topCwe)) || (j && (j.top_cwe || j.topCwe)) || [];


    const total = k.total ?? 0;
    const eff   = k.effective ?? 0;
    const degr  = k.degraded ?? 0;
    const unk   = k.unknown_count ?? 0;
    const score = (k.score===undefined || k.score===null) ? "" : k.score;

    const verdict = (degr > 0) ? "DEGRADED" : (total > 0 ? "OK" : "EMPTY");
    const gateTxt = (score !== "") ? (String(score) + "/100") : verdict;

    let ok = 0;
    ok += _vspSetTextK("kpi-overall", verdict) ? 1 : 0;
    ok += _vspSetTextK("kpi-overall-sub", `total ${total} | eff ${eff} | degr ${degr} | unk ${unk}`) ? 1 : 0;

    ok += _vspSetTextK("kpi-gate", gateTxt) ? 1 : 0;
    ok += _vspSetTextK("kpi-gate-sub", fmtBySev(bySev)) ? 1 : 0;

    const gtl = pickTool(byTool, "GITLEAKS");
    const cql = pickTool(byTool, "CODEQL");
    ok += _vspSetTextK("kpi-gitleaks", (gtl===null) ? "NOT_RUN" : gtl) ? 1 : 0;
    ok += _vspSetTextK("kpi-gitleaks-sub", "GITLEAKS") ? 1 : 0;
    ok += _vspSetTextK("kpi-codeql", (cql===null) ? "NOT_RUN" : cql) ? 1 : 0;
    ok += _vspSetTextK("kpi-codeql-sub", "CODEQL") ? 1 : 0;

    // success if at least the main 2 cards exist
    return ok >= 2;
  }

  function scheduleApply(){
    const j = window.__VSP_LAST_DASH_EXTRAS_J;
    if(!j) return;

    const delays = [0, 120, 300, 800, 1500, 2500];
    for(const d of delays){
      setTimeout(() => { tryApply(j); }, d);
    }

    // observe DOM until KPI nodes appear
    try{
      if(window.__VSP_KPI_OBSERVER_V2) return;
      const obs = new MutationObserver(() => {
        const done = tryApply(j);
        if(done){
          try{ obs.disconnect(); }catch(_){}
          window.__VSP_KPI_OBSERVER_V2 = null;
        }
      });
      obs.observe(document.documentElement || document.body, {childList:true, subtree:true});
      window.__VSP_KPI_OBSERVER_V2 = obs;
    }catch(_){}
  }

  async function fetchExtras(rid){
    const u = "/api/vsp/dashboard_v3_extras_v1?rid=" + encodeURIComponent(rid);
    try{
      const r = await fetch(u, {cache:"no-store"});
      if(!r.ok) return null;
      const j = await r.json();
      return (j && j.ok) ? j : null;
    }catch(_){}
    return null;
  }

  let lastRid = "";
  async function hydrate(force){
    const rid = getRid();
    if(!rid) return;
    if(!force && rid === lastRid) return;
    lastRid = rid;

    const j = await fetchExtras(rid);
    if(!j) return;

    window.__VSP_LAST_DASH_EXTRAS_RID = rid;
    window.__VSP_LAST_DASH_EXTRAS_J = j;

    // try immediately, and also schedule retry until DOM ready
    tryApply(j);
    scheduleApply();
  }

  window.addEventListener("hashchange", () => setTimeout(() => hydrate(true), 150));
  setTimeout(() => hydrate(true), 250);
  setInterval(() => hydrate(false), 2000);
})();


// VSP_KPI_HYDRATOR_RID_FALLBACK_P1_V1



/* === VSP_KPI_STANDALONE_FROM_FINDINGS_V2_P1_V1 ===
   Standalone hydrator that DOES NOT rely on DOMContentLoaded timing or internal module scope.
   Source of truth: /api/vsp/findings_unified_v2/<rid>?limit=1  (counts + total)
*/
(function(){
  if (window.__VSP_KPI_STANDALONE_V2_P1__) return;
  window.__VSP_KPI_STANDALONE_V2_P1__ = 1;

  function normRid(x){
    try{
      x = String(x||"").trim();
      x = x.replace(/^RUN[_\-\s]+/i,"").replace(/^RID[:\s]+/i,"");
      var m = x.match(/(VSP_CI_\d{8}_\d{6})/i);
      return (m && m[1]) ? m[1] : x.replace(/\s+/g,"_");
    }catch(_){ return ""; }
  }

  function ridFromState(){
    try{
      var st = window.__VSP_RID_STATE__ || window.__VSP_RID_STATE || window.VSP_RID_STATE || window.__vsp_rid_state;
      if(!st) return "";
      if (st.rid || st.run_id) return normRid(st.rid || st.run_id);
      if (st.state && (st.state.rid || st.state.run_id)) return normRid(st.state.rid || st.state.run_id);
      if (typeof st.get === "function"){
        var v = st.get();
        if (v && (v.rid || v.run_id)) return normRid(v.rid || v.run_id);
      }
    }catch(_){}
    try{
      // fallback: read RID from page text (header shows "RID: VSP_CI_...")
      var txt = (document && document.body && (document.body.innerText||"")) ? document.body.innerText : "";
      var mm = txt.match(/RID:\s*(VSP_CI_\d{8}_\d{6})/i);
      if(mm && mm[1]) return normRid(mm[1]);
    }catch(_){}

    return "";
  }

  async function fetchLatestRid(){
    try{
      var u="/api/vsp/runs_index_v3_fs_resolved?limit=1&hide_empty=0&filter=1";
      var r=await fetch(u,{cache:"no-store"});
      if(!r.ok) return "";
      var j=await r.json();
      var it=(j && j.items && j.items[0]) ? j.items[0] : null;
      return normRid(it ? (it.run_id || it.rid || "") : "");
    }catch(_){ return ""; }
  }

  async function fetchFindingsCounts(rid){
    try{
      if(!rid) return null;
      var u="/api/vsp/findings_unified_v2/"+encodeURIComponent(rid)+"?limit=1";
      var r=await fetch(u,{cache:"no-store"});
      if(!r.ok) return null;
      var j=await r.json();
      if(!j || !j.ok) return null;
      return j;
    }catch(_){ return null; }
  }

  function fmtBySev(bySev){
    if(!bySev) return "";
    var order=["CRITICAL","HIGH","MEDIUM","LOW","INFO","TRACE"];
    var out=[];
    for (var i=0;i<order.length;i++){
      var k=order[i];
      if (bySev[k] !== undefined) out.push(k[0]+":"+bySev[k]);
    }
    return out.join(" ");
  }

  function pickTool(byTool, want){
    if(!byTool) return null;
    if (byTool[want] !== undefined) return byTool[want];
    var keys=Object.keys(byTool);
    for (var i=0;i<keys.length;i++){
      if (String(keys[i]||"").toUpperCase() === String(want||"").toUpperCase()) return byTool[keys[i]];
    }
    return null;
  }

  function setText(id, v){
    try{
      if (typeof window._vspSetTextK === "function") return window._vspSetTextK(id, v);
    }catch(_){}
    // fallback
    try{
      var el=document.getElementById(id);
      if(!el) return false;
      el.textContent = (v===0) ? "0" : (v ? String(v) : "—");
      return true;
    }catch(_){ return false; }
  }
  // === VSP_KPI_STANDALONE_DEBUG_DOMRID_P1_V2 ===
function applyFromUnified(j){
    if(!j) return false;
    var total = (j.total !== undefined && j.total !== null) ? j.total : 0;
    var c = j.counts || {};
    var bySev = c.by_sev || {};
    var byTool = c.by_tool || {};
    var unk = (c.unknown_count !== undefined && c.unknown_count !== null) ? c.unknown_count : 0;
    var eff = Math.max(0, total - unk);
    var degr = Math.max(0, unk);

    var score = (total>0) ? Math.round((eff/Math.max(1,total))*100) : 0;
    var verdict = (degr>0) ? "DEGRADED" : (total>0 ? "OK" : "EMPTY");
    var gateTxt = String(score) + "/100";

    var gtl = pickTool(byTool,"GITLEAKS");
    var cql = pickTool(byTool,"CODEQL");

    var ok=0;
    ok += setText("kpi-overall", verdict) ? 1:0;
    ok += setText("kpi-overall-sub", "total "+total+" | eff "+eff+" | degr "+degr+" | unk "+unk) ? 1:0;
    ok += setText("kpi-gate", gateTxt) ? 1:0;
    ok += setText("kpi-gate-sub", fmtBySev(bySev)) ? 1:0;

    ok += setText("kpi-gitleaks", (gtl===null) ? "NOT_RUN" : gtl) ? 1:0;
    ok += setText("kpi-gitleaks-sub", "GITLEAKS") ? 1:0;
    ok += setText("kpi-codeql", (cql===null) ? "NOT_RUN" : cql) ? 1:0;
    ok += setText("kpi-codeql-sub", "CODEQL") ? 1:0;

    return ok>=2;
  }

  async function tick(){
try{
      var rid = ridFromState();
      if(!rid) rid = await fetchLatestRid();
      if(!rid) return;

      var j = await fetchFindingsCounts(rid);
      if(!j) return;

      applyFromUnified(j);
    }catch(_){}
  }

  // Start immediately (works even if script loads after DOMContentLoaded)
  try{ tick(); }catch(_){}
  try{ setTimeout(tick, 250); }catch(_){}
  try{ setTimeout(tick, 800); }catch(_){}
  try{ setInterval(tick, 2000); }catch(_){}
})();




/* === VSP_KPI_STICKY_LOCK_P1_V1 ===
   After standalone writes KPI values, prevent other modules from overwriting via _vspSetTextK/_vspSetHTMLK.
*/
(function(){
  if (window.__VSP_KPI_STICKY_LOCKED__) return;
  window.__VSP_KPI_STICKY_LOCKED__ = 1;

  var IDS = ["kpi-overall","kpi-overall-sub","kpi-gate","kpi-gate-sub","kpi-gitleaks","kpi-gitleaks-sub","kpi-codeql","kpi-codeql-sub"];

  function el(id){ try{return document.getElementById(id);}catch(_){return null;} }
  function hasValue(e){
    try{
      var t=(e && (e.textContent||"") || "").trim();
      if(!t) return false;
      var u=t.toUpperCase();
      return (t !== "…" && t !== "—" && u !== "N/A");
    }catch(_){ return false; }
  }
  function stable(id){
    var e=el(id);
    try{ return !!(e && e.getAttribute("data-vsp-kpi-stable")==="1" && hasValue(e)); }catch(_){ return false; }
  }
  function markStable(){
    for (var i=0;i<IDS.length;i++){
      var id = IDS[i];
      var e = el(id);
      try{
        if(!e) continue;
        if(!hasValue(e)) continue;
        var t = (e.textContent||"").trim();
        var u = t.toUpperCase();
        // don't lock placeholders/debug
        if(u==="N/A" || t==="…" || t==="—") continue;
        if(u==="BOOT") continue;
        if(t.indexOf("tick ")===0) continue;
        e.setAttribute("data-vsp-kpi-stable","1");
      }catch(_){}
    }
  }

  // Wrap setters (if exist)
  var _origText = window._vspSetTextK;
  var _origHTML = window._vspSetHTMLK;

  if (typeof _origText === "function" && !window.__VSP_SET_TEXTK_WRAPPED__){
    window.__VSP_SET_TEXTK_WRAPPED__ = 1;
    window._vspSetTextK = function(id, v){
      try{ if(stable(id)) return false; }catch(_){}
      return _origText(id, v);
    };
  }
  if (typeof _origHTML === "function" && !window.__VSP_SET_HTMLK_WRAPPED__){
    window.__VSP_SET_HTMLK_WRAPPED__ = 1;
    window._vspSetHTMLK = function(id, v){
      try{ if(stable(id)) return false; }catch(_){}
      return _origHTML(id, v);
    };
  }

  // Mark stable periodically (SPA can re-mount)
  try{
    setTimeout(markStable, 200);
    setTimeout(markStable, 800);
    setInterval(markStable, 2000);
  }catch(_){}
})();


// VSP_KPI_STANDALONE_DEBUG_DOMRID_P1_V2



/* === VSP_KPI_HYDRATOR_CANON_P1_V1 ===
   Canonical KPI hydrator:
   - RID from __VSP_RID_STATE__ OR DOM "RID:" OR hash
   - KPI from /api/vsp/dashboard_v3_extras_v1?rid=...
   - Tool+Sev from /api/vsp/findings_unified_v2/<rid>?limit=1
   - Writes #kpi-overall/#kpi-gate/#kpi-gitleaks/#kpi-codeql (+sub)
*/
;(function(){
  'use strict';

  function _el(id){ try{ return document.getElementById(id); }catch(_){ return null; } }
  function _isPlaceholder(t){
    t = (t||"").toString().trim();
    if(!t) return True;
    var u = t.toUpperCase();
    return (t==="…" || t==="—" || u==="N/A" || u==="BOOT" || u==="LOADING" || u==="PENDING");
  }
  function _hasValue(el){
    try{
      var t = (el && (el.textContent||"") || "").trim();
      if(!t) return false;
      var u=t.toUpperCase();
      return (t!=="…" && t!=="—" && u!=="N/A");
    }catch(_){ return false; }
  }
  function _unlockIfPlaceholder(id){
    var el=_el(id); if(!el) return;
    try{
      var t=(el.textContent||"").trim();
      var u=t.toUpperCase();
      var ph = (!t) || (t==="…"||t==="—"||u==="N/A"||u==="BOOT");
      if(ph) el.removeAttribute("data-vsp-kpi-lock");
    }catch(_){}
  }
  function _lockIfReal(id){
    var el=_el(id); if(!el) return;
    try{
      if(_hasValue(el)) el.setAttribute("data-vsp-kpi-lock","1");
    }catch(_){}
  }
  function _setText(id,v){
    var el=_el(id); if(!el) return false;
    try{
      if(el.getAttribute("data-vsp-kpi-lock")==="1" && _hasValue(el)) return false;
      el.textContent = (v===0) ? "0" : (v ? String(v) : "—");
      return true;
    }catch(_){ return false; }
  }

  function _normRid(x){
    try{
      x = (x||"").toString().trim();
      x = x.replace(/^RUN[_\-\s]+/i,"").replace(/^RID[:\s]+/i,"");
      var m = x.match(/(VSP_CI_\d{8}_\d{6})/i);
      if(m && m[1]) return m[1];
      return x.replace(/\s+/g,"_");
    }catch(_){ return ""; }
  }

  function _getRid(){
    // 1) shared rid state
    try{
      var st = window.__VSP_RID_STATE__ || window.__VSP_RID_STATE || window.VSP_RID_STATE || window.__vsp_rid_state;
      if(st){
        var v = st.rid || st.run_id || (st.state && (st.state.rid || st.state.run_id));
        if(!v && typeof st.get === "function"){
          var g = st.get();
          v = g && (g.rid || g.run_id);
        }
        if(v) return _normRid(v);
      }
    }catch(_){}
    // 2) DOM contains "RID: VSP_CI_..."
    try{
      var txt = (document.body && (document.body.innerText || document.body.textContent) || "");
      var m = txt.match(/RID\s*[:=]\s*(VSP_CI_\d{8}_\d{6})/i);
      if(m && m[1]) return _normRid(m[1]);
    }catch(_){}
    // 3) hash
    try{
      var h = (location.hash||"");
      var m2 = h.match(/(VSP_CI_\d{8}_\d{6})/i);
      if(m2 && m2[1]) return _normRid(m2[1]);
    }catch(_){}
    return "";
  }

  function _fmtBySev(bySev){
    if(!bySev) return "";
    var order=["CRITICAL","HIGH","MEDIUM","LOW","INFO","TRACE"];
    var out=[];
    for(var i=0;i<order.length;i++){
      var k=order[i];
      if(bySev[k]!==undefined && bySev[k]!==null) out.push(k[0]+":"+bySev[k]);
    }
    return out.join(" ");
  }

  function _pickByTool(byTool, want){
    if(!byTool) return null;
    if(byTool[want]!==undefined) return byTool[want];
    var w = String(want||"").toUpperCase();
    var keys = Object.keys(byTool);
    for(var i=0;i<keys.length;i++){
      if(String(keys[i]||"").toUpperCase()===w) return byTool[keys[i]];
    }
    return null;
  }

  async function _fetchJson(url){
    try{
      var r = await fetch(url, {cache:"no-store"});
      if(!r.ok) return null;
      return await r.json();
    }catch(_){ return null; }
  }

  async function hydrateOnce(){
    var rid=_getRid();
    if(!rid) return false;

    var extras = await _fetchJson("/api/vsp/dashboard_v3_extras_v1?rid="+encodeURIComponent(rid));
    var fu = await _fetchJson("/api/vsp/findings_unified_v2/"+encodeURIComponent(rid)+"?limit=1");

    var total=null, eff=null, degr=null, unk=null, score=null;
    if(extras && extras.kpi){
      var k=extras.kpi||{};
      if(k.total!=null) total=k.total;
      if(k.effective!=null) eff=k.effective;
      if(k.degraded!=null) degr=k.degraded;
      if(k.unknown_count!=null) unk=k.unknown_count;
      if(k.score!=null) score=k.score;
    }

    var bySev=null, byTool=null;
    if(fu && fu.counts){
      bySev = fu.counts.by_sev || null;
      byTool = fu.counts.by_tool || null;
      if(total==null && fu.total!=null) total=fu.total;
      if(unk==null && fu.counts.unknown_count!=null) unk=fu.counts.unknown_count;
    }

    // derive missing
    if(degr==null && unk!=null) degr=unk;
    if(eff==null && total!=null && degr!=null) eff = Math.max(0, (total - degr));

    if(total==null && eff==null && degr==null && !bySev && !byTool) return false;

    var verdict = (degr && degr>0) ? "DEGRADED" : ((total && total>0) ? "OK" : "EMPTY");
    var gateTxt = (score!=null) ? (String(score)+"/100") : verdict;

    _unlockIfPlaceholder("kpi-overall");
    _unlockIfPlaceholder("kpi-gate");
    _unlockIfPlaceholder("kpi-gitleaks");
    _unlockIfPlaceholder("kpi-codeql");

    _setText("kpi-overall", verdict);
    _setText("kpi-overall-sub",
      "total "+(total==null?"—":total)+" | eff "+(eff==null?"—":eff)+" | degr "+(degr==null?"—":degr)+" | unk "+(unk==null?"—":unk)
    );
    _setText("kpi-gate", gateTxt);
    _setText("kpi-gate-sub", _fmtBySev(bySev));

    var gtl=_pickByTool(byTool,"GITLEAKS");
    var cql=_pickByTool(byTool,"CODEQL");
    _setText("kpi-gitleaks", (gtl==null) ? "NOT_RUN" : gtl);
    _setText("kpi-gitleaks-sub", "GITLEAKS");
    _setText("kpi-codeql", (cql==null) ? "NOT_RUN" : cql);
    _setText("kpi-codeql-sub", "CODEQL");

    _lockIfReal("kpi-overall");
    _lockIfReal("kpi-gate");
    _lockIfReal("kpi-gitleaks");
    _lockIfReal("kpi-codeql");
    return true;
  }

  var started=false;
  function start(){
    if(started) return;
    started=true;

    // fast warm-up loop (1s), then slow keep-alive (15s)
    var n=0;
    var t = setInterval(function(){
      n++;
      hydrateOnce().catch(function(){});
      if(n>=45){
        clearInterval(t);
        setInterval(function(){ hydrateOnce().catch(function(){}); }, 15000);
      }
    }, 1000);
  }

  if(document.readyState==="loading") document.addEventListener("DOMContentLoaded", start);
  else start();
})();


try{ console.info('[VSP_UI_FREEZE]', 'build=20251216_224121'); }catch(_){ }


/* P0_DOM_FORM_IDS_FIX_BUNDLE_V1 */
(function(){
  'use strict';
  function run(){
    try{
      // fix duplicate IDs
      const byId = {};
      const all = Array.from(document.querySelectorAll("[id]"));
      for (const el of all){
        const id = el.getAttribute("id");
        if (!id) continue;
        (byId[id] ||= []).push(el);
      }
      for (const id of Object.keys(byId)){
        const arr = byId[id];
        if (arr.length <= 1) continue;
        for (let i=1;i<arr.length;i++){
          arr[i].setAttribute("id", id + "__dup" + i);
        }
      }

      // ensure form controls have id/name
      const ctrls = Array.from(document.querySelectorAll("input,select,textarea"));
      let k = 0;
      for (const el of ctrls){
        const tag = (el.tagName||"x").toLowerCase();
        const id = (el.getAttribute("id")||"").trim();
        const name = (el.getAttribute("name")||"").trim();
        if (!id && !name){
          const nid = "vsp_auto_" + tag + "_" + (++k);
          el.setAttribute("id", nid);
          el.setAttribute("name", nid);
        } else if (!name && id){
          el.setAttribute("name", id);
        } else if (!id && name){
          el.setAttribute("id", name);
        }
      }
    }catch(_){}
  }
  if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", run, {once:true});
  else run();
})();

})();
/* ==== END: static/js/vsp_ui_4tabs_commercial_v1.freeze.js ==== */

/* ==== BEGIN: static/js/vsp_ui_4tabs_commercial_v1.js ==== */
(function(){
'use strict';
/* === VSP_GLOBAL_KPI_GUARDS_P1_V2 ===
   Ensure _vspSetTextK/_vspSetHTMLK exist in GLOBAL scope (file has multiple IIFEs/modules).
*/
var _vspKpiEl = (typeof _vspKpiEl === "function") ? _vspKpiEl : function(id){
  try{ return document.getElementById(id); }catch(_){ return null; }
};
var _vspKpiHasValue = (typeof _vspKpiHasValue === "function") ? _vspKpiHasValue : function(el){
  try{
    var t = (el && (el.textContent||"") || "").trim();
    if(!t) return false;
    var u = t.toUpperCase();
    return (t !== "…" && t !== "—" && u !== "N/A");
  }catch(_){ return false; }
};
var _vspKpiLocked = (typeof _vspKpiLocked === "function") ? _vspKpiLocked : function(id){
  var el=_vspKpiEl(id);
  try{ return !!(el && el.getAttribute("data-vsp-kpi-lock")==="1"); }catch(_){ return false; }
};
var _vspKpiLock = (typeof _vspKpiLock === "function") ? _vspKpiLock : function(id){
  var el=_vspKpiEl(id);
  try{ if(el) el.setAttribute("data-vsp-kpi-lock","1"); }catch(_){}
};
var _vspSetTextK = (typeof _vspSetTextK === "function") ? _vspSetTextK : function(id, v){
  var el=_vspKpiEl(id);
  if(!el) return false;
  if(_vspKpiLocked(id) && _vspKpiHasValue(el)) return false;
  try{
    el.textContent = (v===0) ? "0" : (v ? String(v) : "—");
    return true;
  }catch(_){ return false; }
};
var _vspSetHTMLK = (typeof _vspSetHTMLK === "function") ? _vspSetHTMLK : function(id, html){
  var el=_vspKpiEl(id);
  if(!el) return false;
  if(_vspKpiLocked(id) && _vspKpiHasValue(el)) return false;
  try{
    el.innerHTML = (html===0) ? "0" : (html ? String(html) : "—");
    return true;
  }catch(_){ return false; }
};
/* === END VSP_GLOBAL_KPI_GUARDS_P1_V2 === */

/* === VSP_GLOBAL_KPI_HYDRATOR_FROM_EXTRAS_P1_V1 ===
   Purpose: hydrate KPI cards from /api/vsp/dashboard_v3_extras_v1 regardless of internal module function names.
   Requires: global _vspSetTextK/_vspSetHTMLK/_vspKpiLock from VSP_GLOBAL_KPI_GUARDS_P1_V2.
*/
(function(){
  function _normRid(x){
    try{
      x = String(x||"").trim();
      x = x.replace(/^RUN[_\-\s]+/i,"").replace(/^RID[:\s]+/i,"");
      const m = x.match(/(VSP_CI_\d{8}_\d{6})/i);
      if(m && m[1]) return m[1].toUpperCase();
      return x.replace(/\s+/g,"_");
    }catch(_){ return ""; }
  }
  function _getRid(){
    // 1) shared rid state
    try{
      const st = window.__VSP_RID_STATE__ || window.__VSP_RID_STATE || window.VSP_RID_STATE || window.__vsp_rid_state;
      if(st){
        if(st.rid || st.run_id) return _normRid(st.rid || st.run_id);
        if(st.state && (st.state.rid || st.state.run_id)) return _normRid(st.state.rid || st.state.run_id);
        if(typeof st.get === "function"){
          const v = st.get();
          if(v && (v.rid || v.run_id)) return _normRid(v.rid || v.run_id);
        }
      }
    }catch(_){}
    // 2) scan page text
    try{
      const txt = (document && document.body && document.body.innerText) ? document.body.innerText : "";
      const m = txt.match(/(VSP_CI_\d{8}_\d{6})/i);
      if(m && m[1]) return _normRid(m[1]);
    }catch(_){}
    return "";
  }

  // === VSP_KPI_HYDRATOR_RID_FALLBACK_P1_V1 ===
  async function _fetchLatestRid(){
    try{
      const u="/api/vsp/runs_index_v3_fs_resolved?limit=1&hide_empty=0&filter=1";
      const r=await fetch(u,{cache:"no-store"});
      if(!r.ok) return "";
      const j=await r.json();
      const it = (j && j.items && j.items[0]) ? j.items[0] : null;
      const rid = it ? (it.run_id || it.rid || "") : "";
      return _normRid(rid);
    }catch(_){ return ""; }
  }

  function _hasKpiDom(){
    try{ return !!(document.getElementById("kpi-overall") && document.getElementById("kpi-gate")); }
    catch(_){ return false; }
  }
  function _fmtBySev(bySev){
    try{
      if(!bySev) return "";
      const order=["CRITICAL","HIGH","MEDIUM","LOW","INFO","TRACE"];
      const out=[];
      for(const k of order){
        if(bySev[k]!==undefined) out.push(k[0]+":"+bySev[k]);
      }
      return out.join(" ");
    }catch(_){ return ""; }
  }
  async function _fetchExtras(rid){
    if(!rid) return null;
    const u="/api/vsp/dashboard_v3_extras_v1?rid="+encodeURIComponent(rid);
    try{
      const r=await fetch(u,{cache:"no-store"});
      if(!r.ok) return null;
      const j=await r.json();
      return (j && j.ok && j.kpi) ? j : null;
    }catch(_){ return null; }
  }
  function _apply(j){
    try{
      if(!j || !j.kpi) return false;
      const k=j.kpi||{};
      const total = (k.total ?? 0);
      const eff   = (k.effective ?? 0);
      const degr  = (k.degraded ?? 0);
      const unk   = (k.unknown_count ?? 0);
      const score = (k.score===undefined || k.score===null) ? "" : k.score;

      const verdict = (degr>0) ? "DEGRADED" : (total>0 ? "OK" : "EMPTY");
      const gateTxt = (score!=="") ? (String(score)+"/100") : verdict;

      // set + lock so status_v2 won't overwrite
      _vspSetTextK("kpi-overall", verdict);
      _vspSetTextK("kpi-overall-sub", `total ${total} | eff ${eff} | degr ${degr} | unk ${unk}`);
      _vspKpiLock("kpi-overall"); _vspKpiLock("kpi-overall-sub");

      _vspSetTextK("kpi-gate", gateTxt);
      // by_sev may not exist; keep safe
      const bySev = k.by_sev || k.bySev || null;
      _vspSetTextK("kpi-gate-sub", bySev ? _fmtBySev(bySev) : "");
      _vspKpiLock("kpi-gate"); _vspKpiLock("kpi-gate-sub");

      return true;
    }catch(_){ return false; }
  }

  async function _run(){
    try{
      if(!_hasKpiDom()) return;
      let rid=_getRid();
      if(!rid) rid = await _fetchLatestRid();
      if(!rid) return;
const j=await _fetchExtras(rid);
      if(!j) return;
      _apply(j);
    }catch(_){}
  }

  function _install(){
    try{
      if(window.__VSP_GLOBAL_KPI_HYDRATOR_INSTALLED__) return;
      window.__VSP_GLOBAL_KPI_HYDRATOR_INSTALLED__ = 1;

      // immediate + retry
      _run(); setTimeout(_run,200); setTimeout(_run,800); setTimeout(_run,1600);

      // observe pane mount / route change
      const obs = new MutationObserver(()=>{ if(_hasKpiDom()) _run(); });
      obs.observe(document.documentElement || document.body, {subtree:true, childList:true});

      // periodic safety
      setInterval(_run, 3000);
    }catch(_){}
  }

  if(document.readyState==="loading"){
    document.addEventListener("DOMContentLoaded", _install);
  }else{
    _install();
  }
})();




// === VSP_EXPORT_HEAD_NOISE_PATCH_V1 ===
(function(){
  'use strict';

  // === VSP_KPI_LOCK_PREFER_EXTRAS_P1_V1 ===
  function _vspKpiEl(id){ try{return document.getElementById(id);}catch(_){return null;} }
  function _vspKpiHasValue(el){
    try{
      const t = (el && (el.textContent||"") || "").trim();
      if(!t) return false;
      const u = t.toUpperCase();
      return (t !== "…" && t !== "—" && u !== "N/A");
    }catch(_){ return false; }
  }
  function _vspKpiLocked(id){
    const el=_vspKpiEl(id);
    return !!(el && el.getAttribute("data-vsp-kpi-lock")==="1");
  }
  function _vspKpiLock(id){
    const el=_vspKpiEl(id);
    if(el) el.setAttribute("data-vsp-kpi-lock","1");
  }
  function _vspSetTextK(id, v){
    const el=_vspKpiEl(id);
    if(el && _vspKpiLocked(id) && _vspKpiHasValue(el)) return;
    setText(id, v);
  }
  function _vspSetHTMLK(id, v){
    const el=_vspKpiEl(id);
    if(el && _vspKpiLocked(id) && _vspKpiHasValue(el)) return;
    setHTML(id, v);
  }


/* === VSP_4TABS_KPI_FROM_EXTRAS_P1_V1 === */
(function(){
  if(window.__VSP_4TABS_KPI_FROM_EXTRAS_P1_V1) return;
  window.__VSP_4TABS_KPI_FROM_EXTRAS_P1_V1 = 1;

  function normRid(x){
    try{
      x = String(x||"").trim();
      x = x.replace(/^RUN[_\-\s]+/i, "");
      x = x.replace(/^RID[:\s]+/i, "");
      const m = x.match(/(VSP_CI_\d{8}_\d{6})/i);
      if(m && m[1]) return m[1];
      return x.replace(/\s+/g,"_");
    }catch(_){ return ""; }
  }

  function getRid(){
    try{
      const st = window.__VSP_RID_STATE__ || window.__VSP_RID_STATE || window.VSP_RID_STATE;
      if(st){
        if(st.rid || st.run_id) return normRid(st.rid || st.run_id);
        if(st.state && (st.state.rid || st.state.run_id)) return normRid(st.state.rid || st.state.run_id);
        if(typeof st.get === "function"){
          const v = st.get();
          if(v && (v.rid || v.run_id)) return normRid(v.rid || v.run_id);
        }
      }
    }catch(_){}

    try{
      const t = document.body ? (document.body.innerText || "") : "";
      const m = t.match(/RID:\s*(VSP_CI_\d{8}_\d{6})/i);
      if(m && m[1]) return normRid(m[1]);
    }catch(_){}

    return "";
  }

  function setText(id, v){
    const el = document.getElementById(id);
    if(!el) return false;
    el.textContent = (v===0) ? "0" : (v ? String(v) : "—");
    return true;
  }

  function fmtBySev(bySev){
    if(!bySev) return "";
    const order = ["CRITICAL","HIGH","MEDIUM","LOW","INFO","TRACE"];
    const out = [];
    for(const k of order){
      if(bySev[k] !== undefined) out.push(k[0] + ":" + bySev[k]);
    }
    return out.join(" ");
  }

  async function fetchExtras(rid){
    if(!rid) return null;
    const u = "/api/vsp/dashboard_v3_extras_v1?rid=" + encodeURIComponent(rid);
    try{
      const r = await fetch(u, {cache:"no-store"});
      if(!r.ok) return null;
      const j = await r.json();
      if(j && j.ok) return j;
    }catch(_){}
    return null;
  }

  function applyExtras(j){
    const k = (j && j.kpi) ? j.kpi : {};
    const byTool = j.by_tool || {};
    const bySev  = j.by_sev  || {};

    const total = k.total ?? 0;
    const eff   = k.effective ?? 0;
    const degr  = k.degraded ?? 0;
    const unk   = k.unknown_count ?? 0;
    const score = (k.score===undefined || k.score===null) ? "" : k.score;

    const verdict = (degr > 0) ? "DEGRADED" : (total > 0 ? "OK" : "EMPTY");
    const gateTxt = (score !== "") ? (String(score) + "/100") : verdict;

    _vspSetTextK("kpi-overall", verdict);
    _vspSetTextK("kpi-overall-sub", `total ${total} | eff ${eff} | degr ${degr} | unk ${unk}`);
    
    // --- VSP_KPI_LOCK_AFTER_EXTRAS_P1 ---
    _vspKpiLock("kpi-overall");
    _vspKpiLock("kpi-overall-sub");
    _vspKpiLock("kpi-gate");
    _vspKpiLock("kpi-gate-sub");
    _vspKpiLock("kpi-gitleaks");
    _vspKpiLock("kpi-gitleaks-sub");
    _vspKpiLock("kpi-codeql");
    _vspKpiLock("kpi-codeql-sub");
_vspSetTextK("kpi-gate", gateTxt);
    _vspSetTextK("kpi-gate-sub", fmtBySev(bySev));

    const gtl = (byTool.GITLEAKS !== undefined) ? byTool.GITLEAKS : null;
    const cql = (byTool.CODEQL  !== undefined) ? byTool.CODEQL  : null;
    _vspSetTextK("kpi-gitleaks", (gtl===null) ? "NOT_RUN" : gtl);
    _vspSetTextK("kpi-gitleaks-sub", "GITLEAKS");
    _vspSetTextK("kpi-codeql", (cql===null) ? "NOT_RUN" : cql);
    _vspSetTextK("kpi-codeql-sub", "CODEQL");
  }

  let lastRid = "";
  async function hydrate(force){
    const rid = getRid();
    if(!rid) return;
    if(!force && rid === lastRid) return;
    lastRid = rid;

    const j = await fetchExtras(rid);
    if(j) applyExtras(j);
  }

  window.addEventListener("hashchange", () => setTimeout(() => hydrate(true), 120));
  setTimeout(() => hydrate(true), 200);
  setInterval(() => hydrate(false), 1500);
})();


  // 1) QUIET export probe:
  // Browser HEAD to /api/vsp/run_export_v3/...fmt=pdf may fail/noisy (DevTools shows "Fetch failed loading: HEAD ...")
  // We short-circuit ONLY that exact pattern to a synthetic 200 so UI stops spamming.
  if (!window.__VSP_EXPORT_HEAD_NOISE_PATCH_V1__) {
    window.__VSP_EXPORT_HEAD_NOISE_PATCH_V1__ = true;
    const _fetch = (window.fetch && window.fetch.bind(window)) ? window.fetch.bind(window) : null;

    if (_fetch) {
      window.fetch = function(input, init){
        try {
          const method = (init && init.method)
            ? String(init.method).toUpperCase()
            : (input && input.method ? String(input.method).toUpperCase() : "GET");
          const url = (typeof input === "string")
            ? input
            : (input && input.url ? String(input.url) : "");
          if (method === "HEAD"
              && url.includes("/api/vsp/run_export_v3/")
              && url.includes("fmt=pdf")) {
            // pretend "available" without real network HEAD (removes noisy HEAD errors)
            return Promise.resolve(new Response("", {
              status: 200,
              headers: { "X-VSP-EXPORT-AVAILABLE": "1" }
            }));
          }
        } catch(_e) {}
        return _fetch(input, init);
      };
      console.log("[VSP][EXPORT] installed HEAD-noise patch for fmt=pdf");
    }
  }

  // 2) DRILLDOWN bus (Dashboard/Gate Summary click -> Data Source auto filter)
  const LS_KEY = "vsp_ds_filters_v1";

  function emitFilters(filters){
    const payload = { v:1, ts: Date.now(), filters: (filters||{}) };
    try { localStorage.setItem(LS_KEY, JSON.stringify(payload)); } catch(_){}
    try { window.dispatchEvent(new CustomEvent("vsp:datasource:setFilters", { detail: payload })); } catch(_){}
  }

  window.VSP_DRILL_TO_DATASOURCE = function(filters){
    emitFilters(filters || {});
    // switch to datasource tab via hash (your router logs show hash-based router)
    try { location.hash = "#datasource"; } catch(_){}
  };

  // datasource side: best-effort apply by label text (Severity/Tool/CWE/Text/Limit)
  function findControlByLabelText(labelText, preferTags){
    labelText = String(labelText||"").toLowerCase();
    preferTags = preferTags || ["select","input","textarea"];
    const nodes = Array.from(document.querySelectorAll("div,span,label,strong,b,small,h1,h2,h3,h4,h5,h6"));
    for (const n of nodes) {
      const t = (n.textContent || "").trim().toLowerCase();
      if (!t) continue;
      if (t === labelText || t.includes(labelText)) {
        // search within same parent first
        let base = n.parentElement || n;
        for (let hop=0; hop<3 && base; hop++){
          for (const tg of preferTags){
            const c = base.querySelector(tg);
            if (c) return c;
          }
          base = base.parentElement;
        }
      }
    }
    return null;
  }

  function fire(el){
    try { el.dispatchEvent(new Event("input", { bubbles:true })); } catch(_){}
    try { el.dispatchEvent(new Event("change", { bubbles:true })); } catch(_){}
  }

  function applyFilters(filters){
    filters = filters || {};
    // only apply when datasource pane is active-ish
    const h = String(location.hash||"");
    if (!h.includes("datasource")) return;

    const sev = findControlByLabelText("Severity", ["select","input"]);
    const tool = findControlByLabelText("Tool", ["select","input"]);
    const cwe = findControlByLabelText("CWE", ["input","select"]);
    const txt = findControlByLabelText("Text", ["input","textarea"]);
    const lim = findControlByLabelText("Limit", ["input","select"]);

    if (filters.severity && sev) { sev.value = String(filters.severity); fire(sev); }
    if (filters.tool && tool) { tool.value = String(filters.tool); fire(tool); }
    if (filters.cwe && cwe) { cwe.value = String(filters.cwe); fire(cwe); }
    if (filters.text && txt) { txt.value = String(filters.text); fire(txt); }
    if (filters.limit && lim) { lim.value = String(filters.limit); fire(lim); }

    // try click "Load" if exists (your UI has Load/Clear buttons)
    try {
      const btn = Array.from(document.querySelectorAll("button"))
        .find(b => (b.textContent||"").trim().toLowerCase() === "load");
      if (btn) btn.click();
    } catch(_){}
  }

  function consumePending(){
    try {
      const raw = localStorage.getItem(LS_KEY);
      if (!raw) return;
      const p = JSON.parse(raw);
      if (!p || !p.filters) return;
      const age = Date.now() - Number(p.ts || 0);
      if (!(age >= 0 && age <= 5*60*1000)) return;
      localStorage.removeItem(LS_KEY);
      applyFilters(p.filters);
    } catch(_){}
  }

  window.addEventListener("vsp:datasource:setFilters", (e)=>{
    try { applyFilters((e.detail && e.detail.filters) || {}); } catch(_){}
  });
  window.addEventListener("hashchange", ()=>{ try { consumePending(); } catch(_){} });

  // Gate Summary pills click -> drilldown
  function wireGateSummaryClicks(){
    const toolSet = new Set(["GITLEAKS","SEMGREP","TRIVY","CODEQL","KICS","GRYPE","SYFT","BANDIT"]);
    const sevSet  = new Set(["CRITICAL","HIGH","MEDIUM","LOW","INFO","TRACE"]);
    const pills = Array.from(document.querySelectorAll(".vsp-pill, [data-pill], td, th, span, div"));

    for (const el of pills) {
      if (!el || el.__vsp_drilled__) continue;
      const txt = (el.textContent || "").trim();
      if (!txt) continue;
      const up = txt.toUpperCase();

      const filters = {};
      if (toolSet.has(up)) filters.tool = up;
      if (sevSet.has(up)) filters.severity = up;
      if (/^CWE-\d+$/i.test(up)) filters.cwe = up;

      if (Object.keys(filters).length === 0) continue;

      // limit to dashboard area if possible
      const inDash = !!el.closest("#vsp-dashboard-main") || String(location.hash||"").includes("dashboard");
      if (!inDash) continue;

      el.__vsp_drilled__ = true;
      el.style.cursor = "pointer";
      el.title = "Click → drilldown Data Source";
      el.addEventListener("click", ()=> window.VSP_DRILL_TO_DATASOURCE(filters));
    }
  }

  function onReady(fn){
    if (document.readyState === "complete" || document.readyState === "interactive") return setTimeout(fn, 0);
    document.addEventListener("DOMContentLoaded", fn, { once:true });
  }

  onReady(()=>{ try { wireGateSummaryClicks(); } catch(_){} });
  onReady(()=>{ try { consumePending(); } catch(_){} });

})();



// === VSP_P2_UI_NULL_GUARD_V1 ===
(function(){
  window.VSP_UI_SAFE_EL_V1 = function(id, parentSel){
    try{
      var el = document.getElementById(id);
      if (el) return el;
      var host = document.querySelector(parentSel || "#vsp4-main") ||
                 document.querySelector("#vsp-content") ||
                 document.body;
      el = document.createElement("div");
      el.id = id;
      host.appendChild(el);
      return el;
    }catch(e){
      var el2 = document.createElement("div");
      el2.id = id;
      document.body.appendChild(el2);
      return el2;
    }
  };
})();

/* === VSP_UI_EXPORT_CI_AND_8TOOLS_V1 === */
window.__VSP_STATUS_CACHE = window.__VSP_STATUS_CACHE || {};
/* === VSP_UI_FIX_ARTLIST_NULL_V1 === */
/* === VSP_UI_4TABS_COMMERCIAL_V1 === */
(function(){
  const API = {
    runsIndex: "/api/vsp/runs_index_v3_fs_resolved?limit=20&hide_empty=0&filter=1",
    statusV2: (rid) => `/api/vsp/run_status_v2/${encodeURIComponent(rid)}`,
    artIndex: (rid) => `/api/vsp/run_artifacts_index_v1/${encodeURIComponent(rid)}`
  };

  const $ = (s, r=document) => r.querySelector(s);
  const $all = (s, r=document) => Array.from(r.querySelectorAll(s));

  async function fetchJSON(url){
    const r = await fetch(url, {headers: {"Accept":"application/json"}});
    if (!r.ok) throw new Error(`HTTP ${r.status} ${url}`);
    return await r.json();
  }

  function normRid(runId){
    if (!runId) return "";
    runId = String(runId).trim();
    if (runId.startsWith("RUN_")) return runId;
    if (runId.startsWith("VSP_CI_")) return "RUN_" + runId;
    return runId;
  }

  function badge(verdict, label){
    const v = (verdict||"").toUpperCase();
    let cls="vsp-badge-muted", dot="vsp-dot-muted", text=v||"N/A";
    if (v==="GREEN"){cls="vsp-badge-green";dot="vsp-dot-green";}
    else if (v==="AMBER"||v==="YELLOW"){cls="vsp-badge-amber";dot="vsp-dot-amber";text="AMBER";}
    else if (v==="RED"){cls="vsp-badge-red";dot="vsp-dot-red";}
    else if (v==="DISABLED"||v==="NOT_RUN"||v==="DEGRADED"){cls="vsp-badge-muted";dot="vsp-dot-muted";text=v;}
    return `<span class="vsp-badge ${cls}" title="${label||""}"><span class="vsp-dot ${dot}"></span>${text}</span>`;
  }

  function setHTML(id, html){ const el=document.getElementById(id); if (el) el.innerHTML=html; }
  function setText(id, txt){ const el=document.getElementById(id); if (el) el.textContent=txt; }

  function tabSwitch(name){
    const tabs = ["dashboard","runs","settings","data"];
    tabs.forEach(t=>{
      const sec = document.getElementById(`tab-${t}`);
      if (sec) sec.style.display = (t===name) ? "" : "none";
    });
    $all("#nav button").forEach(b=>b.classList.toggle("active", b.dataset.tab===name));
    const titleMap = {dashboard:"Dashboard", runs:"Runs & Reports", settings:"Settings", data:"Data Source"};
    setText("page-title", titleMap[name] || "VSP");
  }

  function renderGateByTool(s){
    const rg = s.run_gate_summary || {};
    const bt = rg.by_tool || {};
    const rows = Object.keys(bt).sort().map(k=>{
      const o = bt[k]||{};
      const v = o.verdict || "N/A";
      const total = o.total ?? 0;
      return `<div class="vsp-row" style="margin:8px 0">
        <div style="min-width:92px;font-weight:800">${k}</div>
        <div>${badge(v, k)}</div>
        <div class="vsp-muted">total: <span class="vsp-mono">${total}</span></div>
      </div>`;
    }).join("");
    $("#gate-bytool").innerHTML = rows || `<div class="vsp-muted">No gate summary</div>`;
    setText("gate-ts", rg.ts ? `ts: ${rg.ts}` : "ts: -");
  }

  function updateKpis(s){
    const overall = s.overall_verdict || s.overall || (s.run_gate_summary && s.run_gate_summary.overall) || "N/A";
    const gateOverall = (s.run_gate_summary && (s.run_gate_summary.overall_verdict || s.run_gate_summary.overall)) || overall || "N/A";

    const glV = s.gitleaks_verdict || "NOT_RUN";
    const glT = Number(s.gitleaks_total || 0);

    let cqV = s.codeql_verdict || (s.has_codeql ? "AMBER" : "DISABLED");
    let cqT = Number(s.codeql_total || 0);
    if (!s.has_codeql && (cqV==="GREEN"||cqV==="AMBER"||cqV==="RED")) cqV="DISABLED";

    _vspSetHTMLK("kpi-overall", badge(overall,"status_v2.overall_verdict"));
    _vspSetTextK("kpi-overall-sub", s.rid_norm ? `RID: ${s.rid_norm}` : "");
    _vspSetHTMLK("kpi-gate", badge(gateOverall,"run_gate_summary.overall"));
    _vspSetTextK("kpi-gate-sub", s.run_gate_summary && s.run_gate_summary.ts ? `ts: ${s.run_gate_summary.ts}` : "");
    _vspSetHTMLK("kpi-gitleaks", badge(glV,"gitleaks_verdict"));
    _vspSetTextK("kpi-gitleaks-sub", `total: ${glT}`);
    _vspSetHTMLK("kpi-codeql", badge(cqV,"codeql_verdict"));
    _vspSetTextK("kpi-codeql-sub", `total: ${cqT}`);

    setHTML("pill-overall", badge(overall));
  }

  function updateMeta(s){
    const lines = [
      `rid: ${s.rid || "-"}`,
      `rid_norm: ${s.rid_norm || "-"}`,
      `ci_run_dir: ${s.ci_run_dir || "-"}`,
      `status: ${s.status || "-"}`,
      `stage: ${s.stage_name || "-"}`,
      `degraded_n: ${s.degraded_n ?? (Array.isArray(s.degraded_tools) ? s.degraded_tools.length : 0)}`
    ];
    $("#run-meta").textContent = lines.join("\n");
  }

  async function renderArtifacts(rid){
    try{
      const j = await fetchJSON(API.artIndex(rid));
      const items = j.items || j.artifacts || j.files || [];
      setText("art-count", `count: ${items.length}`);
      const __pa = $("#pill-art"); if(__pa) __pa.textContent = String(items.length);
      const __al=$("#art-list"); if(__al) __al.textContent = items.slice(0,300).map(x=>{
        if (typeof x === "string") return x;
        return x.path || x.name || JSON.stringify(x);
      }).join("\n");
    }catch(e){
      setText("art-count", "count: -");
      const __al=$("#art-list"); if(__al) __al.textContent = String(e);
  }
  }

  async function loadRuns(){
    const idx = await fetchJSON(API.runsIndex);
    const items = idx.items || idx.runs || idx.data || [];
    $("#pill-runs").textContent = String(items.length || 0);

    // build picker
    const optHtml = items.map(it=>{
      const runId = it.run_id || it.id || it.rid || it.rid_norm || it.name || "";
      const rid = normRid(runId);
      return `<option value="${rid}">${rid}</option>`;
    }).join("");
    $("#run-picker").innerHTML = optHtml || `<option value="">(no runs)</option>`;

    // build runs table (with status_v2)
    const tbody = $("#runs-tbody");
    tbody.innerHTML = "";
    for (const it of items.slice(0,20)){
      const runId = it.run_id || it.id || it.rid || it.rid_norm || it.name || "";
      const rid = normRid(runId);
      if (!rid.startsWith("RUN_")) continue;

      let s = null;
      try { s = await fetchJSON(API.statusV2(rid)); } catch(e){ s = null; }

      const overall = s ? (s.overall_verdict || (s.run_gate_summary && s.run_gate_summary.overall) || "N/A") : "N/A";
      const gate = s && s.run_gate_summary ? (s.run_gate_summary.overall || "N/A") : "N/A";
      const glV = s ? (s.gitleaks_verdict || "NOT_RUN") : "N/A";
      const cqV = s ? (s.codeql_verdict || (s.has_codeql ? "AMBER" : "DISABLED")) : "N/A";
      const deg = s ? (s.degraded_n ?? (Array.isArray(s.degraded_tools)?s.degraded_tools.length:0)) : "-";

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="vsp-mono">${rid}</td>
        <td>${badge(overall)}</td>
        <td>${badge(gate)}</td>
        <td>${badge(glV)} <span class="vsp-muted">(t=${(function(){const a=_vsp_pickTool(s,"semgrep");const b=_vsp_pickTool(s,"trivy");const c=_vsp_pickTool(s,"kics");const d=_vsp_pickTool(s,"gitleaks");
      return _vsp_toolBadge("SEMGREP",a.verdict,a.total)+" "+_vsp_toolBadge("TRIVY",b.verdict,b.total)+" "+_vsp_toolBadge("KICS",c.verdict,c.total)+" "+_vsp_toolBadge("GITLEAKS",d.verdict,d.total);})()})</span></td>
        <td>${badge(cqV)} <span class="vsp-muted">(t=${(function(){const a=_vsp_pickTool(s,"codeql");const b=_vsp_pickTool(s,"bandit");const c=_vsp_pickTool(s,"syft");const d=_vsp_pickTool(s,"grype");
      return _vsp_toolBadge("CODEQL",a.verdict,a.total)+" "+_vsp_toolBadge("BANDIT",b.verdict,b.total)+" "+_vsp_toolBadge("SYFT",c.verdict,c.total)+" "+_vsp_toolBadge("GRYPE",d.verdict,d.total);})()})</span></td>
        <td class="vsp-mono">${deg}</td>
      `;
      tr.style.cursor="pointer";
      tr.addEventListener("click", async ()=>{
        $("#run-picker").value = rid;
        await loadOne(rid);
        tabSwitch("dashboard");
      });
      tbody.appendChild(tr);
    }
  }

  async function loadOne(rid){
    if (!rid) return;
    let s = null;
    try { s = await fetchJSON(API.statusV2(rid)); } catch(e){ s = null; }
    if (!s){
      setText("run-meta", "cannot load status_v2");
      return;
    }
    updateKpis(s);
    renderGateByTool(s);
    updateMeta(s);
    window.__VSP_STATUS_CACHE[rid]=s;
await renderArtifacts(rid);
    await _vsp_setup_export_links(rid);
    await _vsp_render_datasource(rid, s);
  }

  function loadSettingsUi(){
    const key = (k)=>`vsp_ui_set_${k}`;
    const enable = localStorage.getItem(key("ENABLE_CODEQL")) ?? "1";
    const tCodeql = localStorage.getItem(key("TIMEOUT_CODEQL")) ?? "3600s";
    const tKics = localStorage.getItem(key("TIMEOUT_KICS")) ?? "1800s";
    $("#set-enable-codeql").value = enable;
    $("#set-timeout-codeql").value = tCodeql;
    $("#set-timeout-kics").value = tKics;

    $("#set-enable-codeql").addEventListener("change", ()=>localStorage.setItem(key("ENABLE_CODEQL"), $("#set-enable-codeql").value));
    $("#set-timeout-codeql").addEventListener("change", ()=>localStorage.setItem(key("TIMEOUT_CODEQL"), $("#set-timeout-codeql").value));
    $("#set-timeout-kics").addEventListener("change", ()=>localStorage.setItem(key("TIMEOUT_KICS"), $("#set-timeout-kics").value));
  }

  function bootNav(){
    $all("#nav button").forEach(b=>{
      b.addEventListener("click", ()=>{
        tabSwitch(b.dataset.tab);
      });
    });
    $("#btn-refresh").addEventListener("click", async ()=>{
      await loadRuns();
      const rid = $("#run-picker").value;
      if (rid) await loadOne(rid);
    await _vsp_setup_export_links(rid);
  });
    $("#run-picker").addEventListener("change", async ()=>{
      const rid = $("#run-picker").value;
      if (rid) await loadOne(rid);
    });
  }

/* === VSP_UI_4TABS_EXPORT_DS_V1 === */
async function _vsp_try_head(url){
  try{
    const r = await fetch(url, {method:"HEAD"});
    if (r.ok) return true;
  }catch(e){}
  try{
    const r2 = await fetch(url, {method:"GET", headers: {"Range":"bytes=0-0"}});
    if (r2.ok) return true;
  }catch(e){}
  return false;
}

async function _vsp_probe_first(urls){
  for (const u of urls){
    if (await _vsp_try_head(u)) return u;
  }
  return null;
}

function _vsp_disable_link(a, reason){
  if (!a) return;
  a.href = "#";
  a.style.opacity = "0.45";
  a.style.pointerEvents = "none";
  if (reason) a.title = reason;
}

function _vsp_pretty(obj){
  try { return JSON.stringify(obj, null, 2); } catch(e){ return String(obj); }
}

// try to fetch an artifact file by probing common endpoints
async function _vsp_fetch_artifact_text(rid, path){
  const qp = encodeURIComponent(path);
  const cands = [
    `/api/vsp/run_artifact_v1/${encodeURIComponent(rid)}?path=${qp}`,
    `/api/vsp/run_artifact_get_v1/${encodeURIComponent(rid)}?path=${qp}`,
    `/api/vsp/run_artifacts_get_v1/${encodeURIComponent(rid)}?path=${qp}`,
    `/api/vsp/artifact_get_v1/${encodeURIComponent(rid)}?path=${qp}`,
    `/api/vsp/run_artifact_v1/${encodeURIComponent(rid)}?p=${qp}`,
    `/api/vsp/run_artifact_get_v1/${encodeURIComponent(rid)}?p=${qp}`,
  ];
  for (const u of cands){
    try{
      const r = await fetch(u, {headers: {"Accept":"text/plain,application/json,*/*"}});
      if (!r.ok) continue;
      const txt = await r.text();
      // heuristic: not an HTML error page
      if ((txt||"").trim().startsWith("<!DOCTYPE html") || (txt||"").includes("HTTP_404")) continue;
      return {ok:true, url:u, text:txt};
    }catch(e){}
  }
  return {ok:false, url:null, text:null};
}

function _vsp_parse_csv_preview(csvText, limitRows=50){
  const lines = (csvText||"").split(/\r?\n/).filter(x=>x.trim().length>0);
  if (!lines.length) return {cols:[], rows:[]};
  // naive CSV split (good enough for preview)
  const split = (s)=> {
    const out=[]; let cur=""; let q=false;
    for (let i=0;i<s.length;i++){
      const ch=s[i];
      if (ch === '"' ){ q = !q; continue; }
      if (ch === "," && !q){ out.push(cur); cur=""; continue; }
      cur+=ch;
    }
    out.push(cur);
    return out.map(x=>x.trim());
  };
  const cols = split(lines[0]).slice(0,40);
  const rows = [];
  for (let i=1;i<lines.length && rows.length<limitRows;i++){
    rows.push(split(lines[i]).slice(0,40));
  }
  return {cols, rows};
}

function _vsp_render_findings_table(cols, rows){
  const head = document.getElementById("ds-findings-head");
  const body = document.getElementById("ds-findings-body");
  if (!head || !body) return;

  head.innerHTML = "";
  body.innerHTML = "";

  cols.slice(0,14).forEach(c=>{
    const th = document.createElement("th");
    th.textContent = c;
    head.appendChild(th);
  });

  rows.slice(0,80).forEach(r=>{
    const tr = document.createElement("tr");
    cols.slice(0,14).forEach((_,i)=>{
      const td = document.createElement("td");
      td.textContent = (r[i] ?? "");
      tr.appendChild(td);
    });
    body.appendChild(tr);
  });
}

async function _vsp_setup_export_links(selectedRid){
  const aHtml = document.getElementById("btn-exp-html");
  const aPdf  = document.getElementById("btn-exp-pdf");
  const aZip  = document.getElementById("btn-exp-zip");
  const aArt  = document.getElementById("btn-open-artindex");
  const hint  = document.getElementById("exp-hint");

  if (!aHtml && !aPdf && !aZip) return;

  if (!selectedRid){
    _vsp_disable_link(aHtml,"no run");
    _vsp_disable_link(aPdf,"no run");
    _vsp_disable_link(aZip,"no run");
    _vsp_disable_link(aArt,"no run");
    if (hint) hint.textContent = "no selected run";
    return;
  }

  
  const __st = (window.__VSP_STATUS_CACHE||{})[selectedRid] || null;
  const __ci = (__st && (__st.ci_run_dir || __st.ci || __st.run_dir)) ? String(__st.ci_run_dir || __st.ci || __st.run_dir) : "";
  const __ciQ = __ci ? `&ci=${encodeURIComponent(__ci)}` : "";
// artifacts index always exists
  if (aArt){
    aArt.href = `/api/vsp/run_artifacts_index_v1/${encodeURIComponent(selectedRid)}`;
    aArt.style.opacity = "1";
    aArt.style.pointerEvents = "auto";
  }

  // probe export endpoints (several shapes)
  const mk = (fmt)=>[
    `/api/vsp/run_export_v3/${encodeURIComponent(selectedRid)}?fmt=${fmt}${String(__ciQ||"").replace(/^\?/, "&")}`,
    `/api/vsp/run_export_v3/${encodeURIComponent(selectedRid)}?format=${fmt}${String(__ciQ||"").replace(/^\?/, "&")}`,
    `/api/vsp/run_export_v3?rid=${encodeURIComponent(selectedRid)}&fmt=${fmt}${String(__ciQ||"").replace(/^\?/, "&")}`,
    `/api/vsp/run_export_v3?run_id=${encodeURIComponent(selectedRid)}&fmt=${fmt}${String(__ciQ||"").replace(/^\?/, "&")}`,
    `/api/vsp/run_export_v3?rid=${encodeURIComponent(selectedRid)}&format=${fmt}${String(__ciQ||"").replace(/^\?/, "&")}`,
  ];

  const uHtml = await _vsp_probe_first(mk("html"));
  const uPdf  = await _vsp_probe_first(mk("pdf"));
  const uZip  = await _vsp_probe_first(mk("zip"));

  if (uHtml){ aHtml.href=uHtml; aHtml.style.opacity="1"; aHtml.style.pointerEvents="auto"; }
  else _vsp_disable_link(aHtml,"export html not available");

  if (uPdf){ aPdf.href=uPdf; aPdf.style.opacity="1"; aPdf.style.pointerEvents="auto"; }
  else _vsp_disable_link(aPdf,"export pdf not available");

  if (uZip){ aZip.href=uZip; aZip.style.opacity="1"; aZip.style.pointerEvents="auto"; }
  else _vsp_disable_link(aZip,"export zip not available");

  if (hint){
    hint.textContent = `rid=${selectedRid} • export: ${uHtml?'HTML':'-'} ${uPdf?'PDF':'-'} ${uZip?'ZIP':'-'}`
  }
}

async function _vsp_render_datasource(rid, statusV2Obj){
  const boxS = document.getElementById("ds-statusv2");
  const boxA = document.getElementById("ds-artjson");
  const hint = document.getElementById("ds-findings-hint");

  if (boxS) boxS.textContent = _vsp_pretty(statusV2Obj || {});
  if (!rid) return;

  // artifacts index JSON
  let art = null;
  try{
    art = await fetchJSON(`/api/vsp/run_artifacts_index_v1/${encodeURIComponent(rid)}`);
    if (boxA) boxA.textContent = _vsp_pretty(art);
  }catch(e){
    if (boxA) boxA.textContent = String(e);
    if (hint) hint.textContent = "cannot load artifacts index";
    return;
  }

  // find candidate findings files from artifacts list
  const items = art.items || art.artifacts || art.files || [];
  const paths = items.map(x => (typeof x === "string") ? x : (x.path || x.name || "")).filter(Boolean);

  const pick = (needle)=> paths.find(p => p.toLowerCase().includes(needle));
  const csvPath = pick("findings_unified.csv") || pick("findings.csv") || pick("findings_unified");
  const jsonPath = pick("findings_unified.json") || pick("findings.json");

  if (!csvPath && !jsonPath){
    if (hint) hint.textContent = "no findings_unified.* in artifacts index";
    return;
  }

  // try csv first for table preview
  if (csvPath){
    if (hint) hint.textContent = `trying csv: ${csvPath}`;
    const r = await _vsp_fetch_artifact_text(rid, csvPath);
    if (r.ok){
      const pv = _vsp_parse_csv_preview(r.text, 60);
      _vsp_render_findings_table(pv.cols, pv.rows);
      if (hint) hint.textContent = `preview from CSV ✓ via ${r.url}`;
      return;
    }
  }

  // fallback json
  if (jsonPath){
    if (hint) hint.textContent = `trying json: ${jsonPath}`;
    const r = await _vsp_fetch_artifact_text(rid, jsonPath);
    if (r.ok){
      let obj = null;
      try{ obj = JSON.parse(r.text); }catch(e){ obj=null; }
      if (obj && Array.isArray(obj.items)) obj = obj.items;
      // render columns from first item keys
      const rows = Array.isArray(obj) ? obj.slice(0,60) : [];
      const cols = rows[0] ? Object.keys(rows[0]).slice(0,14) : [];
      const tableRows = rows.map(o => cols.map(c => (o && o[c] !== undefined) ? String(o[c]) : ""));
      _vsp_render_findings_table(cols, tableRows);
      if (hint) hint.textContent = `preview from JSON ✓ via ${r.url}`;
      return;
    }
  }

  if (hint) hint.textContent = "cannot fetch findings file (no artifact download endpoint found)";
}

function _vsp_normVerd(v){
  const s = (v||"").toString().toUpperCase();
  if (!s) return "N/A";
  return s;
}
function _vsp_toolBadge(name, verdict, total){
  const v = _vsp_normVerd(verdict);
  const cls = (v==="RED"||v==="CRITICAL"||v==="HIGH") ? "pill red"
            : (v==="AMBER"||v==="MEDIUM") ? "pill amber"
            : (v==="GREEN"||v==="LOW"||v==="OK") ? "pill green"
            : (v==="DEGRADED") ? "pill amber"
            : (v==="DISABLED"||v==="NOT_RUN") ? "pill gray"
            : "pill gray";
  const tt = `${name}: ${v} (${total??0})`;
  return `<span class="${cls}" title="${tt}">${name} <span class="vsp-muted">(${total??0})</span></span>`;
}
function _vsp_pickTool(s, key){
  // allow either flat fields or *_summary
  if (!s) return {verdict:"N/A", total:0};
  const up = key.toUpperCase();
  // run_gate_summary.by_tool preferred
  const gate = (s.run_gate_summary && s.run_gate_summary.by_tool) ? s.run_gate_summary.by_tool : null;
  if (gate && gate[up]) return {verdict: gate[up].verdict||"N/A", total: gate[up].total||0};
  // direct fields
  const v1 = s[`${key}_verdict`];
  const t1 = s[`${key}_total`];
  if (v1 !== undefined || t1 !== undefined) return {verdict: v1||"N/A", total: (t1||0)};
  // summary object
  const sum = s[`${key}_summary`];
  if (sum && typeof sum === "object") return {verdict: sum.verdict||sum.status||"N/A", total: sum.total||0};
  // special known: codeql in our wrapper
  if (key==="codeql"){
    return {verdict: s.codeql_verdict||"NOT_RUN", total: s.codeql_total||0};
  }
  if (key==="gitleaks"){
    return {verdict: s.gitleaks_verdict||"NOT_RUN", total: s.gitleaks_total||0};
  }
  return {verdict:"NOT_RUN", total:0};
}


async function boot(){
    bootNav();
    loadSettingsUi();
    await loadRuns();
    const rid = $("#run-picker").value;
    if (rid) await loadOne(rid);
  }

  if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", boot);
  else boot();
})();

// === VSP_P2_FIX_EXPORT_CIQ_V1 ===
// patched run_export_v3 candidate URLs to normalize __ciQ leading '?'



// === VSP_UI_GATE_SUMMARY_ALWAYS8_V1 ===
(function(){
  'use strict';

  const CANON = ["SEMGREP","GITLEAKS","TRIVY","CODEQL","KICS","GRYPE","SYFT","BANDIT"];

  function esc(s){ return String(s||"").replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c])); }
  function pick(obj, keys){ for(const k of keys){ if(obj && obj[k] != null) return obj[k]; } return null; }

  function normalizeToolEntry(t, entry){
    entry = entry || {};
    const verdict = String(pick(entry, ["verdict","status"]) || "NOT_RUN").toUpperCase();
    const total = Number(pick(entry, ["total","n","count"]) || 0) || 0;
    return { tool: t, verdict, total };
  }

  function buildListFromStatus(status){
    status = status || {};
    const tools = status.tools || null;
    const order = status.tools_order || CANON;
    const out = [];

    // Prefer .tools (new backend)
    if (tools && typeof tools === "object") {
      for (const t of order) out.push(normalizeToolEntry(t, tools[t]));
      return out;
    }

    // Fallback: legacy run_gate_summary
    const gs = status.run_gate_summary || {};
    if (gs && typeof gs === "object") {
      for (const t of order) out.push(normalizeToolEntry(t, gs[t]));
      return out;
    }

    // Last fallback: legacy 4 tools flat fields
    const legacyMap = {
      "SEMGREP": { verdict: status.semgrep_verdict, total: status.semgrep_total },
      "GITLEAKS": { verdict: status.gitleaks_verdict, total: status.gitleaks_total },
      "TRIVY": { verdict: status.trivy_verdict, total: status.trivy_total },
      "CODEQL": { verdict: status.codeql_verdict, total: status.codeql_total }
    };
    for (const t of CANON) out.push(normalizeToolEntry(t, legacyMap[t] || {}));
    return out;
  }

  function badgeClass(v){
    v = String(v||"").toUpperCase();
    if (v === "RED" || v === "FAIL" || v === "CRITICAL") return "vsp-badge vsp-badge-red";
    if (v === "AMBER" || v === "WARN" || v === "HIGH") return "vsp-badge vsp-badge-amber";
    if (v === "GREEN" || v === "OK" || v === "PASS") return "vsp-badge vsp-badge-green";
    if (v === "DEGRADED") return "vsp-badge vsp-badge-amber";
    return "vsp-badge vsp-badge-gray";
  }

  function renderGateSummaryAlways8(status){
    const host = document.querySelector("#vsp-gate-summary, #gate-summary, [data-vsp='gate-summary']");
    if (!host) return false;

    const list = buildListFromStatus(status);
    const rows = list.map(x => {
      const t = esc(x.tool);
      const v = esc(x.verdict);
      const n = esc(x.total);
      return `
        <div class="vsp-gs-row" data-vsp-drill-tool="${t}">
          <div class="vsp-gs-tool vsp-pill" data-vsp-drill-tool="${t}">${t}</div>
          <div class="${badgeClass(v)} vsp-pill" data-vsp-drill-tool="${t}">${v}</div>
          <div class="vsp-gs-total vsp-pill" data-vsp-drill-tool="${t}">${n}</div>
        </div>
      `;
    }).join("");

    host.innerHTML = `
      <div class="vsp-gs-head">
        <div class="vsp-gs-col">TOOL</div>
        <div class="vsp-gs-col">VERDICT</div>
        <div class="vsp-gs-col">TOTAL</div>
      </div>
      <div class="vsp-gs-body">${rows}</div>
    `;

    return true;
  }

  // Hook: if your code already has a function that receives status JSON, we wrap it.
  function wrapStatusConsumer(){
    const names = ["VSP_UI_APPLY_STATUS", "vspApplyStatus", "renderRunStatus", "updateStatusUI"];
    for (const n of names){
      if (typeof window[n] === "function" && !window[n].__vsp_wrapped__) {
        const orig = window[n];
        window[n] = function(status){
          try { renderGateSummaryAlways8(status); } catch(_){}
          return orig.apply(this, arguments);
        };
        window[n].__vsp_wrapped__ = true;
        console.log("[VSP][UI] wrapped status consumer:", n);
        return;
      }
    }
    // fallback: poll global last status if exists
    try {
      if (window.VSP_LAST_STATUS && !window.__VSP_GATE8_TICK__) {
        window.__VSP_GATE8_TICK__ = setInterval(()=>{ try { renderGateSummaryAlways8(window.VSP_LAST_STATUS); } catch(_){} }, 1200);
      }
    } catch(_){}
  }

  // Ensure a container exists (non-breaking)
  function ensureHost(){
    let host = document.querySelector("#vsp-gate-summary");
    if (host) return;
    const dash = document.querySelector("#vsp-dashboard-main");
    if (!dash) return;
    host = document.createElement("div");
    host.id = "vsp-gate-summary";
    host.style.marginTop = "10px";
    dash.appendChild(host);
  }

  function onReady(fn){
    if (document.readyState === "complete" || document.readyState === "interactive") return setTimeout(fn, 0);
    document.addEventListener("DOMContentLoaded", fn, { once:true });
  }

  onReady(()=>{ try { ensureHost(); } catch(_){} });
  onReady(()=>{ try { wrapStatusConsumer(); } catch(_){} });

})();


/* === VSP_SILENCE_EXPORT_HEAD_PROBE_V1 ===
 * Fix commercial UX: stop console noise caused by HEAD probes to /api/vsp/run_export_v3/*
 * We only intercept HEAD (probe). Real export clicks (usually GET via navigation) are not touched.
 */
(function(){
  try{
    const _fetch = window.fetch ? window.fetch.bind(window) : null;
    if (!_fetch) return;

    window.fetch = function(input, init){
      try{
        const url = String(input || "");
        const method = String((init && init.method) || "GET").toUpperCase();
        if (method === "HEAD" && url.indexOf("/api/vsp/run_export_v3/") >= 0){
          // Return 200 + header available=0 so UI can hide/disable without throwing 404.
          return Promise.resolve(new Response("", {
            status: 200,
            headers: {
              "X-VSP-EXPORT-AVAILABLE": "0",
              "Content-Type": "application/json"
            }
          }));
        }
      }catch(e){}
      return _fetch(input, init);
    };
  }catch(e){}
})();
 /* === /VSP_SILENCE_EXPORT_HEAD_PROBE_V1 === */

/* VSP_FETCH_DEDUPE_SHIM_P1_V1_BEGIN */
(function(){
  'use strict';
  if (window.__VSP_FETCH_DEDUPE_SHIM_P1_V1) return;
  window.__VSP_FETCH_DEDUPE_SHIM_P1_V1 = true;

  const origFetch = window.fetch ? window.fetch.bind(window) : null;
  if (!origFetch) return;

  const cache = new Map();     // url -> {status, ctype, body}
  const inflight = new Map();  // url -> Promise<{status,ctype,body}>

  function urlOf(input){
    try { return (typeof input === "string") ? input : (input && input.url) ? input.url : ""; }
    catch(_e){ return ""; }
  }

  function shouldCache(url){
    if (!url) return false;
    if (url.includes("__nocache=1")) return false;
    // cache/dedupe only the noisy + safe GET JSON endpoints
    return (
      url.includes("/api/vsp/runs_index_v3_fs_resolved") ||
      url.includes("/api/vsp/run_status_v2/") ||
      url.includes("/api/vsp/dashboard_v3")
    );
  }

  function cloneResponseFrom(entry){
    return new Response(entry.body, {
      status: entry.status || 200,
      headers: { "Content-Type": entry.ctype || "application/json" }
    });
  }

  async function fetchAndStore(input, init, url){
    const res = await origFetch(input, init);
    try{
      const c = res.clone();
      const body = await c.text();
      const ctype = c.headers.get("content-type") || "application/json";
      const entry = { status: c.status, ctype, body };
      cache.set(url, entry);
      return entry;
    }catch(_e){
      // if clone fails, don't cache
      return null;
    }
  }

  window.fetch = function(input, init){
    const url = urlOf(input);
    const method = (init && init.method) ? String(init.method).toUpperCase() : "GET";
    if (method !== "GET" || !shouldCache(url)) {
      return origFetch(input, init);
    }

    if (cache.has(url)) {
      return Promise.resolve(cloneResponseFrom(cache.get(url)));
    }

    if (inflight.has(url)) {
      return inflight.get(url).then(entry => entry ? cloneResponseFrom(entry) : origFetch(input, init));
    }

    const p = fetchAndStore(input, init, url)
      .finally(() => inflight.delete(url));

    inflight.set(url, p);

    return origFetch(input, init); // return real response for first caller
  };

  console.log("[VSP_FETCH_DEDUPE_SHIM_P1_V1] enabled");
})();
/* VSP_FETCH_DEDUPE_SHIM_P1_V1_END */




/* === VSP_4TABS_KPI_FROM_EXTRAS_P1_V2 (observer+retry) === */
(function(){
  if(window.__VSP_4TABS_KPI_FROM_EXTRAS_P1_V2) return;
  window.__VSP_4TABS_KPI_FROM_EXTRAS_P1_V2 = 1;

  function normRid(x){
    try{
      x = String(x||"").trim();
      x = x.replace(/^RUN[_\-\s]+/i, "");
      x = x.replace(/^RID[:\s]+/i, "");
      const m = x.match(/(VSP_CI_\d{8}_\d{6})/i);
      if(m && m[1]) return m[1];
      return x.replace(/\s+/g,"_");
    }catch(_){ return ""; }
  }

  function getRid(){
    try{
      const st = window.__VSP_RID_STATE__ || window.__VSP_RID_STATE || window.VSP_RID_STATE || window.__vsp_rid_state;
      if(st){
        if(st.rid || st.run_id) return normRid(st.rid || st.run_id);
        if(st.state && (st.state.rid || st.state.run_id)) return normRid(st.state.rid || st.state.run_id);
        if(typeof st.get === "function"){
          const v = st.get();
          if(v && (v.rid || v.run_id)) return normRid(v.rid || v.run_id);
        }
      }
    }catch(_){}
    try{
      const t = document.body ? (document.body.innerText || "") : "";
      const m = t.match(/RID:\s*(VSP_CI_\d{8}_\d{6})/i);
      if(m && m[1]) return normRid(m[1]);
    }catch(_){}
    return "";
  }

  function setText(id, v){
    const el = document.getElementById(id);
    if(!el) return false;
    el.textContent = (v===0) ? "0" : (v ? String(v) : "—");
    return true;
  }

  function fmtBySev(bySev){
    if(!bySev) return "";
    const order = ["CRITICAL","HIGH","MEDIUM","LOW","INFO","TRACE"];
    const out = [];
    for(const k of order){
      if(bySev[k] !== undefined) out.push(k[0] + ":" + bySev[k]);
    }
    return out.join(" ");
  }

  function pickTool(byTool, want){
    if(!byTool) return null;
    if(byTool[want] !== undefined) return byTool[want];
    const key = Object.keys(byTool).find(k => String(k||"").toUpperCase() === want.toUpperCase());
    return key ? byTool[key] : null;
  }

  function tryApply(j){
    if(!j || !j.kpi) return false;
    // === VSP_EXTRAS_READER_USE_KPI_ROOT_P1_V1 ===
    const k = (j && j.kpi) ? j.kpi : {};
    // prefer kpi.* (our API returns only {ok,rid,sources,kpi})
    const byTool = (k && (k.by_tool || k.byTool)) || (j && (j.by_tool || j.byTool)) || {};
    const bySev  = (k && (k.by_sev  || k.bySev))  || (j && (j.by_sev  || j.bySev))  || {};
    const topCwe = (k && (k.top_cwe || k.topCwe)) || (j && (j.top_cwe || j.topCwe)) || [];


    const total = k.total ?? 0;
    const eff   = k.effective ?? 0;
    const degr  = k.degraded ?? 0;
    const unk   = k.unknown_count ?? 0;
    const score = (k.score===undefined || k.score===null) ? "" : k.score;

    const verdict = (degr > 0) ? "DEGRADED" : (total > 0 ? "OK" : "EMPTY");
    const gateTxt = (score !== "") ? (String(score) + "/100") : verdict;

    let ok = 0;
    ok += _vspSetTextK("kpi-overall", verdict) ? 1 : 0;
    ok += _vspSetTextK("kpi-overall-sub", `total ${total} | eff ${eff} | degr ${degr} | unk ${unk}`) ? 1 : 0;

    ok += _vspSetTextK("kpi-gate", gateTxt) ? 1 : 0;
    ok += _vspSetTextK("kpi-gate-sub", fmtBySev(bySev)) ? 1 : 0;

    const gtl = pickTool(byTool, "GITLEAKS");
    const cql = pickTool(byTool, "CODEQL");
    ok += _vspSetTextK("kpi-gitleaks", (gtl===null) ? "NOT_RUN" : gtl) ? 1 : 0;
    ok += _vspSetTextK("kpi-gitleaks-sub", "GITLEAKS") ? 1 : 0;
    ok += _vspSetTextK("kpi-codeql", (cql===null) ? "NOT_RUN" : cql) ? 1 : 0;
    ok += _vspSetTextK("kpi-codeql-sub", "CODEQL") ? 1 : 0;

    // success if at least the main 2 cards exist
    return ok >= 2;
  }

  function scheduleApply(){
    const j = window.__VSP_LAST_DASH_EXTRAS_J;
    if(!j) return;

    const delays = [0, 120, 300, 800, 1500, 2500];
    for(const d of delays){
      setTimeout(() => { tryApply(j); }, d);
    }

    // observe DOM until KPI nodes appear
    try{
      if(window.__VSP_KPI_OBSERVER_V2) return;
      const obs = new MutationObserver(() => {
        const done = tryApply(j);
        if(done){
          try{ obs.disconnect(); }catch(_){}
          window.__VSP_KPI_OBSERVER_V2 = null;
        }
      });
      obs.observe(document.documentElement || document.body, {childList:true, subtree:true});
      window.__VSP_KPI_OBSERVER_V2 = obs;
    }catch(_){}
  }

  async function fetchExtras(rid){
    const u = "/api/vsp/dashboard_v3_extras_v1?rid=" + encodeURIComponent(rid);
    try{
      const r = await fetch(u, {cache:"no-store"});
      if(!r.ok) return null;
      const j = await r.json();
      return (j && j.ok) ? j : null;
    }catch(_){}
    return null;
  }

  let lastRid = "";
  async function hydrate(force){
    const rid = getRid();
    if(!rid) return;
    if(!force && rid === lastRid) return;
    lastRid = rid;

    const j = await fetchExtras(rid);
    if(!j) return;

    window.__VSP_LAST_DASH_EXTRAS_RID = rid;
    window.__VSP_LAST_DASH_EXTRAS_J = j;

    // try immediately, and also schedule retry until DOM ready
    tryApply(j);
    scheduleApply();
  }

  window.addEventListener("hashchange", () => setTimeout(() => hydrate(true), 150));
  setTimeout(() => hydrate(true), 250);
  setInterval(() => hydrate(false), 2000);
})();


// VSP_KPI_HYDRATOR_RID_FALLBACK_P1_V1



/* === VSP_KPI_STANDALONE_FROM_FINDINGS_V2_P1_V1 ===
   Standalone hydrator that DOES NOT rely on DOMContentLoaded timing or internal module scope.
   Source of truth: /api/vsp/findings_unified_v2/<rid>?limit=1  (counts + total)
*/
(function(){
  if (window.__VSP_KPI_STANDALONE_V2_P1__) return;
  window.__VSP_KPI_STANDALONE_V2_P1__ = 1;

  function normRid(x){
    try{
      x = String(x||"").trim();
      x = x.replace(/^RUN[_\-\s]+/i,"").replace(/^RID[:\s]+/i,"");
      var m = x.match(/(VSP_CI_\d{8}_\d{6})/i);
      return (m && m[1]) ? m[1] : x.replace(/\s+/g,"_");
    }catch(_){ return ""; }
  }

  function ridFromState(){
    try{
      var st = window.__VSP_RID_STATE__ || window.__VSP_RID_STATE || window.VSP_RID_STATE || window.__vsp_rid_state;
      if(!st) return "";
      if (st.rid || st.run_id) return normRid(st.rid || st.run_id);
      if (st.state && (st.state.rid || st.state.run_id)) return normRid(st.state.rid || st.state.run_id);
      if (typeof st.get === "function"){
        var v = st.get();
        if (v && (v.rid || v.run_id)) return normRid(v.rid || v.run_id);
      }
    }catch(_){}
    try{
      // fallback: read RID from page text (header shows "RID: VSP_CI_...")
      var txt = (document && document.body && (document.body.innerText||"")) ? document.body.innerText : "";
      var mm = txt.match(/RID:\s*(VSP_CI_\d{8}_\d{6})/i);
      if(mm && mm[1]) return normRid(mm[1]);
    }catch(_){}

    return "";
  }

  async function fetchLatestRid(){
    try{
      var u="/api/vsp/runs_index_v3_fs_resolved?limit=1&hide_empty=0&filter=1";
      var r=await fetch(u,{cache:"no-store"});
      if(!r.ok) return "";
      var j=await r.json();
      var it=(j && j.items && j.items[0]) ? j.items[0] : null;
      return normRid(it ? (it.run_id || it.rid || "") : "");
    }catch(_){ return ""; }
  }

  async function fetchFindingsCounts(rid){
    try{
      if(!rid) return null;
      var u="/api/vsp/findings_unified_v2/"+encodeURIComponent(rid)+"?limit=1";
      var r=await fetch(u,{cache:"no-store"});
      if(!r.ok) return null;
      var j=await r.json();
      if(!j || !j.ok) return null;
      return j;
    }catch(_){ return null; }
  }

  function fmtBySev(bySev){
    if(!bySev) return "";
    var order=["CRITICAL","HIGH","MEDIUM","LOW","INFO","TRACE"];
    var out=[];
    for (var i=0;i<order.length;i++){
      var k=order[i];
      if (bySev[k] !== undefined) out.push(k[0]+":"+bySev[k]);
    }
    return out.join(" ");
  }

  function pickTool(byTool, want){
    if(!byTool) return null;
    if (byTool[want] !== undefined) return byTool[want];
    var keys=Object.keys(byTool);
    for (var i=0;i<keys.length;i++){
      if (String(keys[i]||"").toUpperCase() === String(want||"").toUpperCase()) return byTool[keys[i]];
    }
    return null;
  }

  function setText(id, v){
    try{
      if (typeof window._vspSetTextK === "function") return window._vspSetTextK(id, v);
    }catch(_){}
    // fallback
    try{
      var el=document.getElementById(id);
      if(!el) return false;
      el.textContent = (v===0) ? "0" : (v ? String(v) : "—");
      return true;
    }catch(_){ return false; }
  }
  // === VSP_KPI_STANDALONE_DEBUG_DOMRID_P1_V2 ===
function applyFromUnified(j){
    if(!j) return false;
    var total = (j.total !== undefined && j.total !== null) ? j.total : 0;
    var c = j.counts || {};
    var bySev = c.by_sev || {};
    var byTool = c.by_tool || {};
    var unk = (c.unknown_count !== undefined && c.unknown_count !== null) ? c.unknown_count : 0;
    var eff = Math.max(0, total - unk);
    var degr = Math.max(0, unk);

    var score = (total>0) ? Math.round((eff/Math.max(1,total))*100) : 0;
    var verdict = (degr>0) ? "DEGRADED" : (total>0 ? "OK" : "EMPTY");
    var gateTxt = String(score) + "/100";

    var gtl = pickTool(byTool,"GITLEAKS");
    var cql = pickTool(byTool,"CODEQL");

    var ok=0;
    ok += setText("kpi-overall", verdict) ? 1:0;
    ok += setText("kpi-overall-sub", "total "+total+" | eff "+eff+" | degr "+degr+" | unk "+unk) ? 1:0;
    ok += setText("kpi-gate", gateTxt) ? 1:0;
    ok += setText("kpi-gate-sub", fmtBySev(bySev)) ? 1:0;

    ok += setText("kpi-gitleaks", (gtl===null) ? "NOT_RUN" : gtl) ? 1:0;
    ok += setText("kpi-gitleaks-sub", "GITLEAKS") ? 1:0;
    ok += setText("kpi-codeql", (cql===null) ? "NOT_RUN" : cql) ? 1:0;
    ok += setText("kpi-codeql-sub", "CODEQL") ? 1:0;

    return ok>=2;
  }

  async function tick(){
try{
      var rid = ridFromState();
      if(!rid) rid = await fetchLatestRid();
      if(!rid) return;

      var j = await fetchFindingsCounts(rid);
      if(!j) return;

      applyFromUnified(j);
    }catch(_){}
  }

  // Start immediately (works even if script loads after DOMContentLoaded)
  try{ tick(); }catch(_){}
  try{ setTimeout(tick, 250); }catch(_){}
  try{ setTimeout(tick, 800); }catch(_){}
  try{ setInterval(tick, 2000); }catch(_){}
})();




/* === VSP_KPI_STICKY_LOCK_P1_V1 ===
   After standalone writes KPI values, prevent other modules from overwriting via _vspSetTextK/_vspSetHTMLK.
*/
(function(){
  if (window.__VSP_KPI_STICKY_LOCKED__) return;
  window.__VSP_KPI_STICKY_LOCKED__ = 1;

  var IDS = ["kpi-overall","kpi-overall-sub","kpi-gate","kpi-gate-sub","kpi-gitleaks","kpi-gitleaks-sub","kpi-codeql","kpi-codeql-sub"];

  function el(id){ try{return document.getElementById(id);}catch(_){return null;} }
  function hasValue(e){
    try{
      var t=(e && (e.textContent||"") || "").trim();
      if(!t) return false;
      var u=t.toUpperCase();
      return (t !== "…" && t !== "—" && u !== "N/A");
    }catch(_){ return false; }
  }
  function stable(id){
    var e=el(id);
    try{ return !!(e && e.getAttribute("data-vsp-kpi-stable")==="1" && hasValue(e)); }catch(_){ return false; }
  }
  function markStable(){
    for (var i=0;i<IDS.length;i++){
      var id = IDS[i];
      var e = el(id);
      try{
        if(!e) continue;
        if(!hasValue(e)) continue;
        var t = (e.textContent||"").trim();
        var u = t.toUpperCase();
        // don't lock placeholders/debug
        if(u==="N/A" || t==="…" || t==="—") continue;
        if(u==="BOOT") continue;
        if(t.indexOf("tick ")===0) continue;
        e.setAttribute("data-vsp-kpi-stable","1");
      }catch(_){}
    }
  }

  // Wrap setters (if exist)
  var _origText = window._vspSetTextK;
  var _origHTML = window._vspSetHTMLK;

  if (typeof _origText === "function" && !window.__VSP_SET_TEXTK_WRAPPED__){
    window.__VSP_SET_TEXTK_WRAPPED__ = 1;
    window._vspSetTextK = function(id, v){
      try{ if(stable(id)) return false; }catch(_){}
      return _origText(id, v);
    };
  }
  if (typeof _origHTML === "function" && !window.__VSP_SET_HTMLK_WRAPPED__){
    window.__VSP_SET_HTMLK_WRAPPED__ = 1;
    window._vspSetHTMLK = function(id, v){
      try{ if(stable(id)) return false; }catch(_){}
      return _origHTML(id, v);
    };
  }

  // Mark stable periodically (SPA can re-mount)
  try{
    setTimeout(markStable, 200);
    setTimeout(markStable, 800);
    setInterval(markStable, 2000);
  }catch(_){}
})();


// VSP_KPI_STANDALONE_DEBUG_DOMRID_P1_V2



/* === VSP_KPI_HYDRATOR_CANON_P1_V1 ===
   Canonical KPI hydrator:
   - RID from __VSP_RID_STATE__ OR DOM "RID:" OR hash
   - KPI from /api/vsp/dashboard_v3_extras_v1?rid=...
   - Tool+Sev from /api/vsp/findings_unified_v2/<rid>?limit=1
   - Writes #kpi-overall/#kpi-gate/#kpi-gitleaks/#kpi-codeql (+sub)
*/
;(function(){
  'use strict';

  function _el(id){ try{ return document.getElementById(id); }catch(_){ return null; } }
  function _isPlaceholder(t){
    t = (t||"").toString().trim();
    if(!t) return True;
    var u = t.toUpperCase();
    return (t==="…" || t==="—" || u==="N/A" || u==="BOOT" || u==="LOADING" || u==="PENDING");
  }
  function _hasValue(el){
    try{
      var t = (el && (el.textContent||"") || "").trim();
      if(!t) return false;
      var u=t.toUpperCase();
      return (t!=="…" && t!=="—" && u!=="N/A");
    }catch(_){ return false; }
  }
  function _unlockIfPlaceholder(id){
    var el=_el(id); if(!el) return;
    try{
      var t=(el.textContent||"").trim();
      var u=t.toUpperCase();
      var ph = (!t) || (t==="…"||t==="—"||u==="N/A"||u==="BOOT");
      if(ph) el.removeAttribute("data-vsp-kpi-lock");
    }catch(_){}
  }
  function _lockIfReal(id){
    var el=_el(id); if(!el) return;
    try{
      if(_hasValue(el)) el.setAttribute("data-vsp-kpi-lock","1");
    }catch(_){}
  }
  function _setText(id,v){
    var el=_el(id); if(!el) return false;
    try{
      if(el.getAttribute("data-vsp-kpi-lock")==="1" && _hasValue(el)) return false;
      el.textContent = (v===0) ? "0" : (v ? String(v) : "—");
      return true;
    }catch(_){ return false; }
  }

  function _normRid(x){
    try{
      x = (x||"").toString().trim();
      x = x.replace(/^RUN[_\-\s]+/i,"").replace(/^RID[:\s]+/i,"");
      var m = x.match(/(VSP_CI_\d{8}_\d{6})/i);
      if(m && m[1]) return m[1];
      return x.replace(/\s+/g,"_");
    }catch(_){ return ""; }
  }

  function _getRid(){
    // 1) shared rid state
    try{
      var st = window.__VSP_RID_STATE__ || window.__VSP_RID_STATE || window.VSP_RID_STATE || window.__vsp_rid_state;
      if(st){
        var v = st.rid || st.run_id || (st.state && (st.state.rid || st.state.run_id));
        if(!v && typeof st.get === "function"){
          var g = st.get();
          v = g && (g.rid || g.run_id);
        }
        if(v) return _normRid(v);
      }
    }catch(_){}
    // 2) DOM contains "RID: VSP_CI_..."
    try{
      var txt = (document.body && (document.body.innerText || document.body.textContent) || "");
      var m = txt.match(/RID\s*[:=]\s*(VSP_CI_\d{8}_\d{6})/i);
      if(m && m[1]) return _normRid(m[1]);
    }catch(_){}
    // 3) hash
    try{
      var h = (location.hash||"");
      var m2 = h.match(/(VSP_CI_\d{8}_\d{6})/i);
      if(m2 && m2[1]) return _normRid(m2[1]);
    }catch(_){}
    return "";
  }

  function _fmtBySev(bySev){
    if(!bySev) return "";
    var order=["CRITICAL","HIGH","MEDIUM","LOW","INFO","TRACE"];
    var out=[];
    for(var i=0;i<order.length;i++){
      var k=order[i];
      if(bySev[k]!==undefined && bySev[k]!==null) out.push(k[0]+":"+bySev[k]);
    }
    return out.join(" ");
  }

  function _pickByTool(byTool, want){
    if(!byTool) return null;
    if(byTool[want]!==undefined) return byTool[want];
    var w = String(want||"").toUpperCase();
    var keys = Object.keys(byTool);
    for(var i=0;i<keys.length;i++){
      if(String(keys[i]||"").toUpperCase()===w) return byTool[keys[i]];
    }
    return null;
  }

  async function _fetchJson(url){
    try{
      var r = await fetch(url, {cache:"no-store"});
      if(!r.ok) return null;
      return await r.json();
    }catch(_){ return null; }
  }

  async function hydrateOnce(){
    var rid=_getRid();
    if(!rid) return false;

    var extras = await _fetchJson("/api/vsp/dashboard_v3_extras_v1?rid="+encodeURIComponent(rid));
    var fu = await _fetchJson("/api/vsp/findings_unified_v2/"+encodeURIComponent(rid)+"?limit=1");

    var total=null, eff=null, degr=null, unk=null, score=null;
    if(extras && extras.kpi){
      var k=extras.kpi||{};
      if(k.total!=null) total=k.total;
      if(k.effective!=null) eff=k.effective;
      if(k.degraded!=null) degr=k.degraded;
      if(k.unknown_count!=null) unk=k.unknown_count;
      if(k.score!=null) score=k.score;
    }

    var bySev=null, byTool=null;
    if(fu && fu.counts){
      bySev = fu.counts.by_sev || null;
      byTool = fu.counts.by_tool || null;
      if(total==null && fu.total!=null) total=fu.total;
      if(unk==null && fu.counts.unknown_count!=null) unk=fu.counts.unknown_count;
    }

    // derive missing
    if(degr==null && unk!=null) degr=unk;
    if(eff==null && total!=null && degr!=null) eff = Math.max(0, (total - degr));

    if(total==null && eff==null && degr==null && !bySev && !byTool) return false;

    var verdict = (degr && degr>0) ? "DEGRADED" : ((total && total>0) ? "OK" : "EMPTY");
    var gateTxt = (score!=null) ? (String(score)+"/100") : verdict;

    _unlockIfPlaceholder("kpi-overall");
    _unlockIfPlaceholder("kpi-gate");
    _unlockIfPlaceholder("kpi-gitleaks");
    _unlockIfPlaceholder("kpi-codeql");

    _setText("kpi-overall", verdict);
    _setText("kpi-overall-sub",
      "total "+(total==null?"—":total)+" | eff "+(eff==null?"—":eff)+" | degr "+(degr==null?"—":degr)+" | unk "+(unk==null?"—":unk)
    );
    _setText("kpi-gate", gateTxt);
    _setText("kpi-gate-sub", _fmtBySev(bySev));

    var gtl=_pickByTool(byTool,"GITLEAKS");
    var cql=_pickByTool(byTool,"CODEQL");
    _setText("kpi-gitleaks", (gtl==null) ? "NOT_RUN" : gtl);
    _setText("kpi-gitleaks-sub", "GITLEAKS");
    _setText("kpi-codeql", (cql==null) ? "NOT_RUN" : cql);
    _setText("kpi-codeql-sub", "CODEQL");

    _lockIfReal("kpi-overall");
    _lockIfReal("kpi-gate");
    _lockIfReal("kpi-gitleaks");
    _lockIfReal("kpi-codeql");
    return true;
  }

  var started=false;
  function start(){
    if(started) return;
    started=true;

    // fast warm-up loop (1s), then slow keep-alive (15s)
    var n=0;
    var t = setInterval(function(){
      n++;
      hydrateOnce().catch(function(){});
      if(n>=45){
        clearInterval(t);
        setInterval(function(){ hydrateOnce().catch(function(){}); }, 15000);
      }
    }, 1000);
  }

  if(document.readyState==="loading") document.addEventListener("DOMContentLoaded", start);
  else start();
})();


})();
/* ==== END: static/js/vsp_ui_4tabs_commercial_v1.js ==== */

/* ==== BEGIN: static/js/vsp_ui_commercial_cleanup_v1.js ==== */
(function(){
'use strict';
/* vsp_ui_commercial_cleanup_v1.js
 * Commercial cleanup shim:
 * 1) Filters panel only on #datasource
 * 2) Hide conflicting floating "CI GATE - LATEST RUN" widget (we already have Gate panel)
 * 3) Remove stray "\\n\\n" debug text rendered on page
 *
 * If you want to keep the floating gate widget for debugging:
 *   window.VSP_KEEP_GATE_TOAST = true;
 */
(function () {
  'use strict';

  function tab() {
    var h = (location.hash || '').toLowerCase();
    if (!h) return 'dashboard';
    if (h.includes('datasource')) return 'datasource';
    if (h.includes('runs')) return 'runs';
    if (h.includes('settings')) return 'settings';
    if (h.includes('rules')) return 'rules';
    if (h.includes('dashboard')) return 'dashboard';
    return h.replace('#','') || 'unknown';
  }

  function findByText(needle) {
    needle = String(needle || '').toLowerCase();
    var all = Array.from(document.querySelectorAll('div,section,main,aside,pre,code'));
    return all.filter(function (el) {
      var t = (el.textContent || '').toLowerCase();
      return t.includes(needle);
    });
  }

  function looksLikeFiltersCard(el) {
    var t = (el.textContent || '').toLowerCase();
    // match the exact UI strings seen in your screenshots
    var ok = t.includes('filters') &&
             t.includes('severity') &&
             t.includes('tool') &&
             (t.includes('search (rule / path / cwe)') || t.includes('rule / path / cwe'));
    // avoid hiding the whole page by requiring inputs/selects inside
    var hasInputs = el.querySelector('select,input,textarea');
    return !!(ok && hasInputs);
  }

  function hideFiltersOutsideDatasource() {
    var current = tab();
    var candidates = findByText('search (rule / path / cwe)').concat(findByText('filters'));
    var uniq = Array.from(new Set(candidates));
    uniq.forEach(function (el) {
      // climb up a bit to the card container
      var card = el;
      for (var i=0;i<6 && card && card.parentElement;i++){
        if (looksLikeFiltersCard(card)) break;
        card = card.parentElement;
      }
      if (card && looksLikeFiltersCard(card)) {
        if (current !== 'datasource') {
          card.style.display = 'none';
          card.setAttribute('data-vsp-hidden-by', 'commercial_cleanup_v1');
        } else {
          // restore on datasource
          if (card.getAttribute('data-vsp-hidden-by') === 'commercial_cleanup_v1') {
            card.style.display = '';
          }
        }
      }
    });
  }

  function hideConflictingGateToast() {
    if (window.VSP_KEEP_GATE_TOAST) return;
    var nodes = findByText('ci gate - latest run');
    nodes.forEach(function (el) {
      // hide the container (usually a floating card)
      var box = el;
      for (var i=0;i<8 && box && box.parentElement;i++){
        var t = (box.textContent || '').toLowerCase();
        if (t.includes('ci gate - latest run')) break;
        box = box.parentElement;
      }
      if (!box) return;
      // prefer hiding the biggest container that still contains the phrase
      box.style.display = 'none';
      box.setAttribute('data-vsp-hidden-by', 'commercial_cleanup_v1');
    });
  }

  function removeStrayDebugBackslashN() {
    // remove elements that are basically just "\n" "\n\n" "\\n \\n"
    var all = Array.from(document.querySelectorAll('div,span,pre'));
    all.forEach(function (el) {
      if (!el || !el.textContent) return;
      var raw = el.textContent.trim();
      if (raw === '\\n' || raw === '\\n\\n' || raw === '\\n \\n' || raw === '\\n \\n\\n' || raw === '\\n\\n\\n') {
        // only remove if it's tiny and not a real section
        if ((el.innerHTML || '').trim() === raw || (el.childElementCount === 0)) {
          el.style.display = 'none';
          el.setAttribute('data-vsp-hidden-by', 'commercial_cleanup_v1');
        }
      }
    });
  }

  function run() {
    
    _vspRemoveStrayTextNodes();
    _vspHideGateToast();
hideFiltersOutsideDatasource();
    hideConflictingGateToast();
    removeStrayDebugBackslashN();
  }

  window.addEventListener('hashchange', function(){ setTimeout(run, 0); });
  document.addEventListener('DOMContentLoaded', function(){ setTimeout(run, 0); });

  // Also rerun a few times shortly after load in case other JS injects late
  var n = 0;
  var iv = setInterval(function(){
    run();
    n++;
    if (n >= 8) clearInterval(iv);
  }, 400);

  try { console.log('[VSP_UI_COMMERCIAL_CLEANUP_V1] loaded'); } catch(e){}
})();

// === VSP_UI_COMMERCIAL_CLEANUP_V1_TEXTNODE_TOAST_FIX ===
function _vspRemoveStrayTextNodes() {
  try {
    function walk(node){
      if (!node) return;
      // remove stray text nodes like "\n \n"
      if (node.nodeType === Node.TEXT_NODE) {
        var t = (node.nodeValue || '').trim();
        if (t === '\\n' || t === '\\n\\n' || t === '\\n \\n' || t === '\\n \\n\\n' || t === '\\n\\n\\n') {
          node.parentNode && node.parentNode.removeChild(node);
          return;
        }
      }
      var kids = Array.from(node.childNodes || []);
      kids.forEach(walk);
    }
    walk(document.body);
  } catch(e){}
}

function _vspHideGateToast() {
  try {
    if (window.VSP_KEEP_GATE_TOAST) return;
    var els = Array.from(document.querySelectorAll('div,section,aside'));
    els.forEach(function(el){
      var t = (el.textContent || '').toUpperCase();
      // match both "-" and "–"
      if (t.includes('CI GATE') && t.includes('LATEST RUN')) {
        // hide only floating-ish blocks
        var st = window.getComputedStyle(el);
        if (st && (st.position === 'fixed' || st.position === 'sticky') && (st.right !== 'auto' || st.bottom !== 'auto')) {
          el.style.display = 'none';
          el.setAttribute('data-vsp-hidden-by', 'commercial_cleanup_v1');
        }
      }
    });
  } catch(e){}
}
// === END VSP_UI_COMMERCIAL_CLEANUP_V1_TEXTNODE_TOAST_FIX ===


try {
  var _n=0;
  var _iv=setInterval(function(){
    _vspRemoveStrayTextNodes();
    _vspHideGateToast();
    _n++; if (_n>40) clearInterval(_iv);
  }, 300);
} catch(e){}

})();
/* ==== END: static/js/vsp_ui_commercial_cleanup_v1.js ==== */

/* ==== BEGIN: static/js/vsp_ui_commercial_polish_v1.js ==== */
(function(){
'use strict';
/**
 * VSP_UI 2025 – Commercial polish layer (V2)
 * - KHÔNG thay đổi logic fetch hiện tại.
 * - Chỉ "enhance" DOM sau khi dữ liệu đã render:
 *   + Badge severity / tool ở Data Source (MutationObserver).
 *   + Row hover + selected ở Runs.
 *   + Toast khi Save Settings / Rules.
 */

(function () {
  const LOG_PREFIX = "[VSP_UI_COMMERCIAL]";

  function ready(fn) {
    if (document.readyState !== "loading") {
      fn();
    } else {
      document.addEventListener("DOMContentLoaded", fn);
    }
  }

  function getToastContainer() {
    let c = document.querySelector(".vsp-toast-container");
    if (!c) {
      c = document.createElement("div");
      c.className = "vsp-toast-container";
      document.body.appendChild(c);
    }
    return c;
  }

  function showToast(message, type) {
    type = type || "info";
    const c = getToastContainer();
    const toast = document.createElement("div");
    toast.className = "vsp-toast vsp-toast-" + type;
    toast.textContent = message;
    c.appendChild(toast);
    setTimeout(function () {
      toast.classList.add("vsp-toast-hide");
    }, 2200);
    setTimeout(function () {
      if (toast.parentNode) toast.parentNode.removeChild(toast);
    }, 2600);
  }

  /*  Runs & Reports  */
  function enhanceRunsTab() {
    const tbody = document.getElementById("vsp-runs-tbody");
    if (!tbody) {
      console.log(LOG_PREFIX, "Không thấy #vsp-runs-tbody – bỏ qua polish Runs.");
      return;
    }

    const table = tbody.closest("table");
    if (table && !table.classList.contains("vsp-table-hover")) {
      table.classList.add("vsp-table-hover");
    }

    tbody.addEventListener("click", function (ev) {
      const tr = ev.target.closest("tr");
      if (!tr || !tbody.contains(tr)) return;

      Array.from(tbody.querySelectorAll("tr")).forEach(function (row) {
        row.classList.remove("vsp-run-selected");
      });
      tr.classList.add("vsp-run-selected");

      const detailBox = document.getElementById("vsp-run-detail-box");
      if (!detailBox) return;

      const cells = tr.children;
      const runId =
        tr.getAttribute("data-run-id") ||
        (cells[0] && cells[0].textContent.trim()) ||
        "-";

      const startedAt =
        tr.getAttribute("data-started-at") ||
        (cells[1] && cells[1].textContent.trim()) ||
        "-";

      const profile =
        tr.getAttribute("data-profile") ||
        (cells[2] && cells[2].textContent.trim()) ||
        "-";

      const status =
        tr.getAttribute("data-status") ||
        (cells[3] && cells[3].textContent.trim()) ||
        "-";

      const mapField = function (field, value) {
        const el = detailBox.querySelector('[data-field="' + field + '"]');
        if (el) el.textContent = value || "-";
      };

      mapField("run_id", runId);
      mapField("started_at", startedAt);
      mapField("profile", profile);
      mapField("status", status);
    });
  }

  /*  Data Source  */

  function styleDataSourceRows(tbody) {
    const rows = Array.from(tbody.querySelectorAll("tr"));
    if (!rows.length) return;

    rows.forEach(function (tr) {
      const cells = tr.children;
      if (!cells || !cells.length) return;

      const sevCell = cells[0];
      const toolCell = cells[1];
      const pathCell = cells[4];

      // Severity -> badge
      if (sevCell) {
        const hasBadge = sevCell.querySelector(".vsp-badge-sev");
        if (!hasBadge) {
          const raw = (sevCell.textContent || "").trim();
          if (raw) {
            const sev = raw.toUpperCase();
            const span = document.createElement("span");
            span.textContent = sev;
            span.className =
              "vsp-badge vsp-badge-sev vsp-badge-sev-" + sev.toLowerCase();
            sevCell.textContent = "";
            sevCell.appendChild(span);
          }
        }
      }

      // Tool -> badge
      if (toolCell) {
        const hasTool = toolCell.querySelector(".vsp-badge-tool");
        if (!hasTool) {
          const tool = (toolCell.textContent || "").trim();
          if (tool) {
            const span = document.createElement("span");
            span.textContent = tool;
            span.className = "vsp-badge vsp-badge-tool";
            toolCell.textContent = "";
            toolCell.appendChild(span);
          }
        }
      }

      // Path -> rút gọn + tooltip
      if (pathCell && !pathCell.dataset.vspShortened) {
        const full = (pathCell.textContent || "").trim();
        if (full.length > 70) {
          const short = "…" + full.slice(-65);
          pathCell.textContent = short;
          pathCell.title = full;
        }
        pathCell.dataset.vspShortened = "1";
      }
    });
  }

  function enhanceDataSourceTab() {
    const tbody =
      document.getElementById("vsp-datasource-tbody") ||
      document.getElementById("vsp-ds-tbody");
    if (!tbody) {
      console.log(
        LOG_PREFIX,
        "Không thấy tbody Data Source (#vsp-datasource-tbody / #vsp-ds-tbody)."
      );
      return;
    }

    const table = tbody.closest("table");
    if (table && !table.classList.contains("vsp-table-hover")) {
      table.classList.add("vsp-table-hover");
    }

    // Style lần đầu
    styleDataSourceRows(tbody);

    // Bắt async update từ /api/vsp/datasource_v2
    const observer = new MutationObserver(function () {
      styleDataSourceRows(tbody);
    });
    observer.observe(tbody, { childList: true });

    console.log(LOG_PREFIX, "Data Source polish ready (MutationObserver).");
  }

  /*  Settings & Rules – toast  */

  function wireSettingsAndRulesToasts() {
    const settingsSave = document.getElementById("vsp-settings-save");
    if (settingsSave && !settingsSave.classList.contains("vsp-btn-primary")) {
      settingsSave.classList.add("vsp-btn-primary", "vsp-btn");
    }

    const rulesSave = document.getElementById("vsp-rules-save");
    if (rulesSave && !rulesSave.classList.contains("vsp-btn-primary")) {
      rulesSave.classList.add("vsp-btn-primary", "vsp-btn");
    }

    if (settingsSave) {
      settingsSave.addEventListener("click", function () {
        showToast("Đang lưu settings_v1.json ...", "info");
        setTimeout(function () {
          showToast("Settings đã được gửi lên server.", "success");
        }, 700);
      });
    }

    if (rulesSave) {
      rulesSave.addEventListener("click", function () {
        showToast("Đang lưu rule_overrides_v1.json ...", "info");
        setTimeout(function () {
          showToast("Rule overrides đã được gửi lên server.", "success");
        }, 700);
      });
    }
  }

  ready(function () {
    console.log(
      LOG_PREFIX,
      "Khởi tạo polish V2 cho Runs / Data / Settings / Rules."
    );
    try {
      enhanceRunsTab();
    } catch (e) {
      console.error(LOG_PREFIX, "Lỗi enhanceRunsTab:", e);
    }
    try {
      enhanceDataSourceTab();
    } catch (e) {
      console.error(LOG_PREFIX, "Lỗi enhanceDataSourceTab:", e);
    }
    try {
      wireSettingsAndRulesToasts();
    } catch (e) {
      console.error(LOG_PREFIX, "Lỗi wireSettingsAndRulesToasts:", e);
    }
  });
})();

})();
/* ==== END: static/js/vsp_ui_commercial_polish_v1.js ==== */

/* ==== BEGIN: static/js/vsp_ui_commercial_ux_p1_v1.js ==== */
(function(){
'use strict';
/* VSP_UI_COMMERCIAL_UX_P1_V1
 * - Make dashboard/runs feel commercial: pills, hover, click-to-select RID, gentle auto refresh
 */
(function(){
  'use strict';
  if (window.__VSP_UI_COMMERCIAL_UX_P1_V1) return;
  window.__VSP_UI_COMMERCIAL_UX_P1_V1 = 1;

  // ---------- helpers ----------
  const qs = (s, r=document)=>r.querySelector(s);
  const qsa = (s, r=document)=>Array.from(r.querySelectorAll(s));
  const on = (el, ev, fn)=>el && el.addEventListener(ev, fn, {passive:true});

  function pill(text, kind){
    const span = document.createElement('span');
    span.className = 'vsp-pill ' + (kind ? ('vsp-pill-' + kind) : 'vsp-pill-muted');
    span.textContent = text;
    return span;
  }

  function normalizeVerdict(v){
    v = (v||'').toString().toUpperCase();
    if (v.includes('DEGRA')) return 'DEGRADED';
    if (v.includes('RED') || v.includes('FAIL') || v.includes('BLOCK')) return 'RED';
    if (v.includes('AMBER') || v.includes('WARN') || v.includes('YELLOW')) return 'AMBER';
    if (v.includes('GREEN') || v.includes('PASS') || v.includes('OK')) return 'GREEN';
    return v || 'N/A';
  }

  function verdictKind(v){
    v = normalizeVerdict(v);
    if (v === 'GREEN') return 'green';
    if (v === 'AMBER') return 'amber';
    if (v === 'RED') return 'red';
    if (v === 'DEGRADED') return 'degraded';
    return 'muted';
  }

  function ensureCss(){
    if (qs('#vsp-ui-commercial-ux-css')) return;
    const style = document.createElement('style');
    style.id = 'vsp-ui-commercial-ux-css';
    style.textContent = `
      .vsp-pill{display:inline-flex;align-items:center;gap:.35rem;padding:.18rem .55rem;border-radius:999px;
        font-size:12px;line-height:1;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.06);color:#cbd5e1}
      .vsp-pill-green{background:rgba(16,185,129,.12);border-color:rgba(16,185,129,.25);color:#a7f3d0}
      .vsp-pill-amber{background:rgba(245,158,11,.12);border-color:rgba(245,158,11,.25);color:#fde68a}
      .vsp-pill-red{background:rgba(239,68,68,.10);border-color:rgba(239,68,68,.25);color:#fecaca}
      .vsp-pill-degraded{background:rgba(99,102,241,.10);border-color:rgba(99,102,241,.22);color:#c7d2fe}
      .vsp-pill-muted{opacity:.85}

      .vsp-runs-row{transition:transform .08s ease, background .12s ease}
      .vsp-runs-row:hover{background:rgba(255,255,255,.04);transform:translateY(-1px)}
      .vsp-runs-row.is-active{outline:1px solid rgba(99,102,241,.35);background:rgba(99,102,241,.08)}
      .vsp-kpi-sub{opacity:.75;font-size:12px;margin-top:.25rem}
    `;
    document.head.appendChild(style);
  }

  function setRid(rid){
    try{
      // existing app uses RID in hash or local storage; support both
      localStorage.setItem('vsp_rid', rid);
    }catch(_){}
    // update UI field if exists
    const ridBox = qsa('input,textarea').find(x=> (x.placeholder||'').toLowerCase().includes('rid') || (x.value||'').startsWith('VSP_'));
    if (ridBox && ridBox.value !== rid) ridBox.value = rid;

    // set in sidebar if there is a pill/card
    const ridLabel = qsa('*').find(n=> (n.textContent||'').trim()==='RID');
    if (ridLabel && ridLabel.parentElement){
      const v = ridLabel.parentElement.querySelector('.vsp-kv-value,.value,div,span');
      if (v) v.textContent = rid;
    }
  }

  // ---------- decorate dashboard KPIs ----------
  function decorateDashboard(){
    ensureCss();
    // try to find KPI cards by headings
    const cards = qsa('.vsp-card, .dashboard-card, .card');
    cards.forEach(card=>{
      const h = qs('h3,h2,.title', card);
      if (!h) return;
      const t = (h.textContent||'').trim().toLowerCase();
      if (!t) return;

      // if card already has pills -> skip
      if (card.querySelector('.vsp-pill')) return;

      // infer verdict from text inside
      const raw = (card.textContent||'');
      const v = normalizeVerdict(raw);
      const k = verdictKind(v);

      if (t.includes('overall') || t.includes('gate') || t.includes('tools')){
        const row = document.createElement('div');
        row.style.display='flex';
        row.style.gap='.5rem';
        row.style.marginTop='.45rem';
        row.appendChild(pill(v, k));
        card.appendChild(row);
      }
    });
  }

  // ---------- runs table UX ----------
  function decorateRuns(){
    ensureCss();
    // find likely table rows
    const rows = qsa('tr, .row, .vsp-run-row, .runs-row').filter(r=>{
      const txt = (r.textContent||'').trim();
      return txt.includes('VSP_') && (txt.includes('zip') || txt.includes('pdf') || txt.includes('html') || txt.includes('status'));
    });

    rows.forEach(r=>{
      r.classList.add('vsp-runs-row');
      if (r.__vsp_bound) return;
      r.__vsp_bound = 1;

      // extract run id
      const m = (r.textContent||'').match(/VSP_[A-Za-z0-9_:-]+/);
      const rid = m ? m[0] : '';
      if (!rid) return;

      on(r, 'click', (e)=>{
        // ignore if clicking buttons/links
        const tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : '';
        if (tag === 'button' || tag === 'a') return;
        // highlight
        qsa('.vsp-runs-row.is-active').forEach(x=>x.classList.remove('is-active'));
        r.classList.add('is-active');
        setRid(rid);
      });

      // add pills into row if there are plain "YES/NO" cells
      if (!r.querySelector('.vsp-pill')){
        const vtxt = (r.textContent||'').toUpperCase();
        const hasFindings = vtxt.includes('YES') ? 'HAS FINDINGS' : (vtxt.includes('NO') ? 'NO FINDINGS' : '');
        const degraded = vtxt.includes('DEGRA') ? 'DEGRADED' : '';
        const pillBox = document.createElement('div');
        pillBox.style.display='inline-flex';
        pillBox.style.gap='.35rem';
        pillBox.style.marginLeft='.5rem';
        if (hasFindings) pillBox.appendChild(pill(hasFindings, hasFindings==='NO FINDINGS'?'amber':'green'));
        if (degraded) pillBox.appendChild(pill(degraded, 'degraded'));
        if (pillBox.childNodes.length) r.appendChild(pillBox);
      }
    });
  }

  // ---------- gentle auto refresh on #runs ----------
  let lastTick = 0;
  function tick(){
    const now = Date.now();
    if (now - lastTick < 30_000) return;
    lastTick = now;
    const h = (location.hash||'').toLowerCase();
    if (!h.includes('runs')) return;
    // click refresh button if exists
    const btn = qsa('button');
    const refresh = qsa('button, a');
    const list = qsa('button, a');
    const b = qsa('button') && qsa('button', document.body);
    const cand = qsa('button, a').find(x=> (x.textContent||'').trim().toLowerCase()==='refresh');
    if (cand) { try{ cand.click(); }catch(_){} }
  }

  // run on load and on route change
  function runAll(){
    const h = (location.hash||'').toLowerCase();
    if (h.includes('dashboard')) decorateDashboard();
    if (h.includes('runs')) decorateRuns();
  }

  window.addEventListener('hashchange', ()=>setTimeout(runAll, 50));
  setInterval(()=>{ try{ tick(); runAll(); }catch(_){ } }, 2000);
  setTimeout(runAll, 80);
})();

})();
/* ==== END: static/js/vsp_ui_commercial_ux_p1_v1.js ==== */

/* ==== BEGIN: static/js/vsp_ui_extras_v25.js ==== */
(function(){
'use strict';
/**
 * VSP 2025 – UI Extras V2.8
 *  - Shell + header 5 tab
 *  - Dashboard extras (Top risks + Delta)
 *  - Global floating card: CI Gate – Latest Run (mọi tab đều thấy)
 *  - Runs & Reports:
 *      + CI/CD Gate summary dạng KPI cards
 *      + Filter Run ID / Status
 *      + Badge màu ở cột cuối
 *  - Data Source:
 *      + Summary card + mini chart (nếu Chart.js có sẵn)
 *      + Filter severity / tool
 *  - Settings:
 *      + Summary + 3 block Scan / Tools / CI Gate
 *  - Rule Overrides:
 *      + Summary bảng overrides hoặc card “không có overrides”
 */

(function () {
  console.log("[VSP_V28] vsp_ui_extras_v25.js loaded (V2.8)");

  /* ------------ HELPERS ------------ */

  function safeParseJSON(text) {
    try {
      return JSON.parse(text);
    } catch (e) {
      return null;
    }
  }

  function observeOnce(rootId, onReady) {
    var root = document.getElementById(rootId);
    if (!root) return;

    try { onReady(root); } catch (e) { console.warn("[VSP_V28] onReady initial error", e); }

    var obs = new MutationObserver(function () {
      try { onReady(root); } catch (e) { console.warn("[VSP_V28] onReady mutation error", e); }
    });
    obs.observe(root, { childList: true, subtree: true });
  }

  /* ------------ COMMON SHELL ------------ */

  function wrapShellAndHeaders() {
    [
      { id: "vsp-dashboard-main",  title: "Dashboard",       sub: "CIO-level security posture & trends" },
      { id: "vsp-runs-main",       title: "Runs & Reports",  sub: "Lịch sử quét, CI/CD Gates & export báo cáo" },
      { id: "vsp-datasource-main", title: "Data Source",     sub: "Chi tiết unified findings & mini analytics" },
      { id: "vsp-settings-main",   title: "Settings",        sub: "Scan paths, tool stack & gate policy" },
      { id: "vsp-rules-main",      title: "Rule Overrides",  sub: "Override rule severity / scope" }
    ].forEach(function (cfg) {
      var el = document.getElementById(cfg.id);
      if (!el) return;

      if (!el.classList.contains("vsp-main-shell")) {
        el.classList.add("vsp-main-shell");
      }

      if (!el.querySelector(".vsp-tab-header")) {
        var header = document.createElement("div");
        header.className = "vsp-tab-header vsp-fadein vsp-fadein-delay-1";

        var hTitle = document.createElement("div");
        hTitle.className = "vsp-tab-header-title";
        hTitle.textContent = cfg.title;

        var hSub = document.createElement("div");
        hSub.className = "vsp-tab-header-sub";
        hSub.textContent = cfg.sub;

        header.appendChild(hTitle);
        header.appendChild(hSub);

        if (el.firstChild) el.insertBefore(header, el.firstChild);
        else el.appendChild(header);
      }
    });
  }

  /* ------------ DASHBOARD EXTRAS (Top risks + Delta) ------------ */

  function animateDashboardKpis() {
    var root = document.getElementById("vsp-dashboard-main");
    if (!root) return;
    var kpis = root.querySelectorAll(".vsp-kpi-card, .vsp-chart-card");
    kpis.forEach(function (card, idx) {
      if (!card.classList.contains("vsp-fadein")) {
        card.classList.add("vsp-fadein");
        card.classList.add("vsp-fadein-delay-" + ((idx % 6) + 1));
      }
    });
  }

  function buildDashboardExtras() {
    var root = document.getElementById("vsp-dashboard-main");
    if (!root) return;

    if (!root.querySelector(".vsp-dashboard-extras-grid")) {
      var extras = document.createElement("div");
      extras.className = "vsp-dashboard-extras-grid vsp-fadein vsp-fadein-delay-2";

      // Top 10 High/Critical
      var cardTop = document.createElement("div");
      cardTop.className = "vsp-table-card";
      var headerTop = document.createElement("div");
      headerTop.className = "vsp-table-card-header";
      var hTitle = document.createElement("div");
      hTitle.className = "vsp-table-card-title";
      hTitle.textContent = "Top 10 High / Critical Findings";
      var hSub = document.createElement("div");
      hSub.className = "vsp-table-card-sub";
      hSub.textContent = "Ưu tiên CRITICAL, đọc từ /api/vsp/datasource_v2.";
      headerTop.appendChild(hTitle); headerTop.appendChild(hSub);
      cardTop.appendChild(headerTop);
      var tableTop = document.createElement("table");
      tableTop.className = "vsp-table-compact";
      tableTop.innerHTML =
        "<thead><tr><th>#</th><th>Severity</th><th>Tool</th><th>Rule</th><th>CWE</th><th>File</th><th>Line</th></tr></thead>" +
        "<tbody id='vsp-dash-top-risks-body'><tr><td colspan='7'>Đang tải...</td></tr></tbody>";
      cardTop.appendChild(tableTop);

      // Delta
      var cardDelta = document.createElement("div");
      cardDelta.className = "vsp-table-card";
      var headerDelta = document.createElement("div");
      headerDelta.className = "vsp-table-card-header";
      var dTitle = document.createElement("div");
      dTitle.className = "vsp-table-card-title";
      dTitle.textContent = "What changed since last run?";
      var dSub = document.createElement("div");
      dSub.className = "vsp-table-card-sub";
      dSub.textContent = "So sánh 2 lần quét gần nhất (Total findings & xu hướng).";
      headerDelta.appendChild(dTitle); headerDelta.appendChild(dSub);
      cardDelta.appendChild(headerDelta);
      var tableDelta = document.createElement("table");
      tableDelta.className = "vsp-table-compact";
      tableDelta.innerHTML =
        "<thead><tr><th></th><th>Run ID</th><th>Total Findings</th><th>Time / Trend</th></tr></thead>" +
        "<tbody id='vsp-dash-delta-body'><tr><td colspan='4'>Đang tải...</td></tr></tbody>";
      cardDelta.appendChild(tableDelta);

      extras.appendChild(cardTop);
      extras.appendChild(cardDelta);
      root.appendChild(extras);

      fetchTopRisks();
      fetchDeltaRuns();
    }
  }

  function fetchTopRisks() {
    var tbody = document.getElementById("vsp-dash-top-risks-body");
    if (!tbody) return;

    fetch("/api/vsp/datasource_v2?limit=1000")
      .then(function (r) { return r.json(); })
      .then(function (data) {
        var items = data.items || [];
        var shortlist = items.filter(function (it) {
          return it.severity === "CRITICAL" || it.severity === "HIGH";
        });

        shortlist.sort(function (a, b) {
          var sA = a.severity === "CRITICAL" ? 2 : 1;
          var sB = b.severity === "CRITICAL" ? 2 : 1;
          if (sA !== sB) return sB - sA;
          return 0;
        });

        shortlist = shortlist.slice(0, 10);
        if (!shortlist.length) {
          tbody.innerHTML = "<tr><td colspan='7'>Không có High/Critical trong 1000 findings đầu.</td></tr>";
          return;
        }

        tbody.innerHTML = "";
        shortlist.forEach(function (it, idx) {
          var tr = document.createElement("tr");
          tr.innerHTML =
            "<td>" + (idx + 1) + "</td>" +
            "<td>" + (it.severity || "") + "</td>" +
            "<td>" + (it.tool || "") + "</td>" +
            "<td>" + (it.rule_id || it.rule || "") + "</td>" +
            "<td>" + (it.cwe || "") + "</td>" +
            "<td>" + (it.file || "").split("/").slice(-2).join("/") + "</td>" +
            "<td>" + (it.line || "") + "</td>";
          tbody.appendChild(tr);
        });
      })
      .catch(function () {
        tbody.innerHTML = "<tr><td colspan='7'>Lỗi tải dữ liệu.</td></tr>";
      });
  }

  function fetchDeltaRuns() {
    var tbody = document.getElementById("vsp-dash-delta-body");
    if (!tbody) return;

    fetch("/api/vsp/dashboard_v3")
      .then(function (r) { return r.json(); })
      .then(function (data) {
        var trend = data.trend_by_run || [];
        if (!Array.isArray(trend) || trend.length < 2) {
          tbody.innerHTML = "<tr><td colspan='4'>Chưa đủ dữ liệu trend (cần ≥ 2 run).</td></tr>";
          return;
        }

        trend.sort(function (a, b) {
          var ta = new Date(a.started_at || a.created_at || "").getTime();
          var tb = new Date(b.started_at || b.created_at || "").getTime();
          return tb - ta;
        });

        var latest = trend[0];
        var prev = trend[1];

        var totalLatest = latest.total_findings || latest.total || 0;
        var totalPrev = prev.total_findings || prev.total || 0;
        var delta = totalLatest - totalPrev;

        var badge = document.createElement("span");
        badge.className = "vsp-badge " +
          (delta > 0 ? "vsp-badge-red" : delta < 0 ? "vsp-badge-green" : "vsp-badge-amber");
        badge.textContent =
          delta > 0 ? ("▲ +" + delta) :
          delta < 0 ? ("▼ " + delta) :
          "No change";

        tbody.innerHTML = "";

        function row(label, obj, total) {
          var tr = document.createElement("tr");
          tr.innerHTML =
            "<td>" + label + "</td>" +
            "<td>" + (obj.run_id || "") + "</td>" +
            "<td>" + total + "</td>" +
            "<td>" + (obj.started_at || obj.created_at || "") + "</td>";
          return tr;
        }

        tbody.appendChild(row("Latest", latest, totalLatest));
        tbody.appendChild(row("Previous", prev, totalPrev));

        var trDelta = document.createElement("tr");
        trDelta.innerHTML =
          "<td>Delta</td><td></td><td>" + (delta >= 0 ? "+" : "") + delta + "</td><td></td>";
        trDelta.lastChild.appendChild(badge);
        tbody.appendChild(trDelta);
      })
      .catch(function () {
        tbody.innerHTML = "<tr><td colspan='4'>Lỗi tải dữ liệu.</td></tr>";
      });
  }

  /* ------------ GLOBAL CI GATE – floating card (mọi tab) ------------ */

  function createGlobalCiGateCard() {
    if (document.getElementById("vsp-ci-gate-global-card")) return;

    var card = document.createElement("div");
    card.id = "vsp-ci-gate-global-card";
    card.className = "vsp-table-card vsp-ci-gate-card vsp-fadein vsp-fadein-delay-3";
    card.style.position = "fixed";
    card.style.right = "24px";
    card.style.bottom = "24px";
    card.style.width = "320px";
    card.style.zIndex = "9999";
    card.style.boxShadow = "0 18px 45px rgba(15,23,42,0.9)";

    var header = document.createElement("div");
    header.className = "vsp-table-card-header";

    var title = document.createElement("div");
    title.className = "vsp-table-card-title";
    title.textContent = "CI Gate – Latest Run";

    var statusWrap = document.createElement("div");
    statusWrap.id = "vsp-ci-gate-status-pill";

    header.appendChild(title);
    header.appendChild(statusWrap);
    card.appendChild(header);

    var body = document.createElement("div");
    body.style.fontSize = "12px";
    body.innerHTML =
      "<div style='color:#9ca3af;margin-bottom:4px;' id='vsp-ci-gate-run-id'>Run: N/A</div>" +
      "<div style='margin-bottom:8px;'>Total findings: <span style='font-size:20px;font-weight:600' id='vsp-ci-gate-total'>N/A</span></div>" +
      "<div style='display:flex;flex-wrap:wrap;gap:6px;font-size:11px;margin-bottom:6px;' id='vsp-ci-gate-sev-chips'></div>" +
      "<div style='font-size:11px;color:#6b7280;display:flex;justify-content:space-between;align-items:center;'>" +
      "<span>Source: <span id='vsp-ci-gate-source'>N/A</span></span>" +
      "<a href='#runs' style='color:#38bdf8;text-decoration:none;'>View in Runs</a>" +
      "</div>";
    card.appendChild(body);

    var close = document.createElement("button");
    close.textContent = "×";
    close.style.position = "absolute";
    close.style.top = "4px";
    close.style.right = "8px";
    close.style.border = "none";
    close.style.background = "transparent";
    close.style.color = "#9ca3af";
    close.style.cursor = "pointer";
    close.style.fontSize = "14px";
    close.addEventListener("click", function () {
      card.style.display = "none";
    });
    card.appendChild(close);

    document.body.appendChild(card);
    fetchCiGateLatest();
  }

  function fetchCiGateLatest() {
    var runIdEl = document.getElementById("vsp-ci-gate-run-id");
    var totalEl = document.getElementById("vsp-ci-gate-total");
    var chipsEl = document.getElementById("vsp-ci-gate-sev-chips");
    var sourceEl = document.getElementById("vsp-ci-gate-source");
    var pillWrap = document.getElementById("vsp-ci-gate-status-pill");
    if (!runIdEl || !totalEl || !chipsEl || !sourceEl || !pillWrap) return;

    fetch("/api/vsp/dashboard_v3")
      .then(function (r) { return r.json(); })
      .then(function (dash) {
        var runId = dash.latest_run_id || "N/A";
        var total = dash.total_findings || 0;
        var sev = dash.by_severity || {};
        var score = dash.security_posture_score || 0;

        runIdEl.textContent = "Run: " + runId;
        totalEl.textContent = total;
        sourceEl.textContent = "FULL_EXT (dashboard_v3)";

        var status = "OK";
        var cls = "vsp-badge vsp-badge-green";
        if (score < 30) { status = "FAILED"; cls = "vsp-badge vsp-badge-red"; }
        else if (score < 60) { status = "WARN"; cls = "vsp-badge vsp-badge-amber"; }

        pillWrap.innerHTML = "";
        var pill = document.createElement("span");
        pill.className = cls;
        pill.textContent = status;
        pillWrap.appendChild(pill);

        chipsEl.innerHTML = "";
        var order = ["CRITICAL", "HIGH", "MEDIUM", "LOW", "INFO", "TRACE"];
        var labels = ["C", "H", "M", "L", "I", "T"];
        order.forEach(function (k, idx) {
          var val = sev[k] || 0;
          var chip = document.createElement("span");
          chip.style.borderRadius = "999px";
          chip.style.border = "1px solid rgba(148,163,184,0.6)";
          chip.style.padding = "2px 6px";
          chip.style.fontSize = "11px";
          chip.textContent = labels[idx] + ": " + val;
          chipsEl.appendChild(chip);
        });
      })
      .catch(function () {
        runIdEl.textContent = "Run: N/A";
        totalEl.textContent = "N/A";
        sourceEl.textContent = "N/A";
      });
  }

  /* ------------ RUNS TAB (KPI + filter + badges) ------------ */

  function enhanceRunsTab(root) {
    
    // === VSP_DISABLE_UI_EXTRAS_RUNS_BY_MASTER_V1 ===
    if (window.VSP_COMMERCIAL_RUNS_MASTER) {
      console.log('[VSP_UI_EXTRAS] skip enhanceRunsTab (commercial runs master)');
      return;
    }
    // === END VSP_DISABLE_UI_EXTRAS_RUNS_BY_MASTER_V1 ===
if (!root) return;

    var table = root.querySelector("table");
    if (!table) return;
    var tbody = table.querySelector("tbody");
    if (!tbody) return;

    // KPI grid
    if (!root.querySelector(".vsp-runs-kpi-grid")) {
      var grid = document.createElement("div");
      grid.className = "vsp-runs-kpi-grid";
      grid.style.display = "grid";
      grid.style.gridTemplateColumns = "repeat(4,minmax(0,1fr))";
      grid.style.gap = "16px";
      grid.style.marginBottom = "18px";

      function makeKpi(id, label, sub) {
        var card = document.createElement("div");
        card.className = "vsp-kpi-card vsp-fadein vsp-fadein-delay-2";
        card.id = id;

        var title = document.createElement("div");
        title.className = "vsp-kpi-title";
        title.textContent = label;

        var value = document.createElement("div");
        value.className = "vsp-kpi-value";
        value.textContent = "--";

        var desc = document.createElement("div");
        desc.className = "vsp-kpi-sub";
        desc.textContent = sub;

        card.appendChild(title);
        card.appendChild(value);
        card.appendChild(desc);
        return card;
      }

      grid.appendChild(makeKpi("vsp-runs-kpi-total", "TOTAL RUNS", "Tổng số lần scan"));
      grid.appendChild(makeKpi("vsp-runs-kpi-lastn", "LAST N RUNS", "kpi.last_n"));
      grid.appendChild(makeKpi("vsp-runs-kpi-avg", "AVG FINDINGS / RUN", "Trung bình trên last N"));
      grid.appendChild(makeKpi("vsp-runs-kpi-latest", "LATEST GATE", "Status / Gate latest run"));

      table.parentNode.insertBefore(grid, table);
      fetchRunsGateSummaryKpi();
    }

    // Filter bar
    if (!root.querySelector(".vsp-runs-filter-bar")) {
      var container = document.createElement("div");
      container.className = "vsp-filter-bar vsp-runs-filter-bar";

      var inpId = document.createElement("input");
      inpId.className = "vsp-filter-input";
      inpId.placeholder = "Filter Run ID...";
      container.appendChild(inpId);

      var inpStatus = document.createElement("input");
      inpStatus.className = "vsp-filter-input";
      inpStatus.placeholder = "Filter Status / Gate...";
      container.appendChild(inpStatus);

      table.parentNode.insertBefore(container, table);

      function applyFilter() {
        var qId = inpId.value.toLowerCase();
        var qStatus = inpStatus.value.toLowerCase();

        Array.from(tbody.rows).forEach(function (row) {
          var text = row.innerText.toLowerCase();
          var ok = true;
          if (qId && text.indexOf(qId) === -1) ok = false;
          if (qStatus && text.indexOf(qStatus) === -1) ok = false;
          row.style.display = ok ? "" : "none";
        });
      }

      inpId.addEventListener("input", applyFilter);
      inpStatus.addEventListener("input", applyFilter);
    }

    // Badges cho cột cuối
    Array.from(tbody.rows).forEach(function (row) {
      var cells = row.children;
      if (!cells.length) return;
      var last = cells[cells.length - 1];
      if (!last || last.querySelector(".vsp-badge")) return;

      var text = (last.textContent || "").trim();
      if (!text) return;

      var upper = text.toUpperCase();
      var cls = null;

      if (upper.includes("GREEN") || upper === "DONE" || upper === "PASS") {
        cls = "vsp-badge vsp-badge-green";
      } else if (upper.includes("AMBER") || upper === "WARN" || upper.includes("WARNING")) {
        cls = "vsp-badge vsp-badge-amber";
      } else if (upper.includes("RED") || upper === "FAIL" || upper.includes("ERROR")) {
        cls = "vsp-badge vsp-badge-red";
      }

      if (!cls) return;

      last.textContent = "";
      var span = document.createElement("span");
      span.className = cls;
      span.textContent = text;
      last.appendChild(span);
    });
  }

  function fetchRunsGateSummaryKpi() {
    var elTotal = document.querySelector("#vsp-runs-kpi-total .vsp-kpi-value");
    var elLastN = document.querySelector("#vsp-runs-kpi-lastn .vsp-kpi-value");
    var elAvg   = document.querySelector("#vsp-runs-kpi-avg .vsp-kpi-value");
    var elLatest= document.querySelector("#vsp-runs-kpi-latest .vsp-kpi-value");
    if (!elTotal || !elLastN || !elAvg || !elLatest) return;

    fetch("/api/vsp/runs_index_v3_fs?limit=40")
      .then(function (r) { return r.json(); })
      .then(function (data) {
        var items = data.items || [];
        var kpi = data.kpi || {};

        var totalRuns = kpi.total_runs || items.length || 0;
        var lastN = kpi.last_n || 0;
        var avgFind = kpi.avg_findings_per_run_last_n || null;

        var latest = items[0] || {};
        var latestStatus = (latest.status || "N/A");
        if (latest.ci_gate_status) latestStatus += " / " + latest.ci_gate_status;

        elTotal.textContent = totalRuns;
        elLastN.textContent = lastN || "N/A";
        elAvg.textContent   = avgFind != null ? Math.round(avgFind) : "N/A";
        elLatest.textContent= latestStatus;
      })
      .catch(function () {
        elTotal.textContent = elLastN.textContent = elAvg.textContent = elLatest.textContent = "N/A";
      });
  }

  /* ------------ DATA SOURCE (summary + mini chart + filter) ------------ */

  var dsCharts = { sev: null, tool: null };

  function enhanceDatasourceTab(root) {
    if (!root) return;
    var table = root.querySelector("table");
    if (!table) return;
    var tbody = table.querySelector("tbody");
    if (!tbody) return;

    // Summary card + mini canvases
    if (!root.querySelector(".vsp-ds-summary-card")) {
      var card = document.createElement("div");
      card.className = "vsp-table-card vsp-ds-summary-card vsp-fadein vsp-fadein-delay-2";

      var header = document.createElement("div");
      header.className = "vsp-table-card-header";

      var title = document.createElement("div");
      title.className = "vsp-table-card-title";
      title.textContent = "Data Source summary";

      var sub = document.createElement("div");
      sub.className = "vsp-table-card-sub";
      sub.textContent = "Mini chart & thống kê nhanh từ /api/vsp/datasource_v2 (limit=500).";

      header.appendChild(title); header.appendChild(sub);
      card.appendChild(header);

      var inner = document.createElement("div");
      inner.style.display = "grid";
      inner.style.gridTemplateColumns = "minmax(0,1.5fr) minmax(0,1fr)";
      inner.style.gap = "16px";

      var left = document.createElement("div");
      left.innerHTML =
        "<table class='vsp-table-compact'>" +
        "<thead><tr><th>METRIC</th><th>VALUE</th></tr></thead>" +
        "<tbody id='vsp-ds-summary-body'><tr><td colspan='2'>Đang tải...</td></tr></tbody>" +
        "</table>";

      var right = document.createElement("div");
      right.innerHTML =
        "<div style='height:110px;margin-bottom:8px;'><canvas id='vsp-ds-summary-sev-canvas'></canvas></div>" +
        "<div style='height:110px;'><canvas id='vsp-ds-summary-tool-canvas'></canvas></div>";

      inner.appendChild(left);
      inner.appendChild(right);
      card.appendChild(inner);

      var parent = table.parentNode || root;
      parent.insertBefore(card, table);

      fetchDatasourceSummaryAndCharts();
    }

    // Filter bar
    if (!root.querySelector(".vsp-ds-filter-bar")) {
      var container = document.createElement("div");
      container.className = "vsp-filter-bar vsp-ds-filter-bar";

      var inpSeverity = document.createElement("input");
      inpSeverity.className = "vsp-filter-input";
      inpSeverity.placeholder = "Severity (CRITICAL/HIGH/...)";
      container.appendChild(inpSeverity);

      var inpTool = document.createElement("input");
      inpTool.className = "vsp-filter-input";
      inpTool.placeholder = "Tool (semgrep, kics, ...)";
      container.appendChild(inpTool);

      table.parentNode.insertBefore(container, table);

      function applyFilter() {
        var qSev = inpSeverity.value.toLowerCase();
        var qTool = inpTool.value.toLowerCase();

        Array.from(tbody.rows).forEach(function (row) {
          var text = row.innerText.toLowerCase();
          var ok = true;
          if (qSev && text.indexOf(qSev) === -1) ok = false;
          if (qTool && text.indexOf(qTool) === -1) ok = false;
          row.style.display = ok ? "" : "none";
        });
      }

      inpSeverity.addEventListener("input", applyFilter);
      inpTool.addEventListener("input", applyFilter);
    }
  }

  function fetchDatasourceSummaryAndCharts() {
    var tbody = document.getElementById("vsp-ds-summary-body");
    if (!tbody) return;

    fetch("/api/vsp/datasource_v2?limit=500")
      .then(function (r) { return r.json(); })
      .then(function (data) {
        var items = data.items || [];

        var total = items.length;
        var bySev = {};
        var byTool = {};

        items.forEach(function (it) {
          var s = it.severity || "UNKNOWN";
          var t = it.tool || "UNKNOWN";
          bySev[s] = (bySev[s] || 0) + 1;
          byTool[t] = (byTool[t] || 0) + 1;
        });

        var sevParts = Object.keys(bySev).sort().map(function (k) {
          return k + ": " + bySev[k];
        });

        var toolParts = Object.keys(byTool).sort(function (a, b) {
          return byTool[b] - byTool[a];
        }).slice(0, 6).map(function (k) {
          return k + ": " + byTool[k];
        });

        tbody.innerHTML = "";
        function row(k, v) {
          var tr = document.createElement("tr");
          tr.innerHTML = "<td>" + k + "</td><td>" + v + "</td>";
          tbody.appendChild(tr);
        }

        row("Total findings (limit 500)", total);
        row("By severity", sevParts.join(" · "));
        row("Top tools", toolParts.join(" · "));

        renderDatasourceCharts(bySev, byTool);
      })
      .catch(function () {
        tbody.innerHTML = "<tr><td colspan='2'>Lỗi tải dữ liệu.</td></tr>";
      });
  }

  function renderDatasourceCharts(bySev, byTool) {
    if (typeof Chart === "undefined") {
      console.warn("[VSP_V28] Chart.js not available – skip DS mini charts");
      return;
    }

    var sevCanvas = document.getElementById("vsp-ds-summary-sev-canvas");
    var toolCanvas = document.getElementById("vsp-ds-summary-tool-canvas");
    if (!sevCanvas || !toolCanvas) return;

    var sevLabels = Object.keys(bySev);
    var sevData = sevLabels.map(function (k) { return bySev[k]; });

    var toolLabels = Object.keys(byTool).sort(function (a, b) {
      return byTool[b] - byTool[a];
    }).slice(0, 6);
    var toolData = toolLabels.map(function (k) { return byTool[k]; });

    if (dsCharts.sev) dsCharts.sev.destroy();
    if (dsCharts.tool) dsCharts.tool.destroy();

    dsCharts.sev = new Chart(sevCanvas.getContext("2d"), {
      type: "doughnut",
      data: {
        labels: sevLabels,
        datasets: [{ data: sevData }]
      },
      options: {
        plugins: { legend: { display: false } },
        maintainAspectRatio: false
      }
    });

    dsCharts.tool = new Chart(toolCanvas.getContext("2d"), {
      type: "bar",
      data: {
        labels: toolLabels,
        datasets: [{ data: toolData }]
      },
      options: {
        plugins: { legend: { display: false } },
        maintainAspectRatio: false,
        scales: { x: { ticks: { autoSkip: false, maxRotation: 60, minRotation: 30 } } }
      }
    });
  }

  /* ------------ SETTINGS ------------ */

  function enhanceSettingsTab(root) {
    if (!root) return;
    if (root.querySelector(".vsp-settings-summary-card")) return;

    var pre = root.querySelector("pre");
    if (!pre) return;

    var data = safeParseJSON(pre.textContent.trim());
    if (!data || typeof data !== "object") return;

    var settings = data.settings || {};

    var sumCard = document.createElement("div");
    sumCard.className = "vsp-table-card vsp-settings-summary-card vsp-fadein vsp-fadein-delay-2";

    var header = document.createElement("div");
    header.className = "vsp-table-card-header";
    var title = document.createElement("div");
    title.className = "vsp-table-card-title";
    title.textContent = "Settings summary";
    var sub = document.createElement("div");
    sub.className = "vsp-table-card-sub";
    sub.textContent = "Tổng quan cấu hình từ settings_ui_v1.";
    header.appendChild(title); header.appendChild(sub);
    sumCard.appendChild(header);

    var table = document.createElement("table");
    table.className = "vsp-table-compact";
    var rowsHtml = "";
    Object.keys(data).forEach(function (k, idx) {
      var v = data[k];
      var type = Array.isArray(v) ? "array" : typeof v;
      var extra = "";
      if (Array.isArray(v)) extra = v.length + " item(s)";
      else if (v && typeof v === "object") extra = Object.keys(v).length + " key(s)";
      rowsHtml += "<tr><td>" + (idx + 1) + "</td><td>" + k + "</td><td>" + type + "</td><td>" + extra + "</td></tr>";
    });
    table.innerHTML =
      "<thead><tr><th>#</th><th>Key</th><th>Type</th><th>Detail</th></tr></thead><tbody>" + rowsHtml + "</tbody>";
    sumCard.appendChild(table);

    var grid = document.createElement("div");
    grid.className = "vsp-dashboard-extras-grid vsp-fadein vsp-fadein-delay-3";

    // Scan config
    var scanCard = document.createElement("div");
    scanCard.className = "vsp-table-card";
    var scanHeader = document.createElement("div");
    scanHeader.className = "vsp-table-card-header";
    var scanTitle = document.createElement("div");
    scanTitle.className = "vsp-table-card-title";
    scanTitle.textContent = "Scan config (paths & exclude)";
    var scanSub = document.createElement("div");
    scanSub.className = "vsp-table-card-sub";
    scanSub.textContent = "Thư mục gốc, thư mục quét và pattern loại trừ.";
    scanHeader.appendChild(scanTitle); scanHeader.appendChild(scanSub);
    scanCard.appendChild(scanHeader);
    var scanTable = document.createElement("table");
    scanTable.className = "vsp-table-compact";
    var scan = settings.scan || {};
    var roots = scan.scan_roots || scan.roots || [];
    var excludes = scan.exclude_patterns || scan.excludes || [];
    if (!scan.project_root && !roots.length && !excludes.length) {
      scanTable.innerHTML = "<tbody><tr><td>Chưa cấu hình scan paths trong settings.scan.</td></tr></tbody>";
    } else {
      var sRows = "";
      sRows += "<tr><td>Project root</td><td>" + (scan.project_root || "N/A") + "</td></tr>";
      sRows += "<tr><td>Scan roots</td><td>" + (roots.length ? roots.join(', ') : "N/A") + "</td></tr>";
      sRows += "<tr><td>Excludes</td><td>" + (excludes.length ? excludes.join(', ') : "N/A") + "</td></tr>";
      scanTable.innerHTML =
        "<thead><tr><th>Field</th><th>Value</th></tr></thead><tbody>" + sRows + "</tbody>";
    }
    scanCard.appendChild(scanTable);

    // Tools
    var toolsCard = document.createElement("div");
    toolsCard.className = "vsp-table-card";
    var toolsHeader = document.createElement("div");
    toolsHeader.className = "vsp-table-card-header";
    var toolsTitle = document.createElement("div");
    toolsTitle.className = "vsp-table-card-title";
    toolsTitle.textContent = "Tool stack";
    var toolsSub = document.createElement("div");
    toolsSub.className = "vsp-table-card-sub";
    toolsSub.textContent = "Danh sách tool ON/OFF & profile.";
    toolsHeader.appendChild(toolsTitle); toolsHeader.appendChild(toolsSub);
    toolsCard.appendChild(toolsHeader);
    var toolsTable = document.createElement("table");
    toolsTable.className = "vsp-table-compact";
    var tools = settings.tools || {};
    var toolKeys = Object.keys(tools);
    if (!toolKeys.length) {
      toolsTable.innerHTML = "<tbody><tr><td>Chưa cấu hình tools trong settings.tools.</td></tr></tbody>";
    } else {
      var tRows = "";
      toolKeys.forEach(function (name) {
        var cfg = tools[name] || {};
        var enabled = cfg.enabled === false ? "OFF" : "ON";
        var profile = cfg.profile || cfg.mode || "-";
        tRows += "<tr><td>" + name + "</td><td>" + enabled + "</td><td>" + profile + "</td></tr>";
      });
      toolsTable.innerHTML =
        "<thead><tr><th>Tool</th><th>Enabled</th><th>Profile/Mode</th></tr></thead><tbody>" + tRows + "</tbody>";
    }
    toolsCard.appendChild(toolsTable);

    // CI Gate
    var gateCard = document.createElement("div");
    gateCard.className = "vsp-table-card";
    var gateHeader = document.createElement("div");
    gateHeader.className = "vsp-table-card-header";
    var gateTitle = document.createElement("div");
    gateTitle.className = "vsp-table-card-title";
    gateTitle.textContent = "CI/CD Gate policy";
    var gateSub = document.createElement("div");
    gateSub.className = "vsp-table-card-sub";
    gateSub.textContent = "Ngưỡng RED/AMBER/GREEN từ settings.ci_gate.";
    gateHeader.appendChild(gateTitle); gateHeader.appendChild(gateSub);
    gateCard.appendChild(gateHeader);
    var gateTable = document.createElement("table");
    gateTable.className = "vsp-table-compact";
    var ciGate = settings.ci_gate || {};
    var gateKeys = Object.keys(ciGate);
    if (!gateKeys.length) {
      gateTable.innerHTML = "<tbody><tr><td>Chưa cấu hình CI/CD Gate trong settings.ci_gate.</td></tr></tbody>";
    } else {
      var gRows = "";
      gateKeys.forEach(function (k) {
        var v = ciGate[k];
        var val;
        if (Array.isArray(v)) val = v.join(", ");
        else if (v && typeof v === "object") val = JSON.stringify(v);
        else val = String(v);
        gRows += "<tr><td>" + k + "</td><td>" + val + "</td></tr>";
      });
      gateTable.innerHTML =
        "<thead><tr><th>Key</th><th>Value</th></tr></thead><tbody>" + gRows + "</tbody>";
    }
    gateCard.appendChild(gateTable);

    grid.appendChild(scanCard);
    grid.appendChild(toolsCard);
    grid.appendChild(gateCard);

    pre.parentNode.insertBefore(sumCard, pre);
    pre.parentNode.insertBefore(grid, pre);
  }

  /* ------------ RULE OVERRIDES ------------ */

  function enhanceRulesTab(root) {
    if (!root) return;
    if (root.querySelector(".vsp-rules-summary-card")) return;

    var pre = root.querySelector("pre");
    if (!pre) return;

    var data = safeParseJSON(pre.textContent.trim());
    if (!data) return;

    var list = [];
    if (Array.isArray(data.items)) list = data.items;
    else if (Array.isArray(data.overrides)) list = data.overrides;
    else if (Array.isArray(data)) list = data;
    else if (typeof data === "object") {
      Object.keys(data).forEach(function (rid) {
        var v = data[rid];
        if (v && typeof v === "object") list.push(Object.assign({ rule_id: rid }, v));
      });
    }

    var card = document.createElement("div");
    card.className = "vsp-table-card vsp-rules-summary-card vsp-fadein vsp-fadein-delay-2";

    var header = document.createElement("div");
    header.className = "vsp-table-card-header";
    var title = document.createElement("div");
    title.className = "vsp-table-card-title";
    title.textContent = "Rule overrides summary";
    var sub = document.createElement("div");
    sub.className = "vsp-table-card-sub";
    sub.textContent = list.length
      ? "Các rule đang bị override severity / scope (rule_overrides_ui_v1)."
      : "Chưa có rule nào bị override (rule_overrides_ui_v1).";
    header.appendChild(title); header.appendChild(sub);
    card.appendChild(header);

    var table = document.createElement("table");
    table.className = "vsp-table-compact";
    if (!list.length) {
      table.innerHTML = "<tbody><tr><td>Không có overrides.</td></tr></tbody>";
    } else {
      var bodyHtml = "";
      list.slice(0, 50).forEach(function (ov, idx) {
        var rid = ov.rule_id || ov.id || "";
        var sev = ov.new_severity || ov.severity || "";
        var scope = ov.scope || ov.path || ov.module || "";
        bodyHtml += "<tr><td>" + (idx + 1) + "</td><td>" + rid + "</td><td>" + sev + "</td><td>" + scope + "</td></tr>";
      });
      table.innerHTML =
        "<thead><tr><th>#</th><th>Rule</th><th>Severity</th><th>Scope</th></tr></thead><tbody>" + bodyHtml + "</tbody>";
    }

    card.appendChild(table);
    pre.parentNode.insertBefore(card, pre);
  }

  /* ------------ BOOTSTRAP ------------ */

  function bootstrap() {
    try {
      wrapShellAndHeaders();
      animateDashboardKpis();
      buildDashboardExtras();
      createGlobalCiGateCard();
    } catch (e) {
      console.warn("[VSP_V28] bootstrap error", e);
    }

    observeOnce("vsp-runs-main", enhanceRunsTab);
    observeOnce("vsp-datasource-main", enhanceDatasourceTab);
    observeOnce("vsp-settings-main", enhanceSettingsTab);
    observeOnce("vsp-rules-main", enhanceRulesTab);
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", bootstrap);
  } else {
    bootstrap();
  }

  window.addEventListener("hashchange", function () {
    setTimeout(bootstrap, 200);
  });
})();


/* P0_DOM_FORM_IDS_FIX_V1: auto-fix duplicate ids + missing name/id for form fields */
(function(){
  'use strict';
  function run(){
    try{
      // 1) Fix duplicate IDs
      const byId = {};
      const all = Array.from(document.querySelectorAll("[id]"));
      for (const el of all){
        const id = el.getAttribute("id");
        if (!id) continue;
        byId[id] = byId[id] || [];
        byId[id].push(el);
      }
      for (const id of Object.keys(byId)){
        const arr = byId[id];
        if (arr.length <= 1) continue;
        for (let i=1;i<arr.length;i++){
          arr[i].setAttribute("id", id + "__dup" + i);
        }
        try{ console.info("[P0_IDS] fixed duplicate id:", id, "count=", arr.length); }catch(_){}
      }

      // 2) Ensure form controls have id or name (Chrome Issues)
      const ctrls = Array.from(document.querySelectorAll("input,select,textarea"));
      let k = 0;
      for (const el of ctrls){
        const tag = (el.tagName||"x").toLowerCase();
        const id = (el.getAttribute("id")||"").trim();
        const name = (el.getAttribute("name")||"").trim();
        if (!id && !name){
          const nid = "vsp_auto_" + tag + "_" + (++k);
          el.setAttribute("id", nid);
          el.setAttribute("name", nid);
        } else if (!name && id){
          el.setAttribute("name", id);
        } else if (!id && name){
          el.setAttribute("id", name);
        }
      }
    }catch(e){
      try{ console.warn("[P0_IDS] fixer error:", e && e.message ? e.message : e); }catch(_){}
    }
  }
  if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", run, {once:true});
  else run();
})();

})();
/* ==== END: static/js/vsp_ui_extras_v25.js ==== */

/* ==== BEGIN: static/js/vsp_ui_features_v1.js ==== */
(function(){
'use strict';
/* VSP_UI_FEATURES_V1 DISABLED (COMMERCIAL BUNDLE-ONLY) */
(function(){
  'use strict';
  try{
    // In commercial mode we never dynamically load other scripts.
    if (window && (window.__VSP_BUNDLE_COMMERCIAL_V2 || window.__VSP_BUNDLE_COMMERCIAL_V1)) return;
  }catch(_){}
})();

})();
/* ==== END: static/js/vsp_ui_features_v1.js ==== */

/* ==== BEGIN: static/js/vsp_ui_global_shims_commercial_p0_v1.js ==== */
(function(){
'use strict';
// VSP_SAFE_DRILLDOWN_HARDEN_P0_V6
/* VSP_FORCE_ASSET_VERSION_P0_V2
 * Force cache-bust for dynamically injected /static/js/*.js scripts.
 */
(function(){
  'use strict';
  if (window.__VSP_FORCE_ASSET_VERSION_P0_V2) return;
  window.__VSP_FORCE_ASSET_VERSION_P0_V2=1;

  function ver(){
    return (window.__VSP_ASSET_V || window.VSP_ASSET_V || '20251217_142944');
  }
  function rewrite(u){
    try {
      if(!u) return u;
      if(u.indexOf('/static/js/') === -1) return u;
      // remove any existing v= param
      u = u.replace(/[?&]v=[^&]+/g, '');
      u = u.replace(/[?&]$/, '');
      var sep = (u.indexOf('?') >= 0) ? '&' : '?';
      return u + sep + 'v=' + encodeURIComponent(ver());
    } catch(_e) {
      return u;
    }
  }

  var _append = Element.prototype.appendChild;
  Element.prototype.appendChild = function(node){
    try {
      if(node && node.tagName === 'SCRIPT' && node.src) node.src = rewrite(node.src);
    } catch(_e) {}
    return _append.call(this, node);
  };

  var _setAttr = Element.prototype.setAttribute;
  Element.prototype.setAttribute = function(name, value){
    try {
      if(this && this.tagName === 'SCRIPT' && (name === 'src' || name === 'SRC') && typeof value === 'string') {
        value = rewrite(value);
      }
    } catch(_e) {}
    return _setAttr.call(this, name, value);
  };
})();

/* VSP_UI_GLOBAL_SHIMS_COMMERCIAL_P0_V1
 * 목적: UI 안정화(P0)
 *  - Fix: __VSP_DD_ART_CALL__(VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2, ...) is not a function
 *  - Fetch fallback: run_status_v2 -> run_status_v1 (+ /v1/<rid>)
 *  - Soft-degrade for missing endpoints (never throw to console)
 */
(function(){
  'use strict';
  



/* VSP_FIX_DRILLDOWN_CALLSITE_P0_V5: safe-call drilldown artifacts (function OR object.open) */
function __VSP_DD_ART_CALL__(h, ...args) {
  try {
    if (typeof h === 'function') return h(...args);
    if (h && typeof h.open === 'function') return h.open(...args);
  } catch(e) { try{console.warn('[VSP][DD_SAFE]', e);}catch(_e){} }
  return null;
}

/* VSP_FIX_DRILLDOWN_CALLSITE_P0_V3: safe-call for drilldown artifacts (function OR object.open) */
function __VSP_DD_ART_CALL__(h, ...args) {
  try {
    if (typeof h === 'function') return h(...args);
    if (h && typeof h.open === 'function') return h.open(...args);
  } catch (e) {
    try { console.warn('[VSP][DD_SAFE] call failed', e); } catch (_e) {}
  }
  return null;
}

if (window.__VSP_UI_GLOBAL_SHIMS_COMMERCIAL_P0_V1) return;
  window.__VSP_UI_GLOBAL_SHIMS_COMMERCIAL_P0_V1 = 1;

  // ---- (A) normalize drilldown artifacts callable BEFORE anyone uses it ----
  function normalizeCallable(v){
    if (typeof v === 'function') return v;
    if (v && typeof v.open === 'function') {
      const obj = v;
      const fn = function(arg){
        try { return obj.open(arg); } catch(e){ try{ console.warn('[VSP][DD] open failed', e);}catch(_){} return null; }
      };
      fn.__wrapped_from_object = true;
      return fn;
    }
    const noop = function(_arg){ return null; };
    noop.__noop = true;
    return noop;
  }

  try{
    let _val = window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2;
    Object.defineProperty(window, 'VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2', {
      configurable: true, enumerable: true,
      get: function(){ return _val; },
      set: function(v){ _val = normalizeCallable(v); }
    });
    window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 = _val;
  }catch(e){
    window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 = normalizeCallable(window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2);
  }

  // ---- (B) fetch fallback (targeted) ----
  const _fetch = window.fetch ? window.fetch.bind(window) : null;

  // VSP_THROTTLE_DASHBOARD_EXTRAS_P0_V2: throttle + cache + cooldown for dashboard extras to avoid spam ERR_NETWORK_CHANGED
  let __vsp_extras_cache_text = '';
  let __vsp_extras_cache_ts = 0;
  let __vsp_extras_last_try = 0;
  let __vsp_extras_last_fail = 0;
  let __vsp_extras_inflight = null;

  function __vsp_resp_json(text, status=200){
    try {
      return new Response(text || '{}', {
        status: status,
        headers: {'content-type':'application/json; charset=utf-8'}
      });
    } catch(_e) {
      // older browsers fallback
      return new Response(text || '{}');
    }
  }

  async function __vsp_fetch_extras_with_cache(url, init){
    const now = Date.now();
    const THROTTLE_MS = 10_000;   // 1 req / 10s
    const COOLDOWN_MS = 30_000;   // after fail, skip 30s
    const CACHE_OK_MS = 120_000;  // serve cache up to 2 min

    // if hidden -> prefer cache (avoid background spam)
    if (document.hidden && (now - __vsp_extras_cache_ts) < CACHE_OK_MS && __vsp_extras_cache_text) {
      return __vsp_resp_json(__vsp_extras_cache_text, 200);
    }

    // cooldown after fail
    if ((now - __vsp_extras_last_fail) < COOLDOWN_MS) {
      if (__vsp_extras_cache_text) return __vsp_resp_json(__vsp_extras_cache_text, 200);
      return __vsp_resp_json('{}', 200);
    }

    // throttle
    if ((now - __vsp_extras_last_try) < THROTTLE_MS) {
      if (__vsp_extras_cache_text) return __vsp_resp_json(__vsp_extras_cache_text, 200);
      return __vsp_resp_json('{}', 200);
    }

    __vsp_extras_last_try = now;

    // de-dup inflight
    if (__vsp_extras_inflight) {
      const t = await __vsp_extras_inflight;
      return __vsp_resp_json(t, 200);
    }

    __vsp_extras_inflight = (async () => {
      try {
        const r = await _fetch(url, init);
        const t = await r.text();
        if (r && r.ok) {
          __vsp_extras_cache_text = t || '{}';
          __vsp_extras_cache_ts = Date.now();
        }
        return (t || '{}');
      } catch(_e) {
        __vsp_extras_last_fail = Date.now();
        return (__vsp_extras_cache_text || '{}');
      } finally {
        __vsp_extras_inflight = null;
      }
    })();

    const txt = await __vsp_extras_inflight;
    return __vsp_resp_json(txt, 200);
  }
  if (_fetch) {
    function parseRidFromUrl(u){
      try{
        const url = new URL(u, window.location.origin);
        return url.searchParams.get('rid') || '';
      }catch(_){ return ''; }
    }
    function swapEndpoint(u, from, to){
      try { return u.replace(from, to); } catch(_) { return u; }
    }
    async function tryFetch(u, init){
      try { return await _fetch(u, init); } catch(_) { return null; }
    }

    window.fetch = async function(input, init){
      const url = (typeof input === 'string') ? input : (input && input.url ? input.url : '');

      // VSP_THROTTLE_DASHBOARD_EXTRAS_P0_V2: intercept dashboard extras first (avoid repeated failed XHR spam)
      if (url && url.includes('/api/vsp/dashboard_v3_extras_v1')) {
        return await __vsp_fetch_extras_with_cache(url, init);
      }
      let res = null;

      // first attempt
      res = await tryFetch(input, init);

      // if ok => return
      if (res && res.ok) return res;

      // targeted fallbacks
      if (url.includes('/api/vsp/run_status_v2')) {
        const rid = parseRidFromUrl(url);
        // 1) v2 -> v1 (same query)
        let u1 = swapEndpoint(url, '/api/vsp/run_status_v2', '/api/vsp/run_status_v1');
        let r1 = await tryFetch(u1, init);
        if (r1 && r1.ok) return r1;

        // 2) path form /run_status_v1/<rid>
        if (rid) {
          let u2 = '/api/vsp/run_status_v1/' + encodeURIComponent(rid);
          let r2 = await tryFetch(u2, init);
          if (r2 && r2.ok) return r2;
        }
        return res || r1 || null;
      }

      if (url.includes('/api/vsp/findings_effective_v1')) {
        const rid = parseRidFromUrl(url);
        // try path form /findings_effective_v1/<rid>
        if (rid) {
          let u2 = '/api/vsp/findings_effective_v1/' + encodeURIComponent(rid);
          let r2 = await tryFetch(u2, init);
          if (r2 && r2.ok) return r2;
        }
        // no hard fallback => return original (avoid throwing)
        return res;
      }

      // default: return original result (even if null)
      return res;
    };
  }
})();

/* __VSP_FIX_DD_ALIAS_P0_V1: make drilldown handler callable even if it is an object (.open) */
(function(){
  'use strict';
  if (window.__VSP_FIX_DD_ALIAS_P0_V1) return;
  window.__VSP_FIX_DD_ALIAS_P0_V1 = 1;

  // Safe call: function OR {open: fn}
  window.__VSP_DD_ART_CALL__ = window.__VSP_DD_ART_CALL__ || function(h){
    try{
      var args = Array.prototype.slice.call(arguments, 1);
      if (typeof h === 'function') return h.apply(null, args);
      if (h && typeof h.open === 'function') return h.open.apply(h, args);
    }catch(e){
      try{ console.warn('[VSP][DD_SAFE]', e); }catch(_){}
    }
    return null;
  };

  // If VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 is NOT a function but exists, wrap it
  try{
    var h = window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2;
    if (h && typeof h !== 'function'){
      window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 = function(){
        return window.__VSP_DD_ART_CALL__.apply(null, [h].concat([].slice.call(arguments)));
      };
      try{ console.log('[VSP][P0] drilldown alias wrapped (obj->fn)'); }catch(_){}
    }
    // If missing entirely, provide a harmless no-op function (avoid hard crash)
    if (!window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2){
      window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 = function(){
        try{ console.warn('[VSP][P0] drilldown handler missing; noop'); }catch(_){}
        return null;
      };
    }
  }catch(e){
    try{ console.warn('[VSP][P0] drilldown alias init failed', e); }catch(_){}
  }
})();


})();
/* ==== END: static/js/vsp_ui_global_shims_commercial_p0_v1.js ==== */

/* ==== BEGIN: static/js/vsp_ui_hide_runs_strip_on_other_tabs_p1_v1.js ==== */
(function(){
'use strict';
(function(){
  'use strict';
  if (window.__VSP_HIDE_RUNS_STRIP_P1_V1) return;
  window.__VSP_HIDE_RUNS_STRIP_P1_V1 = true;

  const TAG='VSP_HIDE_RUNS_STRIP_P1_V1';

  function findRunsStrip(){
    // Heuristic: find the bar that contains "Limit" + "Has findings" + "Degraded" near the top
    const els=[...document.querySelectorAll('div,section,header')];
    for (const el of els){
      const tx=(el.innerText||'');
      if (tx.includes('Limit') && tx.includes('Has findings') && tx.includes('Degraded') && tx.includes('Search')){
        return el;
      }
    }
    return null;
  }

  function setVisible(isRuns){
    const strip=findRunsStrip();
    if (!strip) return;
    // hide the whole parent block (usually card/container)
    const box = strip.closest('.vsp-card, .dashboard-card, section, div') || strip;
    box.style.display = isRuns ? '' : 'none';
  }

  function onRoute(){
    const h=(location.hash||'').toLowerCase();
    const isRuns = (h==='#runs' || h.startsWith('#runs'));
    setVisible(isRuns);
    console.log(`[${TAG}] route=${h} isRuns=${isRuns}`);
  }

  window.addEventListener('hashchange', onRoute);
  if (document.readyState==='loading') document.addEventListener('DOMContentLoaded', onRoute, {once:true});
  else onRoute();
})();

})();
/* ==== END: static/js/vsp_ui_hide_runs_strip_on_other_tabs_p1_v1.js ==== */

/* ==== BEGIN: static/js/vsp_ui_loader_route_p0_v2.js ==== */
(function(){
'use strict';
/* VSP_UI_LOADER_ROUTE_P0_V2: route-scoped loader that never blocks UI */
(function(){
  'use strict';

/* __VSP_DD_SAFE_CALL__ (P0): call handler as fn OR {open: fn} */
(function(){
  'use strict';
  if (window.__VSP_DD_SAFE_CALL__) return;
  window.__VSP_DD_SAFE_CALL__ = function(handler){
    try{
      var args = Array.prototype.slice.call(arguments, 1);
      if (typeof handler === 'function') return handler.apply(null, args);
      if (handler && typeof handler.open === 'function') return handler.open.apply(handler, args);
    }catch(e){
      try{ console.warn('[VSP][DD_SAFE_CALL]', e); }catch(_){}
    }
    return null;
  };
})();


  if (window.__VSP_UI_LOADER_ROUTE_P0_V2) return;
  window.__VSP_UI_LOADER_ROUTE_P0_V2 = 1;

  const log = (...a)=>{ try{ console.log("[VSP_LOADER_P0_V2]", ...a); }catch(_){} };
  const warn = (...a)=>{ try{ console.warn("[VSP_LOADER_P0_V2]", ...a); }catch(_){} };

  const loaded = new Map(); // url -> Promise<{ok:boolean}>
  function injectScript(url){
    if (loaded.has(url)) return loaded.get(url);
    const p = new Promise((resolve)=>{
      try{
        const s = document.createElement("script");
        s.src = url;
        s.async = true;
        s.crossOrigin = "anonymous";
        let done = false;
        const finish = (ok, why)=>{
          if (done) return;
          done = true;
          if (!ok) warn("script failed/degraded:", url, why||"");
          resolve({ok: !!ok});
        };
        s.onload = ()=>finish(true);
        s.onerror = ()=>finish(false, "onerror");
        // HARD fail-safe: never hang waiting for onload
        setTimeout(()=>finish(false, "timeout"), 4000);
        (document.head || document.documentElement).appendChild(s);
      }catch(e){
        warn("inject exception:", url, e);
        resolve({ok:false});
      }
    });
    loaded.set(url, p);
    return p;
  }

  function featOn(key){
    try{
      const f = window.VSP_UI_FEATURES_V1 || window.__VSP_UI_FEATURES_V1 || null;
      if (!f) return true; // default ON if missing
      if (typeof f === "function") return !!f(key);
      if (typeof f === "object") return !!f[key];
    }catch(_){}
    return true;
  }

  const ROUTE_SCRIPTS = {
    dashboard: [
      "/static/js/vsp_dashboard_enhance_v1.js",
      "/static/js/vsp_dashboard_charts_pretty_v3.js",
      "/static/js/vsp_degraded_panel_hook_v3.js"
    ],
    runs: ["/static/js/vsp_runs_tab_resolved_v1.js"],
    datasource: ["/static/js/vsp_datasource_tab_v1.js"],
    settings: ["/static/js/vsp_settings_tab_v1.js"],
    rules: ["/static/js/vsp_rule_overrides_tab_v1.js"],
  };

  function normRoute(){
    const h = (location.hash || "").replace(/^#/, "");
    const r = (h.split("&")[0] || "").trim().toLowerCase();
    if (!r) return "dashboard";
    if (r === "artifacts") return "datasource";
    return r;
  }

  async function applyRoute(){
    const r = normRoute();
    const scripts = ROUTE_SCRIPTS[r] || [];
    log("route=", r, "scripts=", scripts);

    // feature gates (matching your toggles)
    if (r === "dashboard" && !featOn("DASHBOARD_CHARTS")) return;
    if (r === "runs" && !featOn("RUNS_PANEL")) return;
    if (r === "datasource" && !featOn("DATASOURCE_TAB")) return;
    if (r === "settings" && !featOn("SETTINGS_TAB")) return;
    if (r === "rules" && !featOn("RULE_OVERRIDES_TAB")) return;

    // load in-order but never block forever
    for (const u of scripts) {
      // add cache-buster that changes on each hard refresh anyway; keep stable per page load
      const url = u + (u.includes("?") ? "&" : "?") + "v=" + (window.__VSP_LOADER_CB || (window.__VSP_LOADER_CB = Date.now()));
      await injectScript(url);
    }

    try{
      // Some modules may expose a markStable; call if exists
      if (typeof window.__vsp_markStable === "function") window.__vsp_markStable();
    }catch(_){}
  }

  window.addEventListener("hashchange", ()=>{ applyRoute(); });
  // initial
  setTimeout(()=>applyRoute(), 0);
})();

})();
/* ==== END: static/js/vsp_ui_loader_route_p0_v2.js ==== */

/* ==== BEGIN: static/js/vsp_ui_main.js ==== */
(function(){
'use strict';
(() => {
  const API = {
    dashboard: "/api/vsp/dashboard_v3",
    trend: "/api/vsp/trend_v1",
    runsIndex: "/api/vsp/runs_index_v3",
    datasource: "/api/vsp/datasource_v2",
    settings: "/api/vsp/settings/get",
    overrides: "/api/vsp/overrides/list",
    topFindings: "/api/vsp/top_findings_v1?limit=20",
  };

  // Charts
  let severityDonut = null;
  let trendChart = null;
  let dsChartSeverity = null;
  let dsChartTool = null;
  let dsChartCwe = null;
  let dsChartDir = null;

  // Data cache
  let runsRaw = [];
  let dsRawItems = [];
  let dsPage = 1;
  const DS_PAGE_SIZE = 50;

  function showToast(message, type = "info") {
    const toast = document.getElementById("vsp-toast");
    if (!toast) return;
    toast.textContent = message;
    toast.className = "vsp-toast";
    toast.classList.add("show", `vsp-toast-${type}`);
    setTimeout(() => {
      toast.classList.remove("show");
    }, 3500);
  }

  async function fetchJSON(url, opts = {}) {
    try {
      const res = await fetch(url, opts);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return await res.json();
    } catch (err) {
      console.error("Fetch error", url, err);
      showToast(`Lỗi tải dữ liệu: ${url}`, "error");
      return null;
    }
  }

  /* ====================== TAB / HEADER ====================== */

  function initTabs() {
    const buttons = document.querySelectorAll(".vsp-tab-btn");
    const panes = document.querySelectorAll(".vsp-tab-pane");

    buttons.forEach((btn) => {
      btn.addEventListener("click", () => {
        const tab = btn.dataset.tab;
        buttons.forEach((b) =>
          b.classList.toggle("active", b === btn)
        );
        panes.forEach((p) =>
          p.classList.toggle("active", p.id === `tab-${tab}`)
        );
      });
    });
  }

  function initRunButton() {
    const btn = document.getElementById("vsp-run-btn");
    if (!btn) return;
    btn.addEventListener("click", () => {
      // Phase sau nối real pipeline; giờ chỉ toast.
      showToast(
        "RUN FULL SCAN: nối với run_vsp_full_ext.sh hoặc API trigger trong phase sau.",
        "info"
      );
    });
  }

  async function loadSettingsAndHeader() {
    const data = await fetchJSON(API.settings);
    const envChip = document.getElementById("vsp-env-chip");
    const srcChip = document.getElementById("vsp-src-chip");

    if (!data) {
      if (envChip) envChip.textContent = "PROFILE: EXT+";
      if (srcChip) srcChip.textContent = "SRC: --";
      return;
    }

    const profile =
      data.profile ||
      data.PROFILE ||
      data.profile_name ||
      "EXT+";
    const src =
      data.src_path ||
      data.source_path ||
      data.repo ||
      data.src ||
      "--";

    if (envChip) envChip.textContent = `PROFILE: ${profile}`;
    if (srcChip) srcChip.textContent = `SRC: ${src}`;

    // Tool stack TAB 4
    const tbody = document.getElementById("vsp-tools-tbody");
    if (tbody && Array.isArray(data.tools)) {
      tbody.innerHTML = "";
      data.tools.forEach((t) => {
        const status = t.enabled === false ? "DISABLED" : "ENABLED";
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${t.name || ""}</td>
          <td>${t.description || ""}</td>
          <td>${status}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Env grid TAB 4
    const envGrid = document.getElementById("vsp-env-grid");
    if (envGrid) {
      envGrid.innerHTML = "";
      const entries = [
        ["Profile", profile],
        ["Source path", src],
        ["Last run id", data.last_run_id || data.last_run || "--"],
        ["Last run time", data.last_run_ts || data.last_run_time || "--"],
        ["Bundle out dir", data.out_dir || data.bundle_dir || "--"],
      ];
      entries.forEach(([label, value]) => {
        const div = document.createElement("div");
        div.className = "vsp-env-item";
        div.innerHTML = `
          <div class="vsp-env-label">${label}</div>
          <div class="vsp-env-value">${value}</div>
        `;
        envGrid.appendChild(div);
      });
    }
  }

  /* ====================== TAB 1 – DASHBOARD ====================== */

  function renderKpis(dash) {
    const by = dash.by_severity || dash.bySeverity || {};
    const get = (k) => by[k] || 0;

    const total = dash.total_findings || dash.total || 0;
    const sevCritical = get("CRITICAL");
    const sevHigh = get("HIGH");
    const sevMed = get("MEDIUM");
    const sevLow = get("LOW");
    const sevInfo = get("INFO");
    const sevTrace = get("TRACE");

    const elTotal = document.getElementById("kpi-total");
    const elCritical = document.getElementById("kpi-critical");
    const elHigh = document.getElementById("kpi-high");
    const elMedium = document.getElementById("kpi-medium");
    const elLow = document.getElementById("kpi-low");
    const elInfoTrace = document.getElementById("kpi-info-trace");

    if (elTotal) elTotal.textContent = total;
    if (elCritical) elCritical.textContent = sevCritical;
    if (elHigh) elHigh.textContent = sevHigh;
    if (elMedium) elMedium.textContent = sevMed;
    if (elLow) elLow.textContent = sevLow;
    if (elInfoTrace) elInfoTrace.textContent = sevInfo + sevTrace;

    const sub = document.getElementById("vsp-last-run-subtitle");
    const meta = document.getElementById("vsp-last-run-meta");
    if (sub) {
      sub.textContent = dash.run_id
        ? `Last run: ${dash.run_id}`
        : "No run yet.";
    }
    if (meta) {
      const score =
        dash.security_score !== undefined ? dash.security_score : dash.score;
      const tool = dash.top_risky_tool || dash.top_tool || "--";
      const cwe = dash.top_cwe || "--";
      const module = dash.top_module || "--";
      meta.innerHTML = `
        <span class="vsp-meta-chip">
          Security Score: <strong>${score ?? "--"}</strong>
        </span>
        <span class="vsp-meta-chip">
          Top tool: <strong>${tool}</strong>
        </span>
        <span class="vsp-meta-chip">
          Top CWE: <strong>${cwe}</strong>
        </span>
        <span class="vsp-meta-chip">
          Top module: <strong>${module}</strong>
        </span>
      `;
    }
  }

  function renderSeverityDonut(dash) {
    const ctx = document.getElementById("chart-severity-donut");
    if (!ctx || typeof Chart === "undefined") return;

    const raw = dash.by_severity || dash.bySeverity || {};
    const order = ["CRITICAL", "HIGH", "MEDIUM", "LOW", "INFO", "TRACE"];
    const data = order.map((k) => raw[k] || 0);

    if (severityDonut) {
      severityDonut.data.labels = order;
      severityDonut.data.datasets[0].data = data;
      severityDonut.update();
      return;
    }

    severityDonut = new Chart(ctx, {
      type: "doughnut",
      data: {
        labels: order,
        datasets: [
          {
            data,
            borderWidth: 0,
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        cutout: "60%",
        plugins: {
          legend: {
            position: "bottom",
            labels: {
              boxWidth: 10,
              font: { size: 10 },
            },
          },
        },
      },
    });
  }

  function renderByToolList(dash) {
    const ul = document.getElementById("vsp-bytool-list");
    if (!ul) return;

    const byTool = dash.by_tool || dash.byTool;
    if (!byTool || typeof byTool !== "object") {
      ul.innerHTML = `<li><span>No by_tool data</span><span>--</span></li>`;
      return;
    }

    const entries = Object.entries(byTool)
      .map(([tool, cnt]) => ({ tool, cnt }))
      .sort((a, b) => b.cnt - a.cnt)
      .slice(0, 6);

    ul.innerHTML = "";
    entries.forEach((item) => {
      const li = document.createElement("li");
      li.innerHTML = `
        <span>${item.tool}</span>
        <span>${item.cnt}</span>
      `;
      ul.appendChild(li);
    });
  }

  function renderTrend(trend) {
    const ctx = document.getElementById("chart-trend");
    if (!ctx || typeof Chart === "undefined") return;
    if (!trend) return;

    const points = Array.isArray(trend.points) ? trend.points : trend;
    if (!Array.isArray(points)) return;

    const labels = points.map((p) => p.label || p.ts || p.run_id || "");
    const data = points.map((p) => p.total || p.total_findings || 0);

    if (trendChart) {
      trendChart.data.labels = labels;
      trendChart.data.datasets[0].data = data;
      trendChart.update();
      return;
    }

    trendChart = new Chart(ctx, {
      type: "line",
      data: {
        labels,
        datasets: [
          {
            label: "Total findings",
            data,
            tension: 0.25,
            fill: false,
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false,
          },
        },
        scales: {
          x: {
            ticks: { maxRotation: 0, font: { size: 9 } },
          },
          y: {
            beginAtZero: true,
          },
        },
      },
    });
  }

  async function loadTopFindings() {
    const data = await fetchJSON(API.topFindings);
    if (!data || !Array.isArray(data.items)) return;

    // Bảng Top Risk Findings là bảng compact đầu tiên trong Findings zone
    const table = document.querySelector(
      "#tab-dashboard .vsp-risk-mid-grid .vsp-risk-card:nth-child(1) table.vsp-table-compact"
    );
    if (!table) return;
    const tbody = table.querySelector("tbody");
    if (!tbody) return;

    tbody.innerHTML = "";
    data.items.slice(0, 8).forEach((f) => {
      const sev = f.severity || f.severity_effective || "INFO";
      const sevClass =
        sev === "CRITICAL"
          ? "sev-critical"
          : sev === "HIGH"
          ? "sev-high"
          : "";

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><span class="vsp-badge ${sevClass}">${sev}</span></td>
        <td>${f.file || f.location || ""}${
        f.line ? `:${f.line}` : ""
      }</td>
        <td>${f.cwe || f.rule_id || f.rule_name || ""}</td>
        <td>${f.tool || ""}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  async function loadDashboard() {
    const dash = await fetchJSON(API.dashboard);
    if (!dash) return;

    renderKpis(dash);
    renderSeverityDonut(dash);
    renderByToolList(dash);

    const trend = await fetchJSON(API.trend);
    if (trend) {
      renderTrend(trend);
    }

    loadTopFindings().catch((e) =>
      console.warn("Top findings failed", e)
    );
  }

  /* ====================== TAB 2 – RUNS & REPORTS ====================== */

  function ensureRunsKpiStrip() {
    const panelBody = document.querySelector(
      ".vsp-panel-runs-list .vsp-panel-body"
    );
    if (!panelBody) return null;

    let kpiStrip = panelBody.querySelector(".vsp-runs-kpi-strip");
    const table = panelBody.querySelector("table");
    if (!table) return null;

    if (!kpiStrip) {
      kpiStrip = document.createElement("div");
      kpiStrip.className = "vsp-runs-kpi-strip";
      kpiStrip.innerHTML = `
        <div class="vsp-kpi-mini">
          <div class="label">Total runs</div>
          <div class="value" id="runs-kpi-total-runs">--</div>
        </div>
        <div class="vsp-kpi-mini">
          <div class="label">Last 10: OK/Fail</div>
          <div class="value" id="runs-kpi-ok-fail">--</div>
        </div>
        <div class="vsp-kpi-mini">
          <div class="label">Avg findings/run</div>
          <div class="value" id="runs-kpi-avg">--</div>
        </div>
        <div class="vsp-kpi-mini">
          <div class="label">Tools enabled</div>
          <div class="value" id="runs-kpi-tools">--</div>
        </div>
      `;
      panelBody.insertBefore(kpiStrip, table);
    }
    return kpiStrip;
  }

  function ensureRunsFilters() {
    const panelBody = document.querySelector(
      ".vsp-panel-runs-list .vsp-panel-body"
    );
    if (!panelBody) return;

    let filterBar = panelBody.querySelector(".vsp-runs-filters");
    const table = panelBody.querySelector("table");
    if (!table) return;

    if (!filterBar) {
      filterBar = document.createElement("div");
      filterBar.className = "vsp-runs-filters";
      filterBar.innerHTML = `
        <select id="runs-filter-profile">
          <option value="">Profile: All</option>
          <option value="FAST">FAST</option>
          <option value="EXT">EXT</option>
          <option value="EXT+">EXT+</option>
          <option value="AGGR">AGGR</option>
          <option value="FULL">FULL</option>
        </select>
        <select id="runs-filter-tool">
          <option value="">Tool: All</option>
          <option value="semgrep">semgrep</option>
          <option value="gitleaks">gitleaks</option>
          <option value="bandit">bandit</option>
          <option value="kics">kics</option>
          <option value="trivy_fs">trivy_fs</option>
          <option value="grype">grype</option>
          <option value="syft">syft</option>
          <option value="codeql">codeql</option>
        </select>
        <select id="runs-filter-range">
          <option value="all">All time</option>
          <option value="7d">Last 7 days</option>
          <option value="30d">Last 30 days</option>
        </select>
        <input id="runs-filter-search" placeholder="Search run id / SRC / URL / commit..." />
        <button id="runs-filter-apply" class="vsp-btn-secondary">Apply</button>
      `;
      panelBody.insertBefore(filterBar, table);
    }

    const applyBtn = document.getElementById("runs-filter-apply");
    if (applyBtn && !applyBtn.dataset._bound) {
      applyBtn.dataset._bound = "1";
      applyBtn.addEventListener("click", renderRunsTable);
    }
  }

  function applyRunsFilter(list) {
    const profileSel = document.getElementById("runs-filter-profile");
    const toolSel = document.getElementById("runs-filter-tool");
    const rangeSel = document.getElementById("runs-filter-range");
    const searchInput = document.getElementById("runs-filter-search");

    const profile = profileSel ? profileSel.value : "";
    const tool = toolSel ? toolSel.value : "";
    const range = rangeSel ? rangeSel.value : "all";
    const q = searchInput ? searchInput.value.trim().toLowerCase() : "";

    let filtered = list.slice();

    if (profile) {
      filtered = filtered.filter((r) => {
        const p = (r.profile || r.profile_name || "").toUpperCase();
        return p.includes(profile.toUpperCase());
      });
    }

    if (tool) {
      filtered = filtered.filter((r) => {
        const byTool = r.by_tool || {};
        return Object.prototype.hasOwnProperty.call(byTool, tool);
      });
    }

    if (range !== "all") {
      const now = new Date();
      const days =
        range === "7d" ? 7 : range === "30d" ? 30 : 0;
      if (days > 0) {
        const cutoff = now.getTime() - days * 24 * 60 * 60 * 1000;
        filtered = filtered.filter((r) => {
          const tsString = r.ts || r.time || r.timestamp;
          if (!tsString) return true;
          const t = new Date(tsString).getTime();
          if (Number.isNaN(t)) return true;
          return t >= cutoff;
        });
      }
    }

    if (q) {
      filtered = filtered.filter((r) => {
        const src =
          r.src ||
          r.src_path ||
          r.source ||
          "";
        const url = r.url || r.app_url || "";
        const commit = r.commit || r.git_commit || "";
        const runId = r.run_id || "";
        const haystack = `${runId} ${src} ${url} ${commit}`.toLowerCase();
        return haystack.includes(q);
      });
    }

    return filtered;
  }

  function renderRunsKpis() {
    ensureRunsKpiStrip();
    const totalRuns = runsRaw.length;
    const last10 = runsRaw.slice(0, 10);
    const ok = last10.filter(
      (r) => r.status === "OK" || r.ok === true
    ).length;
    const fail = last10.length - ok;

    const avg =
      totalRuns === 0
        ? 0
        : Math.round(
            runsRaw.reduce(
              (s, r) => s + (r.total_findings || r.total || 0),
              0
            ) / totalRuns
          );

    const toolsSet = new Set();
    runsRaw.forEach((r) => {
      const byTool = r.by_tool || {};
      Object.keys(byTool).forEach((t) => toolsSet.add(t));
    });

    const elTotal = document.getElementById("runs-kpi-total-runs");
    const elOkFail = document.getElementById("runs-kpi-ok-fail");
    const elAvg = document.getElementById("runs-kpi-avg");
    const elTools = document.getElementById("runs-kpi-tools");

    if (elTotal) elTotal.textContent = totalRuns;
    if (elOkFail) elOkFail.textContent = `${ok}/${fail}`;
    if (elAvg) elAvg.textContent = avg;
    if (elTools) elTools.textContent = toolsSet.size;
  }

  function renderRunDetail(run) {
    const subtitle = document.getElementById("vsp-run-detail-subtitle");
    const link = document.getElementById("vsp-run-report-link");
    const container = document.getElementById("vsp-run-detail-content");

    if (subtitle) {
      subtitle.textContent = `Run: ${
        run.run_id
      } – ${run.ts || run.time || ""}`;
    }

    if (link) {
      if (run.report_html) {
        link.href = run.report_html;
        link.classList.remove("vsp-link-hidden");
      } else {
        link.href = "#";
        link.classList.add("vsp-link-hidden");
      }
    }

    if (!container) return;
    container.innerHTML = "";

    const by = run.by_severity || run.bySeverity || {};
    const byTool = run.by_tool || run.byTool || {};

    const severityCard = document.createElement("div");
    severityCard.className = "vsp-run-detail-card";
    severityCard.innerHTML = `
      <h4>By severity</h4>
      <ul class="vsp-run-detail-list">
        <li>CRITICAL: ${by.CRITICAL || 0}</li>
        <li>HIGH: ${by.HIGH || 0}</li>
        <li>MEDIUM: ${by.MEDIUM || 0}</li>
        <li>LOW: ${by.LOW || 0}</li>
        <li>INFO: ${by.INFO || 0}</li>
        <li>TRACE: ${by.TRACE || 0}</li>
      </ul>
    `;
    container.appendChild(severityCard);

    const toolCard = document.createElement("div");
    toolCard.className = "vsp-run-detail-card";
    const toolList = Object.entries(byTool)
      .map(([tool, cnt]) => `<li>${tool}: ${cnt}</li>`)
      .join("");
    toolCard.innerHTML = `
      <h4>By tool</h4>
      <ul class="vsp-run-detail-list">
        ${toolList || "<li>No by_tool data</li>"}
      </ul>
    `;
    container.appendChild(toolCard);
  }

  function renderRunsTable() {
    const tbody = document.getElementById("vsp-runs-tbody");
    if (!tbody) return;
    tbody.innerHTML = "";

    const filtered = applyRunsFilter(runsRaw);

    filtered.forEach((run) => {
      const by = run.by_severity || run.bySeverity || {};
      const byTool = run.by_tool || run.byTool || {};
      const tools = Object.keys(byTool).join(", ");

      const profile =
        run.profile || run.profile_name || "--";
      const src =
        run.src || run.src_path || run.source || "--";
      const url = run.url || run.app_url || "--";

      const tr = document.createElement("tr");
      tr.dataset.runId = run.run_id;
      tr.innerHTML = `
        <td>${run.run_id}</td>
        <td>${run.ts || run.time || ""}</td>
        <td>${profile}</td>
        <td>${src}</td>
        <td>${url}</td>
        <td>${by.CRITICAL || 0}</td>
        <td>${by.HIGH || 0}</td>
        <td>${by.MEDIUM || 0}</td>
        <td>${by.LOW || 0}</td>
        <td>${by.INFO || 0}</td>
        <td>${by.TRACE || 0}</td>
        <td>${run.total_findings || run.total || 0}</td>
        <td>${tools}</td>
        <td>${
          run.report_html
            ? `<a href="${run.report_html}" target="_blank">HTML</a>`
            : "-"
        }</td>
      `;
      tr.addEventListener("click", () => renderRunDetail(run));
      tbody.appendChild(tr);
    });
  }

  async function loadRuns() {
    const data = await fetchJSON(API.runsIndex);
    runsRaw = Array.isArray(data) ? data : [];
    ensureRunsKpiStrip();
    ensureRunsFilters();
    renderRunsKpis();
    renderRunsTable();
  }

  /* ====================== TAB 3 – DATA SOURCE ====================== */

  function getDsFilters() {
    const toolSel = document.getElementById("ds-tool");
    const sevSel = document.getElementById("ds-severity");
    const searchInput = document.getElementById("ds-search");
    const cweInput = document.getElementById("ds-cwe");
    const folderInput = document.getElementById("ds-folder");

    return {
      tool: toolSel ? toolSel.value : "",
      severity: sevSel ? sevSel.value : "",
      q: searchInput ? searchInput.value.trim() : "",
      cwe: cweInput ? cweInput.value.trim() : "",
      folder: folderInput ? folderInput.value.trim() : "",
    };
  }

  function filterDsItems() {
    const { tool, severity, q, cwe, folder } = getDsFilters();

    let filtered = dsRawItems.slice();

    if (tool) {
      filtered = filtered.filter((it) => it.tool === tool);
    }
    if (severity) {
      filtered = filtered.filter(
        (it) =>
          it.severity === severity ||
          it.severity_effective === severity
      );
    }
    if (q) {
      const lower = q.toLowerCase();
      filtered = filtered.filter((it) => {
        const msg =
          it.message || it.description || "";
        const file = it.file || "";
        const rule =
          it.rule_id || it.rule_name || "";
        const combined = `${msg} ${file} ${rule}`.toLowerCase();
        return combined.includes(lower);
      });
    }
    if (cwe) {
      const lower = cwe.toLowerCase();
      filtered = filtered.filter((it) =>
        (it.cwe || "").toLowerCase().includes(lower)
      );
    }
    if (folder) {
      const lower = folder.toLowerCase();
      filtered = filtered.filter((it) =>
        (it.file || "").toLowerCase().includes(lower)
      );
    }

    return filtered;
  }

  function renderDatasourceTable() {
    const tbody = document.getElementById("vsp-ds-tbody");
    const totalEl = document.getElementById("vsp-ds-total");
    const pageLabel = document.getElementById("ds-page-label");
    if (!tbody) return;

    const filtered = filterDsItems();
    const total = filtered.length;
    const pageCount = Math.max(
      1,
      Math.ceil(total / DS_PAGE_SIZE)
    );
    if (dsPage > pageCount) dsPage = pageCount;

    const start = (dsPage - 1) * DS_PAGE_SIZE;
    const end = start + DS_PAGE_SIZE;
    const pageItems = filtered.slice(start, end);

    tbody.innerHTML = "";
    pageItems.forEach((it, idx) => {
      const sev =
        it.severity || it.severity_effective || "INFO";
      const tr = document.createElement("tr");
      const cves =
        (Array.isArray(it.cves) && it.cves.join(", ")) ||
        it.cve ||
        "";
      const moduleName = it.module || it.package || "";
      const fix = it.fix || it.remediation || "";
      const tags =
        (Array.isArray(it.tags) && it.tags.join(", ")) ||
        "";
      tr.innerHTML = `
        <td>${start + idx + 1}</td>
        <td>${it.tool || ""}</td>
        <td>${sev}</td>
        <td>${it.file || ""}</td>
        <td>${it.line || ""}</td>
        <td>${it.rule_id || it.rule_name || ""}</td>
        <td>${it.message || it.description || ""}</td>
        <td>${it.cwe || ""}</td>
        <td>${cves}</td>
        <td>${moduleName}</td>
        <td>${fix}</td>
        <td>${tags}</td>
      `;
      tbody.appendChild(tr);
    });

    if (totalEl) {
      totalEl.textContent = `Total: ${total}`;
    }
    if (pageLabel) {
      pageLabel.textContent = `Page ${dsPage} / ${pageCount}`;
    }

    renderDatasourceCharts();
  }

  function renderDatasourceCharts() {
    if (typeof Chart === "undefined") return;
    if (!Array.isArray(dsRawItems) || dsRawItems.length === 0) return;

    const filtered = filterDsItems();

    const sevCounts = {
      CRITICAL: 0,
      HIGH: 0,
      MEDIUM: 0,
      LOW: 0,
      INFO: 0,
      TRACE: 0,
    };
    const toolCounts = {};
    const cweCounts = {};
    const dirCounts = {};

    filtered.forEach((it) => {
      const sev =
        it.severity || it.severity_effective || "INFO";
      if (sevCounts[sev] !== undefined) {
        sevCounts[sev] += 1;
      }

      const tool = it.tool || "unknown";
      toolCounts[tool] = (toolCounts[tool] || 0) + 1;

      const cwe = it.cwe;
      if (cwe) {
        cweCounts[cwe] = (cweCounts[cwe] || 0) + 1;
      }

      const file = it.file || "";
      if (file) {
        const parts = file.split("/");
        const dir =
          parts.length > 2
            ? `${parts[0]}/${parts[1]}`
            : parts[0] || "";
        if (dir) {
          dirCounts[dir] = (dirCounts[dir] || 0) + 1;
        }
      }
    });

    // Severity donut
    const ctxSev = document.getElementById("ds-chart-sev");
    if (ctxSev) {
      const labels = Object.keys(sevCounts);
      const data = labels.map((k) => sevCounts[k]);
      if (!dsChartSeverity) {
        dsChartSeverity = new Chart(ctxSev, {
          type: "doughnut",
          data: {
            labels,
            datasets: [{ data, borderWidth: 0 }],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: "60%",
            plugins: { legend: { display: false } },
          },
        });
      } else {
        dsChartSeverity.data.labels = labels;
        dsChartSeverity.data.datasets[0].data = data;
        dsChartSeverity.update();
      }
    }

    // Bar by tool
    const ctxTool = document.getElementById("ds-chart-tool");
    if (ctxTool) {
      const entries = Object.entries(toolCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 8);
      const labels = entries.map((e) => e[0]);
      const data = entries.map((e) => e[1]);
      if (!dsChartTool) {
        dsChartTool = new Chart(ctxTool, {
          type: "bar",
          data: {
            labels,
            datasets: [{ data }],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
          },
        });
      } else {
        dsChartTool.data.labels = labels;
        dsChartTool.data.datasets[0].data = data;
        dsChartTool.update();
      }
    }

    // Top 5 CWE
    const ctxCwe = document.getElementById("ds-chart-cwe");
    if (ctxCwe) {
      const entries = Object.entries(cweCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5);
      const labels = entries.map((e) => e[0]);
      const data = entries.map((e) => e[1]);
      if (!dsChartCwe) {
        dsChartCwe = new Chart(ctxCwe, {
          type: "bar",
          data: {
            labels,
            datasets: [{ data }],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
          },
        });
      } else {
        dsChartCwe.data.labels = labels;
        dsChartCwe.data.datasets[0].data = data;
        dsChartCwe.update();
      }
    }

    // Top 5 directories
    const ctxDir = document.getElementById("ds-chart-dir");
    if (ctxDir) {
      const entries = Object.entries(dirCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5);
      const labels = entries.map((e) => e[0]);
      const data = entries.map((e) => e[1]);
      if (!dsChartDir) {
        dsChartDir = new Chart(ctxDir, {
          type: "bar",
          data: {
            labels,
            datasets: [{ data }],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
          },
        });
      } else {
        dsChartDir.data.labels = labels;
        dsChartDir.data.datasets[0].data = data;
        dsChartDir.update();
      }
    }
  }

  async function loadDatasourceRaw() {
    const data = await fetchJSON(`${API.datasource}?limit=10000`);
    if (!data || !Array.isArray(data.items)) {
      dsRawItems = [];
      return;
    }
    dsRawItems = data.items;
    dsPage = 1;
    renderDatasourceTable();
  }

  function initDatasourceEvents() {
    const applyBtn = document.getElementById("ds-apply");
    const prevBtn = document.getElementById("ds-prev");
    const nextBtn = document.getElementById("ds-next");

    if (applyBtn && !applyBtn.dataset._bound) {
      applyBtn.dataset._bound = "1";
      applyBtn.addEventListener("click", () => {
        dsPage = 1;
        renderDatasourceTable();
      });
    }
    if (prevBtn && !prevBtn.dataset._bound) {
      prevBtn.dataset._bound = "1";
      prevBtn.addEventListener("click", () => {
        if (dsPage > 1) {
          dsPage -= 1;
          renderDatasourceTable();
        }
      });
    }
    if (nextBtn && !nextBtn.dataset._bound) {
      nextBtn.dataset._bound = "1";
      nextBtn.addEventListener("click", () => {
        const filtered = filterDsItems();
        const pageCount = Math.max(
          1,
          Math.ceil(filtered.length / DS_PAGE_SIZE)
        );
        if (dsPage < pageCount) {
          dsPage += 1;
          renderDatasourceTable();
        }
      });
    }
  }

  /* ====================== TAB 5 – OVERRIDES ====================== */

  async function loadOverrides() {
    const res = await fetchJSON(API.overrides);
    const tbody = document.querySelector(
      "#tab-overrides table.vsp-table-compact tbody"
    );
    if (!tbody || !res || !Array.isArray(res.items)) return;

    const items = res.items;
    tbody.innerHTML = "";
    items.forEach((ov) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${ov.tool || ""}</td>
        <td>${ov.rule_id || ""}</td>
        <td>${ov.scope || ""}</td>
        <td>${ov.action || ov.override || ""}</td>
        <td>${ov.note || ov.reason || ""}</td>
      `;
      tr.addEventListener("mouseenter", () => {
        showToast(
          "Impact preview (demo) – phase sau sẽ highlight findings bị ảnh hưởng.",
          "info"
        );
      });
      tbody.appendChild(tr);
    });

    // Metrics đơn giản: số overrides & critical bị hạ mức
    const metricsContainer = document.getElementById("vsp-overrides-metrics");
    if (metricsContainer) {
      const total = items.length;
      const critDown = items.filter((ov) => {
        const from = (ov.from || ov.current || "").toUpperCase();
        const to = (ov.to || ov.override || "").toUpperCase();
        return from === "CRITICAL" && to && to !== "CRITICAL";
      }).length;
      metricsContainer.textContent = `Overrides: ${total}, Critical downgraded: ${critDown}`;
    }
  }

  /* ====================== INIT ====================== */

  async function init() {
    initTabs();
    initRunButton();
    initDatasourceEvents();

    await loadSettingsAndHeader();
    await loadDashboard();
    await loadRuns();
    await loadDatasourceRaw();
    loadOverrides().catch((e) =>
      console.warn("Overrides error", e)
    );
  }

  document.addEventListener("DOMContentLoaded", init);
})();

})();
/* ==== END: static/js/vsp_ui_main.js ==== */

/* ==== BEGIN: static/js/vsp_ui_tabs_v1.js ==== */
(function(){
'use strict';
/**
 * VSP 2025 – Vertical Tabs Runtime (commercial)
 *
 * Điều khiển 5 tab:
 *   Dashboard / Runs & Reports / Data Source / Settings / Rule Overrides
 *
 * Button:
 *   class: .vsp-nav-item hoặc .vsp-tab-btn
 *   attr:  data-tab-target="tab-dashboard" | "tab-runs" | ...
 *
 * Panel:
 *   class: .vsp-tab-panel
 *   id:    tab-dashboard | tab-runs | tab-datasource | tab-settings | tab-overrides
 */

(function () {
  var BUTTON_SELECTOR = ".vsp-nav-item, .vsp-tab-btn";
  var PANEL_SELECTOR  = ".vsp-tab-panel";

  function activateTab(targetId) {
    if (!targetId) return;

    var buttons = document.querySelectorAll(BUTTON_SELECTOR);
    var panels  = document.querySelectorAll(PANEL_SELECTOR);

    buttons.forEach(function (btn) {
      var t = btn.getAttribute("data-tab-target");
      var isActive = (t === targetId);
      btn.classList.toggle("is-active", isActive);
      btn.classList.toggle("active", isActive);
      btn.setAttribute("aria-selected", isActive ? "true" : "false");
    });

    panels.forEach(function (panel) {
      var isActive = (panel.id === targetId);
      panel.classList.toggle("is-active", isActive);
      panel.style.display = isActive ? "" : "none";
    });
  }

  function initTabs() {
    var buttons = document.querySelectorAll(BUTTON_SELECTOR);
    var panels  = document.querySelectorAll(PANEL_SELECTOR);
    if (!buttons.length || !panels.length) return;

    // Gắn handler click cho từng nút
    buttons.forEach(function (btn) {
      btn.addEventListener("click", function (e) {
        e.preventDefault();
        var targetId = btn.getAttribute("data-tab-target");
        if (!targetId) return;
        activateTab(targetId);
      });
    });

    // Xác định tab mặc định: theo button đang .is-active, nếu không có thì lấy button đầu.
    var defaultId = null;
    buttons.forEach(function (btn) {
      if (btn.classList.contains("is-active") || btn.classList.contains("active")) {
        var t = btn.getAttribute("data-tab-target");
        if (t) defaultId = t;
      }
    });
    if (!defaultId && buttons[0]) {
      defaultId = buttons[0].getAttribute("data-tab-target");
    }

    // Ẩn/hiện panels theo default
    if (defaultId) {
      activateTab(defaultId);
    }
  }

  document.addEventListener("DOMContentLoaded", initTabs);
})();

})();
/* ==== END: static/js/vsp_ui_tabs_v1.js ==== */

/* ==== BEGIN: static/js/vsp_api_shim_v1.js ==== */
(function(){
'use strict';
// VSP API SHIM – DISABLED
// Bản thương mại 2025 dùng API thật từ Core (8961), không intercept nữa.
(function () {
  console.log("[VSP_API_SHIM] disabled – dùng API runs_index_v3 thật từ Core");
})();

})();
/* ==== END: static/js/vsp_api_shim_v1.js ==== */

/* ==== BEGIN: static/js/vsp_app_entry_safe_v1.js ==== */
(function(){
'use strict';
/* VSP_SAFE_APP_ENTRY_V1: disable legacy chaos, provide stable minimal commercial UI */
(function(){
  'use strict';
  if (window.__VSP_SAFE_APP_V1__) return;
  window.__VSP_SAFE_APP_V1__ = true;

  const $ = (s, r=document)=>r.querySelector(s);
  const h = ()=> (location.hash||'#dashboard').toLowerCase();
  const is = (x)=> h().startsWith('#'+x);

  async function jget(url){
    const r = await fetch(url, {cache:'no-store'});
    if(!r.ok) throw new Error(url+' -> '+r.status);
    return r.json();
  }

  function esc(x){ return String(x??'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

  function mount(){
    try{
      Array.from(document.body.children).forEach(ch=>{
        if(ch && ch.id !== 'vspSafeApp') ch.style.display = 'none';
      });
    }catch(_){}

    const host = document.createElement('div');
    host.id = 'vspSafeApp';
    host.style.cssText = "min-height:100vh;background:#0b1020;color:#e7eaf0;font-family:system-ui,Segoe UI,Roboto,Arial;";

    host.innerHTML = `
      <div style="padding:16px 18px;border-bottom:1px solid rgba(255,255,255,.08);display:flex;align-items:center;justify-content:space-between;gap:12px">
        <div>
          <div style="font-weight:800;font-size:16px;letter-spacing:.2px">VersaSecure Platform — SAFE MODE</div>
          <div style="opacity:.75;font-size:12px;margin-top:2px">UI ổn định trước, rồi build lại thương mại full sau (không còn nhảy/đúp panel).</div>
        </div>
        <div style="display:flex;gap:8px">
          <button id="safeReload" style="padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:rgba(17,20,28,.9);color:#e7eaf0;cursor:pointer">Hard Reload</button>
          <button id="safeExit" style="padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:rgba(40,120,255,.22);color:#e7eaf0;cursor:pointer">Exit SAFE MODE</button>
        </div>
      </div>

      <div style="padding:14px 18px;display:flex;gap:10px;flex-wrap:wrap">
        <a href="#dashboard" data-tab="dashboard" style="padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.10);text-decoration:none;color:#e7eaf0">Dashboard</a>
        <a href="#runs" data-tab="runs" style="padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.10);text-decoration:none;color:#e7eaf0">Runs & Reports</a>
        <a href="#datasource" data-tab="datasource" style="padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.10);text-decoration:none;color:#e7eaf0">Data Source</a>
        <a href="#settings" data-tab="settings" style="padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.10);text-decoration:none;color:#e7eaf0">Settings</a>
        <a href="#rules" data-tab="rules" style="padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.10);text-decoration:none;color:#e7eaf0">Rule Overrides</a>
      </div>

      <div id="safeMain" style="padding:0 18px 22px"></div>
    `;
    document.body.appendChild(host);

    $('#safeReload', host).onclick = ()=>{ try{ location.reload(true); }catch(_){ location.reload(); } };
    $('#safeExit', host).onclick = ()=>{ alert("SAFE MODE đang bật. Muốn quay lại full UI: restore template từ file .bak_safe_*"); };

    render();
    window.addEventListener('hashchange', render, true);
  }

  async function render(){
    const main = $('#safeMain');
    if(!main) return;
    const tab = is('runs')?'runs':is('datasource')?'datasource':is('settings')?'settings':is('rules')?'rules':'dashboard';

    document.querySelectorAll('#vspSafeApp a[data-tab]').forEach(a=>{
      a.style.background = (a.getAttribute('data-tab')===tab) ? 'rgba(40,120,255,.18)' : 'transparent';
    });

    main.innerHTML = `<div style="opacity:.8;padding:10px 0">Loading…</div>`;

    try{
      if(tab==='dashboard'){
        const d = await jget('/api/vsp/dashboard_v3');
        main.innerHTML = `
          <div style="display:grid;grid-template-columns:repeat(4,minmax(180px,1fr));gap:10px;max-width:1100px">
            <div style="padding:12px;border:1px solid rgba(255,255,255,.10);border-radius:12px">
              <div style="opacity:.7;font-size:12px">Current run_id</div>
              <div style="font-weight:800;font-size:14px;margin-top:6px">${esc(d.run_id||d.rid||'N/A')}</div>
            </div>
            <div style="padding:12px;border:1px solid rgba(255,255,255,.10);border-radius:12px">
              <div style="opacity:.7;font-size:12px">Total</div>
              <div style="font-weight:900;font-size:20px;margin-top:6px">${esc(d.total||d.total_findings||'—')}</div>
            </div>
            <div style="padding:12px;border:1px solid rgba(255,255,255,.10);border-radius:12px">
              <div style="opacity:.7;font-size:12px">Critical</div>
              <div style="font-weight:900;font-size:20px;margin-top:6px">${esc(d.critical||'—')}</div>
            </div>
            <div style="padding:12px;border:1px solid rgba(255,255,255,.10);border-radius:12px">
              <div style="opacity:.7;font-size:12px">High</div>
              <div style="font-weight:900;font-size:20px;margin-top:6px">${esc(d.high||'—')}</div>
            </div>
          </div>
        `;
      }

      if(tab==='runs'){
        const r = await jget('/api/vsp/runs_index_v3_fs_resolved?limit=30&hide_empty=0&filter=1');
        const items = Array.isArray(r.items)?r.items:[];
        const rows = items.map(it=>{
          const rid = it.run_id||it.rid||'';
          return `<tr>
            <td style="padding:8px;border-top:1px solid rgba(255,255,255,.08)">${esc(it.time||it.started||'')}</td>
            <td style="padding:8px;border-top:1px solid rgba(255,255,255,.08);font-family:ui-monospace,monospace">${esc(rid)}</td>
            <td style="padding:8px;border-top:1px solid rgba(255,255,255,.08)">${esc(it.target||'')}</td>
            <td style="padding:8px;border-top:1px solid rgba(255,255,255,.08)">${esc(it.status||it.verdict||'')}</td>
            <td style="padding:8px;border-top:1px solid rgba(255,255,255,.08)">
              <a style="color:#9cc4ff" href="/api/vsp/run_status_v2/${esc(rid)}" target="_blank">status</a>
              &nbsp;|&nbsp;
              <a style="color:#9cc4ff" href="/api/vsp/artifacts_index_v1/${esc(rid)}" target="_blank">artifacts</a>
            </td>
          </tr>`;
        }).join('');

        main.innerHTML = `
          <div style="opacity:.8;font-size:12px;margin-bottom:8px">Runs (SAFE MODE table)</div>
          <div style="border:1px solid rgba(255,255,255,.10);border-radius:12px;overflow:auto;max-width:1200px">
            <table style="border-collapse:collapse;width:100%;min-width:880px">
              <thead>
                <tr style="text-align:left;opacity:.8;font-size:12px">
                  <th style="padding:10px">Time</th>
                  <th style="padding:10px">Run ID</th>
                  <th style="padding:10px">Target</th>
                  <th style="padding:10px">Status</th>
                  <th style="padding:10px">Links</th>
                </tr>
              </thead>
              <tbody>${rows || `<tr><td colspan="5" style="padding:12px;opacity:.75">No items</td></tr>`}</tbody>
            </table>
          </div>
        `;
      }

      if(tab==='datasource'){
        main.innerHTML = `<div style="max-width:1100px;padding:12px;border:1px solid rgba(255,255,255,.10);border-radius:12px;opacity:.9">
          Data Source SAFE MODE: mở API raw để kiểm tra dữ liệu.
          <div style="margin-top:8px">
            <a style="color:#9cc4ff" href="/api/vsp/dashboard_v3" target="_blank">/api/vsp/dashboard_v3</a><br/>
            <a style="color:#9cc4ff" href="/api/vsp/runs_index_v3_fs_resolved?limit=50&hide_empty=0&filter=1" target="_blank">runs_index_v3</a>
          </div>
        </div>`;
      }

      if(tab==='settings'){
        main.innerHTML = `<div style="max-width:1100px;padding:12px;border:1px solid rgba(255,255,255,.10);border-radius:12px;opacity:.9">
          Settings SAFE MODE: UI ổn định trước. Quay lại full UI bằng restore template từ .bak_safe_*.
        </div>`;
      }

      if(tab==='rules'){
        main.innerHTML = `<div style="max-width:1100px;padding:12px;border:1px solid rgba(255,255,255,.10);border-radius:12px;opacity:.9">
          Rule Overrides SAFE MODE: không chạy editor legacy để tránh crash/syntax.
        </div>`;
      }
    }catch(e){
      main.innerHTML = `<div style="padding:12px;border:1px solid rgba(255,80,80,.30);border-radius:12px;max-width:1100px">
        <div style="font-weight:800;margin-bottom:6px">SAFE MODE error</div>
        <div style="opacity:.85;font-family:ui-monospace,monospace;white-space:pre-wrap">${esc(e && (e.stack||e.message||String(e)))}</div>
      </div>`;
    }
  }

  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', mount, {once:true});
  }else{
    mount();
  }
})();

})();
/* ==== END: static/js/vsp_app_entry_safe_v1.js ==== */

/* ==== BEGIN: static/js/vsp_charts_full_is1.js ==== */
(function(){
'use strict';
// VSP 2025 - legacy charts stub
// Các chart chính đã chuyển sang vsp_dashboard_live_v2.js,
// file này chỉ để tránh 404 trong template cũ.
console.log("[VSP] vsp_charts_full_is1.js stub loaded.");

})();
/* ==== END: static/js/vsp_charts_full_is1.js ==== */

/* ==== BEGIN: static/js/vsp_charts_live_v2.js ==== */
(function(){
'use strict';
(function () {
  'use strict';

  const API_URL = '/api/vsp/dashboard_v3_v2';

  function getCanvasForChart(name) {
    // Tìm container có data-chart
    var container = document.querySelector('[data-chart="' + name + '"]');
    if (!container) {
      console.warn('[VSP][CHART] Không tìm thấy container data-chart=' + name);
      return null;
    }

    var canvas = container.querySelector('canvas');
    if (!canvas) {
      canvas = document.createElement('canvas');
      container.appendChild(canvas);
    }
    return canvas;
  }

  function renderSeverityDonut(bySev) {
    if (typeof Chart === 'undefined') {
      console.warn('[VSP][CHART] Chart.js not loaded');
      return;
    }

    var canvas = getCanvasForChart('severity_donut');
    if (!canvas) return;

    var buckets = ['CRITICAL','HIGH','MEDIUM','LOW','INFO','TRACE'];
    var data = buckets.map(function (k) {
      return Number(bySev && bySev[k] || 0);
    });

    var ctx = canvas.getContext('2d');
    new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: buckets,
        datasets: [{
          data: data
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        cutout: '70%',
        plugins: {
          legend: { display: false }
        }
      }
    });
  }

  function renderFindingsByTool(byTool) {
    if (typeof Chart === 'undefined') {
      console.warn('[VSP][CHART] Chart.js not loaded');
      return;
    }

    var canvas = getCanvasForChart('findings_by_tool');
    if (!canvas) return;

    var order = ['gitleaks','semgrep','bandit','trivy_fs','grype','kics','codeql','syft'];
    var labels = [];
    var data = [];

    order.forEach(function (key) {
      if (!byTool || byTool[key] === undefined) return;
      labels.push(key);
      data.push(Number(byTool[key] || 0));
    });

    var ctx = canvas.getContext('2d');
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          data: data
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          x: { ticks: { autoSkip: false } }
        }
      }
    });
  }

  // Trend Over Time – placeholder: chờ /api/vsp/runs, giờ chỉ hiển thị "No data"
  function renderTrendPlaceholder() {
    var container = document.querySelector('[data-chart="trend_over_time"]');
    if (!container) return;
    container.innerHTML = '<div class="vsp-chart-empty">Trend chart requires /api/vsp/runs data.</div>';
  }

  function loadCharts() {
    fetch(API_URL)
      .then(function (r) { return r.json(); })
      .then(function (data) {
        if (!data || data.ok === false) {
          console.warn('[VSP][CHART] /api/vsp/dashboard_v3_v2 not ok:', data);
          return;
        }
        var summary = data.summary || {};
        var bySev  = summary.by_severity || data.severity || {};
        var byTool = summary.by_tool     || data.by_tool   || {};

        renderSeverityDonut(bySev);
        renderFindingsByTool(byTool);
        renderTrendPlaceholder();
      })
      .catch(function (err) {
        console.error('[VSP][CHART] fetch error:', err);
      });
  }

  document.addEventListener('DOMContentLoaded', loadCharts);
})();

})();
/* ==== END: static/js/vsp_charts_live_v2.js ==== */

/* ==== BEGIN: static/js/vsp_ci_gate_floating_card_v1.js ==== */
(function(){
'use strict';
(function(){
  console.log("[VSP_GATE] floating CI gate card loaded");

  function insertCard(html) {
    var old = document.getElementById("vsp-floating-ci-gate");
    if (old) old.remove();

    var host = document.body;
    var div = document.createElement("div");
    div.id = "vsp-floating-ci-gate";
    div.style.position = "fixed";
    div.style.right = "24px";
    div.style.bottom = "24px";
    div.style.zIndex = "999";
    div.innerHTML = html;
    host.appendChild(div);
  }

  fetch("/api/vsp/dashboard_v3", { credentials: "same-origin" })
    .then(function(r){ if(!r.ok) throw new Error("HTTP "+r.status); return r.json(); })
    .then(function(d){
      var sev = d.by_severity || {};
      var html = [
        '<div class="vsp-ci-gate-card">',
        '  <div class="vsp-ci-gate-header">',
        '    <span>CI GATE – Latest Run</span>',
        '    <span class="vsp-ci-gate-badge">', (d.ci_gate_status && d.ci_gate_status.label) || 'FAILED', '</span>',
        '  </div>',
        '  <div class="vsp-ci-gate-body">',
        '    <div class="vsp-ci-gate-runid">', (d.latest_run_id || 'N/A'), '</div>',
        '    <div class="vsp-ci-gate-total">Total findings: ', (d.total_findings || 0), '</div>',
        '    <div class="vsp-ci-gate-sev">',
        '      C:', (sev.CRITICAL||0), ' · ',
        '      H:', (sev.HIGH||0), ' · ',
        '      M:', (sev.MEDIUM||0), ' · ',
        '      L:', (sev.LOW||0), ' · ',
        '      I:', (sev.INFO||0), ' · ',
        '      T:', (sev.TRACE||0),
        '    </div>',
        '    <a href="#/runs" class="vsp-ci-gate-link">View in Runs</a>',
        '  </div>',
        '</div>'
      ].join('');
      insertCard(html);
    })
    .catch(function(err){
      console.error("[VSP_GATE] failed to load dashboard_v3 for gate card:", err);
    });

})();

})();
/* ==== END: static/js/vsp_ci_gate_floating_card_v1.js ==== */

/* ==== BEGIN: static/js/vsp_ci_gate_widget_v1.js ==== */
(function(){
'use strict';
(function() {
  const LOG = "[VSP_CI_GATE]";

  function gotoRunsForRunId(runId) {
    try {
      // Lưu lại cho script khác dùng nếu cần
      window.VSP_CI_GATE_LAST_RUN_ID = runId;

      // Chuyển sang tab Runs & Reports nếu tìm thấy nút tab
      try {
        const runsTabBtn =
          document.querySelector('[data-vsp-tab-target="#vsp-tab-runs"]') ||
          document.querySelector('[data-bs-target="#vsp-tab-runs"]') ||
          document.querySelector('button#vsp-tab-runs') ||
          document.querySelector('a[href="#vsp-tab-runs"]');
        if (runsTabBtn) {
          runsTabBtn.click();
        }
      } catch (e) {
        console.warn(LOG, "Không tìm thấy nút tab Runs, bỏ qua.", e);
      }

      // Filter theo run-id nếu có ô filter
      try {
        const filterInput =
          document.querySelector('input[data-vsp-runs-filter="run-id"]') ||
          document.querySelector('input#vsp-runs-filter-run-id') ||
          document.querySelector('input[name="run_id_filter"]');
        if (filterInput) {
          filterInput.value = runId;
          filterInput.dispatchEvent(new Event("input", { bubbles: true }));
        }
      } catch (e) {
        console.warn(LOG, "Không autofilter được run-id, bỏ qua.", e);
      }

      // Hash CHỈ dùng để chọn tab, không nhét runId vào nữa
      try {
        window.location.hash = "#runs";
      } catch (e) {
        console.warn(LOG, "Không set hash được", e);
      }
    } catch (err) {
      console.error(LOG, "gotoRunsForRunId error:", err);
    }
  }

  function createWidget(data) {
    if (!data || !data.ok) {
      console.warn(LOG, "No data or ok=false", data);
      return;
    }

    let existing = document.getElementById("vsp-ci-gate-widget");
    if (existing) existing.remove();

    const hasFindings = !!data.has_findings;
    const total = data.total_findings || 0;
    const runId = data.run_id || data.ci_run_dir || "N/A";
    const sev = data.by_severity || {};

    const c = sev.CRITICAL || 0;
    const h = sev.HIGH || 0;
    const m = sev.MEDIUM || 0;
    const l = sev.LOW || 0;
    const info = sev.INFO || 0;
    const trace = sev.TRACE || 0;

    const severities = ["CRITICAL", "HIGH", "MEDIUM", "LOW", "INFO", "TRACE"];

    // Policy FAIL / WARN / PASS
    let status = "PASS";
    let statusLabel = "PASS";
    let borderColor = "#22c55e";
    let badgeBg = "rgba(34,197,94,0.12)";
    let badgeColor = "#4ade80";

    if (c > 0 || h > 10) {
      status = "FAIL";
      statusLabel = "FAILED";
      borderColor = "#f97373";
      badgeBg = "rgba(248,113,113,0.12)";
      badgeColor = "#f97373";
    } else if (h === 0 && c === 0 && (m > 0 || l > 0)) {
      status = "WARN";
      statusLabel = "PASS (MED/LOW)";
      borderColor = "#fbbf24";
      badgeBg = "rgba(251,191,36,0.12)";
      badgeColor = "#fbbf24";
    }

    const wrapper = document.createElement("div");
    wrapper.id = "vsp-ci-gate-widget";
    Object.assign(wrapper.style, {
      position: "fixed",
      right: "20px",
      bottom: "20px",
      zIndex: 9999,
      minWidth: "260px",
      maxWidth: "320px",
      background: "#020617",
      color: "#e5e7eb",
      borderRadius: "12px",
      boxShadow: "0 10px 30px rgba(15,23,42,0.8)",
      padding: "14px 16px",
      fontFamily: "system-ui, -apple-system, BlinkMacSystemFont, 'Inter', sans-serif",
      border: "1px solid " + borderColor,
      fontSize: "13px",
      cursor: "default"
    });

    wrapper.title = "Data from /api/vsp/ci_snapshot_latest\nPolicy: FAIL if CRITICAL>0 or HIGH>10";

    const header = document.createElement("div");
    header.style.display = "flex";
    header.style.alignItems = "center";
    header.style.justifyContent = "space-between";
    header.style.marginBottom = "6px";

    const title = document.createElement("div");
    title.textContent = "CI Gate – Latest Run";
    title.style.fontWeight = "600";
    title.style.fontSize = "13px";
    header.appendChild(title);

    const statusBadge = document.createElement("div");
    statusBadge.textContent = statusLabel;
    Object.assign(statusBadge.style, {
      padding: "2px 8px",
      borderRadius: "999px",
      fontSize: "11px",
      fontWeight: "600",
      letterSpacing: "0.04em",
      background: badgeBg,
      color: badgeColor
    });
    header.appendChild(statusBadge);
    wrapper.appendChild(header);

    const runLine = document.createElement("div");
    runLine.textContent = runId;
    runLine.style.fontSize = "11px";
    runLine.style.color = "#9ca3af";
    runLine.style.marginBottom = "10px";
    wrapper.appendChild(runLine);

    const totalRow = document.createElement("div");
    totalRow.style.display = "flex";
    totalRow.style.alignItems = "baseline";
    totalRow.style.marginBottom = "8px";

    const totalLabel = document.createElement("span");
    totalLabel.textContent = "Total findings:";
    totalLabel.style.fontSize = "11px";
    totalLabel.style.color = "#9ca3af";

    const totalVal = document.createElement("span");
    totalVal.textContent = " " + total;
    totalVal.style.fontSize = "16px";
    totalVal.style.fontWeight = "700";
    totalVal.style.marginLeft = "4px";
    totalVal.style.color = status === "FAIL"
      ? "#f97316"
      : (status === "WARN" ? "#fbbf24" : "#22c55e");

    totalRow.appendChild(totalLabel);
    totalRow.appendChild(totalVal);
    wrapper.appendChild(totalRow);

    const sevRow = document.createElement("div");
    sevRow.style.display = "flex";
    sevRow.style.flexWrap = "wrap";
    sevRow.style.gap = "4px";

    const sevColors = {
      CRITICAL: "#f97373",
      HIGH: "#fb923c",
      MEDIUM: "#eab308",
      LOW: "#22c55e",
      INFO: "#38bdf8",
      TRACE: "#a855f7"
    };

    severities.forEach((name) => {
      const v =
        name === "CRITICAL" ? c :
        name === "HIGH" ? h :
        name === "MEDIUM" ? m :
        name === "LOW" ? l :
        name === "INFO" ? info :
        trace;
      const pill = document.createElement("div");
      pill.textContent = name[0] + ": " + v;
      Object.assign(pill.style, {
        fontSize: "10px",
        padding: "2px 6px",
        borderRadius: "999px",
        background: "rgba(15,23,42,0.9)",
        border: "1px solid " + (sevColors[name] || "#4b5563"),
        color: sevColors[name] || "#e5e7eb"
      });
      sevRow.appendChild(pill);
    });

    wrapper.appendChild(sevRow);

    const footer = document.createElement("div");
    footer.style.marginTop = "8px";
    footer.style.display = "flex";
    footer.style.justifyContent = "space-between";
    footer.style.alignItems = "center";
    footer.style.fontSize = "10px";
    footer.style.color = "#6b7280";

    const sourceSpan = document.createElement("span");
    sourceSpan.textContent = "Source: CI";
    footer.appendChild(sourceSpan);

    const actions = document.createElement("div");
    actions.style.display = "flex";
    actions.style.alignItems = "center";
    actions.style.gap = "4px";

    const viewBtn = document.createElement("button");
    viewBtn.textContent = "View in Runs";
    Object.assign(viewBtn.style, {
      border: "none",
      background: "transparent",
      color: "#60a5fa",
      cursor: "pointer",
      fontSize: "10px",
      padding: "0 4px",
      textDecoration: "underline"
    });
    viewBtn.addEventListener("click", function(ev) {
      ev.stopPropagation();
      gotoRunsForRunId(runId);
    });
    actions.appendChild(viewBtn);

    const closeBtn = document.createElement("button");
    closeBtn.textContent = "×";
    Object.assign(closeBtn.style, {
      border: "none",
      background: "transparent",
      color: "#6b7280",
      cursor: "pointer",
      fontSize: "14px",
      padding: "0 4px"
    });
    closeBtn.addEventListener("click", function(ev) {
      ev.stopPropagation();
      wrapper.remove();
    });
    actions.appendChild(closeBtn);

    footer.appendChild(actions);
    wrapper.appendChild(footer);

    document.body.appendChild(wrapper);
  }

  async function loadSnapshot() {
    try {
      const res = await fetch("/api/vsp/ci_snapshot_latest", { cache: "no-store" });
      if (!res.ok) {
        console.warn(LOG, "HTTP", res.status);
        return;
      }
      const data = await res.json();
      console.log(LOG, "Snapshot", data);
      createWidget(data);
    } catch (e) {
      console.error(LOG, "Error loading CI snapshot:", e);
    }
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", loadSnapshot);
  } else {
    loadSnapshot();
  }
})();

})();
/* ==== END: static/js/vsp_ci_gate_widget_v1.js ==== */

/* ==== BEGIN: static/js/vsp_commercial_bind_v1.js ==== */
(function(){
'use strict';
/* === VSP_COMMERCIAL_BIND_V1 === */
(function () {
  const API = {
    runsIndex: "/api/vsp/runs_index_v3_fs_resolved?limit=20&hide_empty=0&filter=1",
    statusV2: (rid) => `/api/vsp/run_status_v2/${encodeURIComponent(rid)}`
  };

  function $(sel, root=document){ return root.querySelector(sel); }
  function $all(sel, root=document){ return Array.from(root.querySelectorAll(sel)); }

  async function fetchJSON(url) {
    const r = await fetch(url, { headers: { "Accept": "application/json" } });
    if (!r.ok) throw new Error(`HTTP ${r.status} ${url}`);
    return await r.json();
  }

  function normRid(rid) {
    if (!rid) return "";
    rid = String(rid).trim();
    if (rid.startsWith("RUN_")) return rid;
    if (rid.startsWith("VSP_CI_")) return "RUN_" + rid;
    if (rid.startsWith("VSP_UIREQ_")) return rid; // status_v2 may not support uireq; ignore
    return rid.startsWith("RUN_") ? rid : rid;
  }

  function verdictBadge(verdict, label) {
    const v = (verdict || "").toUpperCase();
    let cls = "vsp-badge-muted", dot = "vsp-dot-muted", text = v || "N/A";
    if (v === "GREEN") { cls = "vsp-badge-green"; dot = "vsp-dot-green"; }
    else if (v === "AMBER" || v === "YELLOW") { cls = "vsp-badge-amber"; dot = "vsp-dot-amber"; text = "AMBER"; }
    else if (v === "RED") { cls = "vsp-badge-red"; dot = "vsp-dot-red"; }
    else if (v === "DISABLED" || v === "NOT_RUN" || v === "DEGRADED") { cls = "vsp-badge-muted"; dot = "vsp-dot-muted"; text = v; }

    return `
      <span class="vsp-badge ${cls}" title="${label || ""}">
        <span class="vsp-dot ${dot}"></span>
        ${text}
      </span>
    `;
  }

  function ensureKpiPanel() {
    if ($("#vsp-kpis-commercial")) return;

    const host =
      $("#main") ||
      $("main") ||
      $(".vsp-main") ||
      $(".content") ||
      $(".container") ||
      document.body;

    const wrap = document.createElement("div");
    wrap.id = "vsp-kpis-commercial";
    wrap.innerHTML = `
      <div class="vsp-kpi-grid">
        <div class="vsp-kpi">
          <div class="k">Overall Verdict</div>
          <div class="v" id="kpi-overall">…</div>
          <div class="s" id="kpi-overall-sub"></div>
        </div>
        <div class="vsp-kpi">
          <div class="k">Gate Overall</div>
          <div class="v" id="kpi-gate">…</div>
          <div class="s" id="kpi-gate-sub"></div>
        </div>
        <div class="vsp-kpi">
          <div class="k">Gitleaks</div>
          <div class="v" id="kpi-gitleaks">…</div>
          <div class="s" id="kpi-gitleaks-sub"></div>
        </div>
        <div class="vsp-kpi">
          <div class="k">CodeQL</div>
          <div class="v" id="kpi-codeql">…</div>
          <div class="s" id="kpi-codeql-sub"></div>
        </div>
      </div>
    `;
    host.insertBefore(wrap, host.firstChild);
  }

  function setText(id, txt){ const el = document.getElementById(id); if (el) el.textContent = txt; }
  function setHTML(id, html){ const el = document.getElementById(id); if (el) el.innerHTML = html; }

  async function loadLatestStatusV2() {
    const idx = await fetchJSON(API.runsIndex);
    const items = (idx && (idx.items || idx.runs || idx.data)) || [];
    const first = items[0] || null;
    const runId = first && (first.run_id || first.id || first.rid || first.rid_norm || first.name);
    const rid = normRid(runId);
    if (!rid || !rid.startsWith("RUN_")) return null;
    return await fetchJSON(API.statusV2(rid));
  }

  function updateKpis(s) {
    if (!s) return;

    const overall = s.overall_verdict || s.overall || (s.run_gate_summary && s.run_gate_summary.overall) || "N/A";
    const gateOverall = (s.run_gate_summary && (s.run_gate_summary.overall_verdict || s.run_gate_summary.overall)) || overall || "N/A";

    const glVerdict = s.gitleaks_verdict || "NOT_RUN";
    const glTotal = (typeof s.gitleaks_total === "number") ? s.gitleaks_total : (s.gitleaks_total ? Number(s.gitleaks_total) : 0);

    // CodeQL: if disabled/not present, show placeholder labels
    let cqVerdict = s.codeql_verdict || (s.has_codeql ? "AMBER" : "DISABLED");
    let cqTotal = (typeof s.codeql_total === "number") ? s.codeql_total : (s.codeql_total ? Number(s.codeql_total) : 0);
    if (!s.has_codeql && (cqVerdict === "AMBER" || cqVerdict === "GREEN" || cqVerdict === "RED")) cqVerdict = "DISABLED";

    setHTML("kpi-overall", verdictBadge(overall, "Overall verdict (status_v2)"));
    setText("kpi-overall-sub", s.ci_run_dir ? `CI: ${s.rid_norm || ""}` : "");

    setHTML("kpi-gate", verdictBadge(gateOverall, "Gate overall (run_gate_summary)"));
    setText("kpi-gate-sub", s.run_gate_summary && s.run_gate_summary.ts ? `ts: ${s.run_gate_summary.ts}` : "");

    setHTML("kpi-gitleaks", verdictBadge(glVerdict, "Gitleaks verdict"));
    setText("kpi-gitleaks-sub", `total: ${glTotal}`);

    setHTML("kpi-codeql", verdictBadge(cqVerdict, "CodeQL verdict"));
    setText("kpi-codeql-sub", `total: ${cqTotal}`);
  }

  async function enhanceRunsTable() {
    // best-effort: try to find a runs table
    const table = document.querySelector("table#runs_table, table.vsp-runs, table");
    if (!table) return;

    const rows = $all("tbody tr", table).slice(0, 20);
    if (!rows.length) return;

    // add header cols if possible
    const theadTr = table.querySelector("thead tr");
    if (theadTr && !theadTr.querySelector("[data-vsp-col='overall']")) {
      const th1 = document.createElement("th"); th1.textContent = "Overall"; th1.setAttribute("data-vsp-col","overall");
      const th2 = document.createElement("th"); th2.textContent = "Degraded"; th2.setAttribute("data-vsp-col","degraded");
      theadTr.appendChild(th1); theadTr.appendChild(th2);
    }

    for (const tr of rows) {
      const txt = tr.textContent || "";
      const m = txt.match(/VSP_CI_\d{8}_\d{6}/);
      if (!m) continue;
      const rid = normRid(m[0]);
      if (tr.querySelector("[data-vsp-cell='overall']")) continue;

      // placeholder cells
      const tdOverall = document.createElement("td"); tdOverall.setAttribute("data-vsp-cell","overall");
      tdOverall.innerHTML = verdictBadge("N/A","loading...");
      const tdDeg = document.createElement("td"); tdDeg.setAttribute("data-vsp-cell","degraded");
      tdDeg.textContent = "…";
      tr.appendChild(tdOverall);
      tr.appendChild(tdDeg);

      try {
        const s = await fetchJSON(API.statusV2(rid));
        const overall = s.overall_verdict || (s.run_gate_summary && s.run_gate_summary.overall) || "N/A";
        tdOverall.innerHTML = verdictBadge(overall, rid);
        tdDeg.textContent = String(s.degraded_n ?? (Array.isArray(s.degraded_tools) ? s.degraded_tools.length : 0));
      } catch (e) {
        tdOverall.innerHTML = verdictBadge("N/A", String(e));
        tdDeg.textContent = "-";
      }
    }
  }

  async function boot() {
    try {
      ensureKpiPanel();
      const s = await loadLatestStatusV2();
      updateKpis(s);
      enhanceRunsTable(); // best-effort
    } catch (e) {
      // keep UI stable even if API fails
      console.warn("[VSP_COMMERCIAL_BIND_V1]", e);
    }
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", boot);
  } else {
    boot();
  }
})();

})();
/* ==== END: static/js/vsp_commercial_bind_v1.js ==== */

/* ==== BEGIN: static/js/vsp_commercial_layout_controller_p0_v1.js ==== */
(function(){
'use strict';
/* VSP_COMMERCIAL_LAYOUT_CONTROLLER_P0_V1 */
(function(){
  'use strict';
  if (window.__VSP_COMMERCIAL_LAYOUT_CONTROLLER_P0_V1) return;
  window.__VSP_COMMERCIAL_LAYOUT_CONTROLLER_P0_V1 = true;

  function routeFromHash(){
    const h = (location.hash || '').replace(/^#/, '').trim().toLowerCase();
    if (!h) return 'dashboard';
    if (h.startsWith('run')) return 'runs';
    if (h.startsWith('data')) return 'datasource';
    if (h.startsWith('set')) return 'settings';
    if (h.startsWith('rule')) return 'rules';
    if (h.startsWith('dash')) return 'dashboard';
    return h;
  }

  function findByText(re){
    const nodes = document.querySelectorAll('h1,h2,h3,h4,header,section,div');
    for (const el of nodes){
      const t = (el.textContent || '').trim();
      if (!t) continue;
      if (re.test(t)) return el;
    }
    return null;
  }

  function markContainer(el, className){
    if (!el) return null;
    let cur = el;
    for (let i=0; i<10 && cur && cur !== document.body; i++){
      const r = cur.getBoundingClientRect();
      if (r.width > 700 && r.height > 80){
        cur.classList.add(className);
        return cur;
      }
      cur = cur.parentElement;
    }
    (el.parentElement || el).classList.add(className);
    return (el.parentElement || el);
  }

  function ensureCommercialContainer(){
    // pick the “main app” area by locating brand header text
    const brand = findByText(/VersaSecure Platform/i) || findByText(/SECURITY_BUNDLE/i);
    if (!brand) return null;
    const box = markContainer(brand, 'vsp-commercial-container');
    return box;
  }

  function detectRunsStrip(){
    // top strip usually contains "Degraded tools"
    const degraded = findByText(/Degraded tools/i);
    if (!degraded) return null;
    return markContainer(degraded, 'vsp-runs-strip');
  }

  function detectPolicyBlock(){
    // bottom block contains "Commercial Operational Policy" or "OVERALL VERDICT"
    const pol = findByText(/Commercial Operational Policy/i) || findByText(/OVERALL VERDICT/i);
    if (!pol) return null;
    return markContainer(pol, 'vsp-policy-block');
  }

  function hardUnscaleIfNeeded(container){
    if (!container) return;
    try{
      const cs = getComputedStyle(container);
      if (cs.transform && cs.transform !== 'none'){
        container.style.transform = 'none';
      }
    }catch(_){}
  }

  function setVisibility(route, runsStrip, policyBlock){
    // show runs strip ONLY on runs tab
    if (runsStrip){
      if (route === 'runs') runsStrip.classList.remove('vsp-hidden');
      else runsStrip.classList.add('vsp-hidden');
    }

    // policy block: hide by default, open via FAB (still accessible)
    if (policyBlock){
      policyBlock.classList.add('vsp-hidden');
      policyBlock.dataset.vspPolicyHidden = '1';
    }
  }

  function ensurePolicyFab(policyBlock){
    if (!policyBlock) return;
    if (document.querySelector('.vsp-fab[data-kind="policy"]')) return;

    const btn = document.createElement('button');
    btn.className = 'vsp-fab';
    btn.dataset.kind = 'policy';
    btn.textContent = 'Policy / Verdict';
    btn.addEventListener('click', function(){
      const hidden = policyBlock.classList.contains('vsp-hidden');
      if (hidden){
        policyBlock.classList.remove('vsp-hidden');
        policyBlock.scrollIntoView({behavior:'smooth', block:'start'});
      }else{
        policyBlock.classList.add('vsp-hidden');
      }
    });
    document.body.appendChild(btn);
  }

  function apply(){
    document.body.classList.add('vsp-commercial-2025');

    const route = routeFromHash();
    document.documentElement.dataset.vspRoute = route;

    const container = ensureCommercialContainer();
    hardUnscaleIfNeeded(container);

    const runsStrip = detectRunsStrip();
    const policyBlock = detectPolicyBlock();

    setVisibility(route, runsStrip, policyBlock);
    ensurePolicyFab(policyBlock);
  }

  window.addEventListener('hashchange', function(){
    try{ apply(); }catch(_){}
  });

  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', apply);
  }else{
    apply();
  }
})();

})();
/* ==== END: static/js/vsp_commercial_layout_controller_p0_v1.js ==== */

/* ==== BEGIN: static/js/vsp_commercial_layout_controller_v1.js ==== */
(function(){
'use strict';
/* VSP_COMMERCIAL_LAYOUT_CONTROLLER_V4_STABLE
 * Goals:
 * - Runs strip only in #runs
 * - Policy/Verdict not stretching pages; open via single overlay button
 * - No node-moving that causes layout jump; hide origin + clone into panel
 */
(function(){
  'use strict';
  if (window.__VSP_COMMERCIAL_LAYOUT_V4_STABLE__) return;
  window.__VSP_COMMERCIAL_LAYOUT_V4_STABLE__ = true;

  const STATE = {
    lastHash: null,
    lastApplyAt: 0,
    applyTimer: null,
  };

  function norm(t){
    try{ return (t||'').replace(/\s+/g,' ').trim().toLowerCase(); }catch(_){ return ''; }
  }

  function hash(){
    try{ return (location.hash||'#dashboard').toLowerCase(); }catch(_){ return '#dashboard'; }
  }
  function isRuns(){
    const h = hash();
    return h.startsWith('#runs') || h.includes('#runs/');
  }

  function qsa(sel){
    try{ return Array.from(document.querySelectorAll(sel)); }catch(_){ return []; }
  }

  function dedupePolicyToggles(){
    // remove any legacy buttons labelled Policy/Verdict except our V4 toggle
    try{
      qsa('button').forEach(b=>{
        const txt = norm(b.textContent);
        if(!txt) return;
        if(txt.includes('policy') && txt.includes('verdict') && b.id !== 'vspPolicyToggleV4'){
          b.remove();
        }
      });
      // remove legacy panels
      qsa('#vsp-policy-verdict-panel, #vsp_policy_panel_v1, #vsp_policy_panel').forEach(el=>{
        if(el && el.id !== 'vspPolicyPanelV4') el.remove();
      });
    }catch(_){}
  }

  function hideRunsOutsideRuns(){
    if (isRuns()) return;
    // best-effort hide any runs strip / runs-only blocks
    const sels = [
      '#runs-strip','.runs-strip','.runs-strip-wrap','.vsp-runs-strip','.vsp-runs-strip-wrap',
      '.runs-and-reports','.vsp-runs-and-reports','section#runs_reports','div#runs_reports'
    ];
    for (const sel of sels){
      qsa(sel).forEach(el=>{
        if(!el) return;
        if(el.id === 'vsp-runs-main') return;
        el.style.display = 'none';
        el.setAttribute('data-vsp-hidden','runs-outside');
      });
    }
  }

  function findBlockByHeading(label){
    const want = norm(label);
    if(!want) return null;

    // headings or strong/label-ish nodes
    const nodes = qsa('h1,h2,h3,h4,strong,div,span');
    for(const n of nodes){
      const t = norm(n.textContent);
      if(!t) continue;
      if(t === want || t.includes(want)){
        const box = n.closest('.vsp-card,.dashboard-card,.card,section,article,div') || n.parentElement;
        if(!box) continue;
        // avoid picking our overlay
        if(box.id === 'vspPolicyPanelV4') continue;
        return box;
      }
    }
    return null;
  }

  function ensurePanel(){
    let panel = document.getElementById('vspPolicyPanelV4');
    if(panel) return panel;

    panel = document.createElement('div');
    panel.id = 'vspPolicyPanelV4';
    panel.style.cssText = [
      'position:fixed','right:14px','bottom:14px','z-index:10000',
      'width:min(820px,92vw)','max-height:78vh','overflow:auto',
      'border-radius:14px','padding:12px',
      'border:1px solid rgba(255,255,255,.10)',
      'background:rgba(10,12,18,.96)','backdrop-filter: blur(6px)',
      'box-shadow:0 18px 50px rgba(0,0,0,.55)',
      'display:none'
    ].join(';') + ';';

    const head = document.createElement('div');
    head.style.cssText = 'display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px;';
    const title = document.createElement('div');
    title.textContent = 'Policy / Verdict';
    title.style.cssText = 'font-weight:700;font-size:13px;color:#e7eaf0;letter-spacing:.2px;';
    const close = document.createElement('button');
    close.type='button';
    close.textContent='×';
    close.style.cssText = 'width:32px;height:32px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:rgba(17,20,28,.92);color:#e7eaf0;cursor:pointer;';
    close.addEventListener('click', ()=>{ panel.style.display='none'; });
    head.appendChild(title); head.appendChild(close);
    panel.appendChild(head);

    const body = document.createElement('div');
    body.id = 'vspPolicyBodyV4';
    body.style.cssText = 'display:flex;flex-direction:column;gap:12px;';
    panel.appendChild(body);

    document.body.appendChild(panel);
    return panel;
  }

  function ensureToggle(){
    let btn = document.getElementById('vspPolicyToggleV4');
    if(btn) return btn;

    btn = document.createElement('button');
    btn.id='vspPolicyToggleV4';
    btn.type='button';
    btn.textContent='Policy / Verdict';
    btn.style.cssText = [
      'position:fixed','right:14px','bottom:14px','z-index:9999',
      'padding:9px 11px','border-radius:12px',
      'border:1px solid rgba(255,255,255,.12)',
      'background:rgba(17,20,28,.92)','color:#e7eaf0',
      'font-size:12px','cursor:pointer',
      'box-shadow:0 10px 26px rgba(0,0,0,.40)'
    ].join(';') + ';';

    btn.addEventListener('click', ()=>{
      const panel = ensurePanel();
      const open = panel.style.display === 'none';
      if(open){
        refreshPanelContent();
        panel.style.display = '';
      }else{
        panel.style.display = 'none';
      }
    });

    document.body.appendChild(btn);
    return btn;
  }

  
  function __vsp_pick_big_panel(label, mustWords){
    const want = norm(label);
    const req = (mustWords||[]).map(norm).filter(Boolean);
    let best = null;
    let bestArea = 0;

    // search likely containers only (avoid scanning every node)
    const cand = qsa('section,article,div');
    for(const el of cand){
      try{
        if(!el) continue;
        if(el.id === 'vspPolicyPanelV4') continue;
        if(el.closest && el.closest('#vspPolicyPanelV4')) continue;

        const t = norm(el.textContent);
        if(!t) continue;
        if(!t.includes(want)) continue;

        // must contain these words to target the BIG panel, not the small card
        let ok = true;
        for(const w of req){
          if(!w) continue;
          if(!t.includes(w)){ ok=false; break; }
        }
        if(!ok) continue;

        const r = el.getBoundingClientRect ? el.getBoundingClientRect() : null;
        if(!r) continue;
        const area = Math.max(0, r.width) * Math.max(0, r.height);

        // ignore tiny cards
        if(area < 60000) continue;

        if(area > bestArea){
          bestArea = area;
          best = el;
        }
      }catch(_){}
    }
    return best;
  }

  function hideOriginVerdictPolicy(){
    // BIG "OVERALL VERDICT" panel usually contains Updated/RID/Source/Reasons
    const bigVerdict = __vsp_pick_big_panel('OVERALL VERDICT', ['updated', 'rid', 'source', 'reasons']);

    // BIG policy panel usually contains "8 tools" and "timeout/degraded"
    const bigPolicy = __vsp_pick_big_panel('Commercial Operational Policy', ['8 tools']);

    [bigVerdict, bigPolicy].forEach(b=>{
      if(!b) return;
      try{
        if(b.getAttribute('data-vsp-origin-hidden') === '1') return;
        b.setAttribute('data-vsp-origin-hidden','1');
        b.style.display = 'none';
      }catch(_){}
    });
  }


  function refreshPanelContent(){
    const panel = ensurePanel();
    const body = document.getElementById('vspPolicyBodyV4');
    if(!body) return;

    // clear + re-clone (stable, no moving nodes)
    body.innerHTML = '';

    const blocks = [];
    const b1 = findBlockByHeading('OVERALL VERDICT');
    const b2 = findBlockByHeading('Commercial Operational Policy');
    if(b1) blocks.push(b1);
    if(b2) blocks.push(b2);

    for(const b of blocks){
      try{
        const clone = b.cloneNode(true);
        clone.style.display = '';
        clone.style.maxWidth = '100%';
        clone.style.margin = '0';
        body.appendChild(clone);
      }catch(_){}
    }
  }

  function apply(){
    const now = Date.now();
    if(now - STATE.lastApplyAt < 120) return; // throttle
    STATE.lastApplyAt = now;

    dedupePolicyToggles();
    hideRunsOutsideRuns();

    // always stabilize verdict/policy: hide origin + one toggle
    hideOriginVerdictPolicy();
    ensureToggle();

    try{
      console.info('[VSP_COMMERCIAL_LAYOUT_V4_STABLE] apply route=', hash(), 'isRuns=', isRuns());
    }catch(_){}
  }

  function scheduleApply(){
    try{ clearTimeout(STATE.applyTimer); }catch(_){}
    STATE.applyTimer = setTimeout(apply, 40);
  }

  // initial
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', scheduleApply, {once:true});
  }else{
    scheduleApply();
  }
  window.addEventListener('hashchange', scheduleApply, true);

  // observe late DOM injection (charts/runs panel)
  try{
    const mo = new MutationObserver(()=>scheduleApply());
    mo.observe(document.documentElement, {childList:true, subtree:true});
  }catch(_){}
})();

})();
/* ==== END: static/js/vsp_commercial_layout_controller_v1.js ==== */

/* ==== BEGIN: static/js/vsp_console_patch_v1.js ==== */
(function(){
'use strict';
// [VSP_HASH_SANITIZE_V1] Fix invalid hash patterns like "#runs:ID" breaking querySelector
(function() {
  try {
    var h = window.location && window.location.hash;
    if (h && h.indexOf(":") !== -1) {
      var clean = h.split(":")[0];
      console.log("[VSP_HASH_SANITIZE_V1] Clean hash", h, "->", clean);
      window.location.hash = clean;
    }
  } catch (e) {
    console.error("[VSP_HASH_SANITIZE_V1] Error:", e);
  }
})();


/**
 * VSP console patch v1
 * Mục tiêu: chặn mọi log / warning chứa "[VSP_RUNS_UI_v1]"
 * để không còn rác console từ legacy stub cũ.
 */

(function () {
  'use strict';

  var origWarn = console.warn;
  var origLog  = console.log;

  function shouldMute(msg) {
    if (!msg || typeof msg !== 'string') return false;
    return msg.indexOf('[VSP_RUNS_UI_v1]') !== -1 ||
           msg.indexOf('tbody#vsp-runs-tbody') !== -1;
  }

  console.warn = function () {
    if (arguments.length > 0 && shouldMute(arguments[0])) {
      // Nuốt luôn log cũ
      return;
    }
    return origWarn.apply(console, arguments);
  };

  console.log = function () {
    if (arguments.length > 0 && shouldMute(arguments[0])) {
      return;
    }
    return origLog.apply(console, arguments);
  };

  origLog('[VSP_CONSOLE_PATCH] Installed console filter for legacy RUNS_UI_v1 logs.');
})();


// VSP_SETTINGS_AUTOBIND_v1
(function() {
  const LOG = "[VSP_SETTINGS_BIND]";
  function bindVspSettingsTab() {
    if (!window.vspInitSettingsTab) {
      console.log(LOG, "vspInitSettingsTab not found – skip.");
      return;
    }
    const btns = Array.from(document.querySelectorAll(
      "[data-vsp-tab='settings'], [data-vsp-target='#tab-settings'], [data-vsp-id='settings']"
    ));
    if (!btns.length) {
      console.warn(LOG, "No Settings tab button found.");
      return;
    }
    btns.forEach(btn => {
      if (btn.dataset.vspSettingsBound === "1") return;
      btn.addEventListener("click", () => {
        try {
          window.vspInitSettingsTab();
        } catch (e) {
          console.error(LOG, "Error in vspInitSettingsTab", e);
        }
      });
      btn.dataset.vspSettingsBound = "1";
    });
    console.log(LOG, "bound", btns.length, "Settings tab buttons.");
  }
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", bindVspSettingsTab);
  } else {
    bindVspSettingsTab();
  }
})();

// [VSP_TABS_MAIN_INIT]
(function () {
  "use strict";
  var LOG_PREFIX_TABS = "[VSP_TABS]";

  function logTabs() {
    if (typeof console !== "undefined" && console.log) {
      var args = Array.prototype.slice.call(arguments);
      args.unshift(LOG_PREFIX_TABS);
      console.log.apply(console, args);
    }
  }

  function normalizeLabel(text) {
    if (!text) return "";
    return text.replace(/\s+/g, " ").trim().toLowerCase();
  }

  function initTabs() {
    // Map label -> pane id
    var map = {
      "dashboard": "#vsp-tab-dashboard",
      "runs & reports": "#vsp-tab-runs",
      "data source": "#vsp-tab-datasource",
      "settings": "#vsp-tab-settings",
      "settings (profile / tools)": "#vsp-tab-settings",
      "rule overrides": "#vsp-tab-rules"
    };

    var buttons = [];
    var candidates = document.querySelectorAll("button, a, span");

    for (var i = 0; i < candidates.length; i++) {
      var el = candidates[i];
      var label = normalizeLabel(el.textContent || el.innerText);
      if (map[label]) {
        el.setAttribute("data-vsp-tab-target", map[label]);
        el.classList.add("vsp-tab-link");
        buttons.push(el);
      }
    }

    var panes = document.querySelectorAll(".vsp-tab-pane");
    if (!buttons.length || !panes.length) {
      logTabs("log removed", "buttons", buttons.length, "panes", panes.length);
      return;
    }

    function showTab(targetSelector) {
      if (!targetSelector) return;
      var found = false;

      for (var i = 0; i < panes.length; i++) {
        var pane = panes[i];
        if (pane.matches(targetSelector)) {
          pane.classList.add("vsp-tab-pane-active");
          pane.style.display = "";
          found = true;
        } else {
          pane.classList.remove("vsp-tab-pane-active");
          pane.style.display = "none";
        }
      }

      for (var j = 0; j < buttons.length; j++) {
        var btn = buttons[j];
        var sel = btn.getAttribute("data-vsp-tab-target");
        if (sel === targetSelector) {
          btn.classList.add("vsp-tab-link-active");
        } else {
          btn.classList.remove("vsp-tab-link-active");
        }
      }

      if (!found) {
        logTabs("No pane matched selector:", targetSelector);
      } else {
        logTabs("Switched to tab:", targetSelector);
      }
    }

    buttons.forEach(function (btn) {
      btn.addEventListener("click", function (e) {
        e.preventDefault();
        var sel = btn.getAttribute("data-vsp-tab-target");
        if (!sel) return;
        showTab(sel);
      });
    });

    var defaultSelector = "#vsp-tab-dashboard";
    if (window.location.hash && document.querySelector(window.location.hash)) {
      defaultSelector = window.location.hash;
    }
    showTab(defaultSelector);
    logTabs("Initialized, default tab =", defaultSelector);

    // debug: vspTabsShow('#vsp-tab-runs')
    window.vspTabsShow = showTab;
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initTabs);
  } else {
    initTabs();
  }
})();

// [VSP_TABS_AUTOWRAP_V1]
(function () {
  "use strict";

  var LOG_WRAP = "[VSP_TABS_WRAP]";
  var LOG_TABS2 = "[VSP_TABS2]";

  function logWrap() {
    if (typeof console !== "undefined" && console.log) {
      var args = Array.prototype.slice.call(arguments);
      args.unshift(LOG_WRAP);
      console.log.apply(console, args);
    }
  }

  function logTabs2() {
    if (typeof console !== "undefined" && console.log) {
      var args = Array.prototype.slice.call(arguments);
      args.unshift(LOG_TABS2);
      console.log.apply(console, args);
    }
  }

  function ensurePanes() {
    // Nếu đã có rồi thì thôi
    var existing = document.querySelectorAll(".vsp-tab-pane");
    if (existing.length) {
      logWrap("Found existing panes, skip autowrap. count =", existing.length);
      return;
    }

    var main = document.querySelector("main");
    if (!main) {
      logWrap("No <main> found – cannot autowrap.");
      return;
    }

    // Bọc main vào pane Dashboard
    var wrap = document.createElement("div");
    wrap.id = "vsp-tab-dashboard";
    wrap.className = "vsp-tab-pane vsp-tab-pane-active";

    main.parentNode.insertBefore(wrap, main);
    wrap.appendChild(main);

    // Tạo thêm 4 pane rỗng
    function addPane(id, text) {
      var pane = document.createElement("div");
      pane.id = id;
      pane.className = "vsp-tab-pane";
      var card = document.createElement("div");
      card.className = "vsp-card";
      var body = document.createElement("div");
      body.className = "vsp-card-body";
      body.textContent = text;
      card.appendChild(body);
      pane.appendChild(card);
      wrap.parentNode.insertBefore(pane, wrap.nextSibling);
      wrap = pane; // để nó nối tiếp nhau
    }

    addPane("vsp-tab-runs", "Runs & Reports tab V1 – content TODO.");
    addPane("vsp-tab-datasource", "Data Source tab V1 – content TODO.");
    addPane("vsp-tab-settings", "Settings tab V1 – content TODO.");
    addPane("vsp-tab-rules", "Rule Overrides tab V1 – content TODO.");

    var after = document.querySelectorAll(".vsp-tab-pane").length;
    logWrap("Created tab panes:", after);
  }

  function initTabs2() {
    var panes = document.querySelectorAll(".vsp-tab-pane");
    if (!panes.length) {
      logTabs2("No panes after autowrap – skip.");
      return;
    }

    var buttons = document.querySelectorAll("[data-vsp-tab-target]");
    if (!buttons.length) {
      logTabs2("No buttons with data-vsp-tab-target – skip.");
      return;
    }

    function showTab(targetSelector) {
      if (!targetSelector) return;
      var found = false;

      panes.forEach(function (pane) {
        if (pane.matches(targetSelector)) {
          pane.classList.add("vsp-tab-pane-active");
          pane.style.display = "";
          found = true;
        } else {
          pane.classList.remove("vsp-tab-pane-active");
          pane.style.display = "none";
        }
      });

      buttons.forEach(function (btn) {
        var sel = btn.getAttribute("data-vsp-tab-target");
        if (sel === targetSelector) {
          btn.classList.add("vsp-tab-link-active");
        } else {
          btn.classList.remove("vsp-tab-link-active");
        }
      });

      if (!found) {
        logTabs2("No pane matched selector:", targetSelector);
      } else {
        logTabs2("Switched to tab:", targetSelector);
      }
    }

    // Gắn click (thêm 1 listener nữa cũng không sao)
    buttons.forEach(function (btn) {
      btn.addEventListener("click", function (e) {
        e.preventDefault();
        var sel = btn.getAttribute("data-vsp-tab-target");
        if (!sel) return;
        showTab(sel);
      });
    });

    var defaultSelector = "#vsp-tab-dashboard";
    if (window.location.hash && document.querySelector(window.location.hash)) {
      defaultSelector = window.location.hash;
    }
    showTab(defaultSelector);
    logTabs2("Initialized V2, default tab =", defaultSelector);

    window.vspTabsShow2 = showTab;
  }

  function runAll() {
    ensurePanes();
    initTabs2();
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", runAll);
  } else {
    runAll();
  }
})();

// [VSP_TABS_LAYOUT_V1]
(function () {
  "use strict";
  var LOG = "[VSP_TABS_LAYOUT]";

  function log() {
    if (typeof console !== "undefined" && console.log) {
      var args = Array.prototype.slice.call(arguments);
      args.unshift(LOG);
      console.log.apply(console, args);
    }
  }

  function setRunsLayout() {
    var root = document.getElementById("vsp-tab-runs");
    if (!root) {
      log("No #vsp-tab-runs, skip.");
      return;
    }
    if (root.dataset.vspLayout === "full") return;
    root.dataset.vspLayout = "full";

    root.innerHTML = [
      '<div class="vsp-two-col">',
      '  <div class="vsp-card">',
      '    <div class="vsp-card-header">',
      '      <div>',
      '        <div class="vsp-card-title">Runs &amp; Reports</div>',
      '        <div class="vsp-card-subtitle">Danh sách scan runs từ thư mục out/</div>',
      '      </div>',
      '    </div>',
      '    <div class="vsp-card-body">',
      '      <div class="vsp-filters-row">',
      '        <select id="vsp-runs-filter-profile" class="vsp-input">',
      '          <option value="">All profiles</option>',
      '          <option value="FAST">FAST</option>',
      '          <option value="EXT">EXT</option>',
      '          <option value="FULL">FULL</option>',
      '        </select>',
      '        <select id="vsp-runs-filter-severity" class="vsp-input">',
      '          <option value="">Any severity</option>',
      '          <option value="CRITICAL">CRITICAL</option>',
      '          <option value="HIGH">HIGH</option>',
      '          <option value="MEDIUM">MEDIUM</option>',
      '          <option value="LOW">LOW</option>',
      '        </select>',
      '        <input id="vsp-runs-filter-daterange" class="vsp-input" placeholder="Date range (optional)" />',
      '      </div>',
      '      <div class="vsp-table-wrapper">',
      '        <table class="vsp-table vsp-table-runs">',
      '          <thead>',
      '            <tr>',
      '              <th>Run ID</th>',
      '              <th>Profile</th>',
      '              <th>Posture</th>',
      '              <th>Total</th>',
      '              <th>Max severity</th>',
      '              <th>Started at</th>',
      '            </tr>',
      '          </thead>',
      '          <tbody id="vsp-runs-tbody"></tbody>',
      '        </table>',
      '      </div>',
      '    </div>',
      '  </div>',
      '  <div class="vsp-card vsp-card-side">',
      '    <div class="vsp-card-header vsp-card-header-actions">',
      '      <div>',
      '        <div class="vsp-card-title">Run detail</div>',
      '        <div class="vsp-card-subtitle">Posture / total / severity tối đa.</div>',
      '      </div>',
      '      <div class="vsp-card-actions">',
      '        <button id="vsp-run-export-html" class="vsp-chip-btn vsp-run-export-btn">Export HTML</button>',
      '        <button id="vsp-run-export-zip" class="vsp-chip-btn vsp-run-export-btn">Export ZIP</button>',
      '      </div>',
      '    </div>',
      '    <div class="vsp-card-body" id="vsp-run-detail"></div>',
      '  </div>',
      '</div>'
    ].join("");

    if (typeof window.vspReloadRuns === "function") {
      try {
        window.vspReloadRuns();
      } catch (e) {
        log("vspReloadRuns error:", e);
      }
    } else {
      log("window.vspReloadRuns not found – runs table sẽ được JS khác lo nếu có.");
    }
  }

  function setDataSourceLayout() {
    var root = document.getElementById("vsp-tab-datasource");
    if (!root) {
      log("No #vsp-tab-datasource, skip.");
      return;
    }
    if (root.dataset.vspLayout === "full") return;
    root.dataset.vspLayout = "full";

    root.innerHTML = [
      '<div id="vsp-ds-root" class="vsp-card">',
      '  <div class="vsp-card-header">',
      '    <div>',
      '      <div class="vsp-card-title">Unified Findings</div>',
      '      <div class="vsp-card-subtitle">Data source từ summary_unified / findings_unified.</div>',
      '    </div>',
      '    <div class="vsp-card-actions">',
      '      <button id="vsp-ds-reload" class="vsp-chip-btn">Reload</button>',
      '    </div>',
      '  </div>',
      '  <div class="vsp-card-body">',
      '    <div class="vsp-filters-row">',
      '      <select id="vsp-ds-filter-severity" class="vsp-input">',
      '        <option value="">Severity: Any</option>',
      '        <option value="CRITICAL">CRITICAL</option>',
      '        <option value="HIGH">HIGH</option>',
      '        <option value="MEDIUM">MEDIUM</option>',
      '        <option value="LOW">LOW</option>',
      '        <option value="INFO">INFO</option>',
      '        <option value="TRACE">TRACE</option>',
      '      </select>',
      '      <select id="vsp-ds-filter-tool" class="vsp-input">',
      '        <option value="">Tool: Any</option>',
      '        <option value="semgrep">Semgrep</option>',
      '        <option value="bandit">Bandit</option>',
      '        <option value="codeql">CodeQL</option>',
      '        <option value="trivy">Trivy</option>',
      '        <option value="grype">Grype</option>',
      '        <option value="kics">KICS</option>',
      '        <option value="gitleaks">Gitleaks</option>',
      '      </select>',
      '      <input id="vsp-ds-filter-text" class="vsp-input" placeholder="Search message / path / CWE..." />',
      '    </div>',
      '    <div class="vsp-table-wrapper vsp-table-wrapper-ds">',
      '      <table class="vsp-table vsp-table-ds">',
      '        <thead>',
      '          <tr>',
      '            <th>Severity</th>',
      '            <th>Tool</th>',
      '            <th>CWE</th>',
      '            <th>Rule</th>',
      '            <th>Path</th>',
      '            <th>Line</th>',
      '            <th>Message</th>',
      '            <th>Run</th>',
      '          </tr>',
      '        </thead>',
      '        <tbody id="vsp-ds-tbody"></tbody>',
      '      </table>',
      '    </div>',
      '    <div class="vsp-ds-pager">',
      '      <button id="vsp-ds-prev" class="vsp-chip-btn">Prev</button>',
      '      <span id="vsp-ds-page-info" class="vsp-ds-page-info">Page 1</span>',
      '      <button id="vsp-ds-next" class="vsp-chip-btn">Next</button>',
      '    </div>',
      '  </div>',
      '</div>'
    ].join("");

    log("Data Source layout ready (chưa gắn API – sẽ làm V2).");
  }

  function setSettingsLayout() {
    var root = document.getElementById("vsp-tab-settings");
    if (!root) {
      log("No #vsp-tab-settings, skip.");
      return;
    }
    if (root.dataset.vspLayout === "full") return;
    root.dataset.vspLayout = "full";

    root.innerHTML = [
      '<div id="vsp-settings-root" class="vsp-card">',
      '  <div class="vsp-card-header">',
      '    <div>',
      '      <div class="vsp-card-title">Profiles &amp; Tools</div>',
      '      <div class="vsp-card-subtitle">settings_v1 – profiles, tool toggles, default profile.</div>',
      '    </div>',
      '    <div class="vsp-card-actions">',
      '      <button id="vsp-settings-reload" class="vsp-chip-btn">Reload</button>',
      '      <button id="vsp-settings-save" class="vsp-chip-btn">Save</button>',
      '    </div>',
      '  </div>',
      '  <div class="vsp-card-body">',
      '    <textarea id="vsp-settings-json" class="vsp-json-editor" spellcheck="false"></textarea>',
      '    <div id="vsp-settings-status" class="vsp-status-line"></div>',
      '  </div>',
      '</div>'
    ].join("");

    if (!window.vspInitSettingsTab) {
      window.vspInitSettingsTab = function () {
        console.log("[VSP_SETTINGS_TAB] stub init – UI only (chưa gắn API).");
      };
    }
  }

  function setRulesLayout() {
    var root = document.getElementById("vsp-tab-rules");
    if (!root) {
      log("No #vsp-tab-rules, skip.");
      return;
    }
    if (root.dataset.vspLayout === "full") return;
    root.dataset.vspLayout = "full";

    root.innerHTML = [
      '<div id="vsp-rules-root" class="vsp-card">',
      '  <div class="vsp-card-header">',
      '    <div>',
      '      <div class="vsp-card-title">Rule Overrides</div>',
      '      <div class="vsp-card-subtitle">Override severity / pattern cho từng tool – rule_overrides_v1.</div>',
      '    </div>',
      '    <div class="vsp-card-actions">',
      '      <button id="vsp-rules-reload" class="vsp-chip-btn">Reload</button>',
      '      <button id="vsp-rules-save" class="vsp-chip-btn">Save</button>',
      '    </div>',
      '  </div>',
      '  <div class="vsp-card-body">',
      '    <div class="vsp-two-col">',
      '      <div>',
      '        <div class="vsp-section-title">Danh sách overrides</div>',
      '        <div class="vsp-table-wrapper vsp-table-wrapper-rules">',
      '          <table class="vsp-table vsp-table-rules">',
      '            <thead>',
      '              <tr>',
      '                <th>ID</th>',
      '                <th>Tool</th>',
      '                <th>Pattern</th>',
      '                <th>Severity</th>',
      '                <th>Reason</th>',
      '              </tr>',
      '            </thead>',
      '            <tbody id="vsp-rules-tbody">',
      '              <tr><td colspan="5">V1 – chưa load dữ liệu.</td></tr>',
      '            </tbody>',
      '          </table>',
      '        </div>',
      '      </div>',
      '      <div>',
      '        <div class="vsp-section-title">JSON rule_overrides_v1</div>',
      '        <textarea id="vsp-rules-json" class="vsp-json-editor" spellcheck="false"></textarea>',
      '        <div id="vsp-rules-status" class="vsp-status-line"></div>',
      '      </div>',
      '    </div>',
      '  </div>',
      '</div>'
    ].join("");

    log("Rule Overrides layout ready (V1, chưa gắn API).");
  }

  function run() {
    setRunsLayout();
    setDataSourceLayout();
    setSettingsLayout();
    setRulesLayout();
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", run);
  } else {
    run();
  }
})();

// [VSP_TABS_API_V1]
(function () {
  "use strict";
  var LOG_DS = "[VSP_DS_API]";
  var LOG_SET = "[VSP_SETTINGS_API]";
  var LOG_RULE = "[VSP_RULES_API]";

  function logDs() {
    if (console && console.log) {
      var args = Array.prototype.slice.call(arguments);
      args.unshift(LOG_DS);
      console.log.apply(console, args);
    }
  }
  function logSet() {
    if (console && console.log) {
      var args = Array.prototype.slice.call(arguments);
      args.unshift(LOG_SET);
      console.log.apply(console, args);
    }
  }
  function logRule() {
    if (console && console.log) {
      var args = Array.prototype.slice.call(arguments);
      args.unshift(LOG_RULE);
      console.log.apply(console, args);
    }
  }

  // ---- Data Source /api/vsp/datasource_v2 ----
  function initDataSourceApi() {
    var root = document.getElementById("vsp-ds-root");
    if (!root) {
      logDs("No #vsp-ds-root – skip.");
      return;
    }

    var tbody = document.getElementById("vsp-ds-tbody");
    var selSeverity = document.getElementById("vsp-ds-filter-severity");
    var selTool = document.getElementById("vsp-ds-filter-tool");
    var txtSearch = document.getElementById("vsp-ds-filter-text");
    var btnReload = document.getElementById("vsp-ds-reload");
    var btnPrev = document.getElementById("vsp-ds-prev");
    var btnNext = document.getElementById("vsp-ds-next");
    var lblPage = document.getElementById("vsp-ds-page-info");

    if (!tbody) {
      logDs("Missing tbody #vsp-ds-tbody – skip.");
      return;
    }

    var state = {
      page: 1,
      pageSize: 50,
      total: 0,
      severity: "",
      tool: "",
      q: ""
    };

    function buildUrl() {
      var params = new URLSearchParams();
      if (state.severity) params.set("severity", state.severity);
      if (state.tool) params.set("tool", state.tool);
      if (state.q) params.set("q", state.q);
      params.set("limit", String(state.pageSize));
      params.set("page", String(state.page));
      return "/api/vsp/datasource_v2?" + params.toString();
    }

    function render(data) {
      var items = [];
      if (Array.isArray(data)) {
        items = data;
      } else if (data && Array.isArray(data.items)) {
        items = data.items;
        if (typeof data.total === "number") {
          state.total = data.total;
        }
      }

      tbody.innerHTML = "";
      if (!items.length) {
        var tr = document.createElement("tr");
        var td = document.createElement("td");
        td.colSpan = 8;
        td.textContent = "Không có findings nào (filter quá chặt?).";
        tr.appendChild(td);
        tbody.appendChild(tr);
      } else {
        items.forEach(function (it) {
          var tr = document.createElement("tr");
          function td(text) {
            var c = document.createElement("td");
            c.textContent = text == null ? "" : String(text);
            tr.appendChild(c);
          }

          var sev = it.severity_effective || it.severity || "";
          var tool = it.tool || it.source || "";
          var cwe = it.cwe_id || it.cwe || "";
          var rule = it.rule_id || it.rule || it.check_id || "";
          var path = it.path || it.file || "";
          var line = it.line || it.start_line || "";
          var msg = it.message || it.title || "";
          var run = it.run_id || (data && data.run_id) || "";

          td(sev);
          td(tool);
          td(cwe);
          td(rule);
          td(path);
          td(line);
          td(msg);
          td(run);

          tbody.appendChild(tr);
        });
      }

      var pageInfo = "Page " + state.page;
      if (state.total && state.pageSize) {
        var pages = Math.ceil(state.total / state.pageSize);
        pageInfo = "Page " + state.page + " / " + pages + " (" + state.total + " items)";
      }
      if (lblPage) lblPage.textContent = pageInfo;
    }

    function loadData() {
      var url = buildUrl();
      logDs("Loading", url);
      fetch(url)
        .then(function (res) {
          if (!res.ok) throw new Error("HTTP " + res.status);
          return res.json();
        })
        .then(function (data) {
          logDs("Loaded", data);
          render(data);
        })
        .catch(function (err) {
          logDs("Error", err);
          tbody.innerHTML = "";
          var tr = document.createElement("tr");
          var td = document.createElement("td");
          td.colSpan = 8;
          td.textContent = "Error loading datasource_v2: " + err;
          tr.appendChild(td);
          tbody.appendChild(tr);
        });
    }

    function resetPageAndLoad() {
      state.page = 1;
      loadData();
    }

    if (selSeverity) {
      selSeverity.addEventListener("change", function () {
        state.severity = selSeverity.value || "";
        resetPageAndLoad();
      });
    }
    if (selTool) {
      selTool.addEventListener("change", function () {
        state.tool = selTool.value || "";
        resetPageAndLoad();
      });
    }
    if (txtSearch) {
      txtSearch.addEventListener("keyup", function (e) {
        if (e.key === "Enter") {
          state.q = txtSearch.value || "";
          resetPageAndLoad();
        }
      });
    }
    if (btnReload) {
      btnReload.addEventListener("click", function () {
        resetPageAndLoad();
      });
    }
    if (btnPrev) {
      btnPrev.addEventListener("click", function () {
        if (state.page > 1) {
          state.page -= 1;
          loadData();
        }
      });
    }
    if (btnNext) {
      btnNext.addEventListener("click", function () {
        state.page += 1;
        loadData();
      });
    }

    resetPageAndLoad();
  }

  // ---- Settings /api/vsp/settings_ui_v1 ----
  function initSettingsApi() {
    var root = document.getElementById("vsp-settings-root");
    if (!root) {
      logSet("No #vsp-settings-root – skip.");
      return;
    }

    var txt = document.getElementById("vsp-settings-json");
    var btnReload = document.getElementById("vsp-settings-reload");
    var btnSave = document.getElementById("vsp-settings-save");
    var status = document.getElementById("vsp-settings-status");

    if (!txt) {
      logSet("Missing #vsp-settings-json – skip.");
      return;
    }

    function showStatus(msg, isErr) {
      if (!status) return;
      status.textContent = msg;
      status.style.color = isErr ? "#f97373" : "rgba(148,163,184,0.9)";
    }

    function reloadSettings() {
      showStatus("Loading settings_v1 ...");
      fetch("/api/vsp/settings_ui_v1")
        .then(function (res) {
          if (!res.ok) throw new Error("HTTP " + res.status);
          return res.json();
        })
        .then(function (data) {
          txt.value = JSON.stringify(data, null, 2);
          showStatus("Loaded settings_v1.");
          logSet("Loaded", data);
        })
        .catch(function (err) {
          logSet("Error", err);
          showStatus("Error loading settings_v1: " + err, true);
        });
    }

    function saveSettings() {
      var raw = txt.value;
      var parsed;
      try {
        parsed = JSON.parse(raw);
      } catch (e) {
        showStatus("JSON không hợp lệ: " + e.message, true);
        return;
      }
      showStatus("Saving settings_v1 ...");
      fetch("/api/vsp/settings_ui_v1", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify(parsed)
      })
        .then(function (res) {
          if (!res.ok) throw new Error("HTTP " + res.status);
          return res.json();
        })
        .then(function (data) {
          showStatus("Saved settings_v1.");
          logSet("Saved", data);
        })
        .catch(function (err) {
          logSet("Save error", err);
          showStatus("Error saving settings_v1: " + err, true);
        });
    }

    if (btnReload) btnReload.addEventListener("click", reloadSettings);
    if (btnSave) btnSave.addEventListener("click", saveSettings);

    // load lần đầu
    reloadSettings();
  }

  // ---- Rule Overrides /api/vsp/rule_overrides_ui_v1 ----
  function initRulesApi() {
    var root = document.getElementById("vsp-rules-root");
    if (!root) {
      logRule("No #vsp-rules-root – skip.");
      return;
    }

    var txt = document.getElementById("vsp-rules-json");
    var tbody = document.getElementById("vsp-rules-tbody");
    var btnReload = document.getElementById("vsp-rules-reload");
    var btnSave = document.getElementById("vsp-rules-save");
    var status = document.getElementById("vsp-rules-status");

    if (!txt || !tbody) {
      logRule("Missing textarea or tbody – skip.");
      return;
    }

    function showStatus(msg, isErr) {
      if (!status) return;
      status.textContent = msg;
      status.style.color = isErr ? "#f97373" : "rgba(148,163,184,0.9)";
    }

    function renderTable(data) {
      var list = [];
      if (Array.isArray(data)) {
        list = data;
      } else if (data && Array.isArray(data.items)) {
        list = data.items;
      }

      tbody.innerHTML = "";
      if (!list.length) {
        var tr = document.createElement("tr");
        var td = document.createElement("td");
        td.colSpan = 5;
        td.textContent = "Không có rule override nào.";
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }

      list.forEach(function (it) {
        var tr = document.createElement("tr");
        function td(text) {
          var c = document.createElement("td");
          c.textContent = text == null ? "" : String(text);
          tr.appendChild(c);
        }
        td(it.id || it.rule_id || "");
        td(it.tool || "");
        td(it.pattern || "");
        td(it.severity_effective || it.severity || "");
        td(it.reason || "");
        tbody.appendChild(tr);
      });
    }

    function reloadRules() {
      showStatus("Loading rule_overrides_v1 ...");
      fetch("/api/vsp/rule_overrides_ui_v1")
        .then(function (res) {
          if (!res.ok) throw new Error("HTTP " + res.status);
          return res.json();
        })
        .then(function (data) {
          txt.value = JSON.stringify(data, null, 2);
          renderTable(data);
          showStatus("Loaded rule_overrides_v1.");
          logRule("Loaded", data);
        })
        .catch(function (err) {
          logRule("Error", err);
          showStatus("Error loading rule_overrides_v1: " + err, true);
        });
    }

    function saveRules() {
      var raw = txt.value;
      var parsed;
      try {
        parsed = JSON.parse(raw);
      } catch (e) {
        showStatus("JSON không hợp lệ: " + e.message, true);
        return;
      }
      showStatus("Saving rule_overrides_v1 ...");
      fetch("/api/vsp/rule_overrides_ui_v1", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify(parsed)
      })
        .then(function (res) {
          if (!res.ok) throw new Error("HTTP " + res.status);
          return res.json();
        })
        .then(function (data) {
          showStatus("Saved rule_overrides_v1.");
          renderTable(data);
          logRule("Saved", data);
        })
        .catch(function (err) {
          logRule("Save error", err);
          showStatus("Error saving rule_overrides_v1: " + err, true);
        });
    }

    if (btnReload) btnReload.addEventListener("click", reloadRules);
    if (btnSave) btnSave.addEventListener("click", saveRules);

    reloadRules();
  }

  function runAll() {
    initDataSourceApi();
    initSettingsApi();
    initRulesApi();
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", runAll);
  } else {
    runAll();
  }
})();


;(function () {
  const LOG_PREFIX = "[VSP_CONSOLE_EXTRA]";
  const extraScripts = [
    "vsp_runs_tab_kpi_inject_v1.js",
    "vsp_datasource_ext_columns_v1.js",
    "vsp_datasource_export_v1.js",
    "vsp_datasource_charts_v1.js",
    "vsp_settings_tab_v1.js",
    "vsp_rules_tab_v1.js",
    "vsp_runs_fullscan_panel_v1.js"
  ];

  function loadExtra(name) {
    try {
      var url = "/static/js/" + name;
      var s = document.createElement("script");
      s.src = url;
      s.defer = true;
      s.onload = function () {
        try {
          console.log(LOG_PREFIX, "loaded", name);
        } catch (e) {}
      };
      s.onerror = function () {
        try {
          console.warn(LOG_PREFIX, "failed", name);
        } catch (e) {}
      };
      document.head.appendChild(s);
    } catch (e) {
      try {
        console.error(LOG_PREFIX, "error injecting", name, e);
      } catch (e2) {}
    }
  }

  if (typeof window !== "undefined" && document && document.head) {
    extraScripts.forEach(loadExtra);
  } else {
    try {
      console.warn(LOG_PREFIX, "document/head chưa sẵn sàng – skip extra scripts.");
    } catch (e) {}
  }
})();



// === VSP_DS_HEIGHT_FIX_V1 – limit Data Source charts height ===
(function() {
  if (window.VSP_DS_HEIGHT_FIX_V1) return;
  window.VSP_DS_HEIGHT_FIX_V1 = true;
  const LOG = "[VSP_DS_HEIGHT_FIX]";

  function shrinkDsCharts() {
    try {
      const tab = document.querySelector("#vsp-tab-datasource");
      if (!tab) return;
      const canvases = tab.querySelectorAll("canvas");
      if (!canvases.length) return;
      canvases.forEach(cv => {
        cv.style.height = "260px";
        cv.style.maxHeight = "260px";
      });
      console.log(LOG, "Applied height=260px to", canvases.length, "canvas elements.");
    } catch (e) {
      console.warn(LOG, "Error while shrinking charts:", e);
    }
  }

  // Gọi 1 lần khi load
  if (document.readyState === "complete" || document.readyState === "interactive") {
    shrinkDsCharts();
  } else {
    document.addEventListener("DOMContentLoaded", shrinkDsCharts);
  }

  // Dùng MutationObserver để bắt mọi lần Data Source render lại chart
  try {
    const obs = new MutationObserver(() => shrinkDsCharts());
    obs.observe(document.documentElement, { childList: true, subtree: true });
    console.log(LOG, "MutationObserver attached.");
  } catch (e) {
    console.warn(LOG, "Cannot attach MutationObserver:", e);
    // fallback: thỉnh thoảng thu nhỏ lại
    setInterval(shrinkDsCharts, 1500);
  }
})();


// === VSP_DS_HEIGHT_FIX_V2 – stronger override for Data Source charts ===
(function() {
  if (window.VSP_DS_HEIGHT_FIX_V2) return;
  window.VSP_DS_HEIGHT_FIX_V2 = true;
  const LOG = "[VSP_DS_HEIGHT_FIX_V2]";

  function hardShrinkDsCharts() {
    const tab = document.querySelector("#vsp-tab-datasource");
    if (!tab) return;

    const canvases = tab.querySelectorAll("canvas");
    if (!canvases.length) return;

    canvases.forEach(cv => {
      try {
        // Ép height canvas
        cv.style.setProperty("height", "220px", "important");
        cv.style.setProperty("max-height", "220px", "important");
        cv.height = 220;

        // Ép container trực tiếp
        const parent = cv.parentElement;
        if (parent) {
          parent.style.setProperty("height", "230px", "important");
          parent.style.setProperty("max-height", "230px", "important");
          parent.style.overflow = "hidden";
        }

        // Ép card/wrapper lớn quanh chart
        const card = cv.closest(".vsp-card") || cv.closest(".card") || cv.closest(".panel");
        if (card) {
          card.style.setProperty("max-height", "280px", "important");
          card.style.overflow = "hidden";
        }
      } catch (e) {
        console.warn(LOG, "Error shrink chart:", e);
      }
    });

    console.log(LOG, "Hard shrink applied to", canvases.length, "canvas elements.");
  }

  // Gọi khi document sẵn sàng
  if (document.readyState === "complete" || document.readyState === "interactive") {
    hardShrinkDsCharts();
  } else {
    document.addEventListener("DOMContentLoaded", hardShrinkDsCharts);
  }

  // Observer mọi thay đổi để luôn ép lại khi Chart.js re-render
  try {
    const obs = new MutationObserver(() => hardShrinkDsCharts());
    obs.observe(document.querySelector("#vsp-tab-datasource") || document.body, {
      childList: true,
      subtree: true
    });
    console.log(LOG, "MutationObserver attached.");
  } catch (e) {
    console.warn(LOG, "Cannot attach MutationObserver:", e);
    setInterval(hardShrinkDsCharts, 1500);
  }
})();

/* VSP_RUNS_LAYOUT_HELPER_V1
 * Tự động load vsp_runs_overview_layout_v1.js từ console patch.
 */
(function(){
  try {
    var s = document.createElement('script');
    s.src = '/static/js/vsp_runs_overview_layout_v1.js';
    s.defer = true;
    document.head.appendChild(s);
    console.log('[VSP_RUNS_LAYOUT] helper script injected from console patch.');
  } catch (e) {
    console.warn('[VSP_RUNS_LAYOUT] cannot inject layout script:', e);
  }
})();

// [VSP_RUN_FULLSCAN_REBIND] allow EXT_ONLY / URL_ONLY / FULL_EXT
(function() {
  function rebindRunFullscan() {
    var btn = document.querySelector('#vsp-run-fullscan-btn');
    if (!btn) {
      console.log('[VSP_RUN_FULLSCAN_REBIND] Không thấy nút #vsp-run-fullscan-btn');
      return;
    }

    // Chỉ bind 1 lần
    if (btn.dataset.vspRunRebound === '1') {
      console.log('[VSP_RUN_FULLSCAN_REBIND] Đã bind trước đó, skip.');
      return;
    }

    // Clone để xoá hết event listener cũ
    var newBtn = btn.cloneNode(true);
    btn.parentNode.replaceChild(newBtn, btn);
    newBtn.dataset.vspRunRebound = '1';

    var inputRoot  = document.querySelector('#vsp-source-root');
    var inputUrl   = document.querySelector('#vsp-target-url');
    var selProfile = document.querySelector('#vsp-profile');

    newBtn.addEventListener('click', function() {
      var sourceRoot = (inputRoot && inputRoot.value || '').trim();
      var targetUrl  = (inputUrl  && inputUrl.value  || '').trim();
      var profile    = (selProfile && selProfile.value || '').trim() || 'FULL_EXT';

      // Rule: phải có ÍT NHẤT 1 trong 2
      if (!sourceRoot && !targetUrl) {
        window.alert('Vui lòng nhập ít nhất Source root hoặc Target URL.');
        return;
      }

      var mode;
      if (sourceRoot && targetUrl) {
        mode = 'FULL_EXT';
      } else if (sourceRoot && !targetUrl) {
        mode = 'EXT_ONLY';
      } else {
        mode = 'URL_ONLY';
      }

      var payload = {
        source_root: sourceRoot || null,
        target_url:  targetUrl  || null,
        profile: profile,
        mode: mode
      };

      console.log('[VSP_RUN_FULLSCAN_REBIND] payload', payload);

      fetch('/api/vsp/run_fullscan_v1', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      })
      .then(function(r) { return r.json(); })
      .then(function(data) {
        console.log('[VSP_RUN_FULLSCAN_REBIND] resp', data);
        if (!data.ok) {
          window.alert('Run full scan failed: ' + (data.error || 'unknown error'));
        }
      })
      .catch(function(err) {
        console.error('[VSP_RUN_FULLSCAN_REBIND] error', err);
        window.alert('Có lỗi khi gửi yêu cầu run full scan.');
      });
    });

    console.log('[VSP_RUN_FULLSCAN_REBIND] Đã bind lại nút Run full scan.');
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', rebindRunFullscan);
  } else {
    rebindRunFullscan();
  }
})();

// [VSP_RUN_FULLSCAN_REBIND_POLL] rebind nút Run full scan sau khi panel được inject
(function() {
  console.log('[VSP_RUN_FULLSCAN_REBIND_POLL] start');

  var tries = 0;
  var maxTries = 30; // ~6s nếu interval = 200ms

  var timer = setInterval(function() {
    tries += 1;

    var btn = document.querySelector('#vsp-run-fullscan-btn');
    if (!btn) {
      if (tries >= maxTries) {
        console.warn('[VSP_RUN_FULLSCAN_REBIND_POLL] Hết số lần thử, không thấy nút.');
        clearInterval(timer);
      }
      return;
    }

    if (btn.dataset.vspRunRebound === '1') {
      console.log('[VSP_RUN_FULLSCAN_REBIND_POLL] Nút đã được bind trước đó, dừng poll.');
      clearInterval(timer);
      return;
    }

    // Clone để xoá toàn bộ listener cũ (bao gồm alert "Vui lòng nhập Target URL")
    var newBtn = btn.cloneNode(true);
    btn.parentNode.replaceChild(newBtn, btn);
    newBtn.dataset.vspRunRebound = '1';

    var inputRoot  = document.querySelector('#vsp-source-root');
    var inputUrl   = document.querySelector('#vsp-target-url');
    var selProfile = document.querySelector('#vsp-profile');

    newBtn.addEventListener('click', function() {
      var sourceRoot = (inputRoot && inputRoot.value || '').trim();
      var targetUrl  = (inputUrl  && inputUrl.value  || '').trim();
      var profile    = (selProfile && selProfile.value || '').trim() || 'FULL_EXT';

      if (!sourceRoot && !targetUrl) {
        window.alert('Vui lòng nhập ít nhất Source root hoặc Target URL.');
        return;
      }

      var mode;
      if (sourceRoot && targetUrl) {
        mode = 'FULL_EXT';
      } else if (sourceRoot && !targetUrl) {
        mode = 'EXT_ONLY';
      } else {
        mode = 'URL_ONLY';
      }

      var payload = {
        source_root: sourceRoot || null,
        target_url:  targetUrl  || null,
        profile: profile,
        mode: mode
      };

      console.log('[VSP_RUN_FULLSCAN_REBIND_POLL] payload', payload);

      fetch('/api/vsp/run_fullscan_v1', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      })
      .then(function(r) { return r.json(); })
      .then(function(data) {
        console.log('[VSP_RUN_FULLSCAN_REBIND_POLL] resp', data);
        if (!data.ok) {
          window.alert('Run full scan failed: ' + (data.error || 'unknown error'));
        }
      })
      .catch(function(err) {
        console.error('[VSP_RUN_FULLSCAN_REBIND_POLL] error', err);
        window.alert('Có lỗi khi gửi yêu cầu run full scan.');
      });
    });

    console.log('[VSP_RUN_FULLSCAN_REBIND_POLL] Đã bind lại nút Run full scan.');
    clearInterval(timer);
  }, 200);
})();
// [VSP_RUN_FULLSCAN_REBIND_POLL_V3] rebind nút Run full scan sau khi panel được inject
(function() {
  console.log('[VSP_RUN_FULLSCAN_REBIND_POLL_V3] start');

  var tries = 0;
  var maxTries = 30; // ~6s nếu interval 200ms

  var timer = setInterval(function() {
    tries += 1;

    var btn = document.querySelector('#vsp-run-fullscan-btn');
    if (!btn) {
      if (tries >= maxTries) {
        console.warn('[VSP_RUN_FULLSCAN_REBIND_POLL_V3] Hết số lần thử, không thấy nút.');
        clearInterval(timer);
      }
      return;
    }

    if (btn.dataset.vspRunReboundV3 === '1') {
      console.log('[VSP_RUN_FULLSCAN_REBIND_POLL_V3] Nút đã được bind V3, dừng poll.');
      clearInterval(timer);
      return;
    }

    // Clone để xoá mọi listener cũ (bao gồm alert cũ)
    var newBtn = btn.cloneNode(true);
    btn.parentNode.replaceChild(newBtn, btn);
    newBtn.dataset.vspRunReboundV3 = '1';

    console.log('[VSP_RUN_FULLSCAN_REBIND_POLL_V3] Đã clone nút Run full scan.');

    newBtn.addEventListener('click', function() {
      // Lấy input trong cùng card/panel với nút
      var card = newBtn.closest('.vsp-card') || newBtn.closest('section') || document;
      var inputs = card.querySelectorAll('input');

      var sourceRoot = inputs[0] ? (inputs[0].value || '').trim() : '';
      var targetUrl  = inputs[1] ? (inputs[1].value || '').trim() : '';

      var profileSel = card.querySelector('select');
      var profile = profileSel && profileSel.value ? profileSel.value.trim() : 'FULL_EXT';

      console.log('[VSP_RUN_FULLSCAN_REBIND_POLL_V3] current values', {
        sourceRoot: sourceRoot,
        targetUrl: targetUrl,
        profile: profile
      });

      if (!sourceRoot && !targetUrl) {
        window.alert('Vui lòng nhập ít nhất Source root hoặc Target URL.');
        return;
      }

      var mode;
      if (sourceRoot && targetUrl) {
        mode = 'FULL_EXT';
      } else if (sourceRoot && !targetUrl) {
        mode = 'EXT_ONLY';
      } else {
        mode = 'URL_ONLY';
      }

      var payload = {
        source_root: sourceRoot || null,
        target_url:  targetUrl  || null,
        profile: profile,
        mode: mode
      };

      console.log('[VSP_RUN_FULLSCAN_REBIND_POLL_V3] payload', payload);

      fetch('/api/vsp/run_fullscan_v1', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      })
      .then(function(r) { return r.json(); })
      .then(function(data) {
        console.log('[VSP_RUN_FULLSCAN_REBIND_POLL_V3] resp', data);
        if (!data.ok) {
          window.alert('Run full scan failed: ' + (data.error || 'unknown error'));
        }
      })
      .catch(function(err) {
        console.error('[VSP_RUN_FULLSCAN_REBIND_POLL_V3] error', err);
        window.alert('Có lỗi khi gửi yêu cầu run full scan.');
      });
    });

    console.log('[VSP_RUN_FULLSCAN_REBIND_POLL_V3] Đã bind lại nút Run full scan.');
    clearInterval(timer);
  }, 200);
})();
// [VSP_RUN_FULLSCAN_CAPTURE_V1] Override click Run full scan (EXT_ONLY / URL_ONLY / FULL_EXT)
(function() {
  console.log('[VSP_RUN_FULLSCAN_CAPTURE_V1] start');

  function bindRunFullscanCapture() {
    var btn = document.querySelector('#vsp-run-fullscan-btn');
    if (!btn) {
      return;
    }
    if (btn.dataset.vspRunCaptureBound === '1') {
      return;
    }
    btn.dataset.vspRunCaptureBound = '1';

    console.log('[VSP_RUN_FULLSCAN_CAPTURE_V1] Bind capture listener cho nút Run full scan.');

    btn.addEventListener('click', function(ev) {
      // Chặn toàn bộ handler cũ (bao gồm alert "Vui lòng nhập Target URL.")
      ev.preventDefault();
      ev.stopImmediatePropagation();

      var card = btn.closest('.vsp-card') || btn.closest('section') || document;
      var inputs = card.querySelectorAll('input');

      var sourceRoot = inputs[0] ? (inputs[0].value || '').trim() : '';
      var targetUrl  = inputs[1] ? (inputs[1].value || '').trim() : '';

      var profileSel = card.querySelector('select');
      var profile = profileSel && profileSel.value ? profileSel.value.trim() : 'FULL_EXT';

      console.log('[VSP_RUN_FULLSCAN_CAPTURE_V1] values', {
        sourceRoot: sourceRoot,
        targetUrl: targetUrl,
        profile: profile
      });

      if (!sourceRoot && !targetUrl) {
        window.alert('Vui lòng nhập ít nhất Source root hoặc Target URL.');
        return;
      }

      var mode;
      if (sourceRoot && targetUrl) {
        mode = 'FULL_EXT';
      } else if (sourceRoot && !targetUrl) {
        mode = 'EXT_ONLY';
      } else {
        mode = 'URL_ONLY';
      }

      var payload = {
        source_root: sourceRoot || null,
        target_url:  targetUrl  || null,
        profile: profile,
        mode: mode
      };

      console.log('[VSP_RUN_FULLSCAN_CAPTURE_V1] payload', payload);

      fetch('/api/vsp/run_fullscan_v1', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      })
      .then(function(r) { return r.json(); })
      .then(function(data) {
        console.log('[VSP_RUN_FULLSCAN_CAPTURE_V1] resp', data);
        if (!data.ok) {
          window.alert('Run full scan failed: ' + (data.error || 'unknown error'));
        }
      })
      .catch(function(err) {
        console.error('[VSP_RUN_FULLSCAN_CAPTURE_V1] error', err);
        window.alert('Có lỗi khi gửi yêu cầu run full scan.');
      });
    }, true); // <= CAPTURE = true
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
      setTimeout(bindRunFullscanCapture, 800);
    });
  } else {
    setTimeout(bindRunFullscanCapture, 800);
  }

  // Phòng trường hợp panel inject muộn
  var tries = 0;
  var maxTries = 30;
  var timer = setInterval(function() {
    tries += 1;
    bindRunFullscanCapture();
    if (tries >= maxTries) {
      clearInterval(timer);
    }
  }, 200);
})();


// [VSP_CI_GATE_WIDGET] auto load CI gate widget
(function() {
  try {
    console.log("[VSP_CI_GATE_WIDGET] injecting widget script");
    var s = document.createElement("script");
    s.src = "/static/js/vsp_ci_gate_widget_v1.js";
    s.defer = true;
    document.head.appendChild(s);
  } catch (e) {
    console.error("[VSP_CI_GATE_WIDGET] failed to inject widget:", e);
  }
})();



// [VSP_DASH_ENHANCE] load dashboard enhancement script
(function() {
  try {
    console.log("[VSP_DASH_ENHANCE] injecting script");
    var s = document.createElement("script");
    s.src = "/static/js/vsp_dashboard_enhance_v1.js";
    s.defer = true;
    document.head.appendChild(s);
  } catch (e) {
    console.error("[VSP_DASH_ENHANCE] failed to inject:", e);
  }
})();


// [VSP_DASH_DELTA_INLINE_v1] Hiển thị Δ Findings bên cạnh label "Charts"
(function () {
  const LOG = (...args) => console.log("[VSP_DASH_DELTA_INLINE]", ...args);

  function onReady(fn) {
    if (document.readyState === "complete" || document.readyState === "interactive") {
      fn();
    } else {
      document.addEventListener("DOMContentLoaded", fn, { once: true });
    }
  }

  async function fetchDelta() {
    try {
      const res = await fetch("/api/vsp/dashboard_delta_latest", { cache: "no-store" });
      if (!res.ok) {
        LOG("HTTP error", res.status);
        return;
      }
      const data = await res.json();
      if (!data || !data.ok || !data.current || !data.previous) {
        LOG("Không đủ dữ liệu delta", data);
        return;
      }
      injectDelta(data);
    } catch (e) {
      LOG("Exception khi gọi dashboard_delta_latest:", e);
    }
  }

  function injectDelta(data) {
    const current = data.current || {};
    const previous = data.previous || {};

    const curTot = typeof current.total_findings === "number" ? current.total_findings : null;
    const prevTot = typeof previous.total_findings === "number" ? previous.total_findings : null;

    if (curTot === null || prevTot === null) {
      LOG("Thiếu total_findings trong current/previous", { current, previous });
      return;
    }

    const diff = curTot - prevTot;
    const cls =
      diff > 0 ? "vsp-delta-up" :
      diff < 0 ? "vsp-delta-down" :
                 "vsp-delta-flat";

    const diffStr = diff > 0 ? `+${diff}` : `${diff}`;

    const root = document.querySelector("#vsp-dashboard-root") || document;
    if (!root) {
      LOG("Không tìm thấy #vsp-dashboard-root");
      return;
    }

    // Tìm node text "Charts" trong dashboard
    const labels = Array.from(root.querySelectorAll("*")).filter((el) => {
      if (el.childElementCount !== 0) return false;
      const txt = (el.textContent || "").trim();
      return txt === "Charts";
    });

    if (!labels.length) {
      LOG("Không tìm thấy label 'Charts' để chèn delta");
      return;
    }

    const chartsLabel = labels[0];
    if (chartsLabel.querySelector(".vsp-dash-delta-inline")) {
      LOG("Delta đã được chèn trước đó, bỏ qua.");
      return;
    }

    const span = document.createElement("span");
    span.className = "vsp-dash-delta-inline";
    span.innerHTML =
      '<span class="vsp-dash-delta-label"> · Δ Findings </span>' +
      `<span class="vsp-dash-delta-val ${cls}">${diffStr}</span>` +
      `<span class="vsp-dash-delta-runs"> (${curTot} vs ${prevTot})</span>`;

    chartsLabel.appendChild(span);

    LOG(
      "Injected delta:",
      diffStr,
      " (",
      curTot,
      "vs",
      prevTot,
      ") current:",
      current.run_id,
      "previous:",
      previous.run_id
    );
  }

  onReady(fetchDelta);
})();

// [VSP_KPI_SCORE_DELTA_v1] Hiển thị Δ Security Score trong card KPI
(function () {
  const LOG = (...args) => console.log("[VSP_KPI_SCORE_DELTA]", ...args);

  function onReady(fn) {
    if (document.readyState === "complete" || document.readyState === "interactive") {
      fn();
    } else {
      document.addEventListener("DOMContentLoaded", fn, { once: true });
    }
  }

  async function fetchDelta() {
    try {
      const res = await fetch("/api/vsp/dashboard_delta_latest", { cache: "no-store" });
      if (!res.ok) {
        LOG("HTTP error", res.status);
        return;
      }
      const data = await res.json();
      if (!data || !data.ok || !data.current || !data.previous) {
        LOG("Không đủ dữ liệu delta", data);
        return;
      }
      renderScoreDelta(data);
    } catch (e) {
      LOG("Exception khi gọi dashboard_delta_latest:", e);
    }
  }

  function renderScoreDelta(data) {
    const current = data.current || {};
    const previous = data.previous || {};

    const curScore = Number(
      typeof current.security_posture_score === "number"
        ? current.security_posture_score
        : 0
    );
    const prevScore = Number(
      typeof previous.security_posture_score === "number"
        ? previous.security_posture_score
        : 0
    );

    if (Number.isNaN(curScore) || Number.isNaN(prevScore)) {
      LOG("Score không hợp lệ", { curScore, prevScore });
      return;
    }

    const delta = curScore - prevScore;
    const deltaStr = delta > 0 ? `+${delta}` : `${delta}`;

    let cls = "vsp-kpi-delta-flat";
    if (delta > 0) cls = "vsp-kpi-delta-up";
    else if (delta < 0) cls = "vsp-kpi-delta-down";

    const card = document.getElementById("vsp-kpi-security-score");
    if (!card) {
      LOG("Không tìm thấy card #vsp-kpi-security-score");
      return;
    }

    if (card.querySelector(".vsp-kpi-delta-score")) {
      LOG("Score delta đã tồn tại, bỏ qua.");
      return;
    }

    const div = document.createElement("div");
    div.className = `vsp-kpi-delta-score ${cls}`;
    div.textContent = `Δ Score ${deltaStr} (${prevScore} → ${curScore})`;

    card.appendChild(div);

    LOG("Render Δ Score:", {
      delta,
      curScore,
      prevScore,
      run_current: current.run_id,
      run_previous: previous.run_id,
    });
  }

  onReady(fetchDelta);
})();
// ===============================================
// [VSP_TABS_ENHANCE_v1]
// Decorate 4 tabs: Runs, DataSource, Settings,
// Rule Overrides với KPI header
// ===============================================
(function () {
  const LOG = (...args) => console.log("[VSP_TABS_ENHANCE]", ...args);

  function onReadyTabsEnhance(fn) {
    if (document.readyState === "complete" || document.readyState === "interactive") {
      fn();
    } else {
      document.addEventListener("DOMContentLoaded", fn, { once: true });
    }
  }

  function ensureTabHeader(tabEl, title, subtitle) {
    if (!tabEl) return null;

    let header = tabEl.querySelector(".vsp-tab-header");
    if (!header) {
      header = document.createElement("div");
      header.className = "vsp-tab-header vsp-tab-header-grid";
      tabEl.prepend(header);
    }

    if (!header.querySelector(".vsp-tab-title")) {
      const titleBox = document.createElement("div");
      titleBox.className = "vsp-tab-title";
      const h2 = document.createElement("h2");
      h2.textContent = title;
      const p = document.createElement("p");
      p.textContent = subtitle || "";
      titleBox.appendChild(h2);
      titleBox.appendChild(p);
      header.appendChild(titleBox);
    }

    let kpiRow = header.querySelector(".vsp-tab-kpi-row");
    if (!kpiRow) {
      kpiRow = document.createElement("div");
      kpiRow.className = "vsp-tab-kpi-row";
      header.appendChild(kpiRow);
    }
    return kpiRow;
  }

  function makeKpiChip(label, value, extra) {
    const div = document.createElement("div");
    div.className = "vsp-kpi-chip";

    const spanLabel = document.createElement("div");
    spanLabel.className = "vsp-kpi-chip-label";
    spanLabel.textContent = label;

    const spanVal = document.createElement("div");
    spanVal.className = "vsp-kpi-chip-value";
    spanVal.textContent = value;

    div.appendChild(spanLabel);
    div.appendChild(spanVal);

    if (extra) {
      const spanExtra = document.createElement("div");
      spanExtra.className = "vsp-kpi-chip-extra";
      spanExtra.textContent = extra;
      div.appendChild(spanExtra);
    }

    return div;
  }

  // -------- Runs & Reports tab --------
  async function enhanceRunsTab() {
    const tab = document.getElementById("vsp-tab-runs");
    if (!tab) {
      LOG("Không thấy tab Runs (#vsp-tab-runs)");
      return;
    }

    let kpiRow = ensureTabHeader(
      tab,
      "Runs & Reports",
      "Lịch sử các lần scan · Chọn 1 run để xem chi tiết."
    );
    if (!kpiRow) return;
    if (kpiRow.dataset.enhanced === "1") {
      LOG("Runs tab đã enhanced, bỏ qua.");
      return;
    }

    try {
      const res = await fetch("/api/vsp/runs_index_v3_fs?limit=50", { cache: "no-store" });
      if (!res.ok) {
        LOG("HTTP error runs_index_v3:", res.status);
        return;
      }
      const data = await res.json();

      const kpi = data.kpi || {};
      const items = Array.isArray(data.items) ? data.items : [];

      const totalRuns = kpi.total_runs || items.length || 0;
      const avgLastN = kpi.avg_findings_per_run_last_n || 0;
      const lastN = kpi.last_n || (items.length || 0);

      const lastRun = items[0] || {};
      const lastRunId = lastRun.run_id || "N/A";
      const lastRunTotal = lastRun.total_findings || lastRun.total || 0;

      kpiRow.appendChild(
        makeKpiChip("Total runs", String(totalRuns), `Last N = ${lastN}`)
      );
      kpiRow.appendChild(
        makeKpiChip("Avg findings (last N)", String(Math.round(avgLastN)), "")
      );
      kpiRow.appendChild(
        makeKpiChip("Latest run", lastRunId, `Findings = ${lastRunTotal}`)
      );

      kpiRow.dataset.enhanced = "1";
      LOG("Enhanced Runs tab KPI:", { totalRuns, avgLastN, lastN, lastRunId, lastRunTotal });
    } catch (e) {
      LOG("Exception enhanceRunsTab:", e);
    }
  }

  // -------- Data Source tab --------
  async function enhanceDatasourceTab() {
    const tab = document.getElementById("vsp-tab-datasource");
    if (!tab) {
      LOG("Không thấy tab DataSource (#vsp-tab-datasource)");
      return;
    }

    let kpiRow = ensureTabHeader(
      tab,
      "Data Source",
      "Bảng chi tiết các findings đã unify từ nhiều tool."
    );
    if (!kpiRow) return;
    if (kpiRow.dataset.enhanced === "1") {
      LOG("DataSource tab đã enhanced, bỏ qua.");
      return;
    }

    try {
      const res = await fetch("/api/vsp/datasource_v2?limit=1", { cache: "no-store" });
      if (!res.ok) {
        LOG("HTTP error datasource_v2:", res.status);
        return;
      }
      const data = await res.json();
      const total = data.total || 0;
      const bySeverity = data.by_severity || {};
      const crit = bySeverity.CRITICAL || 0;
      const high = bySeverity.HIGH || 0;
      const med = bySeverity.MEDIUM || 0;

      kpiRow.appendChild(
        makeKpiChip("Total findings (all tools)", String(total), "")
      );
      kpiRow.appendChild(
        makeKpiChip("Critical / High", `${crit} / ${high}`, "Xử lý nhóm này trước.")
      );
      kpiRow.appendChild(
        makeKpiChip("Medium", String(med), "Ưu tiên theo business impact.")
      );

      kpiRow.dataset.enhanced = "1";
      LOG("Enhanced DataSource tab KPI:", { total, bySeverity });
    } catch (e) {
      LOG("Exception enhanceDatasourceTab:", e);
    }
  }

  // -------- Settings tab --------
  async function enhanceSettingsTab() {
    const tab = document.getElementById("vsp-tab-settings");
    if (!tab) {
      LOG("Không thấy tab Settings (#vsp-tab-settings)");
      return;
    }

    let kpiRow = ensureTabHeader(
      tab,
      "Settings & Profiles",
      "Cấu hình tool, profile scan và policy gate."
    );
    if (!kpiRow) return;
    if (kpiRow.dataset.enhanced === "1") {
      LOG("Settings tab đã enhanced, bỏ qua.");
      return;
    }

    try {
      const res = await fetch("/api/vsp/settings_ui_v1", { cache: "no-store" });
      if (!res.ok) {
        LOG("HTTP error settings_ui_v1:", res.status);
        return;
      }
      const data = await res.json();
      const settings = data.settings || {};

      const gate = settings.gate_policy || {};
      const maxHigh = typeof gate.max_high === "number" ? gate.max_high : 10;

      const tools = settings.tools_enabled || settings.tools || [];
      const toolsArr = Array.isArray(tools) ? tools : [];
      const toolsLabel = toolsArr.length
        ? toolsArr.join(", ")
        : "Semgrep, Gitleaks, KICS, CodeQL, Bandit, Trivy, Syft, Grype";

      kpiRow.appendChild(
        makeKpiChip("Gate policy", "CRIT = 0", `HIGH ≤ ${maxHigh}`)
      );
      kpiRow.appendChild(
        makeKpiChip("Tools enabled", String(toolsArr.length || 8), toolsLabel)
      );

      kpiRow.dataset.enhanced = "1";
      LOG("Enhanced Settings tab KPI:", { gate, toolsArr });
    } catch (e) {
      LOG("Exception enhanceSettingsTab:", e);
    }
  }

  // -------- Rules / Rule Overrides tab --------
  async function enhanceRulesTab() {
    const tab =
      document.getElementById("vsp-tab-rule-overrides") ||
      document.getElementById("vsp-tab-rules");
    if (!tab) {
      LOG("Không thấy tab Rule Overrides (#vsp-tab-rule-overrides / #vsp-tab-rules)");
      return;
    }

    let kpiRow = ensureTabHeader(
      tab,
      "Rule Overrides",
      "Quản lý ngoại lệ, suppression và tuning rule cho tool."
    );
    if (!kpiRow) return;
    if (kpiRow.dataset.enhanced === "1") {
      LOG("Rules tab đã enhanced, bỏ qua.");
      return;
    }

    try {
      const res = await fetch("/api/vsp/rule_overrides_ui_v1", { cache: "no-store" });
      if (!res.ok) {
        LOG("HTTP error rule_overrides_ui_v1:", res.status);
        return;
      }
      const data = await res.json();

      const total = data.total || 0;
      const active = data.active || data.enabled || 0;
      const byTool = data.by_tool || {};
      const toolNames = Object.keys(byTool);
      const toolsCount = toolNames.length;
      const toolsList = toolNames.slice(0, 4).join(", ");

      kpiRow.appendChild(
        makeKpiChip("Total overrides", String(total), `Active = ${active}`)
      );
      kpiRow.appendChild(
        makeKpiChip("Tools with overrides", String(toolsCount), toolsList || "N/A")
      );

      kpiRow.dataset.enhanced = "1";
      LOG("Enhanced Rules tab KPI:", { total, active, byTool });
    } catch (e) {
      LOG("Exception enhanceRulesTab:", e);
    }
  }

  onReadyTabsEnhance(() => {
    try {
      enhanceRunsTab();
      enhanceDatasourceTab();
      enhanceSettingsTab();
      enhanceRulesTab();
    } catch (e) {
      LOG("Exception top-level:", e);
    }
  });
})();
// ====================================================
// [VSP_TABS_ENHANCE_v2]
// Thêm header + KPI cho 4 tab: Runs, Data, Settings,
// Rule Overrides. Dùng MutationObserver chờ tab sẵn sàng.
// ====================================================
(function () {
  const LOG = (...args) => console.log("[VSP_TABS_ENHANCE_V2]", ...args);

  function whenReady(fn) {
    if (document.readyState === "complete" || document.readyState === "interactive") {
      fn();
    } else {
      document.addEventListener("DOMContentLoaded", fn, { once: true });
    }
  }

  // ---- Helper: chờ cho tới khi có element với id ----
  function waitForEl(id, cb) {
    const existing = document.getElementById(id);
    if (existing) {
      cb(existing);
      return;
    }
    const maxTries = 40;
    let tries = 0;

    const obs = new MutationObserver(() => {
      const el = document.getElementById(id);
      if (el) {
        obs.disconnect();
        cb(el);
      } else if (++tries >= maxTries) {
        obs.disconnect();
        LOG("Timeout chờ element", id);
      }
    });

    obs.observe(document.body, { childList: true, subtree: true });
  }

  function ensureTabHeader(tabEl, title, subtitle) {
    if (!tabEl) return null;

    let header = tabEl.querySelector(".vsp-tab-header");
    if (!header) {
      header = document.createElement("div");
      header.className = "vsp-tab-header vsp-tab-header-grid";
      tabEl.prepend(header);
    }

    if (!header.querySelector(".vsp-tab-title")) {
      const titleBox = document.createElement("div");
      titleBox.className = "vsp-tab-title";
      const h2 = document.createElement("h2");
      h2.textContent = title;
      const p = document.createElement("p");
      p.textContent = subtitle || "";
      titleBox.appendChild(h2);
      titleBox.appendChild(p);
      header.appendChild(titleBox);
    }

    let kpiRow = header.querySelector(".vsp-tab-kpi-row");
    if (!kpiRow) {
      kpiRow = document.createElement("div");
      kpiRow.className = "vsp-tab-kpi-row";
      header.appendChild(kpiRow);
    }
    return kpiRow;
  }

  function makeKpiChip(label, value, extra) {
    const div = document.createElement("div");
    div.className = "vsp-kpi-chip";

    const lab = document.createElement("div");
    lab.className = "vsp-kpi-chip-label";
    lab.textContent = label;

    const val = document.createElement("div");
    val.className = "vsp-kpi-chip-value";
    val.textContent = value;

    div.appendChild(lab);
    div.appendChild(val);

    if (extra) {
      const ext = document.createElement("div");
      ext.className = "vsp-kpi-chip-extra";
      ext.textContent = extra;
      div.appendChild(ext);
    }
    return div;
  }

  // ------------- Runs & Reports ----------------
  async function enhanceRuns(tab) {
    const kpiRow = ensureTabHeader(
      tab,
      "Runs & Reports",
      "Lịch sử scan · chọn 1 run để xem / export."
    );
    if (!kpiRow || kpiRow.dataset.enhanced === "1") return;

    try {
      const res = await fetch("/api/vsp/runs_index_v3_fs?limit=50", { cache: "no-store" });
      if (!res.ok) {
        LOG("HTTP error runs_index_v3:", res.status);
        return;
      }
      const data = await res.json();
      const kpi = data.kpi || {};
      const items = Array.isArray(data.items) ? data.items : [];

      const totalRuns = kpi.total_runs || items.length || 0;
      const lastN = kpi.last_n || (items.length || 0);
      const avgLastN = kpi.avg_findings_per_run_last_n || 0;

      const lastRun = items[0] || {};
      const lastRunId = lastRun.run_id || "N/A";
      const lastRunTotal = lastRun.total_findings || lastRun.total || 0;

      kpiRow.appendChild(
        makeKpiChip("Total runs", String(totalRuns), `Last N = ${lastN}`)
      );
      kpiRow.appendChild(
        makeKpiChip("Avg findings (last N)", String(Math.round(avgLastN)), "")
      );
      kpiRow.appendChild(
        makeKpiChip("Latest run", lastRunId, `Findings = ${lastRunTotal}`)
      );

      kpiRow.dataset.enhanced = "1";
      LOG("Runs tab enhanced.");
    } catch (e) {
      LOG("Runs enhance error:", e);
    }
  }

  // ------------- Data Source -------------------
  async function enhanceDataSource(tab) {
    const kpiRow = ensureTabHeader(
      tab,
      "Data Source",
      "Bảng chi tiết findings unify từ nhiều tool."
    );
    if (!kpiRow || kpiRow.dataset.enhanced === "1") return;

    try {
      const res = await fetch("/api/vsp/datasource_v2?limit=1", { cache: "no-store" });
      if (!res.ok) {
        LOG("HTTP error datasource_v2:", res.status);
        return;
      }
      const data = await res.json();
      const total = data.total || 0;
      const sev = data.by_severity || {};
      const crit = sev.CRITICAL || 0;
      const high = sev.HIGH || 0;
      const med = sev.MEDIUM || 0;

      kpiRow.appendChild(
        makeKpiChip("Total findings", String(total), "Từ tất cả tools")
      );
      kpiRow.appendChild(
        makeKpiChip("Critical / High", `${crit} / ${high}`, "Xử lý nhóm này trước")
      );
      kpiRow.appendChild(
        makeKpiChip("Medium", String(med), "Ưu tiên theo business impact")
      );

      kpiRow.dataset.enhanced = "1";
      LOG("DataSource tab enhanced.");
    } catch (e) {
      LOG("DataSource enhance error:", e);
    }
  }

  // ------------- Settings ----------------------
  async function enhanceSettings(tab) {
    const kpiRow = ensureTabHeader(
      tab,
      "Settings & Profiles",
      "Cấu hình tool, profile scan, gate policy."
    );
    if (!kpiRow || kpiRow.dataset.enhanced === "1") return;

    try {
      const res = await fetch("/api/vsp/settings_ui_v1", { cache: "no-store" });
      if (!res.ok) {
        LOG("HTTP error settings_ui_v1:", res.status);
        return;
      }
      const data = await res.json();
      const settings = data.settings || {};

      const gate = settings.gate_policy || {};
      const maxHigh = typeof gate.max_high === "number" ? gate.max_high : 10;

      const tools = settings.tools_enabled || settings.tools || [];
      const arr = Array.isArray(tools) ? tools : [];
      const toolsLabel = arr.length
        ? arr.join(", ")
        : "Semgrep, Gitleaks, KICS, CodeQL, Bandit, Trivy, Syft, Grype";

      kpiRow.appendChild(
        makeKpiChip("Gate policy", "CRIT = 0", `HIGH ≤ ${maxHigh}`)
      );
      kpiRow.appendChild(
        makeKpiChip("Tools enabled", String(arr.length || 8), toolsLabel)
      );

      kpiRow.dataset.enhanced = "1";
      LOG("Settings tab enhanced.");
    } catch (e) {
      LOG("Settings enhance error:", e);
    }
  }

  // ------------- Rules / Overrides -------------
  async function enhanceRules(tab) {
    const kpiRow = ensureTabHeader(
      tab,
      "Rule Overrides",
      "Quản lý ngoại lệ, suppression, tuning rule."
    );
    if (!kpiRow || kpiRow.dataset.enhanced === "1") return;

    try {
      const res = await fetch("/api/vsp/rule_overrides_ui_v1", { cache: "no-store" });
      if (!res.ok) {
        LOG("HTTP error rule_overrides_ui_v1:", res.status);
        return;
      }
      const data = await res.json();
      const total = data.total || 0;
      const active = data.active || data.enabled || 0;
      const byTool = data.by_tool || {};
      const tools = Object.keys(byTool);
      const toolsList = tools.slice(0, 4).join(", ");

      kpiRow.appendChild(
        makeKpiChip("Total overrides", String(total), `Active = ${active}`)
      );
      kpiRow.appendChild(
        makeKpiChip("Tools with overrides", String(tools.length), toolsList || "N/A")
      );

      kpiRow.dataset.enhanced = "1";
      LOG("Rules tab enhanced.");
    } catch (e) {
      LOG("Rules enhance error:", e);
    }
  }

  whenReady(function () {
    LOG("Init tab enhancements V2...");

    waitForEl("vsp-tab-runs", enhanceRuns);
    waitForEl("vsp-tab-datasource", enhanceDataSource);
    waitForEl("vsp-tab-settings", enhanceSettings);

    // rules tab id có thể là vsp-tab-rule-overrides hoặc vsp-tab-rules
    waitForEl("vsp-tab-rule-overrides", enhanceRules);
    waitForEl("vsp-tab-rules", enhanceRules);
  });
})();


/* == VSP TABS HASH ROUTER LOADER v1 ==
 * Tự động load /static/js/vsp_tabs_hash_router_v1.js
 * trên mọi trang đang dùng vsp_console_patch_v1.js
 * (đã có guard tránh load nhiều lần).
 */
(function () {
  try {
    if (window.VSP_TABS_HASH_ROUTER_LOADER) return;
    window.VSP_TABS_HASH_ROUTER_LOADER = true;

    var s = document.createElement('script');
    s.src = '/static/js/vsp_tabs_hash_router_v1.js';
    s.defer = true;
    s.onload = function () {
      console.log('[VSP_CONSOLE_PATCH] vsp_tabs_hash_router_v1.js loaded.');
    };
    document.head.appendChild(s);
  } catch (e) {
    console.warn('[VSP_CONSOLE_PATCH] Failed to attach hash router loader', e);
  }
})();

})();
/* ==== END: static/js/vsp_console_patch_v1.js ==== */

/* ==== BEGIN: static/js/vsp_dashboard_cleanup_v1.js ==== */
(function(){
'use strict';
// static/js/vsp_dashboard_cleanup_v1.js
// TẠM THỜI VÔ HIỆU – không ẩn gì hết, chỉ log cho dễ debug.

(function () {
  'use strict';
  console.log('[VSP_DASH_CLEANUP] disabled – no legacy block is hidden.');
})();

})();
/* ==== END: static/js/vsp_dashboard_cleanup_v1.js ==== */

/* ==== BEGIN: static/js/vsp_dashboard_comm_enhance_v1.js ==== */
(function(){
'use strict';
// VSP_SAFE_DRILLDOWN_HARDEN_P0_V6

  // VSP_DD_LOCAL_SAFE_VAR_V1: force local callable symbol (prevents TypeError forever)
  try{
    function __vsp_dd_stub_local(){
      try{ console.info("[VSP][DD] local-safe stub invoked"); }catch(_){}
      return {open:function(){},show:function(){},close:function(){},destroy:function(){}};
    }
    try{
      if (typeof window !== "undefined") {


/* VSP_FIX_DRILLDOWN_ARTIFACTS_NOT_FUNCTION_P0_V2
 * Fix: TypeError __VSP_DD_ART_CALL__(VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2, ...) is not a function
 * Normalize BEFORE first use:
 *   - if function: keep
 *   - if object with .open(): wrap as function(arg)->obj.open(arg)
 *   - else: no-op (never throw)
 */
(function(){
  'use strict';
  



/* VSP_FIX_DRILLDOWN_CALLSITE_P0_V5: safe-call drilldown artifacts (function OR object.open) */
function __VSP_DD_ART_CALL__(h, ...args) {
  try {
    if (typeof h === 'function') return h(...args);
    if (h && typeof h.open === 'function') return h.open(...args);
  } catch(e) { try{console.warn('[VSP][DD_SAFE]', e);}catch(_e){} }
  return null;
}

/* VSP_FIX_DRILLDOWN_CALLSITE_P0_V3: safe-call for drilldown artifacts (function OR object.open) */
function __VSP_DD_ART_CALL__(h, ...args) {
  try {
    if (typeof h === 'function') return h(...args);
    if (h && typeof h.open === 'function') return h.open(...args);
  } catch (e) {
    try { console.warn('[VSP][DD_SAFE] call failed', e); } catch (_e) {}
  }
  return null;
}

if (window.__VSP_FIX_DRILLDOWN_ARTIFACTS_NOT_FUNCTION_P0_V2) return;
  window.__VSP_FIX_DRILLDOWN_ARTIFACTS_NOT_FUNCTION_P0_V2 = 1;

  function normalize(v){
    if (typeof v === 'function') return v;
    if (v && typeof v.open === 'function') {
      const obj = v;
      const fn = function(arg){ try { return obj.open(arg); } catch(e){ console.warn('[VSP][DD_FIX] open() failed', e); return null; } };
      fn.__wrapped_from_object = true;
      return fn;
    }
    const noop = function(_arg){ return null; };
    noop.__noop = true;
    return noop;
  }

  try {
    // trap future assignments
    let _val = window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2;
    Object.defineProperty(window, 'VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2', {
      configurable: true, enumerable: true,
      get: function(){ return _val; },
      set: function(v){ _val = normalize(v); }
    });
    window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 = _val;
  } catch(e) {
    window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 = normalize(window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2);
  }
})();

        if (typeof window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 !== "function") {
          window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 = __vsp_dd_stub_local;
        }
      }
    }catch(_){}
    // IMPORTANT: bind a LOCAL var used by this file (so later overwrites can't break us)
    var VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 =
      (typeof window !== "undefined" && typeof window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 === "function")
        ? window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2
        : __vsp_dd_stub_local;
  }catch(_){}

  // VSP_DD_CALLSAFE_P0_V2: ALWAYS call window drilldown as function, never crash
  function __VSP_DD_CALL__(/*...args*/){
    try{
      var fn = (typeof window !== "undefined" && typeof window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 === "function")
        ? window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2
        : function(){ return {open:function(){},show:function(){},close:function(){},destroy:function(){}}; };
      return fn.apply(null, arguments);
    }catch(_){
      return {open:function(){},show:function(){},close:function(){},destroy:function(){}};
    }
  }

  // VSP_DD_GUARD_LOCAL_V1: never crash if drilldown symbol isn't a function
  try{
    function __vsp_dd_stub(){
      try{ console.info("[VSP][DD] local stub invoked"); }catch(_){}
      return {open:function(){},show:function(){},close:function(){},destroy:function(){}};
    }
    if (typeof window !== "undefined") {
      if (typeof window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 !== "function") {
        window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 = __vsp_dd_stub;
      }
    }
  }catch(_){}
"use strict";

/**
 * VSP_DASHBOARD_COMM_ENHANCE_V1
 * - Bổ sung KPI cho TAB 2 (Runs & Reports): Total runs + Last run timestamp
 * - Đổ bảng Run index vào #vsp-runs-container
 * - Đổ bảng Data Source (severity + theo tool) vào #vsp-datasource-container
 */
(function () {
  function formatTs(ts) {
    if (!ts) return "–";
    return String(ts).replace("T", " ").split(".")[0];
  }

  /* ======================
   *  RUNS & REPORTS (TAB 2)
   * ====================== */
  function renderRuns(data) {
    var container = document.getElementById("vsp-runs-container");
    if (!container) return;

    var items;
    if (Array.isArray(data)) {
      items = data;
    } else if (data && Array.isArray(data.items)) {
      items = data.items;
    } else {
      items = [];
    }

    if (!items.length) {
      container.innerHTML =
        '<p style="font-size:12px;color:#9ca3c7;">Không tải được dữ liệu runs.</p>';
      return;
    }

    // KPI: total runs + last run timestamp
    var totalRuns = items.length;
    var latest = items[0] || {};
    var kpiCards = document.querySelectorAll("#tab-runs .kpi-value");
    if (kpiCards[0]) {
      kpiCards[0].textContent = String(totalRuns);
    }
    if (kpiCards[1]) {
      kpiCards[1].textContent = formatTs(latest.ts || latest.ts_last_run);
    }

    // Bảng Run index
    var html = '';
    html += '<div style="max-height: 320px; overflow:auto;">';
    html += '<table class="vsp-table">';
    html += '<thead><tr>';
    html += '<th>Run ID</th>';
    html += '<th>Total</th>';
    html += '<th>CRI</th>';
    html += '<th>HIGH</th>';
    html += '<th>MED</th>';
    html += '<th>LOW</th>';
    html += '</tr></thead><tbody>';

    items.forEach(function (r) {
      var sev = r.by_severity || r.severity || {};
      var total = r.total_findings || r.total || 0;
      html += '<tr>';
      html += '<td style="white-space:nowrap;">' + (r.run_id || "–") + '</td>';
      html += '<td>' + total + '</td>';
      html += '<td>' + (sev.CRITICAL || 0) + '</td>';
      html += '<td>' + (sev.HIGH || 0) + '</td>';
      html += '<td>' + (sev.MEDIUM || 0) + '</td>';
      html += '<td>' + (sev.LOW || 0) + '</td>';
      html += '</tr>';
    });

    html += '</tbody></table></div>';
    container.innerHTML = html;
  }

  function loadRuns() {
    fetch("/api/vsp/runs_index_v3_v3", { cache: "no-store" })
      .then(function (res) { return res.json(); })
      .then(function (data) { renderRuns(data); })
      .catch(function (err) {
        console.error("[VSP] load runs_index_v3 error:", err);
        var container = document.getElementById("vsp-runs-container");
        if (container) {
          container.innerHTML =
            '<p style="font-size:12px;color:#fca5a5;">Lỗi khi tải dữ liệu runs.</p>';
        }
      });
  }

  /* ======================
   *  DATA SOURCE (TAB 3)
   * ====================== */
  function get(obj, key) {
    return obj && obj[key] != null ? obj[key] : 0;
  }

  function renderDatasource(data) {
    var container = document.getElementById("vsp-datasource-container");
    if (!container) return;

    var summary = (data && data.summary) ? data.summary : data || {};
    var bySev = summary.by_severity || summary.severity || {};
    var byTool = summary.by_tool || {};

    var html = '';
    html += '<div class="vsp-card-soft">';
    html += '<div style="display:grid;grid-template-columns:minmax(0,0.7fr) minmax(0,1fr);gap:8px;">';

    // Bảng theo severity
    html += '<div>';
    html += '<div style="font-size:12px;font-weight:600;color:#e5e7eb;margin-bottom:4px;">Tổng quan theo mức độ</div>';
    html += '<table class="vsp-table" style="font-size:11px;">';
    html += '<thead><tr><th>Severity</th><th>Count</th></tr></thead><tbody>';
    ["CRITICAL","HIGH","MEDIUM","LOW","INFO","TRACE"].forEach(function (sev) {
      html += '<tr>';
      html += '<td>' + sev + '</td>';
      html += '<td>' + get(bySev, sev) + '</td>';
      html += '</tr>';
    });
    html += '</tbody></table>';
    html += '</div>';

    // Bảng theo tool
    html += '<div>';
    html += '<div style="font-size:12px;font-weight:600;color:#e5e7eb;margin-bottom:4px;">Theo tool</div>';

    var toolNames = Object.keys(byTool || {});
    if (!toolNames.length) {
      html += '<p style="font-size:11px;color:#9ca3c7;">Không có dữ liệu theo tool.</p>';
    } else {
      html += '<table class="vsp-table" style="font-size:11px;">';
      html += '<thead><tr>';
      html += '<th>Tool</th>';
      html += '<th>CRI</th>';
      html += '<th>HIGH</th>';
      html += '<th>MED</th>';
      html += '<th>LOW</th>';
      html += '<th>INFO</th>';
      html += '<th>TRACE</th>';
      html += '</tr></thead><tbody>';

      toolNames.forEach(function (tool) {
        var sev = byTool[tool] || {};
        html += '<tr>';
        html += '<td>' + tool + '</td>';
        html += '<td>' + get(sev,"CRITICAL") + '</td>';
        html += '<td>' + get(sev,"HIGH") + '</td>';
        html += '<td>' + get(sev,"MEDIUM") + '</td>';
        html += '<td>' + get(sev,"LOW") + '</td>';
        html += '<td>' + get(sev,"INFO") + '</td>';
        html += '<td>' + get(sev,"TRACE") + '</td>';
        html += '</tr>';
      });

      html += '</tbody></table>';
    }

    html += '</div>'; // col tool
    html += '</div>'; // grid
    html += '</div>'; // card-soft

    container.innerHTML = html;
  }

  function loadDatasource() {
    fetch("/api/vsp/datasource?mode=dashboard", { cache: "no-store" })
      .then(function (res) { return res.json(); })
      .then(function (data) { renderDatasource(data); })
      .catch(function (err) {
        console.error("[VSP] load datasource dashboard error:", err);
        var container = document.getElementById("vsp-datasource-container");
        if (container) {
          container.innerHTML =
            '<p style="font-size:12px;color:#fca5a5;">Lỗi khi tải unified datasource.</p>';
        }
      });
  }

  /* ======================
   *  INIT
   * ====================== */
  function init() {
    loadRuns();
    loadDatasource();
  }

  // Cho chắc chắn chạy sau khi DOM sẵn sàng
  document.addEventListener("DOMContentLoaded", init);
  window.VSP_DASHBOARD_COMM_ENHANCE_V1 = init;
})();

})();
/* ==== END: static/js/vsp_dashboard_comm_enhance_v1.js ==== */

/* ==== BEGIN: static/js/vsp_dashboard_extras_v2.js ==== */
(function(){
'use strict';
// ======================= VSP_DASHBOARD_EXTRAS_V2 =======================
// Dò table theo header thay vì ID:
//  - Top risk findings  : headers ~ [Severity, Tool, Location, Rule]
//  - Top noisy paths    : headers ~ [Path, Total, Noise level]

(function () {
  console.log("[EXTRAS] script loaded (header-scan mode)");

  function norm(str) {
    return (str || "").trim().toLowerCase();
  }

  function getHeaders(table) {
    const ths = table.querySelectorAll("thead tr th");
    if (!ths.length) return [];
    return Array.prototype.map.call(ths, (th) => norm(th.textContent));
  }

  function findTableByHeaders(expected) {
    const tables = document.querySelectorAll("table");
    for (const tbl of tables) {
      const heads = getHeaders(tbl);
      if (heads.length < expected.length) continue;
      let ok = true;
      for (let i = 0; i < expected.length; i++) {
        if (!heads[i] || heads[i].indexOf(expected[i]) === -1) {
          ok = false;
          break;
        }
      }
      if (ok) return tbl;
    }
    return null;
  }

  function renderTopRisk(list) {
    const tbl = findTableByHeaders(["severity", "tool", "location", "rule"]);
    if (!tbl) {
      console.warn("[EXTRAS] Không tìm thấy table top risk theo header");
      return;
    }
    const tbody = tbl.querySelector("tbody") || tbl;
    tbody.innerHTML = "";

    if (!list || list.length === 0) {
      const tr = document.createElement("tr");
      const td = document.createElement("td");
      td.colSpan = 4;
      td.textContent = "No critical/high findings in this run.";
      td.classList.add("vsp-empty-cell");
      tr.appendChild(td);
      tbody.appendChild(tr);
      return;
    }

    list.forEach((item) => {
      const tr = document.createElement("tr");

      const tdSev = document.createElement("td");
      tdSev.textContent = item.severity || "-";
      tdSev.classList.add("vsp-sev", "vsp-sev-" + (item.severity || "").toLowerCase());

      const tdTool = document.createElement("td");
      tdTool.textContent = item.tool || "-";

      const tdLoc = document.createElement("td");
      tdLoc.textContent = item.location || "-";

      const tdRule = document.createElement("td");
      tdRule.textContent = item.rule_id || item.cwe || "-";

      tr.appendChild(tdSev);
      tr.appendChild(tdTool);
      tr.appendChild(tdLoc);
      tr.appendChild(tdRule);

      tbody.appendChild(tr);
    });
  }

  function renderTopNoisy(list) {
    const tbl = findTableByHeaders(["path", "total", "noise"]);
    if (!tbl) {
      console.warn("[EXTRAS] Không tìm thấy table top noisy theo header");
      return;
    }
    const tbody = tbl.querySelector("tbody") || tbl;
    tbody.innerHTML = "";

    if (!list || list.length === 0) {
      const tr = document.createElement("tr");
      const td = document.createElement("td");
      td.colSpan = 3;
      td.textContent = "No medium/low/info/trace clusters in this run.";
      td.classList.add("vsp-empty-cell");
      tr.appendChild(td);
      tbody.appendChild(tr);
      return;
    }

    list.forEach((item) => {
      const tr = document.createElement("tr");

      const tdPath = document.createElement("td");
      tdPath.textContent = item.path || "-";

      const tdTotal = document.createElement("td");
      tdTotal.textContent = item.total != null ? String(item.total) : "-";

      const tdNoise = document.createElement("td");
      tdNoise.textContent = item.noise_level || "-";
      tdNoise.classList.add("vsp-noise-" + (item.noise_level || "").toLowerCase());

      tr.appendChild(tdPath);
      tr.appendChild(tdTotal);
      tr.appendChild(tdNoise);

      tbody.appendChild(tr);
    });
  }

  async function init() {
    try {
      const res = await fetch("/static/data/vsp_dashboard_extras_latest.json", {
        cache: "no-store",
      });
      console.log("[EXTRAS] fetch status", res.status);
      if (!res.ok) {
        console.warn("[EXTRAS] Không load được extras JSON:", res.status);
        return;
      }
      const data = await res.json();
      console.log("[EXTRAS] Loaded extras for run", data.run_id);

      renderTopRisk(data.top_risk_findings || []);
      renderTopNoisy(data.top_noisy_paths || []);
    } catch (err) {
      console.error("[EXTRAS][ERR] Khi load extras:", err);
    }
  }

  document.addEventListener("DOMContentLoaded", init);
})();

})();
/* ==== END: static/js/vsp_dashboard_extras_v2.js ==== */

/* ==== BEGIN: static/js/vsp_dashboard_findings_v1.js ==== */
(function(){
'use strict';
;(function () {
  const LOG_PREFIX = "[VSP_DASH_FINDINGS]";
  console.log(LOG_PREFIX, "Stub loaded – Dashboard findings zone is disabled in this build.");
  // Bản thương mại V1: không inject extra findings zone để giữ layout gọn.
  // Khi nào muốn bật lại, sẽ viết lại file này theo spec mới.
})();

})();
/* ==== END: static/js/vsp_dashboard_findings_v1.js ==== */

/* ==== BEGIN: static/js/vsp_dashboard_kpi_adv_v1.js ==== */
(function(){
'use strict';
(function () {
  'use strict';

  const API_URL = '/api/vsp/dashboard_v3_v2';

  function findKpiCardByTitle(titleText) {
    var all = document.querySelectorAll('*');
    var titleEl = null;

    for (var i = 0; i < all.length; i++) {
      var txt = (all[i].textContent || '').trim();
      if (txt === titleText) {
        titleEl = all[i];
        break;
      }
    }
    if (!titleEl) return null;

    var card = titleEl;
    for (var depth = 0; depth < 5 && card; depth++) {
      if (card.classList && card.classList.contains('vsp-kpi-card')) {
        return card;
      }
      card = card.parentElement;
    }
    return titleEl.parentElement || titleEl;
  }

  function setKpiValue(title, main, sub) {
    var card = findKpiCardByTitle(title);
    if (!card) return;

    var mainEl = card.querySelector('.vsp-kpi-value');
    if (!mainEl) {
      mainEl = document.createElement('div');
      mainEl.className = 'vsp-kpi-value';
      card.appendChild(mainEl);
    }
    mainEl.textContent = main;

    if (sub !== undefined) {
      var subEl = card.querySelector('.vsp-kpi-sub');
      if (!subEl) {
        subEl = document.createElement('div');
        subEl.className = 'vsp-kpi-sub';
        card.appendChild(subEl);
      }
      subEl.textContent = sub;
    }
  }

  function renderKpi(data) {
    if (!data) return;

    var total = Number(data.total_findings || 0);

    var summary = data.summary || {};
    var sev = summary.by_severity || data.severity || {};

    var crit  = Number(sev.CRITICAL || 0);
    var high  = Number(sev.HIGH     || 0);
    var med   = Number(sev.MEDIUM   || 0);
    var low   = Number(sev.LOW      || 0);
    var info  = Number(sev.INFO     || 0);
    var trace = Number(sev.TRACE    || 0);
    var infoTrace = info + trace;

    // 6 KPI severity
    setKpiValue('Total Findings', total.toLocaleString(), '');
    setKpiValue('Critical',       crit.toLocaleString(), '');
    setKpiValue('High',           high.toLocaleString(), '');
    setKpiValue('Medium',         med.toLocaleString(), '');
    setKpiValue('Low',            low.toLocaleString(), '');
    setKpiValue('Info / Trace',   infoTrace.toLocaleString(), '');

    // 4 KPI nâng cao – hiện BE chưa có, để "-" cho đẹp
    var score   = summary.security_score;
    var topTool = summary.top_risky_tool || '-';
    var topCwe  = summary.top_cwe        || '-';
    var topMod  = summary.top_module     || '-';

    if (typeof score === 'number') {
      setKpiValue('Security Score', String(score), '/100');
    } else {
      setKpiValue('Security Score', '-', '/100');
    }

    setKpiValue('Top Risky Tool', topTool, '');
    setKpiValue('Top CWE',        topCwe,  '');
    setKpiValue('Top Module',     topMod,  '');
  }

  function loadKpi() {
    fetch(API_URL)
      .then(function (r) { return r.json(); })
      .then(function (data) {
        if (!data || data.ok === false) {
          console.warn('[VSP][KPI] /api/vsp/dashboard_v3_v2 not ok:', data);
          return;
        }
        renderKpi(data);
      })
      .catch(function (err) {
        console.error('[VSP][KPI] fetch error:', err);
      });
  }

  document.addEventListener('DOMContentLoaded', loadKpi);
})();

})();
/* ==== END: static/js/vsp_dashboard_kpi_adv_v1.js ==== */

/* ==== BEGIN: static/js/vsp_dashboard_kpi_adv_v2.js ==== */
(function(){
'use strict';
/* ---------------------------------------------------------
 * VSP CIO VIEW – Advanced KPI (Top risks + Noisy paths)
 * Không sửa layout, chỉ inject data vào 2 bảng:
 *  - "Top risk findings"
 *  - "Top noisy paths"
 * Tự tìm bảng bằng heading text, không cần thêm id.
 * --------------------------------------------------------- */

(function () {
  "use strict";

  function dbg() {
    if (window.console && console.log) {
      console.log.apply(console, arguments);
    }
  }

  function findTbodyByHeading(keyword) {
    keyword = (keyword || "").toLowerCase();
    if (!keyword) return null;

    var headings = document.querySelectorAll("h2, h3, h4, h5");
    for (var i = 0; i < headings.length; i++) {
      var h = headings[i];
      var txt = (h.textContent || "").toLowerCase();
      if (txt.indexOf(keyword) !== -1) {
        // tìm container gần nhất có table
        var container = h.closest("section, article, div") || h.parentElement;
        if (!container) continue;
        var tbody = container.querySelector("tbody");
        if (tbody) {
          return tbody;
        }
      }
    }
    return null;
  }

  /* ------------------------------
     TOP RISK FINDINGS
     (CRITICAL + HIGH)
  ------------------------------ */
  function loadTopRiskFindings() {
    var severities = ["CRITICAL", "HIGH"];
    var promises = [];

    for (var i = 0; i < severities.length; i++) {
      (function (sev) {
        var url = "/api/vsp/datasource_v2?severity=" +
                  encodeURIComponent(sev) + "&limit=50";
        dbg("[VSP][ADV] top risks GET", url);
        var p = fetch(url)
          .then(function (r) { return r.json(); })
          .catch(function (e) {
            console.error("[VSP][ADV] top risks fetch ERR (" + sev + "):", e);
            return null;
          });
        promises.push(p);
      })(severities[i]);
    }

    Promise.all(promises).then(function (results) {
      var tbody = findTbodyByHeading("top risk findings");
      if (!tbody) {
        dbg("[VSP][ADV] Không tìm thấy bảng 'Top risk findings' trong DOM.");
        return;
      }

      var allItems = [];
      for (var i = 0; i < results.length; i++) {
        var res = results[i];
        if (!res || res.ok === false || !Array.isArray(res.items)) continue;
        allItems = allItems.concat(res.items);
      }

      if (!allItems.length) {
        tbody.innerHTML =
          '<tr><td colspan="4">No CRITICAL/HIGH findings.</td></tr>';
        return;
      }

      // sort: CRITICAL trước HIGH
      var weight = { CRITICAL: 2, HIGH: 1 };
      allItems.sort(function (a, b) {
        var sa = a.severity_effective || a.severity || "HIGH";
        var sb = b.severity_effective || b.severity || "HIGH";
        var wa = weight[sa] || 0;
        var wb = weight[sb] || 0;
        if (wa !== wb) return wb - wa;
        return 0;
      });

      // Lấy TOP 10
      allItems = allItems.slice(0, 10);

      tbody.innerHTML = "";
      for (var j = 0; j < allItems.length; j++) {
        var it = allItems[j];
        var sev  = it.severity_effective || it.severity || "N/A";
        var tool = it.tool || "";
        var loc  = it.file || it.path || "";
        var rule = it.rule_id || it.cwe || "";

        var tr = document.createElement("tr");
        tr.innerHTML =
          "<td>" + sev  + "</td>" +
          "<td>" + tool + "</td>" +
          "<td>" + loc  + "</td>" +
          "<td>" + rule + "</td>";
        tbody.appendChild(tr);
      }
    });
  }

  /* ------------------------------
     TOP NOISY PATHS
     (MEDIUM / LOW / INFO / TRACE)
  ------------------------------ */
  function loadTopNoisyPaths() {
    var severities = ["MEDIUM", "LOW", "INFO", "TRACE"];
    var promises = [];

    for (var i = 0; i < severities.length; i++) {
      (function (sev) {
        var url = "/api/vsp/datasource_v2?severity=" +
                  encodeURIComponent(sev) + "&limit=200";
        dbg("[VSP][ADV] noisy paths GET", url);
        var p = fetch(url)
          .then(function (r) { return r.json(); })
          .catch(function (e) {
            console.error("[VSP][ADV] noisy paths fetch ERR (" + sev + "):", e);
            return null;
          });
        promises.push(p);
      })(severities[i]);
    }

    Promise.all(promises).then(function (results) {
      var tbody = findTbodyByHeading("top noisy paths");
      if (!tbody) {
        dbg("[VSP][ADV] Không tìm thấy bảng 'Top noisy paths' trong DOM.");
        return;
      }

      var counts = {}; // path/file -> total

      for (var i = 0; i < results.length; i++) {
        var res = results[i];
        if (!res || res.ok === false || !Array.isArray(res.items)) continue;

        for (var j = 0; j < res.items.length; j++) {
          var it = res.items[j];
          var key = it.file || it.path || "";
          if (!key) continue;
          if (!counts[key]) counts[key] = 0;
          counts[key] += 1;
        }
      }

      var paths = [];
      for (var k in counts) {
        if (!counts.hasOwnProperty(k)) continue;
        paths.push({ path: k, total: counts[k] });
      }

      if (!paths.length) {
        tbody.innerHTML =
          '<tr><td colspan="3">No noisy paths (MEDIUM/LOW/INFO/TRACE).</td></tr>';
        return;
      }

      // sort desc theo total
      paths.sort(function (a, b) {
        return b.total - a.total;
      });

      // helper noise level
      function noiseLevel(total) {
        if (total >= 20) return "HIGH";
        if (total >= 10) return "MEDIUM";
        if (total >= 3)  return "LOW";
        return "MINOR";
      }

      // Lấy TOP 10
      paths = paths.slice(0, 10);

      tbody.innerHTML = "";
      for (var p = 0; p < paths.length; p++) {
        var e = paths[p];
        var tr = document.createElement("tr");
        tr.innerHTML =
          "<td>" + e.path + "</td>" +
          "<td>" + e.total + "</td>" +
          "<td>" + noiseLevel(e.total) + "</td>";
        tbody.appendChild(tr);
      }
    });
  }

  /* ------------------------------
     INIT – KHÔNG ĐỤNG JS CŨ
  ------------------------------ */
  function initAdvKpi() {
    dbg("[VSP][ADV] init advanced KPI (top risks + noisy paths)");
    loadTopRiskFindings();
    loadTopNoisyPaths();
  }

  document.addEventListener("DOMContentLoaded", initAdvKpi);
})();

})();
/* ==== END: static/js/vsp_dashboard_kpi_adv_v2.js ==== */

/* ==== BEGIN: static/js/vsp_dashboard_kpi_force_any_v1.js ==== */
(function(){
'use strict';
(function () {
  if (window.VSP_DASH_FORCE_INIT) {
    console.log('[VSP_DASH_FORCE] already initialized, skip');
    return;
  }
  window.VSP_DASH_FORCE_INIT = true;

  console.log('[VSP_DASH_FORCE] vsp_dashboard_kpi_force_any_v1.js loaded');

  function fmtInt(n) {
    if (n == null || isNaN(n)) return '--';
    return Number(n).toLocaleString('en-US');
  }

  function setText(id, value, isNumber) {
    var el = document.getElementById(id);
    if (!el) return;
    if (value == null || value === '') {
      el.textContent = '--';
      return;
    }
    el.textContent = isNumber ? fmtInt(value) : String(value);
  }

  async function loadKpiOnce() {
    try {
      const res = await fetch('/api/vsp/dashboard_v3');
      if (!res.ok) {
        console.warn('[VSP_DASH_FORCE] dashboard_v3 HTTP != 200', res.status);
        return;
      }
      const data = await res.json();
      const sev = data.by_severity || data.severity_cards || {};

      let topTool   = data.top_risky_tool;
      let topCwe    = data.top_impacted_cwe;
      let topModule = data.top_vulnerable_module;

      if (topCwe && typeof topCwe === 'object') {
        topCwe =
          topCwe.cwe_id ||
          topCwe.cwe ||
          topCwe.id ||
          topCwe.name ||
          JSON.stringify(topCwe);
      }
      if (topModule && typeof topModule === 'object') {
        topModule =
          topModule.path ||
          topModule.module ||
          topModule.id ||
          topModule.name ||
          JSON.stringify(topModule);
      }

      // 5 KPI chính
      setText('vsp-kpi-total-findings', data.total_findings, true);
      setText('vsp-kpi-score',          data.security_posture_score, true);
      setText('vsp-kpi-top-tool',       topTool, false);
      setText('vsp-kpi-top-cwe',        topCwe, false);
      setText('vsp-kpi-top-module',     topModule, false);

      // 6 severity
      setText('vsp-kpi-sev-critical', sev.CRITICAL || 0, true);
      setText('vsp-kpi-sev-high',     sev.HIGH     || 0, true);
      setText('vsp-kpi-sev-medium',   sev.MEDIUM   || 0, true);
      setText('vsp-kpi-sev-low',      sev.LOW      || 0, true);
      setText('vsp-kpi-sev-info',     sev.INFO     || 0, true);
      setText('vsp-kpi-sev-trace',    sev.TRACE    || 0, true);

      console.log('[VSP_DASH_FORCE] KPI applied', {
        total: data.total_findings,
        score: data.security_posture_score,
        topTool, topCwe, topModule,
        by_severity: sev
      });
    } catch (e) {
      console.error('[VSP_DASH_FORCE] Error loading KPI', e);
    }
  }

  function init() {
    var tries = 0;
    var t = setInterval(function () {
      var pane = document.getElementById('vsp-dashboard-main');
      if (pane) {
        clearInterval(t);
        loadKpiOnce();
      } else if (tries++ > 20) {
        clearInterval(t);
        console.warn('[VSP_DASH_FORCE] Hết retries, không thấy #vsp-dashboard-main');
      }
    }, 500);
  }

  if (document.readyState === 'complete' || document.readyState === 'interactive') {
    init();
  } else {
    document.addEventListener('DOMContentLoaded', init);
  }
})();

})();
/* ==== END: static/js/vsp_dashboard_kpi_force_any_v1.js ==== */

/* ==== BEGIN: static/js/vsp_dashboard_kpi_force_any_v2.js ==== */
(function(){
'use strict';
(function () {
  console.log('[VSP_DASH_FORCE] vsp_dashboard_kpi_force_any_v2.js loaded');

  function fmtInt(n) {
    if (n == null || isNaN(n)) return '--';
    return Number(n).toLocaleString('en-US');
  }

  function setText(id, value, isNumber) {
    var el = document.getElementById(id);
    if (!el) return;
    if (value == null || value === '') {
      el.textContent = '--';
      return;
    }
    el.textContent = isNumber ? fmtInt(value) : String(value);
  }

  async function loadKpiOnce() {
    try {
      const res = await fetch('/api/vsp/dashboard_v3');
      if (!res.ok) {
        console.warn('[VSP_DASH_FORCE] dashboard_v3 HTTP != 200', res.status);
        return;
      }
      const data = await res.json();
      const sev = data.by_severity || {};

      let topTool   = data.top_risky_tool;
      let topCwe    = data.top_impacted_cwe;
      let topModule = data.top_vulnerable_module;

      if (topCwe && typeof topCwe === 'object') {
        topCwe = topCwe.cwe_id || topCwe.cwe || topCwe.id || topCwe.name || JSON.stringify(topCwe);
      }
      if (topModule && typeof topModule === 'object') {
        topModule = topModule.path || topModule.module || topModule.id || topModule.name || JSON.stringify(topModule);
      }

      // 5 KPI chính
      setText('vsp-kpi-total-findings', data.total_findings, true);
      setText('vsp-kpi-score',          data.security_posture_score, true);
      setText('vsp-kpi-top-tool',       topTool, false);
      setText('vsp-kpi-top-cwe',        topCwe, false);
      setText('vsp-kpi-top-module',     topModule, false);

      // 6 severity
      setText('vsp-kpi-sev-critical', sev.CRITICAL || 0, true);
      setText('vsp-kpi-sev-high',     sev.HIGH     || 0, true);
      setText('vsp-kpi-sev-medium',   sev.MEDIUM   || 0, true);
      setText('vsp-kpi-sev-low',      sev.LOW      || 0, true);
      setText('vsp-kpi-sev-info',     sev.INFO     || 0, true);
      setText('vsp-kpi-sev-trace',    sev.TRACE    || 0, true);

      console.log('[VSP_DASH_FORCE] KPI applied', {
        total: data.total_findings,
        score: data.security_posture_score,
        topTool, topCwe, topModule,
        by_severity: sev
      });
    } catch (e) {
      console.error('[VSP_DASH_FORCE] Error loading KPI', e);
    }
  }

  function init() {
    // chỉ chạy khi pane dashboard đã inject
    var tries = 0;
    var t = setInterval(function () {
      var pane = document.getElementById('vsp-dashboard-main');
      if (pane) {
        clearInterval(t);
        loadKpiOnce();
      } else if (tries++ > 20) {
        clearInterval(t);
        console.warn('[VSP_DASH_FORCE] Hết retries, không thấy #vsp-dashboard-main');
      }
    }, 500);
  }

  if (document.readyState === 'complete' || document.readyState === 'interactive') {
    init();
  } else {
    document.addEventListener('DOMContentLoaded', init);
  }
})();

})();
/* ==== END: static/js/vsp_dashboard_kpi_force_any_v2.js ==== */

/* ==== BEGIN: static/js/vsp_dashboard_kpi_force_any_v3.js ==== */
(function(){
'use strict';
(function () {
  if (window.VSP_DASH_FORCE_V3_INIT) {
    console.log('[VSP_DASH_FORCE] already initialized, skip');
    return;
  }
  window.VSP_DASH_FORCE_V3_INIT = true;

  console.log('[VSP_DASH_FORCE] vsp_dashboard_kpi_force_any_v3.js loaded');

  function fmtInt(n) {
    if (n == null || isNaN(n)) return '--';
    return Number(n).toLocaleString('en-US');
  }

  function setText(id, value, isNumber) {
    var el = document.getElementById(id);
    if (!el) return;
    if (value == null || value === '') {
      el.textContent = '--';
      return;
    }
    el.textContent = isNumber ? fmtInt(value) : String(value);
  }

  async function loadKpiOnce() {
    try {
      const res = await fetch('/api/vsp/dashboard_v3');
      if (!res.ok) {
        console.warn('[VSP_DASH_FORCE] dashboard_v3 HTTP != 200', res.status);
        return;
      }
      const data = await res.json();
      const sev = data.by_severity || data.severity_cards || {};

      let topTool   = data.top_risky_tool;
      let topCwe    = data.top_impacted_cwe;
      let topModule = data.top_vulnerable_module;

      if (topCwe && typeof topCwe === 'object') {
        topCwe =
          topCwe.cwe_id ||
          topCwe.cwe ||
          topCwe.id ||
          topCwe.name ||
          JSON.stringify(topCwe);
      }
      if (topModule && typeof topModule === 'object') {
        topModule =
          topModule.path ||
          topModule.module ||
          topModule.id ||
          topModule.name ||
          JSON.stringify(topModule);
      }

      // 5 KPI chính – ĐÚNG ID HTML ANH ĐANG CÓ
      setText('vsp-kpi-total',          data.total_findings, true);
      setText('vsp-kpi-security-score', data.security_posture_score, true);
      setText('vsp-kpi-top-tool',       topTool, false);
      setText('vsp-kpi-top-cwe',        topCwe, false);
      setText('vsp-kpi-top-module',     topModule, false);

      // 6 severity – ĐÚNG ID HTML
      setText('vsp-kpi-critical', sev.CRITICAL || 0, true);
      setText('vsp-kpi-high',     sev.HIGH     || 0, true);
      setText('vsp-kpi-medium',   sev.MEDIUM   || 0, true);
      setText('vsp-kpi-low',      sev.LOW      || 0, true);
      setText('vsp-kpi-info',     sev.INFO     || 0, true);
      setText('vsp-kpi-trace',    sev.TRACE    || 0, true);

      console.log('[VSP_DASH_FORCE] KPI applied', {
        total: data.total_findings,
        score: data.security_posture_score,
        topTool,
        topCwe,
        topModule,
        by_severity: sev
      });
    } catch (e) {
      console.error('[VSP_DASH_FORCE] Error loading KPI', e);
    }
  }

  function init() {
    var tries = 0;
    var t = setInterval(function () {
      var pane = document.getElementById('vsp-dashboard-main');
      if (pane) {
        clearInterval(t);
        loadKpiOnce();
      } else if (tries++ > 20) {
        clearInterval(t);
        console.warn('[VSP_DASH_FORCE] Hết retries, không thấy #vsp-dashboard-main');
      }
    }, 500);
  }

  if (document.readyState === 'complete' || document.readyState === 'interactive') {
    init();
  } else {
    document.addEventListener('DOMContentLoaded', init);
  }
})();

})();
/* ==== END: static/js/vsp_dashboard_kpi_force_any_v3.js ==== */

/* ==== BEGIN: static/js/vsp_dashboard_kpi_v1.js ==== */
(function(){
'use strict';

function vspNormalizeTopModule(m) {
  if (!m) return 'N/A';
  if (typeof m === 'string') return m;
  try {
    if (m.label) return String(m.label);
    if (m.path) return String(m.path);
    if (m.id)   return String(m.id);
    return String(m);
  } catch (e) {
    return 'N/A';
  }
}

'use strict';

(function () {
  const LOG = '[VSP_DASHBOARD_KPI]';

  function setText(id, value) {
    const el = document.getElementById(id);
    if (!el) return;
    el.textContent = value;
  }

  function renderKpi(model) {
    if (!model) return;
    const sev =
      model.severity_cards ||
      model.summary_by_severity ||
      model.summary_all ||
      {};

    const total =
      model.total_findings ??
      model.total ??
      sev.TOTAL ??
      0;

    setText('vsp-kpi-total', total);
    setText('vsp-kpi-critical', sev.CRITICAL ?? 0);
    setText('vsp-kpi-high', sev.HIGH ?? 0);
    setText('vsp-kpi-medium', sev.MEDIUM ?? 0);
    setText('vsp-kpi-low', sev.LOW ?? 0);
    setText('vsp-kpi-info', (sev.INFO ?? 0) + (sev.TRACE ?? 0));

    if (model.security_posture_score != null) {
      setText('vsp-kpi-score-main', model.security_posture_score + '/100');
    }

    if (model.top_risky_tool) {
      setText('vsp-kpi-top-tool', model.top_risky_tool);
    }
    if (model.top_impacted_cwe) {
      setText('vsp-kpi-top-cwe', model.top_impacted_cwe);
    }
    if (model.top_vulnerable_module) {
      setText('vsp-kpi-top-module', model.top_vulnerable_module);
    }

    if (model.latest_run_id) {
      setText('vsp-last-run-span', model.latest_run_id);
    }

    // Cho Charts JS dùng chung model này
    window.VSP_DASHBOARD_MODEL = model;
    if (typeof window.vspRenderChartsFromDashboard === 'function') {
      try {
        window.vspRenderChartsFromDashboard(model);
      } catch (e) {
        console.error(LOG, 'Chart render error', e);
      }
    }
  }

  async function loadDashboard() {
    const url = '/api/vsp/dashboard_v3';
    console.log(LOG, 'Loading', url);

    try {
      const res = await fetch(url, { credentials: 'same-origin' });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const data = await res.json();
      console.log(LOG, 'Dashboard model:', data);
      renderKpi(data);
    } catch (err) {
      console.error(LOG, 'Load dashboard error:', err);
      const errBox = document.getElementById('vsp-dashboard-error');
      if (errBox) {
        errBox.textContent = 'Không tải được dashboard: ' + (err.message || err);
        errBox.style.display = 'block';
      }
    }
  }

  document.addEventListener('DOMContentLoaded', loadDashboard);
})();

})();
/* ==== END: static/js/vsp_dashboard_kpi_v1.js ==== */

/* ==== BEGIN: static/js/vsp_dashboard_live_v2.V1_baseline.js ==== */
(function(){
'use strict';
"use strict";

/**
 * VSP_DASHBOARD_LIVE_V2 – ALL-IN-ONE (datasource + fallback v1/v3)
 */

(function () {
  const API_SUMMARY      = "/api/vsp/datasource?mode=dashboard";
  const API_DS_SEV       = (sev, limit) =>
    "/api/vsp/datasource?severity=" + encodeURIComponent(sev) + "&limit=" + (limit || 1);
  const API_RUNS_V3      = "/api/vsp/runs_index_v3_v3";
  const API_RUNS_V1      = "/api/vsp/runs";
  const API_TREND_V1     = "/api/vsp/trend_v1";
  const API_SETTINGS     = "/api/vsp/settings/get";
  const API_OVERRIDES    = "/api/vsp/overrides/list";
  const API_DASHBOARD_V3 = "/api/vsp/dashboard_v3";

  const SEVERITIES = ["CRITICAL", "HIGH", "MEDIUM", "LOW", "INFO", "TRACE"];

  function $(id) {
    return document.getElementById(id);
  }

  async function fetchJson(url) {
    const res = await fetch(url, { cache: "no-store" });
    if (!res.ok) {
      const err = new Error("HTTP " + res.status + " for " + url);
      err.status = res.status;
      throw err;
    }
    return await res.json();
  }

  function safeInt(v) {
    if (v == null) return 0;
    const n = Number(v);
    return Number.isFinite(n) ? n : 0;
  }

  function escHtml(str) {
    return String(str)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;");
  }

  function setNoData(container, msg) {
    if (!container) return;
    container.innerHTML =
      '<p style="font-size:12px;color:#9ca3c7;">' + msg + "</p>";
  }

  /* ========== KPI + DONUT ========== */

  let donutChart = null;

  function renderKpisAndDonut(dash, bySev) {
    const sev = bySev || {};
    const fmt = (n) => n.toLocaleString("en-US");

    const crit  = safeInt(sev.CRITICAL);
    const high  = safeInt(sev.HIGH);
    const med   = safeInt(sev.MEDIUM);
    const low   = safeInt(sev.LOW);
    const info  = safeInt(sev.INFO);
    const trace = safeInt(sev.TRACE);

    const totalFromSev = crit + high + med + low + info + trace;
    const total =
      safeInt(dash.total_findings) ||
      safeInt(dash.total) ||
      totalFromSev;

    const elTotal = $("kpi-total-findings");
    if (elTotal) elTotal.textContent = fmt(total);

    const elCrit = $("kpi-critical");
    if (elCrit) elCrit.textContent = fmt(crit);

    const elHigh = $("kpi-high");
    if (elHigh) elHigh.textContent = fmt(high);

    const elMed = $("kpi-medium");
    if (elMed) elMed.textContent = fmt(med);

    const elLow = $("kpi-low");
    if (elLow) elLow.textContent = fmt(low);

    const elInfoTrace = $("kpi-info-trace");
    if (elInfoTrace) elInfoTrace.textContent = fmt(info + trace);

    const lastRunId = $("vsp-last-run-id");
    if (lastRunId) lastRunId.textContent = dash.run_id || "–";

    const lastRunTs = $("vsp-last-run-ts");
    if (lastRunTs) {
      const ts = dash.ts || dash.last_run_ts || dash.last_ts;
      lastRunTs.textContent = ts ? ts : "Last run: –";
    }

    // Donut
    const canvas = $("severity_donut_chart");
    if (canvas && typeof Chart !== "undefined") {
      if (donutChart) donutChart.destroy();
      donutChart = new Chart(canvas, {
        type: "doughnut",
        data: {
          labels: ["CRITICAL", "HIGH", "MEDIUM", "LOW", "INFO", "TRACE"],
          datasets: [
            {
              data: [crit, high, med, low, info, trace],
              backgroundColor: [
                "#ff4b6a",
                "#ff9f43",
                "#ffd166",
                "#4ade80",
                "#38bdf8",
                "#a855f7",
              ],
              borderWidth: 0,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: "70%",
          plugins: { legend: { display: false } },
        },
      });
    }

    // fallback trend 1 điểm, sẽ bị override nếu initTrend() load được nhiều điểm
    renderTrend([{ label: dash.run_id || "Last run", total }]);
  }

  async function computeSeverityBucketsFromDatasource() {
    const buckets = {
      CRITICAL: 0,
      HIGH: 0,
      MEDIUM: 0,
      LOW: 0,
      INFO: 0,
      TRACE: 0,
    };

    const promises = SEVERITIES.map(async (sev) => {
      try {
        const resp = await fetchJson(API_DS_SEV(sev, 1));
        const total = safeInt(resp.total || resp.total_findings || resp.count);
        buckets[sev] = total;
      } catch (err) {
        console.warn("[VSP] severity", sev, "error:", err);
      }
    });

    await Promise.all(promises);
    return buckets;
  }

  /* ========== TREND ========== */

  let trendChart = null;

  function renderTrend(points) {
    const canvas = $("trend_line_chart");
    if (!canvas || typeof Chart === "undefined") return;
    if (!Array.isArray(points) || !points.length) return;

    const labels = points.map((p) => p.label || "");
    const totals = points.map((p) => safeInt(p.total || p.total_findings));

    // Destroy mọi chart đang gắn với canvas này (kể cả không lưu trong trendChart)
    if (typeof Chart.getChart === "function") {
      try {
        const existing = Chart.getChart(canvas);
        if (existing) existing.destroy();
      } catch (e) {
        console.warn("[VSP][TREND] Chart.getChart destroy error:", e);
      }
    }

    if (trendChart) {
      try {
        trendChart.destroy();
      } catch (e) {
        console.warn("[VSP][TREND] trendChart.destroy error:", e);
      }
      trendChart = null;
    }

    trendChart = new Chart(canvas, {
      type: "line",
      data: {
        labels,
        datasets: [
          {
            label: "Total findings",
            data: totals,
            tension: 0.35,
            borderWidth: 2,
            pointRadius: 3,
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          x: {
            ticks: { maxRotation: 45, minRotation: 45 },
            grid: { display: false },
          },
          y: {
            beginAtZero: true,
            grid: { color: "rgba(148,163,210,0.25)" },
          },
        },
      },
    });
  }

  async function initTrend() {
    // 1) trend_v1 nếu có
    try {
      const t = await fetchJson(API_TREND_V1);
      const pts = Array.isArray(t.points) ? t.points : [];
      if (pts.length) {
        renderTrend(pts);
        return;
      }
    } catch (e) {
      console.warn("[VSP] trend_v1 error:", e);
    }

    // 2) runs_index_v3 nếu có
    try {
      const runs = await fetchJson(API_RUNS_V3);
      if (Array.isArray(runs) && runs.length) {
        const pts = runs
          .slice(0, 10)
          .map((r) => ({
            label: r.run_id || "",
            total: r.total_findings || r.total || 0,
          }))
          .reverse();
        renderTrend(pts);
        return;
      }
    } catch (e) {
      console.warn("[VSP] runs_index_v3 error (trend):", e);
    }
    // fallback = 1 điểm đã vẽ sẵn bởi renderKpisAndDonut
  }

      /* ========== TOP CWE BAR ========== */

  let topCweChart = null;

  function ensureTopCweCanvas() {
    let canvas = $("top_cwe_chart");
    if (canvas) return canvas;

    const table = document.querySelector("#top-cwe-table");
    if (table) {
      table.style.display = "none";
      const parent = table.parentElement || table.parentNode || table;
      canvas = document.createElement("canvas");
      canvas.id = "top_cwe_chart";
      canvas.style.width = "100%";
      canvas.style.height = "210px";
      parent.appendChild(canvas);
      return canvas;
    }
    return null;
  }

  function renderTopCweBarFromInsights(items) {
    const canvas = ensureTopCweCanvas();
    if (!canvas || typeof Chart === "undefined") return;

    const arr = Array.isArray(items) ? items : [];
    if (!arr.length) {
      console.debug("[VSP] renderTopCweBarFromInsights: empty items");
      return;
    }

    const labels = arr.map((it) => it.cwe || "UNKNOWN");
    const totals = arr.map((it) => safeInt(it.count || 0));

    if (topCweChart) {
      topCweChart.destroy();
    }

    topCweChart = new Chart(canvas, {
      type: "bar",
      data: {
        labels,
        datasets: [
          {
            label: "Findings",
            data: totals,
            borderWidth: 1,
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: (ctx) => {
                const v = ctx.parsed.y || 0;
                return `  ${v} findings`;
              },
            },
          },
        },
        scales: {
          x: {
            grid: { display: false },
            ticks: { maxRotation: 45, minRotation: 45 },
          },
          y: {
            beginAtZero: true,
            grid: { color: "rgba(148,163,210,0.25)" },
          },
        },
      },
    });
  }

  async function initTopCweFromInsights() {
    try {
      const data = await fetchJson(API_TOP_CWE_V1);
      if (!data || data.ok === false) {
        console.warn("[VSP] TOPCWE – insights ok=false hoặc data rỗng", data && data.error);
        return;
      }
      const items = Array.isArray(data.items) ? data.items : [];
      if (!items.length) {
        console.warn("[VSP] TOPCWE – empty items from insights");
        return;
      }
      renderTopCweBarFromInsights(items);
    } catch (e) {
      console.warn("[VSP] TOPCWE – insights fetch error:", e);
    }
  }

  // Giữ hàm initTopCwe cũ để loadAll() vẫn gọi được,
  // nhưng bên trong chỉ còn gọi insights.
  async function initTopCwe(summary) {  // summary không dùng nữa
    await initTopCweFromInsights();
  }

/* ========== TOP FINDINGS ========== */

  async function initTopFindings() {
    const tbody = document.querySelector("#top-findings-table tbody");
    if (!tbody) return;

    try {
      const resp = await fetchJson(API_DS_SEV("CRITICAL", 5));
      const items = Array.isArray(resp.items) ? resp.items : [];
      if (!items.length) {
        tbody.innerHTML =
          '<tr><td colspan="10" style="color:#9ca3c7;font-size:11px;">Không load được dữ liệu top findings.</td></tr>';
        return;
      }

      const rows = items
        .map((it) => {
          const sev =
            '<span class="vsp-severity-badge vsp-severity-critical">CRITICAL</span>';
          const loc = it.location || it.file || it.path || "";
          const rule = it.rule || it.rule_id || it.cwe || "";
          const tool = it.tool || it.source || "";
          return (
            "<tr>" +
            "<td>" + sev + "</td>" +
            "<td>" + escHtml(loc) + "</td>" +
            "<td>" + escHtml(rule) + "</td>" +
            "<td>" + escHtml(tool) + "</td>" +
            "</tr>"
          );
        })
        .join("");

      tbody.innerHTML = rows;
    } catch (e) {
      console.warn("[VSP] initTopFindings error:", e);
      tbody.innerHTML =
        '<tr><td colspan="10" style="color:#9ca3c7;font-size:11px;">Không load được dữ liệu top findings.</td></tr>';
    }
  }

  /* ========== RUNS TAB ========== */

  function renderRunsTable(runs) {
    const container = $("vsp-runs-container");
    if (!container) return;

    if (!Array.isArray(runs) || !runs.length) {
      setNoData(container, "Không load được dữ liệu runs.");
      return;
    }

    const rows = runs
      .slice(0, 20)
      .map((r) => {
        const sev = r.by_severity || r.severity || {};
        return (
          "<tr>" +
          "<td>" + escHtml(r.run_id || r.id || "") + "</td>" +
          "<td>" + safeInt(r.total_findings || r.total) + "</td>" +
          "<td>" + safeInt(sev.CRITICAL) + "</td>" +
          "<td>" + safeInt(sev.HIGH) + "</td>" +
          "<td>" + safeInt(sev.MEDIUM) + "</td>" +
          "<td>" + safeInt(sev.LOW) + "</td>" +
          "</tr>"
        );
      })
      .join("");

    container.innerHTML =
      '<table class="vsp-table">' +
      "<thead><tr>" +
      "<th>Run ID</th>" +
      "<th>Total</th>" +
      "<th>CRI</th>" +
      "<th>HIGH</th>" +
      "<th>MED</th>" +
      "<th>LOW</th>" +
      "</tr></thead>" +
      "<tbody>" + rows + "</tbody></table>";
  }

  async function initRunsTab() {
    const container = $("vsp-runs-container");
    if (!container) return;

    // ưu tiên v3, fallback v1
    try {
      const runs = await fetchJson(API_RUNS_V3);
      renderRunsTable(runs);
      return;
    } catch (e) {
      console.warn("[VSP] runs_index_v3 error (tab):", e);
    }

    try {
      const runs = await fetchJson(API_RUNS_V1);
      renderRunsTable(runs);
    } catch (e) {
      console.warn("[VSP] /api/vsp/runs (v1) error:", e);
      setNoData(
        container,
        "Không load được dữ liệu runs (API /api/vsp/runs_index_v3_v3 và /api/vsp/runs đều chưa sẵn sàng)."
      );
    }
  }

  /* ========== DATA SOURCE TAB ========== */

  async function initDatasourceTab(summary, bySevComputed) {
    const container = $("vsp-datasource-container");
    if (!container) return;

    try {
      const sev =
        bySevComputed ||
        summary.by_severity ||
        summary.severity ||
        summary.by_severity_buckets ||
        {};

      let byTool =
        summary.by_tool ||
        summary.by_tool_severity ||
        summary.by_tools ||
        summary.tools ||
        {};

      // nếu datasource không có by_tool – thử lấy từ dashboard_v3
      if (!Object.keys(byTool).length) {
        try {
          const dash = await fetchJson(API_DASHBOARD_V3);
          byTool = dash.by_tool || {};
        } catch (e) {
          console.warn("[VSP] dashboard_v3 by_tool fallback error:", e);
        }
      }

      const sevRows = SEVERITIES.map((s) => {
        return (
          "<tr><td>" +
          s +
          "</td><td>" +
          safeInt(sev[s]) +
          "</td></tr>"
        );
      }).join("");

      const toolKeys = Object.keys(byTool || {});
      const toolRows = toolKeys
        .sort()
        .map((tool) => {
          const raw = byTool[tool] || {};
          const d = raw.by_severity || raw.severity || raw;
          return (
            "<tr>" +
            "<td>" + escHtml(tool) + "</td>" +
            "<td>" + safeInt(d.CRITICAL) + "</td>" +
            "<td>" + safeInt(d.HIGH) + "</td>" +
            "<td>" + safeInt(d.MEDIUM) + "</td>" +
            "<td>" + safeInt(d.LOW) + "</td>" +
            "</tr>"
          );
        })
        .join("");

      const rightTable =
        toolKeys.length === 0
          ? "<p style='font-size:12px;color:#9ca3c7;'>Không có dữ liệu theo tool.</p>"
          : '<table class="vsp-table">' +
            "<thead><tr><th>Tool</th><th>CRI</th><th>HIGH</th><th>MED</th><th>LOW</th></tr></thead>" +
            "<tbody>" + toolRows + "</tbody></table>";

      container.innerHTML =
        '<div style="display:grid;grid-template-columns:35% 65%;gap:12px;">' +
        '<div>' +
        '<h3 style="margin:0 0 6px;font-size:13px;">Tổng quan theo mức độ</h3>' +
        '<table class="vsp-table">' +
        "<thead><tr><th>Severity</th><th>Count</th></tr></thead>" +
        "<tbody>" + sevRows + "</tbody></table>" +
        "</div>" +
        '<div>' +
        '<h3 style="margin:0 0 6px;font-size:13px;">Theo tool</h3>' +
        rightTable +
        "</div>" +
        "</div>";
    } catch (e) {
      console.warn("[VSP] initDatasourceTab error:", e);
      setNoData(
        container,
        "Không load được datasource (API /api/vsp/datasource?mode=dashboard chưa sẵn sàng)."
      );
    }
  }

  /* ========== SETTINGS TAB ========== */

  async function initSettingsTab() {
    const container = $("vsp-settings-container");
    if (!container) return;

    try {
      const cfg = await fetchJson(API_SETTINGS);
      container.innerHTML =
        "<h3 style='margin:0 0 6px;font-size:13px;'>Cấu hình VSP EXT+ (đọc từ API)</h3>" +
        "<pre style='font-size:11px;white-space:pre-wrap;border-radius:8px;background:#020617;padding:8px;border:1px solid rgba(148,163,210,0.35);'>" +
        escHtml(JSON.stringify(cfg, null, 2)) +
        "</pre>";
    } catch (e) {
      console.warn("[VSP] initSettingsTab error:", e);
      setNoData(
        container,
        "Không load được cấu hình (API /api/vsp/settings/get chưa sẵn sàng)."
      );
    }
  }

  /* ========== RULE OVERRIDES TAB ========== */

  async function initOverridesTab() {
    const container = $("vsp-overrides-container");
    if (!container) return;

    try {
      const resp = await fetchJson(API_OVERRIDES);
      const raw = Array.isArray(resp.items) ? resp.items : resp;
      let list;

      if (Array.isArray(raw)) {
        list = raw;
      } else if (raw && typeof raw === "object") {
        list = Object.keys(raw).map((k) => raw[k]);
      } else {
        throw new Error("invalid overrides format");
      }

      const rows = list
        .map((it) => {
          return (
            "<tr>" +
            "<td>" + escHtml(it.id || it.name || "") + "</td>" +
            "<td>" + escHtml(it.pattern || it.rule || "") + "</td>" +
            "<td>" + escHtml(it.reason || "") + "</td>" +
            "</tr>"
          );
        })
        .join("");

      container.innerHTML =
        "<h3 style='margin:0 0 6px;font-size:13px;'>Rule overrides</h3>" +
        '<table class="vsp-table">' +
        "<thead><tr><th>ID</th><th>Pattern / Rule</th><th>Reason</th></tr></thead>" +
        "<tbody>" + rows + "</tbody></table>";
    } catch (e) {
      console.warn("[VSP] initOverridesTab error:", e);
      setNoData(
        container,
        "Không load được danh sách override (API /api/vsp/overrides/list chưa sẵn sàng)."
      );
    }
  }

  /* ========== MAIN LOAD ========== */

  async function loadAll() {
    try {
      const resp = await fetchJson(API_SUMMARY);
      const summary = resp.summary || resp;

      const dash = {
        run_id: resp.run_id || summary.run_id,
        ts: resp.ts || summary.ts,
        total_findings:
          summary.total_findings ||
          summary.total ||
          summary.total_findings_unified,
      };

      const bySev = await computeSeverityBucketsFromDatasource();

      renderKpisAndDonut(dash, bySev);
      await initTrend();
      renderTopCweBar(summary);
      await initTopFindings();

      await initRunsTab();
      await initDatasourceTab(summary, bySev);
      await initSettingsTab();
      await initOverridesTab();
    } catch (e) {
      console.error("[VSP] loadAll error:", e);
    }
  }

  window.VSP_DASHBOARD_LIVE_V2_INIT = function () {
    loadAll().catch((err) => console.error("[VSP] loadAll outer error:", err));
  };
})();



/* ========== TOP CWE FROM INSIGHTS V1 ========== */

function renderTopCweBarFromInsights(items) {
  const canvas = ensureTopCweCanvas();
  if (!canvas || typeof Chart === "undefined") return;

  const arr = Array.isArray(items) ? items : [];
  if (!arr.length) {
    console.debug("[VSP] renderTopCweBarFromInsights: empty items");
    return;
  }

  const labels = arr.map((it) => it.cwe || "UNKNOWN");
  const totals = arr.map((it) => safeInt(it.count || 0));

  if (topCweChart) {
    try {
      topCweChart.destroy();
    } catch (e) {
      console.warn("[VSP] destroy topCweChart error:", e);
    }
  }

  topCweChart = new Chart(canvas, {
    type: "bar",
    data: {
      labels,
      datasets: [
        {
          label: "Findings",
          data: totals,
          borderWidth: 1,
          // Màu để Chart.js tự chọn, UI theme đã lo phần nền
        }
      ],
    },
    options: {
      indexAxis: "y",
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
      },
      scales: {
        x: {
          beginAtZero: true,
          grid: { color: "rgba(148,163,210,0.25)" },
        },
        y: {
          ticks: { autoSkip: false },
          grid: { display: false },
        },
      },
    },
  });
}

async function initTopCweFromInsights() {
  if (typeof API_TOP_CWE_V1 === "undefined") {
    console.warn("[VSP] API_TOP_CWE_V1 not defined – skip Top CWE chart.");
    return;
  }
  try {
    const data = await fetchJson(API_TOP_CWE_V1 + "?limit=5");
    const items = data && Array.isArray(data.items) ? data.items : [];
    if (!items.length) {
      console.warn("[VSP] top_cwe_v1: no items");
      return;
    }
    renderTopCweBarFromInsights(items);
  } catch (e) {
    console.warn("[VSP] top_cwe_v1 error:", e);
  }
}

// ======================= TOP_CWE_PATCH_V3 =======================
// Bind TOP CWE từ /api/vsp/dashboard_v3 (hoặc window.__vspTopCweInit)
(function () {
  function bindTopCwe(payload) {
    try {
      if (!payload) {
        console.warn("[VSP][TOP_CWE] Không có payload");
        return;
      }

      // Hỗ trợ 2 dạng:
      // 1) { run_id, top_cwe: [...] }
      // 2) { ok, payload: { run_id, top_cwe: [...] } }
      var topList = null;

      if (Array.isArray(payload.top_cwe)) {
        topList = payload.top_cwe;
      } else if (payload.payload && Array.isArray(payload.payload.top_cwe)) {
        topList = payload.payload.top_cwe;
      }

      if (!topList || !topList.length) {
        console.warn("[VSP][TOP_CWE] Không có top_cwe trong payload");
        return;
      }

      var top = topList[0] || {};
      var label = top.id || "N/A";
      var count = (top.count != null) ? top.count : 0;

      var labelNodes = document.querySelectorAll("[data-vsp-topcwe-label]");
      for (var i = 0; i < labelNodes.length; i++) {
        labelNodes[i].textContent = label;
      }

      var countNodes = document.querySelectorAll("[data-vsp-topcwe-count]");
      for (var j = 0; j < countNodes.length; j++) {
        countNodes[j].textContent = String(count);
      }

      console.log("[VSP][TOP_CWE] Bound TOP CWE =", label, "count =", count);
    } catch (err) {
      console.error("[VSP][TOP_CWE] bindTopCwe error:", err);
    }
  }

  // expose global để chỗ khác gọi được
  window.__vspBindTopCwe = bindTopCwe;

  function initTopCweFromInsights() {
    try {
      if (window.__vspTopCweInit) {
        console.log("[VSP][TOP_CWE] Dùng window.__vspTopCweInit");
        bindTopCwe(window.__vspTopCweInit);
        return;
      }

      fetch("/api/vsp/dashboard_v3")
        .then(function (res) {
          if (!res.ok) {
            throw new Error("HTTP " + res.status);
          }
          return res.json();
        })
        .then(function (data) {
          console.log("[VSP][TOP_CWE] Nhận data từ /api/vsp/dashboard_v3", data);
          bindTopCwe(data);
        })
        .catch(function (err) {
          console.error("[VSP][TOP_CWE] Fetch /api/vsp/dashboard_v3 lỗi:", err);
        });
    } catch (err) {
      console.error("[VSP][TOP_CWE] initTopCweFromInsights error:", err);
    }
  }

  // cũng expose global nếu muốn gọi tay
  window.initTopCweFromInsights = initTopCweFromInsights;

  document.addEventListener("DOMContentLoaded", function () {
    try {
      initTopCweFromInsights();
    } catch (err) {
      console.error("[VSP][TOP_CWE] DOMContentLoaded hook error:", err);
    }
  });
})();

// ======================= VSP_ADVANCED_KPI_V1 =======================
// Bind 4 advanced KPI vào layout CIO-level:
// - Security Posture Score (0–100)
// - Top risky tool
// - Top impacted CWE  (lấy thẳng từ top_cwe[0].id)
// - Top vulnerable module

function vspBindAdvancedKpis(dash) {
  try {
    if (!dash) {
      console.warn("[VSP][ADV_KPI] Không có dashboard data để bind.");
      return;
    }

    // 1) Security Posture Score
    var scoreEl = document.querySelector("[data-vsp-kpi-posture-score]");
    if (scoreEl) {
      var score = null;
      if (typeof dash.security_posture_score === "number") {
        score = dash.security_posture_score;
      } else if (dash.security_posture && typeof dash.security_posture.score === "number") {
        score = dash.security_posture.score;
      }
      if (typeof score === "number") {
        scoreEl.textContent = String(score);
      } else {
        scoreEl.textContent = "0";
      }
    }

    // 2) Top risky tool
    var riskyEl = document.querySelector("[data-vsp-kpi-top-risky-tool]");
    if (riskyEl) {
      var risky = dash.top_risky_tool
        || (dash.security_posture && dash.security_posture.top_risky_tool)
        || null;
      if (risky && typeof risky.tool === "string") {
        riskyEl.textContent = risky.tool.toUpperCase();
      } else if (typeof risky === "string") {
        riskyEl.textContent = risky.toUpperCase();
      } else {
        riskyEl.textContent = "–";
      }
    }

    // 3) Top impacted CWE – luôn ưu tiên từ top_cwe[0].id
    var cweEl = document.querySelector("[data-vsp-kpi-top-cwe]");
    if (cweEl) {
      var hiId = null;
      if (Array.isArray(dash.top_cwe) && dash.top_cwe.length && typeof dash.top_cwe[0].id === "string") {
        hiId = dash.top_cwe[0].id;
      } else if (typeof dash.highest_impacted_cwe === "string") {
        hiId = dash.highest_impacted_cwe;
      } else if (dash.highest_impacted_cwe && typeof dash.highest_impacted_cwe.id === "string") {
        hiId = dash.highest_impacted_cwe.id;
      }
      cweEl.textContent = hiId || "–";
    }

    // 4) Top vulnerable module
    var modEl = document.querySelector("[data-vsp-kpi-top-module]");
    if (modEl) {
      var mod = dash.top_vulnerable_module
        || (dash.security_posture && dash.security_posture.top_vulnerable_module)
        || null;
      if (mod && typeof mod.name === "string") {
        modEl.textContent = mod.name;
      } else if (typeof mod === "string") {
        modEl.textContent = mod;
      } else {
        modEl.textContent = "–";
      }
    }

    console.log("[VSP][ADV_KPI] Bound advanced KPIs (CWE từ top_cwe[0].id).");
  } catch (err) {
    console.error("[VSP][ADV_KPI] bind error:", err);
  }
}

})();
/* ==== END: static/js/vsp_dashboard_live_v2.V1_baseline.js ==== */

/* ==== BEGIN: static/js/vsp_dashboard_live_v2.js ==== */
(function(){
'use strict';
/* VSP_DASHBOARD_LIVE_V2 STUB (COMMERCIAL P0) */
(function(){
  'use strict';
  try{
    // Keep API surface so older code won't crash
    window.VSP_DASHBOARD_LIVE_V2 = window.VSP_DASHBOARD_LIVE_V2 || function(){ return true; };
  }catch(_){}
})();

})();
/* ==== END: static/js/vsp_dashboard_live_v2.js ==== */

/* ==== BEGIN: static/js/vsp_dashboard_tables_live_v1.js ==== */
(function(){
'use strict';
(function () {
  'use strict';

  const API_TABLES       = '/api/vsp/dashboard_v3_tables';
  const API_TOP_FINDINGS = '/api/vsp/datasource?severity=HIGH&limit=10';

  function findTbodyByTitle(titleText) {
    var all = document.querySelectorAll('*');
    var titleEl = null;

    for (var i = 0; i < all.length; i++) {
      var txt = (all[i].textContent || '').trim();
      if (txt === titleText) {
        titleEl = all[i];
        break;
      }
    }
    if (!titleEl) return null;

    var card = titleEl;
    for (var depth = 0; depth < 6 && card; depth++) {
      var tbody = card.querySelector('tbody');
      if (tbody) return tbody;
      card = card.parentElement;
    }
    return null;
  }

  // -------- Top Findings (chi tiết từ datasource HIGH) ----------
  function renderTopFindings(items) {
    var tbody = findTbodyByTitle('Top Findings');
    if (!tbody) return;

    tbody.innerHTML = '';

    if (!Array.isArray(items) || items.length === 0) {
      var tr = document.createElement('tr');
      var td = document.createElement('td');
      td.colSpan = 5;
      td.textContent = 'No data from latest FULL EXT run.';
      tr.appendChild(td);
      tbody.appendChild(tr);
      return;
    }

    items.forEach(function (f) {
      var tr = document.createElement('tr');

      var sev  = (f.severity || f.sev || '').toString().toUpperCase();
      var tool = f.tool || f.source || '';
      var rule = f.rule_id || f.rule || f.check_id || '';
      var file = f.file || f.path || f.relpath || '';
      var msg  = f.message || f.detail || f.title || '';

      function cell(text) {
        var td = document.createElement('td');
        td.textContent = text;
        tr.appendChild(td);
      }

      cell(sev);
      cell(tool);
      cell(rule);
      cell(file);
      cell(msg);

      tbody.appendChild(tr);
    });
  }

  function loadTopFindings() {
    fetch(API_TOP_FINDINGS)
      .then(function (r) { return r.json(); })
      .then(function (data) {
        if (!data || data.ok === false) {
          console.warn('[VSP][TABLE] datasource HIGH not ok:', data);
          return;
        }
        renderTopFindings(data.items || []);
      })
      .catch(function (err) {
        console.error('[VSP][TABLE] fetch Top Findings error:', err);
      });
  }

  // -------- Top CVE / CWE ----------
  function renderTopCve(list) {
    var tbody = findTbodyByTitle('Top CVE');
    if (!tbody) return;

    tbody.innerHTML = '';

    if (!Array.isArray(list) || list.length === 0) {
      var tr = document.createElement('tr');
      var td = document.createElement('td');
      td.colSpan = 2;
      td.textContent = 'No data from latest FULL EXT run.';
      tr.appendChild(td);
      tbody.appendChild(tr);
      return;
    }

    list.forEach(function (row) {
      var tr = document.createElement('tr');

      var id = row.cve || row.cwe || row.id || '-';
      var count = row.count || 0;

      var td1 = document.createElement('td');
      td1.textContent = id;
      tr.appendChild(td1);

      var td2 = document.createElement('td');
      td2.textContent = String(count);
      tr.appendChild(td2);

      tbody.appendChild(tr);
    });
  }

  // -------- Top Modules ----------
  function renderTopModules(list, topDirs) {
    var tbody = findTbodyByTitle('Top Modules');
    if (!tbody) return;

    tbody.innerHTML = '';

    // Nếu BE chưa có summary.top_modules → tự build từ top_dirs
    if (!Array.isArray(list) || list.length === 0) {
      list = [];
      if (Array.isArray(topDirs)) {
        topDirs.forEach(function (d) {
          list.push({
            name: d.path || '',
            total: d.total || 0,
            crit_high: (d.CRIT || 0) + (d.HIGH || 0)
          });
        });
      }
    }

    if (!Array.isArray(list) || list.length === 0) {
      var tr = document.createElement('tr');
      var td = document.createElement('td');
      td.colSpan = 3;
      td.textContent = 'No data from latest FULL EXT run.';
      tr.appendChild(td);
      tbody.appendChild(tr);
      return;
    }

    list.forEach(function (row) {
      var tr = document.createElement('tr');

      var name = row.name || row.module || row.package || '-';
      var total = row.total || 0;
      var ch = row.crit_high || row.CRIT_HIGH || 0;

      function cell(text) {
        var td = document.createElement('td');
        td.textContent = String(text);
        tr.appendChild(td);
      }

      cell(name);
      cell(total);
      cell(ch);

      tbody.appendChild(tr);
    });
  }

  function loadTables() {
    fetch(API_TABLES)
      .then(function (r) { return r.json(); })
      .then(function (data) {
        if (!data || data.ok === false) {
          console.warn('[VSP][TABLE] /api/vsp/dashboard_v3_tables not ok:', data);
          return;
        }
        var topCweList = data.top_cve_list || data.top_cwe_list || [];
        var topModules = data.top_modules || [];
        var topDirs    = data.top_dirs || [];

        renderTopCve(topCweList);
        renderTopModules(topModules, topDirs);
      })
      .catch(function (err) {
        console.error('[VSP][TABLE] fetch dashboard_tables error:', err);
      });
  }

  document.addEventListener('DOMContentLoaded', function () {
    loadTopFindings();
    loadTables();
  });
})();

})();
/* ==== END: static/js/vsp_dashboard_tables_live_v1.js ==== */

/* ==== BEGIN: static/js/vsp_dashboard_top_module_dom_v1.js ==== */
(function(){
'use strict';
(function () {
  const LOG_PREFIX = "[VSP_TOP_MODULE_DOM]";

  function cleanupOnce() {
    try {
      const root = document.querySelector("#vsp-root") || document;
      if (!root) return;

      // Tìm phần tử có text "Top vulnerable module"
      const all = Array.from(root.querySelectorAll("*"));
      const labelEls = all.filter((el) => {
        if (!el || !el.textContent) return false;
        return el.textContent.trim() === "Top vulnerable module";
      });

      if (!labelEls.length) return;

      labelEls.forEach((labelEl) => {
        let valueEl = labelEl.nextElementSibling;
        if (!valueEl) {
          // thử tìm trong cùng block
          const parent = labelEl.parentElement;
          if (!parent) return;
          const candidates = Array.from(parent.children).filter((c) => c !== labelEl);
          valueEl = candidates[0] || null;
        }
        if (!valueEl) return;

        const raw = (valueEl.textContent || "").trim();
        if (!raw) return;

        let textOut = raw;

        // Nếu là JSON thì parse -> label/path/id
        try {
          const parsed = JSON.parse(raw);
          if (parsed && typeof parsed === "object") {
            textOut =
              parsed.label ||
              parsed.path ||
              parsed.id ||
              raw;
          }
        } catch (e) {
          // không phải JSON thì giữ nguyên
        }

        if (textOut && textOut.length > 80) {
          textOut = textOut.slice(0, 77) + "...";
        }

        if (textOut && textOut !== raw) {
          console.log(LOG_PREFIX, "Normalize top module:", raw, "=>", textOut);
          valueEl.textContent = textOut;
        }
      });
    } catch (err) {
      console.error(LOG_PREFIX, "cleanup error:", err);
    }
  }

  function startWatcher() {
    let tries = 0;
    const maxTries = 30; // ~15s nếu 500ms/lần

    const timer = setInterval(() => {
      tries += 1;
      cleanupOnce();
      if (tries >= maxTries) {
        clearInterval(timer);
      }
    }, 500);
  }

  // Chạy khi load xong
  if (document.readyState === "complete" || document.readyState === "interactive") {
    startWatcher();
  } else {
    window.addEventListener("DOMContentLoaded", startWatcher);
  }

  // Nếu dashboard có trigger event custom thì cũng bắt thêm
  window.addEventListener("vspDashboardV3Rendered", function () {
    console.log(LOG_PREFIX, "Received vspDashboardV3Rendered event");
    cleanupOnce();
  });
})();

})();
/* ==== END: static/js/vsp_dashboard_top_module_dom_v1.js ==== */

/* ==== BEGIN: static/js/vsp_dast_history_v1.js ==== */
(function(){
'use strict';
(function () {
  console.log("[VSP_DAST] vsp_dast_history_v1.js loaded");
  const tableBody = document.getElementById("vsp-dast-history-body");

  async function loadHistory() {
    if (!tableBody) return;
    try {
      const resp = await fetch("/api/vsp/dast/history");
      const data = await resp.json();
      if (!data.ok) {
        console.warn("[VSP_DAST] history not ok", data);
        return;
      }
      tableBody.innerHTML = "";
      data.items.forEach(item => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${item.run_id}</td>
          <td>${item.url}</td>
          <td>${item.engine}</td>
          <td>${item.status}</td>
          <td>${item.created_at || ""}</td>
        `;
        tableBody.appendChild(tr);
      });
    } catch (err) {
      console.error("[VSP_DAST] loadHistory error", err);
    }
  }

  document.addEventListener("DOMContentLoaded", loadHistory);
})();

})();
/* ==== END: static/js/vsp_dast_history_v1.js ==== */

/* ==== BEGIN: static/js/vsp_drilldown_artifacts_impl_commercial_v1.js ==== */
(function(){
'use strict';
/* VSP_DRILLDOWN_ARTIFACTS_IMPL_COMMERCIAL_V1
   Goal: VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 is ALWAYS callable (even if someone sets object).
   Behavior: navigate to Data Source tab and pass drilldown intent (rid + optional filters). */
(function(){
  'use strict';
  if (window.__VSP_DRILLDOWN_ART_IMPL_COMMERCIAL_V1__) return;
  window.__VSP_DRILLDOWN_ART_IMPL_COMMERCIAL_V1__ = 1;

  var _impl = null;

  function _emitIntent(intent){
    try{
      // store intent for datasource tab to pick up
      window.__VSP_DRILLDOWN_INTENT__ = intent;
      try{ localStorage.setItem('vsp_drilldown_intent_v1', JSON.stringify(intent)); }catch(_){}
      window.dispatchEvent(new CustomEvent('vsp:drilldown', { detail: intent }));
    }catch(_){}
  }

  function _gotoDataSource(){
    try{
      // prefer router if exists
      if (window.location.hash !== '#datasource'){
        window.location.hash = '#datasource';
      }
    }catch(_){}
  }

  function _safeInvoke(impl, args){
    try{
      if (typeof impl === 'function') return impl.apply(null, args);
      if (impl && typeof impl.open === 'function') return impl.open.apply(impl, args);
      if (impl && typeof impl.run === 'function') return impl.run.apply(impl, args);
      if (impl && typeof impl.invoke === 'function') return impl.invoke.apply(impl, args);
    }catch(e){
      try{ console.warn('[VSP][DD] invoke failed', e); }catch(_){}
    }
    return null;
  }

  // exported callable used by dashboard/runs
  function exported(opts){
    // opts can be (rid) or ({rid, kind, severity, cwe, tool, ...})
    var intent = {};
    try{
      if (typeof opts === 'string') intent.rid = opts;
      else if (opts && typeof opts === 'object') intent = opts;
      // auto-fill rid from global state if missing
      if (!intent.rid){
        intent.rid = (window.__VSP_RID_STATE__ && window.__VSP_RID_STATE__.rid) || window.__VSP_RID || null;
      }
      intent.ts = Date.now();
      intent.kind = intent.kind || 'artifacts';
    }catch(_){}

    // If there is a real impl, call it. Otherwise do commercial fallback navigation.
    var r = _safeInvoke(_impl, arguments);
    if (r !== null) return r;

    _emitIntent(intent);
    _gotoDataSource();

    // if datasource exposes an API, call it
    try{
      if (typeof window.VSP_DATASOURCE_APPLY_DRILLDOWN_V1 === 'function'){
        return window.VSP_DATASOURCE_APPLY_DRILLDOWN_V1(intent);
      }
    }catch(_){}
    return null;
  }

  // Force window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 to be callable forever.
  function install(){
    try{
      // capture current value if any
      if (window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 && window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 !== exported){
        _impl = window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2;
      }
      Object.defineProperty(window, 'VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2', {
        configurable: true,
        enumerable: true,
        get: function(){ return exported; },
        set: function(v){
          _impl = v;
          try{ console.log('[VSP][DD] accepted real impl'); }catch(_){}
        }
      });
    }catch(e){
      // fallback (still callable)
      _impl = window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2;
      window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 = exported;
    }
  }

  install();

  // re-assert callable (some old scripts may clobber)
  setInterval(function(){
    try{
      if (window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 !== exported){
        _impl = window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2;
        window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 = exported;
      }
    }catch(_){}
  }, 800);
})();

})();
/* ==== END: static/js/vsp_drilldown_artifacts_impl_commercial_v1.js ==== */

/* ==== BEGIN: static/js/vsp_drilldown_stub_safe_v1.js ==== */
(function(){
'use strict';
/* VSP_DRILLDOWN_STUB_SAFE_V1 DISABLED (COMMERCIAL BUNDLE-ONLY) */
(function(){
  'use strict';
  try{
    // In commercial mode we never dynamically load other scripts.
    if (window && (window.__VSP_BUNDLE_COMMERCIAL_V2 || window.__VSP_BUNDLE_COMMERCIAL_V1)) return;
  }catch(_){}
})();

})();
/* ==== END: static/js/vsp_drilldown_stub_safe_v1.js ==== */

/* ==== BEGIN: static/js/vsp_drilldown_stub_v1.js ==== */
(function(){
'use strict';
// VSP_SAFE_DRILLDOWN_HARDEN_P0_V6
/* VSP_DRILLDOWN_STUB_V1: guarantee drilldown factory exists early */
(function(){
  'use strict';
  





/* VSP_FIX_DRILLDOWN_CALLSITE_P0_V5: safe-call drilldown artifacts (function OR object.open) */
function __VSP_DD_ART_CALL__(h, ...args) {
  try {
    if (typeof h === 'function') return h(...args);
    if (h && typeof h.open === 'function') return h.open(...args);
  } catch(e) { try{console.warn('[VSP][DD_SAFE]', e);}catch(_e){} }
  return null;
}

/* VSP_FIX_DRILLDOWN_CALLSITE_P0_V3: safe-call for drilldown artifacts (function OR object.open) */
function __VSP_DD_ART_CALL__(h, ...args) {
  try {
    if (typeof h === 'function') return h(...args);
    if (h && typeof h.open === 'function') return h.open(...args);
  } catch (e) {
    try { console.warn('[VSP][DD_SAFE] call failed', e); } catch (_e) {}
  }
  return null;
}

/* VSP_FIX_DRILLDOWN_ARTIFACTS_NOT_FUNCTION_P0_V2
 * Fix: TypeError __VSP_DD_ART_CALL__(VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2, ...) is not a function
 * Normalize BEFORE first use:
 *   - if function: keep
 *   - if object with .open(): wrap as function(arg)->obj.open(arg)
 *   - else: no-op (never throw)
 */
(function(){
  'use strict';
  if (window.__VSP_FIX_DRILLDOWN_ARTIFACTS_NOT_FUNCTION_P0_V2) return;
  window.__VSP_FIX_DRILLDOWN_ARTIFACTS_NOT_FUNCTION_P0_V2 = 1;

  function normalize(v){
    if (typeof v === 'function') return v;
    if (v && typeof v.open === 'function') {
      const obj = v;
      const fn = function(arg){ try { return obj.open(arg); } catch(e){ console.warn('[VSP][DD_FIX] open() failed', e); return null; } };
      fn.__wrapped_from_object = true;
      return fn;
    }
    const noop = function(_arg){ return null; };
    noop.__noop = true;
    return noop;
  }

  try {
    // trap future assignments
    let _val = window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2;
    Object.defineProperty(window, 'VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2', {
      configurable: true, enumerable: true,
      get: function(){ return _val; },
      set: function(v){ _val = normalize(v); }
    });
    window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 = _val;
  } catch(e) {
    window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 = normalize(window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2);
  }
})();

try{
    function __vsp_dd_stub(){
      try{ console.info("[VSP][DD] stub invoked"); }catch(_){}
      return { open:function(){}, show:function(){}, close:function(){}, destroy:function(){} };
    }
    if (typeof window !== "undefined") {
      if (typeof window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 !== "function") {
        window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 = __vsp_dd_stub;
      }
      // some older code might reference this name too
      if (typeof window.VSP_DASH_DRILLDOWN_ARTIFACTS !== "function") {
        window.VSP_DASH_DRILLDOWN_ARTIFACTS = __vsp_dd_stub;
      }
    }
  }catch(_){}
})();

})();
/* ==== END: static/js/vsp_drilldown_stub_v1.js ==== */

/* ==== BEGIN: static/js/vsp_drilldown_symbol_lock_v1.js ==== */
(function(){
'use strict';
// VSP_SAFE_DRILLDOWN_HARDEN_P0_V6


/* VSP_FIX_DRILLDOWN_ARTIFACTS_NOT_FUNCTION_P0_V2
 * Fix: TypeError __VSP_DD_ART_CALL__(VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2, ...) is not a function
 * Normalize BEFORE first use:
 *   - if function: keep
 *   - if object with .open(): wrap as function(arg)->obj.open(arg)
 *   - else: no-op (never throw)
 */
(function(){
  'use strict';
  



/* VSP_FIX_DRILLDOWN_CALLSITE_P0_V5: safe-call drilldown artifacts (function OR object.open) */
function __VSP_DD_ART_CALL__(h, ...args) {
  try {
    if (typeof h === 'function') return h(...args);
    if (h && typeof h.open === 'function') return h.open(...args);
  } catch(e) { try{console.warn('[VSP][DD_SAFE]', e);}catch(_e){} }
  return null;
}

/* VSP_FIX_DRILLDOWN_CALLSITE_P0_V3: safe-call for drilldown artifacts (function OR object.open) */
function __VSP_DD_ART_CALL__(h, ...args) {
  try {
    if (typeof h === 'function') return h(...args);
    if (h && typeof h.open === 'function') return h.open(...args);
  } catch (e) {
    try { console.warn('[VSP][DD_SAFE] call failed', e); } catch (_e) {}
  }
  return null;
}

if (window.__VSP_FIX_DRILLDOWN_ARTIFACTS_NOT_FUNCTION_P0_V2) return;
  window.__VSP_FIX_DRILLDOWN_ARTIFACTS_NOT_FUNCTION_P0_V2 = 1;

  function normalize(v){
    if (typeof v === 'function') return v;
    if (v && typeof v.open === 'function') {
      const obj = v;
      const fn = function(arg){ try { return obj.open(arg); } catch(e){ console.warn('[VSP][DD_FIX] open() failed', e); return null; } };
      fn.__wrapped_from_object = true;
      return fn;
    }
    const noop = function(_arg){ return null; };
    noop.__noop = true;
    return noop;
  }

  try {
    // trap future assignments
    let _val = window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2;
    Object.defineProperty(window, 'VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2', {
      configurable: true, enumerable: true,
      get: function(){ return _val; },
      set: function(v){ _val = normalize(v); }
    });
    window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 = _val;
  } catch(e) {
    window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 = normalize(window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2);
  }
})();

/* VSP_DRILLDOWN_SYMBOL_LOCK_V1: make sure VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 is ALWAYS a function */
(function(){
  'use strict';

  function stub(){
    try{ console.info("[VSP][DD] stub invoked"); }catch(_){}
    return {open:function(){},show:function(){},close:function(){},destroy:function(){}};
  }

  function lock(){
    try{
      if (typeof window === "undefined") return;

      // keep last known good real impl
      if (typeof window.__vsp_dd_real !== "function") window.__vsp_dd_real = null;

      function getFn(){
        return (typeof window.__vsp_dd_real === "function") ? window.__vsp_dd_real : stub;
      }

      // If property can be defined, lock it
      try{
        Object.defineProperty(window, "VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2", {
          configurable: false,
          enumerable: true,
          get: function(){ return getFn(); },
          set: function(v){
            if (typeof v === "function") {
              window.__vsp_dd_real = v;
              try{ console.info("[VSP][DD] accepted real drilldown impl"); }catch(_){}
            } else {
              try{ console.warn("[VSP][DD] blocked non-function overwrite:", v); }catch(_){}
            }
          }
        });
        // normalize existing value (if it was non-function)
        if (typeof window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 !== "function") {
          window.__vsp_dd_real = null;
        }
      }catch(e){
        // Fallback if defineProperty fails: force-correct periodically
        try{ console.warn("[VSP][DD] defineProperty failed, fallback ticker", e); }catch(_){}
        try{
          if (!window.__vsp_dd_fix_timer) {
            window.__vsp_dd_fix_timer = setInterval(function(){
              try{
                if (typeof window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 !== "function") {
                  window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 = stub;
                }
              }catch(_){}
            }, 400);
          }
        }catch(_){}
      }
    }catch(_){}
  }

  // early + late lock
  lock();
  try{
    window.addEventListener("DOMContentLoaded", lock, {once:true});
    window.addEventListener("load", lock, {once:true});
  }catch(_){}
})();

})();
/* ==== END: static/js/vsp_drilldown_symbol_lock_v1.js ==== */

/* ==== BEGIN: static/js/vsp_export_guard_v1.js ==== */
(function(){
'use strict';
/* VSP_EXPORT_GUARD_V1 */
(function () {
  function hidePDF() {
    const sel = [
      'a[href*="fmt=pdf"]',
      'button[data-fmt="pdf"]',
      '[data-export-fmt="pdf"]',
      '[data-vsp-export="pdf"]'
    ].join(",");

    document.querySelectorAll(sel).forEach((n) => {
      n.style.display = "none";
      n.setAttribute("aria-hidden", "true");
    });

    // Heuristic: hide menu items with exact text "PDF"
    document.querySelectorAll("a,button,li,div,span").forEach((n) => {
      const t = (n.textContent || "").trim().toUpperCase();
      if (t === "PDF") {
        // hide container if it's obviously a menu item
        const box = n.closest("li") || n.closest("a") || n;
        box.style.display = "none";
      }
    });
  }

  function interceptPDFClicks() {
    document.addEventListener("click", (e) => {
      const a = e.target.closest && e.target.closest('a[href*="fmt=pdf"]');
      if (!a) return;
      e.preventDefault();
      e.stopPropagation();
      alert("PDF export is disabled in this commercial build. Use HTML or ZIP.");
    }, true);
  }

  window.addEventListener("DOMContentLoaded", () => {
    hidePDF();
    interceptPDFClicks();
    // re-hide after UI rerenders
    setTimeout(hidePDF, 800);
    setTimeout(hidePDF, 1800);
  });
})();

})();
/* ==== END: static/js/vsp_export_guard_v1.js ==== */

/* ==== BEGIN: static/js/vsp_fetch_shim_v1.js ==== */
(function(){
'use strict';
(function () {
  const LOG = "[VSP_FETCH_SHIM]";
  const ORIG = (window.fetch && window.fetch.bind(window)) || fetch;

  function log(...args) {
    try {
      console.warn(LOG, ...args);
    } catch (e) {}
  }

  window.fetch = function (input, init) {
    let url = (typeof input === "string") ? input : (input && input.url) || "";

    // Chuẩn hóa: chỉ lấy path để so pattern nếu cần
    try {
      const u = new URL(url, window.location.origin);
      url = u.pathname + u.search;
    } catch (e) {
      // nếu không parse được thì dùng nguyên string
    }

    // 1) Legacy bug: /api/vsp/runs_index_v3_v3
    if (url.includes("/api/vsp/runs_index_v3_v3")) {
      const fixed = url.replace("runs_index_v3_v3", "runs_index_v3");
      log("redirect runs_index_v3_v3 ->", fixed);
      return ORIG(fixed, init);
    }

    // 2) Legacy API: /api/vsp/runs_v2 -> runs_index_v3
    if (url.includes("/api/vsp/runs_v2")) {
      const fixed = url.replace("runs_v2", "runs_index_v3");
      log("redirect runs_v2 ->", fixed);
      return ORIG(fixed, init);
    }

    // 3) Legacy top_cwe_v1 – stub rỗng, tránh 404
    if (url.includes("/api/vsp/top_cwe_v1")) {
      log("stub top_cwe_v1");
      const body = JSON.stringify({ ok: true, items: [] });
      return Promise.resolve(new Response(body, {
        status: 200,
        headers: { "Content-Type": "application/json" }
      }));
    }

    // 4) Legacy settings/get – stub rỗng, tránh 404
    if (url.includes("/api/vsp/settings/get")) {
      log("stub settings/get");
      const body = JSON.stringify({
        ok: true,
        profiles: [],
        tool_overrides: []
      });
      return Promise.resolve(new Response(body, {
        status: 200,
        headers: { "Content-Type": "application/json" }
      }));
    }

    return ORIG(input, init);
  };

  console.log(LOG, "installed");
})();

})();
/* ==== END: static/js/vsp_fetch_shim_v1.js ==== */

/* ==== BEGIN: static/js/vsp_fulltabs_bind_v1.js ==== */
(function(){
'use strict';
var enabledTools = 0;
var totalTools = 0;
/**
 * vsp_fulltabs_bind_v1.js
 * Bind data + Chart + KPI cho 5 tab (Dashboard + Runs + Data Source + Settings).
 */

console.log("[VSP][FULLTABS] vsp_fulltabs_bind_v1.js loaded.");

// Severity palette dùng chung cho chart & badge
const VSP_SEVERITY_COLORS = {
  CRITICAL: "rgba(255, 99, 132, 0.9)",
  HIGH:     "rgba(255, 159, 64, 0.9)",
  MEDIUM:   "rgba(255, 205, 86, 0.9)",
  LOW:      "rgba(75, 192, 192, 0.9)",
  INFO:     "rgba(54, 162, 235, 0.9)",
  TRACE:    "rgba(201, 203, 207, 0.9)"
};

async function vspFullFetch(url) {
  try {
    const resp = await fetch(url, { credentials: "same-origin" });
    if (!resp.ok) {
      console.error("[VSP][FULLTABS] HTTP", resp.status, url);
      return null;
    }
    return await resp.json();
  } catch (e) {
    console.error("[VSP][FULLTABS] Fetch error", url, e);
    return null;
  }
}

/* ===== Helpers DOM chung ===== */

function vspFullFindCardByTitle(labelText) {
  const all = document.querySelectorAll("h1,h2,h3,h4,h5,h6,div,span,p");
  const target = labelText.trim().toUpperCase();
  for (const el of all) {
    const t = (el.textContent || "").trim().toUpperCase();
    if (!t) continue;
    if (t === target) {
      let card =
        el.closest(".kpi-card") ||
        el.closest(".vsp-kpi") ||
        el.closest(".vsp-card") ||
        el.closest(".card") ||
        el.closest(".panel") ||
        el.parentElement;
      if (card) return card;
    }
  }
  return null;
}

function vspFullFormat(n) {
  if (typeof n !== "number" || !isFinite(n)) return "0";
  return n.toLocaleString("en-US");
}

function vspFullEnsureCanvas(card, id) {
  if (!card) return null;
  let canvas = card.querySelector("canvas#" + id);
  if (!canvas) {
    canvas = document.createElement("canvas");
    canvas.id = id;
    const body =
      card.querySelector(".widget-body, .card-body, .vsp-widget, .content") ||
      card;
    body.innerHTML = "";
    body.appendChild(canvas);
  }
  return canvas;
}

function vspFullSetTextInCard(card, selectorList, text) {
  if (!card) return;
  for (const sel of selectorList) {
    const el = card.querySelector(sel);
    if (el) {
      el.textContent = text;
      return;
    }
  }
}

/* ===== 1. Dashboard – KPI + chart + top risk ===== */

const VSP_KPI_SEV_CLASSES = [
  "vsp-kpi-critical",
  "vsp-kpi-high",
  "vsp-kpi-medium",
  "vsp-kpi-low",
  "vsp-kpi-info",
  "vsp-kpi-trace",
  "vsp-kpi-good",
  "vsp-kpi-warn",
  "vsp-kpi-bad"
];

function vspFullApplyKpiSeverityStyles(dashboard) {
  const bySeverity = dashboard.by_severity || {};

  function styleSevCard(title, sevKey) {
    const card = vspFullFindCardByTitle(title);
    if (!card) return;
    card.classList.remove(...VSP_KPI_SEV_CLASSES);
    card.classList.add("vsp-kpi-card", "vsp-kpi-" + sevKey.toLowerCase());
  }

  // Các card severity chính
  styleSevCard("CRITICAL", "CRITICAL");
  styleSevCard("HIGH", "HIGH");
  styleSevCard("MEDIUM", "MEDIUM");
  styleSevCard("LOW", "LOW");
  styleSevCard("INFO + TRACE", "INFO");

  // TOTAL FINDINGS: đỏ nếu có CRIT/HIGH, cam nếu chỉ MED, xanh nếu low-level
  const totalCard = vspFullFindCardByTitle("TOTAL FINDINGS");
  if (totalCard) {
    totalCard.classList.remove(...VSP_KPI_SEV_CLASSES);
    totalCard.classList.add("vsp-kpi-card");
    const crit = Number(bySeverity.CRITICAL || 0);
    const high = Number(bySeverity.HIGH || 0);
    const med  = Number(bySeverity.MEDIUM || 0);
    let cls = "vsp-kpi-good";
    if (crit > 0 || high > 0) cls = "vsp-kpi-critical";
    else if (med > 0) cls = "vsp-kpi-high";
    totalCard.classList.add(cls);
  }

  // SECURITY SCORE: >=80 xanh, 50-79 warn, <50 bad
  const scoreCard = vspFullFindCardByTitle("SECURITY POSTURE SCORE");
  if (scoreCard) {
    scoreCard.classList.remove(...VSP_KPI_SEV_CLASSES);
    scoreCard.classList.add("vsp-kpi-card");
    const score = Number(dashboard.security_score || 0);
    let cls = "vsp-kpi-bad";
    if (score >= 80) cls = "vsp-kpi-good";
    else if (score >= 50) cls = "vsp-kpi-warn";
    scoreCard.classList.add(cls);
  }
}

function vspFullBindDashboard(dashboard, runs, datasource, topCweInsights) {
  if (!dashboard) return;

  const bySeverity = dashboard.by_severity || {};
  const byTool = dashboard.by_tool || {};

  /* ---- TOP RISKY TOOL ---- */
  let topRiskyTool = dashboard.top_risky_tool || "N/A";
  if ((!topRiskyTool || topRiskyTool === "N/A") && byTool) {
    let bestName = null;
    let bestCount = -1;
    Object.entries(byTool).forEach(([name, cnt]) => {
      const n = Number(cnt || 0);
      if (n > bestCount) {
        bestCount = n;
        bestName = name;
      }
    });
    if (bestName) topRiskyTool = bestName;
  }
  const riskyCard = vspFullFindCardByTitle("TOP RISKY TOOL");
  if (riskyCard) {
    vspFullSetTextInCard(
      riskyCard,
      [".kpi-value", ".value", ".kpi-main"],
      topRiskyTool || "N/A"
    );
  }

  /* ---- Severity distribution chart ---- */
  const sevCard = vspFullFindCardByTitle("Severity distribution (6 levels)");
  if (sevCard && window.Chart) {
    const canvas = vspFullEnsureCanvas(sevCard, "vsp_chart_severity");
    if (canvas) {
      const labels = ["CRITICAL", "HIGH", "MEDIUM", "LOW", "INFO", "TRACE"];
      const data = labels.map(sev => bySeverity[sev] || 0);
      const bgColors = labels.map(
        sev => VSP_SEVERITY_COLORS[sev] || "rgba(255,255,255,0.3)"
      );

      if (canvas._chart) canvas._chart.destroy();
      canvas._chart = new Chart(canvas.getContext("2d"), {
        type: "bar",
        data: {
          labels,
          datasets: [{
            label: "Findings",
            data,
            backgroundColor: bgColors,
            borderColor: bgColors,
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            x: { ticks: { autoSkip: false } },
            y: { beginAtZero: true }
          }
        }
      });
    }
  } else if (sevCard) {
    const text =
      "CRIT " + vspFullFormat(bySeverity.CRITICAL || 0) +
      " • HIGH " + vspFullFormat(bySeverity.HIGH || 0) +
      " • MED " + vspFullFormat(bySeverity.MEDIUM || 0) +
      " • LOW " + vspFullFormat(bySeverity.LOW || 0) +
      " • INFO " + vspFullFormat(bySeverity.INFO || 0) +
      " • TRACE " + vspFullFormat(bySeverity.TRACE || 0);
    const body =
      sevCard.querySelector(".widget-body, .card-body, .vsp-widget, .content") ||
      sevCard;
    body.innerHTML = '<div class="severity-summary-text">' + text + "</div>";
  }

  /* ---- Trend over time (Critical+High) ---- */
  if (Array.isArray(runs) && window.Chart) {
    const trendCard = vspFullFindCardByTitle("Trend over time");
    if (trendCard) {
      const canvas = vspFullEnsureCanvas(trendCard, "vsp_chart_trend");
      if (canvas) {
        const recent = runs.slice().reverse().slice(-10);
        const labels = recent.map(r => {
          const id = r.run_id || "";
          const parts = id.split("_");
          return parts.length >= 4 ? parts[3] : id;
        });
        const data = recent.map(r => {
          const sev = r.by_severity || {};
          return Number(sev.CRITICAL || 0) + Number(sev.HIGH || 0);
        });

        if (canvas._chart) canvas._chart.destroy();
        canvas._chart = new Chart(canvas.getContext("2d"), {
          type: "line",
          data: {
            labels,
            datasets: [{
              label: "Critical + High",
              data,
              fill: false,
              tension: 0.3
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true } }
          }
        });
      }
    }
  }

  /* ---- Critical & High by tool ---- */
  if (datasource && Array.isArray(datasource.items) && window.Chart) {
    const card = vspFullFindCardByTitle("Critical & High by tool");
    if (card) {
      const canvas = vspFullEnsureCanvas(card, "vsp_chart_tool_ch");
      if (canvas) {
        const counts = {};
        datasource.items.forEach(it => {
          const sev = (it.severity || "").toUpperCase();
          if (sev !== "CRITICAL" && sev !== "HIGH") return;
          const tool = it.tool || "unknown";
          counts[tool] = (counts[tool] || 0) + 1;
        });
        const labels = Object.keys(counts);
        const data = labels.map(t => counts[t]);

        if (canvas._chart) canvas._chart.destroy();
        canvas._chart = new Chart(canvas.getContext("2d"), {
          type: "bar",
          data: {
            labels,
            datasets: [{
              label: "Critical+High",
              data
            }]
          },
          options: {
            indexAxis: "y",
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: { x: { beginAtZero: true } }
          }
        });
      }
    }
  }

  /* ---- Top CWE exposure ---- */
  if (topCweInsights && Array.isArray(topCweInsights.items) && window.Chart) {
    const card = vspFullFindCardByTitle("Top CWE exposure");
    if (card) {
      const canvas = vspFullEnsureCanvas(card, "vsp_chart_cwe");
      if (canvas) {
        const items = topCweInsights.items.slice(0, 7);
        const labels = items.map(it => it.cwe || "UNKNOWN");
        const data = items.map(it => it.count || 0);

        if (canvas._chart) canvas._chart.destroy();
        canvas._chart = new Chart(canvas.getContext("2d"), {
          type: "bar",
          data: {
            labels,
            datasets: [{
              label: "Findings",
              data
            }]
          },
          options: {
            indexAxis: "y",
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: { x: { beginAtZero: true } }
          }
        });
      }
    }
  }

  /* ---- Top risk findings (table) ---- */
  if (datasource && Array.isArray(datasource.items)) {
    const sevRank = { CRITICAL: 0, HIGH: 1, MEDIUM: 2, LOW: 3, INFO: 4, TRACE: 5 };
    const items = datasource.items.slice().sort((a, b) => {
      const sa = sevRank[(a.severity || "").toUpperCase()] ?? 99;
      const sb = sevRank[(b.severity || "").toUpperCase()] ?? 99;
      if (sa !== sb) return sa - sb;
      return 0;
    });
    const top = items.slice(0, 5);

    const topCard = vspFullFindCardByTitle("Top risk findings");
    if (topCard) {
      const tbody = topCard.querySelector("tbody");
      if (tbody && !tbody.hasChildNodes()) {
        top.forEach(it => {
          const tr = document.createElement("tr");
          const tdSev  = document.createElement("td");
          const tdTool = document.createElement("td");
          const tdLoc  = document.createElement("td");
          const tdRule = document.createElement("td");
          tdSev.textContent  = it.severity || "";
          tdTool.textContent = it.tool || "";
          tdLoc.textContent  = it.file || it.path || "";
          tdRule.textContent = it.rule_id || it.rule || "";
          tr.appendChild(tdSev);
          tr.appendChild(tdTool);
          tr.appendChild(tdLoc);
          tr.appendChild(tdRule);
          tbody.appendChild(tr);
        });
      }
    }
  }

  // Áp màu heat cho KPI
  vspFullApplyKpiSeverityStyles(dashboard);
}

/* ===== 2. Runs & Reports – KPI & style ===== */

function vspFullBindRuns(runs) {
  if (!Array.isArray(runs) || runs.length === 0) return;

  const totalRuns = runs.length;
  const totalFindingsAll = runs.reduce(
    (sum, r) => sum + Number(r.total_findings || 0),
    0
  );
  const avgFindings = totalRuns > 0
    ? Math.round(totalFindingsAll / totalRuns)
    : 0;

  const totalRunsCard = vspFullFindCardByTitle("TOTAL RUNS");
  if (totalRunsCard) {
    vspFullSetTextInCard(
      totalRunsCard,
      [".kpi-value", ".value", ".kpi-main"],
      vspFullFormat(totalRuns)
    );
  }

  // LAST 10 RUNS success/fail (0 findings = success)
  const last10 = runs.slice(0, 10);
  let successCount = 0;
  let failCount = 0;
  last10.forEach(r => {
    const tf = Number(r.total_findings || 0);
    if (tf === 0) successCount += 1;
    else failCount += 1;
  });

  const lastCard = vspFullFindCardByTitle("LAST 10 RUNS");
  if (lastCard) {
    const txt = successCount + " / " + failCount;
    vspFullSetTextInCard(lastCard, [".kpi-value", ".value", ".kpi-main"], txt);
  }

  const avgCard = vspFullFindCardByTitle("AVG FINDINGS / RUN");
  if (avgCard) {
    vspFullSetTextInCard(
      avgCard,
      [".kpi-value", ".value", ".kpi-main"],
      vspFullFormat(avgFindings)
    );
  }

  // TOOLS ENABLED / RUN – dựa vào settings (global cache)
  const toolsCard = vspFullFindCardByTitle("TOOLS ENABLED / RUN");
  if (toolsCard) {
    let totalTools = 7;
    let enabledTools = 7;
    if (window.vspFullSettingsLast && window.vspFullSettingsLast.tools) {
      const t = window.vspFullSettingsLast.tools;
      totalTools = Object.keys(t).length;
      enabledTools = Object.values(t).filter(cfg => cfg && cfg.enabled).length;
    }
    const txt = enabledTools + " / " + totalTools;
    vspFullSetTextInCard(toolsCard, [".kpi-value", ".value", ".kpi-main"], txt);
  }

  // Style màu cho 4 KPI Runs
  if (totalRunsCard) {
    totalRunsCard.classList.remove(...VSP_KPI_SEV_CLASSES);
    totalRunsCard.classList.add("vsp-kpi-card", "vsp-kpi-info");
  }
  if (lastCard) {
    lastCard.classList.remove(...VSP_KPI_SEV_CLASSES);
    lastCard.classList.add("vsp-kpi-card");
    const cls = failCount === 0 ? "vsp-kpi-good"
      : (failCount <= 3 ? "vsp-kpi-warn" : "vsp-kpi-bad");
    lastCard.classList.add(cls);
  }
  if (avgCard) {
    avgCard.classList.remove(...VSP_KPI_SEV_CLASSES);
    avgCard.classList.add("vsp-kpi-card");
    let cls = "vsp-kpi-good";
    if (avgFindings > 5000) cls = "vsp-kpi-critical";
    else if (avgFindings > 1000) cls = "vsp-kpi-high";
    avgCard.classList.add(cls);
  }
  if (toolsCard) {
    toolsCard.classList.remove(...VSP_KPI_SEV_CLASSES);
    toolsCard.classList.add("vsp-kpi-card");
    const cls = (enabledTools === totalTools) ? "vsp-kpi-good" : "vsp-kpi-warn";
    toolsCard.classList.add(cls);
  }
}

/* ===== 3. Data Source – donut + Top CWE list ===== */

function vspFullBindDatasource(datasource, topCweInsights) {
  if (!datasource || !Array.isArray(datasource.items)) return;

  const sevCounts = { CRITICAL: 0, HIGH: 0, MEDIUM: 0, LOW: 0, INFO: 0, TRACE: 0 };
  datasource.items.forEach(it => {
    const s = (it.severity || "").toUpperCase();
    if (sevCounts[s] !== undefined) sevCounts[s] += 1;
  });

  const donutCard = vspFullFindCardByTitle("Severity donut - unified");
  if (donutCard && window.Chart) {
    const canvas = vspFullEnsureCanvas(donutCard, "vsp_chart_ds_severity");
    if (canvas) {
      const labels = ["CRITICAL", "HIGH", "MEDIUM", "LOW", "INFO", "TRACE"];
      const data = labels.map(sev => sevCounts[sev] || 0);
      const bgColors = labels.map(
        sev => VSP_SEVERITY_COLORS[sev] || "rgba(255,255,255,0.3)"
      );

      if (canvas._chart) canvas._chart.destroy();
      canvas._chart = new Chart(canvas.getContext("2d"), {
        type: "doughnut",
        data: {
          labels,
          datasets: [{
            data,
            backgroundColor: bgColors,
            borderColor: bgColors,
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { position: "bottom" } },
          cutout: "60%"
        }
      });
    }
  } else if (donutCard) {
    const body =
      donutCard.querySelector(".widget-body, .card-body, .vsp-widget, .content") ||
      donutCard;
    body.innerHTML =
      "<ul class='sev-donut-text'>" +
      "<li>CRIT: " + vspFullFormat(sevCounts.CRITICAL) + "</li>" +
      "<li>HIGH: " + vspFullFormat(sevCounts.HIGH) + "</li>" +
      "<li>MED: " + vspFullFormat(sevCounts.MEDIUM) + "</li>" +
      "<li>LOW: " + vspFullFormat(sevCounts.LOW) + "</li>" +
      "<li>INFO: " + vspFullFormat(sevCounts.INFO) + "</li>" +
      "<li>TRACE: " + vspFullFormat(sevCounts.TRACE) + "</li>" +
      "</ul>";
  }

  const cweCard = vspFullFindCardByTitle("Top CWE & hot directories");
  if (cweCard && topCweInsights && Array.isArray(topCweInsights.items)) {
    const items = topCweInsights.items.slice(0, 5);
    const body =
      cweCard.querySelector(".widget-body, .card-body, .vsp-widget, .content") ||
      cweCard;
    let html = "<ul class='top-cwe-list'>";
    items.forEach(it => {
      const cwe = it.cwe || "UNKNOWN";
      const count = vspFullFormat(it.count || 0);
      html += "<li>" + cwe + " – " + count + " findings</li>";
    });
    html += "</ul>";
    body.innerHTML = html;
  }
}

/* ===== 4. Settings & Overrides (cache tools cho Runs KPI) ===== */

function vspFullBindSettings(settings) {
  if (!settings || !settings.env || !settings.tools) return;

  window.vspFullSettingsLast = settings;

  const card = vspFullFindCardByTitle("Profile / Tools");
  if (card) {
    const profile = settings.env.profile || "UNKNOWN";
    const tools = Object.entries(settings.tools)
      .filter(([_, cfg]) => cfg && cfg.enabled)
      .map(([name]) => name)
      .join(", ");
    const txt = profile + " – " + tools;
    vspFullSetTextInCard(
      card,
      [".kpi-value", ".value", ".kpi-main", ".content"],
      txt
    );
  }
}

/* ===== 5. Severity badges (Data Source + Top risk table) ===== */

function vspApplySeverityBadges() {
  const map = {
    CRITICAL: "vsp-sev-critical",
    HIGH: "vsp-sev-high",
    MEDIUM: "vsp-sev-medium",
    LOW: "vsp-sev-low",
    INFO: "vsp-sev-info",
    TRACE: "vsp-sev-trace"
  };

  const nodes = document.querySelectorAll("td, span, div");
  nodes.forEach(el => {
    const txt = (el.textContent || "").trim().toUpperCase();
    const cls = map[txt];
    if (!cls) return;
    el.classList.add("vsp-sev-badge", cls);
  });
}

/* ===== 6. Init – call APIs ===== */

async function vspFullTabsInit() {
  console.log("[VSP][FULLTABS] Init...");

  const [dashboard, runs, datasource, topCwe, settings] = await Promise.all([
    vspFullFetch("/api/vsp/dashboard_v3"),
    vspFullFetch("/api/vsp/runs_index_v3_v3?limit=200"),
    vspFullFetch("/api/vsp/datasource_v2?limit=1000"),
    vspFullFetch("/api/vsp/top_cwe_v1?limit=10"),
    vspFullFetch("/api/vsp/settings/get")
  ]);

  if (settings) vspFullBindSettings(settings);
  if (dashboard) vspFullBindDashboard(dashboard, runs || [], datasource || {}, topCwe || null);
  if (runs) vspFullBindRuns(runs);
  if (datasource) vspFullBindDatasource(datasource, topCwe || null);

  vspApplySeverityBadges();

  console.log("[VSP][FULLTABS] Done.");
}

if (document.readyState === "loading") {
  document.addEventListener("DOMContentLoaded", vspFullTabsInit);
} else {
  vspFullTabsInit();
}

})();
/* ==== END: static/js/vsp_fulltabs_bind_v1.js ==== */

/* ==== BEGIN: static/js/vsp_gate_panel_v1.js ==== */
(function(){
'use strict';
/* VSP_GATE_PANEL_V1 (P0 canonical): stable RID resolve + canonical gate summary + no N/A */
(function(){
  'use strict';

  const LS_KEYS = [
    "vsp_rid_selected_v2",
    "vsp_rid_selected",
    "vsp_last_rid"
  ];

  const SELS = [
    "#vsp_gate_panel",
    "#vsp-gate-panel",
    "#gate_panel",
    "#gate-panel",
    ".vsp-gate-panel",
    "[data-vsp-gate-panel]"
  ];

  let _inited = false;
  let _warned_no_mount = false;
  let _warned_no_runs = false;

  function nowISO(){
    try { return new Date().toISOString(); } catch(_) { return ""; }
  }

  function safeText(x){
    if (x === null || x === undefined) return "";
    if (typeof x === "string") return x;
    try { return JSON.stringify(x); } catch(_) { return String(x); }
  }

  function pickMount(){
    for (const s of SELS){
      const el = document.querySelector(s);
      if (el) return el;
    }
    return null;
  }

  function setHTML(el, html){
    if (!el) return;
    el.innerHTML = html;
  }

  function badge(status){
    const s = (status || "").toUpperCase();
    const cls =
      s === "OK" ? "vsp-bdg-ok" :
      (s === "FAIL" || s === "RED") ? "vsp-bdg-fail" :
      (s === "DEGRADED" || s === "AMBER") ? "vsp-bdg-deg" :
      "vsp-bdg-unk";
    return `<span class="vsp-bdg ${cls}">${escapeHtml(s || "UNKNOWN")}</span>`;
  }

  function escapeHtml(str){
    return String(str)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function normalizeOverall(v){
    // accept many shapes: {overall:{status}} or {verdict:{overall}} or {status}
    if (!v) return { status: "DEGRADED", reasons: ["missing gate summary"], degraded: ["gate_summary_missing"], ts: nowISO() };

    // status candidates
    let status =
      (v.overall && (v.overall.status || v.overall.verdict)) ||
      (v.verdict && (v.verdict.overall || v.verdict.status)) ||
      v.status ||
      v.overall_status ||
      v.overall;

    status = String(status || "").toUpperCase();

    // map common verdict words
    if (status === "GREEN") status = "OK";
    if (status === "AMBER") status = "DEGRADED";
    if (status === "RED") status = "FAIL";
    if (!status) status = "DEGRADED";

    // reasons/degraded lists
    const reasons = []
      .concat((v.overall && v.overall.reasons) || [])
      .concat((v.reasons) || [])
      .concat((v.overall && v.overall.reason) ? [v.overall.reason] : [])
      .concat((v.reason) ? [v.reason] : [])
      .filter(Boolean)
      .map(safeText);

    const degraded = []
      .concat((v.overall && v.overall.degraded) || [])
      .concat(v.degraded || [])
      .concat(v.degraded_list || [])
      .filter(Boolean)
      .map(safeText);

    const ts =
      (v.overall && (v.overall.ts || v.overall.timestamp)) ||
      v.ts || v.timestamp || nowISO();

    return { status, reasons, degraded, ts: safeText(ts) };
  }

  async function fetchJSON(url){
    const r = await fetch(url, { credentials: "same-origin" });
    if (!r.ok) {
      const t = await r.text().catch(()=> "");
      const e = new Error(`HTTP ${r.status} ${r.statusText} for ${url}`);
      e._body = t;
      e._status = r.status;
      throw e;
    }
    return await r.json();
  }

  function getRIDFromLocalStorage(){
    for (const k of LS_KEYS){
      try {
        const v = localStorage.getItem(k);
        if (v && String(v).trim()) return String(v).trim();
      } catch(_){}
    }
    return "";
  }

  function setRIDToLocalStorage(rid){
    try { localStorage.setItem("vsp_rid_selected_v2", String(rid||"")); } catch(_){}
    try { localStorage.setItem("vsp_last_rid", String(rid||"")); } catch(_){}
  }

  async function resolveRID(){
    // 1) localStorage (canonical P0)
    const lsRid = getRIDFromLocalStorage();
    if (lsRid) return lsRid;

    // 2) dashboard_v3 (often has current run_id)
    try{
      const d = await fetchJSON("/api/vsp/dashboard_v3");
      const rid = d && (d.run_id || d.rid || (d.current && (d.current.run_id || d.current.rid)));
      if (rid) return String(rid);
    }catch(_){}

    // 3) runs_index latest (fallback)
    try{
      const idx = await fetchJSON("/api/vsp/runs_index_v3_fs_resolved?limit=1&hide_empty=0&filter=1");
      const items = (idx && idx.items) ? idx.items : [];
      const rid = items.length ? (items[0].run_id || items[0].rid || items[0].id) : "";
      if (rid) return String(rid);
      if (!_warned_no_runs){
        _warned_no_runs = true;
        console.warn("[VSP_GATE] no runs from runs_index_v3_fs_resolved (degraded)");
      }
    }catch(e){
      if (!_warned_no_runs){
        _warned_no_runs = true;
        console.warn("[VSP_GATE] runs_index_v3_fs_resolved fetch failed (degraded)", e);
      }
    }

    return "";
  }

  async function fetchGateSummaryByRID(rid){
    // try canonical endpoints (order matters)
    const candidates = [
      `/api/vsp/run_gate_summary_v1/${encodeURIComponent(rid)}`,
      `/api/vsp/run_gate_summary_v2/${encodeURIComponent(rid)}`,
      `/api/vsp/run_gate_summary/${encodeURIComponent(rid)}`,
      `/api/vsp/run_gate_summary_v1?rid=${encodeURIComponent(rid)}`,
      `/api/vsp/run_gate_summary_v2?rid=${encodeURIComponent(rid)}`
    ];

    let lastErr = null;
    for (const url of candidates){
      try{
        const j = await fetchJSON(url);
        return { ok:true, url, data:j };
      }catch(e){
        lastErr = e;
        // continue
      }
    }
    return { ok:false, url:(candidates[candidates.length-1]||""), err:lastErr };
  }

  function renderGate(el, model){
    const status = (model && model.status) ? model.status : "DEGRADED";
    const reasons = (model && model.reasons && model.reasons.length) ? model.reasons : [];
    const degraded = (model && model.degraded && model.degraded.length) ? model.degraded : [];
    const ts = (model && model.ts) ? model.ts : nowISO();

    const reasonsHtml = reasons.length
      ? `<ul class="vsp-gate-list">${reasons.map(x=>`<li>${escapeHtml(x)}</li>`).join("")}</ul>`
      : `<div class="vsp-gate-muted">No reasons</div>`;

    const degradedHtml = degraded.length
      ? `<ul class="vsp-gate-list">${degraded.map(x=>`<li>${escapeHtml(x)}</li>`).join("")}</ul>`
      : `<div class="vsp-gate-muted">No degraded items</div>`;

    const html = `
      <div class="vsp-gate-wrap">
        <div class="vsp-gate-hd">
          <div class="vsp-gate-title">OVERALL VERDICT</div>
          <div class="vsp-gate-badge">${badge(status)}</div>
        </div>
        <div class="vsp-gate-sub">
          <div><span class="vsp-gate-k">Updated:</span> <span class="vsp-gate-v">${escapeHtml(ts)}</span></div>
          ${model && model._rid ? `<div><span class="vsp-gate-k">RID:</span> <span class="vsp-gate-v">${escapeHtml(model._rid)}</span></div>` : ""}
          ${model && model._src ? `<div><span class="vsp-gate-k">Source:</span> <span class="vsp-gate-v">${escapeHtml(model._src)}</span></div>` : ""}
        </div>

        <div class="vsp-gate-cols">
          <div class="vsp-gate-col">
            <div class="vsp-gate-col-title">Reasons</div>
            ${reasonsHtml}
          </div>
          <div class="vsp-gate-col">
            <div class="vsp-gate-col-title">Degraded</div>
            ${degradedHtml}
          </div>
        </div>
      </div>
    `;

    setHTML(el, html);

    // inject minimal styles once
    if (!document.getElementById("vsp-gate-style-v1")){
      const st = document.createElement("style");
      st.id = "vsp-gate-style-v1";
      st.textContent = `
        .vsp-gate-wrap{border-radius:14px;padding:14px 14px 10px;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.03)}
        .vsp-gate-hd{display:flex;align-items:center;justify-content:space-between;gap:10px}
        .vsp-gate-title{font-weight:700;letter-spacing:.2px}
        .vsp-gate-sub{margin-top:8px;display:grid;gap:4px;font-size:12px;opacity:.9}
        .vsp-gate-k{opacity:.7}
        .vsp-gate-cols{margin-top:10px;display:grid;grid-template-columns:1fr 1fr;gap:12px}
        .vsp-gate-col-title{font-size:12px;font-weight:700;opacity:.85;margin-bottom:6px}
        .vsp-gate-list{margin:0;padding-left:16px;font-size:12px;opacity:.9}
        .vsp-gate-muted{font-size:12px;opacity:.6}
        .vsp-bdg{display:inline-flex;align-items:center;justify-content:center;padding:5px 10px;border-radius:999px;font-size:12px;font-weight:800;letter-spacing:.3px;border:1px solid rgba(255,255,255,.12)}
        .vsp-bdg-ok{background:rgba(0,255,140,.12)}
        .vsp-bdg-deg{background:rgba(255,190,0,.14)}
        .vsp-bdg-fail{background:rgba(255,70,70,.14)}
        .vsp-bdg-unk{background:rgba(160,160,160,.14)}
        @media (max-width: 900px){ .vsp-gate-cols{grid-template-columns:1fr} }
      `;
      document.head.appendChild(st);
    }
  }

  async function loadAndRender(){
    const mount = pickMount();
    if (!mount){
      if (!_warned_no_mount){
        _warned_no_mount = true;
        console.warn("[VSP_GATE] mount element not found (degraded)");
      }
      return;
    }

    // skeleton immediately
    renderGate(mount, { status:"DEGRADED", reasons:["waiting for run id"], degraded:["rid_pending"], ts:nowISO(), _src:"bootstrap" });

    const rid = await resolveRID();
    if (!rid){
      renderGate(mount, {
        status:"DEGRADED",
        reasons:["missing RID (no localStorage, no dashboard_v3 run_id, no runs_index)"],
        degraded:["rid_missing"],
        ts: nowISO(),
        _src:"resolveRID"
      });
      return;
    }

    setRIDToLocalStorage(rid);

    const gs = await fetchGateSummaryByRID(rid);
    if (!gs.ok){
      const msg = gs.err ? (gs.err.message || safeText(gs.err)) : "unknown error";
      renderGate(mount, {
        status:"DEGRADED",
        reasons:[`missing gate summary for RID=${rid}`, msg],
        degraded:["gate_summary_missing"],
        ts: nowISO(),
        _rid: rid,
        _src:"canonical_endpoints"
      });
      return;
    }

    const model = normalizeOverall(gs.data);
    model._rid = rid;
    model._src = gs.url;
    renderGate(mount, model);
  }

  function init(){
    if (_inited) return;
    _inited = true;

    // run once on DOM ready
    const run = () => { loadAndRender().catch(e=>console.warn("[VSP_GATE] loadAndRender failed", e)); };
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", run, { once:true });
    } else {
      run();
    }

    // optional: refresh on custom events if other tabs update RID
    window.addEventListener("vsp:rid_changed", run);
  }

  // expose minimal API (safe)
  window.VSP_GATE_PANEL_V1 = {
    init,
    refresh: () => loadAndRender()
  };

  init();
})();

})();
/* ==== END: static/js/vsp_gate_panel_v1.js ==== */

/* ==== BEGIN: static/js/vsp_hash_normalize_v1.js ==== */
(function(){
'use strict';
/* VSP_HASH_NORMALIZE_V1 DISABLED (COMMERCIAL BUNDLE-ONLY) */
(function(){
  'use strict';
  try{
    // In commercial mode we never dynamically load other scripts.
    if (window && (window.__VSP_BUNDLE_COMMERCIAL_V2 || window.__VSP_BUNDLE_COMMERCIAL_V1)) return;
  }catch(_){}
})();

})();
/* ==== END: static/js/vsp_hash_normalize_v1.js ==== */

/* ==== BEGIN: static/js/vsp_nav_scroll_autofix_v1.js ==== */
(function(){
'use strict';
/* VSP_NAV_SCROLL_AUTOFIX_V1: make left nav scrollable even when CSS selector unknown */
(function(){
  function pickNavContainer(anchor){
    // Walk up and find an ancestor that contains multiple nav items (sidebar list)
    let p = anchor;
    for (let i=0; i<20 && p; i++){
      try {
        const items = p.querySelectorAll ? p.querySelectorAll(".vsp-nav-item, a.vsp-tab, a[data-tab]") : [];
        if (items && items.length >= 4) return p;
      } catch(_){}
      p = p.parentElement;
    }
    return null;
  }

  function apply(){
    const tab = document.getElementById("tab-rules");
    if (!tab) return;

    // Ensure it isn't accidentally hidden
    tab.style.display = "";
    tab.style.visibility = "visible";

    const nav = pickNavContainer(tab) || tab.parentElement;
    if (!nav) return;

    // Make scrollable
    nav.style.overflowY = "auto";
    nav.style.maxHeight = "100vh";
    nav.style.webkitOverflowScrolling = "touch";

    // If nav is inside a fixed sidebar, also allow its parent to not clip
    if (nav.parentElement){
      nav.parentElement.style.overflow = "visible";
    }
    console.log("[VSP_NAV_SCROLL_AUTOFIX_V1] applied");
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", apply);
  } else {
    apply();
  }
  window.addEventListener("hashchange", apply);
})();

})();
/* ==== END: static/js/vsp_nav_scroll_autofix_v1.js ==== */

/* ==== BEGIN: static/js/vsp_overrides_v1.js ==== */
(function(){
'use strict';
/**
 * VSP Rule Overrides – render tab Overrides từ /api/vsp/overrides/list
 */
(function () {
  function fetchOverrides() {
    return fetch("/api/vsp/overrides/list")
      .then(function (res) {
        if (!res.ok) throw new Error("HTTP " + res.status);
        return res.json();
      })
      .catch(function (e) {
        console.error("[VSP][OVERRIDES] API error:", e);
        return { ok: false, items: [], metrics: {} };
      });
  }

  function renderTable(items) {
    var tbody = document.querySelector("#overrides-table tbody");
    if (!tbody) return;
    tbody.innerHTML = "";

    if (!items || !items.length) {
      var tr = document.createElement("tr");
      var td = document.createElement("td");
      td.colSpan = 5;
      td.textContent = "No overrides configured.";
      tr.appendChild(td);
      tbody.appendChild(tr);
      return;
    }

    items.forEach(function (it) {
      var tr = document.createElement("tr");

      function td(text) {
        var cell = document.createElement("td");
        cell.textContent = text == null ? "" : String(text);
        return cell;
      }

      tr.appendChild(td(it.tool));
      tr.appendChild(td(it.rule_id));
      tr.appendChild(td(it.scope));
      tr.appendChild(td(it.action));
      tr.appendChild(td(it.note));

      tbody.appendChild(tr);
    });
  }

  function renderMetrics(metrics) {
    var active = document.getElementById("ov-metric-active");
    var crit = document.getElementById("ov-metric-critical");
    var top = document.getElementById("ov-metric-top-rule");

    if (active) active.textContent = metrics.active_overrides ?? 0;
    if (crit) crit.textContent = metrics.critical_downgraded ?? 0;
    if (top) top.textContent = metrics.most_ignored_rule || "N/A";
  }

  function init() {
    var tab = document.getElementById("tab-overrides");
    if (!tab) return;

    fetchOverrides().then(function (data) {
      renderTable(data.items || []);
      renderMetrics(data.metrics || {});
    });
  }

  document.addEventListener("DOMContentLoaded", init);
})();

})();
/* ==== END: static/js/vsp_overrides_v1.js ==== */

/* ==== BEGIN: static/js/vsp_pane_toggle_safe_v1.js ==== */
(function(){
'use strict';
/* VSP_PANE_TOGGLE_SAFE_V1: hide non-active panes based on hash route */
(function(){
  'use strict';

  function routeFromHash(h){
    h = (h||'').trim();
    if (!h) return 'dashboard';
    if (h[0] === '#') h = h.slice(1);
    // strip query-ish fragments: #runs&x=y or #runs?x=y
    h = h.split('&')[0].split('?')[0].trim();
    return h || 'dashboard';
  }

  function firstExistingId(ids){
    for (const id of ids){
      const el = document.getElementById(id);
      if (el) return el;
    }
    return null;
  }

  function setPaneVisible(pane, on){
    if (!pane) return;
    pane.style.display = on ? '' : 'none';
    pane.setAttribute('data-vsp-pane-visible', on ? '1' : '0');
  }

  function apply(){
    try{
      const r = routeFromHash(location.hash);
      const map = {
        dashboard: ['pane-dashboard','dashboard-pane','vsp-pane-dashboard'],
        runs:      ['pane-runs','runs-pane','vsp-pane-runs'],
        datasource:['pane-datasource','datasource-pane','vsp-pane-datasource'],
        settings:  ['pane-settings','settings-pane','vsp-pane-settings'],
        rules:     ['pane-rules','rules-pane','vsp-pane-rules'],
      };

      // show/hide panes if they exist
      const panes = {};
      Object.keys(map).forEach(k => panes[k] = firstExistingId(map[k]));
      Object.keys(panes).forEach(k => setPaneVisible(panes[k], k === r));

      // also mark active tab if present
      document.querySelectorAll('.vsp-tab,[data-tab]').forEach(a=>{
        const t = (a.getAttribute('data-tab') || (a.getAttribute('href')||'').replace('#','')).split('&')[0].split('?')[0];
        if (!t) return;
        if (t === r) a.classList.add('is-active');
        else a.classList.remove('is-active');
      });
    }catch(e){
      try{ console.warn("[VSP_PANE_TOGGLE_SAFE_V1] apply failed", e); }catch(_){}
    }
  }

  window.addEventListener('hashchange', apply, {passive:true});
  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', apply);
  else apply();
})();

})();
/* ==== END: static/js/vsp_pane_toggle_safe_v1.js ==== */

/* ==== BEGIN: static/js/vsp_pane_toggle_safe_v2.js ==== */
(function(){
'use strict';
/* VSP_PANE_TOGGLE_SAFE_V2: show only active pane by hash route */
(function(){
  'use strict';

  function routeFromHash(){
    var h = (location.hash || '').trim();
    if (!h) return 'dashboard';
    if (h[0] === '#') h = h.slice(1);
    h = h.split('?')[0].split('&')[0];
    h = (h || 'dashboard').toLowerCase();
    if (h === '' ) h = 'dashboard';
    return h;
  }

  function collectPanes(){
    var panes = [];
    // common ids we used across patches
    var fixed = [
      'vsp-dashboard-main','vsp-runs-main','vsp-datasource-main','vsp-settings-main','vsp-rules-main',
      'vsp-dashboard-pane','vsp-runs-pane','vsp-datasource-pane','vsp-settings-pane','vsp-rules-pane'
    ];
    fixed.forEach(function(id){
      var el = document.getElementById(id);
      if (el) panes.push(el);
    });

    // generic: any container that looks like a pane
    var q = document.querySelectorAll('[id^="vsp-"][id$="-main"],[id^="vsp-"][id$="-pane"],.vsp-pane,[data-vsp-pane]');
    for (var i=0;i<q.length;i++) panes.push(q[i]);

    // unique
    var seen = new Set();
    var out = [];
    panes.forEach(function(el){
      if (!el || !el.id && !el.getAttribute) return;
      var key = el.id ? ("#"+el.id) : ("@"+(el.getAttribute('data-vsp-pane')||''));
      if (!seen.has(key)) { seen.add(key); out.push(el); }
    });
    return out;
  }

  function matchPane(route, panes){
    // try by id conventions
    var candidates = [
      'vsp-'+route+'-main',
      'vsp-'+route+'-pane'
    ];
    for (var i=0;i<candidates.length;i++){
      var el = document.getElementById(candidates[i]);
      if (el) return el;
    }
    // try by data attr
    for (var j=0;j<panes.length;j++){
      var p = panes[j];
      try{
        var dv = (p.getAttribute && (p.getAttribute('data-vsp-pane')||'')).toLowerCase();
        if (dv && dv === route) return p;
      }catch(_){}
    }
    return null;
  }

  function apply(){
    try{
      var route = routeFromHash();
      var panes = collectPanes();
      var active = matchPane(route, panes) || matchPane('dashboard', panes);

      panes.forEach(function(p){
        try{
          // hide all
          p.style.display = 'none';
          p.style.visibility = 'hidden';
        }catch(_){}
      });

      if (active){
        try{
          active.style.display = '';
          active.style.visibility = 'visible';
        }catch(_){}
      }

      try{ console.info("[VSP_PANES] route=", route, "panes=", panes.length, "active=", active && (active.id || active.getAttribute('data-vsp-pane'))); }catch(_){}
    }catch(_){}
  }

  function onReady(fn){
    if (document.readyState === 'complete' || document.readyState === 'interactive') return fn();
    document.addEventListener('DOMContentLoaded', fn);
  }

  onReady(function(){
    apply();
    window.addEventListener('hashchange', function(){ apply(); }, {passive:true});
    // sometimes router updates DOM after hashchange; apply again shortly
    setTimeout(apply, 50);
    setTimeout(apply, 250);
  });
})();

})();
/* ==== END: static/js/vsp_pane_toggle_safe_v2.js ==== */

/* ==== BEGIN: static/js/vsp_pane_toggle_safe_v3.js ==== */
(function(){
'use strict';
/* VSP_PANE_TOGGLE_SAFE_V3: show only active route pane; hide Dashboard block on non-dashboard routes */
(function(){
  'use strict';

  function routeFromHash(){
    let h = (location.hash||'').trim();
    if (!h) return 'dashboard';
    if (h[0]==='#') h=h.slice(1);
    h = h.split('&')[0].split('?')[0].split('/')[0].trim();
    if (!h) return 'dashboard';
    return h.toLowerCase();
  }

  function q(sel){ try{return document.querySelector(sel);}catch(_){return null;} }
  function qa(sel){ try{return Array.from(document.querySelectorAll(sel));}catch(_){return [];} }

  function findDashboardBlock(){
    // heuristic: heading text == "Dashboard"
    const hs = qa('h1,h2,h3');
    for (const h of hs){
      const t = (h.textContent||'').trim().toLowerCase();
      if (t === 'dashboard'){
        const blk = h.closest('section,div,main');
        if (blk) return blk;
      }
    }
    return null;
  }

  function paneFor(route){
    // panes created by router logs: #vsp-runs-main, #vsp-datasource-main, #vsp-settings-main, #vsp-rules-main
    return (
      q('#vsp-' + route + '-main') ||
      q('#' + route + '-main') ||
      q('#pane-' + route) ||
      q('[data-pane="'+route+'"]')
    );
  }

  function apply(){
    const route = routeFromHash();

    // hide/show router panes if present
    const routes = ['dashboard','runs','datasource','settings','rules'];
    const panes = {};
    for (const r of routes){
      panes[r] = paneFor(r);
    }

    // If we can identify a container, hide sibling panes
    const activePane = panes[route] || panes['dashboard'] || null;
    if (activePane && activePane.parentElement){
      const parent = activePane.parentElement;
      const kids = Array.from(parent.children || []);
      for (const el of kids){
        const id = (el.id||'');
        const isKnownPane = /(^|)vsp-(dashboard|runs|datasource|settings|rules)-main$/.test(id) || /(^|)(dashboard|runs|datasource|settings|rules)-main$/.test(id);
        if (isKnownPane){
          el.style.display = (el === activePane) ? '' : 'none';
        }
      }
    }

    // Additionally, hide the Dashboard block on non-dashboard routes (fix “#runs still shows dashboard”)
    const dashBlk = findDashboardBlock();
    if (dashBlk){
      dashBlk.style.display = (route === 'dashboard') ? '' : 'none';
    }
  }

  window.addEventListener('hashchange', apply, {passive:true});
  window.addEventListener('load', function(){ setTimeout(apply, 0); }, {once:true});
})();

})();
/* ==== END: static/js/vsp_pane_toggle_safe_v3.js ==== */

/* ==== BEGIN: static/js/vsp_patch_5tabs_v1.js ==== */
(function(){
'use strict';
// ======================================================================
// VSP_PATCH_5TABS_V1
// - Fix TOP IMPACTED CWE KPI (Dashboard)
// - Bind TAB 2: Runs & Reports (KPI + Run history table)
// - Bind TAB 3: Data Source (table + 2 chart)
//
// YÊU CẦU:
//   Dashboard:
//     <div data-vsp-kpi-top-cwe>...</div>
//
//   Runs tab:
//     KPI: data-vsp-runs-total, data-vsp-runs-last10,
//          data-vsp-runs-avg, data-vsp-runs-tools-per-run
//     Table: <tbody data-vsp-runs-tbody>...</tbody>
//
//   Data Source tab:
//     Table: <tbody data-vsp-ds-tbody>...</tbody>
//     Charts: <canvas id="vsp-ds-severity-donut">, <canvas id="vsp-ds-topcwe">
// ======================================================================

(function () {
  "use strict";

  function qs(sel) { return document.querySelector(sel); }

// ----------------------------------------------------------------------
// 1) DASHBOARD – TOP IMPACTED CWE
// ----------------------------------------------------------------------
  function vspPatchDashboardTopCwe() {
    var el = qs("[data-vsp-kpi-top-cwe]");
    if (!el) return;

    fetch("/api/vsp/dashboard_v3")
      .then(function (res) {
        if (!res.ok) throw new Error("HTTP " + res.status);
        return res.json();
      })
      .then(function (dash) {
        var hiId = null;
        if (Array.isArray(dash.top_cwe) &&
            dash.top_cwe.length &&
            typeof dash.top_cwe[0].id === "string") {
          hiId = dash.top_cwe[0].id;
        } else if (typeof dash.highest_impacted_cwe === "string") {
          hiId = dash.highest_impacted_cwe;
        } else if (dash.highest_impacted_cwe &&
                   typeof dash.highest_impacted_cwe.id === "string") {
          hiId = dash.highest_impacted_cwe.id;
        }
        el.textContent = hiId || "–";
        console.log("[VSP_PATCH][DASH] Top impacted CWE =", hiId);
      })
      .catch(function (err) {
        console.error("[VSP_PATCH][DASH] Error patching top CWE:", err);
      });
  }

// ----------------------------------------------------------------------
// 2) TAB 2 – RUNS & REPORTS
// ----------------------------------------------------------------------
  function vspPatchRunsTab() {
    var tbody = qs("[data-vsp-runs-tbody]");
    if (!tbody) {
      // không nằm ở tab Runs thì thôi
      return;
    }

    function formatDate(value) {
      if (!value) return "–";
      try {
        var d = new Date(value);
        if (isNaN(d.getTime())) return String(value);
        return d.toISOString().slice(0, 19).replace("T", " ");
      } catch (e) {
        return String(value);
      }
    }

    fetch("/api/vsp/runs_index_v3_fs?limit=50")
      .then(function (res) {
        if (!res.ok) throw new Error("HTTP " + res.status);
        return res.json();
      })
      .then(function (runs) {
        if (!Array.isArray(runs)) {
          console.warn("[VSP_PATCH][RUNS] Response không phải array:", runs);
          return;
        }

        console.log("[VSP_PATCH][RUNS] Loaded runs:", runs.length);

        // KPI cho last 10 runs
        var totalRuns = runs.length;
        var last10 = runs.slice(0, 10);
        var okCount = 0, failCount = 0;
        var totalFindings = 0;
        var totalTools = 0, toolsRuns = 0;

        last10.forEach(function (run) {
          if (run.status === "OK" || run.status === "SUCCESS") okCount++;
          else if (run.status === "FAIL" || run.status === "ERROR") failCount++;

          if (typeof run.total_findings === "number") {
            totalFindings += run.total_findings;
          }
          if (run.by_tool && typeof run.by_tool === "object") {
            totalTools += Object.keys(run.by_tool).length;
            toolsRuns++;
          }
        });

        var avgFindings = last10.length ? Math.round(totalFindings / last10.length) : 0;
        var avgTools    = toolsRuns ? (totalTools / toolsRuns).toFixed(1) : "0.0";

        var elTotal = qs("[data-vsp-runs-total]");
        var elLast  = qs("[data-vsp-runs-last10]");
        var elAvg   = qs("[data-vsp-runs-avg]");
        var elTools = qs("[data-vsp-runs-tools-per-run]");

        if (elTotal) elTotal.textContent = String(totalRuns);
        if (elLast)  elLast.textContent  = okCount + " / " + failCount;
        if (elAvg)   elAvg.textContent   = String(avgFindings);
        if (elTools) elTools.textContent = avgTools;

        // Bảng Run history
        tbody.innerHTML = "";
        if (!runs.length) {
          var trEmpty = document.createElement("tr");
          var tdEmpty = document.createElement("td");
          tdEmpty.colSpan = 13;
          tdEmpty.textContent = "No runs.";
          trEmpty.appendChild(tdEmpty);
          tbody.appendChild(trEmpty);
          return;
        }

        runs.forEach(function (run) {
          var tr = document.createElement("tr");
          function td(text) {
            var cell = document.createElement("td");
            cell.textContent = text;
            return cell;
          }

          var runId   = run.run_id || run.id || "–";
          var ts      = formatDate(run.started_at || run.timestamp || run.ts);
          var profile = run.profile || run.mode || "EXT+";
          var src     = run.src_path || run.root_dir || "–";
          var url     = run.target_url || "–";
          var sev     = run.by_severity || {};
          var crit    = sev.CRITICAL || 0;
          var high    = sev.HIGH || 0;
          var med     = sev.MEDIUM || 0;
          var low     = sev.LOW || 0;
          var info    = sev.INFO || 0;
          var trace   = sev.TRACE || 0;
          var total   = typeof run.total_findings === "number"
                        ? run.total_findings
                        : crit + high + med + low + info + trace;
          var tools   = run.by_tool ? Object.keys(run.by_tool).join(",")
                       : (run.tools || "–");

          tr.appendChild(td(runId));
          tr.appendChild(td(ts));
          tr.appendChild(td(profile));
          tr.appendChild(td(src));
          tr.appendChild(td(url));
          tr.appendChild(td(String(crit)));
          tr.appendChild(td(String(high)));
          tr.appendChild(td(String(med)));
          tr.appendChild(td(String(low)));
          tr.appendChild(td(String(info)));
          tr.appendChild(td(String(trace)));
          tr.appendChild(td(String(total)));
          tr.appendChild(td(tools));

          tbody.appendChild(tr);
        });
      })
      .catch(function (err) {
        console.error("[VSP_PATCH][RUNS] Error loading runs_index_v3:", err);
      });
  }

// ----------------------------------------------------------------------
// 3) TAB 3 – DATA SOURCE
// ----------------------------------------------------------------------
  function vspPatchDataSourceTab() {
    var tbody = qs("[data-vsp-ds-tbody]");
    if (!tbody) {
      return;
    }

    function renderTable(items) {
      tbody.innerHTML = "";
      if (!Array.isArray(items) || !items.length) {
        var trEmpty = document.createElement("tr");
        var tdEmpty = document.createElement("td");
        tdEmpty.colSpan = 10;
        tdEmpty.textContent = "No findings.";
        trEmpty.appendChild(tdEmpty);
        tbody.appendChild(trEmpty);
        return;
      }

      items.forEach(function (f) {
        var tr = document.createElement("tr");
        function td(text) {
          var cell = document.createElement("td");
          cell.textContent = text;
          return cell;
        }

        tr.appendChild(td(f.severity || "–"));
        tr.appendChild(td(f.tool || "–"));
        tr.appendChild(td(f.file || f.path || "–"));
        tr.appendChild(td(f.line != null ? String(f.line) : "–"));
        tr.appendChild(td(f.rule_id || f.rule || "–"));
        tr.appendChild(td(f.message || "–"));
        tr.appendChild(td(f.cwe || "–"));
        tr.appendChild(td(f.cve || "–"));
        tr.appendChild(td(f.module || "–"));
        tr.appendChild(td(Array.isArray(f.tags) ? f.tags.join(",") : (f.tags || "–")));

        tbody.appendChild(tr);
      });
    }

    function buildSeveritySummary(items) {
      var sev = { CRITICAL:0, HIGH:0, MEDIUM:0, LOW:0, INFO:0, TRACE:0 };
      items.forEach(function (f) {
        var s = (f.severity || "").toUpperCase();
        if (sev.hasOwnProperty(s)) sev[s]++;
      });
      return sev;
    }

    function buildTopCwe(items, limit) {
      var map = {};
      items.forEach(function (f) {
        var c = f.cwe || f.cwe_id;
        if (!c) return;
        map[c] = (map[c] || 0) + 1;
      });
      var arr = Object.keys(map).map(function (id) {
        return { id: id, count: map[id] };
      });
      arr.sort(function (a, b) { return b.count - a.count; });
      return arr.slice(0, limit || 8);
    }

    function renderSeverityDonut(sev) {
      var canvas = qs("#vsp-ds-severity-donut");
      if (!canvas || typeof Chart === "undefined") return;

      var labels = ["CRITICAL","HIGH","MEDIUM","LOW","INFO","TRACE"];
      var data   = labels.map(function (k) { return sev[k] || 0; });

      new Chart(canvas.getContext("2d"), {
        type: "doughnut",
        data: {
          labels: labels,
          datasets: [{ data: data }]
        },
        options: {
          plugins: { legend: { display: true } }
        }
      });
    }

    function renderTopCweBar(topCwe) {
      var canvas = qs("#vsp-ds-topcwe");
      if (!canvas || typeof Chart === "undefined") return;

      var labels = topCwe.map(function (c) { return c.id; });
      var counts = topCwe.map(function (c) { return c.count; });

      new Chart(canvas.getContext("2d"), {
        type: "bar",
        data: {
          labels: labels,
          datasets: [{ data: counts }]
        },
        options: {
          indexAxis: "y",
          plugins: { legend: { display: false } }
        }
      });
    }

    fetch("/api/vsp/datasource_v2?limit=500")
      .then(function (res) {
        if (!res.ok) throw new Error("HTTP " + res.status);
        return res.json();
      })
      .then(function (data) {
        var items = Array.isArray(data.items) ? data.items : [];
        console.log("[VSP_PATCH][DS] Loaded datasource_v2 items:", items.length);
        renderTable(items);

        var sev = buildSeveritySummary(items);
        renderSeverityDonut(sev);

        var topCwe = buildTopCwe(items, 8);
        renderTopCweBar(topCwe);
      })
      .catch(function (err) {
        console.error("[VSP_PATCH][DS] Error loading datasource_v2:", err);
      });
  }

// ----------------------------------------------------------------------
// INIT
// ----------------------------------------------------------------------
  document.addEventListener("DOMContentLoaded", function () {
    try {
      vspPatchDashboardTopCwe();
      vspPatchRunsTab();
      vspPatchDataSourceTab();
    } catch (err) {
      console.error("[VSP_PATCH] Init error:", err);
    }
  });

})();

})();
/* ==== END: static/js/vsp_patch_5tabs_v1.js ==== */

/* ==== BEGIN: static/js/vsp_patch_5tabs_v2.V1_baseline.js ==== */
(function(){
'use strict';
// ======================= VSP_PATCH_5TABS_V2_BASELINE_V1 =======================
//
// File này giữ vai trò "patch container" cho UI 5 tab.
// Hiện tại chỉ log nhẹ để tránh 404 / SyntaxError.
// Tất cả logic chính về dashboard, runs, datasource, settings, overrides
// đang được xử lý trong các file JS khác (vd: vsp_dashboard_live_v2.js, vsp_ui_main.js).
//
// Khi cần thêm patch mới (extras, top risk, noisy paths...), sẽ tạo file JS riêng.

document.addEventListener("DOMContentLoaded", () => {
  try {
    console.log("[VSP_PATCH_5TABS_V2] baseline loaded");
    // Chưa có patch bổ sung nào ở V1.
  } catch (err) {
    console.error("[VSP_PATCH_5TABS_V2][ERR]", err);
  }
});

})();
/* ==== END: static/js/vsp_patch_5tabs_v2.V1_baseline.js ==== */

/* ==== BEGIN: static/js/vsp_patch_5tabs_v2.js ==== */
(function(){
'use strict';
// ======================= VSP_PATCH_5TABS_V2_BASELINE_V1 =======================
//
// File này giữ vai trò "patch container" cho UI 5 tab.
// Hiện tại chỉ log nhẹ để tránh 404 / SyntaxError.
// Tất cả logic chính về dashboard, runs, datasource, settings, overrides
// đang được xử lý trong các file JS khác (vd: vsp_dashboard_live_v2.js, vsp_ui_main.js).
//
// Khi cần thêm patch mới (extras, top risk, noisy paths...), sẽ tạo file JS riêng.

document.addEventListener("DOMContentLoaded", () => {
  try {
    console.log("[VSP_PATCH_5TABS_V2] baseline loaded");
    // Chưa có patch bổ sung nào ở V1.
  } catch (err) {
    console.error("[VSP_PATCH_5TABS_V2][ERR]", err);
  }
});


// ======================= VSP_TOP_CWE_FIX_FROM_PATCH_V1 =======================
// Sau khi layout 5 tab load xong, sửa TOP IMPACTED CWE từ [object Object] thành mã CWE/id thật.
document.addEventListener("DOMContentLoaded", () => {
  // đợi mọi script khác chạy xong
  setTimeout(async () => {
    try {
      const res = await fetch("/api/vsp/dashboard_v3");
      const data = await res.json();
      if (!data.ok) {
        console.warn("[VSP_TOP_CWE_FIX] dashboard_v3 not ok");
        return;
      }

      const top = (data.top_cwe && data.top_cwe[0]) || null;
      const val = (top && (top.cwe || top.id)) || "–";

      let replaced = 0;
      const nodes = document.querySelectorAll("span,div,strong,h1,h2,h3,p");

      nodes.forEach(el => {
        const t = (el.textContent || "").trim();
        if (t === "[object Object]") {
          el.textContent = val;
          replaced++;
        }
      });

      console.log("[VSP_TOP_CWE_FIX] replaced", replaced, "node(s) with", val);
    } catch (e) {
      console.warn("[VSP_TOP_CWE_FIX] error", e);
    }
  }, 1500);
});


// ======================= VSP_TOP_RISK_EMPTY_MSG_V1 =======================
// Nếu bảng Top risk findings không có hàng dữ liệu CRIT/HIGH,
// hiển thị 1 dòng message rõ ràng.
document.addEventListener("DOMContentLoaded", () => {
  setTimeout(() => {
    try {
      // Ưu tiên body có id rõ ràng
      let body = document.getElementById("tbl-top-risk-body");

      // Nếu không có thì tìm table có chứa text 'Top risk findings'
      if (!body) {
        const tables = document.querySelectorAll("table");
        tables.forEach(tbl => {
          const txt = (tbl.textContent || "").toUpperCase();
          if (txt.includes("TOP RISK FINDINGS") && !body) {
            body = tbl.querySelector("tbody") || tbl;
          }
        });
      }

      if (!body) return;

      const rows = Array.from(body.querySelectorAll("tr"));
      const hasData = rows.some(tr => {
        const t = (tr.textContent || "").trim();
        if (!t) return false;
        const upper = t.toUpperCase();
        if (upper.includes("SEVERITY") && upper.includes("TOOL")) return false;
        if (t == "-" || t == "–" || t == "- - - -") return false;
        return True;
      });

      if (hasData) return;

      body.innerHTML = `
        <tr>
          <td colspan="5" style="text-align:center; color:#ccc;">
            No critical/high findings in this run (all findings are MED/LOW/INFO/TRACE).
          </td>
        </tr>
      `;
      console.log("[VSP_TOP_RISK_EMPTY_MSG] injected message row");
    } catch (e) {
      console.warn("[VSP_TOP_RISK_EMPTY_MSG] error", e);
    }
  }, 1600);
});

})();
/* ==== END: static/js/vsp_patch_5tabs_v2.js ==== */

/* ==== BEGIN: static/js/vsp_rid_state_v1.js ==== */
(function(){
'use strict';
/* VSP_RID_STATE_V10 (commercial stable) */
(function(){
  'use strict';

  const LOGP = '[VSP_RID_STATE_V10]';
  const LS_SELECTED = 'vsp_rid_selected_v1';
  const LS_LATEST   = 'vsp_rid_latest_v1';
  const RID_KEYS_QS = ['rid','run_id','runid'];

  function safeLSGet(k){
    try { return localStorage.getItem(k); } catch(e){ return null; }
  }
  function safeLSSet(k,v){
    try { localStorage.setItem(k, v); } catch(e){}
  }

  function qsRid(){
    try{
      const u = new URL(window.location.href);
      for(const k of RID_KEYS_QS){
        const v = u.searchParams.get(k);
        if(v && String(v).trim()) return String(v).trim();
      }
    }catch(e){}
    return null;
  }

  function getRid(){
    return qsRid() || safeLSGet(LS_SELECTED) || safeLSGet(LS_LATEST) || null;
  }

  function updateBadge(rid){
    const txt = `RID: ${rid || '(none)'}`;

    // common ids
    const ids = ['vsp-rid-badge','rid-badge','vsp_rid_badge','vspRidBadge'];
    for(const id of ids){
      const el = document.getElementById(id);
      if(el){ el.textContent = txt; return; }
    }

    // common classes / data attributes
    const el2 = document.querySelector('[data-vsp-rid-badge], .vsp-rid-badge, .rid-badge');
    if(el2){ el2.textContent = txt; return; }

    // fallback: any small element whose text starts with "RID:"
    const all = document.querySelectorAll('body *');
    for(const el of all){
      const t = (el.textContent || '').trim();
      if(t.startsWith('RID:') && t.length < 80){
        el.textContent = txt;
        return;
      }
    }
  }

  function setRid(rid, why){
    const v = (rid && String(rid).trim()) ? String(rid).trim() : null;
    if(!v) return null;
    safeLSSet(LS_SELECTED, v);
    safeLSSet(LS_LATEST, v);
    updateBadge(v);

    try{
      window.dispatchEvent(new CustomEvent('VSP_RID_CHANGED', { detail: { rid: v, why: why || 'set' } }));
    }catch(e){}
    return v;
  }

  async function pickLatestFromRunsIndex(){
    const url = '/api/vsp/runs_index_v3_fs_resolved?limit=1&hide_empty=0&filter=1';
    const r = await fetch(url, { cache: 'no-store' });
    if(!r.ok) throw new Error('runs_index not ok: ' + r.status);
    const j = await r.json();
    const it = (j && j.items && j.items[0]) ? j.items[0] : null;
    const rid = it && (it.run_id || it.rid || it.id);
    if(rid && String(rid).trim()) return String(rid).trim();
    return null;
  }

  async function pickLatest(){
    // 1) optional override: MUST return string RID or null
    try{
      const ov = window.VSP_RID_PICKLATEST_OVERRIDE_V1;
      if(typeof ov === 'function'){
        const v = await ov();
        if(typeof v === 'string' && v.trim()){
          console.log(LOGP, 'picked by override');
          return setRid(v.trim(), 'override');
        }
      }
    }catch(e){
      console.warn(LOGP, 'override failed', e);
    }

    // 2) default: runs_index
    try{
      const rid = await pickLatestFromRunsIndex();
      if(rid){
        console.log(LOGP, 'picked by runs_index', rid);
        return setRid(rid, 'runs_index');
      }
    }catch(e){
      console.warn(LOGP, 'runs_index pickLatest failed', e);
    }

    return null;
  }

  async function ensure(){
    const cur = getRid();
    updateBadge(cur);
    if(cur) return cur;
    return await pickLatest();
  }

  // compatibility exports
  window.VSP_RID_GET = getRid;
  window.VSP_RID_SET = (rid)=>setRid(rid,'manual');
  window.VSP_RID_PICKLATEST = pickLatest;

  document.addEventListener('DOMContentLoaded', ()=>{ ensure(); });
  console.log(LOGP, 'installed');
})();

})();
/* ==== END: static/js/vsp_rid_state_v1.js ==== */

/* ==== BEGIN: static/js/vsp_rules_bind_v1.js ==== */
(function(){
'use strict';
(function () {
  function onReady(fn) {
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", fn);
    } else {
      fn();
    }
  }

  function $(id) {
    return document.getElementById(id);
  }

  async function loadRuleOverrides() {
    console.log("[VSP_RULES] init loadRuleOverrides()");

    var table = $("vsp-rules-table");
    if (!table) {
      console.log("[VSP_RULES] Không thấy #vsp-rules-table trong DOM, bỏ qua.");
      return;
    }

    var tbody = table.querySelector("tbody");
    if (!tbody) return;

    var url = "/api/vsp/rule_overrides/get";

    try {
      var resp = await fetch(url, { credentials: "same-origin" });
      console.log("[VSP_RULES] fetch " + url + " ->", resp.status);

      if (!resp.ok) {
        console.warn("[VSP_RULES] Backend rule overrides lỗi HTTP:", resp.status);
        return;
      }

      var data = await resp.json();
      console.log("[VSP_RULES] Loaded overrides JSON:", data);

      var items = data.items || [];

      // Bảng rules
      tbody.innerHTML = "";
      if (!Array.isArray(items) || !items.length) {
        var trEmpty = document.createElement("tr");
        trEmpty.className = "vsp-rules-row-placeholder";
        trEmpty.innerHTML =
          '<td colspan="5"><span class="vsp-muted">' +
          "Không có rule override nào trong cấu hình hiện tại." +
          "</span></td>";
        tbody.appendChild(trEmpty);
      } else {
        items.forEach(function (r) {
          var tr = document.createElement("tr");
          var ruleId = r.rule_id || r.id || "";
          var tool = r.tool || "";
          var match = r.match || r.when || "";
          var action = r.action || r.effect || "";
          var notes = r.notes || r.comment || "";

          tr.innerHTML =
            "<td>" + ruleId + "</td>" +
            "<td>" + tool + "</td>" +
            "<td>" + match + "</td>" +
            "<td>" + action + "</td>" +
            "<td>" + notes + "</td>";
          tbody.appendChild(tr);
        });
      }

      // KPI
      var total = (typeof data.total === "number") ? data.total : items.length;
      var active = (typeof data.active === "number") ? data.active : items.filter(function (r) {
        return r.enabled !== false && r.disabled !== true;
      }).length;
      var disabled = (typeof data.disabled === "number") ? data.disabled : (total - active);

      if ($("vsp-rules-total")) $("vsp-rules-total").textContent = String(total);
      if ($("vsp-rules-active")) $("vsp-rules-active").textContent = String(active);
      if ($("vsp-rules-disabled")) $("vsp-rules-disabled").textContent = String(disabled);

      // Profile / config path
      if ($("vsp-rules-profile-label") && data.profile) {
        $("vsp-rules-profile-label").textContent = data.profile;
      }
      if ($("vsp-rules-config-path") && data.config_path) {
        $("vsp-rules-config-path").textContent = data.config_path;
      }

      // raw JSON preview
      if ($("vsp-rules-raw-json")) {
        var raw = data.raw || data;
        $("vsp-rules-raw-json").textContent = JSON.stringify(raw, null, 2);
      }
    } catch (err) {
      console.warn("[VSP_RULES] Lỗi khi load rule overrides:", err);
    }
  }

  onReady(loadRuleOverrides);
})();

})();
/* ==== END: static/js/vsp_rules_bind_v1.js ==== */

/* ==== BEGIN: static/js/vsp_rules_editor_v1.js ==== */
(function(){
'use strict';
(function () {
  console.log("[VSP_RULES_EDITOR] vsp_rules_editor_v1.js loaded (v4)");

  var WRAPPER_ID = "vsp-rules-editor-root";

  // ==== helper: show/hide editor theo tab ====
  function setEditorVisibility() {
    var root = document.getElementById(WRAPPER_ID);
    if (!root) return;
    if (location.hash === "#rules") {
      root.style.display = "";
    } else {
      root.style.display = "none";
    }
  }

  // ==== tìm đúng pane Rules ====
  function findRulesPane() {
    var pane =
      document.getElementById("vsp-tab-rules-main") ||
      document.querySelector("[data-vsp-pane='rules']") ||
      document.querySelector("#vsp-tab-rules") ||
      document.querySelector(".vsp-pane-rules");

    if (pane) {
      console.log("[VSP_RULES_EDITOR] Found rules pane (by id/class).");
      return pane;
    }

    // Fallback: block có text RULE OVERRIDES (chỉ chạy khi đang ở #rules)
    var nodes = Array.from(document.querySelectorAll("section, div, main"));
    var marker = nodes.find(function (el) {
      var t = (el.textContent || "").toUpperCase();
      return t.includes("RULE OVERRIDES") && !t.includes("RUN SCAN NOW");
    });

    if (marker) {
      pane =
        marker.closest(".vsp-pane") ||
        marker.closest("section") ||
        marker.closest("div");
      if (pane) {
        console.log("[VSP_RULES_EDITOR] Found rules pane via text marker.");
        return pane;
      }
    }

    console.warn("[VSP_RULES_EDITOR] Không thấy pane Rules.");
    return null;
  }

  async function fetchOverrides() {
    const resp = await fetch("/api/vsp/rule_overrides_ui_v1");
    if (!resp.ok) throw new Error("HTTP " + resp.status);
    return await resp.json();
  }

  async function saveOverrides(jsonText) {
    let obj;
    try {
      obj = JSON.parse(jsonText);
    } catch (e) {
      alert("JSON không hợp lệ: " + e.message);
      throw e;
    }
    const resp = await fetch("/api/vsp/rule_overrides_save_v1", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(obj),
    });
    const data = await resp.json();
    if (!resp.ok || !data.ok) {
      throw new Error(data.error || resp.statusText);
    }
    return data;
  }

  async function initEditor() {
    if (location.hash !== "#rules") {
      setEditorVisibility();
      return;
    }

    var pane = findRulesPane();
    if (!pane) return;

    // Nếu đã có wrapper thì chỉ bật visible rồi thoát
    var existing = document.getElementById(WRAPPER_ID);
    if (existing) {
      setEditorVisibility();
      return;
    }

    let data;
    try {
      data = await fetchOverrides();
    } catch (e) {
      console.error("[VSP_RULES_EDITOR] Lỗi fetch overrides:", e);
      return;
    }

    var items = (data && data.items) || data.overrides || [];

    var root = document.createElement("div");
    root.id = WRAPPER_ID;
    root.className = "vsp-grid vsp-grid-2";
    root.style.marginTop = "24px";
    root.style.gap = "24px";

    var left = document.createElement("div");
    left.className = "vsp-card";
    left.innerHTML = `
      <div class="vsp-card-title">Rule list / summary</div>
      <p class="vsp-card-subtitle">Tóm tắt overrides (severity mới, tool, scope,...)</p>
      <div class="vsp-table-wrapper" style="max-height:360px; overflow:auto;">
        <table class="vsp-table" id="vsp-rules-table">
          <thead>
            <tr>
              <th>#</th>
              <th>Rule ID / Query ID</th>
              <th>New severity</th>
              <th>Tool</th>
              <th>Note</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    `;

    var right = document.createElement("div");
    right.className = "vsp-card";
    right.innerHTML = `
      <div class="vsp-card-title">Rule Overrides JSON</div>
      <p class="vsp-card-subtitle">Chỉnh JSON trực tiếp. Save sẽ ghi out/vsp_rule_overrides_v1.json</p>
      <textarea id="vsp-rules-json-editor" style="width:100%; min-height:260px; font-family:monospace; font-size:12px;"></textarea>
      <div style="margin-top:12px; display:flex; gap:8px;">
        <button id="vsp-rules-format" class="vsp-btn-secondary">Format JSON</button>
        <button id="vsp-rules-save" class="vsp-btn-primary">Save (apply)</button>
      </div>
      <p id="vsp-rules-status" style="margin-top:8px; font-size:12px; opacity:0.8;"></p>
    `;

    root.appendChild(left);
    root.appendChild(right);
    pane.appendChild(root);

    // Fill table
    var tbody = left.querySelector("tbody");
    if (tbody && Array.isArray(items)) {
      items.forEach(function (item, idx) {
        var tr = document.createElement("tr");
        var ruleId = item.rule_id || item.query_id || item.id || "";
        var sev = item.new_severity || item.severity || "";
        var tool = item.tool || item.engine || "";
        var note = item.note || item.reason || "";
        tr.innerHTML = `
          <td>${idx + 1}</td>
          <td>${ruleId}</td>
          <td>${sev}</td>
          <td>${tool}</td>
          <td>${note}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // JSON editor
    var editor = document.getElementById("vsp-rules-json-editor");
    var status = document.getElementById("vsp-rules-status");
    if (editor) {
      editor.value = JSON.stringify(data, null, 2);
    }

    var formatBtn = document.getElementById("vsp-rules-format");
    var saveBtn = document.getElementById("vsp-rules-save");

    if (formatBtn && editor) {
      formatBtn.addEventListener("click", function () {
        try {
          var obj = JSON.parse(editor.value);
          editor.value = JSON.stringify(obj, null, 2);
          status.textContent = "Đã format JSON.";
        } catch (e) {
          alert("JSON không hợp lệ: " + e.message);
        }
      });
    }

    if (saveBtn && editor) {
      saveBtn.addEventListener("click", async function () {
        saveBtn.disabled = true;
        saveBtn.textContent = "Saving...";
        status.textContent = "";
        try {
          var res = await saveOverrides(editor.value);
          status.textContent = "Đã lưu: " + res.path;
        } catch (e) {
          console.error(e);
          status.textContent = "Save failed: " + e.message;
          alert("Save failed: " + e.message);
        } finally {
          saveBtn.disabled = false;
          saveBtn.textContent = "Save (apply)";
        }
      });
    }

    setEditorVisibility();
  }

  // ==== wiring ====
  document.addEventListener("DOMContentLoaded", function () {
    setEditorVisibility();
    if (location.hash === "#rules") {
      setTimeout(initEditor, 200);
    }
  });

  window.addEventListener("hashchange", function () {
    setEditorVisibility();
    if (location.hash === "#rules") {
      setTimeout(initEditor, 200);
    }
  });
})();

})();
/* ==== END: static/js/vsp_rules_editor_v1.js ==== */

/* ==== BEGIN: static/js/vsp_rules_editor_v2.js ==== */
(function(){
'use strict';
(function () {
  console.log("[VSP_RULES] vsp_rules_editor_v2.js loaded");

  const tbody = document.getElementById("vsp-rules-table-body");
  const btnAdd = document.getElementById("vsp-rules-add");
  const btnDelete = document.getElementById("vsp-rules-delete");
  const btnValidate = document.getElementById("vsp-rules-validate");
  const btnSave = document.getElementById("vsp-rules-save");
  const txtJson = document.getElementById("vsp-rules-json");

  let rules = [];

  function renderTable() {
    if (!tbody) return;
    tbody.innerHTML = "";
    rules.forEach((r, idx) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><input type="checkbox" data-index="${idx}"></td>
        <td contenteditable="true" data-field="id" data-index="${idx}">${r.id || ""}</td>
        <td contenteditable="true" data-field="tool" data-index="${idx}">${r.tool || ""}</td>
        <td contenteditable="true" data-field="severity" data-index="${idx}">${r.severity || ""}</td>
        <td contenteditable="true" data-field="pattern" data-index="${idx}">${r.pattern || r.rule_id || ""}</td>
        <td contenteditable="true" data-field="scope" data-index="${idx}">${r.scope || ""}</td>
        <td contenteditable="true" data-field="enabled" data-index="${idx}">${r.enabled === false ? "false" : "true"}</td>
      `;
      tbody.appendChild(tr);
    });
    updateJson();
  }

  function updateJson() {
    if (!txtJson) return;
    txtJson.value = JSON.stringify({items: rules}, null, 2);
  }

  function syncFromJson() {
    if (!txtJson) return;
    try {
      const obj = JSON.parse(txtJson.value || "{}");
      if (!obj.items || !Array.isArray(obj.items)) {
        alert("JSON phải có field items là array");
        return;
      }
      rules = obj.items;
      renderTable();
    } catch (e) {
      alert("JSON không hợp lệ: " + e);
    }
  }

  function onCellInput(e) {
    const el = e.target;
    const idx = parseInt(el.getAttribute("data-index"), 10);
    const field = el.getAttribute("data-field");
    if (!Number.isInteger(idx) || !field) return;
    const val = el.innerText.trim();
    if (!rules[idx]) return;

    if (field === "enabled") {
      rules[idx][field] = !(val.toLowerCase() === "false" || val === "0");
    } else {
      rules[idx][field] = val;
    }
    updateJson();
  }

  function addRule() {
    rules.push({
      id: "RULE_" + (rules.length + 1),
      tool: "",
      severity: "MEDIUM",
      pattern: "",
      scope: "",
      enabled: true
    });
    renderTable();
  }

  function deleteSelected() {
    const checkboxes = tbody.querySelectorAll("input[type='checkbox'][data-index]");
    const toDelete = [];
    checkboxes.forEach(cb => {
      if (cb.checked) {
        toDelete.push(parseInt(cb.getAttribute("data-index"), 10));
      }
    });
    if (toDelete.length === 0) return;
    rules = rules.filter((_, idx) => !toDelete.includes(idx));
    renderTable();
  }

  function validateRules() {
    for (let i = 0; i < rules.length; i++) {
      const r = rules[i];
      if (!r.id || !r.tool || !r.severity) {
        alert(`Rule #${i + 1} thiếu id/tool/severity`);
        return;
      }
    }
    alert("Validate OK");
  }

  async function saveRules() {
    try {
      validateRules();
    } catch {
      return;
    }
    try {
      const resp = await fetch("/api/vsp/rule_overrides_ui_v1", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({items: rules})
      });
      const data = await resp.json();
      if (!resp.ok || !data.ok) {
        alert("Save failed: " + (data.error || resp.statusText));
        return;
      }
      alert("Saved OK. items_count=" + data.items_count);
    } catch (err) {
      console.error("[VSP_RULES] save error", err);
      alert("Save failed (network error)");
    }
  }

  async function loadInitial() {
    try {
      const resp = await fetch("/api/vsp/rule_overrides_ui_v1");
      const data = await resp.json();
      if (!resp.ok) {
        console.error("[VSP_RULES] load error", data);
        return;
      }
      const items = data.items || data.data || data.rule_overrides || [];
      rules = Array.isArray(items) ? items : [];
      renderTable();
    } catch (err) {
      console.error("[VSP_RULES] loadInitial error", err);
    }
  }

  if (tbody) {
    tbody.addEventListener("input", onCellInput);
  }
  if (btnAdd) btnAdd.addEventListener("click", addRule);
  if (btnDelete) btnDelete.addEventListener("click", deleteSelected);
  if (btnValidate) btnValidate.addEventListener("click", validateRules);
  if (btnSave) btnSave.addEventListener("click", saveRules);
  if (txtJson) {
    txtJson.addEventListener("change", syncFromJson);
  }

  document.addEventListener("DOMContentLoaded", loadInitial);
})();

})();
/* ==== END: static/js/vsp_rules_editor_v2.js ==== */

/* ==== BEGIN: static/js/vsp_rules_tab_simple_v1.js ==== */
(function(){
'use strict';
(function () {
  var API_URL = "/api/vsp/rule_overrides_ui_v1";
  var hydrated = false;

  function hydratePane() {
    if (hydrated) return;
    var pane = document.getElementById("vsp-tab-rules");
    if (!pane) return;

    hydrated = true;

    pane.innerHTML =
      '<div class="vsp-section-header">' +
        '<div>' +
          '<h2 class="vsp-section-title">Rule Overrides</h2>' +
          '<p class="vsp-section-subtitle">Mapping / override rule (rule_overrides_ui_v1)</p>' +
        '</div>' +
      '</div>' +
      '<div class="vsp-card">' +
        '<pre id="vsp-rules-pre">{\n  "ok": false,\n  "items": []\n}</pre>' +
      '</div>';

    var pre = document.getElementById("vsp-rules-pre");
    if (!pre) return;

    fetch(API_URL, { cache: "no-store" })
      .then(function (res) { return res.json(); })
      .then(function (data) {
        console.log("[VSP_RULES_TAB_V2] rule_overrides_ui_v1 loaded.", data);
        try {
          pre.textContent = JSON.stringify(data, null, 2);
        } catch (e) {
          pre.textContent = "Lỗi format JSON rule_overrides_ui_v1.";
        }
      })
      .catch(function (err) {
        console.error("[VSP_RULES_TAB_V2] Failed to load rule_overrides_ui_v1:", err);
        pre.textContent = "Lỗi gọi API rule_overrides_ui_v1.";
      });
  }

  window.vspInitRulesTab = hydratePane;

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", hydratePane);
  } else {
    hydratePane();
  }
})();

})();
/* ==== END: static/js/vsp_rules_tab_simple_v1.js ==== */

/* ==== BEGIN: static/js/vsp_rules_tab_v1.js ==== */
(function(){
'use strict';
(function () {
  const API_URL = '/api/vsp/rule_overrides_ui_v1';
  const INIT_DELAY_MS = 1200;

  function esc(s) {
    if (s == null) return '';
    return String(s)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;');
  }

  function renderSkeleton(tab) {
    tab.innerHTML = `
      <div class="vsp-tab-inner vsp-tab-rules">
        <div class="vsp-tab-header">
          <h2>Rule Overrides</h2>
          <p class="vsp-tab-subtitle">
            Quản lý các rule đã được chấp nhận rủi ro hoặc điều chỉnh severity. Dùng để giảm “noise”
            nhưng vẫn giữ được trace đầy đủ.
          </p>
        </div>

        <div class="vsp-card vsp-card-note">
          <p>
            Cơ chế rule overrides giúp:
          </p>
          <ul class="vsp-list">
            <li>Hạ severity cho một số rule đã được kiểm soát bằng biện pháp khác.</li>
            <li>Ẩn các findings đã được chấp nhận rủi ro nhưng vẫn lưu trong log để truy vết.</li>
            <li>Import/export bộ rule để áp dụng cho nhiều project.</li>
          </ul>
        </div>

        <div class="vsp-card vsp-table-card">
          <div class="vsp-table-header">
            <div>
              <h3>Current overrides</h3>
              <p class="vsp-table-subtitle">
                Danh sách rule override đang được áp dụng (theo tool, rule, CWE, action).
              </p>
            </div>
          </div>

          <div class="vsp-table-wrapper">
            <table class="vsp-table" id="vsp-rules-table">
              <thead>
                <tr>
                  <th>Tool</th>
                  <th>Rule ID</th>
                  <th>CWE</th>
                  <th>Action</th>
                  <th>Target</th>
                  <th>Reason</th>
                </tr>
              </thead>
              <tbody>
                <tr><td colspan="6" class="vsp-table-loading">Đang tải danh sách rule overrides…</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    `;
  }

  async function bindRules(tab) {
    renderSkeleton(tab);

    const tbody = tab.querySelector('#vsp-rules-table tbody');
    if (!tbody) return;

    let data;
    try {
      const res = await fetch(API_URL, { cache: 'no-store' });
      data = await res.json();
    } catch (e) {
      console.error('[VSP_RULES_TAB] Failed to load rule_overrides_ui_v1', e);
      tbody.innerHTML = `<tr><td colspan="6" class="vsp-table-error">
        Không tải được rule overrides từ API.
      </td></tr>`;
      return;
    }

    const items = Array.isArray(data.overrides)
      ? data.overrides
      : Array.isArray(data) ? data : [];

    if (!items.length) {
      tbody.innerHTML = `<tr><td colspan="6" class="vsp-table-empty">
        Hiện chưa có rule override nào. Hệ thống đang dùng rule mặc định của các tool.
      </td></tr>`;
      return;
    }

    tbody.innerHTML = items.map(o => {
      const tool = o.tool || '-';
      const ruleId = o.rule_id || o.id || '-';
      const cwe = o.cwe || o.cwe_id || '-';
      const action = o.action || o.mode || '-';
      const target = o.target || o.path || o.module || '-';
      const reason = o.reason || o.note || '-';

      return `
        <tr>
          <td>${esc(tool)}</td>
          <td>${esc(ruleId)}</td>
          <td>${esc(cwe)}</td>
          <td>${esc(action)}</td>
          <td class="vsp-mono">${esc(target)}</td>
          <td>${esc(reason)}</td>
        </tr>
      `;
    }).join('');

    console.log('[VSP_RULES_TAB] Rendered', items.length, 'rule overrides.');
  }

  let initialized = false;

  function tryInit() {
    if (initialized) return;
    const tab = document.querySelector('#vsp-tab-rules');
    if (!tab) {
      setTimeout(tryInit, 500);
      return;
    }
    initialized = true;
    setTimeout(() => bindRules(tab), INIT_DELAY_MS);
  }

  tryInit();
})();

})();
/* ==== END: static/js/vsp_rules_tab_v1.js ==== */

/* ==== BEGIN: static/js/vsp_rules_v2.js ==== */
(function(){
'use strict';
// === VSP RULE OVERRIDES – FIX V3 ===

function loadRules() {
  fetch("/api/vsp/rules/get")
    .then(r => r.json())
    .then(json => {
      if (!json.ok) return;

      const tbody = $("#rules-body");
      tbody.empty();

      json.items.forEach(rule => {
        const sev = rule.severity_effective.toLowerCase();
        tbody.append(`
          <tr>
            <td>${rule.tool}</td>
            <td>${rule.rule_id}</td>
            <td>${rule.severity_raw}</td>
            <td class="sev-${sev}">${rule.severity_effective}</td>
            <td>${rule.reason || "-"}</td>
          </tr>
        `);
      });
    })
    .catch(err => console.error("[RULES] Error", err));
}

document.addEventListener("DOMContentLoaded", loadRules);

})();
/* ==== END: static/js/vsp_rules_v2.js ==== */

/* ==== BEGIN: static/js/vsp_run_full_ext_v1.js ==== */
(function(){
'use strict';
// === VSP RUN FULL EXT+ – FIX V2 ===

console.log("[VSP_RUN][FULL_EXT] vsp_run_full_ext_v1.js loaded");

function vspGetRunSrc() {
  // Thử lần lượt vài ID phổ biến trong TAB 4
  let el =
    document.querySelector("#vsp_run_full_src") ||
    document.querySelector("#vsp_run_src") ||
    document.querySelector("#vsp_run_full_src_path") ||
    document.querySelector("#trigger_full_src");

  if (!el) {
    console.warn("[VSP_RUN][FULL_EXT] Không tìm thấy input SRC trong DOM");
    return "";
  }
  return (el.value || "").trim();
}

function vspRunFullExtFromUI() {
  const src = vspGetRunSrc();

  if (!src) {
    alert("Hãy nhập SRC path trước khi chạy FULL EXT+.");
    return;
  }

  console.log("[VSP_RUN][FULL_EXT] Gửi run_full_ext với src =", src);

  fetch("/api/vsp/run_full_ext", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ src: src })
  })
    .then(async (resp) => {
      const text = await resp.text();
      let data = null;
      try {
        data = JSON.parse(text);
      } catch (e) {
        console.warn("[VSP_RUN][FULL_EXT] Body không phải JSON thuần:", text);
      }

      console.log(
        "[VSP_RUN][FULL_EXT] Response",
        "status=", resp.status,
        "data=", data || text
      );

      if (!resp.ok || !data || data.ok === false) {
        const msg = (data && data.error) || text || ("HTTP " + resp.status);
        alert("Run FULL EXT+ FAILED: " + msg);
        return;
      }

      alert("Run FULL EXT+ STARTED: " + (data.run_id || "OK"));
    })
    .catch((err) => {
      console.error("[VSP_RUN][FULL_EXT] Fetch error", err);
      alert("Run FULL EXT+ error (xem console).");
    });
}

// bind nút "Run now"
document.addEventListener("DOMContentLoaded", function () {
  const btn =
    document.querySelector("#vsp_run_full_btn") ||
    document.querySelector("#trigger_full_run_btn");

  if (!btn) {
    console.warn("[VSP_RUN][FULL_EXT] Không tìm thấy button Run now trong DOM");
    return;
  }

  btn.addEventListener("click", function (ev) {
    ev.preventDefault();
    vspRunFullExtFromUI();
  });
});

})();
/* ==== END: static/js/vsp_run_full_ext_v1.js ==== */

/* ==== BEGIN: static/js/vsp_run_full_scan_v1.js ==== */
(function(){
'use strict';
/**
 * JS trigger FULL SCAN from UI.
 */

(function () {
  console.log("[VSP_RUN_FULL] vsp_run_full_scan_v1.js loaded.");

  var btn = document.getElementById("vsp-btn-run-full-scan");
  if (!btn) {
    console.warn("[VSP_RUN_FULL] Button #vsp-btn-run-full-scan not found");
    return;
  }

  btn.addEventListener("click", function (e) {
    e.preventDefault();

    var payload = {
      profile: "FULL_EXT",
      source_root: null,
      target_url: null
    };

    fetch("/api/vsp/run_full_scan", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    })
      .then(function (res) {
        if (!res.ok) throw new Error("HTTP " + res.status);
        return res.json();
      })
      .then(function (data) {
        console.log("[VSP_RUN_FULL] Scan started:", data);
        alert("FULL SCAN STARTED\nPID: " + data.pid + "\nCMD: " + data.cmd);
      })
      .catch(function (err) {
        console.error("[VSP_RUN_FULL] ERROR:", err);
        alert("Failed to start FULL scan: " + err);
      });
  });
})();

})();
/* ==== END: static/js/vsp_run_full_scan_v1.js ==== */

/* ==== BEGIN: static/js/vsp_run_fullscan_v1.js ==== */
(function(){
'use strict';
(function () {
  'use strict';

  function $(sel) {
    return document.querySelector(sel);
  }

  function getValue(selector, fallback) {
    var el = $(selector);
    if (!el) return fallback;
    var v = (el.value || el.textContent || '').trim();
    return v || fallback;
  }

  function setStatus(text, isError) {
    var statusEl = $('#vsp-run-fullscan-status');
    if (!statusEl) return;
    statusEl.textContent = text;
    statusEl.classList.remove('status-ok', 'status-err');
    statusEl.classList.add(isError ? 'status-err' : 'status-ok');
  }

  async function handleRunFullScan(ev) {
    ev.preventDefault();

    var btn = ev.currentTarget;
    var profile = getValue('#vsp-scan-profile', 'FULL_EXT');
    var sourceRoot = getValue('#vsp-scan-source-root', '');
    var targetUrl = getValue('#vsp-scan-target-url', '');

    if (!sourceRoot || !targetUrl) {
      setStatus('Vui lòng điền đủ Source Root và Target URL trước khi chạy.', true);
      return;
    }

    // Disable button + đổi text
    btn.disabled = true;
    if (!btn.dataset.originalText) {
      btn.dataset.originalText = btn.textContent;
    }
    btn.textContent = 'Đang gửi FULL scan...';
    setStatus('Đang gọi /api/vsp/run_full_scan ...', false);

    try {
      var res = await fetch('/api/vsp/run_full_scan', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          profile: profile,
          source_root: sourceRoot,
          target_url: targetUrl
        })
      });

      if (!res.ok) {
        setStatus('HTTP ' + res.status + ' khi gọi run_full_scan.', true);
        return;
      }

      var data = await res.json();
      if (data.ok) {
        var msg = 'Started ' + (data.profile || profile) +
          ' trên ' + (data.source_root || sourceRoot) +
          ' → ' + (data.target_url || targetUrl);
        if (data.pid) msg += ' (PID ' + data.pid + ')';
        setStatus(msg, false);
      } else {
        setStatus(data.message || 'run_full_scan trả về ok=false.', true);
      }
    } catch (err) {
      console.error('[VSP_RUN_FULLSCAN]', err);
      setStatus('Lỗi khi gọi run_full_scan: ' + err, true);
    } finally {
      btn.disabled = false;
      if (btn.dataset.originalText) {
        btn.textContent = btn.dataset.originalText;
      }
    }
  }

  document.addEventListener('DOMContentLoaded', function () {
    var btn = $('#vsp-run-fullscan-btn');
    if (!btn) {
      console.warn('[VSP_RUN_FULLSCAN] Không tìm thấy #vsp-run-fullscan-btn – chưa gắn được handler.');
      return;
    }
    btn.addEventListener('click', handleRunFullScan);
  });
})();

})();
/* ==== END: static/js/vsp_run_fullscan_v1.js ==== */

/* ==== BEGIN: static/js/vsp_sidebar.js ==== */
(function(){
'use strict';
(function () {
  function switchTab(targetId) {
    // 1) Đổi active ở menu
    document.querySelectorAll(".vsp-menu-item").forEach(function (item) {
      var tabKey = item.getAttribute("data-tab");
      if (tabKey === targetId) {
        item.classList.add("active");
      } else {
        item.classList.remove("active");
      }
    });

    // 2) Ẩn/hiện nội dung tab
    document.querySelectorAll(".vsp-tab").forEach(function (panel) {
      if (panel.id === targetId) {
        panel.style.display = "block";
      } else {
        panel.style.display = "none";
      }
    });
  }

  document.addEventListener("DOMContentLoaded", function () {
    // Gắn click handler
    document.querySelectorAll(".vsp-menu-item").forEach(function (item) {
      item.addEventListener("click", function () {
        var target = this.getAttribute("data-tab");
        if (!target) return;
        switchTab(target);
      });
    });

    // Mặc định mở Dashboard nếu có
    if (document.getElementById("tab-dashboard")) {
      switchTab("tab-dashboard");
    }
  });
})();

})();
/* ==== END: static/js/vsp_sidebar.js ==== */

/* ==== BEGIN: static/js/vsp_tab_overrides_v1.js ==== */
(function(){
'use strict';
/* =========================================================
 * VSP_TAB_OVERRIDES_V1
 *  A. Rule override table (Rule ID, Tool, Current, Override, Scope, Description)
 *  B. JSON/YAML editor (panel phải)
 *  C. Allowlist dynamic (checkbox)
 *  D. Metrics (active overrides, highest downgrade, ignored count)
 *  E. Preview panel (hover row -> thông tin rule)
 *  Data: GET /api/vsp/overrides/list  (items [])
 *        (optional) POST /api/vsp/overrides/set
 * =======================================================*/

(function () {
  const API_OVERRIDES_GET = "/api/vsp/overrides/list";
  const API_OVERRIDES_SET = "/api/vsp/overrides/set"; // optional, BE có thì dùng

  const PAGE_SIZE = 20;

  let overridesItems = [];
  let currentPage = 1;

  const SEV_ORDER = ["TRACE", "INFO", "LOW", "MEDIUM", "HIGH", "CRITICAL"];

  function normalizeSeverity(raw) {
    if (!raw) return "";
    return String(raw).trim().toUpperCase();
  }

  function severityRank(sev) {
    const s = normalizeSeverity(sev);
    const idx = SEV_ORDER.indexOf(s);
    return idx === -1 ? SEV_ORDER.length : idx;
  }

  function severityToClass(sev) {
    switch (normalizeSeverity(sev)) {
      case "CRITICAL": return "vsp-pill--critical";
      case "HIGH":     return "vsp-pill--high";
      case "MEDIUM":   return "vsp-pill--medium";
      case "LOW":      return "vsp-pill--low";
      case "INFO":     return "vsp-pill--info";
      case "TRACE":    return "vsp-pill--trace";
      default:         return "";
    }
  }

  // -------------------- Layout builder --------------------

  function buildLayout(panel) {
    if (!panel || panel.dataset.vspOverridesInit === "1") return;

    panel.innerHTML = `
      <div class="vsp-over-grid">
        <!-- LEFT MAIN COLUMN -->
        <div class="vsp-over-main">
          <!-- A. Rule override table -->
          <div class="vsp-card vsp-card--full">
            <div class="vsp-card-header">
              <div class="vsp-card-title">Rule overrides</div>
              <div class="vsp-card-subtitle">
                Tinh chỉnh nhiễu, giảm false positive, override severity cho từng rule / tool.
              </div>
            </div>
            <div class="vsp-card-body">
              <div id="vsp-overrides-empty" class="vsp-empty-text">
                No rule overrides configured for this profile.
              </div>

              <div id="vsp-overrides-table-wrapper" class="vsp-table-wrapper" style="display:none;">
                <table class="vsp-table vsp-table-overrides">
                  <thead>
                    <tr>
                      <th>Rule ID</th>
                      <th>Tool</th>
                      <th>Current</th>
                      <th>Override</th>
                      <th>Scope</th>
                      <th>Description</th>
                    </tr>
                  </thead>
                  <tbody id="vsp-overrides-tbody"></tbody>
                </table>

                <div class="vsp-table-footer">
                  <div class="vsp-table-footer-left">
                    <span id="vsp-overrides-total">Total overrides: 0</span>
                  </div>
                  <div class="vsp-table-footer-right">
                    <button class="vsp-btn vsp-btn-secondary" id="vsp-overrides-prev">Prev</button>
                    <span class="vsp-table-page-label" id="vsp-overrides-page-label">Page 1 / 1</span>
                    <button class="vsp-btn vsp-btn-secondary" id="vsp-overrides-next">Next</button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- D. Metrics -->
          <div class="vsp-card vsp-card--metrics">
            <div class="vsp-card-header">
              <div class="vsp-card-title">Override metrics</div>
              <div class="vsp-card-subtitle">
                Snapshot tác động của các rule override đang active.
              </div>
            </div>
            <div class="vsp-card-body vsp-over-metrics-grid">
              <div class="vsp-over-metric">
                <div class="vsp-over-metric-label">Active overrides</div>
                <div class="vsp-over-metric-value" id="vsp-over-metric-active">0</div>
              </div>
              <div class="vsp-over-metric">
                <div class="vsp-over-metric-label">Highest downgrade</div>
                <div class="vsp-over-metric-value" id="vsp-over-metric-downgrade">-</div>
              </div>
              <div class="vsp-over-metric">
                <div class="vsp-over-metric-label">Rules ignored</div>
                <div class="vsp-over-metric-value" id="vsp-over-metric-ignored">0</div>
              </div>
              <div class="vsp-over-metric">
                <div class="vsp-over-metric-label">Affected findings</div>
                <div class="vsp-over-metric-value" id="vsp-over-metric-affected">0</div>
              </div>
            </div>
          </div>

          <!-- E. Preview panel -->
          <div class="vsp-card vsp-card--preview">
            <div class="vsp-card-header">
              <div class="vsp-card-title">Preview impact</div>
              <div class="vsp-card-subtitle">
                Hover vào một rule ở bảng bên trên để xem mô tả nhanh các findings bị ảnh hưởng.
              </div>
            </div>
            <div class="vsp-card-body">
              <div id="vsp-over-preview-text" class="vsp-over-preview-text">
                Hover một dòng rule override để xem preview.
              </div>
            </div>
          </div>
        </div>

        <!-- RIGHT SIDE COLUMN -->
        <div class="vsp-over-side">
          <!-- B. JSON/YAML editor -->
          <div class="vsp-card vsp-card--editor">
            <div class="vsp-card-header">
              <div class="vsp-card-title">Overrides config (JSON / YAML)</div>
              <div class="vsp-card-subtitle">
                Đồng bộ với core engine. Bạn có thể chỉnh sửa JSON/YAML rồi đẩy về backend.
              </div>
            </div>
            <div class="vsp-card-body">
              <div class="vsp-over-editor-toolbar">
                <button class="vsp-btn vsp-btn-secondary" id="vsp-over-editor-load">Load từ API</button>
                <button class="vsp-btn vsp-btn-secondary" id="vsp-over-editor-validate">Validate</button>
                <button class="vsp-btn vsp-btn-primary" id="vsp-over-editor-save">Save (POST)</button>
              </div>
              <textarea id="vsp-overrides-editor" class="vsp-over-editor" spellcheck="false"></textarea>
              <div class="vsp-over-editor-hint">
                Ví dụ YAML:
<pre>overrides:
  - id: GITLEAKS_GENERIC_SECRET
    tool: gitleaks
    severity: LOW
    scope: "path:^tests/"
  - id: SEMGREP_PYTHON_SQL
    tool: semgrep
    severity: CRITICAL
    scope: null
</pre>
              </div>
            </div>
          </div>

          <!-- C. Allowlist dynamic -->
          <div class="vsp-card vsp-card--allowlist">
            <div class="vsp-card-header">
              <div class="vsp-card-title">Dynamic allowlist</div>
              <div class="vsp-card-subtitle">
                Mẫu cấu hình nhanh để ignore theo file, folder, CVE, CWE, tool, path regex.
              </div>
            </div>
            <div class="vsp-card-body">
              <div class="vsp-allowlist-grid">
                <label class="vsp-allow-item">
                  <input type="checkbox" id="vsp-allow-ignore-file" />
                  <span>Ignore file</span>
                </label>
                <label class="vsp-allow-item">
                  <input type="checkbox" id="vsp-allow-ignore-folder" />
                  <span>Ignore folder</span>
                </label>
                <label class="vsp-allow-item">
                  <input type="checkbox" id="vsp-allow-ignore-cve" />
                  <span>Ignore CVE</span>
                </label>
                <label class="vsp-allow-item">
                  <input type="checkbox" id="vsp-allow-ignore-cwe" />
                  <span>Ignore CWE</span>
                </label>
                <label class="vsp-allow-item">
                  <input type="checkbox" id="vsp-allow-ignore-tool" />
                  <span>Ignore tool</span>
                </label>
                <label class="vsp-allow-item">
                  <input type="checkbox" id="vsp-allow-ignore-path" />
                  <span>Ignore path regex</span>
                </label>
              </div>
              <div class="vsp-allowlist-note">
                Hiện tại checkbox mới log ra console để thiết kế rule mẫu. 
                Phase sau có thể generate snippet JSON/YAML tương ứng rồi POST về core engine.
              </div>
            </div>
          </div>
        </div>
      </div>
    `;

    panel.dataset.vspOverridesInit = "1";
  }

  // -------------------- Metrics --------------------

  function computeMetrics(items) {
    if (!Array.isArray(items)) items = [];

    let activeCount = 0;
    let ignoredCount = 0;
    let affectedTotal = 0;
    let highestDowngrade = null; // {from, to, diff}

    items.forEach((it) => {
      const active = it.active !== false; // default: active
      if (active) activeCount += 1;

      const from = normalizeSeverity(it.current_severity || it.original_severity);
      const to   = normalizeSeverity(it.override_severity || it.effective_severity);

      const sevIgnore = ["IGNORE", "OFF", "NONE", "DISABLE"];
      if (sevIgnore.includes(to)) {
        ignoredCount += 1;
      }

      if (typeof it.affected_count === "number") {
        affectedTotal += it.affected_count;
      }

      if (from && to) {
        const diff = severityRank(to) - severityRank(from); // >0: upgrade, <0: downgrade
        if (diff < 0) {
          if (!highestDowngrade || diff < highestDowngrade.diff) {
            highestDowngrade = { from, to, diff };
          }
        }
      }
    });

    return {
      activeCount,
      ignoredCount,
      affectedTotal,
      highestDowngrade,
    };
  }

  function renderMetrics(items) {
    const m = computeMetrics(items || []);
    const elActive   = document.getElementById("vsp-over-metric-active");
    const elDown     = document.getElementById("vsp-over-metric-downgrade");
    const elIgnored  = document.getElementById("vsp-over-metric-ignored");
    const elAffected = document.getElementById("vsp-over-metric-affected");

    if (elActive)   elActive.textContent = String(m.activeCount);
    if (elIgnored)  elIgnored.textContent = String(m.ignoredCount);
    if (elAffected) elAffected.textContent = String(m.affectedTotal);

    if (elDown) {
      if (m.highestDowngrade) {
        elDown.textContent = m.highestDowngrade.from + " → " + m.highestDowngrade.to;
      } else {
        elDown.textContent = "-";
      }
    }
  }

  // -------------------- Editor --------------------

  function mapItemsToSimpleConfig(items) {
    return {
      overrides: (items || []).map((it) => ({
        id: it.id || it.rule_id || "",
        tool: it.tool || "",
        current_severity: it.current_severity || it.original_severity || null,
        severity: it.override_severity || it.effective_severity || null,
        scope: it.scope || null,
        description: it.description || ""
      }))
    };
  }

  function refreshEditorFromItems() {
    const textarea = document.getElementById("vsp-overrides-editor");
    if (!textarea) return;
    const cfg = mapItemsToSimpleConfig(overridesItems);
    textarea.value = JSON.stringify(cfg, null, 2);
  }

  function editorHandleLoad() {
    refreshEditorFromItems();
  }

  function editorHandleValidate() {
    const textarea = document.getElementById("vsp-overrides-editor");
    if (!textarea) return;
    const text = textarea.value;
    try {
      JSON.parse(text);
      alert("JSON hợp lệ. (YAML hiện chưa parse, sẽ hỗ trợ ở phase sau)");
    } catch (err) {
      console.error("[VSP][OVR_EDITOR] JSON parse error:", err);
      alert("Không parse được JSON. Nếu bạn dùng YAML thì bỏ qua nút Validate.");
    }
  }

  async function editorHandleSave() {
    const textarea = document.getElementById("vsp-overrides-editor");
    if (!textarea) return;
    const bodyText = textarea.value;

    try {
      const res = await fetch(API_OVERRIDES_SET, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: bodyText
      });

      if (!res.ok) {
        console.error("[VSP][OVR_EDITOR] Save error, status =", res.status);
        alert("Save thất bại (HTTP " + res.status + "). Kiểm tra log backend.");
        return;
      }

      alert("Save overrides thành công (POST /api/vsp/overrides/set).");
    } catch (err) {
      console.error("[VSP][OVR_EDITOR] Save error:", err);
      alert("Không gọi được API /api/vsp/overrides/set. Kiểm tra backend.");
    }
  }

  function attachEditorHandlers() {
    const btnLoad = document.getElementById("vsp-over-editor-load");
    const btnVal  = document.getElementById("vsp-over-editor-validate");
    const btnSave = document.getElementById("vsp-over-editor-save");

    if (btnLoad) btnLoad.addEventListener("click", editorHandleLoad);
    if (btnVal)  btnVal.addEventListener("click", editorHandleValidate);
    if (btnSave) btnSave.addEventListener("click", editorHandleSave);
  }

  // -------------------- Allowlist toggles --------------------

  function attachAllowlistHandlers() {
    const ids = [
      "vsp-allow-ignore-file",
      "vsp-allow-ignore-folder",
      "vsp-allow-ignore-cve",
      "vsp-allow-ignore-cwe",
      "vsp-allow-ignore-tool",
      "vsp-allow-ignore-path",
    ];

    ids.forEach((id) => {
      const el = document.getElementById(id);
      if (!el) return;
      el.addEventListener("change", function () {
        console.log("[VSP][ALLOWLIST] toggle", id, "=", el.checked);
        // Phase sau: generate snippet JSON/YAML tương ứng gắn vào editor.
      });
    });
  }

  // -------------------- Table & preview --------------------

  function renderTable() {
    const emptyEl    = document.getElementById("vsp-overrides-empty");
    const wrapperEl  = document.getElementById("vsp-overrides-table-wrapper");
    const tbodyEl    = document.getElementById("vsp-overrides-tbody");
    const totalEl    = document.getElementById("vsp-overrides-total");
    const pageLabel  = document.getElementById("vsp-overrides-page-label");

    if (!emptyEl || !wrapperEl || !tbodyEl) return;

    const total = overridesItems.length;

    if (!total) {
      emptyEl.style.display = "block";
      wrapperEl.style.display = "none";
      if (totalEl)   totalEl.textContent = "Total overrides: 0";
      if (pageLabel) pageLabel.textContent = "Page 1 / 1";
      return;
    }

    emptyEl.style.display = "none";
    wrapperEl.style.display = "block";

    const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
    if (currentPage > totalPages) currentPage = totalPages;

    const start = (currentPage - 1) * PAGE_SIZE;
    const end   = start + PAGE_SIZE;
    const pageItems = overridesItems.slice(start, end);

    tbodyEl.innerHTML = "";

    pageItems.forEach((item) => {
      const tr = document.createElement("tr");

      // Rule ID
      const ruleTd = document.createElement("td");
      ruleTd.textContent = item.id || item.rule_id || "";
      tr.appendChild(ruleTd);

      // Tool
      const toolTd = document.createElement("td");
      toolTd.textContent = item.tool || "";
      tr.appendChild(toolTd);

      // Current
      const curTd = document.createElement("td");
      const cur = normalizeSeverity(item.current_severity || item.original_severity || "");
      curTd.textContent = cur || "-";
      tr.appendChild(curTd);

      // Override (pill)
      const ovrTd = document.createElement("td");
      const ovr = normalizeSeverity(item.override_severity || item.effective_severity || "");
      const span = document.createElement("span");
      span.className = "vsp-pill vsp-pill--severity " + severityToClass(ovr);
      span.textContent = ovr || "-";
      ovrTd.appendChild(span);
      tr.appendChild(ovrTd);

      // Scope
      const scopeTd = document.createElement("td");
      scopeTd.textContent = item.scope || "";
      tr.appendChild(scopeTd);

      // Description
      const descTd = document.createElement("td");
      descTd.textContent = item.description || "";
      tr.appendChild(descTd);

      // Preview hover
      tr.addEventListener("mouseenter", function () {
        const previewEl = document.getElementById("vsp-over-preview-text");
        if (!previewEl) return;
        const parts = [];
        parts.push((item.id || item.rule_id || "Unknown rule") + " (" + (item.tool || "tool?") + ")");
        const from = normalizeSeverity(item.current_severity || item.original_severity || "");
        const to   = normalizeSeverity(item.override_severity || item.effective_severity || "");
        if (from || to) {
          parts.push("Severity: " + (from || "?") + " → " + (to || "?"));
        }
        if (item.scope) {
          parts.push("Scope: " + item.scope);
        }
        if (typeof item.affected_count === "number") {
          parts.push("Affected findings: " + item.affected_count);
        }
        if (item.description) {
          parts.push("Desc: " + item.description);
        }
        previewEl.textContent = parts.join(" | ");
      });

      tbodyEl.appendChild(tr);
    });

    if (totalEl)   totalEl.textContent = "Total overrides: " + total;
    if (pageLabel) pageLabel.textContent = "Page " + currentPage + " / " + Math.max(1, Math.ceil(total / PAGE_SIZE));
  }

  function attachPagingHandlers() {
    const prevBtn = document.getElementById("vsp-overrides-prev");
    const nextBtn = document.getElementById("vsp-overrides-next");

    if (prevBtn) {
      prevBtn.addEventListener("click", function () {
        if (currentPage > 1) {
          currentPage -= 1;
          renderTable();
        }
      });
    }

    if (nextBtn) {
      nextBtn.addEventListener("click", function () {
        const total = overridesItems.length;
        const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
        if (currentPage < totalPages) {
          currentPage += 1;
          renderTable();
        }
      });
    }
  }

  // -------------------- Load data --------------------

  async function loadOverrides() {
    try {
      const res = await fetch(API_OVERRIDES_GET, {
        method: "GET",
        headers: { "Accept": "application/json" },
      });

      if (!res.ok) {
        console.error("[VSP][OVERRIDES] HTTP error:", res.status);
        overridesItems = [];
        renderTable();
        renderMetrics(overridesItems);
        return;
      }

      const data = await res.json();
      if (Array.isArray(data)) {
        overridesItems = data;
      } else if (data && Array.isArray(data.items)) {
        overridesItems = data.items;
      } else {
        console.warn("[VSP][OVERRIDES] Unexpected payload:", data);
        overridesItems = [];
      }

      currentPage = 1;
      renderTable();
      renderMetrics(overridesItems);
      refreshEditorFromItems();
    } catch (err) {
      console.error("[VSP][OVERRIDES] Failed to load:", err);
    }
  }

  // -------------------- Init --------------------

  function init() {
    const panel = document.getElementById("tab-overrides");
    if (!panel) return;

    buildLayout(panel);
    attachPagingHandlers();
    attachEditorHandlers();
    attachAllowlistHandlers();
    loadOverrides();
  }

  document.addEventListener("DOMContentLoaded", function () {
    setTimeout(init, 400);
  });
})();

// VSP_OVERRIDES_CARD_POLISH_V1
// Bọc các block Overrides thành vsp-card:
// - RULE OVERRIDES table
// - OVERRIDE METRICS
// - PREVIEW IMPACT
// - OVERRIDES CONFIG (JSON / YAML)
(function () {
  function enhanceOverrideCards() {
    const tab = document.getElementById("tab-overrides");
    if (!tab) return;

    function markCard(keyword, extraClass) {
      const els = Array.from(tab.querySelectorAll("h2, h3, h4, strong"));
      const found = els.find((el) => {
        const txt = (el.textContent || "").toLowerCase();
        return txt.indexOf(keyword) !== -1;
      });
      if (!found) return;
      const card = found.closest("div");
      if (!card) return;
      card.classList.add("vsp-card");
      if (extraClass) card.classList.add(extraClass);
    }

    markCard("rule overrides", "vsp-card--ovr-table");
    markCard("override metrics", "vsp-card--ovr-metrics");
    markCard("preview impact", "vsp-card--ovr-preview");
    markCard("overrides config", "vsp-card--ovr-editor");
  }

  document.addEventListener("DOMContentLoaded", function () {
    setTimeout(enhanceOverrideCards, 400);
  });
})();

// VSP_OVERRIDES_POLISH_INLINE_V1
// Đánh bóng toàn bộ tab Rule Overrides: table + metrics + preview + editor.
(function () {
  function styleCardByKeyword(tab, keyword) {
    const title = Array.from(tab.querySelectorAll("*")).find((el) => {
      const txt = (el.textContent || "").toLowerCase();
      return txt.indexOf(keyword) !== -1;
    });
    const card = title ? title.closest("div") : null;
    if (!card) return null;
    card.style.borderRadius = "22px";
    card.style.background =
      "radial-gradient(circle at top left, rgba(0, 180, 150, 0.14), rgba(2, 12, 30, 0.98))";
    card.style.border = "1px solid rgba(0, 200, 170, 0.40)";
    card.style.boxShadow = "0 18px 50px rgba(0, 0, 0, 0.75)";
    card.style.padding = "14px 18px 16px";
    card.style.marginTop = card.style.marginTop || "0px";
    return card;
  }

  function polishOverrides() {
    const tab = document.getElementById("tab-overrides");
    if (!tab) return;

    const cardTable = styleCardByKeyword(tab, "rule overrides");
    const cardMetrics = styleCardByKeyword(tab, "override metrics");
    const cardPreview = styleCardByKeyword(tab, "preview impact");
    const cardEditor = styleCardByKeyword(tab, "overrides config");

    if (cardMetrics) cardMetrics.style.marginTop = "14px";
    if (cardPreview) cardPreview.style.marginTop = "14px";
    if (cardEditor) cardEditor.style.marginTop = "14px";

    // Editor: textarea + buttons
    if (cardEditor) {
      const textarea =
        cardEditor.querySelector("textarea") ||
        cardEditor.querySelector("pre") ||
        cardEditor.querySelector("code");
      if (textarea) {
        textarea.style.width = "100%";
        textarea.style.minHeight = "140px";
        textarea.style.background = "rgba(1, 20, 40, 0.98)";
        textarea.style.borderRadius = "12px";
        textarea.style.border = "1px solid rgba(0, 180, 140, 0.6)";
        textarea.style.color = "#e6f7ff";
        textarea.style.fontFamily = '"JetBrains Mono", "Fira Code", monospace';
        textarea.style.fontSize = "11px";
        textarea.style.padding = "8px 10px";
      }

      const buttons = cardEditor.querySelectorAll("button");
      buttons.forEach((btn) => {
        btn.style.borderRadius = "9999px";
        btn.style.border = "1px solid rgba(0, 255, 210, 0.95)";
        btn.style.padding = "4px 14px";
        btn.style.fontSize = "11px";
        btn.style.textTransform = "uppercase";
        btn.style.letterSpacing = "0.06em";
        btn.style.background =
          "radial-gradient(circle at top left, rgba(0, 255, 210, 0.28), rgba(0, 40, 60, 1))";
        btn.style.color = "#001320";
        btn.style.cursor = "pointer";
        btn.style.marginRight = "6px";
        btn.style.marginTop = "6px";
      });
    }
  }

  document.addEventListener("DOMContentLoaded", function () {
    setTimeout(polishOverrides, 900);
  });
})();

// VSP_OVERRIDES_SOFTCARD_V1
// Gắn .vsp-card-soft cho 4 block: table, metrics, preview, editor.
(function () {
  function tagOverrideCards() {
    const tab = document.getElementById("tab-overrides");
    if (!tab) return;

    function addSoft(keyword) {
      const el = Array.from(tab.querySelectorAll("*")).find((node) => {
        const txt = (node.textContent || "").toLowerCase();
        return txt.indexOf(keyword) !== -1;
      });
      if (!el) return;
      const card = el.closest("div");
      if (!card) return;
      card.classList.add("vsp-card-soft");
    }

    addSoft("rule overrides");
    addSoft("override metrics");
    addSoft("preview impact");
    addSoft("overrides config");
  }

  document.addEventListener("DOMContentLoaded", function () {
    setTimeout(tagOverrideCards, 500);
  });
})();

// VSP_OVERRIDES_FINALIZE_CARD_V1
// Reset 4 block Overrides về card chuẩn (.vsp-card).
(function () {
  function finalizeOverrideCards() {
    const tab = document.getElementById("tab-overrides");
    if (!tab) return;

    function fixCard(keyword) {
      const el = Array.from(tab.querySelectorAll("*")).find((node) => {
        const txt = (node.textContent || "").toLowerCase();
        return txt.indexOf(keyword) !== -1;
      });
      if (!el) return;
      const card = el.closest("div");
      if (!card) return;
      card.removeAttribute("style");
      card.classList.remove("vsp-card-soft");
      card.classList.add("vsp-card");
    }

    fixCard("rule overrides");
    fixCard("override metrics");
    fixCard("preview impact");
    fixCard("overrides config");
  }

  document.addEventListener("DOMContentLoaded", function () {
    setTimeout(finalizeOverrideCards, 1200);
  });
})();


})();
/* ==== END: static/js/vsp_tab_overrides_v1.js ==== */

/* ==== BEGIN: static/js/vsp_tables_severity_color_v1.js ==== */
(function(){
'use strict';
(function(){
  console.log("[VSP_TABLES] severity colouring loaded");
  document.addEventListener("DOMContentLoaded", function(){
    document.querySelectorAll("[data-severity]").forEach(function(el){
      var sev = el.getAttribute("data-severity");
      if (!sev) return;
      el.classList.add("vsp-sev-" + sev);
    });
  });
})();

})();
/* ==== END: static/js/vsp_tables_severity_color_v1.js ==== */

/* ==== BEGIN: static/js/vsp_tabs_runtime_fix.js ==== */
(function(){
'use strict';
console.log("[VSP_UI] vsp_tabs_runtime_fix.js loaded");

document.addEventListener("DOMContentLoaded", () => {
  // Nút tab ngang: Dashboard / Runs & Reports / Data Source / Settings / Rule Overrides
  const buttons = document.querySelectorAll(".vsp-tab-btn");

  // 5 panel nội dung
  const panels = {
    dashboard:  document.getElementById("tab-dashboard"),
    runs:       document.getElementById("tab-runs"),
    datasource: document.getElementById("tab-datasource"),
    settings:   document.getElementById("tab-settings"),
    overrides:  document.getElementById("tab-overrides"),
  };

  console.log(
    "[VSP_UI][TABS_FIX] buttons=",
    buttons.length,
    "panels=",
    Object.values(panels).filter(Boolean).length
  );

  if (!buttons.length) {
    console.warn("[VSP_UI][TABS_FIX] Không thấy .vsp-tab-btn");
  }

  function showTab(name) {
    Object.entries(panels).forEach(([key, el]) => {
      if (!el) return;
      const active = key === name;
      el.style.display = active ? "" : "none";
      el.classList.toggle("active", active);
      el.classList.toggle("is-active", active);
    });

    buttons.forEach((btn) => {
      const tab = btn.dataset.tab;
      const active = tab === name;
      btn.classList.toggle("active", active);
      btn.classList.toggle("is-active", active);
    });

    console.log("[VSP_UI][TABS_FIX] showTab =", name);
  }

  buttons.forEach((btn) => {
    btn.addEventListener("click", () => {
      const tab = btn.dataset.tab;
      if (!tab) return;
      showTab(tab);
    });
  });

  // Mặc định: Dashboard
  showTab("dashboard");
});

})();
/* ==== END: static/js/vsp_tabs_runtime_fix.js ==== */

/* ==== BEGIN: static/js/vsp_tabs_runtime_v2.js ==== */
(function(){
'use strict';
// VSP_TABS_RUNTIME_V2_CLEAN – quản lý 5 tab chính, không gọi API
(function () {
  const LOG = "[VSP_TABS]";

  function activateTab(targetId) {
    const panes = document.querySelectorAll(".tab-pane");
    panes.forEach(p => {
      if (p.id === targetId) {
        p.classList.add("active");
      } else {
        p.classList.remove("active");
      }
    });

    const buttons = document.querySelectorAll("[data-tab-target]");
    buttons.forEach(b => {
      if (b.getAttribute("data-tab-target") === targetId) {
        b.classList.add("active");
      } else {
        b.classList.remove("active");
      }
    });

    console.log(LOG, "switch to", targetId);
  }

  document.addEventListener("DOMContentLoaded", function () {
    const buttons = document.querySelectorAll("[data-tab-target]");
    if (!buttons.length) {
      console.warn(LOG, "Không tìm thấy nút tab nào.");
      return;
    }

    buttons.forEach(btn => {
      btn.addEventListener("click", function (e) {
        e.preventDefault();
        const targetId = btn.getAttribute("data-tab-target");
        if (!targetId) return;
        activateTab(targetId);

        // Hook: khi chuyển tab, gọi loader nếu có
        if (targetId === "tab-runs" && window.vspLoadRunsTab) {
          window.vspLoadRunsTab();
        }
        if (targetId === "tab-data" && window.vspLoadDataSourceTab) {
          window.vspLoadDataSourceTab();
        }
      });
    });

    // đảm bảo có 1 tab active ban đầu
    const activePane = document.querySelector(".tab-pane.active");
    if (!activePane && buttons[0]) {
      const firstTarget = buttons[0].getAttribute("data-tab-target");
      if (firstTarget) {
        activateTab(firstTarget);
      }
    }

    console.log(LOG, "init done");
  });
})();

})();
/* ==== END: static/js/vsp_tabs_runtime_v2.js ==== */

/* ==== BEGIN: static/js/vsp_tabs_simple_v1.js ==== */
(function(){
'use strict';
(function () {
  "use strict";

  const LOG_PREFIX = "[VSP_TABS]";

  function log() {
    // eslint-disable-next-line no-console
    console.log.apply(console, [LOG_PREFIX].concat(Array.from(arguments)));
  }

  function initTabs() {
    const buttons = document.querySelectorAll("[data-vsp-tab-target]");
    const panes = document.querySelectorAll(".vsp-tab-pane");

    if (!buttons.length || !panes.length) {
      log("No tab buttons or panes found – skip.");
      return;
    }

    function showTab(targetSelector) {
      if (!targetSelector) return;
      let found = false;

      panes.forEach((pane) => {
        if (pane.matches(targetSelector)) {
          pane.classList.add("vsp-tab-pane-active");
          pane.style.display = "";
          found = true;
        } else {
          pane.classList.remove("vsp-tab-pane-active");
          pane.style.display = "none";
        }
      });

      buttons.forEach((btn) => {
        const sel = btn.getAttribute("data-vsp-tab-target");
        if (sel === targetSelector) {
          btn.classList.add("vsp-tab-link-active");
        } else {
          btn.classList.remove("vsp-tab-link-active");
        }
      });

      if (!found) {
        log("No pane matched selector:", targetSelector);
      } else {
        log("Switched to tab:", targetSelector);
      }
    }

    buttons.forEach((btn) => {
      btn.addEventListener("click", function (e) {
        e.preventDefault();
        const sel = btn.getAttribute("data-vsp-tab-target");
        if (!sel) return;
        showTab(sel);
      });
    });

    let defaultSelector = null;

    if (window.location.hash && document.querySelector(window.location.hash)) {
      defaultSelector = window.location.hash;
    }
    if (!defaultSelector) {
      const defBtn = document.querySelector(
        "[data-vsp-tab-default='true'][data-vsp-tab-target]"
      );
      if (defBtn) {
        defaultSelector = defBtn.getAttribute("data-vsp-tab-target");
      }
    }
    if (!defaultSelector && buttons[0]) {
      defaultSelector = buttons[0].getAttribute("data-vsp-tab-target");
    }

    if (defaultSelector) {
      showTab(defaultSelector);
      log("Initialized, default tab =", defaultSelector);
    } else {
      log("Initialized without default tab.");
    }

    window.vspTabsShow = showTab;
  }

  document.addEventListener("DOMContentLoaded", initTabs);
})();

})();
/* ==== END: static/js/vsp_tabs_simple_v1.js ==== */

/* ==== BEGIN: static/js/vsp_tool_pills_verdict_from_gate_p0_v1.js ==== */
(function(){
'use strict';
(function(){
  'use strict';
  if (window.__VSP_TOOL_PILLS_VERDICT_P0_V1) return;
  window.__VSP_TOOL_PILLS_VERDICT_P0_V1 = true;

  const TAG='VSP_TOOL_PILLS_VERDICT_P0_V1';
  const TOOLS=["BANDIT","SEMGREP","GITLEAKS","KICS","TRIVY","SYFT","GRYPE","CODEQL"];

  function ensureStyle(){
    if (document.getElementById('vsp-toolpill-style-v1')) return;
    const st=document.createElement('style');
    st.id='vsp-toolpill-style-v1';
    st.textContent=`
      .vsp-pill-v{display:inline-flex;align-items:center;gap:8px}
      .vsp-vbdg{display:inline-flex;align-items:center;justify-content:center;
        padding:3px 8px;border-radius:999px;font-size:11px;font-weight:900;
        border:1px solid rgba(255,255,255,.14)}
      .vsp-vg{background:rgba(0,255,140,.12)}
      .vsp-va{background:rgba(255,190,0,.14)}
      .vsp-vr{background:rgba(255,70,70,.14)}
      .vsp-vn{background:rgba(160,160,160,.14)}
    `;
    document.head.appendChild(st);
  }

  function map(v){
    v=String(v||'').toUpperCase();
    if (v==='OK') v='GREEN';
    if (v==='FAIL') v='RED';
    if (v==='DEGRADED') v='AMBER';
    if (v==='GREEN') return {t:'GREEN', c:'vsp-vbdg vsp-vg'};
    if (v==='AMBER') return {t:'AMBER', c:'vsp-vbdg vsp-va'};
    if (v==='RED') return {t:'RED', c:'vsp-vbdg vsp-vr'};
    return {t:'NOT_RUN', c:'vsp-vbdg vsp-vn'};
  }

  function getRID(){
    try{
      const v=localStorage.getItem('vsp_rid_selected_v2');
      if (v && String(v).trim()) return String(v).trim();
    }catch(_){}
    return '';
  }

  async function resolveRID(){
    const ls=getRID();
    if (ls) return ls;
    try{
      const r=await fetch('/api/vsp/runs_index_v3_fs_resolved?limit=1&hide_empty=0&filter=1',{credentials:'same-origin'});
      const j=await r.json();
      return String(j?.items?.[0]?.run_id || '');
    }catch(_){ return ''; }
  }

  async function fetchGate(rid){
    const r=await fetch(`/api/vsp/run_gate_summary_v1/${encodeURIComponent(rid)}`,{credentials:'same-origin'});
    return await r.json();
  }

  function decorateByTool(by){
    // Find any element whose text starts with tool name (case-insensitive)
    const all=[...document.querySelectorAll('div,span,a,button')];
    let n=0;
    for (const tool of TOOLS){
      const el = all.find(x => {
        const tx=(x.innerText||'').trim();
        return tx && tx.toUpperCase().startsWith(tool);
      });
      if (!el) continue;
      if (el.querySelector && el.querySelector('[data-vsp-tool-verdict="1"]')) continue;

      const vv = by?.[tool]?.verdict || by?.[tool]?.status || '';
      const m = map(vv);

      // wrap text + badge without breaking layout
      const wrap=document.createElement('span');
      wrap.className='vsp-pill-v';
      wrap.innerHTML = `<span>${tool}</span> <span class="${m.c}" data-vsp-tool-verdict="1">${m.t}</span>`;
      el.innerHTML = '';
      el.appendChild(wrap);
      n++;
    }
    if (n) console.log(`[${TAG}] decorated tool pills:`, n);
  }

  async function boot(){
    ensureStyle();
    const rid=await resolveRID();
    if (!rid) return;
    const gs=await fetchGate(rid).catch(()=>null);
    if (!gs) return;
    decorateByTool(gs.by_tool || {});
  }

  if (document.readyState==='loading') document.addEventListener('DOMContentLoaded', boot, {once:true});
  else boot();
})();

})();
/* ==== END: static/js/vsp_tool_pills_verdict_from_gate_p0_v1.js ==== */

/* ==== BEGIN: static/js/vsp_tool_pills_verdict_from_gate_p0_v2.js ==== */
(function(){
'use strict';
(function(){
  'use strict';
  if (window.__VSP_TOOL_PILLS_VERDICT_P0_V2) return;
  window.__VSP_TOOL_PILLS_VERDICT_P0_V2 = true;

  const TAG='VSP_TOOL_PILLS_VERDICT_P0_V2';
  const TOOLS=["BANDIT","SEMGREP","GITLEAKS","KICS","TRIVY","SYFT","GRYPE","CODEQL"];

  function ensureStyle(){
    if (document.getElementById('vsp-toolpill-style-v2')) return;
    const st=document.createElement('style');
    st.id='vsp-toolpill-style-v2';
    st.textContent=`
      .vsp-vbdg{display:inline-flex;align-items:center;justify-content:center;
        padding:3px 8px;border-radius:999px;font-size:11px;font-weight:900;
        border:1px solid rgba(255,255,255,.14); margin-left:8px}
      .vsp-vg{background:rgba(0,255,140,.12)}
      .vsp-va{background:rgba(255,190,0,.14)}
      .vsp-vr{background:rgba(255,70,70,.14)}
      .vsp-vn{background:rgba(160,160,160,.14)}
    `;
    document.head.appendChild(st);
  }

  function map(v){
    v=String(v||'').toUpperCase();
    if (v==='OK') v='GREEN';
    if (v==='FAIL') v='RED';
    if (v==='DEGRADED') v='AMBER';
    if (v==='GREEN') return {t:'GREEN', c:'vsp-vbdg vsp-vg'};
    if (v==='AMBER') return {t:'AMBER', c:'vsp-vbdg vsp-va'};
    if (v==='RED') return {t:'RED', c:'vsp-vbdg vsp-vr'};
    return {t:'NOT_RUN', c:'vsp-vbdg vsp-vn'};
  }

  async function resolveRID(){
    try{
      const v=localStorage.getItem('vsp_rid_selected_v2');
      if (v && String(v).trim()) return String(v).trim();
    }catch(_){}
    try{
      const r=await fetch('/api/vsp/runs_index_v3_fs_resolved?limit=1&hide_empty=0&filter=1',{credentials:'same-origin'});
      const j=await r.json();
      return String(j?.items?.[0]?.run_id || '');
    }catch(_){ return ''; }
  }

  async function fetchGate(rid){
    const r=await fetch(`/api/vsp/run_gate_summary_v1/${encodeURIComponent(rid)}`,{credentials:'same-origin'});
    return await r.json();
  }

  function findToolNodes(tool){
    const nodes=[...document.querySelectorAll('div,span,a,button')];
    const up=tool.toUpperCase();
    return nodes.filter(n=>{
      const tx=(n.innerText||'').trim().toUpperCase();
      return tx===up || tx.startsWith(up+'\n') || tx.startsWith(up+' ') || tx.includes('\n'+up+'\n') || tx.includes(' '+up+'\n');
    });
  }

  function decorate(by){
    let n=0;
    for (const tool of TOOLS){
      const nodes=findToolNodes(tool);
      if (!nodes.length) continue;
      const vv = by?.[tool]?.verdict || by?.[tool]?.status || '';
      const m = map(vv);

      for (const el of nodes){
        if (el.querySelector && el.querySelector('[data-vsp-tool-verdict="1"]')) continue;
        const bdg=document.createElement('span');
        bdg.className=m.c;
        bdg.textContent=m.t;
        bdg.setAttribute('data-vsp-tool-verdict','1');
        el.appendChild(bdg);
        n++;
      }
    }
    if (n) console.log(`[${TAG}] decorated`, n, 'tool nodes');
    return n;
  }

  async function tick(){
    ensureStyle();
    const rid=await resolveRID();
    if (!rid) return 0;
    const gs=await fetchGate(rid).catch(()=>null);
    if (!gs) return 0;
    return decorate(gs.by_tool || {});
  }

  function boot(){
    let tries=0;
    const iv=setInterval(async ()=>{
      tries++;
      const n=await tick();
      if (n>0 && tries>=3) { /* keep a bit to catch rerender */ }
      if (tries>=60) clearInterval(iv); // 30s
    }, 500);
  }

  if (document.readyState==='loading') document.addEventListener('DOMContentLoaded', boot, {once:true});
  else boot();
})();

})();
/* ==== END: static/js/vsp_tool_pills_verdict_from_gate_p0_v2.js ==== */

/* ==== BEGIN: static/js/vsp_tools_status_from_gate_p0_v1.js ==== */
(function(){
'use strict';
/* VSP_TOOLS_STATUS_STUB_P0_V1: disabled to stabilize UI (broken upstream file caused parse errors) */
(function(){
  'use strict';
  try{
    console.warn('[VSP_TOOLS_STATUS_STUB_P0_V1] tools_status disabled (P0 stabilize).');
  }catch(_){}
})();

})();
/* ==== END: static/js/vsp_tools_status_from_gate_p0_v1.js ==== */

/* ==== BEGIN: static/js/vsp_trend_topcwe_v1.js ==== */
(function(){
'use strict';
// ======================= VSP TOP CWE EXPOSURE V1 =======================
// Cung cấp 2 hàm global cho vsp_dashboard_live_v2.js:
//   - api_TOPCWE_v1()      -> Promise<{ ok, items: [{cwe, count}] }>
//   - renderTopCweBar(payload)  -> render vào panel Top CWE Exposure

(function () {
  async function api_TOPCWE_v1() {
    try {
      const res = await fetch('/api/vsp/dashboard_v3');
      if (!res.ok) {
        console.warn('[VSP][TOPCWE] /api/vsp/dashboard_v3 HTTP', res.status);
        return { ok: false, items: [] };
      }
      const data = await res.json();
      let items = [];
      const raw = data.top_cwe;

      if (Array.isArray(raw)) {
        // [{cwe, count, ...}, ...]
        items = raw.map(it => ({
          cwe: it.cwe || it.CWE || 'UNKNOWN',
          count: it.count || it.total || 0
        }));
      } else if (raw && typeof raw === 'object') {
        // {cwe:'UNKNOWN', total:1458} hoặc tương tự
        items = [{
          cwe: raw.cwe || raw.CWE || 'UNKNOWN',
          count: raw.total || raw.count || data.total_findings || 0
        }];
      } else {
        // Fallback: 1 entry UNKNOWN = tổng findings
        const total = data.total_findings || 0;
        items = [{ cwe: 'UNKNOWN', count: total }];
      }

      return { ok: true, items };
    } catch (e) {
      console.error('[VSP][TOPCWE] api_TOPCWE_v1 error:', e);
      return { ok: false, items: [] };
    }
  }

  function renderTopCweBar(payload) {
    try {
      const root =
        document.querySelector('[data-vsp-topcwe]') ||
        document.getElementById('vsp-topcwe-panel');

      if (!root) {
        // Không có panel, thôi bỏ qua.
        return;
      }

      const items = (payload && payload.items) || [];
      if (!items.length) {
        root.innerHTML = '<div class="vsp-empty-hint">No CWE data for this run.</div>';
        return;
      }

      const max = items.reduce((m, it) => Math.max(m, it.count || 0), 0) || 1;

      const rows = items.slice(0, 6).map(it => {
        const w = Math.round((it.count || 0) * 100 / max);
        return `
          <div class="vsp-topcwe-row">
            <span class="vsp-topcwe-code">${it.cwe}</span>
            <span class="vsp-topcwe-bar">
              <span class="vsp-topcwe-bar-fill" style="width:${w}%"></span>
            </span>
            <span class="vsp-topcwe-count">${it.count}</span>
          </div>
        `;
      }).join('');

      root.innerHTML = `
        <div class="vsp-topcwe-legend">
          <span class="label">CWE</span>
          <span class="label">Count</span>
        </div>
        <div class="vsp-topcwe-rows">
          ${rows}
        </div>
      `;
    } catch (e) {
      console.error('[VSP][TOPCWE] renderTopCweBar error:', e);
    }
  }

  // Expose globals cho vsp_dashboard_live_v2.js
  window.api_TOPCWE_v1 = api_TOPCWE_v1;
  window.renderTopCweBar = renderTopCweBar;

  // Auto init nếu file được load sau DOMContentLoaded
  if (document.readyState === 'complete' || document.readyState === 'interactive') {
    api_TOPCWE_v1().then(renderTopCweBar);
  } else {
    document.addEventListener('DOMContentLoaded', () => {
      api_TOPCWE_v1().then(renderTopCweBar);
    });
  }
})();

})();
/* ==== END: static/js/vsp_trend_topcwe_v1.js ==== */

/* ==== BEGIN: static/js/vsp_vertical.js ==== */
(function(){
'use strict';
/* VersaSecure VSP EXT+ UI – single JS for 5 tabs
 * Gọi BE:
 *  - POST /api/vsp/run
 *  - GET  /api/vsp/dashboard_v3
 *  - GET  /api/vsp/runs
 *  - GET  /api/vsp/datasource
 *  - GET  /api/vsp/settings
 */

'use strict';

// PATCH: đảm bảo mọi chart có khoảng padding đáy đủ để không mất trục hoành
if (window.Chart && Chart.defaults) {
  Chart.defaults.layout = Chart.defaults.layout || {};
  Chart.defaults.layout.padding = Chart.defaults.layout.padding || {};
  if (!Chart.defaults.layout.padding.bottom ||
      Chart.defaults.layout.padding.bottom < 24) {
    Chart.defaults.layout.padding.bottom = 24;
  }
}

(function () {
  if (!window.VSP) window.VSP = {};
  const VSP = window.VSP;

  // ---------- Helper ----------
  const $ = (sel) => document.querySelector(sel);
  const $$ = (sel) => Array.from(document.querySelectorAll(sel));

  const fmt = (n) => {
    if (n == null || isNaN(n)) return '0';
    return Number(n).toLocaleString('en-US');
  };

  async function fetchJSON(url, opts = {}) {
    try {
      const res = await fetch(url, {
        headers: { 'Accept': 'application/json', 'Content-Type': 'application/json' },
        ...opts,
      });
      if (!res.ok) {
        console.error('[VSP] HTTP error', url, res.status);
        return null;
      }
      return await res.json();
    } catch (e) {
      console.error('[VSP] fetchJSON error', url, e);
      return null;
    }
  }

  function safeDestroyChart(chartRefName) {
    const chart = VSP[chartRefName];
    if (chart && typeof chart.destroy === 'function') {
      chart.destroy();
    }
    VSP[chartRefName] = null;
  }

  // ---------- TAB SWITCH ----------
  function initTabs() {
    const navItems = $$('.vsp-nav-item');
    const panes = $$('.vsp-tab-pane');

    navItems.forEach((btn) => {
      btn.addEventListener('click', () => {
        const target = btn.getAttribute('data-tab');
        navItems.forEach((b) => b.classList.toggle('active', b === btn));
        panes.forEach((p) =>
          p.classList.toggle('active', p.getAttribute('data-tab-pane') === target)
        );

        // Lazy load cho từng tab
        if (target === 'dashboard') {
          loadDashboard();
        } else if (target === 'runs') {
          loadRuns();
        } else if (target === 'datasource') {
          loadDataSource(); // dùng filter hiện tại
        } else if (target === 'settings') {
          loadSettings();
        } else if (target === 'overrides') {
          updateOverridesMetrics();
        }
      });
    });
  }

  // ---------- DASHBOARD ----------
  async function loadDashboard() {
    const data = await fetchJSON('/api/vsp/dashboard_v3');
    if (!data) return;

    const sev = data.severity || {};
    const total = data.total_findings || 0;
    const byTool = data.by_tool || {};
    const runId = data.run_id || '-';

    // KPI 6 severity + TOTAL
    $('#kpi-critical').textContent = fmt(sev.CRITICAL || 0);
    $('#kpi-high').textContent = fmt(sev.HIGH || 0);
    $('#kpi-medium').textContent = fmt(sev.MEDIUM || 0);
    $('#kpi-low').textContent = fmt(sev.LOW || 0);
    const infoTrace = (sev.INFO || 0) + (sev.TRACE || 0);
    $('#kpi-info-trace').textContent = fmt(infoTrace);
    $('#kpi-total').textContent = fmt(total);

    // Security Posture Score – nếu BE có trả thì dùng, không thì tính thô
    let score = data.security_score;
    if (score == null) {
      const critHigh = (sev.CRITICAL || 0) + (sev.HIGH || 0);
      score = critHigh === 0 ? 100 : Math.max(10, 100 - Math.log10(critHigh + 1) * 25);
      score = Math.round(score);
    }
    $('#kpi-score').textContent = score;

    // Top risky tool (dựa trên by_tool)
    let topTool = '–';
    let maxToolVal = -1;
    Object.entries(byTool).forEach(([tool, val]) => {
      if (val > maxToolVal) {
        maxToolVal = val;
        topTool = tool;
      }
    });
    $('#kpi-top-tool').textContent = topTool || '–';

    // Top CWE / Module – nếu BE trả thì gán, không có thì TBD
    $('#kpi-top-cwe').textContent = data.top_cwe || 'TBD';
    $('#kpi-top-module').textContent = data.top_module || 'TBD';

    // ENV footer
    if ($('#vsp-last-run-id')) {
      $('#vsp-last-run-id').textContent = runId;
    }

    // Donut severity
    safeDestroyChart('chartSeverity');
    const ctxSev = document.getElementById('chart-severity-donut');
    if (ctxSev) {
      const labels = ['CRITICAL', 'HIGH', 'MEDIUM', 'LOW', 'INFO', 'TRACE'];
      const values = labels.map((k) => sev[k] || 0);
      VSP.chartSeverity = new Chart(ctxSev, {
        type: 'doughnut',
        data: {
          labels,
          datasets: [
            {
              data: values,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: '68%',
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                boxWidth: 10,
              },
            },
          },
        },
      });
    }

    // Trend over time – dùng /api/vsp/runs để vẽ line
    const runs = await fetchJSON('/api/vsp/runs');
    safeDestroyChart('chartTrend');
    const ctxTrend = document.getElementById('chart-trend');
    if (ctxTrend && runs && Array.isArray(runs)) {
      const labels = runs.map((r) => r.run_id || '').slice(-20);
      const values = runs.map((r) => r.total_findings || 0).slice(-20);
      VSP.chartTrend = new Chart(ctxTrend, {
        type: 'line',
        data: {
          labels,
          datasets: [
            {
              data: values,
              tension: 0.3,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: { ticks: { display: false } },
          },
        },
      });
    }

    // Critical / High by Tool – nếu BE chưa tách thì dùng tổng by_tool
    safeDestroyChart('chartByTool');
    const ctxTool = document.getElementById('chart-by-tool');
    if (ctxTool && Object.keys(byTool).length > 0) {
      const labels = Object.keys(byTool);
      const values = Object.values(byTool);
      VSP.chartByTool = new Chart(ctxTool, {
        type: 'bar',
        data: {
          labels,
          datasets: [{ data: values }],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: { ticks: { autoSkip: true, maxRotation: 0 } },
          },
        },
      });
    }

    // Top CWE exposure – nếu BE trả sẵn top_cwe_list thì dùng, ko thì bỏ trống
    safeDestroyChart('chartTopCwe');
    const ctxCwe = document.getElementById('chart-top-cwe');
    const topCweList = data.top_cwe_list || [];
    if (ctxCwe && topCweList.length > 0) {
      const labels = topCweList.map((x) => x.cwe || '');
      const values = topCweList.map((x) => x.count || 0);
      VSP.chartTopCwe = new Chart(ctxCwe, {
        type: 'bar',
        data: { labels, datasets: [{ data: values }] },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: { ticks: { autoSkip: true, maxRotation: 0 } },
          },
        },
      });
    }

    // Bảng dưới (Top Risk Findings, Noisy Paths, CVEs, Tool&Severity)
    fillDashboardTablesFromDashboard(data);
  }

  function fillDashboardTablesFromDashboard(data) {
    // Các key này tuỳ BE, nếu chưa có thì bảng để trống (UI vẫn ổn)
    const topRisk = data.top_risk_findings || [];
    const noisy = data.top_noisy_paths || [];
    const cves = data.top_cves || [];
    const byToolSev = data.by_tool_severity || [];

    const tblRisk = $('#tbl-top-risk tbody');
    const tblNoisy = $('#tbl-noisy-paths tbody');
    const tblCves = $('#tbl-top-cves tbody');
    const tblToolSev = $('#tbl-tool-sev tbody');

    if (tblRisk) {
      tblRisk.innerHTML = topRisk
        .slice(0, 10)
        .map(
          (r) => `<tr>
            <td>${r.severity || ''}</td>
            <td>${r.tool || ''}</td>
            <td title="${r.file || ''}">${r.file || ''}</td>
            <td>${r.rule_id || ''}</td>
            <td title="${r.message || ''}">${r.message || ''}</td>
          </tr>`
        )
        .join('');
    }

    if (tblNoisy) {
      tblNoisy.innerHTML = noisy
        .slice(0, 10)
        .map(
          (r) => `<tr>
            <td title="${r.path || ''}">${r.path || ''}</td>
            <td>${fmt(r.findings || 0)}</td>
            <td>${fmt(r.crit_high || 0)}</td>
          </tr>`
        )
        .join('');
    }

    if (tblCves) {
      tblCves.innerHTML = cves
        .slice(0, 10)
        .map(
          (r) => `<tr>
            <td>${r.cve || ''}</td>
            <td>${r.module || ''}</td>
            <td>${r.severity || ''}</td>
            <td>${fmt(r.count || 0)}</td>
          </tr>`
        )
        .join('');
    }

    if (tblToolSev) {
      tblToolSev.innerHTML = byToolSev
        .map(
          (r) => `<tr>
            <td>${r.tool || ''}</td>
            <td>${fmt(r.CRITICAL || 0)}</td>
            <td>${fmt(r.HIGH || 0)}</td>
            <td>${fmt(r.MEDIUM || 0)}</td>
            <td>${fmt(r.LOW || 0)}</td>
            <td>${fmt((r.INFO || 0) + (r.TRACE || 0))}</td>
          </tr>`
        )
        .join('');
    }
  }

  // ---------- RUNS & REPORTS ----------
  async function loadRuns() {
    const runs = await fetchJSON('/api/vsp/runs');
    if (!runs || !Array.isArray(runs)) return;

    // KPI trên góc phải
    const totalRuns = runs.length;
    const avg =
      totalRuns === 0
        ? 0
        : runs.reduce((acc, r) => acc + (r.total_findings || 0), 0) / totalRuns;

    $('#runs-total').textContent = fmt(totalRuns);
    $('#runs-avg-findings').textContent = fmt(Math.round(avg));
    $('#runs-tools-enabled').textContent = '8';

    // Bảng history
    const tbody = $('#tbl-runs-history tbody');
    if (!tbody) return;

    const profileFilter = $('#runs-filter-profile').value || '';
    const severityFilter = $('#runs-filter-severity').value || '';
    const toolFilter = $('#runs-filter-tool').value || '';
    const timeFilter = $('#runs-filter-time').value || 'ALL';
    const search = ($('#runs-search').value || '').toLowerCase();

    const now = Date.now();
    const ms7d = 7 * 24 * 3600 * 1000;
    const ms30d = 30 * 24 * 3600 * 1000;

    const filtered = runs.filter((r) => {
      if (profileFilter && (r.profile || '') !== profileFilter) return false;
      // severityFilter/toolFilter có thể map vào r.by_severity / r.by_tool nếu BE có
      if (timeFilter === '7d' && r.ts) {
        const t = Date.parse(r.ts);
        if (!isNaN(t) && now - t > ms7d) return false;
      }
      if (timeFilter === '30d' && r.ts) {
        const t = Date.parse(r.ts);
        if (!isNaN(t) && now - t > ms30d) return false;
      }
      if (search) {
        const hay =
          (r.run_id || '') +
          ' ' +
          (r.src || '') +
          ' ' +
          (r.url || '') +
          ' ' +
          (r.commit || '');
        if (!hay.toLowerCase().includes(search)) return false;
      }
      return true;
    });

    tbody.innerHTML = filtered
      .map((r) => {
        const sev = r.by_severity || {};
        const total = r.total_findings || 0;
        const tools = (r.tools || []).join(', ');
        const runId = r.run_id || '';
        const reportUrl = r.report_html || `/api/vsp/run/${encodeURIComponent(
          runId
        )}/report/html`;
        return `<tr>
          <td title="${runId}">${runId}</td>
          <td>${r.ts || ''}</td>
          <td>${r.profile || ''}</td>
          <td title="${r.src || ''}">${r.src || ''}</td>
          <td title="${r.url || ''}">${r.url || ''}</td>
          <td>${fmt(sev.CRITICAL || 0)}</td>
          <td>${fmt(sev.HIGH || 0)}</td>
          <td>${fmt(sev.MEDIUM || 0)}</td>
          <td>${fmt(sev.LOW || 0)}</td>
          <td>${fmt((sev.INFO || 0) + (sev.TRACE || 0))}</td>
          <td>${fmt(total)}</td>
          <td title="${tools}">${tools || '8'}</td>
          <td><a href="${reportUrl}" target="_blank" rel="noopener">HTML</a></td>
        </tr>`;
      })
      .join('');
  }

  function initRunsFilters() {
    const ids = [
      '#runs-filter-profile',
      '#runs-filter-severity',
      '#runs-filter-tool',
      '#runs-filter-time',
      '#runs-search',
    ];
    ids.forEach((id) => {
      const el = $(id);
      if (!el) return;
      const evt = id === '#runs-search' ? 'input' : 'change';
      el.addEventListener(evt, () => loadRuns());
    });
  }

  // ---------- DATA SOURCE ----------
  async function loadDataSource() {
    const sev = $('#ds-filter-severity')?.value || '';
    const tool = $('#ds-filter-tool')?.value || '';
    const folder = $('#ds-filter-folder')?.value || '';
    const search = $('#ds-filter-search')?.value || '';

    const params = new URLSearchParams();
    if (sev) params.set('severity', sev);
    if (tool) params.set('tool', tool);
    if (folder) params.set('folder', folder);
    if (search) params.set('search', search);
    params.set('limit', '500');
    params.set('offset', '0');

    const url = '/api/vsp/datasource?' + params.toString();
    const data = await fetchJSON(url);
    if (!data || !Array.isArray(data.items)) return;

    const tbody = $('#tbl-ds-findings tbody');
    if (!tbody) return;

    tbody.innerHTML = data.items
      .map((it) => {
        return `<tr>
          <td>${it.severity || ''}</td>
          <td>${it.tool || ''}</td>
          <td title="${it.file || ''}">${it.file || ''}</td>
          <td>${it.line || ''}</td>
          <td>${it.rule_id || it.rule || ''}</td>
          <td title="${it.message || ''}">${it.message || ''}</td>
          <td>${it.cwe || ''}</td>
          <td>${it.cve || ''}</td>
          <td>${it.module || ''}</td>
          <td title="${it.fix || ''}">${it.fix || ''}</td>
          <td>${(it.tags || []).join(', ')}</td>
        </tr>`;
      })
      .join('');

    // Mini charts – build từ tập 500 record này
    buildDataSourceCharts(data.items);
  }

  function buildDataSourceCharts__old(items) {
    const sevCounts = {};
    const toolCounts = {};
    const cweCounts = {};
    const dirCounts = {};

    items.forEach((it) => {
      const sev = it.severity || 'UNKNOWN';
      sevCounts[sev] = (sevCounts[sev] || 0) + 1;

      const tool = it.tool || 'unknown';
      toolCounts[tool] = (toolCounts[tool] || 0) + 1;

      const cwe = it.cwe || 'N/A';
      cweCounts[cwe] = (cweCounts[cwe] || 0) + 1;

      const file = it.file || '';
      let dir = file;
      const idx = file.lastIndexOf('/');
      if (idx > 0) dir = file.slice(0, idx);
      dirCounts[dir] = (dirCounts[dir] || 0) + 1;
    });

    const top = (obj, n) =>
      Object.entries(obj)
        .sort((a, b) => b[1] - a[1])
        .slice(0, n);

    // Severity donut
    safeDestroyChart('dsChartSeverity');
    const ctx1 = document.getElementById('ds-chart-severity');
    if (ctx1) {
      const labels = ['CRITICAL', 'HIGH', 'MEDIUM', 'LOW', 'INFO', 'TRACE'];
      const data = labels.map((k) => sevCounts[k] || 0);
      VSP.dsChartSeverity = new Chart(ctx1, {
        type: 'doughnut',
        data: { labels, datasets: [{ data }] },
        options: { responsive: true, maintainAspectRatio: false },
      });
    }

    // By tool
    safeDestroyChart('dsChartTool');
    const ctx2 = document.getElementById('ds-chart-tool');
    if (ctx2) {
      const arr = top(toolCounts, 8);
      VSP.dsChartTool = new Chart(ctx2, {
        type: 'bar',
        data: {
          labels: arr.map((x) => x[0]),
          datasets: [{ data: arr.map((x) => x[1]) }],
        },
        options: { responsive: true, maintainAspectRatio: false },
      });
    }

    // Top 5 CWE
    safeDestroyChart('dsChartCwe');
    const ctx3 = document.getElementById('ds-chart-cwe');
    if (ctx3) {
      const arr = top(cweCounts, 5);
      VSP.dsChartCwe = new Chart(ctx3, {
        type: 'bar',
        data: {
          labels: arr.map((x) => x[0]),
          datasets: [{ data: arr.map((x) => x[1]) }],
        },
        options: { responsive: true, maintainAspectRatio: false },
      });
    }

    // Top 5 directories
    safeDestroyChart('dsChartDir');
    const ctx4 = document.getElementById('ds-chart-dir');
    if (ctx4) {
      const arr = top(dirCounts, 5);
      VSP.dsChartDir = new Chart(ctx4, {
        type: 'bar',
        data: {
          labels: arr.map((x) => x[0]),
          datasets: [{ data: arr.map((x) => x[1]) }],
        },
        options: { responsive: true, maintainAspectRatio: false },
      });
    }
  }

  function initDataSourceFilters() {
    ['#ds-filter-severity', '#ds-filter-tool'].forEach((id) => {
      const el = $(id);
      if (!el) return;
      el.addEventListener('change', () => loadDataSource());
    });
    const folder = $('#ds-filter-folder');
    const search = $('#ds-filter-search');
    if (folder) folder.addEventListener('input', () => loadDataSource());
    if (search) search.addEventListener('input', () => loadDataSource());
    const btn = $('#ds-refresh-btn');
    if (btn) btn.addEventListener('click', () => loadDataSource());
  }

  // ---------- SETTINGS ----------
  async function loadSettings() {
    const data = await fetchJSON('/api/vsp/settings');
    if (!data) return;

    $('#set-src-default').textContent = data.src_path || '–';
    $('#set-profile').textContent = data.profile || 'EXT';
    $('#set-last-run').textContent = data.last_run_id || '–';

    if ($('#vsp-src-input') && data.src_path) {
      $('#vsp-src-input').value = data.src_path;
    }
    if ($('#vsp-env-label')) {
      $('#vsp-env-label').textContent = `ENV: EXT / staging`;
    }

    const tools = data.tools || {};
    const tbody = $('#tbl-tool-stack tbody');
    if (!tbody) return;

    const TYPE_MAP = {
      gitleaks: 'Secrets',
      semgrep: 'SAST',
      kics: 'IaC',
      codeql: 'CodeQL',
      bandit: 'Python SAST',
      trivy_fs: 'FS scan',
      grype: 'Vuln DB',
      syft: 'SBOM',
    };

    tbody.innerHTML = Object.keys(tools)
      .map((k) => {
        const enabled = tools[k];
        const type = TYPE_MAP[k] || '';
        return `<tr>
          <td>${k}</td>
          <td>${type}</td>
          <td>${enabled ? 'ON' : 'OFF'}</td>
          <td>—</td>
        </tr>`;
      })
      .join('');
  }

  // ---------- RULE OVERRIDES (client preview) ----------
  function updateOverridesMetrics() {
    const txt = $('#overrides-editor')?.value || '';
    if (!txt) {
      $('#ovr-count').textContent = '0';
      $('#ovr-critical-downgraded').textContent = '0';
      $('#ovr-top-rule').textContent = '–';
      return;
    }

    const lines = txt.split('\n');
    let count = 0;
    let critDown = 0;
    const ruleFreq = {};

    let currentRule = null;
    lines.forEach((raw) => {
      const line = raw.trim();
      if (line.startsWith('- id:')) {
        currentRule = line.split(':')[1].trim();
        count += 1;
        ruleFreq[currentRule] = (ruleFreq[currentRule] || 0) + 1;
      }
      if (currentRule && line.startsWith('severity:')) {
        const sev = line.split(':')[1].trim().toUpperCase();
        if (sev !== 'CRITICAL') {
          critDown += 1;
        }
      }
    });

    let topRule = '–';
    let maxCount = 0;
    Object.entries(ruleFreq).forEach(([rule, c]) => {
      if (c > maxCount) {
        maxCount = c;
        topRule = rule;
      }
    });

    $('#ovr-count').textContent = String(count);
    $('#ovr-critical-downgraded').textContent = String(critDown);
    $('#ovr-top-rule').textContent = topRule || '–';
  }

  function initOverrides() {
    const editor = $('#overrides-editor');
    if (editor) {
      editor.addEventListener('input', () => updateOverridesMetrics());
    }
    const btn = $('#ovr-apply-btn');
    if (btn) {
      btn.addEventListener('click', () => {
        updateOverridesMetrics();
        btn.textContent = 'PREVIEW UPDATED';
        setTimeout(() => (btn.textContent = 'APPLY PREVIEW'), 1200);
      });
    }
  }

  // ---------- RUN BUTTON ----------

  // Đợi backend hoàn thành scan & unify cho run_id mới
  async function waitForRunCompletion(expectedRunId) {
    const maxAttempts = 60;       // ~5 phút nếu 5s/lần
    const intervalMs = 5000;

    for (let i = 0; i < maxAttempts; i++) {
      const d = await fetchJSON('/api/vsp/dashboard_v3');
      if (d && d.run_id === expectedRunId) {
        // Khi dashboard đã trỏ sang run mới: reload toàn bộ data
        await loadDashboard();
        await loadRuns();
        await loadDataSource();
        await loadSettings();
        return true;
      }
      await new Promise((resolve) => setTimeout(resolve, intervalMs));
    }
    return false;
  }

  function initRunButton() {

    const btn = $('#vsp-run-btn');
    if (!btn) return;

    btn.addEventListener('click', async () => {
      const src = $('#vsp-src-input')?.value || '';
      const profile = $('#vsp-profile-select')?.value || 'EXT';
      if (!src) {
        alert('Please input SRC path first.');
        return;
      }

      btn.disabled = true;
      const oldText = btn.textContent;
      btn.textContent = 'RUNNING...';

      const payload = {
        src_path: src,
        profile: profile,
        level: profile,
        no_net: 0,
      };

      const res = await fetchJSON('/api/vsp/run', {
        method: 'POST',
        body: JSON.stringify(payload),
      });

      btn.disabled = false;
      btn.textContent = oldText;

      if (!res || res.status !== 'ok') {
        alert('Run failed. Please check backend logs.');
        return;
      }

      // Sau khi scan xong: reload Dashboard + Runs + DataSource + Settings
      loadDashboard();
      loadRuns();
      loadDataSource();
      loadSettings();
    });
  }

  // ---------- INIT ----------
  function init() {
    initTabs();
    initRunsFilters();
    initDataSourceFilters();
    initOverrides();
    initRunButton();

    // Load ban đầu: dashboard + settings + runs (dashboard dùng /runs cho trend)
    loadDashboard();
    loadSettings();
    loadRuns();
    // Data source sẽ tự load khi user click tab hoặc khi dashboard gọi riêng
  }

  // PATCH 2025-12-01 – buildDataSourceCharts: bỏ label 'undefined', 'N/A', rỗng
  function buildDataSourceCharts(items) {
    items = Array.isArray(items) ? items : [];

    const sevCounts  = {};
    const toolCounts = {};
    const cweCounts  = {};
    const dirCounts  = {};

    items.forEach(function (it) {
      // Severity
      if (it.severity) {
        var sev = String(it.severity).toUpperCase();
        sevCounts[sev] = (sevCounts[sev] || 0) + 1;
      }

      // Tool
      if (it.tool) {
        var tool = String(it.tool);
        toolCounts[tool] = (toolCounts[tool] || 0) + 1;
      }

      // CWE
      if (it.cwe) {
        var cwe = String(it.cwe);
        cweCounts[cwe] = (cweCounts[cwe] || 0) + 1;
      }

      // Directory
      if (it.file) {
        var file = String(it.file);
        var idx  = file.lastIndexOf('/');
        var dir  = idx > 0 ? file.slice(0, idx) : file;
        dirCounts[dir] = (dirCounts[dir] || 0) + 1;
      }
    });

    function topEntries(obj, n, opts) {
      opts = opts || {};
      var allowNA = !!opts.allowNA;

      return Object.entries(obj)
        .filter(function ([k, v]) {
          if (!k || v <= 0) return false;
          var key = String(k).trim().toUpperCase();
          if (!allowNA && (key === 'UNDEFINED' || key === 'N/A')) return false;
          return true;
        })
        .sort(function (a, b) { return b[1] - a[1]; })
        .slice(0, n);
    }

    // ----- Severity donut -----
    safeDestroyChart('dsChartSeverity');
    var ctx1 = document.getElementById('ds-chart-severity');
    if (ctx1) {
      var sevLabels = ['CRITICAL', 'HIGH', 'MEDIUM', 'LOW', 'INFO', 'TRACE'];
      var sevData   = sevLabels.map(function (k) { return sevCounts[k] || 0; });
      VSP.dsChartSeverity = new Chart(ctx1, {
        type: 'doughnut',
        data: {
          labels: sevLabels,
          datasets: [{ data: sevData }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false
        }
      });
    }

    // ----- Findings by tool -----
    safeDestroyChart('dsChartTool');
    var ctx2 = document.getElementById('ds-chart-tool');
    if (ctx2) {
      var toolArr = topEntries(toolCounts, 8, { allowNA: false });
      if (toolArr.length > 0) {
        VSP.dsChartTool = new Chart(ctx2, {
          type: 'bar',
          data: {
            labels: toolArr.map(function (x) { return x[0]; }),
            datasets: [{ data: toolArr.map(function (x) { return x[1]; }) }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: {
                ticks: {
                  callback: function (val, idx, ticks) {
                    var label = this.getLabelForValue(val) || '';
                    return label.length > 10 ? label.slice(0, 10) + '…' : label;
                  }
                }
              }
            }
          }
        });
      }
    }

    // ----- Top 5 CWE -----
    safeDestroyChart('dsChartCwe');
    var ctx3 = document.getElementById('ds-chart-cwe');
    if (ctx3) {
      var cweArr = topEntries(cweCounts, 5, { allowNA: false });
      if (cweArr.length > 0) {
        VSP.dsChartCwe = new Chart(ctx3, {
          type: 'bar',
          data: {
            labels: cweArr.map(function (x) { return x[0]; }),
            datasets: [{ data: cweArr.map(function (x) { return x[1]; }) }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: {
                ticks: {
                  callback: function (val, idx, ticks) {
                    var label = this.getLabelForValue(val) || '';
                    return label.length > 14 ? label.slice(0, 14) + '…' : label;
                  }
                }
              }
            }
          }
        });
      }
    }

    // ----- Top 5 directories -----
    safeDestroyChart('dsChartDir');
    var ctx4 = document.getElementById('ds-chart-dir');
    if (ctx4) {
      var dirArr = topEntries(dirCounts, 5, { allowNA: false });
      if (dirArr.length > 0) {
        VSP.dsChartDir = new Chart(ctx4, {
          type: 'bar',
          data: {
            labels: dirArr.map(function (x) { return x[0]; }),
            datasets: [{ data: dirArr.map(function (x) { return x[1]; }) }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: {
                ticks: {
                  callback: function (val, idx, ticks) {
                    var label = this.getLabelForValue(val) || '';
                    // Chỉ show tên thư mục cuối cho gọn
                    var parts = label.split('/');
                    var last  = parts[parts.length - 1] || label;
                    return last.length > 14 ? last.slice(0, 14) + '…' : last;
                  }
                }
              }
            }
          }
        });
      }
    }
  }

  document.addEventListener('DOMContentLoaded', init);
})();

})();
/* ==== END: static/js/vsp_vertical.js ==== */


/* ===================== VSP_DRILLDOWN_BRIDGE_P0_V1 ===================== */
(function(){
  'use strict';
  try{
    // Ensure single entrypoint exists
    if (typeof window.VSP_DRILLDOWN !== 'function') {
      window.VSP_DRILLDOWN = function(intent){
        try{
          console.warn('[VSP][P0] VSP_DRILLDOWN missing impl; fallback intent=', intent);
          // Safe fallback: open datasource tab
          if (intent && typeof intent === 'object') {
            if (intent.intent === 'datasource' || intent.intent === 'total' || intent.intent === 'artifacts') {
              if (location && typeof location.hash === 'string') location.hash = '#datasource';
            }
          }
        }catch(_){}
      };
    }

    function wrap(name, intentName){
      if (typeof window[name] === 'function') return;
      window[name] = function(){
        try{
          return window.VSP_DRILLDOWN({ intent: intentName, args: Array.prototype.slice.call(arguments) });
        }catch(e){
          try{ console.warn('[VSP][P0] '+name+' failed', e); }catch(_){}
        }
      };
    }

    // Fix the exact crash you are seeing
    wrap('VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2', 'artifacts');

    // Optional: prevent future “not a function” on other pills/buttons
    wrap('VSP_DASH_DRILLDOWN_TOTAL_P1_V2', 'total');
    wrap('VSP_DASH_DRILLDOWN_CRITICAL_P1_V2', 'critical');
    wrap('VSP_DASH_DRILLDOWN_HIGH_P1_V2', 'high');
    wrap('VSP_DASH_DRILLDOWN_MEDIUM_P1_V2', 'medium');
    wrap('VSP_DASH_DRILLDOWN_LOW_P1_V2', 'low');
    wrap('VSP_DASH_DRILLDOWN_INFO_P1_V2', 'info');
    wrap('VSP_DASH_DRILLDOWN_TRACE_P1_V2', 'trace');

    console.log('[VSP][P0] drilldown bridge installed');
  }catch(_){}
})();

