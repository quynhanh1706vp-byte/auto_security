/* VSP_UI_ROUTE_LOADER_V1: load per-route modules; never crash whole UI */
(function(){
  'use strict';
  



/* VSP_FIX_DRILLDOWN_CALLSITE_P0_V3: safe-call for drilldown artifacts (function OR object.open) */
function __VSP_DD_ART_CALL__(h, ...args) {
  try {
    if (typeof h === 'function') return h(...args);
    if (h && typeof h.open === 'function') return h.open(...args);
  } catch (e) {
    try { console.warn('[VSP][DD_SAFE] call failed', e); } catch (_e) {}
  }
  return null;
}

/* VSP_FIX_DRILLDOWN_ARTIFACTS_NOT_FUNCTION_P0_V2
 * Fix: TypeError __VSP_DD_ART_CALL__(VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2, ...) is not a function
 * Normalize BEFORE first use:
 *   - if function: keep
 *   - if object with .open(): wrap as function(arg)->obj.open(arg)
 *   - else: no-op (never throw)
 */
(function(){
  'use strict';
  if (window.__VSP_FIX_DRILLDOWN_ARTIFACTS_NOT_FUNCTION_P0_V2) return;
  window.__VSP_FIX_DRILLDOWN_ARTIFACTS_NOT_FUNCTION_P0_V2 = 1;

  function normalize(v){
    if (typeof v === 'function') return v;
    if (v && typeof v.open === 'function') {
      const obj = v;
      const fn = function(arg){ try { return obj.open(arg); } catch(e){ console.warn('[VSP][DD_FIX] open() failed', e); return null; } };
      fn.__wrapped_from_object = true;
      return fn;
    }
    const noop = function(_arg){ return null; };
    noop.__noop = true;
    return noop;
  }

  try {
    // trap future assignments
    let _val = window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2;
    Object.defineProperty(window, 'VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2', {
      configurable: true, enumerable: true,
      get: function(){ return _val; },
      set: function(v){ _val = normalize(v); }
    });
    window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 = _val;
  } catch(e) {
    window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2 = normalize(window.VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2);
  }
})();

if (window.__VSP_UI_ROUTE_LOADER_V1) return;
  window.__VSP_UI_ROUTE_LOADER_V1 = 1;

  // VSP_DRILLDOWN_PROTECT_HARD_V1: keep drilldown symbols always callable even if patches overwrite them
  (function(){
    try{
      function protect(name){
        let fn = (typeof window[name] === 'function') ? window[name] : function(){ return false; };
        Object.defineProperty(window, name, {
          configurable: true,
          enumerable: true,
          get(){ return fn; },
          set(v){
            if (typeof v === 'function') fn = v;
            else {
              try{ console.warn('[VSP_PROTECT] ignore non-function overwrite for', name, typeof v); }catch(_){}
            }
          }
        });
      }
      protect('VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2');
      protect('VSP_DASH_DRILLDOWN_ARTIFACTS_P0_V1');
    }catch(_){}
  })();


  // --- commercial hardening: drilldown stubs (avoid patch-chồng overwrite) ---
  (function(){
    try{
      const mk = (name) => {
        if (typeof window[name] !== 'function'){
          // if overwritten by old patches, force reset
          window[name] = function(){
            try{ console.warn('[VSP_STUB]', name, 'called but not implemented'); }catch(_){}
            return false;
          };
        }
      };
      mk('VSP_DASH_DRILLDOWN_ARTIFACTS_P1_V2');
      mk('VSP_DASH_DRILLDOWN_ARTIFACTS_P0_V1');
    }catch(_){}
  })();
  // --- end hardening ---


  const LOADED = new Set();
  const LOADING = new Map();

  function toast(msg){
    try{
      let el = document.getElementById('vsp-toast');
      if(!el){
        el = document.createElement('div');
        el.id = 'vsp-toast';
        el.style.cssText = [
          'position:fixed','right:16px','bottom:16px','z-index:99999',
          'max-width:520px','padding:10px 12px','border-radius:12px',
          'background:rgba(17,24,39,0.95)','color:#e5e7eb',
          'box-shadow:0 10px 30px rgba(0,0,0,0.35)',
          'font:12px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial',
          'border:1px solid rgba(255,255,255,0.08)'
        ].join(';');
        document.body.appendChild(el);
      }
      el.textContent = msg;
      el.style.display='block';
      clearTimeout(el.__t);
      el.__t = setTimeout(()=>{ el.style.display='none'; }, 4500);
    }catch(_){}
  }

  function loadScriptOnce(src){
    if (LOADED.has(src)) return Promise.resolve(true);
    if (LOADING.has(src)) return LOADING.get(src);

    const p = new Promise((resolve) => {
      const s = document.createElement('script');
      s.src = src + (src.includes('?') ? '&' : '?') + 'v=' + Date.now();
      s.async = true;

      const done = (ok) => {
        try{ s.onload = s.onerror = null; }catch(_){}
        LOADING.delete(src);
        if(ok) LOADED.add(src);
        resolve(ok);
      };

      const t = setTimeout(() => {
        console.warn('[VSP_LOADER] timeout:', src);
        toast('JS load timeout: ' + src);
        done(false);
      }, 6000);

      s.onload = () => { clearTimeout(t); done(true); };
      s.onerror = () => {
        clearTimeout(t);
        console.warn('[VSP_LOADER] failed:', src);
        toast('JS load failed: ' + src);
        done(false);
      };

      document.head.appendChild(s);
    });

    LOADING.set(src, p);
    return p;
  }

  function normRoute(){
    let h = (location.hash || '').replace(/^#/, '').trim();
    if (!h) return 'dashboard';
    h = h.split('?')[0].split('&')[0].trim();
    // normalize synonyms
    if (h === 'runs-reports' || h === 'reports') return 'runs';
    if (h === 'data' || h === 'datasource') return 'datasource';
    if (h === 'rules' || h === 'rule-overrides') return 'rules';
    return h;
  }

  function plan(route){
    const f = (window.__VSP_FEATURE_FLAGS__ || {});
    const scripts = [];

    if (route === 'dashboard' && f.DASHBOARD_CHARTS){
      scripts.push('/static/js/vsp_dashboard_enhance_v1.js');
      scripts.push('/static/js/vsp_dashboard_charts_pretty_v3.js');
      scripts.push('/static/js/vsp_degraded_panel_hook_v3.js');
    }

    if (route === 'runs' && f.RUNS_PANEL){
      scripts.push('/static/js/vsp_runs_tab_resolved_v1.js');
    }

    if ((route === 'datasource' || route === 'data') && f.DATASOURCE_TAB){
      scripts.push('/static/js/vsp_datasource_tab_v1.js');
    }

    if (route === 'settings' && f.SETTINGS_TAB){
      scripts.push('/static/js/vsp_settings_tab_v1.js');
    }

    if ((route === 'rules') && f.RULE_OVERRIDES_TAB){
      scripts.push('/static/js/vsp_rule_overrides_tab_v1.js');
    }

    return scripts;
  }

  async function ensure(){
    const r = normRoute();
    const list = plan(r);
    if (!list.length) return;
    console.log('[VSP_LOADER] route=', r, 'scripts=', list);
    for (const src of list){
      // không “fail toàn UI” nếu 1 file hỏng
      await loadScriptOnce(src);
    }
  }

  window.addEventListener('hashchange', () => { ensure(); });

  window.addEventListener('error', (e) => {
    try{
      const msg = (e && e.message) ? e.message : 'JS error';
      console.warn('[VSP] window.error:', msg);
      toast('JS error: ' + msg);
    }catch(_){}
  });

  window.addEventListener('unhandledrejection', (e) => {
    try{
      const msg = (e && e.reason && (e.reason.message || String(e.reason))) || 'Promise rejection';
      console.warn('[VSP] unhandledrejection:', msg);
      toast('Promise rejection: ' + msg);
    }catch(_){}
  });

  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', ensure);
  } else {
    ensure();
  }
})();
