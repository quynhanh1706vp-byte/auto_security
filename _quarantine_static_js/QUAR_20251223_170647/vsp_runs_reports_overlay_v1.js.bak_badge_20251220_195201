/* VSP Runs & Reports Overlay V1
 * - Safe: independent renderer for /runs
 * - Uses: /api/ui/runs_kpi_v2 + /api/ui/runs_v3?limit=&offset=
 */
(()=> {
  if (window.__vsp_runs_overlay_v1) return;
  window.__vsp_runs_overlay_v1 = true;

  const API_KPI  = "/api/ui/runs_kpi_v2";
  const API_RUNS = "/api/ui/runs_v3";

  const $ = (sel, root=document)=> root.querySelector(sel);
  const el = (tag, attrs={}, kids=[])=>{
    const n=document.createElement(tag);
    for (const [k,v] of Object.entries(attrs||{})){
      if (k==="class") n.className=v;
      else if (k==="style") n.setAttribute("style", v);
      else if (k.startsWith("on") && typeof v==="function") n.addEventListener(k.slice(2), v);
      else n.setAttribute(k, v);
    }
    for (const k of (kids||[])){
      if (k==null) continue;
      if (typeof k==="string") n.appendChild(document.createTextNode(k));
      else n.appendChild(k);
    }
    return n;
  };

  async function api(url){
    const r = await fetch(url, {cache:"no-store"});
    const t = await r.text();
    let j=null;
    try{ j = JSON.parse(t); } catch(_){
      throw new Error("bad_json: " + url + " body=" + t.slice(0,200));
    }
    if (!r.ok || !j || j.ok !== true){
      throw new Error("api_err: " + url + " status=" + r.status + " body=" + t.slice(0,200));
    }
    return j;
  }

  function pill(txt, cls){
    return el("span",{class:"pill "+(cls||"")},[txt]);
  }

  function overallClass(x){
    x = (x||"UNKNOWN").toUpperCase();
    if (x==="GREEN") return "ok";
    if (x==="AMBER") return "warn";
    if (x==="RED") return "bad";
    return "unk";
  }

  function fmtTime(sec){
    if (!sec) return "-";
    const d = new Date(sec*1000);
    return d.toISOString().replace("T"," ").replace(".000Z","Z");
  }

  function ensureHost(){
    // /runs template của bạn có .wrap; nếu không có thì fallback body
    return $(".wrap") || document.body;
  }

  function injectStyles(){
    if ($("#VSP_RUNS_OVERLAY_STYLE_V1")) return;
    const css = `
#vspRunsOverlayV1{margin-top:12px}
#vspRunsOverlayV1 .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;margin:10px 0}
#vspRunsOverlayV1 .kpis{display:flex;gap:10px;flex-wrap:wrap}
#vspRunsOverlayV1 .kpi{min-width:160px;border:1px solid rgba(27,42,85,.75);border-radius:14px;background:rgba(10,16,32,.55);padding:10px}
#vspRunsOverlayV1 .kpi .t{color:var(--muted);font-size:12px}
#vspRunsOverlayV1 .kpi .v{font-size:20px;font-weight:800;margin-top:4px}
#vspRunsOverlayV1 .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
#vspRunsOverlayV1 select{padding:8px 10px;border:1px solid var(--line);border-radius:10px;background:rgba(10,16,32,.6);color:var(--txt)}
#vspRunsOverlayV1 .mini{color:var(--muted);font-size:12px}
#vspRunsOverlayV1 .pill{display:inline-block;padding:3px 8px;border-radius:999px;background:var(--chip);border:1px solid rgba(27,42,85,.65);margin-right:6px}
#vspRunsOverlayV1 .ok{color:var(--ok)} .bad{color:var(--bad)} .warn{color:var(--warn)} .unk{color:var(--muted)}
#vspRunsOverlayV1 table{width:100%;border-collapse:separate;border-spacing:0;margin-top:10px;overflow:hidden;border-radius:12px}
#vspRunsOverlayV1 thead th{position:sticky;top:0;background:rgba(14,22,48,.9);backdrop-filter:blur(6px);
  color:var(--muted);font-weight:600;text-align:left;padding:10px;border-bottom:1px solid var(--line)}
#vspRunsOverlayV1 tbody td{padding:10px;border-bottom:1px solid rgba(27,42,85,.45);vertical-align:middle}
#vspRunsOverlayV1 tbody tr:hover{background:rgba(15,27,61,.25)}
#vspRunsOverlayV1 .btn{padding:8px 12px;border:1px solid var(--line);border-radius:10px;background:rgba(10,16,32,.6);cursor:pointer}
#vspRunsOverlayV1 .btn:hover{filter:brightness(1.08)}
#vspRunsOverlayV1 .err{margin-top:10px;color:#FFD0D6;white-space:pre-wrap}
`;
    const st = el("style",{id:"VSP_RUNS_OVERLAY_STYLE_V1"},[css]);
    document.head.appendChild(st);
  }

  function mountUI(){
    injectStyles();
    const host = ensureHost();
    if ($("#vspRunsOverlayV1")) return $("#vspRunsOverlayV1");

    const root = el("div",{id:"vspRunsOverlayV1", class:"panel"},[]);
    const topRow = el("div",{class:"row"},[]);
    const kpis = el("div",{class:"kpis"},[]);
    const controls = el("div",{class:"controls"},[]);

    const q = el("input",{placeholder:"search rid / path ...", style:"min-width:320px"},[]);
    const pageSize = el("select",{},[
      el("option",{value:"10"},["10/page"]),
      el("option",{value:"20", selected:"selected"},["20/page"]),
      el("option",{value:"50"},["50/page"]),
      el("option",{value:"100"},["100/page"]),
    ]);
    const prevBtn = el("button",{class:"btn"},["Prev"]);
    const nextBtn = el("button",{class:"btn"},["Next"]);
    const pageInfo = el("span",{class:"mini"},["offset=0"]);

    controls.appendChild(q);
    controls.appendChild(pageSize);
    controls.appendChild(prevBtn);
    controls.appendChild(nextBtn);
    controls.appendChild(pageInfo);

    topRow.appendChild(kpis);
    topRow.appendChild(controls);

    const table = el("table",{},[
      el("thead",{},[
        el("tr",{},[
          el("th",{},["RID"]),
          el("th",{},["Overall"]),
          el("th",{},["Findings"]),
          el("th",{},["Updated"]),
          el("th",{},["Notes"]),
        ])
      ]),
      el("tbody",{},[])
    ]);

    const errBox = el("div",{class:"err", style:"display:none"},[""]);
    root.appendChild(topRow);
    root.appendChild(table);
    root.appendChild(errBox);

    host.appendChild(root);

    return {root, kpis, q, pageSize, prevBtn, nextBtn, pageInfo, tbody: $("tbody", table), errBox};
  }

  function setErr(ui, msg){
    ui.errBox.style.display = msg ? "block" : "none";
    ui.errBox.textContent = msg || "";
  }

  function kpiCard(title, value, cls){
    return el("div",{class:"kpi"},[
      el("div",{class:"t"},[title]),
      el("div",{class:"v "+(cls||"")},[String(value)]),
    ]);
  }

  let offset = 0;
  let total = 0;
  let lastItems = [];

  function renderTable(ui, items){
    ui.tbody.innerHTML = "";
    const term = (ui.q.value||"").trim().toLowerCase();

    const filtered = !term ? items : items.filter(x=>{
      const s = (x.rid||"") + " " + (x.run_dir||"") + " " + (x.findings_path||"");
      return s.toLowerCase().includes(term);
    });

    for (const it of filtered){
      const rid = it.rid || "-";
      const ov  = (it.overall || "UNKNOWN").toUpperCase();
      const ft  = (it.findings_total ?? it.total ?? 0);
      const notes = [
        it.has_findings ? "has_findings" : "no_findings",
        it.has_gate ? "has_gate" : "no_gate",
      ].join(", ");

      const tr = el("tr",{},[
        el("td",{},[rid]),
        el("td",{},[pill(ov, overallClass(ov))]),
        el("td",{},[String(ft)]),
        el("td",{},[fmtTime(it.mtime)]),
        el("td",{},[notes]),
      ]);
      ui.tbody.appendChild(tr);
    }

    ui.pageInfo.textContent = `offset=${offset} / total=${total} / showing=${filtered.length}`;
  }

  async function loadKPI(ui){
    const j = await api(API_KPI);
    ui.kpis.innerHTML = "";
    ui.kpis.appendChild(kpiCard("Total runs", j.total_runs ?? "-", ""));
    const by = j.by_overall || {};
    ui.kpis.appendChild(kpiCard("GREEN",  by.GREEN  ?? 0, "ok"));
    ui.kpis.appendChild(kpiCard("AMBER",  by.AMBER  ?? 0, "warn"));
    ui.kpis.appendChild(kpiCard("RED",    by.RED    ?? 0, "bad"));
    ui.kpis.appendChild(kpiCard("UNKNOWN",by.UNKNOWN?? 0, "unk"));
  }

  async function loadRuns(ui){
    const lim = parseInt(ui.pageSize.value || "20", 10);
    const j = await api(`${API_RUNS}?limit=${encodeURIComponent(lim)}&offset=${encodeURIComponent(offset)}`);
    total = j.total ?? 0;
    lastItems = j.items || [];
    renderTable(ui, lastItems);
  }

  function wire(ui){
    ui.q.addEventListener("input", ()=> renderTable(ui, lastItems));
    ui.pageSize.addEventListener("change", async ()=>{
      offset = 0;
      try{ setErr(ui,""); await loadRuns(ui); } catch(e){ setErr(ui, String(e)); }
    });
    ui.prevBtn.addEventListener("click", async ()=>{
      const lim = parseInt(ui.pageSize.value || "20", 10);
      offset = Math.max(0, offset - lim);
      try{ setErr(ui,""); await loadRuns(ui); } catch(e){ setErr(ui, String(e)); }
    });
    ui.nextBtn.addEventListener("click", async ()=>{
      const lim = parseInt(ui.pageSize.value || "20", 10);
      offset = Math.min(Math.max(0, total - 1), offset + lim);
      try{ setErr(ui,""); await loadRuns(ui); } catch(e){ setErr(ui, String(e)); }
    });
  }

  async function boot(){
    // only run on /runs
    if (!location.pathname || !location.pathname.startsWith("/runs")) return;
    const ui = mountUI();
    wire(ui);
    try{
      setErr(ui,"");
      await loadKPI(ui);
      await loadRuns(ui);
    } catch(e){
      setErr(ui, String(e));
    }
  }

  window.addEventListener("DOMContentLoaded", boot);
})();
