
// VSP_P0_THROTTLE_POLLING_RID_LATEST_V1
function __vspVisible(){ try{return document.visibilityState==='visible';}catch(e){return true;} }
window.__vspCheckDegraded = function(){ return; };


/* VSP_P0_DASH_FETCH_KPI_WITH_RID_LATEST_V1 */
async function vspGetRidLatestSafe(){
  try{
    const r = await ((typeof __vspVisible==="function" && !__vspVisible())
      ? Promise.resolve(null)
      : fetch("/api/vsp/rid_latest", {cache:"no-store"}).catch(()=>null));
    const j = await r.json();
    return (j && j.rid) ? String(j.rid) : "";
  }catch(e){ return ""; }
}
function vspWithRid(url, rid){
  if(!rid) return url;
  return url + (url.includes("?") ? "&" : "?") + "rid=" + encodeURIComponent(rid);
}

/* VSP_P2_6E_LUXE_JGET_UNWRAP_RUN_FILE_ALLOW_V1 */
/* VSP_P2_6D_LUXE_HEAD_ROOT_FIX_V1 */
/* VSP_LUXE_HIDE_LEGACY_V1 */
/* VSP_DASH_LUXE_V1 (Commercial polish; safe, no-throw) */
(() => {
  

/* VSP_RUNFILEALLOW_FETCH_GUARD_V3C
   - prevent 404 spam when rid missing/invalid
   - auto add default path when missing
   - covers fetch + XMLHttpRequest
*/
(()=> {
  try {
    if (window.__vsp_runfileallow_fetch_guard_v3c) return;
    window.__vsp_runfileallow_fetch_guard_v3c = true;

    function _isLikelyRid(rid){
      if(!rid || typeof rid !== "string") return false;
      if(rid.length < 6) return false;
      if(rid.includes("{") || rid.includes("}")) return false;
      return /^[A-Za-z0-9_\-]+$/.test(rid);
    }

    function _fix(url0){
      try{
        if(!url0 || typeof url0 !== "string") return {action:"pass"};
        if(!url0.includes("/api/vsp/run_file_allow")) return {action:"pass"};
        const u = new URL(url0, window.location.origin);
        const rid = u.searchParams.get("rid") || "";
        const path = u.searchParams.get("path") || "";
        if(!_isLikelyRid(rid)) return {action:"skip"};
        if(!path){
          u.searchParams.set("path","run_gate_summary.json");
          return {action:"rewrite", url: u.toString().replace(window.location.origin,"")};
        }
        return {action:"pass"};
      }catch(e){
        return {action:"pass"};
      }
    }

    // fetch
    const _origFetch = window.fetch ? window.fetch.bind(window) : null;
    if (_origFetch){
      window.fetch = function(input, init){
        try{
          const url0 = (typeof input === "string") ? input : (input && input.url) ? input.url : "";
          const fx = _fix(url0);
          if (fx.action === "skip"){
            const body = JSON.stringify({ok:false, skipped:true, reason:"no rid"});
            return Promise.resolve(new Response(body, {status:200, headers:{"Content-Type":"application/json; charset=utf-8"}}));
          }
          if (fx.action === "rewrite"){
            if (typeof input === "string") input = fx.url;
            else input = new Request(fx.url, input);
          }
        }catch(e){}
        return _origFetch(input, init);
      };
    }

    // XHR
    const XHR = window.XMLHttpRequest;
    if (XHR && XHR.prototype && XHR.prototype.open){
      const _open = XHR.prototype.open;
      XHR.prototype.open = function(method, url, async, user, password){
        try{
          const url0 = (typeof url === "string") ? url : "";
          const fx = _fix(url0);
          if (fx.action === "skip"){
            const body = encodeURIComponent(JSON.stringify({ok:false, skipped:true, reason:"no rid"}));
            url = "data:application/json;charset=utf-8," + body;
          } else if (fx.action === "rewrite"){
            url = fx.url;
          }
        }catch(e){}
        return _open.call(this, method, url, async, user, password);
      };
    }
  } catch(e) {}
})();

if (window.__vsp_dash_luxe_v1) return;
  window.__vsp_dash_luxe_v1 = true;

  const el = (sel, root=document) => root.querySelector(sel);
  const els = (sel, root=document) => Array.from(root.querySelectorAll(sel));
  const esc = (s) => String(s ?? "").replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
  const sleep = (ms) => new Promise(r=>setTimeout(r,ms));

  function injectCSS(){
    if (el('#VSP_DASH_LUXE_V1_CSS')) return;
    const css = document.createElement('style');
    css.id = 'VSP_DASH_LUXE_V1_CSS';
    css.textContent = `
      :root{
        --vsp-bg:#070e1a;
        --vsp-card:rgba(255,255,255,.04);
        --vsp-card2:rgba(255,255,255,.055);
        --vsp-line:rgba(255,255,255,.08);
        --vsp-text:#dbe6ff;
        --vsp-muted:#8da2d6;
        --vsp-glow:rgba(90,120,255,.35);
        --vsp-ok:#32d583;
        --vsp-warn:#fdb022;
        --vsp-bad:#f97066;
        --vsp-sky:#7aa7ff;
      }
      .vsp-luxe-wrap{max-width:1220px;margin:0 auto;padding:14px 14px 28px;}
      .vsp-luxe-hero{
        border:1px solid var(--vsp-line);
        background: radial-gradient(900px 240px at 15% 0%, rgba(122,167,255,.18), transparent 60%),
                    radial-gradient(700px 220px at 80% 0%, rgba(249,112,102,.10), transparent 62%),
                    linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
        border-radius:18px; padding:14px 14px 12px; box-shadow: 0 10px 28px rgba(0,0,0,.35);
      }
      .vsp-luxe-top{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
      .vsp-luxe-title{display:flex;gap:12px;align-items:center}
      .vsp-luxe-badge{
        width:36px;height:36px;border-radius:12px;
        background:linear-gradient(135deg, rgba(122,167,255,.35), rgba(90,120,255,.12));
        border:1px solid var(--vsp-line);
        box-shadow:0 0 0 6px rgba(122,167,255,.06);
      }
      .vsp-luxe-h1{font-weight:800;letter-spacing:.2px;color:var(--vsp-text);font-size:18px;margin:0;line-height:1.1}
      .vsp-luxe-sub{color:var(--vsp-muted);font-size:12px;margin-top:2px}
      .vsp-luxe-actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
      .vsp-btn{
        cursor:pointer; user-select:none;
        border:1px solid var(--vsp-line); color:var(--vsp-text);
        background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
        padding:8px 10px;border-radius:12px;font-size:12px;
        display:flex;gap:8px;align-items:center;
      }
      .vsp-btn:hover{border-color:rgba(122,167,255,.35); box-shadow:0 0 0 6px rgba(122,167,255,.06)}
      .vsp-chip{font-size:12px;border:1px solid var(--vsp-line);border-radius:999px;padding:6px 10px;color:var(--vsp-muted);background:rgba(0,0,0,.12)}
      .vsp-chip.ok{color:#bff7da;border-color:rgba(50,213,131,.28);background:rgba(50,213,131,.08)}
      .vsp-chip.warn{color:#ffe9bf;border-color:rgba(253,176,34,.28);background:rgba(253,176,34,.08)}
      .vsp-chip.bad{color:#ffd1cd;border-color:rgba(249,112,102,.28);background:rgba(249,112,102,.08)}
      .vsp-grid{display:grid;gap:12px;margin-top:12px}
      .vsp-grid.kpis{grid-template-columns:repeat(12,1fr)}
      .vsp-card{
        border:1px solid var(--vsp-line);
        background:linear-gradient(180deg, var(--vsp-card), rgba(255,255,255,.02));
        border-radius:16px;padding:12px;
        box-shadow:0 10px 22px rgba(0,0,0,.28);
        min-height:78px;
      }
      .vsp-kpi{grid-column:span 3}
      @media (max-width:1100px){ .vsp-kpi{grid-column:span 6} }
      @media (max-width:640px){ .vsp-kpi{grid-column:span 12} }
      .vsp-kpi-label{color:var(--vsp-muted);font-size:12px}
      .vsp-kpi-val{color:var(--vsp-text);font-weight:800;font-size:24px;margin-top:6px;letter-spacing:.3px}
      .vsp-kpi-mini{margin-top:6px;display:flex;gap:8px;align-items:center;color:var(--vsp-muted);font-size:12px}
      .vsp-dot{width:8px;height:8px;border-radius:99px;background:var(--vsp-sky);box-shadow:0 0 0 4px rgba(122,167,255,.10)}
      .vsp-dot.ok{background:var(--vsp-ok);box-shadow:0 0 0 4px rgba(50,213,131,.10)}
      .vsp-dot.warn{background:var(--vsp-warn);box-shadow:0 0 0 4px rgba(253,176,34,.10)}
      .vsp-dot.bad{background:var(--vsp-bad);box-shadow:0 0 0 4px rgba(249,112,102,.10)}
      .vsp-row{display:flex;gap:12px;flex-wrap:wrap}
      .vsp-row > .vsp-card{flex:1 1 360px}
      .vsp-h2{margin:0 0 8px;color:var(--vsp-text);font-size:13px;letter-spacing:.2px}
      .vsp-muted{color:var(--vsp-muted);font-size:12px}
      .vsp-bar{height:10px;border-radius:999px;background:rgba(255,255,255,.06);overflow:hidden;border:1px solid var(--vsp-line)}
      .vsp-bar > span{display:block;height:100%;background:linear-gradient(90deg, rgba(122,167,255,.70), rgba(90,120,255,.20))}
      .vsp-sev{display:grid;grid-template-columns:120px 1fr 54px;gap:10px;align-items:center;margin-top:10px}
      .vsp-sev .name{color:var(--vsp-muted);font-size:12px}
      .vsp-sev .num{color:var(--vsp-text);font-weight:700;font-size:12px;text-align:right}
      .vsp-tools{display:grid;grid-template-columns:repeat(8,1fr);gap:8px;margin-top:10px}
      @media (max-width:900px){ .vsp-tools{grid-template-columns:repeat(4,1fr)}}
      @media (max-width:520px){ .vsp-tools{grid-template-columns:repeat(2,1fr)}}
      .vsp-tool{
        border:1px solid var(--vsp-line);border-radius:14px;padding:10px 10px 8px;
        background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      }
      .vsp-tool .t{color:var(--vsp-text);font-weight:700;font-size:12px}
      .vsp-tool .s{color:var(--vsp-muted);font-size:11px;margin-top:4px}
      .vsp-degraded{
        margin-top:10px;
        border:1px dashed rgba(253,176,34,.35);
        background:rgba(253,176,34,.08);
        border-radius:16px;padding:10px 12px;color:#ffe9bf;font-size:12px;
      }
      .vsp-skel{
        background:linear-gradient(90deg, rgba(255,255,255,.04), rgba(255,255,255,.08), rgba(255,255,255,.04));
        background-size:200% 100%;
        animation: vspShimmer 1.25s linear infinite;
        border-radius:12px;
      }
      @keyframes vspShimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}
    `;
    document.head.appendChild(css);
  }

  async function jget(url){
    const r = await fetch(url, {credentials:'same-origin', headers:{'Accept':'application/json'}});
    const ct = r.headers.get('content-type') || '';
    const txt = await r.text();
    if (!r.ok) throw new Error(`HTTP ${r.status} for ${url} :: ${txt.slice(0,160)}`);
    if (ct.includes('application/json')) return JSON.parse(txt);
    // sometimes server sends json with wrong header => try parse
    try { return JSON.parse(txt); } catch { throw new Error(`Non-JSON response for ${url}: ${txt.slice(0,120)}`); }
  }

  function mountRoot(){
    // Try to place inside main content; fallback to body.
    const anchors = [
      '#vsp_luxe_host',
'#vsp_dashboard_root',
      '#dashboard',
      'main',
      '#main',
      '.vsp-main',
      '.content',
      'body'
    
    ];
    let a = null;
    for (const sel of anchors){
      a = el(sel);
      if (a) break;
    }
    if (!a) a = document.body;

    let root = el('#vspDashLuxeRoot');
    if (root) return root;

    root = document.createElement('div');
    root.id = 'vspDashLuxeRoot';
    // Put at top
    a.prepend(root);
    return root;
  }

  function renderSkeleton(root){
    root.innerHTML = `
      <div class="vsp-luxe-wrap">
        <div class="vsp-luxe-hero">
          <div class="vsp-luxe-top">
            <div class="vsp-luxe-title">
              <div class="vsp-luxe-badge"></div>
              <div>
                <h1 class="vsp-luxe-h1">VSP Dashboard</h1>
                <div class="vsp-luxe-sub">Loading latest run data…</div>
              </div>
            </div>
            <div class="vsp-luxe-actions">
              <div class="vsp-chip vsp-skel" style="width:180px;height:30px"></div>
              <div class="vsp-btn vsp-skel" style="width:92px;height:32px"></div>
            </div>
          </div>
        </div>

        <div class="vsp-grid kpis">
          ${Array.from({length:4}).map(()=>`
            <div class="vsp-card vsp-kpi">
              <div class="vsp-skel" style="height:12px;width:120px"></div>
              <div class="vsp-skel" style="height:26px;width:110px;margin-top:10px"></div>
              <div class="vsp-skel" style="height:12px;width:180px;margin-top:10px"></div>
            </div>`).join('')}
        </div>

        <div class="vsp-row">
          <div class="vsp-card">
            <div class="vsp-skel" style="height:14px;width:180px"></div>
            <div class="vsp-skel" style="height:12px;width:260px;margin-top:10px"></div>
            <div class="vsp-skel" style="height:10px;width:100%;margin-top:16px"></div>
            <div class="vsp-skel" style="height:10px;width:100%;margin-top:10px"></div>
            <div class="vsp-skel" style="height:10px;width:100%;margin-top:10px"></div>
          </div>
          <div class="vsp-card">
            <div class="vsp-skel" style="height:14px;width:180px"></div>
            <div class="vsp-tools" style="margin-top:12px">
              ${Array.from({length:8}).map(()=>`<div class="vsp-tool"><div class="vsp-skel" style="height:12px;width:90px"></div><div class="vsp-skel" style="height:10px;width:120px;margin-top:8px"></div></div>`).join('')}
            </div>
          </div>
        </div>
      </div>
    `;
  }


  function hideLegacyByDefault(root){
    try{
      const legacy = document.querySelector('#vsp5_root');
      if (!legacy) return;
      // hide legacy UI (old dashboard) to keep luxe clean
      if (legacy.dataset && legacy.dataset.vspLuxeHidden === '1') return;
      legacy.style.display = 'none';
      if (legacy.dataset) legacy.dataset.vspLuxeHidden = '1';
    } catch {}
  }

  function statusChip(overall){
    const o = String(overall||'UNKNOWN').toUpperCase();
    if (o.includes('PASS') || o === 'GREEN') return ['ok','PASS'];
    if (o.includes('WARN') || o === 'AMBER') return ['warn','WARN'];
    if (o.includes('FAIL') || o.includes('BLOCK') || o === 'RED') return ['bad','FAIL'];
    return ['','UNKNOWN'];
  }

  function num(n){ return (n===0||n) ? String(n) : '—'; }

  function render(root, state){
    const { rid, gate_root, overall_status, counts, degraded, served_by, tools } = state;

    const [cls, label] = statusChip(overall_status);

    const total = Object.values(counts||{}).reduce((a,b)=>a+(+b||0),0);
    const c = (k)=>+((counts||{})[k]||0);

    const sevRows = [
      ['CRITICAL', c('CRITICAL')],
      ['HIGH', c('HIGH')],
      ['MEDIUM', c('MEDIUM')],
      ['LOW', c('LOW')],
      ['INFO', c('INFO')],
      ['TRACE', c('TRACE')],
    ];
    const maxSev = Math.max(1, ...sevRows.map(x=>x[1]));

    const toolList = tools?.length ? tools : [
      'Bandit','Semgrep','Gitleaks','KICS','Trivy','Syft','Grype','CodeQL'
    ].map(t=>({name:t, status:'OK'}));

    root.innerHTML = `
      <div class="vsp-luxe-wrap">
        <div class="vsp-luxe-hero">
          <div class="vsp-luxe-top">
            <div class="vsp-luxe-title">
              <div class="vsp-luxe-badge"></div>
              <div>
                <h1 class="vsp-luxe-h1">VSP Dashboard</h1>
                <div class="vsp-luxe-sub">
                  RID: <b style="color:var(--vsp-text)">${esc(rid)}</b>
                  <span style="opacity:.6">•</span>
                  gate_root: <span style="color:var(--vsp-text)">${esc(gate_root||'—')}</span>
                  <span style="opacity:.6">•</span>
                  served_by: <span style="color:var(--vsp-muted)">${esc(served_by||'—')}</span>
                </div>
              </div>
            </div>

            <div class="vsp-luxe-actions">
              <span class="vsp-chip ${cls}"><span class="vsp-dot ${cls}"></span>&nbsp;Overall: <b>${esc(label)}</b></span>
              <button class="vsp-btn" id="vspLuxeRefreshBtn" title="Refresh">
                ⟳ Refresh
              </button>
              <button class="vsp-btn" id="vspLuxeOpenRunsBtn" title="Runs & Reports">
                ↗ Runs
              </button>
              <button class="vsp-btn" id="vspLuxeToggleLegacyBtn" title="Toggle legacy dashboard">▦ Legacy</button>
              <button class="vsp-btn" id="vspLuxeOpenRunsBtn" title="Runs & Reports">
                ↗ Runs
              </button>
            </div>
          </div>

          ${degraded ? `
          <div class="vsp-degraded">
            <b>Degraded mode:</b> gate_root_path chưa resolve (RUNS_ROOT chưa cấu hình hoặc evidence chưa nằm trong vùng đọc được).
            Dashboard vẫn chạy, nhưng evidence index/manifest là “virtual”.
          </div>` : ``}
        </div>

        <div class="vsp-grid kpis">
          <div class="vsp-card vsp-kpi">
            <div class="vsp-kpi-label">Total findings</div>
            <div class="vsp-kpi-val">${num(total)}</div>
            <div class="vsp-kpi-mini"><span class="vsp-dot ${cls}"></span>From unified severity counts</div>
          </div>
          <div class="vsp-card vsp-kpi">
            <div class="vsp-kpi-label">Critical</div>
            <div class="vsp-kpi-val">${num(c('CRITICAL'))}</div>
            <div class="vsp-kpi-mini"><span class="vsp-dot bad"></span>Immediate attention</div>
          </div>
          <div class="vsp-card vsp-kpi">
            <div class="vsp-kpi-label">High</div>
            <div class="vsp-kpi-val">${num(c('HIGH'))}</div>
            <div class="vsp-kpi-mini"><span class="vsp-dot warn"></span>Prioritize in sprint</div>
          </div>
          <div class="vsp-card vsp-kpi">
            <div class="vsp-kpi-label">Medium+</div>
            <div class="vsp-kpi-val">${num(c('MEDIUM') + c('HIGH') + c('CRITICAL'))}</div>
            <div class="vsp-kpi-mini"><span class="vsp-dot"></span>Risk-bearing backlog</div>
          </div>
        </div>

        <div class="vsp-row">
          <div class="vsp-card">
            <h3 class="vsp-h2">Severity distribution</h3>
            <div class="vsp-muted">Normalized to 6 DevSecOps levels</div>
            ${sevRows.map(([name, n])=>`
              <div class="vsp-sev">
                <div class="name">${esc(name)}</div>
                <div class="vsp-bar"><span style="width:${Math.round((n/maxSev)*100)}%"></span></div>
                <div class="num">${num(n)}</div>
              </div>
            `).join('')}
          </div>

          <div class="vsp-card">
            <h3 class="vsp-h2">Tool lanes</h3>
            <div class="vsp-muted">8-tool pipeline health (display-only)</div>
            <div class="vsp-tools">
              ${toolList.map(t=>`
                <div class="vsp-tool">
                  <div class="t">${esc(t.name)}</div>
                  <div class="s">status: ${esc(t.status||'OK')}</div>
                </div>
              `).join('')}
            </div>
          </div>
        </div>
      </div>
    `;

    const btn = el('#vspLuxeRefreshBtn', root);
    if (btn) btn.addEventListener('click', () => window.__vsp_dash_luxe_v1_reload?.());
    const tog = el('#vspLuxeToggleLegacyBtn', root);
    if (tog) tog.addEventListener('click', () => {
      try{
        const legacy = document.querySelector('#vsp5_root');
        if (!legacy) return;
        legacy.style.display = (legacy.style.display === 'none') ? '' : 'none';
      } catch {}
    });

    const runsBtn = el('#vspLuxeOpenRunsBtn', root);
    if (runsBtn) runsBtn.addEventListener('click', () => {
      // best effort navigation
      const cands = ['/runs', '/runs_reports', '/runs&reports', '/runs-reports', '/runs_reports_v1'];
      for (const u of cands){
        // try same-origin navigation
        window.location.href = u;
        break;
      }
    });
  }

  async function loadState(){
    // 1) latest rid + gate_root
    const latest = await jget('/api/vsp/rid_latest_gate_root');
    const rid = latest?.rid || '';
    const gate_root = latest?.gate_root || '';

    // 2) manifest (degraded/served_by)
    let manifest = null;
    try { manifest = await jget(`/api/vsp/run_file_allow?rid=${encodeURIComponent(rid)}&path=run_manifest.json`); } catch {}

    // 3) gate summary (overall + counts if present)
    let gateSummary = null;
    try { gateSummary = await jget(`/api/vsp/run_file_allow?rid=${encodeURIComponent(rid)}&path=run_gate_summary.json`); } catch {}

    // 4) fallback counts from findings_unified meta if gate summary doesn't have
    let counts = (gateSummary?.meta?.counts_by_severity) || (gateSummary?.counts_by_severity) || null;
      // ===================== VSP_P3_TRUEFIX_KPI_SOURCE_V1 =====================
      // If dash_kpis has real numbers, prefer it over run_gate_summary counts (commercial KPI correctness)
      try{
        const _k = window.__vsp_dashkpis_cache || null;
        const _dk = (_k && (_k.dash_kpis || _k.kpis || _k)) || null;

        const _by = (_dk && (_dk.counts_by_severity || _dk.by_severity || _dk.severity_counts || (_dk.meta && _dk.meta.counts_by_severity))) || null;

        // total_findings signal (tolerant)
        let _tf = (_dk && (_dk.total_findings ?? _dk.total ?? (_dk.counts_total && _dk.counts_total.total_findings))) ?? null;
        if (_tf == null && _by){
          const keys=["CRITICAL","HIGH","MEDIUM","LOW","INFO","TRACE"];
          _tf = keys.reduce((a,k)=> a + parseInt((_by[k] ?? _by[k.toLowerCase()] ?? 0) || 0,10), 0);
        }
        _tf = parseInt((_tf || 0), 10) || 0;

        // Only override when dash_kpis is actually populated
        if (_tf > 0 && _by && typeof _by === "object"){
          counts = _by;
          // also provide TOTAL if missing (some render paths expect TOTAL)
          if (counts.TOTAL == null && counts.total == null){
            counts.TOTAL = _tf;
          }
          // Kill degraded banner if any (text-based)
          try{
            const blocks = document.querySelectorAll("div,section,article,aside");
            for (const el of blocks){
              const t = (el.textContent||"").replace(/\s+/g," ").trim();
              if (t.includes("KPI/Charts Degraded") || t.includes("KPI data not available")){
                el.style.display="none";
              }
            }
          }catch(_){}
          try{ console.log("[TRUEFIX_KPI_SOURCE_V1] using dash_kpis counts, total_findings=", _tf); }catch(_){}
        } else {
          try{ console.log("[TRUEFIX_KPI_SOURCE_V1] keep run_gate_summary counts (dash_kpis empty)"); }catch(_){}
        }
      }catch(e){
        try{ console.warn("[TRUEFIX_KPI_SOURCE_V1] override failed:", e); }catch(_){}
      }
      // ===================== /VSP_P3_TRUEFIX_KPI_SOURCE_V1 =====================

    if (!counts){
      try {
        const fu = await jget(`/api/vsp/run_file_allow?rid=${encodeURIComponent(rid)}&path=findings_unified.json&limit=25`);
        counts = fu?.meta?.counts_by_severity || null;
      } catch {}
    }
    counts = counts || {"CRITICAL":0,"HIGH":0,"MEDIUM":0,"LOW":0,"INFO":0,"TRACE":0};

    const overall_status =
      gateSummary?.overall_status ||
      gateSummary?.overall ||
      gateSummary?.meta?.overall_status ||
      'UNKNOWN';

    const degraded = !!(manifest && (manifest.degraded === true));
    const served_by = manifest?.served_by || gateSummary?.served_by || '';

    return {
      rid, gate_root,
      overall_status,
      counts,
      degraded,
      served_by,
      tools: null
    };
  }

  async function main(){
    try{
      injectCSS();
      const root = mountRoot();
      renderSkeleton(root);
      // [NONINTR] legacy stays visible by default
      // hideLegacyByDefault(root);

const run = async () => {
        try{
          renderSkeleton(root);
          const st = await loadState();
          render(root, st);
        } catch (e){
          // never throw -> show minimal error card
          root.innerHTML = `
            <div class="vsp-luxe-wrap">
              <div class="vsp-luxe-hero">
                <div class="vsp-luxe-top">
                  <div class="vsp-luxe-title">
                    <div class="vsp-luxe-badge"></div>
                    <div>
                      <h1 class="vsp-luxe-h1">VSP Dashboard</h1>
                      <div class="vsp-luxe-sub">Failed to load data: <span style="color:#ffd1cd">${esc(e?.message||e)}</span></div>
                    </div>
                  </div>
                  <div class="vsp-luxe-actions">
                    <button class="vsp-btn" id="vspLuxeRetryBtn">⟳ Retry</button>
                  </div>
                </div>
              </div>
            </div>
          `;
          const b = el('#vspLuxeRetryBtn', root);
          if (b) b.addEventListener('click', () => run());
        }
      };

      window.__vsp_dash_luxe_v1_reload = run;

      // slight delay to avoid fighting existing scripts during initial render
      await sleep(60);
      await run();
    } catch {
      // swallow
    }
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', main);
  } else {
    main();
  }
})();


/* ===================== VSP_P0_DASH_AUTO_REFRESH_RID_V1 ===================== */
/* Goal: after a new scan run is created, dashboard auto-detects and reloads to pick latest RID & data */
(()=> {
  if (window.__vsp_p0_dash_auto_refresh_rid_v1) return;
  window.__vsp_p0_dash_auto_refresh_rid_v1 = true;

  const API = "/api/vsp/runs?limit=1";
  let lastRid = null;
  let inFlight = false;

  async function tick(){
    if (inFlight) return;
    inFlight = true;
    try{
      const r = await fetch(API, {cache:"no-store", credentials:"same-origin"});
      if (!r.ok) return;
      const j = await r.json();
      const runs = (j && (j.runs || j.items || j.data)) || [];
      const rid = (runs[0] && (runs[0].rid || runs[0].run_id || runs[0].id)) || null;
      if (!rid) return;

      if (lastRid === null){
        lastRid = rid;
        return;
      }
      if (rid && lastRid && rid !== lastRid){
        // new run detected => reload to pick latest gate + release headers etc.
        /* VSP_P1_DASH_DISABLE_AUTO_REFRESH_RID_V1: blocked legacy location.reload() */
      }
    }catch(e){
      // ignore
    }finally{
      inFlight = false;
    }
  }
  /* VSP_P1_DASH_DISABLE_LEGACY_TICK_V1B_FIX: disabled legacy tick(12000) to prevent UI freeze */
  /* VSP_P1_DASH_DISABLE_AUTO_REFRESH_RID_V1: disabled legacy auto-refresh tick start */
})();
/* ===================== /VSP_P0_DASH_AUTO_REFRESH_RID_V1 ===================== */


/* VSP_P1_DASHBOARD_KPI_OVERALL_SOT_V1C_NOFREEZE
   commercial SOT:
   - KPI = run_gate_summary.counts_total (+TOTAL auto)
   - Chip = run_gate_summary.overall
   - NO setInterval 1s; cache DOM once; idle execution; refresh only on RID change
*/
(function(){
  if (window.__VSP_KPI_SOT_NOFREEZE) return;
  window.__VSP_KPI_SOT_NOFREEZE = true;

  const ORIGIN = "";
  const SEVS = ["TOTAL","CRITICAL","HIGH","MEDIUM","LOW","INFO","TRACE"];
  const cache = new Map(); // sev -> [els]

  const defer = (fn) => {
    try{
      if (window.requestIdleCallback) return requestIdleCallback(fn, { timeout: 1200 });
    }catch(_){}
    return setTimeout(fn, 0);
  };

  function api(path){ return ORIGIN + path; }

  function setText(el, val){
    if(!el) return;
    const t = (val===null || val===undefined || val==="") ? "—" : String(val);
    if(el.textContent !== t) el.textContent = t;
  }

  function uniq(arr){
    const out=[]; const seen=new Set();
    for(const x of arr){ if(x && !seen.has(x)){ seen.add(x); out.push(x); } }
    return out;
  }

  function buildCache(){
    // cache targets once to avoid heavy querySelectorAll loops
    for (const sev of SEVS){
      const s = String(sev).toLowerCase();
      const sels = [
        `[data-kpi="${sev}"]`, `[data-kpi="${s}"]`,
        `[data-sev="${sev}"]`, `[data-sev="${s}"]`,
        `#kpi_${s}`, `#kpi-${s}`,
        `.kpi-${s} .kpi-value`,
        `.kpi[data-sev="${s}"] .kpi-value`,
        `.kpi[data-kpi="${s}"] .kpi-value`
      ];
      let els = [];
      for (const sel of sels){
        try{ document.querySelectorAll(sel).forEach(e=>els.push(e)); }catch(_){}
      }
      cache.set(sev, uniq(els));
    }
  }

  function applyCounts(counts){
    if(!counts || typeof counts !== "object") return;

    let total = 0;
    for(const k of Object.keys(counts)){
      const n = Number(counts[k] ?? 0);
      if(Number.isFinite(n)) total += n;
    }
    const map = Object.assign({}, counts, { TOTAL: total });

    for(const sev of SEVS){
      const val = (map[sev] ?? map[sev.toUpperCase()] ?? map[String(sev).toLowerCase()]);
      const targets = cache.get(sev) || [];
      if(!targets.length) continue;
      for(const el of targets) setText(el, val);
    }
  }

  function setOverallChip(overall){
    const v = String(overall||"").toUpperCase();
    const sels = [
      '[data-overall-chip]','#overallChip','#gateChip','#gateOverall',
      '.gate-chip','.overall-chip','[data-gate="overall"]'
    ];
    let el = null;
    for(const sel of sels){ el = document.querySelector(sel); if(el) break; }
    if(!el) return;

    setText(el, v || "—");
    try{ el.dataset.overall = v; }catch(_){}

    el.classList.remove('is-pass','is-fail','is-warn','vsp-overall-red','vsp-overall-green','vsp-overall-amber');
    if(v === "GREEN" || v === "PASS" || v === "OK") el.classList.add('is-pass','vsp-overall-green');
    else if(v === "RED" || v === "FAIL" || v === "BLOCK") el.classList.add('is-fail','vsp-overall-red');
    else if(v) el.classList.add('is-warn','vsp-overall-amber');
  }

  async function fetchJSON(url, timeoutMs=3500){
    const ac = new AbortController();
    const t = setTimeout(()=>ac.abort(), timeoutMs);
    try{
      const r = await fetch(url, { credentials:"same-origin", cache:"no-store", signal: ac.signal });
      const ct = (r.headers.get("content-type") || "");
      if(!ct.includes("application/json")) throw new Error("non-json content-type=" + ct);
      /* VSP_P2_6E_LUXE_JGET_UNWRAP_RUN_FILE_ALLOW_V1 */
      let j = null;
      try { j = await r.json(); } catch(e) { j = null; }

      try {
        // unwrap wrapper payload for run_file_allow findings_unified.json
        var u = (typeof url !== 'undefined') ? String(url || "") : "";
        if (u.indexOf("/api/vsp/run_file_allow") >= 0 && u.indexOf("path=findings_unified.json") >= 0) {
          if (j && j.ok === true && Array.isArray(j.findings)) {
            return { meta: (j.meta || {}), findings: (j.findings || []) };
          }
          if (j && j.ok === false) {
            return { meta: (j.meta || { rid: (j.rid || null) }), findings: [], _err: (j.err || "blocked"), _raw: j };
          }
        }
      } catch(e) {}

      return j;
    } finally {
      clearTimeout(t);
    }
  }

  function getRid(){
    const qs = new URLSearchParams(location.search);
    return (window.__VSP_RID || window.VSP_RID || qs.get("rid") || localStorage.getItem("vsp_rid") || "");
  }

  let lastRid = "";
  async function refresh(){
    let rid = getRid();
    if(!rid){
      try{
        const j = await fetchJSON(api("/api/vsp/rid_latest"));
        rid = (j && j.rid) ? String(j.rid) : "";
      }catch(_){}
    }
    if(!rid) return;

    if (rid === lastRid) return;
    lastRid = rid;
    try{ localStorage.setItem("vsp_rid", rid); }catch(_){}

    try{
      const j = await fetchJSON(api("/api/vsp/run_file_allow?rid=" + encodeURIComponent(rid) + "&path=run_gate_summary.json"));
      setOverallChip(j.overall || "");
      
      // ===================== VSP_P3_TRUEFIX_COUNTS_TOTAL_V1 =====================
      // counts_total drives KPI cards; prefer dash_kpis when it has real numbers
      let __ct = (j && j.counts_total) ? j.counts_total : null;
      try{
        
      // --- VSP_P3_FIX_CT_FETCH_DASHKPIS_V1 ---
      try{
        if (!window.__vsp_dashkpis_cache){
          const __rid = (typeof rid !== "undefined" ? rid : (new URL(location.href)).searchParams.get("rid") || "");
          const __fetch = (typeof fetchJson === "function") ? fetchJson : ((typeof fetchJSON === "function") ? fetchJSON : null);
          if (__fetch){
            // Prefer rid-aware endpoint
            let __u = "/api/vsp/dash_kpis";
            if (__rid) __u = __u + "?rid=" + encodeURIComponent(__rid);
            window.__vsp_dashkpis_cache = await __fetch(__u);
          }
        }
      }catch(_){}
      // --- /VSP_P3_FIX_CT_FETCH_DASHKPIS_V1 ---
const __k  = window.__vsp_dashkpis_cache || null;
        const __dk = (__k && (__k.dash_kpis || __k.kpis || __k)) || null;

        const __by = (__dk && (__dk.counts_by_severity || __dk.by_severity || __dk.severity_counts || (__dk.meta && __dk.meta.counts_by_severity))) || null;

        let __tf = (__dk && (__dk.total_findings ?? __dk.total ?? (__dk.counts_total && __dk.counts_total.total_findings))) ?? null;
        if (__tf == null && __by){
          const keys=["CRITICAL","HIGH","MEDIUM","LOW","INFO","TRACE"];
          __tf = keys.reduce((a,k)=> a + parseInt((__by[k] ?? __by[k.toLowerCase()] ?? 0) || 0,10), 0);
        }
        __tf = parseInt((__tf || 0), 10) || 0;

        if (__tf > 0){
          // start from dash counts_total if available, else clone existing ct
          let __src = (__dk && __dk.counts_total) ? __dk.counts_total : (__ct || {});
          if (typeof __src !== "object" || __src === null) __src = {};
          __ct = __src;

          // normalize keys commonly used by KPI
          __ct.total_findings = __tf;
          __ct.TOTAL = (__ct.TOTAL == null) ? __tf : __ct.TOTAL;

          if (__by && typeof __by === "object"){
            const get = (k)=> parseInt((__by[k] ?? __by[k.toLowerCase()] ?? 0) || 0,10) || 0;
            __ct.critical = get("CRITICAL");
            __ct.high     = get("HIGH");
            __ct.medium   = get("MEDIUM");
            __ct.low      = get("LOW");
            __ct.info     = get("INFO");
            __ct.trace    = get("TRACE");
          }

          // hide degraded banner if present
          try{
            const blocks = document.querySelectorAll("div,section,article,aside");
            for (const el of blocks){
              const t = (el.textContent||"").replace(/\s+/g," ").trim();
              if (t.includes("KPI/Charts Degraded") || t.includes("KPI data not available")){
                el.style.display="none";
              }
            }
          }catch(_){}

          try{ console.log("[TRUEFIX_COUNTS_TOTAL_V1] applied counts_total from dash_kpis, total_findings=", __tf); }catch(_){}
        }
      }catch(e){
        try{ console.warn("[TRUEFIX_COUNTS_TOTAL_V1] override failed:", e); }catch(_){}
      }
      // ===================== /VSP_P3_TRUEFIX_COUNTS_TOTAL_V1 =====================
      
      applyCounts(__ct || null);

      // ===================== VSP_P3_FORCE_KPI_FROM_DASHKPIS_V1 =====================
      // After baseline applyCounts(from run_gate_summary), re-apply using dash_kpis (source-of-truth) for current rid.
      try{
        (async function(){
          try{
            const _rid = (typeof rid !== "undefined" && rid) ? rid : (new URL(location.href)).searchParams.get("rid") || "";
            if(!_rid) return;

            const _fetch = (typeof fetchJson === "function") ? fetchJson : ((typeof fetchJSON === "function") ? fetchJSON : null);
            if(!_fetch) return;

            const _j = await _fetch("/api/vsp/dash_kpis?rid=" + encodeURIComponent(_rid));
            if(!_j || _j.ok !== true) return;

            // cache for other blocks
            try{ window.__vsp_dashkpis_cache = _j; }catch(_){}

            const _ctU = (_j.counts_total || _j.counts || {});
            const _tf  = parseInt((_j.total_findings ?? _j.total ?? 0) || 0, 10) || 0;
            if(_tf <= 0) return;

            // applyCounts() in luxe expects a "counts_total-ish" object but often reads lower-case keys
            const _ct = {
              total_findings: _tf,
              TOTAL: _tf,
              CRITICAL: parseInt((_ctU.CRITICAL ?? 0) || 0, 10) || 0,
              HIGH:     parseInt((_ctU.HIGH ?? 0) || 0, 10) || 0,
              MEDIUM:   parseInt((_ctU.MEDIUM ?? 0) || 0, 10) || 0,
              LOW:      parseInt((_ctU.LOW ?? 0) || 0, 10) || 0,
              INFO:     parseInt((_ctU.INFO ?? 0) || 0, 10) || 0,
              TRACE:    parseInt((_ctU.TRACE ?? 0) || 0, 10) || 0,
            };
            // friendly aliases (some UI paths read these)
            _ct.critical = _ct.CRITICAL;
            _ct.high     = _ct.HIGH;
            _ct.medium   = _ct.MEDIUM;
            _ct.low      = _ct.LOW;
            _ct.info     = _ct.INFO;
            _ct.trace    = _ct.TRACE;

            applyCounts(_ct);

            // Hide degraded banner if still present
            try{
              const blocks = document.querySelectorAll("div,section,article,aside");
              for (const el of blocks){
                const t = (el.textContent||"").replace(/\s+/g," ").trim();
                if (t.includes("KPI/Charts Degraded") || t.includes("KPI data not available")){
                  el.style.display="none";
                }
              }
            }catch(_){}

            try{ console.log("[FORCE_KPI_FROM_DASHKPIS_V1] applied", {rid:_rid, total:_tf, high:_ct.HIGH, medium:_ct.MEDIUM}); }catch(_){}
          }catch(e){
            try{ console.warn("[FORCE_KPI_FROM_DASHKPIS_V1] failed:", e); }catch(_){}
          }
        })();
      }catch(_){}
      // ===================== /VSP_P3_FORCE_KPI_FROM_DASHKPIS_V1 =====================


    }catch(_){}
  }

  function boot(){
    buildCache();
    defer(()=>refresh());
  }

  if(document.readyState === "loading") document.addEventListener("DOMContentLoaded", boot);
  else boot();

  // refresh only when RID might change
  window.addEventListener("vsp:ridchange", ()=>defer(()=>refresh()));
  window.addEventListener("storage", (e)=>{ if(e && e.key==="vsp_rid") defer(()=>refresh()); });
})();
 /* /VSP_P1_DASHBOARD_KPI_OVERALL_SOT_V1C_NOFREEZE */




/* ===================== VSP_P2_JS_ANCHOR_META_CLIENT_V1 ===================== */
(function(){
  const MARK = "VSP_P2_JS_ANCHOR_META_CLIENT_V1";

  function ensureAnchor(){
    try{
      if(document.getElementById("vsp-dashboard-main")) return;
      const root = document.getElementById("vsp5_root");
      const div = document.createElement("div");
      div.id = "vsp-dashboard-main";
      if(root && root.parentNode){
        root.parentNode.insertBefore(div, root);
      }else if(document.body){
        document.body.insertBefore(div, document.body.firstChild);
      }
    }catch(e){}
  }

  if(document.readyState === "loading"){
    document.addEventListener("DOMContentLoaded", ensureAnchor);
  }else{
    ensureAnchor();
  }

  const origFetch = window.fetch;
  if(typeof origFetch === "function" && !window.__vspFetchPatched__){
    window.__vspFetchPatched__ = true;
    window.fetch = async function(input, init){
      const url = (typeof input === "string") ? input : (input && input.url) || "";
      const resp = await origFetch.call(this, input, init);
      try{
        if(url.includes("/api/vsp/run_file_allow") && url.includes("findings_unified.json")){
          const ct = (resp.headers && resp.headers.get && resp.headers.get("content-type")) || "";
          if(ct.includes("application/json")){
            const j = await resp.clone().json();
            if(j && typeof j === "object" && Array.isArray(j.findings)){
              const hasMeta = j.meta && j.meta.counts_by_severity;
              if(!hasMeta){
                const counts = {CRITICAL:0,HIGH:0,MEDIUM:0,LOW:0,INFO:0,TRACE:0};
                for(const f of j.findings){
                  const sev = (f && f.severity) ? String(f.severity).toUpperCase() : "INFO";
                  if(Object.prototype.hasOwnProperty.call(counts, sev)) counts[sev]++; else counts.INFO++;
                }
                j.meta = j.meta || {};
                j.meta.counts_by_severity = counts;
                j.__patched__ = MARK;
                const body = JSON.stringify(j);
                const headers = new Headers(resp.headers || {});
                headers.set("content-type", "application/json; charset=utf-8");
                return new Response(body, {status: resp.status, statusText: resp.statusText, headers});
              }
            }
          }
        }
      }catch(e){}
      return resp;
    };
  }
})();
/* ===================== /VSP_P2_JS_ANCHOR_META_CLIENT_V1 ===================== */



/* VSP_P2_DEGRADED_BANNER_V1 */
(function(){
  function _vspOnce(key){
    try {
      window.__VSP_ONCE__ = window.__VSP_ONCE__ || {};
      if (window.__VSP_ONCE__[key]) return false;
      window.__VSP_ONCE__[key] = 1;
      return true;
    } catch(e){ return true; }
  }

  function _vspStyle(el, css){
    try{ for (const k in css) el.style[k]=css[k]; }catch(e){}
  }

  function _vspInsertBanner(msg, via){
    if (document.getElementById("vsp-degraded-banner")) return;
    const host = document.getElementById("vsp-dashboard-main") || document.body;
    const b = document.createElement("div");
    b.id = "vsp-degraded-banner";
    b.setAttribute("role","status");
    b.innerHTML = `
      <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
        <div style="font-weight:700;letter-spacing:0.2px;">⚠ KPI/Charts Degraded</div>
        <div style="opacity:.9">${msg}</div>
        ${via ? `<div style="opacity:.7;font-size:12px;">via: ${via}</div>` : ``}
      </div>
      <div style="margin-top:6px;opacity:.75;font-size:12px;">
        This is expected when KPI is disabled by policy. UI remains usable; Runs/Data Source/Exports still work.
      </div>
    `;
    _vspStyle(b, {
      background: "rgba(255, 196, 0, 0.10)",
      border: "1px solid rgba(255, 196, 0, 0.35)",
      padding: "12px 14px",
      borderRadius: "12px",
      margin: "12px auto",
      maxWidth: "1200px",
      color: "#e9edf6",
      fontFamily: "system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial",
    });
    // Put it above dashboard anchor if possible
    try {
      if (host && host.parentNode) host.parentNode.insertBefore(b, host);
      else document.body.insertBefore(b, document.body.firstChild);
    } catch(e){ document.body.insertBefore(b, document.body.firstChild); }
  }

  async function _vspCheckDegraded(){
    try {
      if (!location.pathname || location.pathname !== "/vsp5") return;
      const [k, c] = await Promise.all([
        fetch(vspWithRid("/api/vsp/dash_kpis", (rid||window.__vsp_rid_latest||"")), {credentials:"same-origin"}).then(r=>r.json()).catch(()=>null),
        fetch(vspWithRid("/api/vsp/dash_charts", (rid||window.__vsp_rid_latest||"")), {credentials:"same-origin"}).then(r=>r.json()).catch(()=>null),
      ]);
      const kEmpty = (!k || !k.kpis || Object.keys(k.kpis).length === 0);
      const cEmpty = (!c || !c.charts || Object.keys(c.charts).length === 0);
      if (kEmpty || cEmpty) {
        const via = (k && k.__via__) || (c && c.__via__) || "";
        const msg = (kEmpty && cEmpty) ? "KPI & charts data not available." : (kEmpty ? "KPI data not available." : "Charts data not available.");
        _vspInsertBanner(msg, via);
        if (_vspOnce("p2_degraded_console_once")) {
          console.warn("[VSP][P2] Degraded banner shown:", {kEmpty, cEmpty, via});
        }
      }
    } catch(e) {
      if (_vspOnce("p2_degraded_err_once")) console.warn("[VSP][P2] degraded check error:", e);
    }
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", _vspCheckDegraded);
  } else {
    _vspCheckDegraded();
  }
})();


/* VSP_P0_KPI_CHARTS_PLACEHOLDER_IF_EMPTY_V1
   If dash_kpis/dash_charts return empty objects, render enterprise placeholders
   so the dashboard doesn't look "broken" under policy-degraded mode.
*/
(function(){
  function el(tag, cls, html){
    var d=document.createElement(tag);
    if (cls) d.className=cls;
    if (html!=null) d.innerHTML=html;
    return d;
  }

  function findMain(){
    return document.getElementById("vsp-dashboard-main") || document.querySelector("#vsp-dashboard-main");
  }

  function ensurePlaceholderStyles(){
    if (document.getElementById("vsp-p0-empty-style")) return;
    var st=el("style", null, `
      .vsp-empty-wrap{margin:14px 0 8px 0;padding:14px;border:1px solid rgba(255,255,255,.08);border-radius:14px;background:rgba(255,255,255,.03)}
      .vsp-empty-title{font-weight:700;font-size:14px;opacity:.9;margin-bottom:8px}
      .vsp-empty-sub{font-size:12px;opacity:.75;line-height:1.35}
      .vsp-kpi-grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px;margin-top:10px}
      .vsp-kpi-card{padding:12px;border-radius:14px;border:1px solid rgba(255,255,255,.08);background:rgba(0,0,0,.15)}
      .vsp-kpi-k{font-size:11px;opacity:.7}
      .vsp-kpi-v{font-size:18px;font-weight:800;margin-top:4px;opacity:.85}
      .vsp-chart-ph{height:160px;border-radius:14px;border:1px dashed rgba(255,255,255,.16);display:flex;align-items:center;justify-content:center;margin-top:12px;opacity:.8}
      @media (max-width: 1100px){ .vsp-kpi-grid{grid-template-columns:repeat(2,minmax(0,1fr));} }
    `);
    st.id="vsp-p0-empty-style";
    document.head.appendChild(st);
  }

  async function fetchJson(url){
    try{
      var r=await fetch(url,{credentials:"same-origin"});
      return await r.json();
    }catch(e){ return null; }
  }

  function isEmptyObj(o){
    return o && typeof o==="object" && !Array.isArray(o) && Object.keys(o).length===0;
  }

  function render(main, via){
    ensurePlaceholderStyles();
    if (document.getElementById("vsp-p0-empty-wrap")) return;

    var wrap=el("div","vsp-empty-wrap","");
    wrap.id="vsp-p0-empty-wrap";
    wrap.appendChild(el("div","vsp-empty-title","KPI/Charts disabled by policy"));
    wrap.appendChild(el("div","vsp-empty-sub",
      "Dashboard is healthy, but KPI/Charts data is currently unavailable (degraded mode). " +
      (via?("Source: <code>"+via+"</code>."):"")
    ));

    var grid=el("div","vsp-kpi-grid","");
    var cards=[
      ["Overall","—"],
      ["Critical/High","—"],
      ["Coverage","—"],
      ["Last Run","—"]
    ];
    cards.forEach(function(x){
      var c=el("div","vsp-kpi-card","");
      c.appendChild(el("div","vsp-kpi-k",x[0]));
      c.appendChild(el("div","vsp-kpi-v",x[1]));
      grid.appendChild(c);
    });
    wrap.appendChild(grid);

    wrap.appendChild(el("div","vsp-chart-ph","No charts (policy / degraded)"));
    // put at top of main
    main.prepend(wrap);
  }

  async function init(){
    try{
      if (location.pathname !== "/vsp5") return;
      var main=findMain();
      if (!main) return;

      // retry a bit in case JS renders later
      var tries=0;
      while(!findMain() && tries<10){ await new Promise(r=>setTimeout(r,150)); tries++; }
      main=findMain(); if (!main) return;

      var k=await fetchJson(vspWithRid("/api/vsp/dash_kpis", (rid||window.__vsp_rid_latest||"")));
      try{ window.__vsp_dashkpis_cache = k || null; }catch(_){ }

      var c=await fetchJson(vspWithRid("/api/vsp/dash_charts", (rid||window.__vsp_rid_latest||"")));
      var via=null;
      if (k && k.__via__) via=k.__via__;
      else if (c && c.__via__) via=c.__via__;

      // only render placeholders if empty objects
      if (k && isEmptyObj(k.kpis) && c && isEmptyObj(c.charts)){
        render(main, via);
      }
    }catch(e){}
  }

  if (document.readyState==="loading") document.addEventListener("DOMContentLoaded", init);
  else init();
})();


/* VSP_P0_DASH_RID_BOOTSTRAP_V1 */
(async ()=>{ try{ window.__vsp_rid_latest = await vspGetRidLatestSafe(); }catch(e){} })();

/* ===================== VSP_P3_RUN_PICKER_V1 ===================== */
(function(){
  try{
    if (window.__VSP_RUN_PICKER_V1__) return;
    window.__VSP_RUN_PICKER_V1__ = true;

    function qp(name){
      try { return new URL(location.href).searchParams.get(name) || ""; }
      catch(e){ return ""; }
    }
    function lsGet(k){
      try { return localStorage.getItem(k) || ""; } catch(e){ return ""; }
    }
    function lsSet(k,v){
      try { localStorage.setItem(k, v); } catch(e){}
    }
    async function fetchJson(url){
      const r = await fetch(url, { credentials: "same-origin" });
      if (!r.ok) throw new Error("HTTP "+r.status+" for "+url);
      return await r.json();
    }
    function applyRid(rid){
      if(!rid) return;
      lsSet("vsp_rid_selected", rid);
      const u = new URL(location.href);
      u.searchParams.set("rid", rid);
      location.href = u.toString(); // safest P0: full reload
    }

    function cssInline(){
      return [
        "display:flex",
        "align-items:center",
        "gap:10px",
        "padding:10px 12px",
        "margin:10px 0 14px 0",
        "border:1px solid rgba(255,255,255,0.10)",
        "border-radius:12px",
        "background:rgba(20,22,28,0.75)",
        "backdrop-filter:blur(6px)",
        "color:#eaeaea"
      ].join(";");
    }
    function selectCss(){
      return [
        "min-width:420px",
        "max-width:72vw",
        "padding:8px 10px",
        "border-radius:10px",
        "border:1px solid rgba(255,255,255,0.14)",
        "background:rgba(10,12,16,0.85)",
        "color:#eaeaea",
        "outline:none"
      ].join(";");
    }
    function smallCss(){
      return "opacity:0.8;font-size:12px";
    }

    function mount(){
      const main = document.getElementById("vsp-dashboard-main");
      if(!main) return false;

      const host = main.parentElement || document.body;
      if(document.getElementById("vsp-run-picker-bar")) return true;

      const bar = document.createElement("div");
      bar.id = "vsp-run-picker-bar";
      bar.setAttribute("data-marker", "VSP_P3_RUN_PICKER_V1");
      bar.style.cssText = cssInline();
      bar.innerHTML = `
        <div style="font-weight:700;">Run</div>
        <select id="vsp-run-picker-select" style="${selectCss()}">
          <option value="" disabled selected>Loading runs…</option>
        </select>
        <div id="vsp-run-picker-hint" style="${smallCss()}"></div>
      `;
      host.insertBefore(bar, host.firstChild);
      return true;
    }

    function normalizeRuns(j){
      const runs = (j && (j.runs || j.items || j.data)) || [];
      const out = [];
      for(const r of runs){
        const rid = (r && (r.rid || r.run_id || r.id || r.RID)) || "";
        if(rid) out.push({ rid, raw: r });
      }
      return out;
    }

    async function fillOptions(){
      const sel = document.getElementById("vsp-run-picker-select");
      const hint = document.getElementById("vsp-run-picker-hint");
      if(!sel) return;

      const currentRid = qp("rid") || lsGet("vsp_rid_selected");

      sel.innerHTML = "";

      const optLatest = document.createElement("option");
      optLatest.value = "__LATEST__";
      optLatest.textContent = "Latest with findings";
      sel.appendChild(optLatest);

      const optSep = document.createElement("option");
      optSep.value = "__SEP__";
      optSep.textContent = "──────── Recent runs ────────";
      optSep.disabled = true;
      sel.appendChild(optSep);

      let runs = [];
      try{
        const j = await fetchJson("/api/vsp/runs?limit=30&offset=0");
        runs = normalizeRuns(j);
      }catch(e){
        if(hint) hint.textContent = "Failed to load runs: " + (e && e.message ? e.message : e);
      }

      for(const it of runs){
        const o = document.createElement("option");
        o.value = it.rid;
        o.textContent = it.rid;
        sel.appendChild(o);
      }

      if(currentRid){
        const exists = Array.from(sel.options).some(o => o.value === currentRid);
        if(!exists){
          const o = document.createElement("option");
          o.value = currentRid;
          o.textContent = currentRid + " (current)";
          sel.insertBefore(o, optSep.nextSibling);
        }
        sel.value = currentRid;
        if(hint) hint.textContent = "Current RID: " + currentRid;
      }else{
        sel.value = "__LATEST__";
        if(hint) hint.textContent = "Tip: pick a run to refresh KPI/Charts instantly.";
      }

      sel.addEventListener("change", async () => {
        const v = sel.value;
        if(v === "__LATEST__"){
          try{
            const j = await fetchJson("/api/vsp/rid_latest");
            const rid = (j && j.rid) || "";
            if(rid) applyRid(rid);
          }catch(e){
            if(hint) hint.textContent = "Failed to resolve latest rid: " + (e && e.message ? e.message : e);
          }
          return;
        }
        if(v && v !== "__SEP__") applyRid(v);
      }, { once: true });
    }

    async function boot(){
      if(document.readyState === "loading"){
        document.addEventListener("DOMContentLoaded", boot, { once:true });
        return;
      }
      if(!mount()) return;
      await fillOptions();
    }

    boot();
  }catch(e){
    try{ console.warn("[RunPickerV1] init error:", e); }catch(_){}
  }
})();
 /* ===================== /VSP_P3_RUN_PICKER_V1 ===================== */

/* ===================== VSP_P3_TOP_FINDINGS_V1 ===================== */
(function(){
  try{
    if (window.__VSP_TOP_FINDINGS_V1__) return;
    window.__VSP_TOP_FINDINGS_V1__ = true;

    const SEV_ORDER = { "CRITICAL": 6, "HIGH": 5, "MEDIUM": 4, "LOW": 3, "INFO": 2, "TRACE": 1 };

    function qp(name){
      try { return new URL(location.href).searchParams.get(name) || ""; }
      catch(e){ return ""; }
    }
    function lsGet(k){
      try { return localStorage.getItem(k) || ""; } catch(e){ return ""; }
    }
    async function fetchJson(url){
      const r = await fetch(url, { credentials: "same-origin" });
      if (!r.ok) throw new Error("HTTP "+r.status+" for "+url);
      return await r.json();
    }
    function esc(s){
      return (s==null ? "" : String(s))
        .replaceAll("&","&amp;").replaceAll("<","&lt;")
        .replaceAll(">","&gt;").replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }
    function clip(s){
      try { return (s.length > 80) ? (s.slice(0,77)+"…") : s; } catch(e){ return ""; }
    }
    function sevScore(sev){
      const k = (sev||"").toUpperCase();
      return SEV_ORDER[k] || 0;
    }

    function panelCss(){
      return [
        "margin:12px 0 0 0",
        "padding:12px 12px",
        "border:1px solid rgba(255,255,255,0.10)",
        "border-radius:14px",
        "background:rgba(20,22,28,0.72)",
        "backdrop-filter:blur(6px)",
        "color:#eaeaea"
      ].join(";");
    }
    function headCss(){
      return "display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px;";
    }
    function btnCss(){
      return [
        "padding:7px 10px",
        "border-radius:10px",
        "border:1px solid rgba(255,255,255,0.14)",
        "background:rgba(10,12,16,0.85)",
        "color:#eaeaea",
        "cursor:pointer",
        "font-size:12px"
      ].join(";");
    }
    function badgeCss(sev){
      const k=(sev||"").toUpperCase();
      // no explicit colors (keep safe), just weight/border
      return "display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid rgba(255,255,255,0.18);font-weight:700;font-size:11px;letter-spacing:0.2px;";
    }
    function rowCss(){
      return "display:grid;grid-template-columns:90px 90px 1fr;gap:10px;align-items:start;padding:8px 0;border-top:1px solid rgba(255,255,255,0.08);";
    }
    function monoCss(){ return "font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:12px;opacity:0.92;"; }
    function dimCss(){ return "font-size:12px;opacity:0.80;"; }

    function ensurePanel(){
      // Prefer to mount right under run picker bar if exists
      const picker = document.getElementById("vsp-run-picker-bar");
      const root = document.getElementById("vsp5_root") || document.body;

      if (document.getElementById("vsp-top-findings-panel")) return true;

      const host = (picker && picker.parentElement) ? picker.parentElement : root;

      const panel = document.createElement("div");
      panel.id = "vsp-top-findings-panel";
      panel.setAttribute("data-marker", "VSP_P3_TOP_FINDINGS_V1");
      panel.style.cssText = panelCss();
      panel.innerHTML = `
        <div style="${headCss()}">
          <div>
            <div style="font-weight:800;">Top Findings</div>
            <div id="vsp-topfind-sub" style="${dimCss()}">Loading CRITICAL/HIGH…</div>
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;">
            <a id="vsp-topfind-open-ds" href="/data_source" style="text-decoration:none;">
              <button type="button" style="${btnCss()}">Open Data Source</button>
            </a>
            <button type="button" id="vsp-topfind-copy-filter" style="${btnCss()}">Copy filter</button>
          </div>
        </div>
        <div id="vsp-topfind-list"></div>
      `;

      // insert after picker if exists, else top of host
      if (picker && picker.parentElement === host){
        host.insertBefore(panel, picker.nextSibling);
      } else {
        host.insertBefore(panel, host.firstChild);
      }
      return true;
    }

    async function resolveRid(){
      const rid = qp("rid") || lsGet("vsp_rid_selected");
      if (rid) return rid;
      try{
        const j = await fetchJson("/api/vsp/rid_latest");
        return (j && j.rid) || "";
      }catch(e){
        return "";
      }
    }

    function normalizeFindings(j){
      // expected: { ok:true, from:"...", findings:[...] }
      const arr = (j && (j.findings || j.items || j.data)) || [];
      return Array.isArray(arr) ? arr : [];
    }

    function toRowHtml(f){
      const sev = (f && (f.severity || f.sev)) || "";
      const tool = (f && (f.tool || f.source || f.engine)) || "";
      const file = (f && (f.file || f.path || f.location)) || "";
      const title = (f && (f.title || f.message || f.rule || f.id)) || "";
      const cwe = (f && (f.cwe)) || "";
      const extra = cwe ? (" • CWE " + cwe) : "";

      return `
        <div style="${rowCss()}" class="vsp-topfind-row">
          <div><span style="${badgeCss(sev)}">${esc((sev||"").toUpperCase())}</span></div>
          <div style="${monoCss()}">${esc(clip(tool||"-"))}</div>
          <div>
            <div style="font-weight:700;line-height:1.25;">${esc(title||"-")}</div>
            <div style="${dimCss()}">${esc(clip(file||"-"))}${esc(extra)}</div>
          </div>
        </div>
      `;
    }

    async function loadTopFindings(){
      if (!ensurePanel()) return;

      const sub = document.getElementById("vsp-topfind-sub");
      const list = document.getElementById("vsp-topfind-list");
      const btnCopy = document.getElementById("vsp-topfind-copy-filter");
      const aOpen = document.getElementById("vsp-topfind-open-ds");

      const rid = await resolveRid();
      if (!rid){
        if (sub) sub.textContent = "No RID available (rid_latest failed).";
        return;
      }

      // Deep link attempt (safe even if DS ignores params)
      if (aOpen) aOpen.href = "/data_source?rid=" + encodeURIComponent(rid) + "&sev=" + encodeURIComponent("CRITICAL,HIGH");

      const filterObj = { rid, severities:["CRITICAL","HIGH"], top_n:10, sort:"severity_desc" };

      if (btnCopy){
        btnCopy.onclick = async () => {
          const payload = JSON.stringify(filterObj);
          try{
            await navigator.clipboard.writeText(payload);
            if (sub) sub.textContent = "Copied filter JSON to clipboard.";
          }catch(e){
            // fallback prompt
            try{ window.prompt("Copy filter JSON:", payload); }catch(_){}
          }
        };
      }

      if (sub) sub.textContent = "RID: " + rid + " • loading findings…";

      // Fetch limited findings (enough to pick top CRITICAL/HIGH)
      let findings = [];
      const paths = [
        "reports/findings_unified.json",
        "findings_unified.json"
      ];
      let lastErr = "";
      for (const path of paths){
        try{
          const url = "/api/vsp/run_file_allow?rid=" + encodeURIComponent(rid) + "&path=" + encodeURIComponent(path) + "&limit=800";
          const j = await fetchJson(url);
          findings = normalizeFindings(j);
          if (findings.length) break;
        }catch(e){
          lastErr = (e && e.message) ? e.message : String(e);
        }
      }

      if (!findings || !findings.length){
        if (sub) sub.textContent = "RID: " + rid + " • no findings (or failed to load). " + (lastErr ? ("("+lastErr+")") : "");
        if (list) list.innerHTML = `<div style="${dimCss()}">No findings available for CRITICAL/HIGH.</div>`;
        return;
      }

      const picked = findings
        .filter(f => {
          const sev = String((f && (f.severity||f.sev)) || "").toUpperCase();
          return sev === "CRITICAL" || sev === "HIGH";
        })
        .sort((a,b) => sevScore((b && b.severity)||"") - sevScore((a && a.severity)||""))
        .slice(0, 10);

      if (sub) sub.textContent = "RID: " + rid + " • showing " + picked.length + " CRITICAL/HIGH";
      if (list) list.innerHTML = picked.map(toRowHtml).join("") || `<div style="${dimCss()}">No CRITICAL/HIGH found.</div>`;
    }

    function boot(){
      if (document.readyState === "loading"){
        document.addEventListener("DOMContentLoaded", boot, { once:true });
        return;
      }
      loadTopFindings();
    }

    boot();
  }catch(e){
    try{ console.warn("[TopFindingsV1] init error:", e); }catch(_){}
  }
})();
/* ===================== /VSP_P3_TOP_FINDINGS_V1 ===================== */

/* ===================== VSP_P3_MOUNT_FIX_V1 ===================== */
(function(){
  try{
    if (window.__VSP_MOUNT_FIX_V1__) return;
    window.__VSP_MOUNT_FIX_V1__ = true;

    function isDescendant(parent, child){
      try { return !!(parent && child && parent.contains(child)); } catch(e){ return false; }
    }

    function moveIntoRoot(){
      const root = document.getElementById("vsp5_root");
      if(!root) return;

      const picker = document.getElementById("vsp-run-picker-bar");
      const panel  = document.getElementById("vsp-top-findings-panel");

      // Put them at the top of vsp5_root (under nav), in order: picker -> panel
      const toMove = [];
      if (picker && !isDescendant(root, picker)) toMove.push(picker);
      if (panel  && !isDescendant(root, panel))  toMove.push(panel);

      if (!toMove.length) return;

      // Ensure spacing doesn't look cramped
      root.style.paddingTop = root.style.paddingTop || "8px";

      // Prepend while preserving order
      for (let i = toMove.length - 1; i >= 0; i--){
        root.insertBefore(toMove[i], root.firstChild);
      }
    }

    function boot(){
      // Try several times in case other JS renders late
      let n = 0;
      const t = setInterval(() => {
        n++;
        moveIntoRoot();
        if (n >= 8) clearInterval(t);
      }, 250);
      moveIntoRoot();
    }

    if (document.readyState === "loading"){
      document.addEventListener("DOMContentLoaded", boot, { once:true });
    } else {
      boot();
    }
  }catch(e){
    try{ console.warn("[MountFixV1] error:", e); }catch(_){}
  }
})();
 /* ===================== /VSP_P3_MOUNT_FIX_V1 ===================== */

/* ===================== VSP_P3_AUTOFIX_KPI_DEGRADED_V1 ===================== */
// [DISABLED] This block was too aggressive for layout; truefix is done elsewhere.
 /* ===================== /VSP_P3_AUTOFIX_KPI_DEGRADED_V1 ===================== */

/* ===================== VSP_P3_AUTOFIX_KPI_DEGRADED_V2 ===================== */
// [DISABLED] This block was too aggressive for layout; truefix is done elsewhere.
 /* ===================== /VSP_P3_AUTOFIX_KPI_DEGRADED_V2 ===================== */

/* ===================== VSP_P3_AUTOFIX_KPI_DEGRADED_V3 ===================== */
// [DISABLED] This block was too aggressive for layout; truefix is done elsewhere.
 /* ===================== /VSP_P3_AUTOFIX_KPI_DEGRADED_V3 ===================== */

/* VSP_P3_TRUEFIX_KPI_SOURCE_V1 */

/* VSP_P3_TRUEFIX_COUNTS_TOTAL_V1 */

/* VSP_P3_CLEANUP_AUTOFIX_AND_USE_RID_V1 */

/* VSP_P3_FIX_DEGRADEDCHECK_AND_KPI_CT_V1 */

/* VSP_P3_KILL_DEGRADEDCHECK_V2 */

/* VSP_P3_FORCE_KPI_FROM_DASHKPIS_V1 */

/* ===================== VSP_P3_STABILIZE_KPI_V1 ===================== */
(function(){
  try{
    if (window.__VSP_P3_STABILIZE_KPI_V1__) return;
    window.__VSP_P3_STABILIZE_KPI_V1__ = true;

    function qp(name){
      try { return new URL(location.href).searchParams.get(name) || ""; } catch(e){ return ""; }
    }
    function iNum(v){
      try{
        if (v == null) return 0;
        if (typeof v === "string") v = v.replaceAll(",","").trim();
        return parseInt(v || 0, 10) || 0;
      }catch(e){ return 0; }
    }

    async function fetchDashKpis(rid){
      const url = "/api/vsp/dash_kpis?rid=" + encodeURIComponent(rid||"");
      const r = await fetch(url, {credentials:"same-origin"});
      if (!r.ok) throw new Error("HTTP "+r.status);
      return await r.json();
    }

    function normText(s){ return (s||"").replace(/\s+/g," ").trim(); }

    // Hide ONLY the banner element that contains the exact degraded text
    function hideDegradedBanner(){
      const needles = ["KPI/Charts Degraded", "KPI data not available"];
      const els = Array.from(document.querySelectorAll("div,section,article,aside,span,p"));
      for (const el of els){
        const t = normText(el.textContent);
        if(!t) continue;
        if (!needles.some(n => t.includes(n))) continue;

        // Only hide the smallest element that contains the text (avoid hiding parents)
        el.style.display = "none";
      }
    }

    function findLabelNodes(label){
      label = normText(label);
      const els = Array.from(document.querySelectorAll("div,span,p,h1,h2,h3,h4,td,th"));
      return els.filter(el => {
        const t = normText(el.textContent);
        if(!t) return false;
        if(t === label) return true;
        // tolerant: Medium* / Medium (Risk...) / Total findings (extra notes)
        if(t.startsWith(label)) return true;
        if(label.length >= 4 && t.includes(label)) return true;
        // special: label "Medium*" should match anything starting with "Medium"
        if(label.replace("*","") && t.startsWith(label.replace("*",""))) return true;
        return false;
      });
    }

    function pickLargestNumberNode(container){
      const cand = Array.from(container.querySelectorAll("div,span,p,h1,h2,h3,h4"))
        .filter(el => /^[0-9][0-9,]*$/.test((el.textContent||"").trim()));
      if (!cand.length) return null;
      let best = cand[0], bestSize = 0;
      for (const el of cand){
        const fs = parseFloat(getComputedStyle(el).fontSize || "0") || 0;
        if (fs > bestSize){ bestSize = fs; best = el; }
      }
      return best;
    }

    function setKpiByLabel(label, value){
      const labs = findLabelNodes(label);
      for (const lab of labs){
        // climb mildly to card container, but stop early to avoid nuking layout
        let box = lab.closest("div") || lab.parentElement || lab;
        for (let i=0;i<4 && box && box.parentElement;i++){
          const pt = normText(box.parentElement.textContent);
          if (pt.includes("VSP Dashboard") || pt.includes("Top Findings")) break;
          box = box.parentElement;
        }
        const num = pickLargestNumberNode(box);
        if (num){
          num.textContent = String(value);
          return true;
        }
      }
      return false;
    }

    
    // --- VSP_P3_STABILIZE_KPI_V3_DOMCARDS ---
    function findKpiLabelNodeExact(label){
      label = normText(label);
      const els = Array.from(document.querySelectorAll(".vsp-kpi-label,div,span,p"));
      for (const el of els){
        const t = normText(el.textContent);
        if (!t) continue;
        if (t === label) return el;
      }
      return null;
    }

    function pickLargestNumberNodeWithin(root){
      if(!root) return null;
      const cand = Array.from(root.querySelectorAll("div,span,p,h1,h2,h3,h4"))
        .filter(el => /^[0-9][0-9,]*$/.test((el.textContent||"").trim()));
      if (!cand.length) return null;
      let best=cand[0], bestSize=0;
      for (const el of cand){
        const fs = parseFloat(getComputedStyle(el).fontSize || "0") || 0;
        if (fs > bestSize){ bestSize=fs; best=el; }
      }
      return best;
    }

    function setKpiCardValue(label, value){
      // Prefer the explicit label class used by luxe cards
      let lab = findKpiLabelNodeExact(label);
      if(!lab) return false;

      // Find nearest card container: climb a bit until we contain both label and a number
      let card = lab.closest("div");
      for (let i=0;i<8 && card && card.parentElement;i++){
        const num = pickLargestNumberNodeWithin(card);
        if (num){ num.textContent = String(value); return true; }
        card = card.parentElement;
      }
      // fallback: within parent
      const num2 = pickLargestNumberNodeWithin(lab.parentElement);
      if (num2){ num2.textContent = String(value); return true; }
      return false;
    }
    // --- /VSP_P3_STABILIZE_KPI_V3_DOMCARDS ---

async function applyOnce(){
      const rid = qp("rid");
      if(!rid) return;

      hideDegradedBanner();

      let j = null;
      try{ j = await fetchDashKpis(rid); } catch(e){ console.warn("[STABILIZE_KPI_V1] dash_kpis fetch failed", e); return; }
      if(!j || j.ok !== true) return;

      const total = iNum(j.total_findings ?? j.total);
      const ct = j.counts_total || j.counts || {};
      const high = iNum(ct.HIGH);
      const medium = iNum(ct.MEDIUM);
      const critical = iNum(ct.CRITICAL);

      if(total > 0){
        setKpiCardValue("Total findings", total) || setKpiCardValue("Total Findings", total);
        setKpiCardValue("High", high);
        setKpiCardValue("Medium+", medium) || setKpiCardValue("Medium", medium);
        setKpiCardValue("Critical", critical);
      }

      hideDegradedBanner();
      try{ console.log("[STABILIZE_KPI_V3_DOMCARDS] applied", {rid, total, critical, high, medium}); }catch(_){}
    }

    function boot(){
      // run multiple times because dashboard renders async
      setTimeout(applyOnce, 600);
      setTimeout(applyOnce, 1600);
      setTimeout(applyOnce, 3200);
      setTimeout(applyOnce, 5200);
      // keep banner suppressed
      let n=0;
      const t=setInterval(()=>{ n++; hideDegradedBanner(); if(n>25) clearInterval(t); }, 250);
    }

    if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", boot, {once:true});
    else boot();
  }catch(e){ try{ console.warn("[STABILIZE_KPI_V1] error", e); }catch(_){ } }
})();
/* ===================== /VSP_P3_STABILIZE_KPI_V1 ===================== */

/* VSP_P3_STABILIZE_KPI_V1 */

/* VSP_P3_STABILIZE_KPI_V2_LABELS */

/* VSP_P3_STABILIZE_KPI_V3_DOMCARDS */
// VSP_P0_FIX_LUXE_SYNTAX_RID_LATEST_TERNARY_V1
// VSP_P0_FIX_LUXE_SYNTAX_DASHKPIS_COLON_V2 dash_kpis=0 dash_charts=0 generic=1
// VSP_P0_FIX_LUXE_SYNTAX_EXTRA_PAREN_SAMEORIGIN_V4 fixed=1
