/* VSP_P1_TABS4_AUTORID_NODASH_V1
   - Only for non-dashboard tabs (Runs/Settings/Data Source/Rule Overrides)
   - Poll rid_latest_gate_root_v2 + ui_health_v2
   - Store RID in localStorage + dispatch event vsp:rid-changed
*/
(function(){
  const POLL_MS = 5000;
  const LS_KEY = "vsp_current_rid_v2";

  function pageIsDashboard(){
    // hard block: never run on /vsp5 (dashboard)
    try { return (location.pathname || "").startsWith("/vsp5"); } catch(e) { return false; }
  }
  if(pageIsDashboard()) return;

  function ensureBadge(){
    let el = document.getElementById("vsp-ui-ok-badge");
    if(el) return el;
    el = document.createElement("div");
    el.id = "vsp-ui-ok-badge";
    el.style.cssText = [
      "position:fixed","right:14px","bottom:14px","z-index:99999",
      "padding:10px 12px","border-radius:12px","font:600 12px/1.2 system-ui,Segoe UI,Roboto,Arial",
      "background:#1b2333","color:#d6e2ff","border:1px solid rgba(255,255,255,.12)",
      "box-shadow:0 10px 30px rgba(0,0,0,.35)"
    ].join(";");
    el.textContent = "UI OK: …";
    document.body.appendChild(el);
    return el;
  }

  async function fetchJSON(url){
    try{
      const r = await fetch(url, {cache:"no-store"});
      const ct = (r.headers.get("content-type")||"").toLowerCase();
      if(!ct.includes("application/json")){
        return {ok:false, err:"non-json", status:r.status, url};
      }
      const j = await r.json();
      if(typeof j !== "object" || j === null) return {ok:false, err:"bad-json", status:r.status, url};
      j._http_status = r.status;
      return j;
    }catch(e){
      return {ok:false, err:String(e), url};
    }
  }

  function setBadge(ok, rid, detail){
    const el = ensureBadge();
    if(ok){
      el.textContent = `UI OK: GREEN • ${rid||"-"}`;
      el.style.borderColor = "rgba(65,255,164,.35)";
      el.style.background = "rgba(10,28,18,.92)";
      el.style.color = "#bfffe0";
    }else{
      el.textContent = `UI OK: RED • ${rid||"-"}`;
      el.style.borderColor = "rgba(255,96,96,.45)";
      el.style.background = "rgba(35,10,12,.92)";
      el.style.color = "#ffd4d4";
    }
    if(detail && detail.err){ el.title = detail.err; }
    else if(detail && detail.checks && (!detail.ok)){
      try{ el.title = JSON.stringify(detail.checks).slice(0,700); }catch(e){ el.title=""; }
    } else el.title = "";
  }

  function tryUpdateRidPickers(rid){
    if(!rid) return;
    try{
      // Update <select> / <input> that looks like rid picker
      const nodes = Array.from(document.querySelectorAll("select, input"));
      for(const n of nodes){
        const id = (n.id||"").toLowerCase();
        const nm = (n.name||"").toLowerCase();
        if(id.includes("rid") || nm.includes("rid")){
          if(n.tagName === "SELECT"){
            // set if option exists
            const opt = Array.from(n.options||[]).find(o => (o.value===rid || (o.textContent||"").includes(rid)));
            if(opt){
              n.value = opt.value;
              n.dispatchEvent(new Event("change", {bubbles:true}));
            }
          }else{
            // input
            if(n.value !== rid){
              n.value = rid;
              n.dispatchEvent(new Event("input", {bubbles:true}));
              n.dispatchEvent(new Event("change", {bubbles:true}));
            }
          }
        }
      }
    }catch(e){}
  }

  async function callReloadHooks(){
    // Soft hooks (if tabs define them)
    const hooks = [
      "VSP_reloadAll",
      "VSP_reloadRuns",
      "VSP_reloadReports",
      "VSP_reloadSettings",
      "VSP_reloadDataSource",
      "VSP_reloadRuleOverrides",
    ];
    let called = false;
    for(const h of hooks){
      try{
        const fn = window[h];
        if(typeof fn === "function"){
          called = true;
          await Promise.resolve(fn());
        }
      }catch(e){}
    }
    return called;
  }

  let lastRID = null;

  function getStoredRID(){
    try{ return localStorage.getItem(LS_KEY) || ""; }catch(e){ return ""; }
  }
  function storeRID(rid){
    try{ localStorage.setItem(LS_KEY, rid); }catch(e){}
  }

  async function tick(){
    const latest = await fetchJSON("/api/vsp/rid_latest_gate_root_v2");
    const rid = (latest && latest.ok && latest.rid) ? latest.rid : null;

    if(rid && rid !== lastRID){
      lastRID = rid;
      storeRID(rid);
      window.VSP_CURRENT_RID = rid;

      // sync any rid picker on page
      tryUpdateRidPickers(rid);

      // notify others
      try{
        window.dispatchEvent(new CustomEvent("vsp:rid-changed", {detail:{rid, latest}}));
      }catch(e){}

      // reload tab data without full refresh
      const called = await callReloadHooks();
      // If nothing can reload AND page isn't critical, do nothing.
      // (No hard reload here to keep it safe/commercial.)
      if(!called){
        // Optional: if you really want, enable soft reload:
        // setTimeout(()=>location.reload(), 1200);
      }
    }else if(!lastRID){
      // initialize from localStorage if available
      const st = getStoredRID();
      if(st) lastRID = st;
    }

    const health = await fetchJSON("/api/vsp/ui_health_v2?rid=" + encodeURIComponent(lastRID||""));
    setBadge(!!(health && health.ok), lastRID, health);
  }

  setTimeout(()=>{ ensureBadge(); tick(); setInterval(tick, POLL_MS); }, 900);
})();

/* VSP_P1_AUTORID_CALL_PATH_HOOKS_V1C */
(function(){
  try{
    window.addEventListener("vsp:rid-changed", async ()=>{
      try{
        const p = (location.pathname||"").toLowerCase();
        if(p.startsWith("/vsp5")) return; // never dashboard
        if(p.startsWith("/settings") && typeof window.VSP_reloadSettings==="function") return void window.VSP_reloadSettings();
        if(p.startsWith("/data_source") && typeof window.VSP_reloadDataSource==="function") return void window.VSP_reloadDataSource();
        if(p.startsWith("/rule_overrides") && typeof window.VSP_reloadRuleOverrides==="function") return void window.VSP_reloadRuleOverrides();
        if((p.startsWith("/runs") || p.startsWith("/runs_reports")) && typeof window.VSP_reloadRuns==="function") return void window.VSP_reloadRuns();
        if(p.startsWith("/reports") && typeof window.VSP_reloadReports==="function") return void window.VSP_reloadReports();
      }catch(e){}
    });
  }catch(e){}
})();


/* VSP_P1_TABS4_AUTORID_DISPATCH_EVT_V1 */
(()=>{
  try{
    const KEY='VSP_RID_CURRENT';
    const emit=(rid,prev)=>{
      try{ window.dispatchEvent(new CustomEvent('VSP_RID_CHANGED',{detail:{rid,prev,ts:Date.now()}})); }catch(e){}
    };
    // best-effort wrap setRid if exists
    const w=window;
    const oldSet = w.VSP_setRid || null;
    if(typeof oldSet==='function'){
      w.VSP_setRid = function(rid){
        const prev = (localStorage.getItem(KEY)||'');
        const out = oldSet.apply(this, arguments);
        try{ localStorage.setItem(KEY, String(rid||'')); }catch(e){}
        if(String(rid||'') && String(rid||'')!==String(prev||'')) emit(String(rid||''), String(prev||''));
        return out;
      };
    }
    // also emit once on load if rid exists
    const cur = (localStorage.getItem(KEY)||'');
    if(cur) emit(cur,'');
  }catch(e){}
})();



/* VSP_P1_TABS4_AUTORID_POLL_LATEST_AUTOREFRESH_V2
 * - Poll /api/vsp/rid_latest_gate_root_v2 periodically
 * - If RID changes: store to localStorage + dispatch VSP_RID_CHANGED
 * - Auto refresh only for 4 tabs (NO /vsp5 dashboard)
 * - Safe fallback: location.reload() if no reload function exists
 */
(()=> {
  try {
    const RID_API = "/api/vsp/rid_latest_gate_root_v2";
    const KEY = "VSP_RID_CURRENT";
    const POLL_MS = 12000; // commercial default 12s
    const PATHS = new Set(["/runs","/runs_reports","/settings","/data_source","/rule_overrides"]);
    const isTabs4 = () => {
      try {
        const p = (location.pathname || "/").replace(/\/$/,"") || "/";
        if (p.startsWith("/vsp5")) return false;
        return PATHS.has(p);
      } catch(e){ return false; }
    };

    const toast = (msg) => {
      try {
        let el = document.getElementById("vspTabs4ToastV2");
        if(!el){
          el = document.createElement("div");
          el.id = "vspTabs4ToastV2";
          el.style.cssText = "position:fixed;right:14px;bottom:14px;z-index:99999;background:rgba(10,18,32,0.92);border:1px solid rgba(255,255,255,0.12);color:#e7eefc;padding:10px 12px;border-radius:12px;font:12px/1.35 system-ui;max-width:360px;box-shadow:0 14px 40px rgba(0,0,0,0.45)";
          document.body.appendChild(el);
        }
        el.textContent = msg;
        el.style.display = "block";
        clearTimeout(window.__vspTabs4ToastT);
        window.__vspTabs4ToastT = setTimeout(()=>{ try{ el.style.display="none"; }catch(e){} }, 2600);
      } catch(e){}
    };

    const getCur = () => {
      try { return localStorage.getItem(KEY) || ""; } catch(e){ return ""; }
    };

    const setCur = (rid) => {
      try { localStorage.setItem(KEY, String(rid||"")); } catch(e){}
    };

    const emit = (rid, prev) => {
      try {
        window.dispatchEvent(new CustomEvent("VSP_RID_CHANGED", { detail: { rid, prev, ts: Date.now(), via: "poll_v2" }}));
      } catch(e){}
    };

    const callReloadOrFallback = (detail) => {
      if(!isTabs4()) return;

      const p = (location.pathname || "/").replace(/\/$/,"") || "/";
      // never touch dashboard
      if(p.startsWith("/vsp5")) return;

      const tryCall = (fnName) => {
        try {
          const f = window[fnName];
          if(typeof f === "function"){
            f(detail||{});
            return true;
          }
        } catch(e){}
        return false;
      };

      // prefer real reload functions if available
      let ok = false;
      if(p === "/runs" || p === "/runs_reports"){
        ok = tryCall("VSP_reloadRuns");
      } else if(p === "/data_source"){
        ok = tryCall("VSP_reloadDataSource");
      } else if(p === "/settings"){
        ok = tryCall("VSP_reloadSettings");
      } else if(p === "/rule_overrides"){
        // safety: avoid nuking unsaved edits if page exposes a dirty flag
        try {
          if(window.__VSP_RULE_OVERRIDES_DIRTY) {
            toast("RID changed → not auto-reloading Rule Overrides (unsaved edits).");
            return;
          }
        } catch(e){}
        ok = tryCall("VSP_reloadRuleOverrides");
      }

      if(ok){
        toast("RID changed → refreshed data");
        return;
      }

      // fallback: soft reload this tab (commercial-safe)
      toast("RID changed → reloading tab to get latest results…");
      try {
        // throttle to avoid reload storm
        const now = Date.now();
        const last = window.__vspTabs4LastReloadTs || 0;
        if(now - last < 8000) return;
        window.__vspTabs4LastReloadTs = now;
        location.reload();
      } catch(e){}
    };

    async function pollOnce(){
      if(!isTabs4()) return;
      try {
        const r = await fetch(RID_API, { cache: "no-store" });
        const j = await r.json();
        const rid = (j && j.ok && j.rid) ? String(j.rid) : "";
        if(!rid) return;

        const prev = getCur();
        if(rid && rid !== prev){
          setCur(rid);
          emit(rid, prev);
          callReloadOrFallback({ rid, prev });
        }
      } catch(e){}
    }

    // Listen to RID changes from other sources too
    try {
      window.addEventListener("VSP_RID_CHANGED", (ev)=>{
        try {
          const d = ev && ev.detail ? ev.detail : {};
          // only react if we're on tabs4
          if(isTabs4()){
            // don't double reload: ignore if via poll already handled
            if(d && d.via === "poll_v2") return;
            callReloadOrFallback(d);
          }
        } catch(e){}
      });
    } catch(e){}

    // Start poll loop (only if tabs4)
    if(isTabs4()){
      setTimeout(pollOnce, 600);
      setInterval(pollOnce, POLL_MS);
    }
  } catch(e){}
})();

