/* VSP_DISABLE_LEGACY_DASH_ON_VSP5_V1 */
try{ if (String(location.pathname||"").includes("/vsp5")) { /* no legacy dash on vsp5 */ } }catch(_){ }

/* VSP_FETCH_DESCRIPTOR_SAFE_P0_V1 */
(function(){
  try{
    if (window.__vsp_fetch_descriptor_safe_p0_v1) return;
    window.__vsp_fetch_descriptor_safe_p0_v1 = true;

    function canOverrideFetch(){
      try{
        const d = Object.getOwnPropertyDescriptor(window, "fetch");
        if (!d) return true;
        // if accessor exists, allow (setter may exist)
        if (d.get || d.set) return true;
        // data descriptor: must be writable OR configurable to redefine
        if (d.writable) return true;
        if (d.configurable) return true;
        return false;
      }catch(_){ return false; }
    }

    // Provide a helper for other wrappers to use
    window.__vsp_can_override_fetch = canOverrideFetch;

    // If someone already wrapped fetch and locked it, don't crash future code.
    // We DO NOT wrap here; we only prevent TypeError by advising wrappers to check __vsp_can_override_fetch().
  }catch(_){}
})();




// VSP_P1_DASH_RENDER_V6C_IN_BUNDLE
(function(){
  if (window.__VSP_DASH_RENDER_V6C) return;
  window.__VSP_DASH_RENDER_V6C = true;

  function ensureCanvas(holderId){
    var el = document.getElementById(holderId);
    if (!el) return null;
    var tag = (el.tagName||"").toLowerCase();
    if (tag === "canvas") return el;
    var c = el.querySelector && el.querySelector("canvas");
    if (!c){
      c = document.createElement("canvas");
      c.style.width="100%";
      c.style.height="260px";
      el.innerHTML="";     // clear placeholder
      el.appendChild(c);
    }
    return c;
  }

  async function getRid(){
    try{
      var u = new URL(window.location.href);
      var rid = u.searchParams.get("rid");
      if (rid) return rid;
    }catch(e){}
    try{
      var r = await fetch("/api/vsp/runs?limit=1", {cache:"no-store"});
      var j = await r.json();
      if (j && j.items && j.items[0] && j.items[0].run_id) return j.items[0].run_id;
    }catch(e){}
    return "";
  }

  function parseDonut(j){
    if (j?.charts?.severity?.donut) return j.charts.severity.donut;
    if (j?.donut?.labels && j?.donut?.values) return j.donut;
    if (Array.isArray(j?.severity_distribution))
      return { labels: j.severity_distribution.map(x=>x.sev), values: j.severity_distribution.map(x=>x.count) };
    return null;
  }
  function parseTrend(j){
    if (j?.charts?.trend?.series) return j.charts.trend.series;
    if (j?.trend?.labels && j?.trend?.values) return j.trend;
    if (Array.isArray(j?.findings_trend))
      return { labels: j.findings_trend.map(x=>x.rid), values: j.findings_trend.map(x=>x.total) };
    return null;
  }
  function parseBarCritHigh(j){
    if (j?.charts?.crit_high_by_tool?.bar) return j.charts.crit_high_by_tool.bar;
    if (j?.bar_crit_high?.labels) return j.bar_crit_high;
    if (Array.isArray(j?.critical_high_by_tool)){
      var labels = j.critical_high_by_tool.map(x=>x.tool);
      var crit = j.critical_high_by_tool.map(x=>x.critical||0);
      var high = j.critical_high_by_tool.map(x=>x.high||0);
      return { labels: labels, series: [{name:"CRITICAL",data:crit},{name:"HIGH",data:high}] };
    }
    return null;
  }
  function parseTopCwe(j){
    if (j?.charts?.top_cwe?.series) return j.charts.top_cwe.series;
    if (j?.top_cwe?.labels && j?.top_cwe?.values) return j.top_cwe;
    if (Array.isArray(j?.top_cwe_exposure))
      return { labels: j.top_cwe_exposure.map(x=>x.cwe), values: j.top_cwe_exposure.map(x=>x.count) };
    return { labels: [], values: [] };
  }

  function destroyKey(k){ try{ window[k]?.destroy?.(); }catch(e){} window[k]=null; }

  async function renderOnce(){
    if (!window.Chart) return false;

    var a=document.getElementById("vsp-chart-severity");
    var b=document.getElementById("vsp-chart-trend");
    var c=document.getElementById("vsp-chart-bytool");
    var d=document.getElementById("vsp-chart-topcwe");
    if (!a || !b || !c || !d) return false;

    var rid = await getRid();
    if (!rid) return false;

    var resp = await fetch("/api/vsp/dash_charts?rid="+encodeURIComponent(rid), {cache:"no-store"});
    var j = await resp.json();

    var donut=parseDonut(j), trend=parseTrend(j), bar=parseBarCritHigh(j), top=parseTopCwe(j);

    var c1=ensureCanvas("vsp-chart-severity");
    if (c1 && donut){
      destroyKey("__VSP_DONUT_V6C");
      window.__VSP_DONUT_V6C = new Chart(c1, {type:"doughnut",
        data:{labels:donut.labels,datasets:[{data:donut.values}]},
        options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}}}
      });
    }

    var c2=ensureCanvas("vsp-chart-trend");
    if (c2 && trend){
      destroyKey("__VSP_TREND_V6C");
      window.__VSP_TREND_V6C = new Chart(c2, {type:"line",
        data:{labels:trend.labels,datasets:[{data:trend.values}]},
        options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}}}
      });
    }

    var c3=ensureCanvas("vsp-chart-bytool");
    if (c3 && bar){
      destroyKey("__VSP_BYTOOL_V6C");
      var s0=bar.series?.[0]?.data||[], s1=bar.series?.[1]?.data||[];
      window.__VSP_BYTOOL_V6C = new Chart(c3, {type:"bar",
        data:{labels:bar.labels,datasets:[{label:"CRITICAL",data:s0},{label:"HIGH",data:s1}]},
        options:{responsive:true,maintainAspectRatio:false}
      });
    }

    var c4=ensureCanvas("vsp-chart-topcwe");
    if (c4 && top){
      destroyKey("__VSP_TOPCWE_V6C");
      window.__VSP_TOPCWE_V6C = new Chart(c4, {type:"bar",
        data:{labels:top.labels,datasets:[{data:top.values}]},
        options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}}}
      });
    }

    console.log("[VSP][DASH][V6C] rendered rid=", rid);
    return true;
  }

  var tries=0;
  var t=setInterval(function(){
    tries++;
    renderOnce().then(function(ok){
      if (ok || tries>=20){
        clearInterval(t);
        if (!ok) console.warn("[VSP][DASH][V6C] gave up (Chart/container missing)");
      }
    }).catch(function(e){
      if (tries>=20){ clearInterval(t); console.warn("[VSP][DASH][V6C] error", e); }
    });
  }, 500);
})();




// VSP_P1_DASH_CANVAS_FALLBACK_V6D
(function(){
  if (window.__VSP_DASH_RENDER_V6D) return;
  window.__VSP_DASH_RENDER_V6D = true;

  function ensureCanvas(holderId){
    var el = document.getElementById(holderId);
    if (!el) return null;
    var tag = (el.tagName||"").toLowerCase();
    if (tag === "canvas") return el;

    var c = el.querySelector && el.querySelector("canvas");
    if (!c){
      c = document.createElement("canvas");
      c.width = 900; c.height = 300;
      c.style.width="100%";
      c.style.height="260px";
      el.innerHTML=""; // clear placeholder
      el.appendChild(c);
    }
    return c;
  }

  async function getRid(){
    try{
      var u = new URL(window.location.href);
      var rid = u.searchParams.get("rid");
      if (rid) return rid;
    }catch(e){}
    try{
      var r = await fetch("/api/vsp/runs?limit=1", {cache:"no-store"});
      var j = await r.json();
      if (j && j.items && j.items[0] && j.items[0].run_id) return j.items[0].run_id;
    }catch(e){}
    return "";
  }

  function parseDonut(j){
    if (j?.charts?.severity?.donut) return j.charts.severity.donut;
    if (j?.donut?.labels && j?.donut?.values) return j.donut;
    if (Array.isArray(j?.severity_distribution))
      return { labels: j.severity_distribution.map(x=>x.sev), values: j.severity_distribution.map(x=>x.count) };
    return null;
  }
  function parseTrend(j){
    if (j?.charts?.trend?.series) return j.charts.trend.series;
    if (j?.trend?.labels && j?.trend?.values) return j.trend;
    if (Array.isArray(j?.findings_trend))
      return { labels: j.findings_trend.map(x=>x.rid), values: j.findings_trend.map(x=>x.total) };
    return null;
  }
  function parseBarCritHigh(j){
    if (j?.charts?.crit_high_by_tool?.bar) return j.charts.crit_high_by_tool.bar;
    if (j?.bar_crit_high?.labels) return j.bar_crit_high;
    if (Array.isArray(j?.critical_high_by_tool)){
      var labels = j.critical_high_by_tool.map(x=>x.tool);
      var crit = j.critical_high_by_tool.map(x=>x.critical||0);
      var high = j.critical_high_by_tool.map(x=>x.high||0);
      return { labels: labels, series: [{name:"CRITICAL",data:crit},{name:"HIGH",data:high}] };
    }
    return null;
  }
  function parseTopCwe(j){
    if (j?.charts?.top_cwe?.series) return j.charts.top_cwe.series;
    if (j?.top_cwe?.labels && j?.top_cwe?.values) return j.top_cwe;
    if (Array.isArray(j?.top_cwe_exposure))
      return { labels: j.top_cwe_exposure.map(x=>x.cwe), values: j.top_cwe_exposure.map(x=>x.count) };
    return { labels: [], values: [] };
  }

  // ---- Canvas drawing helpers (no Chart.js) ----
  function ctx2d(canvas){
    var ctx = canvas.getContext("2d");
    var w = canvas.width, h = canvas.height;
    // handle hiDPI
    var dpr = window.devicePixelRatio || 1;
    var cssW = canvas.clientWidth || w;
    var cssH = canvas.clientHeight || h;
    canvas.width = Math.max(300, Math.floor(cssW * dpr));
    canvas.height = Math.max(200, Math.floor(cssH * dpr));
    ctx.setTransform(dpr,0,0,dpr,0,0);
    return ctx;
  }

  function clear(ctx, w, h){
    ctx.clearRect(0,0,w,h);
    // subtle grid bg
    ctx.globalAlpha = 0.08;
    ctx.fillStyle = "#ffffff";
    ctx.fillRect(0,0,w,h);
    ctx.globalAlpha = 1;
  }

  function textCenter(ctx, w, h, msg){
    ctx.save();
    ctx.fillStyle = "rgba(255,255,255,0.75)";
    ctx.font = "12px system-ui, -apple-system, Segoe UI, Roboto, Arial";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText(msg, w/2, h/2);
    ctx.restore();
  }

  function drawDonut(canvas, labels, values){
    var ctx = ctx2d(canvas);
    var w = canvas.clientWidth || 900, h = canvas.clientHeight || 260;
    clear(ctx, w, h);
    var total = values.reduce((a,b)=>a+(+b||0),0);
    if (!total){ textCenter(ctx,w,h,"No data"); return; }

    var cx=w/2, cy=h/2, r=Math.min(w,h)*0.32, rIn=r*0.55;
    var ang=-Math.PI/2;

    var palette=["#ef4444","#f59e0b","#3b82f6","#22c55e","#a855f7","#94a3b8"];
    for (var i=0;i<values.length;i++){
      var v=+values[i]||0;
      var a=(v/total)*Math.PI*2;
      ctx.beginPath();
      ctx.moveTo(cx,cy);
      ctx.fillStyle=palette[i%palette.length];
      ctx.globalAlpha=0.85;
      ctx.arc(cx,cy,r,ang,ang+a);
      ctx.closePath();
      ctx.fill();
      ang+=a;
    }
    // hole
    ctx.globalAlpha=1;
    ctx.beginPath();
    ctx.fillStyle="rgba(0,0,0,0.55)";
    ctx.arc(cx,cy,rIn,0,Math.PI*2);
    ctx.fill();

    // center text
    ctx.fillStyle="rgba(255,255,255,0.85)";
    ctx.font="bold 16px system-ui, -apple-system, Segoe UI, Roboto, Arial";
    ctx.textAlign="center"; ctx.textBaseline="middle";
    ctx.fillText(String(total), cx, cy-2);
    ctx.font="12px system-ui, -apple-system, Segoe UI, Roboto, Arial";
    ctx.fillStyle="rgba(255,255,255,0.7)";
    ctx.fillText("total", cx, cy+16);
  }

  function drawLine(canvas, labels, values){
    var ctx = ctx2d(canvas);
    var w = canvas.clientWidth || 900, h = canvas.clientHeight || 260;
    clear(ctx, w, h);
    if (!values || !values.length){ textCenter(ctx,w,h,"No data"); return; }

    var padL=46, padR=14, padT=14, padB=30;
    var plotW=w-padL-padR, plotH=h-padT-padB;

    var maxV=Math.max.apply(null, values.map(v=>+v||0));
    var minV=Math.min.apply(null, values.map(v=>+v||0));
    if (maxV===minV) maxV=minV+1;

    // axes
    ctx.strokeStyle="rgba(255,255,255,0.18)";
    ctx.lineWidth=1;
    ctx.beginPath();
    ctx.moveTo(padL,padT);
    ctx.lineTo(padL,padT+plotH);
    ctx.lineTo(padL+plotW,padT+plotH);
    ctx.stroke();

    // line
    ctx.strokeStyle="rgba(59,130,246,0.9)";
    ctx.lineWidth=2;
    ctx.beginPath();
    for (var i=0;i<values.length;i++){
      var x = padL + (i/(Math.max(1,values.length-1)))*plotW;
      var y = padT + (1-((+values[i]||0)-minV)/(maxV-minV))*plotH;
      if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    }
    ctx.stroke();

    // points
    ctx.fillStyle="rgba(59,130,246,0.95)";
    for (var i=0;i<values.length;i++){
      var x = padL + (i/(Math.max(1,values.length-1)))*plotW;
      var y = padT + (1-((+values[i]||0)-minV)/(maxV-minV))*plotH;
      ctx.beginPath(); ctx.arc(x,y,3,0,Math.PI*2); ctx.fill();
    }

    // y labels
    ctx.fillStyle="rgba(255,255,255,0.7)";
    ctx.font="12px system-ui, -apple-system, Segoe UI, Roboto, Arial";
    ctx.textAlign="right"; ctx.textBaseline="middle";
    ctx.fillText(String(maxV), padL-8, padT);
    ctx.fillText(String(minV), padL-8, padT+plotH);
  }

  function drawBars(canvas, labels, s0, s1){
    var ctx = ctx2d(canvas);
    var w = canvas.clientWidth || 900, h = canvas.clientHeight || 260;
    clear(ctx, w, h);
    if (!labels || !labels.length){ textCenter(ctx,w,h,"No data"); return; }

    var padL=46, padR=14, padT=14, padB=30;
    var plotW=w-padL-padR, plotH=h-padT-padB;

    var maxV=0;
    for (var i=0;i<labels.length;i++){
      maxV=Math.max(maxV, (+s0[i]||0)+(+s1[i]||0), (+s0[i]||0), (+s1[i]||0));
    }
    if (!maxV) maxV=1;

    // axes
    ctx.strokeStyle="rgba(255,255,255,0.18)";
    ctx.lineWidth=1;
    ctx.beginPath();
    ctx.moveTo(padL,padT);
    ctx.lineTo(padL,padT+plotH);
    ctx.lineTo(padL+plotW,padT+plotH);
    ctx.stroke();

    var n=labels.length;
    var groupW = plotW / n;
    var barW = Math.max(6, groupW*0.28);

    for (var i=0;i<n;i++){
      var x0 = padL + i*groupW + groupW*0.18;
      var v0 = +s0[i]||0;
      var v1 = +s1[i]||0;

      var h0 = (v0/maxV)*plotH;
      var h1 = (v1/maxV)*plotH;

      // critical
      ctx.fillStyle="rgba(239,68,68,0.85)";
      ctx.fillRect(x0, padT+plotH-h0, barW, h0);

      // high (next to)
      ctx.fillStyle="rgba(245,158,11,0.85)";
      ctx.fillRect(x0+barW+4, padT+plotH-h1, barW, h1);
    }
  }

  async function renderOnce(){
    var a=document.getElementById("vsp-chart-severity");
    var b=document.getElementById("vsp-chart-trend");
    var c=document.getElementById("vsp-chart-bytool");
    var d=document.getElementById("vsp-chart-topcwe");
    if (!a || !b || !c || !d) return false;

    var rid = await getRid();
    if (!rid) return false;

    var resp = await fetch("/api/vsp/dash_charts?rid="+encodeURIComponent(rid), {cache:"no-store"});
    var j = await resp.json();

    var donut=parseDonut(j);
    var trend=parseTrend(j);
    var bar=parseBarCritHigh(j);
    var top=parseTopCwe(j);

    // DONUT
    var c1=ensureCanvas("vsp-chart-severity");
    if (c1 && donut) drawDonut(c1, donut.labels||[], donut.values||[]);

    // TREND
    var c2=ensureCanvas("vsp-chart-trend");
    if (c2 && trend) drawLine(c2, trend.labels||[], trend.values||[]);

    // BYTOOL
    var c3=ensureCanvas("vsp-chart-bytool");
    if (c3 && bar){
      var s0 = bar.series?.[0]?.data || [];
      var s1 = bar.series?.[1]?.data || [];
      drawBars(c3, bar.labels||[], s0, s1);
    }

    // TOPCWE (single series)
    var c4=ensureCanvas("vsp-chart-topcwe");
    if (c4 && top){
      drawBars(c4, top.labels||[], top.values||[], new Array((top.labels||[]).length).fill(0));
    }

    console.log("[VSP][DASH][V6D] canvas-rendered rid=", rid, "ChartJS=", !!window.Chart);
    return true;
  }

  var tries=0;
  var t=setInterval(function(){
    tries++;
    renderOnce().then(function(ok){
      if (ok || tries>=20){
        clearInterval(t);
        if (!ok) console.warn("[VSP][DASH][V6D] gave up: containers/rid missing");
      }
    }).catch(function(e){
      if (tries>=20){ clearInterval(t); console.warn("[VSP][DASH][V6D] error", e); }
    });
  }, 500);
})();




// VSP_P1_DASH_RID_RESOLVER_CANVAS_V6E
(function(){
  if (window.__VSP_DASH_V6E) return;
  window.__VSP_DASH_V6E = true;

  function qs(id){ return document.getElementById(id); }

  function ensureCanvas(holderId){
    var el = qs(holderId);
    if (!el) return null;
    if ((el.tagName||"").toLowerCase()==="canvas") return el;
    var c = el.querySelector && el.querySelector("canvas");
    if (!c){
      c=document.createElement("canvas");
      c.style.width="100%";
      c.style.height="260px";
      el.innerHTML="";
      el.appendChild(c);
    }
    return c;
  }

  function setupCtx(canvas){
    var ctx=canvas.getContext("2d");
    var dpr=window.devicePixelRatio||1;
    var w=Math.max(320, canvas.clientWidth||900);
    var h=Math.max(220, canvas.clientHeight||260);
    canvas.width=Math.floor(w*dpr);
    canvas.height=Math.floor(h*dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
    return {ctx,w,h};
  }

  function clearBg(ctx,w,h){
    ctx.clearRect(0,0,w,h);
    ctx.fillStyle="rgba(255,255,255,0.03)";
    ctx.fillRect(0,0,w,h);
  }

  function drawText(ctx,w,h,msg){
    ctx.fillStyle="rgba(255,255,255,0.75)";
    ctx.font="12px system-ui, -apple-system, Segoe UI, Roboto, Arial";
    ctx.textAlign="center"; ctx.textBaseline="middle";
    ctx.fillText(msg, w/2, h/2);
  }

  function drawDonut(canvas, labels, values){
    var o=setupCtx(canvas), ctx=o.ctx, w=o.w, h=o.h;
    clearBg(ctx,w,h);
    var total=(values||[]).reduce((a,b)=>a+(+b||0),0);
    if (!total){ drawText(ctx,w,h,"No data"); return; }
    var cx=w/2, cy=h/2, r=Math.min(w,h)*0.32, rIn=r*0.55;
    var ang=-Math.PI/2;
    var pal=["#ef4444","#f59e0b","#3b82f6","#22c55e","#a855f7","#94a3b8"];
    for (var i=0;i<values.length;i++){
      var v=+values[i]||0, a=(v/total)*Math.PI*2;
      ctx.beginPath(); ctx.moveTo(cx,cy);
      ctx.fillStyle=pal[i%pal.length];
      ctx.globalAlpha=0.85;
      ctx.arc(cx,cy,r,ang,ang+a);
      ctx.closePath(); ctx.fill();
      ang+=a;
    }
    ctx.globalAlpha=1;
    ctx.beginPath(); ctx.fillStyle="rgba(0,0,0,0.55)";
    ctx.arc(cx,cy,rIn,0,Math.PI*2); ctx.fill();
    ctx.fillStyle="rgba(255,255,255,0.85)";
    ctx.font="bold 16px system-ui, -apple-system, Segoe UI, Roboto, Arial";
    ctx.textAlign="center"; ctx.textBaseline="middle";
    ctx.fillText(String(total), cx, cy-2);
    ctx.font="12px system-ui, -apple-system, Segoe UI, Roboto, Arial";
    ctx.fillStyle="rgba(255,255,255,0.65)";
    ctx.fillText("total", cx, cy+16);
  }

  function drawLine(canvas, labels, values){
    var o=setupCtx(canvas), ctx=o.ctx, w=o.w, h=o.h;
    clearBg(ctx,w,h);
    if (!values || !values.length){ drawText(ctx,w,h,"No data"); return; }
    var padL=46,padR=14,padT=14,padB=30;
    var pw=w-padL-padR, ph=h-padT-padB;
    var maxV=Math.max.apply(null, values.map(v=>+v||0));
    var minV=Math.min.apply(null, values.map(v=>+v||0));
    if (maxV===minV) maxV=minV+1;

    ctx.strokeStyle="rgba(255,255,255,0.18)";
    ctx.lineWidth=1;
    ctx.beginPath();
    ctx.moveTo(padL,padT);
    ctx.lineTo(padL,padT+ph);
    ctx.lineTo(padL+pw,padT+ph);
    ctx.stroke();

    ctx.strokeStyle="rgba(59,130,246,0.9)";
    ctx.lineWidth=2;
    ctx.beginPath();
    for (var i=0;i<values.length;i++){
      var x=padL+(i/(Math.max(1,values.length-1)))*pw;
      var y=padT+(1-((+values[i]||0)-minV)/(maxV-minV))*ph;
      if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    }
    ctx.stroke();
  }

  function drawBars(canvas, labels, a0, a1){
    var o=setupCtx(canvas), ctx=o.ctx, w=o.w, h=o.h;
    clearBg(ctx,w,h);
    if (!labels || !labels.length){ drawText(ctx,w,h,"No data"); return; }
    var padL=46,padR=14,padT=14,padB=30;
    var pw=w-padL-padR, ph=h-padT-padB;
    var maxV=1;
    for (var i=0;i<labels.length;i++){
      maxV=Math.max(maxV, (+a0[i]||0), (+a1[i]||0), (+a0[i]||0)+(+a1[i]||0));
    }

    ctx.strokeStyle="rgba(255,255,255,0.18)";
    ctx.lineWidth=1;
    ctx.beginPath();
    ctx.moveTo(padL,padT);
    ctx.lineTo(padL,padT+ph);
    ctx.lineTo(padL+pw,padT+ph);
    ctx.stroke();

    var n=labels.length;
    var gw=pw/n;
    var bw=Math.max(6, gw*0.28);
    for (var i=0;i<n;i++){
      var x0=padL+i*gw+gw*0.18;
      var v0=+a0[i]||0, v1=+a1[i]||0;
      var h0=(v0/maxV)*ph, h1=(v1/maxV)*ph;
      ctx.fillStyle="rgba(239,68,68,0.85)";
      ctx.fillRect(x0, padT+ph-h0, bw, h0);
      ctx.fillStyle="rgba(245,158,11,0.85)";
      ctx.fillRect(x0+bw+4, padT+ph-h1, bw, h1);
    }
  }

  function parse(j){
    var donut=null, trend=null, bar=null, top=null;

    if (Array.isArray(j?.severity_distribution))
      donut={labels:j.severity_distribution.map(x=>x.sev), values:j.severity_distribution.map(x=>x.count)};

    if (Array.isArray(j?.findings_trend))
      trend={labels:j.findings_trend.map(x=>x.rid), values:j.findings_trend.map(x=>x.total)};

    if (Array.isArray(j?.critical_high_by_tool)){
      bar={labels:j.critical_high_by_tool.map(x=>x.tool),
           s0:j.critical_high_by_tool.map(x=>x.critical||0),
           s1:j.critical_high_by_tool.map(x=>x.high||0)};
    }

    if (Array.isArray(j?.top_cwe_exposure))
      top={labels:j.top_cwe_exposure.map(x=>x.cwe), values:j.top_cwe_exposure.map(x=>x.count)};

    return {donut,trend,bar,top};
  }

  function ridFromText(){
    try{
      var t=(document.body && (document.body.innerText||document.body.textContent)||"");
      var m=t.match(/rid_latest\s*=\s*([A-Za-z0-9_\-\.]+)/i) || t.match(/rid_latest\s*:\s*([A-Za-z0-9_\-\.]+)/i);
      return m ? (m[1]||"") : "";
    }catch(e){ return ""; }
  }

  async function resolveRid(){
    // 1) URL param
    try{
      var u=new URL(window.location.href);
      var rid=u.searchParams.get("rid");
      if (rid) return rid;
    }catch(e){}

    // 2) hidden input / element
    var el=qs("vsp_live_rid");
    if (el){
      var v = (el.value!=null ? el.value : "") || (el.textContent||"").trim();
      if (v) return v;
    }

    // 3) text regex (your “OK rid_latest=...”)
    var r3 = ridFromText();
    if (r3) return r3;

    // 4) API fallback
    try{
      var r=await fetch("/api/vsp/runs?limit=1", {cache:"no-store"});
      var j=await r.json();
      var rid2=j?.items?.[0]?.run_id || "";
      return rid2;
    }catch(e){
      return "";
    }
  }

  async function render(){
    // only on /vsp5
    if (!(location.pathname||"").includes("/vsp5")) return false;

    var ids=["vsp-chart-severity","vsp-chart-trend","vsp-chart-bytool","vsp-chart-topcwe"];
    var okIds = ids.every(id=>!!qs(id));
    var rid = await resolveRid();

    console.log("[VSP][DASH][V6E] check ids=", okIds, "rid=", rid);

    if (!okIds || !rid) return false;

    // fetch charts once
    var resp=await fetch("/api/vsp/dash_charts?rid="+encodeURIComponent(rid), {cache:"no-store"});
    var j=await resp.json();
    var o=parse(j);

    var c1=ensureCanvas("vsp-chart-severity"); if (c1 && o.donut) drawDonut(c1, o.donut.labels, o.donut.values);
    var c2=ensureCanvas("vsp-chart-trend"); if (c2 && o.trend) drawLine(c2, o.trend.labels, o.trend.values);
    var c3=ensureCanvas("vsp-chart-bytool"); if (c3 && o.bar) drawBars(c3, o.bar.labels, o.bar.s0, o.bar.s1);
    var c4=ensureCanvas("vsp-chart-topcwe"); if (c4 && o.top) drawBars(c4, o.top.labels, o.top.values, new Array(o.top.labels.length).fill(0));

    console.log("[VSP][DASH][V6E] rendered rid=", rid);
    return true;
  }

  function start(){
    var tries=0;
    var t=setInterval(function(){
      tries++;
      render().then(function(ok){
        if (ok || tries>=60){ // 30s
          clearInterval(t);
          if (!ok) console.warn("[VSP][DASH][V6E] gave up (rid/ids still missing)");
        }
      }).catch(function(e){
        if (tries>=60){ clearInterval(t); console.warn("[VSP][DASH][V6E] error", e); }
      });
    }, 500);
  }

  if (document.readyState==="complete") start();
  else window.addEventListener("load", start);
})();




// VSP_P1_DASH_RID_WAIT_CANVAS_V6F
(function(){
  if (window.__VSP_DASH_V6F) return;
  window.__VSP_DASH_V6F = true;

  function id(x){ return document.getElementById(x); }

  function extractRidFromText(t){
    if (!t) return "";
    // accept rid_latest: XXX or rid_latest=XXX or FORCE rid=XXX
    var m = String(t).match(/rid_latest\s*[:=]\s*([A-Za-z0-9_\-\.]+)/i) ||
            String(t).match(/FORCE\s*rid\s*=\s*([A-Za-z0-9_\-\.]+)/i);
    return m ? (m[1]||"") : "";
  }

  function isGoodRid(r){
    if (!r) return false;
    if (r === "N/A" || r === "..." || r === "NA") return false;
    if (r.indexOf("rid_latest")>=0) return false;
    if (r.indexOf(":")>=0 || r.indexOf(" ")>=0) return false;
    return true;
  }

  async function resolveRidStrong(){
    // 1) URL param
    try{
      var u=new URL(location.href);
      var rid=u.searchParams.get("rid");
      if (isGoodRid(rid)) return rid;
    }catch(e){}

    // 2) #vsp_live_rid text (it will become: "rid_latest: REAL_RID")
    var el=id("vsp_live_rid");
    if (el){
      var t=(el.value!=null ? el.value : "") || (el.textContent||"");
      var r2 = extractRidFromText(t) || String(t).trim();
      if (isGoodRid(r2)) return r2;
    }

    // 3) badge (if exists)
    var b=id("vsp_rid_latest_badge");
    if (b){
      var r3=extractRidFromText(b.textContent||"");
      if (isGoodRid(r3)) return r3;
    }

    // 4) /api/vsp/runs (best fallback)
    try{
      var r=await fetch("/api/vsp/runs?limit=1", {cache:"no-store"});
      var j=await r.json();
      var ridLatest = j && j.rid_latest ? j.rid_latest : "";
      if (isGoodRid(ridLatest)) return ridLatest;
      var rid0 = j?.items?.[0]?.run_id || "";
      if (isGoodRid(rid0)) return rid0;
    }catch(e){}

    return "";
  }

  function ensureCanvas(holderId){
    var el=id(holderId);
    if (!el) return null;
    if ((el.tagName||"").toLowerCase()==="canvas") return el;
    var c = el.querySelector && el.querySelector("canvas");
    if (!c){
      c=document.createElement("canvas");
      c.style.width="100%";
      c.style.height="260px";
      el.innerHTML="";
      el.appendChild(c);
    }
    return c;
  }

  function setupCtx(canvas){
    var ctx=canvas.getContext("2d");
    var dpr=window.devicePixelRatio||1;
    var w=Math.max(320, canvas.clientWidth||900);
    var h=Math.max(220, canvas.clientHeight||260);
    canvas.width=Math.floor(w*dpr);
    canvas.height=Math.floor(h*dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
    return {ctx,w,h};
  }
  function clearBg(ctx,w,h){
    ctx.clearRect(0,0,w,h);
    ctx.fillStyle="rgba(255,255,255,0.03)";
    ctx.fillRect(0,0,w,h);
  }
  function textCenter(ctx,w,h,msg){
    ctx.fillStyle="rgba(255,255,255,0.75)";
    ctx.font="12px system-ui, -apple-system, Segoe UI, Roboto, Arial";
    ctx.textAlign="center"; ctx.textBaseline="middle";
    ctx.fillText(msg, w/2, h/2);
  }
  function drawDonut(canvas, labels, values){
    var o=setupCtx(canvas), ctx=o.ctx, w=o.w, h=o.h;
    clearBg(ctx,w,h);
    var total=(values||[]).reduce((a,b)=>a+(+b||0),0);
    if (!total){ textCenter(ctx,w,h,"No data"); return; }
    var cx=w/2, cy=h/2, r=Math.min(w,h)*0.32, rIn=r*0.55;
    var ang=-Math.PI/2;
    var pal=["#ef4444","#f59e0b","#3b82f6","#22c55e","#a855f7","#94a3b8"];
    for (var i=0;i<values.length;i++){
      var v=+values[i]||0, a=(v/total)*Math.PI*2;
      ctx.beginPath(); ctx.moveTo(cx,cy);
      ctx.fillStyle=pal[i%pal.length];
      ctx.globalAlpha=0.85;
      ctx.arc(cx,cy,r,ang,ang+a);
      ctx.closePath(); ctx.fill();
      ang+=a;
    }
    ctx.globalAlpha=1;
    ctx.beginPath(); ctx.fillStyle="rgba(0,0,0,0.55)";
    ctx.arc(cx,cy,rIn,0,Math.PI*2); ctx.fill();
    ctx.fillStyle="rgba(255,255,255,0.85)";
    ctx.font="bold 16px system-ui, -apple-system, Segoe UI, Roboto, Arial";
    ctx.textAlign="center"; ctx.textBaseline="middle";
    ctx.fillText(String(total), cx, cy-2);
    ctx.font="12px system-ui, -apple-system, Segoe UI, Roboto, Arial";
    ctx.fillStyle="rgba(255,255,255,0.65)";
    ctx.fillText("total", cx, cy+16);
  }
  function drawLine(canvas, labels, values){
    var o=setupCtx(canvas), ctx=o.ctx, w=o.w, h=o.h;
    clearBg(ctx,w,h);
    if (!values || !values.length){ textCenter(ctx,w,h,"No data"); return; }
    var padL=46,padR=14,padT=14,padB=30;
    var pw=w-padL-padR, ph=h-padT-padB;
    var maxV=Math.max.apply(null, values.map(v=>+v||0));
    var minV=Math.min.apply(null, values.map(v=>+v||0));
    if (maxV===minV) maxV=minV+1;
    ctx.strokeStyle="rgba(255,255,255,0.18)";
    ctx.lineWidth=1;
    ctx.beginPath();
    ctx.moveTo(padL,padT); ctx.lineTo(padL,padT+ph); ctx.lineTo(padL+pw,padT+ph);
    ctx.stroke();
    ctx.strokeStyle="rgba(59,130,246,0.9)";
    ctx.lineWidth=2;
    ctx.beginPath();
    for (var i=0;i<values.length;i++){
      var x=padL+(i/(Math.max(1,values.length-1)))*pw;
      var y=padT+(1-((+values[i]||0)-minV)/(maxV-minV))*ph;
      if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    }
    ctx.stroke();
  }
  function drawBars(canvas, labels, a0, a1){
    var o=setupCtx(canvas), ctx=o.ctx, w=o.w, h=o.h;
    clearBg(ctx,w,h);
    if (!labels || !labels.length){ textCenter(ctx,w,h,"No data"); return; }
    var padL=46,padR=14,padT=14,padB=30;
    var pw=w-padL-padR, ph=h-padT-padB;
    var maxV=1;
    for (var i=0;i<labels.length;i++){
      maxV=Math.max(maxV, (+a0[i]||0), (+a1[i]||0), (+a0[i]||0)+(+a1[i]||0));
    }
    ctx.strokeStyle="rgba(255,255,255,0.18)";
    ctx.lineWidth=1;
    ctx.beginPath();
    ctx.moveTo(padL,padT); ctx.lineTo(padL,padT+ph); ctx.lineTo(padL+pw,padT+ph);
    ctx.stroke();
    var n=labels.length, gw=pw/n, bw=Math.max(6, gw*0.28);
    for (var i=0;i<n;i++){
      var x0=padL+i*gw+gw*0.18;
      var v0=+a0[i]||0, v1=+a1[i]||0;
      var h0=(v0/maxV)*ph, h1=(v1/maxV)*ph;
      ctx.fillStyle="rgba(239,68,68,0.85)";
      ctx.fillRect(x0, padT+ph-h0, bw, h0);
      ctx.fillStyle="rgba(245,158,11,0.85)";
      ctx.fillRect(x0+bw+4, padT+ph-h1, bw, h1);
    }
  }

  function parseCharts(j){
    var donut=null, trend=null, bar=null, top=null;
    if (Array.isArray(j?.severity_distribution))
      donut={labels:j.severity_distribution.map(x=>x.sev), values:j.severity_distribution.map(x=>x.count)};
    if (Array.isArray(j?.findings_trend))
      trend={labels:j.findings_trend.map(x=>x.rid), values:j.findings_trend.map(x=>x.total)};
    if (Array.isArray(j?.critical_high_by_tool))
      bar={labels:j.critical_high_by_tool.map(x=>x.tool),
           a0:j.critical_high_by_tool.map(x=>x.critical||0),
           a1:j.critical_high_by_tool.map(x=>x.high||0)};
    if (Array.isArray(j?.top_cwe_exposure))
      top={labels:j.top_cwe_exposure.map(x=>x.cwe), values:j.top_cwe_exposure.map(x=>x.count)};
    return {donut,trend,bar,top};
  }

  async function renderOnce(){
    if (!(location.pathname||"").includes("/vsp5")) return false;

    var ids=["vsp-chart-severity","vsp-chart-trend","vsp-chart-bytool","vsp-chart-topcwe"];
    var okIds=ids.every(x=>!!id(x));
    var rid=await resolveRidStrong();

    console.log("[VSP][DASH][V6F] ids=", okIds, "rid=", rid);

    if (!okIds || !isGoodRid(rid)) return false;

    var resp=await fetch("/api/vsp/dash_charts?rid="+encodeURIComponent(rid), {cache:"no-store"});
    if (!resp.ok){
      console.warn("[VSP][DASH][V6F] dash_charts HTTP", resp.status);
      return false;
    }
    var j=await resp.json();
    var o=parseCharts(j);

    var c1=ensureCanvas("vsp-chart-severity"); if (c1 && o.donut) drawDonut(c1, o.donut.labels, o.donut.values);
    var c2=ensureCanvas("vsp-chart-trend");    if (c2 && o.trend) drawLine(c2, o.trend.labels, o.trend.values);
    var c3=ensureCanvas("vsp-chart-bytool");   if (c3 && o.bar)   drawBars(c3, o.bar.labels, o.bar.a0, o.bar.a1);
    var c4=ensureCanvas("vsp-chart-topcwe");   if (c4 && o.top)   drawBars(c4, o.top.labels, o.top.values, new Array(o.top.labels.length).fill(0));

    console.log("[VSP][DASH][V6F] rendered rid=", rid);
    return true;
  }

  function start(){
    var tries=0;
    var t=setInterval(function(){
      tries++;
      renderOnce().then(function(ok){
        if (ok || tries>=80){
          clearInterval(t);
          if (!ok) console.warn("[VSP][DASH][V6F] gave up (rid still not ready)");
        }
      }).catch(function(e){
        if (tries>=80){ clearInterval(t); console.warn("[VSP][DASH][V6F] error", e); }
      });
    }, 500);
  }

  if (document.readyState==="complete") start();
  else window.addEventListener("load", start);
})();


/* ===== VSP_P1_DASH_RENDER_STABLE_V1 (NO Chart.js) ===== */
(function(){
  const LOGP = "[VSP][DASH][STABLE_V1]";
  const $ = (id)=>document.getElementById(id);
  const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
  const now = ()=>Date.now();

  function onReady(fn){
    if (document.readyState === "complete" || document.readyState === "interactive") return fn();
    document.addEventListener("DOMContentLoaded", fn, {once:true});
  }

  async function fetchJSON(url){
    const u = url + (url.includes("?") ? "&" : "?") + "_=" + now();
    const r = await fetch(u, {cache:"no-store", credentials:"same-origin"});
    const t = await r.text();
    try { return JSON.parse(t); } catch(e){
      console.warn(LOGP, "bad json from", u, "len=", (t||"").length);
      throw e;
    }
  }

  function fitCanvas(canvas, w, h){
    const dpr = window.devicePixelRatio || 1;
    canvas.width  = Math.max(10, Math.floor(w * dpr));
    canvas.height = Math.max(10, Math.floor(h * dpr));
    canvas.style.width  = Math.max(10, Math.floor(w)) + "px";
    canvas.style.height = Math.max(10, Math.floor(h)) + "px";
    const ctx = canvas.getContext("2d");
    ctx.setTransform(dpr,0,0,dpr,0,0);
    return ctx;
  }

  function ensureCanvasIn(containerId, minH){
    const box = $(containerId);
    if (!box) return null;
    box.textContent = ""; // clear placeholder
    const c = document.createElement("canvas");
    c.setAttribute("aria-label", containerId);
    c.style.display = "block";
    c.style.width = "100%";
    c.style.height = (minH||220) + "px";
    box.appendChild(c);

    const w = box.clientWidth || 800;
    const h = Math.max(minH||220, box.clientHeight || 0, 200);
    const ctx = fitCanvas(c, w, h);
    return {box, canvas:c, ctx, w, h};
  }

  function drawTextCenter(ctx, w, h, txt){
    ctx.clearRect(0,0,w,h);
    ctx.globalAlpha = 1;
    ctx.font = "13px sans-serif";
    ctx.fillStyle = "rgba(220,230,255,0.75)";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText(txt, w/2, h/2);
  }

  function drawDonut(ctx, w, h, items){
    // items: [{sev,count}]
    const total = items.reduce((a,x)=>a+(+x.count||0),0) || 1;
    const cx=w/2, cy=h/2, r=Math.min(w,h)*0.32;
    const r2=r*0.62;
    let a0 = -Math.PI/2;

    ctx.clearRect(0,0,w,h);
    ctx.lineWidth = 18;
    const palette = [
      "rgba(255,80,80,0.85)",   // CRITICAL
      "rgba(255,160,80,0.85)",  // HIGH
      "rgba(255,220,80,0.85)",  // MEDIUM
      "rgba(160,220,120,0.85)", // LOW
      "rgba(120,180,255,0.85)", // INFO
      "rgba(180,180,200,0.65)"  // TRACE
    ];
    items.forEach((it, i)=>{
      const v = (+it.count||0);
      const a1 = a0 + (v/total)*Math.PI*2;
      ctx.beginPath();
      ctx.strokeStyle = palette[i % palette.length];
      ctx.arc(cx,cy,r,a0,a1,false);
      ctx.stroke();
      a0 = a1;
    });

    // hole
    ctx.globalCompositeOperation = "destination-out";
    ctx.beginPath();
    ctx.arc(cx,cy,r2,0,Math.PI*2);
    ctx.fill();
    ctx.globalCompositeOperation = "source-over";

    // center text
    ctx.font="12px sans-serif";
    ctx.fillStyle="rgba(220,230,255,0.85)";
    ctx.textAlign="center";
    ctx.textBaseline="middle";
    ctx.fillText("TOTAL", cx, cy-8);
    ctx.font="14px sans-serif";
    ctx.fillText(String(total), cx, cy+10);
  }

  function drawBars(ctx, w, h, rows, keyA, keyB){
    // rows: [{tool, critical, high}] -> stacked bar
    ctx.clearRect(0,0,w,h);
    const pad=18, left=80, top=14, bottom=24;
    const innerW = w-left-pad, innerH = h-top-bottom;

    const maxV = Math.max(1, ...rows.map(r=>(+r[keyA]||0)+(+r[keyB]||0)));
    ctx.font="12px sans-serif";
    ctx.textBaseline="middle";

    rows.slice(0,8).forEach((r, idx)=>{
      const y = top + idx*(innerH/8) + (innerH/8)/2;
      const total = (+r[keyA]||0)+(+r[keyB]||0);
      const bw = (total/maxV)*innerW;

      // label
      ctx.fillStyle="rgba(220,230,255,0.75)";
      ctx.textAlign="right";
      ctx.fillText(String(r.tool||"").slice(0,10), left-8, y);

      // bar
      ctx.fillStyle="rgba(255,120,120,0.75)";
      ctx.fillRect(left, y-7, Math.max(2,bw), 14);

      // value
      ctx.textAlign="left";
      ctx.fillStyle="rgba(220,230,255,0.65)";
      ctx.fillText(String(total), left + Math.max(2,bw) + 6, y);
    });
  }

  function drawTopCWE(ctx, w, h, rows){
    // rows: [{cwe,count}]
    ctx.clearRect(0,0,w,h);
    const pad=18, left=90, top=14, bottom=22;
    const innerW=w-left-pad, innerH=h-top-bottom;

    const maxV = Math.max(1, ...rows.map(r=>(+r.count||0)));
    ctx.font="12px sans-serif";
    rows.slice(0,8).forEach((r, idx)=>{
      const y = top + idx*(innerH/8) + 6;
      const bw = ((+r.count||0)/maxV)*innerW;

      ctx.fillStyle="rgba(220,230,255,0.75)";
      ctx.textAlign="right";
      ctx.fillText(String(r.cwe||"").slice(0,14), left-8, y+6);

      ctx.fillStyle="rgba(120,180,255,0.65)";
      ctx.fillRect(left, y, Math.max(2,bw), 12);

      ctx.textAlign="left";
      ctx.fillStyle="rgba(220,230,255,0.6)";
      ctx.fillText(String(+r.count||0), left + Math.max(2,bw) + 6, y+6);
    });
  }

  function drawTrend(ctx, w, h, points){
    // points: [{rid,total_findings}] (càng mới càng phải)
    ctx.clearRect(0,0,w,h);
    const pad=18, left=40, top=14, bottom=28;
    const innerW=w-left-pad, innerH=h-top-bottom;

    const ys = points.map(p=>(+p.total_findings||0));
    const maxY = Math.max(1, ...ys);
    const minY = Math.min(...ys, 0);

    // axes
    ctx.strokeStyle="rgba(220,230,255,0.18)";
    ctx.beginPath();
    ctx.moveTo(left, top);
    ctx.lineTo(left, top+innerH);
    ctx.lineTo(left+innerW, top+innerH);
    ctx.stroke();

    if(points.length < 2){
      drawTextCenter(ctx,w,h,"trend: not enough points");
      return;
    }

    // line
    ctx.strokeStyle="rgba(160,220,120,0.85)";
    ctx.lineWidth=2;
    ctx.beginPath();
    points.forEach((p,i)=>{
      const x = left + (i/(points.length-1))*innerW;
      const yv = (+p.total_findings||0);
      const y = top + innerH - ((yv-minY)/(maxY-minY||1))*innerH;
      if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    });
    ctx.stroke();
  }

  function setText(id, val){
    const el=$(id);
    if(!el) return;
    el.textContent = (val===null || val===undefined) ? "N/A" : String(val);
  }

  function setGate(id, overall){
    const el=$(id);
    if(!el) return;
    const s = String(overall||"").toUpperCase();
    el.textContent = (s || "N/A") + (s==="RED" ? " • Blocking pipeline" : "");
    el.classList.remove("vsp-gate-red","vsp-gate-amber","vsp-gate-green");
    if(s==="RED") el.classList.add("vsp-gate-red");
    else if(s==="AMBER") el.classList.add("vsp-gate-amber");
    else if(s==="GREEN") el.classList.add("vsp-gate-green");
  }

  async function resolveRidLatest(){
    const j = await fetchJSON("/api/vsp/runs?limit=1");
    return (j && (j.rid_latest_gate_root || (j.items && j.items[0] && j.items[0].run_id))) || null;
  }

  async function runOnce(){
    // đảm bảo containers có mặt
    const ids = ["vsp-chart-severity","vsp-chart-trend","vsp-chart-bytool","vsp-chart-topcwe"];
    const miss = ids.filter(x=>!$(x));
    if(miss.length){
      console.warn(LOGP, "missing containers:", miss.join(","));
      return;
    }

    const rid = await resolveRidLatest();
    setText("vsp-header-run-id", rid || "N/A");
    setText("vsp_live_rid", "rid_latest: " + (rid||"N/A"));

    if(!rid){
      console.warn(LOGP, "rid_latest N/A");
      return;
    }

    const kpis = await fetchJSON("/api/vsp/dash_kpis?rid=" + encodeURIComponent(rid));
    const charts = await fetchJSON("/api/vsp/dash_charts?rid=" + encodeURIComponent(rid));

    // KPI mapping
    setText("vsp-kpi-total-findings", kpis.total_findings);
    setText("vsp-kpi-critical", (kpis.counts_total && kpis.counts_total.CRITICAL));
    setText("vsp-kpi-high",     (kpis.counts_total && kpis.counts_total.HIGH));
    setText("vsp-kpi-medium",   (kpis.counts_total && kpis.counts_total.MEDIUM));
    setText("vsp-kpi-low",      (kpis.counts_total && kpis.counts_total.LOW));
    setText("vsp-kpi-score",    kpis.security_score);
    setText("vsp-kpi-top-tool", kpis.top_risky_tool);
    setText("vsp-kpi-top-cwe",  kpis.top_impacted_cwe);
    setText("vsp-kpi-top-module", kpis.top_vulnerable_module);
    setGate("vsp-kpi-ci-gate", kpis.overall);

    // charts
    const sevBox = ensureCanvasIn("vsp-chart-severity", 220);
    if(sevBox) drawDonut(sevBox.ctx, sevBox.w, sevBox.h, (charts.severity_distribution||[]));

    const trBox = ensureCanvasIn("vsp-chart-trend", 220);
    if(trBox) drawTrend(trBox.ctx, trBox.w, trBox.h, (charts.findings_trend||[]));

    const btBox = ensureCanvasIn("vsp-chart-bytool", 220);
    if(btBox) drawBars(btBox.ctx, btBox.w, btBox.h, (charts.critical_high_by_tool||[]), "critical", "high");

    const cweBox = ensureCanvasIn("vsp-chart-topcwe", 220);
    if(cweBox) drawTopCWE(cweBox.ctx, cweBox.w, cweBox.h, (charts.top_cwe_exposure||[]));

    console.log(LOGP, "rendered OK rid=", rid);
  }

  async function runWithRetry(){
    // Retry vài lần vì bundle có thể chạy trước khi DOM layout ổn định
    for(let i=0;i<8;i++){
      try{
        await runOnce();
        return;
      }catch(e){
        console.warn(LOGP, "retry", i, e && e.message ? e.message : e);
        await sleep(250);
      }
    }
    console.warn(LOGP, "gave up after retries");
  }

  onReady(()=>{ setTimeout(runWithRetry, 0); });
})();



/* =======================
   VSP_P1_TABS3_UI_V1
   Data Source + Settings + Rule Overrides
   ======================= */
(() => {
  if (window.__vsp_p1_tabs3_ui_v1) return;
  window.__vsp_p1_tabs3_ui_v1 = true;

  const $ = (sel, root=document) => root.querySelector(sel);
  const esc = (s) => (s==null?'':String(s)).replace(/[&<>"']/g, (c)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]));
  const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));

  function ensureStyle(){
    if (document.getElementById("vsp_tabs3_style_v1")) return;
    const st = document.createElement("style");
    st.id = "vsp_tabs3_style_v1";
    st.textContent = `
      .vsp-card{background:#0f1b2d;border:1px solid rgba(148,163,184,.18);border-radius:14px;padding:14px}
      .vsp-row{display:flex;gap:12px;flex-wrap:wrap}
      .vsp-kpi{min-width:180px}
      .vsp-muted{color:#94a3b8}
      .vsp-btn{background:#111c30;border:1px solid rgba(148,163,184,.22);color:#e5e7eb;border-radius:10px;padding:8px 10px;cursor:pointer}
      .vsp-btn:hover{border-color:rgba(148,163,184,.45)}
      .vsp-in{background:#0b1324;border:1px solid rgba(148,163,184,.22);color:#e5e7eb;border-radius:10px;padding:8px 10px;outline:none}
      .vsp-in:focus{border-color:rgba(59,130,246,.55)}
      table.vsp-t{width:100%;border-collapse:separate;border-spacing:0 8px}
      table.vsp-t th{font-weight:600;text-align:left;color:#cbd5e1;font-size:12px;padding:0 10px}
      table.vsp-t td{background:#0b1324;border-top:1px solid rgba(148,163,184,.18);border-bottom:1px solid rgba(148,163,184,.18);padding:10px;font-size:13px;vertical-align:top}
      table.vsp-t tr td:first-child{border-left:1px solid rgba(148,163,184,.18);border-top-left-radius:12px;border-bottom-left-radius:12px}
      table.vsp-t tr td:last-child{border-right:1px solid rgba(148,163,184,.18);border-top-right-radius:12px;border-bottom-right-radius:12px}
      .vsp-badge{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid rgba(148,163,184,.22);font-size:12px}
      .vsp-pager{display:flex;gap:10px;align-items:center;justify-content:flex-end;margin-top:10px}
      .vsp-code{width:100%;min-height:280px;resize:vertical;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;background:#0b1324;border:1px solid rgba(148,163,184,.22);color:#e5e7eb;border-radius:12px;padding:12px}
      .vsp-ok{color:#86efac}
      .vsp-err{color:#fca5a5}
    `;
    document.head.appendChild(st);
  }

  async function apiJson(url, opt){
    const r = await fetch(url, opt);
    const t = await r.text();
    let j = null;
    try{ j = JSON.parse(t); }catch(_e){ j = { ok:false, err:"non-json", raw:t.slice(0,800) }; }
    if (!r.ok) throw Object.assign(new Error("HTTP "+r.status), {status:r.status, body:j});
    return j;
  }

  function mount(){
    return $("#vsp_tab_root") || document.body;
  }
  function tabName(){
    return (window.__vsp_tab || ($("#vsp_tab_root")?.getAttribute("data-vsp-tab")) || "").trim();
  }

  // ---------------- Data Source ----------------
  function renderCounts(counts){
    const keys = ["TOTAL","CRITICAL","HIGH","MEDIUM","LOW","INFO","TRACE"];
    return keys.map(k=>{
      const v = counts?.[k] ?? 0;
      return `<div class="vsp-card vsp-kpi"><div class="vsp-muted" style="font-size:12px">${k}</div><div style="font-size:22px;font-weight:700;margin-top:6px">${v}</div></div>`;
    }).join("");
  }

  async function renderDataSource(){
    ensureStyle();
    const root = mount();
    root.innerHTML = `
      <div class="vsp-row" style="justify-content:space-between;align-items:center;margin-bottom:12px">
        <div>
          <div style="font-size:18px;font-weight:800">Data Source</div>
          <div class="vsp-muted" style="font-size:12px;margin-top:2px">Table view of findings_unified.json (latest run) with filters & paging</div>
        </div>
        <div class="vsp-row" style="gap:8px">
          <button class="vsp-btn" id="ds_refresh">Refresh</button>
          <button class="vsp-btn" id="ds_dl_json">Download JSON</button>
        </div>
      </div>

      <div class="vsp-row" id="ds_kpis" style="margin-bottom:12px"></div>

      <div class="vsp-card" style="margin-bottom:12px">
        <div class="vsp-row" style="align-items:center">
          <input class="vsp-in" id="ds_q" placeholder="search (tool, rule_id, message, file, cwe)..." style="min-width:260px;flex:1"/>
          <select class="vsp-in" id="ds_sev">
            <option value="">All severities</option>
            <option>CRITICAL</option><option>HIGH</option><option>MEDIUM</option><option>LOW</option><option>INFO</option><option>TRACE</option>
          </select>
          <input class="vsp-in" id="ds_tool" placeholder="tool (exact, e.g. semgrep)" style="min-width:200px"/>
          <select class="vsp-in" id="ds_limit">
            <option value="10">10 / page</option>
            <option value="20" selected>20 / page</option>
            <option value="50">50 / page</option>
          </select>
        </div>
        <div class="vsp-muted" id="ds_meta" style="margin-top:10px;font-size:12px"></div>
      </div>

      <div class="vsp-card">
        <table class="vsp-t">
          <thead>
            <tr>
              <th>Severity</th><th>Tool</th><th>Rule</th><th>File</th><th>Line</th><th>Message</th>
            </tr>
          </thead>
          <tbody id="ds_tbody"></tbody>
        </table>
        <div class="vsp-pager">
          <button class="vsp-btn" id="ds_prev">Prev</button>
          <div class="vsp-muted" id="ds_page">Page 1/1</div>
          <button class="vsp-btn" id="ds_next">Next</button>
        </div>
      </div>
    `;

    let state = { offset:0, limit:20, total:0, last:null };

    const qEl = $("#ds_q"), sevEl=$("#ds_sev"), toolEl=$("#ds_tool"), limEl=$("#ds_limit");
    const kpis = $("#ds_kpis"), tbody=$("#ds_tbody"), meta=$("#ds_meta"), page=$("#ds_page");

    async function load(){
      const q = (qEl.value||"").trim();
      const severity = (sevEl.value||"").trim();
      const tool = (toolEl.value||"").trim();
      const limit = parseInt(limEl.value||"20",10) || 20;
      state.limit = limit;

      const url = `/api/vsp/findings_v1?limit=${encodeURIComponent(limit)}&offset=${encodeURIComponent(state.offset)}&q=${encodeURIComponent(q)}&severity=${encodeURIComponent(severity)}&tool=${encodeURIComponent(tool.toLowerCase())}`;
      const j = await apiJson(url);
      state.total = j.total||0;
      state.last = j;
      kpis.innerHTML = renderCounts(j.counts||{});
      meta.innerHTML = `run_dir: <span class="vsp-muted">${esc(j.run_dir||"")}</span> · total_filtered: <b>${esc(j.total||0)}</b> · limit=${esc(j.limit)} offset=${esc(j.offset)}`;

      const items = j.items||[];
      tbody.innerHTML = items.map(it=>{
        const sev = esc(it.severity||"");
        const tool = esc(it.tool||"");
        const rule = esc(it.rule_id||"");
        const file = esc(it.file||"");
        const line = esc(it.line||"");
        const msg  = esc(it.message||"");
        return `<tr>
          <td><span class="vsp-badge">${sev}</span></td>
          <td>${tool}</td>
          <td>${rule}</td>
          <td style="max-width:360px;word-break:break-word">${file}</td>
          <td>${line}</td>
          <td style="max-width:520px;word-break:break-word">${msg}</td>
        </tr>`;
      }).join("");

      const pages = Math.max(1, Math.ceil((state.total||0)/state.limit));
      const cur = Math.min(pages, Math.floor((state.offset||0)/state.limit)+1);
      page.textContent = `Page ${cur}/${pages}`;
      $("#ds_prev").disabled = (state.offset<=0);
      $("#ds_next").disabled = (state.offset + state.limit >= state.total);
    }

    function debounce(fn, ms=250){
      let t=null;
      return ()=>{ clearTimeout(t); t=setTimeout(fn, ms); };
    }
    const reloadDebounced = debounce(()=>{ state.offset=0; load().catch(e=>console.error(e)); }, 250);

    qEl.addEventListener("input", reloadDebounced);
    sevEl.addEventListener("change", ()=>{ state.offset=0; load().catch(console.error); });
    toolEl.addEventListener("input", reloadDebounced);
    limEl.addEventListener("change", ()=>{ state.offset=0; load().catch(console.error); });

    $("#ds_refresh").onclick = ()=>{ load().catch(console.error); };
    $("#ds_prev").onclick = ()=>{ state.offset = Math.max(0, state.offset - state.limit); load().catch(console.error); };
    $("#ds_next").onclick = ()=>{ state.offset = state.offset + state.limit; load().catch(console.error); };

    $("#ds_dl_json").onclick = ()=>{
      const data = state.last || {};
      const blob = new Blob([JSON.stringify(data, null, 2)], {type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "vsp_findings_v1.json";
      a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href), 1200);
    };

    await load();
  }

  // ---------------- Settings ----------------
  async function renderSettings(){
    ensureStyle();
    const root = mount();
    root.innerHTML = `
      <div class="vsp-row" style="justify-content:space-between;align-items:center;margin-bottom:12px">
        <div>
          <div style="font-size:18px;font-weight:800">Settings</div>
          <div class="vsp-muted" style="font-size:12px;margin-top:2px">Commercial-friendly config JSON (GET/POST)</div>
        </div>
        <div class="vsp-row" style="gap:8px">
          <button class="vsp-btn" id="st_reload">Reload</button>
          <button class="vsp-btn" id="st_save">Save</button>
          <button class="vsp-btn" id="st_dl">Download</button>
        </div>
      </div>

      <div class="vsp-row" style="margin-bottom:12px">
        <div class="vsp-card" style="flex:1;min-width:320px">
          <div class="vsp-muted" style="font-size:12px">Environment</div>
          <pre id="st_env" style="white-space:pre-wrap;margin:10px 0 0 0;font-size:12px;color:#cbd5e1"></pre>
        </div>
        <div class="vsp-card" style="flex:1;min-width:320px">
          <div class="vsp-muted" style="font-size:12px">Storage</div>
          <div id="st_path" class="vsp-muted" style="margin-top:10px;font-size:12px"></div>
          <div id="st_msg" style="margin-top:10px;font-size:12px"></div>
        </div>
      </div>

      <div class="vsp-card">
        <div class="vsp-muted" style="font-size:12px;margin-bottom:8px">settings.json</div>
        <textarea id="st_text" class="vsp-code" spellcheck="false"></textarea>
      </div>
    `;

    const envEl = $("#st_env"), pathEl=$("#st_path"), msgEl=$("#st_msg"), txt=$("#st_text");

    async function load(){
      msgEl.innerHTML = `<span class="vsp-muted">Loading...</span>`;
      const j = await apiJson("/api/vsp/settings_v1");
      envEl.textContent = JSON.stringify(j.env||{}, null, 2);
      pathEl.textContent = `path: ${j.path||""}`;
      txt.value = JSON.stringify(j.settings||{}, null, 2);
      msgEl.innerHTML = `<span class="vsp-ok">OK</span> · ts=${esc(j.ts||"")}`;
      return j;
    }

    async function save(){
      let obj = {};
      try { obj = JSON.parse(txt.value||"{}"); }
      catch(e){ msgEl.innerHTML = `<span class="vsp-err">Invalid JSON:</span> ${esc(e.message||String(e))}`; return; }
      msgEl.innerHTML = `<span class="vsp-muted">Saving...</span>`;
      const j = await apiJson("/api/vsp/settings_v1", {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({settings: obj})
      });
      msgEl.innerHTML = `<span class="vsp-ok">Saved</span> · ${esc(j.path||"")}`;
      return j;
    }

    $("#st_reload").onclick = ()=>load().catch(e=>{ msgEl.innerHTML=`<span class="vsp-err">${esc(e.message||e)}</span>`; });
    $("#st_save").onclick = ()=>save().catch(e=>{ msgEl.innerHTML=`<span class="vsp-err">${esc(e.message||e)}</span>`; });
    $("#st_dl").onclick = ()=>{
      const blob = new Blob([txt.value||"{}"], {type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "vsp_settings.json";
      a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href), 1200);
    };

    await load();
  }

  // ---------------- Rule Overrides ----------------
  async function renderRuleOverrides(){
    ensureStyle();
    const root = mount();
    root.innerHTML = `
      <div class="vsp-row" style="justify-content:space-between;align-items:center;margin-bottom:12px">
        <div>
          <div style="font-size:18px;font-weight:800">Rule Overrides</div>
          <div class="vsp-muted" style="font-size:12px;margin-top:2px">Manage custom overrides (GET/POST) · stored under ui/out_ci/rule_overrides_v1/rules.json</div>
        </div>
        <div class="vsp-row" style="gap:8px">
          <button class="vsp-btn" id="ro_reload">Reload</button>
          <button class="vsp-btn" id="ro_validate">Validate</button>
          <button class="vsp-btn" id="ro_save">Save</button>
          <button class="vsp-btn" id="ro_dl">Download</button>
        </div>
      </div>

      <div class="vsp-row" style="margin-bottom:12px">
        <div class="vsp-card" style="flex:1;min-width:320px">
          <div class="vsp-muted" style="font-size:12px">Quick Schema</div>
          <div class="vsp-muted" style="font-size:12px;margin-top:8px;line-height:1.5">
            Each rule: {"id","tool","rule_id","action","severity","reason","expires"}<br/>
            action examples: "ignore" | "downgrade" | "upgrade"<br/>
            severity override: CRITICAL/HIGH/MEDIUM/LOW/INFO/TRACE
          </div>
        </div>
        <div class="vsp-card" style="flex:1;min-width:320px">
          <div class="vsp-muted" style="font-size:12px">Status</div>
          <div id="ro_path" class="vsp-muted" style="margin-top:10px;font-size:12px"></div>
          <div id="ro_msg" style="margin-top:10px;font-size:12px"></div>
        </div>
      </div>

      <div class="vsp-card">
        <div class="vsp-muted" style="font-size:12px;margin-bottom:8px">rules.json</div>
        <textarea id="ro_text" class="vsp-code" spellcheck="false"></textarea>
      </div>
    `;

    const pathEl=$("#ro_path"), msgEl=$("#ro_msg"), txt=$("#ro_text");

    function normalize(obj){
      // accept list or {rules:[...]}
      if (Array.isArray(obj)) obj = {rules: obj};
      if (!obj || typeof obj !== "object") throw new Error("Root must be object or array");
      if (!Array.isArray(obj.rules)) obj.rules = [];
      // ensure objects
      obj.rules = obj.rules.filter(x=>x && typeof x==="object" && !Array.isArray(x));
      return obj;
    }

    async function load(){
      msgEl.innerHTML = `<span class="vsp-muted">Loading...</span>`;
      const j = await apiJson("/api/vsp/rule_overrides_v1");
      pathEl.textContent = `path: ${j.path||""}`;
      const data = j.data || {rules:[]};
      txt.value = JSON.stringify(data, null, 2);
      msgEl.innerHTML = `<span class="vsp-ok">OK</span> · rules=${esc((data.rules||[]).length)} · ts=${esc(j.ts||"")}`;
    }

    function validate(){
      let obj;
      try { obj = JSON.parse(txt.value||"{}"); obj = normalize(obj); }
      catch(e){ msgEl.innerHTML = `<span class="vsp-err">Invalid:</span> ${esc(e.message||String(e))}`; return null; }
      // light validation
      for (const r of obj.rules){
        if (!("tool" in r) || !("rule_id" in r)){
          msgEl.innerHTML = `<span class="vsp-err">Invalid rule:</span> each rule needs tool + rule_id`; return null;
        }
      }
      msgEl.innerHTML = `<span class="vsp-ok">Valid</span> · rules=${esc(obj.rules.length)}`;
      return obj;
    }

    async function save(){
      const obj = validate();
      if (!obj) return;
      msgEl.innerHTML = `<span class="vsp-muted">Saving...</span>`;
      const j = await apiJson("/api/vsp/rule_overrides_v1", {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({data: obj})
      });
      msgEl.innerHTML = `<span class="vsp-ok">Saved</span> · rules_n=${esc(j.rules_n||"")} · ts=${esc(j.ts||"")}`;
      await sleep(150);
      await load();
    }

    $("#ro_reload").onclick = ()=>load().catch(e=>{ msgEl.innerHTML=`<span class="vsp-err">${esc(e.message||e)}</span>`; });
    $("#ro_validate").onclick = ()=>validate();
    $("#ro_save").onclick = ()=>save().catch(e=>{ msgEl.innerHTML=`<span class="vsp-err">${esc(e.message||e)}</span>`; });
    $("#ro_dl").onclick = ()=>{
      const blob = new Blob([txt.value||"{}"], {type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "vsp_rule_overrides.json";
      a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href), 1200);
    };

    await load();
  }

  // --------------- Router ---------------
  async function boot(){
    const t = tabName() || location.pathname.replace(/^\//,'');
    try{
      if (t.includes("data_source")) return await renderDataSource();
      if (t.includes("settings")) return await renderSettings();
      if (t.includes("rule_overrides")) return await renderRuleOverrides();
    }catch(e){
      console.error(e);
      const root = mount();
      root.innerHTML = `<div class="vsp-card"><div style="font-weight:800">Tab render failed</div><pre style="white-space:pre-wrap;margin-top:10px" class="vsp-muted">${esc(e.message||String(e))}</pre></div>`;
    }
  }

  document.addEventListener("DOMContentLoaded", boot);
})();



/* VSP_P1_DASH_LIVE_KPI_V1 (safe: poll /api/vsp/runs; fetch run_gate.json only for latest; no bulk probing) */
(()=> {
  if (window.__vsp_p1_dash_live_kpi_v1) return;
  window.__vsp_p1_dash_live_kpi_v1 = true;

  function onDash(){
    try {
      const p = (location && location.pathname) ? location.pathname : "";
      // support /vsp5 and /dashboard routes
      return (p === "/vsp5" || p === "/dashboard" || /\/vsp5\/?$/.test(p) || /\/dashboard\/?$/.test(p));
    } catch(e){ return false; }
  }
  if (!onDash()) return;

  const S = { live:true, delay:8000, timer:null, lastRid:"", running:false };

  const now=()=>Date.now();
  const qs=(o)=>Object.keys(o).map(k=>encodeURIComponent(k)+"="+encodeURIComponent(o[k])).join("&");

  function mount(){
    if (document.getElementById("vsp_dash_live_kpi_v1")) return;

    const host =
      document.querySelector("#vsp_tab_dashboard") ||
      document.querySelector("[data-tab='dashboard']") ||
      document.querySelector("main") ||
      document.body;

    const wrap=document.createElement("div");
    wrap.id="vsp_dash_live_kpi_v1";
    wrap.style.cssText=[
      "margin:10px 0 12px 0",
      "padding:10px 12px",
      "border-radius:14px",
      "border:1px solid rgba(255,255,255,0.08)",
      "background:rgba(255,255,255,0.03)",
      "display:flex",
      "gap:10px",
      "align-items:center",
      "flex-wrap:wrap"
    ].join(";");

    wrap.innerHTML = `
      <span style="opacity:.9;font-weight:600">Dashboard Live</span>
      <button id="vsp_dash_live_toggle_v1" style="padding:6px 10px;border-radius:10px;border:1px solid rgba(255,255,255,0.10);background:rgba(255,255,255,0.05);color:inherit;cursor:pointer">Live: ON</button>
      <span id="vsp_dash_live_status_v1" style="opacity:.8;font-size:12px">Last: --</span>
      <span style="opacity:.55">|</span>
      <span id="vsp_dash_live_counts_v1" style="opacity:.92">runs: --</span>
      <span style="opacity:.55">|</span>
      <span id="vsp_dash_live_latest_v1" style="opacity:.92">latest: --</span>
      <button id="vsp_dash_open_gate_json_v1" style="padding:6px 10px;border-radius:10px;border:1px solid rgba(255,255,255,0.10);background:rgba(255,255,255,0.05);color:inherit;cursor:pointer">Open gate JSON</button>
      <button id="vsp_dash_open_html_v1" style="padding:6px 10px;border-radius:10px;border:1px solid rgba(255,255,255,0.10);background:rgba(255,255,255,0.05);color:inherit;cursor:pointer">Open HTML</button>
    `;

    host.insertAdjacentElement("afterbegin", wrap);

    const tgl = document.getElementById("vsp_dash_live_toggle_v1");
    tgl.addEventListener("click", ()=>{
      S.live = !S.live;
      tgl.textContent = S.live ? "Live: ON" : "Live: OFF";
      if (S.live) kick();
    });

    document.getElementById("vsp_dash_open_gate_json_v1").addEventListener("click", ()=>{
      if (!S.lastRid) return;
      window.open(`/api/vsp/run_file_allow?${qs({rid:S.lastRid, path:"run_gate.json"})}`, "_blank");
    });
    document.getElementById("vsp_dash_open_html_v1").addEventListener("click", ()=>{
      if (!S.lastRid) return;
      window.open(`/api/vsp/run_file_allow?${qs({rid:S.lastRid, path:"reports/findings_unified.html", "run_gate_summary.json", "reports/run_gate_summary.json", "reports/run_gate.json"})}`, "_blank");
    });
  }

  function setText(id, t){
    const el=document.getElementById(id);
    if (el) el.textContent=t;
  }

  async function getRuns(){
    const url = `/api/vsp/runs?limit=30&offset=0&_=${now()}`;
    const r = await fetch(url, { cache:"no-store", credentials:"same-origin" });
    if (!r.ok) throw new Error("runs "+r.status);
    return await r.json();
  }

  async function getGate(rid){
    const url = `/api/vsp/run_file_allow?${qs({rid, path:"run_gate.json", _: now()})}`;
    const r = await fetch(url, { cache:"no-store", credentials:"same-origin" });
    if (!r.ok) return null;
    try { return await r.json(); } catch(e){ return null; }
  }

  function normOverall(x){
    const s=(x||"").toString().toUpperCase();
    if (!s) return "UNKNOWN";
    if (["GREEN","PASS","OK"].includes(s)) return "GREEN";
    if (["AMBER","WARN"].includes(s)) return "AMBER";
    if (["RED","FAIL","BLOCK"].includes(s)) return "RED";
    if (["DEGRADED"].includes(s)) return "DEGRADED";
    return s;
  }

  function schedule(ms){
    clearTimeout(S.timer);
    S.timer=setTimeout(()=>tick(), ms);
  }
  function kick(){ schedule(400); }

  async function tick(){
    if (!S.live) return schedule(S.delay);
    if (document.hidden) return schedule(S.delay);
    if (S.running) return schedule(600);
    S.running=true;
    try{
      mount();
      const j = await getRuns();
      const items = (j && j.items) ? j.items : [];
      const total = (typeof j.total === "number") ? j.total : items.length;

      const first = items[0] || null;
      const rid = (first && (first.rid || first.run_id || first.id)) ? (first.rid || first.run_id || first.id).toString() : "";
      if (rid) S.lastRid = rid;

      // counts: prefer item.overall/overall_status if present; else UNKNOWN
      const cnt = {GREEN:0, AMBER:0, RED:0, DEGRADED:0, UNKNOWN:0};
      for (const it of items){
        const ov = normOverall(it.overall || it.overall_status || it.status || "");
        if (cnt[ov] === undefined) cnt.UNKNOWN++;
        else cnt[ov]++;
      }

      // try to get "real" overall for latest via run_gate.json (only 1 file)
      let latestOverall = "UNKNOWN";
      if (rid){
        const gate = await getGate(rid);
        if (gate){
          latestOverall = normOverall(gate.overall || gate.overall_status || "");
        }
      }

      const ts = new Date().toLocaleTimeString();
      setText("vsp_dash_live_status_v1", `Last: ${ts}`);
      setText("vsp_dash_live_counts_v1", `runs: ${total} | G:${cnt.GREEN} A:${cnt.AMBER} R:${cnt.RED} D:${cnt.DEGRADED} U:${cnt.UNKNOWN}`);
      setText("vsp_dash_live_latest_v1", `latest: ${rid || "--"} | overall: ${latestOverall}`);

      schedule(S.delay);
    }catch(e){
      const ts = new Date().toLocaleTimeString();
      setText("vsp_dash_live_status_v1", `Last: ${ts} • err`);
      schedule(Math.min(60000, S.delay*2));
    }finally{
      S.running=false;
    }
  }

  document.addEventListener("visibilitychange", ()=>{ if (!document.hidden && S.live) kick(); });
  kick();
})();


/* VSP_P1_DASH_REAL_KPI_LIVE_V6
   - poll /api/vsp/runs?limit=1 (light)
   - fetch gate via /api/vsp/run_file_allow?rid=RID&path=run_gate.json (fallback summary handled by backend)
   - render KPI strip + by-tool mini table
   - pause when hidden + backoff on errors
*/
(()=> {
  if (window.__vsp_p1_dash_real_kpi_live_v6) return;
  window.__vsp_p1_dash_real_kpi_live_v6 = true;

  function isDash(){
    try{
      const p = (location && location.pathname) ? location.pathname : "";
      return (p === "/vsp5" || p === "/dashboard" || /\/vsp5\/?$/.test(p) || /\/dashboard\/?$/.test(p));
    }catch(e){ return false; }
  }
  if (!isDash()) return;

  const S = {
    live: true,
    baseDelay: 8000,
    delay: 8000,
    maxDelay: 60000,
    backoffN: 0,
    rid: "",
    gate: null,
    running: false,
    timer: null
  };

  const now = ()=> Date.now();
  const qs = (o)=>Object.keys(o).map(k=>encodeURIComponent(k)+"="+encodeURIComponent(o[k])).join("&");

  function el(id){ return document.getElementById(id); }
  function setTxt(id, t){ const e=el(id); if (e) e.textContent = t; }

  function badge(ov){
    const s = (ov||"UNKNOWN").toString().toUpperCase();
    let bg="rgba(255,255,255,0.06)", bd="rgba(255,255,255,0.10)", fg="rgba(255,255,255,0.92)";
    if (s==="GREEN" || s==="OK" || s==="PASS"){ bg="rgba(46, 204, 113, 0.12)"; bd="rgba(46, 204, 113, 0.25)"; }
    else if (s==="AMBER" || s==="WARN"){ bg="rgba(241, 196, 15, 0.12)"; bd="rgba(241, 196, 15, 0.25)"; }
    else if (s==="RED" || s==="FAIL" || s==="BLOCK"){ bg="rgba(231, 76, 60, 0.12)"; bd="rgba(231, 76, 60, 0.25)"; }
    else if (s==="DEGRADED"){ bg="rgba(155, 89, 182, 0.12)"; bd="rgba(155, 89, 182, 0.25)"; }
    return {s, bg, bd, fg};
  }

  function ensureUI(){
    if (el("vsp_dash_kpi_strip_v6")) return;

    const host =
      document.querySelector("#vsp_tab_dashboard") ||
      document.querySelector("[data-tab='dashboard']") ||
      document.querySelector("main") ||
      document.body;

    const wrap = document.createElement("div");
    wrap.id = "vsp_dash_kpi_strip_v6";
    wrap.style.cssText = [
      "margin:12px 0 14px 0",
      "padding:12px 12px",
      "border-radius:16px",
      "border:1px solid rgba(255,255,255,0.10)",
      "background:rgba(255,255,255,0.03)",
      "box-shadow:0 10px 30px rgba(0,0,0,0.20)"
    ].join(";");

    wrap.innerHTML = `
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
        <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
          <span style="font-weight:700;opacity:.92">Dashboard</span>
          <span id="vsp_dash_overall_badge_v6" style="padding:4px 10px;border-radius:999px;border:1px solid rgba(255,255,255,0.10);background:rgba(255,255,255,0.06);font-size:12px;opacity:.95">OVERALL: --</span>
          <span id="vsp_dash_rid_v6" style="font-size:12px;opacity:.82">RID: --</span>
          <span id="vsp_dash_ts_v6" style="font-size:12px;opacity:.72">TS: --</span>
          <span id="vsp_dash_last_v6" style="font-size:12px;opacity:.72">Last: --</span>
        </div>
        <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
          <button id="vsp_dash_live_toggle_v6" style="padding:6px 10px;border-radius:12px;border:1px solid rgba(255,255,255,0.12);background:rgba(255,255,255,0.05);color:inherit;cursor:pointer">Live: ON</button>
          <button id="vsp_dash_refresh_v6" style="padding:6px 10px;border-radius:12px;border:1px solid rgba(255,255,255,0.12);background:rgba(255,255,255,0.05);color:inherit;cursor:pointer">Refresh</button>
          <button id="vsp_dash_open_gate_v6" style="padding:6px 10px;border-radius:12px;border:1px solid rgba(255,255,255,0.12);background:rgba(255,255,255,0.05);color:inherit;cursor:pointer">Open gate JSON</button>
          <button id="vsp_dash_open_html_v6" style="padding:6px 10px;border-radius:12px;border:1px solid rgba(255,255,255,0.12);background:rgba(255,255,255,0.05);color:inherit;cursor:pointer">Open HTML</button>
        </div>
      </div>

      <div style="margin-top:10px;display:grid;grid-template-columns:repeat(6,minmax(120px,1fr));gap:10px">
        ${["TOTAL","HIGH","MEDIUM","LOW","INFO","CRITICAL"].map(k=>`
          <div style="padding:10px 10px;border-radius:14px;border:1px solid rgba(255,255,255,0.08);background:rgba(255,255,255,0.02)">
            <div style="font-size:11px;opacity:.68">${k}</div>
            <div id="vsp_dash_cnt_${k}_v6" style="font-size:20px;font-weight:800;letter-spacing:.2px;margin-top:2px">--</div>
          </div>
        `).join("")}
      </div>

      <div style="margin-top:12px;display:flex;gap:12px;flex-wrap:wrap">
        <div style="flex:1;min-width:300px;padding:10px 10px;border-radius:14px;border:1px solid rgba(255,255,255,0.08);background:rgba(255,255,255,0.02)">
          <div style="font-size:12px;font-weight:700;opacity:.85;margin-bottom:6px">By tool</div>
          <div id="vsp_dash_bytool_v6" style="font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;font-size:12px;opacity:.92">--</div>
        </div>
        <div style="flex:1;min-width:300px;padding:10px 10px;border-radius:14px;border:1px solid rgba(255,255,255,0.08);background:rgba(255,255,255,0.02)">
          <div style="font-size:12px;font-weight:700;opacity:.85;margin-bottom:6px">Notes</div>
          <div id="vsp_dash_notes_v6" style="font-size:12px;opacity:.85;line-height:1.4">
            • Click-only: no bulk probing<br/>
            • Source: run_gate.json (fallback summary)<br/>
            • Severity normalized: CRITICAL/HIGH/MEDIUM/LOW/INFO/TRACE
          </div>
        </div>
      </div>
    `;

    host.insertAdjacentElement("afterbegin", wrap);

    el("vsp_dash_live_toggle_v6").addEventListener("click", ()=>{
      S.live = !S.live;
      el("vsp_dash_live_toggle_v6").textContent = S.live ? "Live: ON" : "Live: OFF";
      if (S.live) kick("toggle_on");
    });
    el("vsp_dash_refresh_v6").addEventListener("click", ()=> kick("manual"));

    el("vsp_dash_open_gate_v6").addEventListener("click", ()=>{
      if (!S.rid) return;
      window.open(`/api/vsp/run_file_allow?${qs({rid:S.rid, path:"run_gate.json"})}`, "_blank");
    });
    el("vsp_dash_open_html_v6").addEventListener("click", ()=>{
      if (!S.rid) return;
      window.open(`/api/vsp/run_file_allow?${qs({rid:S.rid, path:"reports/findings_unified.html"})}`, "_blank");
    });
  }

  async function fetchLatestRid(){
    const url = `/api/vsp/runs?limit=1&offset=0&_=${now()}`;
    const r = await fetch(url, { cache:"no-store", credentials:"same-origin" });
    if (!r.ok) throw new Error("runs "+r.status);
    const j = await r.json();
    const it = (j && j.items && j.items[0]) ? j.items[0] : null;
    if (!it) return "";
    return (it.rid || it.run_id || it.id || "").toString();
  }

  async function fetchGate(rid){
    const url = `/api/vsp/run_file_allow?${qs({rid, path:"run_gate.json", _: now()})}`;
    const r = await fetch(url, { cache:"no-store", credentials:"same-origin" });
    if (!r.ok) return null;
    try { return await r.json(); } catch(e){ return null; }
  }

  function render(g){
    ensureUI();

    const rid = S.rid || "--";
    const ts = (g && (g.ts || g.time || g.generated_at)) ? (g.ts || g.time || g.generated_at) : "--";
    const ov = (g && (g.overall || g.overall_status)) ? (g.overall || g.overall_status) : "UNKNOWN";

    const b = badge(ov);
    const ob = el("vsp_dash_overall_badge_v6");
    if (ob){
      ob.textContent = `OVERALL: ${b.s}`;
      ob.style.background = b.bg;
      ob.style.borderColor = b.bd;
      ob.style.color = b.fg;
    }

    setTxt("vsp_dash_rid_v6", `RID: ${rid}`);
    setTxt("vsp_dash_ts_v6", `TS: ${ts}`);

    const ct = (g && (g.counts_total || g.counts || g.totals)) ? (g.counts_total || g.counts || g.totals) : {};
    const total = (ct.HIGH||0)+(ct.MEDIUM||0)+(ct.LOW||0)+(ct.INFO||0)+(ct.CRITICAL||0)+(ct.TRACE||0);

    setTxt("vsp_dash_cnt_TOTAL_v6", total.toString());
    setTxt("vsp_dash_cnt_HIGH_v6", (ct.HIGH??"--").toString());
    setTxt("vsp_dash_cnt_MEDIUM_v6", (ct.MEDIUM??"--").toString());
    setTxt("vsp_dash_cnt_LOW_v6", (ct.LOW??"--").toString());
    setTxt("vsp_dash_cnt_INFO_v6", (ct.INFO??"--").toString());
    setTxt("vsp_dash_cnt_CRITICAL_v6", (ct.CRITICAL??"--").toString());

    // By-tool mini table (top 10 by HIGH+MEDIUM)
    const bt = (g && g.by_tool) ? g.by_tool : {};
    const rows = Object.keys(bt).map(k=>{
      const x = bt[k] || {};
      const c = x.counts_total || x.counts || {};
      const hi = c.HIGH||0, me=c.MEDIUM||0, lo=c.LOW||0, inf=c.INFO||0, cr=c.CRITICAL||0;
      return {k, hi, me, lo, inf, cr, score: (hi*1000 + me*100 + lo*10 + inf)};
    }).sort((a,b)=>b.score-a.score).slice(0,10);

    const lines = rows.length ? rows.map(r=>{
      const k = (r.k||"").padEnd(10, " ").slice(0,10);
      return `${k}  C:${r.cr}  H:${r.hi}  M:${r.me}  L:${r.lo}  I:${r.inf}`;
    }).join("\n") : "--";

    const btEl = el("vsp_dash_bytool_v6");
    if (btEl){
      btEl.textContent = lines;
      btEl.style.whiteSpace = "pre";
    }
  }

  function schedule(ms){
    clearTimeout(S.timer);
    S.timer = setTimeout(()=>tick("timer"), ms);
  }
  function kick(reason){ schedule(250); }

  async function tick(reason){
    if (!S.live && reason !== "manual") return schedule(S.baseDelay);
    if (document.hidden) return schedule(S.baseDelay);
    if (S.running) return schedule(600);

    S.running = true;
    try{
      ensureUI();

      const rid = await fetchLatestRid();
      const changed = rid && rid !== S.rid;
      if (rid) S.rid = rid;

      let g = S.gate;
      if (changed || !g || reason === "manual"){
        g = await fetchGate(S.rid);
        S.gate = g;
      }

      const last = new Date().toLocaleTimeString();
      setTxt("vsp_dash_last_v6", `Last: ${last}${changed ? " • new RID" : ""}`);

      if (g) render(g);
      try{ if (g && window.__vsp_dash_bind_native_cards_v7_apply) window.__vsp_dash_bind_native_cards_v7_apply(g); }catch(e){}
      /* VSP_P1_DASH_V6_CALL_BIND_V7 */
S.backoffN = 0;
      S.delay = S.baseDelay;
      schedule(S.delay);
    } catch(e){
      S.backoffN += 1;
      S.delay = Math.min(S.maxDelay, Math.max(S.baseDelay, S.baseDelay * (2 ** Math.min(5, S.backoffN))));
      const last = new Date().toLocaleTimeString();
      setTxt("vsp_dash_last_v6", `Last: ${last} • err • backoff ${Math.round(S.delay/1000)}s`);
      schedule(S.delay);
    } finally {
      S.running = false;
    }
  }

  document.addEventListener("visibilitychange", ()=>{ if (!document.hidden && S.live) kick("visible"); });

  // boot
  ensureUI();
  schedule(800);
})();


/* VSP_P1_DASH_BIND_NATIVE_CARDS_V7
   - non-invasive: try to locate existing KPI cards by label text and update values/colors
   - if not found: do nothing (overlay KPI strip remains)
*/
(()=> {
  if (window.__vsp_p1_dash_bind_native_cards_v7) return;
  window.__vsp_p1_dash_bind_native_cards_v7 = true;

  function isDash(){
    try{
      const p = (location && location.pathname) ? location.pathname : "";
      return (p === "/vsp5" || p === "/dashboard" || /\/vsp5\/?$/.test(p) || /\/dashboard\/?$/.test(p));
    }catch(e){ return false; }
  }
  if (!isDash()) return;

  function norm(s){ return (s||"").toString().trim().toUpperCase(); }

  function badgeColors(ov){
    const s = norm(ov) || "UNKNOWN";
    let bg="rgba(255,255,255,0.06)", bd="rgba(255,255,255,0.10)";
    if (s==="GREEN"||s==="OK"||s==="PASS"){ bg="rgba(46,204,113,0.12)"; bd="rgba(46,204,113,0.25)"; }
    else if (s==="AMBER"||s==="WARN"){ bg="rgba(241,196,15,0.12)"; bd="rgba(241,196,15,0.25)"; }
    else if (s==="RED"||s==="FAIL"||s==="BLOCK"){ bg="rgba(231,76,60,0.12)"; bd="rgba(231,76,60,0.25)"; }
    else if (s==="DEGRADED"){ bg="rgba(155,89,182,0.12)"; bd="rgba(155,89,182,0.25)"; }
    return {bg, bd, s};
  }

  // Find a KPI "card" that contains a label text (e.g., HIGH) and has a number element
  function findCardByLabel(label){
    label = norm(label);
    const all = Array.from(document.querySelectorAll("div,section,article"));
    // prefer smaller cards: limit by text length
    for (const el of all){
      const t = norm(el.textContent || "");
      if (!t) continue;
      if (!t.includes(label)) continue;
      // heuristics: must be relatively short and contain digits placeholder
      if (t.length > 120) continue;
      // look for a big-number element inside
      const candidates = Array.from(el.querySelectorAll("div,span,p,h1,h2,h3"))
        .filter(x => /\d|--/.test((x.textContent||"").trim()) && (x.textContent||"").trim().length <= 10);
      if (candidates.length){
        return {card: el, valueEl: candidates.sort((a,b)=> (b.clientHeight||0)-(a.clientHeight||0))[0]};
      }
    }
    return null;
  }

  function setCard(label, val){
    const hit = findCardByLabel(label);
    if (!hit) return false;
    hit.valueEl.textContent = (val===undefined || val===null) ? "--" : String(val);
    return true;
  }

  function setOverall(ov){
    // try badge element first
    const b = badgeColors(ov);
    const nodes = Array.from(document.querySelectorAll("span,div"))
      .filter(x => /OVERALL/i.test(x.textContent||"") && (x.textContent||"").length < 40);
    if (nodes.length){
      const n = nodes[0];
      n.textContent = `OVERALL: ${b.s}`;
      n.style.background = b.bg;
      n.style.border = `1px solid ${b.bd}`;
      n.style.borderRadius = "999px";
      n.style.padding = "4px 10px";
      return true;
    }
    // fallback: overall card
    const hit = findCardByLabel("OVERALL");
    if (hit){
      hit.valueEl.textContent = b.s;
      hit.card.style.background = b.bg;
      hit.card.style.borderColor = b.bd;
      return true;
    }
    return false;
  }

  // Expose binder for the live module (V6) to call if present
  window.__vsp_dash_bind_native_cards_v7_apply = (gate)=>{
    try{
      const ct = (gate && (gate.counts_total || gate.counts || gate.totals)) ? (gate.counts_total || gate.counts || gate.totals) : {};
      const total = (ct.HIGH||0)+(ct.MEDIUM||0)+(ct.LOW||0)+(ct.INFO||0)+(ct.CRITICAL||0)+(ct.TRACE||0);

      // attempt set numbers
      setCard("TOTAL", total);
      setCard("HIGH", ct.HIGH);
      setCard("MEDIUM", ct.MEDIUM);
      setCard("LOW", ct.LOW);
      setCard("INFO", ct.INFO);
      setCard("CRITICAL", ct.CRITICAL);

      setOverall(gate && (gate.overall || gate.overall_status));

      return true;
    }catch(e){
      return false;
    }
  };
})();


/* VSP_P1_DASH_STRIP_FORCE_V6C
   - robust mount: attach near Gate Story, re-attach if DOM replaced
   - live: poll /api/vsp/runs?limit=1 then fetch /api/vsp/run_file_allow rid + run_gate.json (fallback handled)
*/
(()=> {
  if (window.__vsp_p1_dash_strip_force_v6c) return;
  window.__vsp_p1_dash_strip_force_v6c = true;

  function isDash(){
    try{
      const p = (location && location.pathname) ? location.pathname : "";
      return (p === "/vsp5" || p === "/dashboard" || /\/vsp5\/?$/.test(p) || /\/dashboard\/?$/.test(p));
    }catch(e){ return false; }
  }
  if (!isDash()) return;

  const S = { live:true, rid:"", gate:null, running:false, base:8000, delay:8000, max:60000, backoff:0, t:null };

  const now = ()=>Date.now();
  const qs = (o)=>Object.keys(o).map(k=>encodeURIComponent(k)+"="+encodeURIComponent(o[k])).join("&");

  function findGateStoryAnchor(){
    // Try find element that contains "Gate Story"
    const nodes = Array.from(document.querySelectorAll("div,section,header,main"));
    for (const n of nodes){
      const txt = (n.textContent||"").trim();
      if (!txt) continue;
      if (txt.includes("Gate Story")){
        // choose a stable container: go up a bit
        let cur = n;
        for (let i=0;i<4 && cur && cur.parentElement; i++){
          if ((cur.className||"").toString().includes("container")) break;
          cur = cur.parentElement;
        }
        return cur || n;
      }
    }
    // fallback
    return document.querySelector("main") || document.body;
  }

  function ensureStrip(){
    let strip = document.getElementById("vsp_dash_strip_v6c");
    if (strip) return strip;

    const anchor = findGateStoryAnchor();
    strip = document.createElement("div");
    strip.id = "vsp_dash_strip_v6c";
    strip.style.cssText = [
      "margin:12px 0 14px 0",
      "padding:10px 12px",
      "border-radius:16px",
      "border:1px solid rgba(255,255,255,0.10)",
      "background:rgba(255,255,255,0.03)",
      "box-shadow:0 10px 30px rgba(0,0,0,0.20)"
    ].join(";");

    strip.innerHTML = `
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
        <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
          <span style="font-weight:800;opacity:.92">KPI</span>
          <span id="vsp_dash_strip_overall_v6c" style="padding:4px 10px;border-radius:999px;border:1px solid rgba(255,255,255,0.10);background:rgba(255,255,255,0.06);font-size:12px">OVERALL: --</span>
          <span id="vsp_dash_strip_rid_v6c" style="font-size:12px;opacity:.82">RID: --</span>
          <span id="vsp_dash_strip_last_v6c" style="font-size:12px;opacity:.72">Last: --</span>
        </div>
        <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
          <button id="vsp_dash_strip_live_v6c" style="padding:6px 10px;border-radius:12px;border:1px solid rgba(255,255,255,0.12);background:rgba(255,255,255,0.05);color:inherit;cursor:pointer">Live: ON</button>
          <button id="vsp_dash_strip_refresh_v6c" style="padding:6px 10px;border-radius:12px;border:1px solid rgba(255,255,255,0.12);background:rgba(255,255,255,0.05);color:inherit;cursor:pointer">Refresh</button>
          <button id="vsp_dash_strip_open_v6c" style="padding:6px 10px;border-radius:12px;border:1px solid rgba(255,255,255,0.12);background:rgba(255,255,255,0.05);color:inherit;cursor:pointer">Open gate JSON</button>
        </div>
      </div>

      <div style="margin-top:10px;display:grid;grid-template-columns:repeat(6,minmax(110px,1fr));gap:10px">
        ${["TOTAL","HIGH","MEDIUM","LOW","INFO","CRITICAL"].map(k=>`
          <div style="padding:10px 10px;border-radius:14px;border:1px solid rgba(255,255,255,0.08);background:rgba(255,255,255,0.02)">
            <div style="font-size:11px;opacity:.68">${k}</div>
            <div id="vsp_dash_strip_${k}_v6c" style="font-size:18px;font-weight:900;margin-top:2px">--</div>
          </div>
        `).join("")}
      </div>
    `;

    // insert: right BEFORE anchor if possible, else top of body
    try{
      if (anchor && anchor.parentElement){
        anchor.insertAdjacentElement("beforebegin", strip);
      } else {
        (document.body || document.documentElement).insertAdjacentElement("afterbegin", strip);
      }
    } catch(e){
      (document.body || document.documentElement).insertAdjacentElement("afterbegin", strip);
    }

    // events
    document.getElementById("vsp_dash_strip_live_v6c")?.addEventListener("click", ()=>{
      S.live = !S.live;
      document.getElementById("vsp_dash_strip_live_v6c").textContent = S.live ? "Live: ON" : "Live: OFF";
      if (S.live) kick("toggle_on");
    });
    document.getElementById("vsp_dash_strip_refresh_v6c")?.addEventListener("click", ()=>kick("manual"));
    document.getElementById("vsp_dash_strip_open_v6c")?.addEventListener("click", ()=>{
      if (!S.rid) return;
      window.open(`/api/vsp/run_file_allow?${qs({rid:S.rid, path:"run_gate.json"})}`, "_blank");
    });

    return strip;
  }

  function setTxt(id, t){ const e=document.getElementById(id); if(e) e.textContent=t; }

  function styleOverall(ov){
    const s = (ov||"UNKNOWN").toString().toUpperCase();
    const b = document.getElementById("vsp_dash_strip_overall_v6c");
    if (!b) return;
    let bg="rgba(255,255,255,0.06)", bd="rgba(255,255,255,0.10)";
    if (s==="GREEN"||s==="OK"||s==="PASS"){ bg="rgba(46,204,113,0.12)"; bd="rgba(46,204,113,0.25)"; }
    else if (s==="AMBER"||s==="WARN"){ bg="rgba(241,196,15,0.12)"; bd="rgba(241,196,15,0.25)"; }
    else if (s==="RED"||s==="FAIL"||s==="BLOCK"){ bg="rgba(231,76,60,0.12)"; bd="rgba(231,76,60,0.25)"; }
    else if (s==="DEGRADED"){ bg="rgba(155,89,182,0.12)"; bd="rgba(155,89,182,0.25)"; }
    b.textContent = `OVERALL: ${s}`;
    b.style.background = bg;
    b.style.borderColor = bd;
  }

  async function fetchLatestRid(){
    const r = await fetch(`/api/vsp/runs?limit=1&offset=0&_=${now()}`, {cache:"no-store", credentials:"same-origin"});
    if (!r.ok) throw new Error("runs "+r.status);
    const j = await r.json();
    const it = (j && j.items && j.items[0]) ? j.items[0] : null;
    return it ? String(it.rid || it.run_id || "") : "";
  }

  async function fetchGate(rid){
    const r = await fetch(`/api/vsp/run_file_allow?${qs({rid, path:"run_gate.json", _:now()})}`, {cache:"no-store", credentials:"same-origin"});
    if (!r.ok) return null;
    try{ return await r.json(); }catch(e){ return null; }
  }

  function render(g){
    ensureStrip();
    const ct = (g && (g.counts_total||g.counts||g.totals)) ? (g.counts_total||g.counts||g.totals) : {};
    const total = (ct.HIGH||0)+(ct.MEDIUM||0)+(ct.LOW||0)+(ct.INFO||0)+(ct.CRITICAL||0)+(ct.TRACE||0);
    setTxt("vsp_dash_strip_TOTAL_v6c", String(total));
    setTxt("vsp_dash_strip_HIGH_v6c", String(ct.HIGH??"--"));
    setTxt("vsp_dash_strip_MEDIUM_v6c", String(ct.MEDIUM??"--"));
    setTxt("vsp_dash_strip_LOW_v6c", String(ct.LOW??"--"));
    setTxt("vsp_dash_strip_INFO_v6c", String(ct.INFO??"--"));
    setTxt("vsp_dash_strip_CRITICAL_v6c", String(ct.CRITICAL??"--"));
    styleOverall(g && (g.overall||g.overall_status));
  }

  function schedule(ms){ clearTimeout(S.t); S.t=setTimeout(()=>tick("timer"), ms); }
  function kick(){ schedule(200); }

  async function tick(reason){
    ensureStrip(); // also re-attach if missing
    if (!S.live && reason!=="manual") return schedule(S.base);
    if (document.hidden) return schedule(S.base);
    if (S.running) return schedule(600);

    S.running = true;
    try{
      const rid = await fetchLatestRid();
      const changed = rid && rid !== S.rid;
      if (rid) S.rid = rid;
      setTxt("vsp_dash_strip_rid_v6c", `RID: ${S.rid||"--"}`);

      if (changed || !S.gate || reason==="manual"){
        S.gate = await fetchGate(S.rid);
      }
      if (S.gate) render(S.gate);

      setTxt("vsp_dash_strip_last_v6c", `Last: ${new Date().toLocaleTimeString()}${changed ? " • new" : ""}`);
      S.backoff=0; S.delay=S.base;
      schedule(S.delay);
    } catch(e){
      S.backoff += 1;
      S.delay = Math.min(S.max, Math.max(S.base, S.base * (2 ** Math.min(5, S.backoff))));
      setTxt("vsp_dash_strip_last_v6c", `Last: ${new Date().toLocaleTimeString()} • err • backoff ${Math.round(S.delay/1000)}s`);
      schedule(S.delay);
    } finally {
      S.running = false;
    }
  }

  // Re-attach if GateStory re-renders
  const mo = new MutationObserver(()=>{ if (!document.getElementById("vsp_dash_strip_v6c")) ensureStrip(); });
  try{ mo.observe(document.documentElement, {subtree:true, childList:true}); }catch(e){}

  document.addEventListener("visibilitychange", ()=>{ if (!document.hidden && S.live) kick(); });

  // Boot after DOM ready
  if (document.readyState === "loading"){
    document.addEventListener("DOMContentLoaded", ()=>{ ensureStrip(); schedule(800); });
  } else {
    ensureStrip(); schedule(800);
  }
})();


# VSP_P1_ALLOW_GATE_REPORTS_V3
