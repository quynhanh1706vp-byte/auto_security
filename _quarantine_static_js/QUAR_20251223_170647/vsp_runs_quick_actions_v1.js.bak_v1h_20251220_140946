/* VSP_P1_RUNS_QUICK_ACTIONS_V1G (KPI + Pagination + NO 404 spam; autodetect run_file) */
(()=> {
  if (window.__vsp_p1_runs_quick_actions_v1g) return;
  window.__vsp_p1_runs_quick_actions_v1g = true;

  const log = (...a)=>console.log("[RunsQuickV1G]", ...a);
  const warn = (...a)=>console.warn("[RunsQuickV1G]", ...a);

  const API = {
    runs: "/api/vsp/runs",
    exportCsv: "/api/vsp/export_csv",
    exportTgz: "/api/vsp/export_tgz",
    runFile: "/api/vsp/run_file",         // may not exist on this instance
    openFolder: "/api/vsp/open_folder",   // optional
  };

  const qs=(s,r=document)=>r.querySelector(s);
  const el=(t,attrs={},kids=[])=>{
    const n=document.createElement(t);
    for(const [k,v] of Object.entries(attrs||{})){
      if(k==="class") n.className=v;
      else if(k==="html") n.innerHTML=v;
      else if(k.startsWith("on") && typeof v==="function") n.addEventListener(k.slice(2),v);
      else if(v===null || v===undefined) {}
      else n.setAttribute(k,String(v));
    }
    for(const c of kids||[]) n.appendChild(typeof c==="string"?document.createTextNode(c):c);
    return n;
  };

  function injectStyles(){
    const css = `
      .vsp-runsqa-wrap{padding:12px 0 0 0}
      .vsp-runsqa-toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin:10px 0 12px 0}
      .vsp-runsqa-toolbar input,.vsp-runsqa-toolbar select{background:#0f172a;color:#e5e7eb;border:1px solid #24314f;border-radius:10px;padding:8px 10px;outline:none}
      .vsp-runsqa-btn{background:#111827;color:#e5e7eb;border:1px solid #24314f;border-radius:10px;padding:7px 10px;cursor:pointer}
      .vsp-runsqa-btn:hover{filter:brightness(1.08)}
      .vsp-runsqa-btn[disabled]{opacity:.45;cursor:not-allowed}
      .vsp-runsqa-mini{font-size:12px;opacity:.85}
      .vsp-runsqa-table{width:100%;border-collapse:separate;border-spacing:0 8px}
      .vsp-runsqa-row{background:#0b1220;border:1px solid #1f2a44}
      .vsp-runsqa-row td{padding:10px 10px;border-top:1px solid #1f2a44;border-bottom:1px solid #1f2a44;vertical-align:middle}
      .vsp-runsqa-row td:first-child{border-left:1px solid #1f2a44;border-top-left-radius:12px;border-bottom-left-radius:12px}
      .vsp-runsqa-row td:last-child{border-right:1px solid #1f2a44;border-top-right-radius:12px;border-bottom-right-radius:12px}
      .vsp-badge{display:inline-flex;align-items:center;gap:6px;padding:3px 10px;border-radius:999px;border:1px solid #24314f;font-size:12px;white-space:nowrap}
      .vsp-badge.ok{background:#06281b}
      .vsp-badge.amber{background:#2a1c06}
      .vsp-badge.bad{background:#2a0b0b}
      .vsp-badge.dim{opacity:.85}
      .vsp-actions{display:flex;flex-wrap:wrap;gap:6px}
      .vsp-toast{position:fixed;right:16px;bottom:16px;background:#0b1220;border:1px solid #24314f;color:#e5e7eb;padding:10px 12px;border-radius:12px;max-width:560px;box-shadow:0 8px 28px rgba(0,0,0,.35);z-index:99999}
      .vsp-linkbtn{background:transparent;border:0;color:#93c5fd;text-decoration:underline;cursor:pointer;padding:0;margin-left:8px;font-size:12px;opacity:.9}
      .vsp-linkbtn:hover{opacity:1}
      .vsp-legacy-hidden{display:none !important}

      .vsp-kpis{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin:6px 0 10px 0}
      .vsp-kpi{display:flex;gap:8px;align-items:center;border:1px solid #24314f;border-radius:14px;background:#0b1220;padding:8px 10px}
      .vsp-kpi .k{font-size:12px;opacity:.85}
      .vsp-kpi .v{font-size:14px;font-weight:700}
      .vsp-pager{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin:6px 0 10px 0}
      .vsp-pager input{width:84px}
      .vsp-cap{opacity:.8}
    `;
    const st=el("style"); st.textContent=css; document.head.appendChild(st);
  }
  function toast(msg,ms=2200){ const t=el("div",{class:"vsp-toast"},[msg]); document.body.appendChild(t); setTimeout(()=>t.remove(),ms); }

  function pickRid(run){
    return run.run_id || run.rid || run.req_id || run.request_id || run.id || run.RID || run.name || "";
  }

  function deepFindString(obj, re, depth=0){
    if (obj == null || depth > 5) return "";
    if (typeof obj === "string"){
      const m = obj.match(re);
      return m ? m[0] : "";
    }
    if (typeof obj === "number" || typeof obj === "boolean") return "";
    if (Array.isArray(obj)){
      for (const it of obj){
        const v = deepFindString(it, re, depth+1);
        if (v) return v;
      }
      return "";
    }
    if (typeof obj === "object"){
      for (const k of Object.keys(obj)){
        const v = deepFindString(obj[k], re, depth+1);
        if (v) return v;
      }
    }
    return "";
  }

  function normOverall(x){
    const s = String(x||"").toUpperCase();
    const m = s.match(/(GREEN|AMBER|RED|PASS|FAIL|OK|ERROR|WARN(ING)?)/);
    if (!m) return s || "UNKNOWN";
    const t = m[1];
    if (t === "WARN") return "AMBER";
    if (t === "OK") return "GREEN";
    if (t === "ERROR") return "RED";
    return t;
  }

  // ---- run_file autodetect ----
  let runFileMode = null;  // "path" | "file" | null
  let runFileBroken = false;

  function ridParam(rid){ return encodeURIComponent(String(rid||"")); }
  function urlRunFile(rid, relPath){
    if (!runFileMode) {
      // default try "path"
      return `${API.runFile}?rid=${ridParam(rid)}&path=${encodeURIComponent(relPath)}`;
    }
    if (runFileMode === "path") return `${API.runFile}?rid=${ridParam(rid)}&path=${encodeURIComponent(relPath)}`;
    if (runFileMode === "file") return `${API.runFile}?rid=${ridParam(rid)}&file=${encodeURIComponent(relPath)}`;
    return `${API.runFile}?rid=${ridParam(rid)}&path=${encodeURIComponent(relPath)}`;
  }

  async function tryGetJson(url){
    try{
      const r = await fetch(url, {cache:"no-store"});
      if (!r.ok) return {ok:false, status:r.status, data:null};
      const ct = (r.headers.get("content-type")||"").toLowerCase();
      if (ct.includes("application/json")) return {ok:true, status:r.status, data: await r.json()};
      const txt = await r.text();
      try { return {ok:true, status:r.status, data: JSON.parse(txt)}; }
      catch { return {ok:false, status:200, data:null}; }
    }catch(e){
      return {ok:false, status:0, data:null};
    }
  }

  async function detectRunFile(rid){
    if (!rid) return false;

    // Try a file that almost always exists
    const probes = [
      {mode:"path", url: `${API.runFile}?rid=${ridParam(rid)}&path=${encodeURIComponent("run_manifest.json")}`},
      {mode:"file", url: `${API.runFile}?rid=${ridParam(rid)}&file=${encodeURIComponent("run_manifest.json")}`},
      {mode:"path", url: `${API.runFile}?rid=${ridParam(rid)}&path=${encodeURIComponent("run_gate.json")}`},
      {mode:"file", url: `${API.runFile}?rid=${ridParam(rid)}&file=${encodeURIComponent("run_gate.json")}`},
    ];

    for (const p of probes){
      const res = await tryGetJson(p.url);
      if (res.ok){
        runFileMode = p.mode;
        runFileBroken = false;
        log("run_file supported; mode=", runFileMode);
        return true;
      }
      if (res.status === 404){
        // keep trying, but remember 404 evidence
      }
    }

    runFileMode = null;
    runFileBroken = true; // disable resolve to stop 404 spam
    warn("run_file not supported here (404). Disable resolve Overall.");
    return false;
  }

  // ---- Overall cache resolved from run_gate.json (only if run_file supported) ----
  const overallCache = new Map(); // rid -> {overall,degraded,ts}
  const inflight = new Map();     // rid -> Promise
  const MAX_CONC = 4;
  let concNow = 0;
  const queue = [];

  function extractOverallFromGate(g){
    const direct = g?.overall || g?.overall_status || g?.status || g?.result || "";
    let ov = normOverall(direct);
    if (ov === "UNKNOWN"){
      const found = deepFindString(g, /(GREEN|AMBER|RED|PASS|FAIL|OK|ERROR|WARN(ING)?)/i);
      ov = normOverall(found);
    }
    let deg = false;
    try{
      if (g?.by_type && typeof g.by_type === "object"){
        for (const v of Object.values(g.by_type)){
          if (v && typeof v === "object" && v.degraded === true) { deg = true; break; }
        }
      }
      if (g?.degraded === true) deg = true;
      if (g?.any_degraded === true) deg = true;
    }catch(e){}
    return {overall: ov || "UNKNOWN", degraded: !!deg};
  }

  async function fetchRunGateJson(rid){
    const u = urlRunFile(rid, "run_gate.json");
    const res = await tryGetJson(u);
    if (!res.ok){
      if (res.status === 404) runFileBroken = true;
      return null;
    }
    return res.data;
  }

  function scheduleResolve(rid, onDone){
    if (!rid) return;
    if (runFileBroken) return;          // crucial: stop 404 spam
    if (!runFileMode && API.runFile) {  // not detected yet
      // do not resolve until detected (prevents spam)
      return;
    }
    if (overallCache.has(rid)) { onDone?.(overallCache.get(rid)); return; }
    if (inflight.has(rid)) { inflight.get(rid).then(onDone).catch(()=>{}); return; }

    const job = async ()=>{
      const g = await fetchRunGateJson(rid);
      if (!g) {
        overallCache.set(rid, {overall:"UNKNOWN", degraded:false, ts: Date.now()});
        onDone?.(overallCache.get(rid));
        return overallCache.get(rid);
      }
      const x = extractOverallFromGate(g);
      const rec = { ...x, ts: Date.now() };
      overallCache.set(rid, rec);
      onDone?.(rec);
      return rec;
    };

    const runJob = ()=>{
      concNow++;
      const p = job().catch(()=>null).finally(()=>{
        concNow--;
        inflight.delete(rid);
        if (queue.length) queue.shift()();
      });
      inflight.set(rid, p);
      return p;
    };

    if (concNow < MAX_CONC) runJob();
    else queue.push(runJob);
  }

  function pickOverall(run){
    const rid = pickRid(run);
    if (rid && overallCache.has(rid)) return overallCache.get(rid).overall;

    const direct = (run.overall || run.overall_status || run.status || run.result || run.verdict || "");
    if (direct) return normOverall(direct);

    const found = deepFindString(run, /(GREEN|AMBER|RED|PASS|FAIL|OK|ERROR|WARN(ING)?)/i);
    return normOverall(found);
  }

  function pickDegraded(run){
    const rid = pickRid(run);
    if (rid && overallCache.has(rid)) return overallCache.get(rid).degraded;

    const keys = ["degraded","any_degraded","tools_degraded","degraded_tools","is_degraded"];
    for (const k of keys){
      if (typeof run[k] === "boolean") return run[k];
    }
    return false;
  }

  function parseTs(run){
    const raw = run.ts || run.created_at || run.started_at || run.time || run.date || "";
    if (raw){ const d=new Date(raw); if(!isNaN(d.getTime())) return d; }
    const rid=pickRid(run);
    const m=String(rid).match(/(\d{8})_(\d{6})/);
    if(m){
      const y=m[1].slice(0,4), mo=m[1].slice(4,6), da=m[1].slice(6,8);
      const hh=m[2].slice(0,2), mm=m[2].slice(2,4), ss=m[2].slice(4,6);
      const d=new Date(`${y}-${mo}-${da}T${hh}:${mm}:${ss}`); if(!isNaN(d.getTime())) return d;
    }
    return null;
  }
  const pad=n=>String(n).padStart(2,"0");
  function fmtDate(d){ return d?`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`:""; }

  async function fetchRuns(limit=300){
    const r=await fetch(`${API.runs}?limit=${encodeURIComponent(String(limit))}`,{cache:"no-store"});
    if(!r.ok) throw new Error(`runs http ${r.status}`);
    const data=await r.json();
    if(Array.isArray(data)) return data;
    if(Array.isArray(data.items)) return data.items;
    if(Array.isArray(data.runs)) return data.runs;
    return [];
  }

  async function tryPing(u){
    try{
      const r = await fetch(u, {method:"GET", cache:"no-store"});
      return r.ok ? "OK" : `HTTP ${r.status}`;
    }catch(e){ return "ERR"; }
  }
  function openUrl(u){ window.open(u,"_blank","noopener"); }
  function urlCsv(rid){ return `${API.exportCsv}?rid=${ridParam(rid)}`; }
  function urlTgz(rid){ return `${API.exportTgz}?rid=${ridParam(rid)}`; }
  async function go(u, label){
    const st = await tryPing(u);
    if (st !== "OK") toast(`${label}: ${st} (vẫn mở tab để xem)`);
    openUrl(u);
  }
  async function openFolder(rid){
    const u = `${API.openFolder}?rid=${ridParam(rid)}`;
    const st = await tryPing(u);
    if (st !== "OK") return toast(`Open folder: backend chưa hỗ trợ (${st})`);
    toast("Open folder: OK");
  }

  function badgeForOverall(overall){
    const o=String(overall||"UNKNOWN").toUpperCase();
    if (o.includes("GREEN") || o==="OK" || o==="PASS") return el("span",{class:"vsp-badge ok"},[o==="OK"?"GREEN":o]);
    if (o.includes("AMBER") || o.includes("WARN")) return el("span",{class:"vsp-badge amber"},[o.includes("WARN")?"AMBER":o]);
    if (o.includes("RED") || o.includes("FAIL") || o.includes("ERROR")) return el("span",{class:"vsp-badge bad"},[o.includes("ERROR")?"RED":o]);
    return el("span",{class:"vsp-badge dim"},[o||"UNKNOWN"]);
  }

  function hideLegacyExcept(anchor){
    const hidden = [];
    const rx = /(VSP\s*Runs\s*&\s*Reports|Runs\s*&\s*Reports)/i;
    function hideNode(n){
      if (!n || n === document.body) return;
      if (anchor && anchor.contains(n)) return;
      if (n.getAttribute("data-vsp-legacy-hidden")==="1") return;
      n.classList.add("vsp-legacy-hidden");
      n.setAttribute("data-vsp-legacy-hidden","1");
      hidden.push(n);
    }
    const nodes = Array.from(document.querySelectorAll("h1,h2,h3,h4,div,section,main"))
      .filter(n => n && n.textContent && rx.test(n.textContent.trim()))
      .slice(0, 8);
    for (const h of nodes){
      let cur = h;
      for (let i=0;i<10;i++){
        if (!cur || cur===document.body) break;
        if (cur.querySelector && cur.querySelector("table")) { hideNode(cur); break; }
        cur = cur.parentElement;
      }
    }
    window.__vsp_runs_legacy_hidden_nodes = hidden;
    return hidden;
  }
  function toggleLegacy(show){
    const nodes = window.__vsp_runs_legacy_hidden_nodes || [];
    for (const n of nodes){
      if (!n) continue;
      if (show) n.classList.remove("vsp-legacy-hidden");
      else n.classList.add("vsp-legacy-hidden");
    }
  }

  function mount(){
    injectStyles();
    const anchor = qs("#vspRunsQuickActionsV1") || (()=>{ const d=el("div",{id:"vspRunsQuickActionsV1"}); document.body.insertBefore(d, document.body.firstChild); return d; })();
    hideLegacyExcept(anchor);

    let legacyShown = false;
    const ridIn=el("input",{type:"text",placeholder:"Search RID…",style:"min-width:240px"});
    const overallSel=el("select",{},[
      el("option",{value:""},["Overall: ALL"]),
      el("option",{value:"GREEN"},["GREEN"]),
      el("option",{value:"AMBER"},["AMBER"]),
      el("option",{value:"RED"},["RED"]),
      el("option",{value:"UNKNOWN"},["UNKNOWN"]),
    ]);
    const degrSel=el("select",{},[
      el("option",{value:""},["Degraded: ALL"]),
      el("option",{value:"true"},["Degraded: YES"]),
      el("option",{value:"false"},["Degraded: NO"]),
    ]);
    const fromIn=el("input",{type:"date"});
    const toIn=el("input",{type:"date"});

    const pageSizeSel=el("select",{},[
      el("option",{value:"10"},["10/page"]),
      el("option",{value:"20", selected:"selected"},["20/page"]),
      el("option",{value:"50"},["50/page"]),
      el("option",{value:"100"},["100/page"]),
    ]);
    const prevBtn=el("button",{class:"vsp-runsqa-btn"},["Prev"]);
    const nextBtn=el("button",{class:"vsp-runsqa-btn"},["Next"]);
    const pageIn=el("input",{type:"number", min:"1", value:"1"});
    const pageInfo=el("span",{class:"vsp-runsqa-mini"},["1/1"]);

    const refreshBtn=el("button",{class:"vsp-runsqa-btn"},["Refresh"]);
    const resolvePageBtn=el("button",{class:"vsp-runsqa-btn"},["Resolve page"]);
    const resolveTopBtn=el("button",{class:"vsp-runsqa-btn"},["Resolve top 50"]);
    const legacyBtn=el("button",{class:"vsp-runsqa-btn"},["Show legacy"]);
    const clearBtn=el("button",{class:"vsp-runsqa-btn"},["Clear"]);
    const stat=el("span",{class:"vsp-runsqa-mini"},["…"]);

    const cap = el("span",{class:"vsp-runsqa-mini vsp-cap"},["run_file: ?"]);
    legacyBtn.addEventListener("click", ()=>{
      legacyShown = !legacyShown;
      toggleLegacy(legacyShown);
      legacyBtn.textContent = legacyShown ? "Hide legacy" : "Show legacy";
      toast(legacyShown ? "Legacy shown" : "Legacy hidden");
    });

    // KPI
    const mkK = (name)=>({name, v: el("span",{class:"v"},["0"])});
    const kTotal=mkK("Total"), kG=mkK("GREEN"), kA=mkK("AMBER"), kR=mkK("RED"), kU=mkK("UNKNOWN"), kD=mkK("DEGRADED"), kC=mkK("Cache");
    const kpis = el("div",{class:"vsp-kpis"},[
      el("div",{class:"vsp-kpi"},[el("span",{class:"k"},[kTotal.name]), kTotal.v]),
      el("div",{class:"vsp-kpi"},[el("span",{class:"k"},[kG.name]), kG.v]),
      el("div",{class:"vsp-kpi"},[el("span",{class:"k"},[kA.name]), kA.v]),
      el("div",{class:"vsp-kpi"},[el("span",{class:"k"},[kR.name]), kR.v]),
      el("div",{class:"vsp-kpi"},[el("span",{class:"k"},[kU.name]), kU.v]),
      el("div",{class:"vsp-kpi"},[el("span",{class:"k"},[kD.name]), kD.v]),
      el("div",{class:"vsp-kpi"},[el("span",{class:"k"},[kC.name]), kC.v]),
      el("div",{class:"vsp-kpi"},[el("span",{class:"k"},["Capabilities"]), cap]),
    ]);

    const pager = el("div",{class:"vsp-pager"},[
      el("span",{class:"vsp-runsqa-mini"},["Page size"]), pageSizeSel,
      prevBtn, nextBtn,
      el("span",{class:"vsp-runsqa-mini"},["Page"]), pageIn,
      pageInfo,
    ]);

    const wrap=el("div",{class:"vsp-runsqa-wrap"},[
      el("div",{class:"vsp-runsqa-mini"},["Runs & Reports Quick Actions V1G: KPI + pagination. Overall resolve chỉ bật nếu backend có /api/vsp/run_file (autodetect)."]),
      kpis,
      el("div",{class:"vsp-runsqa-toolbar"},[
        ridIn, overallSel, degrSel,
        el("span",{class:"vsp-runsqa-mini"},["From"]), fromIn,
        el("span",{class:"vsp-runsqa-mini"},["To"]), toIn,
        refreshBtn, resolvePageBtn, resolveTopBtn, legacyBtn, clearBtn, stat
      ]),
      pager
    ]);

    const table=el("table",{class:"vsp-runsqa-table"},[
      el("thead",{},[el("tr",{},[
        el("th",{},["RID"]),
        el("th",{},["Date"]),
        el("th",{},["Overall"]),
        el("th",{},["Degraded"]),
        el("th",{},["Actions"]),
      ])]),
      el("tbody",{})
    ]);
    const tbody=table.querySelector("tbody");
    wrap.appendChild(table);
    anchor.appendChild(wrap);

    let runsCache=[];
    let page=1;

    function recomputeKpi(allItems){
      let g=0,a=0,r=0,u=0,d=0;
      for (const run of allItems){
        const ov = String(pickOverall(run)||"UNKNOWN").toUpperCase();
        if (ov.includes("GREEN") || ov==="OK" || ov==="PASS") g++;
        else if (ov.includes("AMBER") || ov.includes("WARN")) a++;
        else if (ov.includes("RED") || ov.includes("FAIL") || ov.includes("ERROR")) r++;
        else u++;
        if (pickDegraded(run)) d++;
      }
      kTotal.v.textContent = String(allItems.length);
      kG.v.textContent = String(g);
      kA.v.textContent = String(a);
      kR.v.textContent = String(r);
      kU.v.textContent = String(u);
      kD.v.textContent = String(d);
      kC.v.textContent = String(overallCache.size);
      cap.textContent = runFileBroken ? "run_file: NO (404)" : (runFileMode ? `run_file: YES (${runFileMode})` : "run_file: ?");
      // disable resolve buttons if broken
      const disabled = runFileBroken || !runFileMode;
      resolvePageBtn.disabled = disabled;
      resolveTopBtn.disabled = disabled;
    }

    function passes(run){
      const rid=pickRid(run);
      const overall=pickOverall(run);
      const degraded=pickDegraded(run);
      const ts=parseTs(run);

      const q=ridIn.value.trim().toLowerCase();
      if(q && !String(rid).toLowerCase().includes(q)) return false;

      const o=overallSel.value.trim().toUpperCase();
      if(o){
        const ov = String(overall||"").toUpperCase();
        if(o==="GREEN" && !ov.includes("GREEN")) return false;
        if(o==="AMBER" && !ov.includes("AMBER")) return false;
        if(o==="RED" && !ov.includes("RED")) return false;
        if(o==="UNKNOWN" && ov!=="UNKNOWN") return false;
      }

      const dsel=degrSel.value;
      if(dsel==="true" && !degraded) return false;
      if(dsel==="false" && degraded) return false;

      const from=fromIn.value ? new Date(fromIn.value+"T00:00:00") : null;
      const to=toIn.value ? new Date(toIn.value+"T23:59:59") : null;
      if((from||to) && ts){
        if(from && ts<from) return false;
        if(to && ts>to) return false;
      }
      return true;
    }

    function getFilteredSorted(){
      return runsCache
        .filter(passes)
        .sort((a,b)=>{
          const ta=parseTs(a), tb=parseTs(b);
          if(ta && tb) return tb.getTime()-ta.getTime();
          if(ta && !tb) return -1;
          if(!ta && tb) return 1;
          return 0;
        });
    }

    function clampPage(p, totalPages){
      if (p < 1) return 1;
      if (p > totalPages) return totalPages;
      return p;
    }

    function render(){
      const itemsAll = getFilteredSorted();
      recomputeKpi(itemsAll);

      const pageSize = parseInt(pageSizeSel.value || "20", 10);
      const totalPages = Math.max(1, Math.ceil(itemsAll.length / pageSize));
      page = clampPage(page, totalPages);
      pageIn.value = String(page);
      pageInfo.textContent = `${page}/${totalPages}`;

      const start = (page-1)*pageSize;
      const items = itemsAll.slice(start, start + pageSize);

      // auto-resolve only if run_file supported
      if (runFileMode && !runFileBroken){
        for (const run of items){
          const rid = pickRid(run);
          if (!rid) continue;
          if (String(pickOverall(run)).toUpperCase() !== "UNKNOWN") continue;
          scheduleResolve(rid, ()=>{ render(); });
        }
      }

      tbody.innerHTML="";
      for(const run of items){
        const rid=pickRid(run);
        const overall=pickOverall(run);
        const degraded=pickDegraded(run);
        const ts=parseTs(run);

        const overallCell = el("td",{},[]);
        overallCell.appendChild(badgeForOverall(overall));
        if (String(overall).toUpperCase()==="UNKNOWN" && rid && runFileMode && !runFileBroken){
          overallCell.appendChild(el("button",{class:"vsp-linkbtn", onclick: ()=>{
            scheduleResolve(rid, ()=>render());
            toast("Resolving overall…");
          }},["resolve"]));
        }

        const ridCell = el("td",{},[
          el("div",{},[String(rid||"(no rid)")]),
          el("div",{class:"vsp-runsqa-mini"},[
            el("button",{class:"vsp-runsqa-btn", onclick: async ()=>{
              try{ await navigator.clipboard.writeText(String(rid||"")); toast("Copied RID"); } catch(e){ toast("Copy failed"); }
            }},["Copy RID"]),
            " ",
            el("button",{class:"vsp-runsqa-btn", onclick: async ()=>openFolder(String(rid||""))},["Open folder"]),
          ])
        ]);

        const actions = el("div",{class:"vsp-actions"},[
          el("button",{class:"vsp-runsqa-btn", onclick: async ()=>go(urlCsv(rid),"CSV")},["CSV"]),
          el("button",{class:"vsp-runsqa-btn", onclick: async ()=>go(urlTgz(rid),"TGZ")},["TGZ"]),
          el("button",{class:"vsp-runsqa-btn", onclick: async ()=>{
            if (!runFileMode || runFileBroken) return toast("Open JSON: run_file không hỗ trợ trên instance này");
            openUrl(urlRunFile(rid, "run_gate.json"));
          }},["Open JSON"]),
          el("button",{class:"vsp-runsqa-btn", onclick: async ()=>{
            if (!runFileMode || runFileBroken) return toast("Open HTML: run_file không hỗ trợ trên instance này");
            openUrl(urlRunFile(rid, "reports/findings_unified.html"));
          }},["Open HTML"]),
        ]);

        const tr = el("tr",{class:"vsp-runsqa-row"},[
          ridCell,
          el("td",{},[fmtDate(ts)||"-"]),
          overallCell,
          el("td",{},[degraded ? el("span",{class:"vsp-badge amber"},["DEGRADED"]) : el("span",{class:"vsp-badge ok"},["OK"])]),
          el("td",{},[actions]),
        ]);
        tbody.appendChild(tr);
      }

      stat.textContent = `Showing ${items.length}/${itemsAll.length} (runs=${runsCache.length}) | cache=${overallCache.size}`;
      prevBtn.disabled = (page<=1);
      nextBtn.disabled = (page>=totalPages);
    }

    prevBtn.addEventListener("click", ()=>{ page = Math.max(1, page-1); render(); });
    nextBtn.addEventListener("click", ()=>{ page = page+1; render(); });
    pageIn.addEventListener("change", ()=>{
      const v = parseInt(pageIn.value||"1",10);
      page = isNaN(v)?1:v;
      render();
    });
    pageSizeSel.addEventListener("change", ()=>{ page=1; render(); });

    async function load(){
      stat.textContent="Loading…";
      try{
        runsCache = await fetchRuns(1200);
        page=1;

        // detect run_file once using the newest run id
        const rid0 = pickRid((runsCache && runsCache[0]) || {});
        if (rid0){
          await detectRunFile(rid0);
        } else {
          runFileBroken = true;
        }

        render();
        log("loaded + running, runs=", runsCache.length);
      }catch(e){
        warn("load failed:", e);
        stat.textContent="Load failed (see console)";
        toast("Load runs failed — check /api/vsp/runs");
      }
    }

    function resolveTopN(n=50){
      if (runFileBroken || !runFileMode) return toast("Resolve disabled: run_file không hỗ trợ");
      const itemsAll = getFilteredSorted();
      const top = itemsAll.slice(0, n);
      for (const run of top){
        const rid = pickRid(run);
        if (!rid) continue;
        if (String(pickOverall(run)).toUpperCase() !== "UNKNOWN") continue;
        scheduleResolve(rid, ()=>render());
      }
      toast(`Resolving top ${n}…`);
    }

    function resolvePage(){
      if (runFileBroken || !runFileMode) return toast("Resolve disabled: run_file không hỗ trợ");
      const itemsAll = getFilteredSorted();
      const pageSize = parseInt(pageSizeSel.value || "20", 10);
      const start = (page-1)*pageSize;
      const items = itemsAll.slice(start, start + pageSize);
      for (const run of items){
        const rid = pickRid(run);
        if (!rid) continue;
        if (String(pickOverall(run)).toUpperCase() !== "UNKNOWN") continue;
        scheduleResolve(rid, ()=>render());
      }
      toast("Resolving this page…");
    }

    resolveTopBtn.addEventListener("click", ()=>resolveTopN(50));
    resolvePageBtn.addEventListener("click", resolvePage);

    [ridIn,overallSel,degrSel,fromIn,toIn].forEach(x=>x.addEventListener("input", ()=>{ page=1; render(); }));
    refreshBtn.addEventListener("click", load);
    clearBtn.addEventListener("click", ()=>{ ridIn.value=""; overallSel.value=""; degrSel.value=""; fromIn.value=""; toIn.value=""; page=1; render(); });

    load();
  }

  if(document.readyState==="loading") document.addEventListener("DOMContentLoaded", mount);
  else mount();
})();
