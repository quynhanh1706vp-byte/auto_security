/* VSP_P0_RID_AUTOFIX_V2_COMMERCIAL */
(()=> {
  try{
    if (window.__vsp_p0_rid_autofix_v2) return;
    window.__vsp_p0_rid_autofix_v2 = true;

    const BASE = "";
    const API_LATEST = (BASE + "/api/vsp/latest_rid");
    const API_RUNS = (BASE + "/api/vsp/runs?limit=20");

    const LS_KEYS = [
      "vsp_selected_rid",
      "vsp_rid",
      "VSP_RID",
      "vsp5_rid",
      "vsp_gate_story_rid"
    ];

    const timeoutFetch = async (url, ms=2500) => {
      const ctrl = new AbortController();
      const t = setTimeout(()=>ctrl.abort(), ms);
      try{
        const r = await fetch(url, {signal: ctrl.signal, credentials: "same-origin"});
        return r;
      } finally {
        clearTimeout(t);
      }
    };

    const fetchJson = async (url, ms=2500) => {
      const r = await timeoutFetch(url, ms);
      if (!r || !r.ok) throw new Error("http_"+(r? r.status : "0"));
      return await r.json();
    };

    const pickRidFromRuns = (j) => {
      // accept many shapes: {runs:[{rid}]} | [{rid}] | {items:[...]} | {data:[...]}
      const arr =
        (Array.isArray(j) ? j :
         (Array.isArray(j?.runs) ? j.runs :
          (Array.isArray(j?.items) ? j.items :
           (Array.isArray(j?.data) ? j.data : null))));
      if (!arr || !arr.length) return "";
      const first = arr[0];
      if (typeof first === "string") return first;
      return String(first?.rid || first?.run_id || first?.id || "");
    };

    const setRid = (rid) => {
      if (!rid) return false;
      try{ window.__VSP_SELECTED_RID = rid; }catch(e){}

      // keep previous (for debugging)
      try{
        const prev = localStorage.getItem("vsp_selected_rid") || "";
        if (prev && prev !== rid) localStorage.setItem("vsp_prev_rid", prev);
      }catch(e){}

      for (const k of LS_KEYS){
        try{ localStorage.setItem(k, rid); }catch(e){}
      }

      // broadcast for any panels
      try{ window.dispatchEvent(new CustomEvent("vsp:rid", {detail:{rid}})); }catch(e){}
      try{ window.dispatchEvent(new CustomEvent("VSP_RID_CHANGED", {detail:{rid}})); }catch(e){}
      try{ window.dispatchEvent(new Event("storage")); }catch(e){}

      // optional hooks if available
      try{
        if (typeof window.vspSetRID === "function") window.vspSetRID(rid);
        if (window.__vsp_gate_story && typeof window.__vsp_gate_story.setRID === "function") window.__vsp_gate_story.setRID(rid);
        if (typeof window.__vsp_gate_story_set_rid === "function") window.__vsp_gate_story_set_rid(rid);
      }catch(e){}

      return true;
    };

    (async ()=> {
      // 1) prefer server resolver
      let rid = "";
      try{
        const j = await fetchJson(API_LATEST, 2000);
        if (j && j.ok && j.rid) rid = String(j.rid);
      }catch(e){}

      // 2) fallback to runs list
      if (!rid){
        try{
          const j = await fetchJson(API_RUNS, 2200);
          rid = pickRidFromRuns(j);
        }catch(e){}
      }

      if (!rid) return;

      // if already set the same, do nothing
      try{
        const cur = localStorage.getItem("vsp_selected_rid") || "";
        if (cur === rid) return;
      }catch(e){}

      setRid(rid);
    })();

  }catch(e){}

    /* VSP_P0_RID_AUTOFIX_POLL_V1 */
    try{
      const POLL_MS = 15000; // commercial-safe: low frequency
      let _last = "";
      try{ _last = localStorage.getItem("vsp_selected_rid") || ""; }catch(e){}
      setInterval(async ()=> {
        try{
          const j = await fetchJson(API_LATEST, 2000);
          const rid2 = (j && j.ok && j.rid) ? String(j.rid) : "";
          if (!rid2) return;
          if (!_last) {
            _last = rid2;
            setRid(rid2);
            return;
          }
          if (rid2 !== _last){
            _last = rid2;
            setRid(rid2);
          }
        }catch(e){}
      }, POLL_MS);
    }catch(e){}

})();
