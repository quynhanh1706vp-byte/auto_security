/* VSP_P2_RUNS_KPI_COMPACT_V3_SAFE (no heavy canvas; DOMReady; single-fetch; layout-safe) */
(()=> {
  if (window.__vsp_runs_kpi_compact_v3_safe) return;
  window.__vsp_runs_kpi_compact_v3_safe = true;

  const $ = (q)=> document.querySelector(q);

  // single-flight + throttle
  let __kpi_inflight = false;
  let __kpi_last_ts = 0;
  let __kpi_last_days = null;

  function setText(id, v){
    const el = document.getElementById(id);
    if (!el) return false;
    el.textContent = (v===null || v===undefined || v==="") ? "—" : String(v);
    return true;
  }

  function hideHeavyCanvases(){
    const c1 = document.getElementById("vsp_runs_kpi_canvas_overall");
    const c2 = document.getElementById("vsp_runs_kpi_canvas_sev");
    const w1 = document.getElementById("vsp_runs_kpi_canvas_wrap_overall") || (c1? c1.parentElement : null);
    const w2 = document.getElementById("vsp_runs_kpi_canvas_wrap_sev") || (c2? c2.parentElement : null);
    if (w1) w1.style.display = "none";
    if (w2) w2.style.display = "none";
  }

  async function fetchKpi(days){
    const now = Date.now();
    const d = String(days || 30);

    if (__kpi_inflight) return null;
    if (__kpi_last_days === d && (now - __kpi_last_ts) < 2500) return null;

    __kpi_inflight = true;
    __kpi_last_days = d;
    __kpi_last_ts = now;

    const q = encodeURIComponent(d);
    const urls = [
      `/api/ui/runs_kpi_v2?days=${q}`,
      `/api/ui/runs_kpi_v1?days=${q}`,
    ];

    const ac = new AbortController();
    const t = setTimeout(()=>{ try{ ac.abort(); }catch(_e){} }, 2500);

    try{
      let lastErr = null;
      for (const u of urls){
        try{
          const r = await fetch(u, {cache:"no-store", signal: ac.signal});
          const j = await r.json();
          if (j && j.ok) return j;
          lastErr = new Error(j?.err || j?.error || "not ok");
        }catch(e){
          lastErr = e;
        }
      }
      throw lastErr || new Error("kpi fetch failed");
    } finally {
      clearTimeout(t);
      __kpi_inflight = false;
    }
  }

  function renderCompactTrend(rootId, labels, seriesMap){
    const root = document.getElementById(rootId);
    if (!root) return;

    if (!labels || !labels.length || !seriesMap || !Object.keys(seriesMap).length){
      root.innerHTML = '<div style="color:#94a3b8;font-size:12px">No trend data</div>';
      return;
    }

    const keys = Object.keys(seriesMap);
    const L = labels.slice(-14);
    const start = Math.max(0, labels.length - 14);

    // compute max stacked
    let max = 1;
    for (let i=start;i<labels.length;i++){
      let sum = 0;
      for (const k of keys) sum += (Number(seriesMap[k]?.[i]||0) || 0);
      if (sum > max) max = sum;
    }

    const rows = L.map((day, idx)=>{
      const i = start + idx;
      let sum = 0;
      let segs = '';
      for (const k of keys){
        const v = (Number(seriesMap[k]?.[i]||0) || 0);
        sum += v;
      }
      // simple bar based on total only (avoid per-key DOM spam)
      const w = Math.max(2, Math.round((sum / max) * 100));
      segs = `<div style="height:10px;border-radius:999px;background:rgba(148,163,184,.22);overflow:hidden">
                <div style="height:10px;width:${w}%;background:rgba(148,163,184,.6)"></div>
              </div>`;
      return `<div style="display:grid;grid-template-columns:92px 1fr 56px;gap:10px;align-items:center;margin:6px 0">
                <div style="color:#94a3b8;font-size:12px">${day}</div>
                ${segs}
                <div style="text-align:right;color:#cbd5e1;font-size:12px">${sum}</div>
              </div>`;
    }).join("");

    root.innerHTML = `<div style="padding:6px 0">${rows}</div>`;
  }

  function applyKpi(j, days){
    // top numbers
    setText("vsp_runs_kpi_total_runs_window", j.total_runs);
    setText("vsp_runs_kpi_GREEN", j.by_overall?.GREEN ?? "—");
    setText("vsp_runs_kpi_AMBER", j.by_overall?.AMBER ?? "—");
    setText("vsp_runs_kpi_RED",   j.by_overall?.RED ?? "—");
    setText("vsp_runs_kpi_UNKNOWN", j.by_overall?.UNKNOWN ?? "—");
    setText("vsp_runs_kpi_findings", j.has_findings ?? "—");
    setText("vsp_runs_kpi_latest", j.latest_rid ?? "—");

    const meta = document.getElementById("vsp_runs_kpi_meta");
    if (meta){
      meta.textContent = `window=${days}d • total=${j.total_runs ?? "—"} • has_gate=${j.has_gate ?? "—"} • ts=${j.ts ?? "—"}`;
    }

    // compact trends (only if API supplies)
    renderCompactTrend("vsp_runs_kpi_trend_overall_compact", j.trend?.labels, j.trend?.overall);
    renderCompactTrend("vsp_runs_kpi_trend_sev_compact", j.trend?.labels, j.trend?.sev);
  }

  async function fillKpi(days){
    hideHeavyCanvases();
    const meta = document.getElementById("vsp_runs_kpi_meta");
    if (meta) meta.textContent = "loading KPI...";
    try{
      const j = await fetchKpi(days);
      if (!j) return; // skipped by throttle/singleflight
      applyKpi(j, days);
    }catch(e){
      if (meta) meta.textContent = `KPI error: ${e?.message || e}`;
      // keep placeholders as "—" (layout-safe)
      renderCompactTrend("vsp_runs_kpi_trend_overall_compact", null, null);
      renderCompactTrend("vsp_runs_kpi_trend_sev_compact", null, null);
    }
  }

  function boot(){
    const sel = $("#vsp_runs_kpi_window_days");
    const btn = $("#vsp_runs_kpi_reload_btn");

    const getDays = ()=> {
      const v = sel ? String(sel.value || "30") : "30";
      const n = parseInt(v, 10);
      return Number.isFinite(n) ? n : 30;
    };

    if (btn){
      btn.addEventListener("click", ()=> fillKpi(getDays()));
    }
    if (sel){
      sel.addEventListener("change", ()=> fillKpi(getDays()));
    }

    // initial
    fillKpi(getDays());
  }

  if (document.readyState === "loading"){
    document.addEventListener("DOMContentLoaded", boot, {once:true});
  } else {
    boot();
  }
})();


/* ===================== VSP_P2_RUNS_KPI_TREND_FROM_RUNS_V1 ===================== */
async function fetchRunsForTrend(limit){
  const u = `/api/vsp/runs?limit=${encodeURIComponent(String(limit||400))}&offset=0`;
  const r = await fetch(u, {cache:"no-store"});
  const j = await r.json();
  // accept: array OR {runs:[...]} OR {items:[...]}
  if (Array.isArray(j)) return j;
  if (j && Array.isArray(j.runs)) return j.runs;
  if (j && Array.isArray(j.items)) return j.items;
  return [];
}

function dateKeyFromRun(x){
  const raw = String((x && (x.date||x.ts||x.time||x.created_at)) || "");
  // try YYYY-MM-DD
  const m = raw.match(/(\d{4}-\d{2}-\d{2})/);
  if (m) return m[1];
  return raw.slice(0,10);
}

function overallFromRun(x){
  const o = (x && (x.overall||x.status||x.result)) || "";
  const v = String(o).toUpperCase();
  if (v.includes("GREEN")) return "GREEN";
  if (v.includes("AMBER")) return "AMBER";
  if (v.includes("RED")) return "RED";
  if (v.includes("UNKNOWN")) return "UNKNOWN";
  return "UNKNOWN";
}

function renderOverallTrendText(rows){
  const root = document.getElementById("vsp_runs_kpi_trend_overall_compact");
  if (!root) return;

  if (!rows || !rows.length){
    root.innerHTML = '<div style="color:#94a3b8;font-size:12px">No trend data</div>';
    return;
  }

  const head = `
    <div style="display:flex;gap:10px;align-items:center;margin-top:8px;margin-bottom:6px">
      <div style="font-weight:700">Overall trend (compact)</div>
      <div style="color:#94a3b8;font-size:12px">(last ${rows.length} days)</div>
    </div>
  `;
  const lines = rows.map(r=>{
    return `
      <div style="display:flex;gap:10px;align-items:center;padding:3px 0;border-top:1px solid rgba(148,163,184,.10)">
        <div style="width:92px;color:#cbd5e1;font-size:12px">${r.day}</div>
        <div style="display:flex;gap:10px;color:#94a3b8;font-size:12px;flex-wrap:wrap">
          <span>G:${r.GREEN}</span><span>A:${r.AMBER}</span><span>R:${r.RED}</span><span>U:${r.UNKNOWN}</span>
        </div>
      </div>
    `;
  }).join("");

  root.innerHTML = head + `<div style="border:1px solid rgba(148,163,184,.10);border-radius:10px;padding:6px 10px;background:rgba(2,6,23,.18)">${lines}</div>`;
}

async function fillOverallTrendFromRuns(days){
  try{
    const runs = await fetchRunsForTrend(500);
    const byDay = {};
    for (const x of runs){
      const d = dateKeyFromRun(x);
      if (!d || d.length < 8) continue;
      const o = overallFromRun(x);
      byDay.setdefault = byDay.setdefault || null; // harmless for old engines
      if (!byDay[d]) byDay[d] = {GREEN:0,AMBER:0,RED:0,UNKNOWN:0};
      byDay[d][o] = (byDay[d][o]||0) + 1;
    }
    const keys = Object.keys(byDay).sort(); // YYYY-MM-DD
    const last = keys.slice(-14).map(k=>({day:k, ...byDay[k]}));
    renderOverallTrendText(last);
  }catch(e){
    const root = document.getElementById("vsp_runs_kpi_trend_overall_compact");
    if (root) root.innerHTML = '<div style="color:#94a3b8;font-size:12px">No trend data</div>';
  }
}

function fillSevTrendPlaceholder(){
  const root = document.getElementById("vsp_runs_kpi_trend_sev_compact");
  if (!root) return;
  root.innerHTML = '<div style="margin-top:10px;color:#94a3b8;font-size:12px">CRITICAL/HIGH trend: pending (will wire from run_gate_summary / unified findings)</div>';
}

/* hook into existing fillKpi() if present */
(function(){
  const _orig = (typeof window.fillKpi === "function") ? window.fillKpi : null;
  if (_orig){
    window.fillKpi = async function(days){
      const r = await _orig(days);
      // fire-and-forget lightweight trend
      fillOverallTrendFromRuns(days||30);
      fillSevTrendPlaceholder();
      return r;
    };
  }else{
    // if fillKpi not global, just run once on DOMReady
    document.addEventListener("DOMContentLoaded", ()=>{
      fillOverallTrendFromRuns(30);
      fillSevTrendPlaceholder();
    });
  }
})();



/* ===================== VSP_P2_RUNS_KPI_OVERALL_TREND_FROM_RUNS_V2 ===================== */
async function __vspFetchRunsForTrend(limit){
  const u = `/api/vsp/runs?limit=${encodeURIComponent(String(limit||500))}&offset=0`;
  const r = await fetch(u, {cache:"no-store"});
  const j = await r.json();
  if (Array.isArray(j)) return j;
  if (j && Array.isArray(j.runs)) return j.runs;
  if (j && Array.isArray(j.items)) return j.items;
  return [];
}

function __vspDateKeyFromAny(x){
  // Prefer explicit date fields
  const raw = String((x && (x.date || x.created_at || x.ts || x.time)) || "");
  const m = raw.match(/(\d{4}-\d{2}-\d{2})/);
  if (m) return m[1];

  // Fallback: parse RID like RUN_YYYYmmdd_HHMMSS
  const rid = String((x && (x.rid || x.run_id || x.id)) || "");
  const m2 = rid.match(/RUN_(\d{4})(\d{2})(\d{2})_/);
  if (m2) return `${m2[1]}-${m2[2]}-${m2[3]}`;

  // Last resort: empty => ignored
  return "";
}

function __vspOverallFromAny(x){
  const v = String((x && (x.overall || x.status || x.result)) || "").toUpperCase();
  if (v.includes("GREEN")) return "GREEN";
  if (v.includes("AMBER")) return "AMBER";
  if (v.includes("RED")) return "RED";
  return "UNKNOWN";
}

function __vspRenderOverallTrendCompact(rows){
  const root = document.getElementById("vsp_runs_kpi_trend_overall_compact");
  if (!root) return;

  if (!rows || !rows.length){
    root.innerHTML = '<div style="color:#94a3b8;font-size:12px">No trend data</div>';
    return;
  }

  const head = `
    <div style="display:flex;gap:10px;align-items:center;margin-top:10px;margin-bottom:6px">
      <div style="font-weight:700">Overall trend (compact)</div>
      <div style="color:#94a3b8;font-size:12px">(last ${rows.length} days)</div>
    </div>
  `;

  const lines = rows.map(r=>{
    return `
      <div style="display:flex;gap:10px;align-items:center;padding:4px 0;border-top:1px solid rgba(148,163,184,.10)">
        <div style="width:92px;color:#cbd5e1;font-size:12px">${r.day}</div>
        <div style="display:flex;gap:12px;color:#94a3b8;font-size:12px;flex-wrap:wrap">
          <span>G:${r.GREEN}</span><span>A:${r.AMBER}</span><span>R:${r.RED}</span><span>U:${r.UNKNOWN}</span>
        </div>
      </div>
    `;
  }).join("");

  root.innerHTML = head + `<div style="border:1px solid rgba(148,163,184,.10);border-radius:10px;padding:6px 10px;background:rgba(2,6,23,.18)">${lines}</div>`;
}

async function __vspFillOverallTrendFromRuns(){
  try{
    const runs = await __vspFetchRunsForTrend(600);
    const byDay = {};
    for (const x of runs){
      const d = __vspDateKeyFromAny(x);
      if (!d) continue;
      const o = __vspOverallFromAny(x);
      if (!byDay[d]) byDay[d] = {GREEN:0,AMBER:0,RED:0,UNKNOWN:0};
      byDay[d][o] = (byDay[d][o]||0) + 1;
    }
    const days = Object.keys(byDay).sort();
    const last = days.slice(-14).map(d=>({day:d, ...byDay[d]}));
    __vspRenderOverallTrendCompact(last);
  }catch(e){
    const root = document.getElementById("vsp_runs_kpi_trend_overall_compact");
    if (root) root.innerHTML = '<div style="color:#94a3b8;font-size:12px">No trend data</div>';
  }
}

// hook: after KPI fills, render trend (super light)
(function(){
  const _orig = (typeof window.fillKpi === "function") ? window.fillKpi : null;
  if (_orig){
    window.fillKpi = async function(days){
      const r = await _orig(days);
      // fire-and-forget
      __vspFillOverallTrendFromRuns();
      return r;
    };
  }else{
    document.addEventListener("DOMContentLoaded", ()=> __vspFillOverallTrendFromRuns());
  }
})();

