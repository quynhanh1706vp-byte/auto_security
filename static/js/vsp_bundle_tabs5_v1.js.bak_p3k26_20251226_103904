/* === VSP_P3K25_URLRID_NO_RIDLATEST_AND_MUTE_TIMEOUT_V1 ===
   Commercial rule:
   - If URL has ?rid= => never call /api/vsp/rid_latest* (use URL rid)
   - Mute only timeout/network noise in Firefox (prevent default unhandledrejection logging)
*/
(function(){
  if (window.__VSP_P3K25_SHIM) return;
  window.__VSP_P3K25_SHIM = 1;

  function _urlRid(){
    try{
      var u = new URL(window.location.href);
      var rid = u.searchParams.get("rid") || "";
      return (rid || "").trim();
    }catch(_){ return ""; }
  }

  function _isNoise(x){
    var m = "";
    try{
      if (!x) m = "";
      else if (typeof x === "string") m = x;
      else if (x.reason) m = String(x.reason);
      else if (x.error) m = String(x.error);
      else if (x.message) m = String(x.message);
      else m = String(x);
    }catch(_){ m = ""; }
    m = (m || "").toLowerCase();
    return (
      m.indexOf("timeout") >= 0 ||
      m.indexOf("networkerror") >= 0 ||
      m.indexOf("failed to fetch") >= 0 ||
      m.indexOf("ns_binding_aborted") >= 0 ||
      m.indexOf("connection") >= 0
    );
  }

  window.addEventListener("unhandledrejection", function(ev){
    if (_isNoise(ev)) { try{ ev.preventDefault(); }catch(_){} }
  });

  // fetch shim: if URL rid exists, short-circuit rid_latest calls
  var rid = _urlRid();
  if (!rid) return;

  var _origFetch = window.fetch;
  if (typeof _origFetch === "function" && !window.__VSP_P3K25_FETCH_WRAP){
    window.__VSP_P3K25_FETCH_WRAP = 1;
    window.fetch = function(input, init){
      try{
        var url = (typeof input === "string") ? input : (input && input.url) ? input.url : "";
        url = String(url || "");
        if (url.indexOf("/api/vsp/rid_latest") >= 0 || url.indexOf("/api/vsp/rid_latest_gate_root") >= 0){
          var body = JSON.stringify({ok:true, rid: rid, mode:"url_rid"});
          return Promise.resolve(new Response(body, {status:200, headers: {"Content-Type":"application/json"}}));
        }
      }catch(_){}
      return _origFetch.apply(this, arguments);
    };
  }
})();\n

/* === VSP_P3K24_MIN_COMMERCIAL_SAFE_V1 ===
   Rules:
   - If URL has ?rid= => do NOT call /api/vsp/rid_latest* (return url rid immediately)
   - Swallow Firefox noise: timeout / NetworkError / AbortError / NS_BINDING_ABORTED
   - Never throw "timeout" to console as unhandled rejection
*/
(function(){
  try{
    if (window.__VSP_P3K24_SAFE__) return;
    window.__VSP_P3K24_SAFE__ = true;

    function _urlRid(){
      try{
        const sp = new URLSearchParams(location.search || "");
        return (sp.get("rid") || "").trim();
      }catch(e){ return ""; }
    }

    const RID_URL = _urlRid();
    if (RID_URL) {
      window.__VSP_RID_URL__ = RID_URL;
      window.__VSP_AUTORID_DISABLED__ = true;
    }

    function _msg(x){
      try{
        if (typeof x === "string") return x;
        if (!x) return "";
        return (x.message || x.toString || "").toString();
      }catch(e){ return ""; }
    }

    function _isNoise(reason){
      const m = _msg(reason);
      return /timeout|networkerror|aborterror|ns_binding_aborted/i.test(m);
    }

    // 1) Stop "Uncaught (in promise) timeout" from poisoning console
    window.addEventListener("unhandledrejection", function(ev){
      try{
        if (ev && _isNoise(ev.reason)) {
          ev.preventDefault && ev.preventDefault();
        }
      }catch(e){}
    }, true);

    // 2) If rid is in URL, short-circuit fetch() calls to rid_latest endpoints
    if (RID_URL && typeof window.fetch === "function") {
      const _fetch = window.fetch.bind(window);
      window.fetch = function(input, init){
        try{
          const url = (typeof input === "string") ? input : (input && input.url) ? input.url : "";
          if (/\/api\/vsp\/rid_latest(_v3|_gate_root)?(\?|$)/.test(String(url))) {
            const body = JSON.stringify({ok:true, rid: RID_URL, mode:"url"});
            return Promise.resolve(new Response(body, {status:200, headers: {"Content-Type":"application/json; charset=utf-8","Cache-Control":"no-store"}}));
          }
        }catch(e){}
        return _fetch(input, init);
      };
    }

    // 3) Utility for other scripts
    window.__VSP_SAFE_WRAP_PROMISE__ = function(p){
      try{
        return Promise.resolve(p).catch(function(e){
          if (_isNoise(e)) return null;
          throw e;
        });
      }catch(e){ return Promise.resolve(null); }
    };

  }catch(e){}
})();

/* === VSP_P3K21_TABS5_HARD_COMMERCIAL_SAFE_SHIM_V1 ===
   Goals (commercial-safe, Firefox-safe):
   - If ?rid= exists => DO NOT call /api/vsp/rid_latest* (return URL rid immediately)
   - Swallow "timeout"/NetworkError unhandled promise rejections (no red console)
   - Scrub banner text "Dashboard error: timeout" even if set later (MutationObserver)
   - Allow debug bypass: add ?debug_ui=1
*/
(function(){
  try{
    if (window.__VSP_P3K21__) return;
    window.__VSP_P3K21__ = true;

    const usp = new URLSearchParams(location.search || "");
    const lockedRid = (usp.get("rid") || "").trim();
    const debug = (usp.get("debug_ui") === "1");

    if (lockedRid) window.__VSP_RID_LOCKED__ = lockedRid;

    // 1) Global swallow: timeout / networkerror / aborted
    function _isSoftErr(x){
      const msg = String((x && (x.message || x.reason || x)) || "").toLowerCase();
      return msg.includes("timeout") || msg.includes("networkerror") || msg.includes("ns_binding_aborted");
    }
    window.addEventListener("unhandledrejection", function(e){
      try{
        if (!debug && _isSoftErr(e && e.reason)) { e.preventDefault(); return; }
      }catch(_){}
    });
    window.addEventListener("error", function(e){
      try{
        if (!debug && _isSoftErr(e && e.error)) { e.preventDefault(); return; }
      }catch(_){}
    });

    // 2) Scrub banner "Dashboard error: timeout" (set muộn cũng dọn)
    const BAD = "dashboard error: timeout";
    function scrub(root){
      try{
        const nodes = (root && root.querySelectorAll) ? root.querySelectorAll("div,span,p,small,em,strong") : [];
        for (let i=0;i<nodes.length;i++){
          const el = nodes[i];
          const t = (el && el.textContent ? el.textContent.trim().toLowerCase() : "");
          if (t === BAD){
            el.textContent = "";
            el.style.display = "none";
            el.setAttribute("data-vsp-scrubbed", "1");
          }
        }
      }catch(_){}
    }
    const mo = new MutationObserver(function(muts){
      if (debug) return;
      for (const m of muts){
        if (m && m.target && m.target.nodeType === 1) scrub(m.target);
        if (m && m.addedNodes){
          for (const n of m.addedNodes){
            if (n && n.nodeType === 1) scrub(n);
          }
        }
      }
    });
    try{
      mo.observe(document.documentElement || document.body, {subtree:true, childList:true, characterData:true});
      window.addEventListener("DOMContentLoaded", function(){ scrub(document); });
      setTimeout(function(){ scrub(document); }, 1200);
      setTimeout(function(){ scrub(document); }, 3500);
    }catch(_){}

    // 3) fetch shim: if lockedRid, short-circuit rid_latest endpoints
    if (!debug && typeof window.fetch === "function"){
      const _fetch = window.fetch.bind(window);
      window.fetch = function(input, init){
        try{
          const url = (typeof input === "string") ? input : (input && input.url) ? input.url : "";
          if (lockedRid && url && url.indexOf("/api/vsp/rid_latest") !== -1){
            const body = JSON.stringify({ok:true, rid: lockedRid, mode:"url_rid"});
            return Promise.resolve(new Response(body, {status:200, headers: {"Content-Type":"application/json"}}));
          }
        }catch(_){}
        return _fetch(input, init);
      };
    }

    // 4) XHR shim: rewrite rid_latest -> rid_latest_v3?rid=lockedRid (no abort => no NS_BINDING_ABORTED)
    if (!debug && lockedRid && window.XMLHttpRequest && window.XMLHttpRequest.prototype){
      const _open = window.XMLHttpRequest.prototype.open;
      window.XMLHttpRequest.prototype.open = function(method, url){
        try{
          const u = String(url || "");
          if (u.indexOf("/api/vsp/rid_latest") !== -1){
            const nu = "/api/vsp/rid_latest_v3?rid=" + encodeURIComponent(lockedRid) + "&mode=url_rid";
            return _open.call(this, method, nu, true);
          }
        }catch(_){}
        return _open.apply(this, arguments);
      };
    }

  }catch(_){}
})();

/* === VSP_P3K20_FETCHSHIM_URLRID_AND_HIDE_TIMEOUT_BANNER_V1 ===
   Goal (commercial-safe):
   - If URL already has ?rid=... then:
     (1) Intercept fetch() for /api/vsp/rid_latest*, /api/vsp/rid_latest_gate_root
         and return the same rid immediately (no timeout, no abort).
     (2) Swallow unhandledrejection for timeout/network style failures.
     (3) Hide any "Dashboard error: timeout" banner if it appears.
*/
(function(){
  try{
    if (window.__VSP_P3K20__) return;
    window.__VSP_P3K20__ = true;

    const sp = new URLSearchParams(location.search || "");
    const urlRid = (sp.get("rid") || "").trim();

    function _hideTimeoutBanner(){
      try{
        const nodes = [];
        const ids = ["vsp-dashboard-error","dashboard-error","vspError","vsp-error","dash-error"];
        for (const id of ids){
          const el = document.getElementById(id);
          if (el) nodes.push(el);
        }
        document.querySelectorAll(".vsp-banner,.vsp-toast,.alert,.notice,.msg,.status,.note").forEach(el=>nodes.push(el));
        // Light scan (avoid heavy DOM walk)
        document.querySelectorAll("div,span,p").forEach((el, idx)=>{ if (idx < 180) nodes.push(el); });

        for (const el of nodes){
          if (!el || !el.textContent) continue;
          const t = (el.textContent || "").trim();
          if (/dashboard\s*error/i.test(t) && /timeout/i.test(t)) {
            el.textContent = "";
            el.style.display = "none";
          }
        }
      }catch(_e){}
    }

    window.addEventListener("DOMContentLoaded", ()=>{
      _hideTimeoutBanner();
      setTimeout(_hideTimeoutBanner, 700);
      setTimeout(_hideTimeoutBanner, 2500);
    });

    window.addEventListener("unhandledrejection", (e)=>{
      try{
        const r = e && e.reason;
        const msg = String((r && (r.message || r)) || "").toLowerCase();
        if (msg.includes("timeout") || msg.includes("networkerror") || msg.includes("failed to fetch")) {
          e.preventDefault();
          _hideTimeoutBanner();
          return;
        }
      }catch(_e){}
    });

    if (!urlRid) return;
    if (!window.fetch) return;

    const realFetch = window.fetch.bind(window);
    function shouldIntercept(u){
      if (!u) return false;
      return (
        u.includes("/api/vsp/rid_latest") ||
        u.includes("/api/vsp/rid_latest_v3") ||
        u.includes("/api/vsp/rid_latest_gate_root")
      );
    }

    window.fetch = function(input, init){
      try{
        const u = (typeof input === "string") ? input : (input && input.url) || "";
        if (shouldIntercept(u)) {
          const body = JSON.stringify({ ok:true, rid:urlRid, mode:"url_rid" });
          const headers = new Headers({
            "Content-Type": "application/json; charset=utf-8",
            "Cache-Control": "no-store"
          });
          return Promise.resolve(new Response(body, { status: 200, headers }));
        }
      }catch(_e){}
      return realFetch(input, init);
    };
  }catch(_e){}
})();


/* === VSP_P3K18_MUTE_DASHBOARD_TIMEOUT_LABEL_V1 === */

/* === VSP_P3K17_TABS5_GUARD_XHR_RIDLATEST_AND_SWALLOW_TIMEOUT_V1 ===
   Fix remaining Firefox issues:
   - rid_latest calls may use XHR (XMLHttpRequest), not fetch()
   - swallow "timeout" errors globally (error + unhandledrejection)
   - if ?rid= exists => always answer rid_latest* from URL (commercial safe)
=== */
(function(){
  function _isTimeoutMsg(m){
    try {
      m = (m && (m.message || (''+m))) || '';
      return (m === 'timeout') || (/\btimeout\b/i.test(m));
    } catch(_){ return false; }
  }

  try {
    window.addEventListener('unhandledrejection', function(e){
      try { if (_isTimeoutMsg(e && e.reason)) e.preventDefault(); } catch(_){}
    });
  } catch(_){}

  try {
    window.addEventListener('error', function(e){
      try {
        var msg = (e && (e.message || (''+e.error))) || '';
        if (_isTimeoutMsg(msg)) e.preventDefault();
      } catch(_){}
    }, true);
  } catch(_){}

  try {
    var qs = new URLSearchParams((location && location.search) || "");
    var rid = qs.get("rid") || "";
    if (!rid) return;

    function _ridJson(){
      return JSON.stringify({ok:true, rid: rid, mode:'from_url'})
    }

    function _match(url){
      url = String(url||'');
      return (
        url.indexOf('/api/vsp/rid_latest') !== -1 ||
        url.indexOf('/api/vsp/rid_latest_v3') !== -1 ||
        url.indexOf('/api/vsp/rid_latest_gate_root') !== -1
      );
    }

    // Patch XHR
    var OrigXHR = window.XMLHttpRequest;
    if (OrigXHR && !window.__VSP_XHR_PATCHED_RIDLATEST__) {
      window.__VSP_XHR_PATCHED_RIDLATEST__ = true;

      function PatchedXHR(){
        var xhr = new OrigXHR();
        var _url = "";

        var _open = xhr.open;
        var _send = xhr.send;

        xhr.open = function(method, url){
          _url = String(url||"");
          return _open.apply(xhr, arguments);
        };

        xhr.send = function(body){
          try {
            if (_match(_url)) {
              var resp = _ridJson();
              // simulate async success without real network
              setTimeout(function(){
                try {
                  Object.defineProperty(xhr, "readyState", {value:4, configurable:true});
                  Object.defineProperty(xhr, "status", {value:200, configurable:true});
                  Object.defineProperty(xhr, "responseText", {value:resp, configurable:true});
                  Object.defineProperty(xhr, "response", {value:resp, configurable:true});
                } catch(_) {
                  try { xhr.readyState=4; xhr.status=200; xhr.responseText=resp; xhr.response=resp; } catch(__){}
                }

                try { xhr.onreadystatechange && xhr.onreadystatechange(); } catch(_){}
                try { xhr.onload && xhr.onload(); } catch(_){}
                try { xhr.onloadend && xhr.onloadend(); } catch(_){}
              }, 0);
              return;
            }
          } catch(_){}
          return _send.apply(xhr, arguments);
        };

        return xhr;
      }

      // keep constants if someone uses them
      for (var k in OrigXHR) {
        try { PatchedXHR[k] = OrigXHR[k]; } catch(_){}
      }
      try { PatchedXHR.prototype = OrigXHR.prototype; } catch(_){}

      window.XMLHttpRequest = PatchedXHR;
    }
  } catch(_){}
})();

/* === VSP_P3K16_TABS5_GUARD_RIDLATEST_AND_SWALLOW_TIMEOUT_V1 ===
   Goal: commercial-safe dashboard
   - prefer rid from URL (?rid=)
   - short-circuit /api/vsp/rid_latest* calls using rid from URL (avoid timeout/abort)
   - swallow unhandledrejection 'timeout' to avoid console spam
=== */
(function(){
  try {
    window.addEventListener('unhandledrejection', function(e){
      try {
        var r = e && e.reason;
        var msg = (r && (r.message || (''+r))) || '';
        if (msg === 'timeout' || /timeout/i.test(msg)) { e.preventDefault(); return; }
      } catch(_){}
    });
  } catch(_){}

  try {
    var qs = new URLSearchParams((location && location.search) || "");
    var rid = qs.get("rid") || "";
    if (rid) {
      // publish common globals (best-effort)
      window.__VSP_RID__ = rid;
      window.__VSP_RID_CURRENT__ = rid;
      window.__VSP_RID_LATEST__ = rid;
      window.__VSP_SKIP_RID_LATEST__ = true;

      // fetch short-circuit: rid_latest, rid_latest_v3, rid_latest_gate_root
      var _fetch = window.fetch ? window.fetch.bind(window) : null;
      if (_fetch && !window.__VSP_FETCH_PATCHED_RIDLATEST__) {
        window.__VSP_FETCH_PATCHED_RIDLATEST__ = true;
        window.fetch = function(input, init){
          try {
            var url = (typeof input === 'string') ? input : (input && input.url) ? input.url : '';
            if (url && url.indexOf('/api/vsp/rid_latest') !== -1) {
              var body = JSON.stringify({ok:true, rid: rid, mode:'from_url'});
              return Promise.resolve(new Response(body, {
                status: 200,
                headers: {'Content-Type':'application/json; charset=utf-8','Cache-Control':'no-store'}
              }));
            }
            if (url && url.indexOf('/api/vsp/rid_latest_v3') !== -1) {
              var body2 = JSON.stringify({ok:true, rid: rid, mode:'from_url'});
              return Promise.resolve(new Response(body2, {
                status: 200,
                headers: {'Content-Type':'application/json; charset=utf-8','Cache-Control':'no-store'}
              }));
            }
            if (url && url.indexOf('/api/vsp/rid_latest_gate_root') !== -1) {
              var body3 = JSON.stringify({ok:true, rid: rid, mode:'from_url'});
              return Promise.resolve(new Response(body3, {
                status: 200,
                headers: {'Content-Type':'application/json; charset=utf-8','Cache-Control':'no-store'}
              }));
            }
          } catch(_){}
          return _fetch(input, init);
        };
      }
    }
  } catch(e) {
    // do nothing
  }
})();


/* === VSP_P3K13D_KILL_P2BADGES_TIMEOUT_LOGS_V1 === */
(function(){
  try{
    function _join(args){
      try{ return Array.prototype.slice.call(args).map(x=>String(x)).join(" "); }catch(e){ return ""; }
    }
    function wrap(m){
      const _orig = console[m];
      if (typeof _orig !== "function") return;
      console[m] = function(){
        try{
          const msg = _join(arguments);
          if (msg.includes("[P2Badges]") && msg.includes("rid_latest") && msg.includes("timeout")) return;
          if (msg.includes("rid_latest fetch fail timeout")) return;
          if (msg.includes("")) return;
        }catch(e){}
        return _orig.apply(console, arguments);
      };
    }
    ["log","info","warn","error","debug"].forEach(wrap);
  }catch(e){}
})();

/* === VSP_P3K13C_SILENCE_P2BADGES_WARN_V1 === */
(function(){
  try{
    const _w = console.warn;
    console.warn = function(){
      try{
        const a0 = arguments && arguments.length ? arguments[0] : "";
        const msg = String(a0 || "");
        if (msg.includes("[P2Badges]") && msg.includes("rid_latest") && msg.includes("timeout")) return;
      }catch(e){}
      return _w.apply(console, arguments);
    };
  }catch(e){}
})();

// VSP_P3K13B_TABS5_SILENCE_P2BADGES_TIMEOUT_V1
// VSP_P3K12_V2_TABS5
// VSP_P3K12_TABS5_TIMEOUTS_FAILSOFT_V1
// VSP_P3K7B_P2BADGES_TIMEOUT_7S_V1
// VSP_P3K7_DISABLE_P2BADGES_DEFAULT_V1
(function(){
  try {
    const u = new URL(location.href);
    // badges=1 => enable P2Badges for debugging only
    if (u.searchParams.get("badges") === "1") return;
  } catch (e) {}
  window.__VSP_DISABLE_P2BADGES = 1;
})();

/* ===== VSP_P1_FETCH_THROTTLE_TIMEOUT_V1 ===== */

;window.__VSP_MINI_V7_ONLY = true;
(function(){
  try{
    if (window.__VSP_FETCH_THROTTLE_TIMEOUT_V1) return;
    window.__VSP_FETCH_THROTTLE_TIMEOUT_V1 = 1;

    const origFetch = window.fetch ? window.fetch.bind(window) : null;
    if (!origFetch) return;

    const MAX_INFLIGHT = 4;
    const TIMEOUT_MS = 6000;
    let inflight = 0;
    const q = [];

    function runNext(){
      while(inflight < MAX_INFLIGHT && q.length){
        const job = q.shift();
        inflight++;
        job().finally(()=>{ inflight--; runNext(); });
      }
    }

    window.fetch = function(input, init){
      return new Promise((resolve,reject)=>{
        const job = async () => {
          const ctrl = new AbortController();
          const t = setTimeout(()=>ctrl.abort("timeout"), TIMEOUT_MS);
          try{
            const ii = Object.assign({}, init||{}, { signal: ctrl.signal });
            const res = await origFetch(input, ii);
            resolve(res);
          }catch(e){
            reject(e);
          }finally{
            clearTimeout(t);
          }
        };
        q.push(job);
        runNext();
      });
    };
  }catch(e){}
})();/* ===== VSP_P1_DASH_KILL_LOADING_TEXT_V4 =====
   MutationObserver + TreeWalker over document.body to eliminate stuck "Loading..."
   Expose: window.__vspDashKillLoadingNow()
*/
(function(){
  try{
    if (window.__VSP_DASH_KILL_LOADING_V4) return;
    window.__VSP_DASH_KILL_LOADING_V4 = true;

    function safeBadge(msg){
      try{
        var id="vsp-dash-degraded-badge-v4";
        var b=document.getElementById(id);
        if(!b){
          b=document.createElement("div");
          b.id=id;
          b.style.cssText=[
            "position:fixed","right:14px","bottom:52px","z-index:99999",
            "padding:8px 10px","border-radius:10px",
            "font:12px/1.2 system-ui",
            "background:rgba(0,0,0,.78)","color:#fff",
            "border:1px solid rgba(255,255,255,.14)",
            "max-width:46vw","pointer-events:none"
          ].join(";");
          (document.body||document.documentElement).appendChild(b);
        }
        b.textContent = msg || "DEGRADED";
      }catch(e){}
    }

    function normalizeLoading(t){
      // handle ASCII and unicode ellipsis
      // examples: "Loading...", "Loading..", "Loading.", "Loading", "Loading..."
      var tt = (t||"").trim();
      if (!tt) return null;
      if (tt==="Loading" || tt==="Loading." || tt==="Loading.." || tt==="Loading..." || tt==="Loading...") return tt;
      if (tt.indexOf("Loading")>=0) return tt;
      return null;
    }

    function replaceLoadingOnce(){
      var changed=0;
      try{
        var root = document.body || document.documentElement;
        if(!root) return 0;

        var w = document.createTreeWalker(root, NodeFilter.SHOW_TEXT, null);
        var node;
        while((node = w.nextNode())){
          var t = node.nodeValue || "";
          if(!t) continue;

          // skip script/style text nodes (paranoid)
          var pn = node.parentNode && node.parentNode.nodeName ? String(node.parentNode.nodeName).toLowerCase() : "";
          if (pn==="script" || pn==="style" || pn==="textarea") continue;

          var hit = normalizeLoading(t);
          if(!hit) continue;

          // Replace only the "Loading..." parts, keep other text around it
          var out = t
            .replace(/Loading\.{0,3}/g, "No data (degraded)")
            .replace(/Loading.../g, "No data (degraded)");

          if (out !== t){
            node.nodeValue = out;
            changed++;
          }
        }
      }catch(e){}
      return changed;
    }

    var pending=false;
    function runDebounced(){
      if(pending) return;
      pending=true;
      setTimeout(function(){
        pending=false;
        var n = replaceLoadingOnce();
        if(n>0) safeBadge("DEGRADED: charts no data (cleaned "+n+")");
      }, 80);
    }

    function start(){
      // initial passes
      runDebounced();
      setTimeout(runDebounced, 1200);
      setTimeout(runDebounced, 4500);
      setTimeout(runDebounced, 9000);

      // observe DOM changes and clean again
      try{
        var obs = new MutationObserver(function(){ runDebounced(); });
        obs.observe(document.body || document.documentElement, {subtree:true, childList:true, characterData:true});
      }catch(e){}
    }

    // expose manual trigger
    window.__vspDashKillLoadingNow = function(){
      try{
        var n = replaceLoadingOnce();
        safeBadge("DEGRADED: manual cleaned "+n);
        return n;
      }catch(e){ return -1; }
    };

    if (document.readyState === "loading"){
      document.addEventListener("DOMContentLoaded", start, {once:true});
    } else {
      start();
    }
  }catch(e){}
})();


/* ===== VSP_P1_DASH_KILL_LOADING_TEXT_V3 =====
   Robust: replace stuck "Loading..." via TreeWalker (text nodes).
*/
(function(){
  try{
    if (window.__VSP_DASH_KILL_LOADING_V3) return;
    window.__VSP_DASH_KILL_LOADING_V3 = true;

    function badge(msg){
      try{
        var id="vsp-dash-degraded-badge-v3";
        var b=document.getElementById(id);
        if(!b){
          b=document.createElement("div");
          b.id=id;
          b.style.cssText="position:fixed;right:14px;bottom:52px;z-index:99999;padding:8px 10px;border-radius:10px;font:12px/1.2 system-ui;background:rgba(0,0,0,.75);color:#fff;border:1px solid rgba(255,255,255,.12);max-width:46vw";
          document.body.appendChild(b);
        }
        b.textContent=msg||"DEGRADED";
      }catch(e){}
    }

    function replaceLoadingOnce(){
      var changed=0;
      try{
        var root = document.querySelector("#vsp-dashboard-main") || document.body;
        if(!root) return 0;

        var w = document.createTreeWalker(root, NodeFilter.SHOW_TEXT, null);
        var node;
        while((node = w.nextNode())){
          var t = node.nodeValue || "";
          if(!t) continue;
          // normalize
          var tt = t.trim();
          if(tt==="Loading..." || tt==="Loading.." || tt==="Loading." || tt==="Loading"){
            node.nodeValue = t.replace(tt, "No data (degraded)");
            changed++;
            continue;
          }
          if(t.indexOf("Loading...")>=0 || t.indexOf("Loading..")>=0 || t.indexOf("Loading.")>=0){
            node.nodeValue = t.replace(/Loading\.{1,3}/g, "No data (degraded)");
            changed++;
          }
        }
      }catch(e){}
      return changed;
    }

    function run(){
      var n = replaceLoadingOnce();
      if(n>0) badge("DEGRADED: charts no data (cleaned "+n+")");
      return n;
    }

    // run after initial loads
    setTimeout(run, 1200);
    setTimeout(run, 6500);

    // catch late renders: every 2s for 16s
    var left = 8;
    var iv = setInterval(function(){
      try{
        run();
        left--;
        if(left<=0) clearInterval(iv);
      }catch(e){
        clearInterval(iv);
      }
    }, 2000);

  }catch(e){}
})();


/* ===== VSP_P1_DASH_KILL_LOADING_TEXT_V2 =====
   Replace stuck "Loading..." placeholders in dashboard panels after timeout.
*/
(function(){
  try{
    if (window.__VSP_DASH_KILL_LOADING_V2) return;
    window.__VSP_DASH_KILL_LOADING_V2 = true;

    function mkBadge(msg){
      try{
        var id="vsp-dash-degraded-badge-v2";
        var b=document.getElementById(id);
        if(!b){
          b=document.createElement("div");
          b.id=id;
          b.style.cssText="position:fixed;right:14px;bottom:52px;z-index:99999;padding:8px 10px;border-radius:10px;font:12px/1.2 system-ui;background:rgba(0,0,0,.75);color:#fff;border:1px solid rgba(255,255,255,.12);max-width:46vw";
          document.body.appendChild(b);
        }
        b.textContent=msg||"DEGRADED";
      }catch(e){}
    }

    function killOnce(){
      var changed=0;
      try{
        // Replace exact "Loading..." and common variants
        var nodes=document.querySelectorAll("*");
        for (var i=0;i<nodes.length;i++){
          var el=nodes[i];
          if(!el || !el.firstChild) continue;
          // only touch leaf-ish text nodes to avoid nuking big containers
          if(el.children && el.children.length>0) continue;
          var t=(el.textContent||"").trim();
          if(t==="Loading..." || t==="Loading.." || t==="Loading." || t==="Loading"){
            el.textContent="No data (degraded)";
            changed++;
          }
        }

        // Also catch dashboard list-style placeholders (many lines)
        var host=document.querySelector("#vsp-dashboard-main") || document.querySelector("main") || document.body;
        if(host){
          var txt=(host.innerText||"");
          if(txt && txt.indexOf("Loading...")>=0){
            // Best-effort: don't rewrite whole host, just show a badge.
            mkBadge("DEGRADED: charts pending (auto-clean)");
          }
        }

      }catch(e){}
      return changed;
    }

    // Run after main fetches likely completed
    setTimeout(function(){
      try{
        var n=killOnce();
        if(n>0) mkBadge("DEGRADED: charts no data (cleaned "+n+")");
      }catch(e){}
    }, 6500);

    // One more pass later (for slow machines)
    setTimeout(function(){
      try{
        var n=killOnce();
        if(n>0) mkBadge("DEGRADED: charts no data (cleaned "+n+")");
      }catch(e){}
    }, 11000);

  }catch(e){}
})();


/* ===== VSP_P1_DASH_WATCHDOG_NOHANG_V1 =====
   If dashboard stays in "loading" too long, force exit loading + show degraded note.
*/
(function(){
  try{
    if (window.__VSP_DASH_WD_V1) return;
    window.__VSP_DASH_WD_V1 = true;

    function q(sel){ try{return document.querySelector(sel);}catch(e){return null;} }
    function text(el, t){ try{ if(el) el.textContent = String(t||""); }catch(e){} }

    function markDegraded(msg){
      // Try common places first; fallback: small toast in corner
      const host = q("#vsp-dashboard-main") || q("main") || document.body;
      if(!host) return;
      let b = q("#vsp-dash-degraded-badge-v1");
      if(!b){
        b = document.createElement("div");
        b.id = "vsp-dash-degraded-badge-v1";
        b.style.cssText = "position:fixed;right:14px;bottom:14px;z-index:99999;padding:8px 10px;border-radius:10px;font:12px/1.2 system-ui;background:rgba(0,0,0,.75);color:#fff;border:1px solid rgba(255,255,255,.12);max-width:46vw";
        document.body.appendChild(b);
      }
      text(b, msg || "DEGRADED");
    }

    function stopLoading(){
      // Common loaders/spinners
      const loaders = [
        "#vsp-loading", "#vsp-loader", ".vsp-loader", ".loading", ".spinner",
        "#vsp-dashboard-loading", "#vsp-dashboard-skeleton", ".vsp-skeleton"
      ];
      loaders.forEach(sel=>{
        const el = q(sel);
        if(el) try{ el.style.display="none"; }catch(e){}
      });
      // Also remove "is-loading" body class if any
      try{ document.body.classList.remove("loading","is-loading","vsp-loading"); }catch(e){}
    }

    // After 6 seconds, if still looks loading, force stop.
    setTimeout(function(){
      try{
        // Heuristic: if any loader element still visible OR key KPI nodes empty
        const loader = q("#vsp-dashboard-loading") || q(".vsp-skeleton") || q("#vsp-loading") || q(".spinner");
        const kpi = q("[data-kpi]") || q(".kpi") || q(".vsp-kpi");
        const looksLoading = !!loader && (loader.offsetParent !== null);
        const looksEmpty = !kpi;
        if(looksLoading || looksEmpty){
          stopLoading();
          markDegraded("DEGRADED: dashboard data not ready (watchdog)");
        }
      }catch(e){}
    }, 6000);

  }catch(e){}
})();


/* ===== VSP_P1_DASH_FETCHSHIM_RUNS_LIMIT1_AND_TREND_POINTS_V1 =====
   목적: commercial-safe UI
   - rewrite /api/vsp/runs?limit=1 => /api/vsp/rid_latest (wrap back to old schema)
   - ensure /api/vsp/trend_v1 has at least 1 point (no empty points[] => no spinner hang)
*/
(function(){
  try{
    if (window.__VSP_DASH_FETCHSHIM_V1) return;
    window.__VSP_DASH_FETCHSHIM_V1 = true;

    const _fetch = window.fetch ? window.fetch.bind(window) : null;
    if (!_fetch) return;

    function _asUrl(input){
      try{
        if (typeof input === "string") return input;
        if (input && typeof input.url === "string") return input.url;
      }catch(e){}
      return "";
    }

    function _mkJsonResponse(obj, origRes){
      try{
        const headers = new Headers((origRes && origRes.headers) ? origRes.headers : undefined);
        headers.set("Content-Type","application/json; charset=utf-8");
        const body = JSON.stringify(obj);
        return new Response(body, { status: 200, headers });
      }catch(e){
        return new Response(JSON.stringify(obj), { status: 200, headers: { "Content-Type":"application/json; charset=utf-8" }});
      }
    }

    window.fetch = async function(input, init){
      const url = _asUrl(input);

      // (1) runs?limit=1 -> rid_latest wrapped as old runs schema
      try{
        if (url && url.indexOf("/api/vsp/runs?limit=1") >= 0){
          // keep original behavior if caller explicitly wants offset!=0
          if (url.indexOf("offset=") < 0 || url.indexOf("offset=0") >= 0){
            try{
              const ridRes = await _fetch("/api/vsp/rid_latest", init);
              const ridTxt = await ridRes.text();
              let rid = "";
              try{ rid = (JSON.parse(ridTxt)||{}).rid || ""; }catch(e){}
              if (rid){
                const wrapped = {
                  ok: true,
                  total: 1,
                  limit: 1,
                  offset: 0,
                  runs: [{ rid: rid, mtime: Math.floor(Date.now()/1000) }],
                  roots: [],
                  ts: Math.floor(Date.now()/1000),
                  __via__: "VSP_P1_DASH_FETCHSHIM_V1"
                };
                return _mkJsonResponse(wrapped, ridRes);
              }
            }catch(e){}
          }
        }
      }catch(e){}

      // default fetch
      const res = await _fetch(input, init);

      // (2) trend_v1: ensure points non-empty (safe fallback)
      try{
        if (url && url.indexOf("/api/vsp/trend_v1") >= 0){
          const txt = await res.text();
          let j=null;
          try{ j = JSON.parse(txt); }catch(e){ j=null; }
          if (j && typeof j === "object"){
            const pts = Array.isArray(j.points) ? j.points : [];
            if (pts.length === 0){
              const latest = j.latest_run_id || "";
              const total = (typeof j.total_findings === "number") ? j.total_findings : 0;
              j.points = [{
                label: latest ? String(latest) : "latest",
                run_id: latest,
                total_findings: total,
                ts: Date.now(),
                __fallback__: true
              }];
              j.__via__ = "VSP_P1_DASH_FETCHSHIM_V1";
              return _mkJsonResponse(j, res);
            }
          }
          // if not modified, return original by re-wrapping consumed body
          return new Response(txt, { status: res.status, statusText: res.statusText, headers: res.headers });
        }
      }catch(e){
        // if anything fails, let original response pass through
      }

      return res;
    };
  }catch(e){}
})();

// VSP_CIO_BUILDSTAMP_V1_LOADER
try{
  if(!document.querySelector('script[data-vsp-cio-buildstamp]')){
    var s=document.createElement('script');
    s.src='/static/js/vsp_cio_build_stamp_v1.js?v='+(window.__VSP_ASSET_V||Date.now());
    s.defer=true;
    s.setAttribute('data-vsp-cio-buildstamp','1');
    document.head.appendChild(s);
  }
}catch(_e){}

try{if(!document.querySelector('script[data-vsp-cio-skeleton]')){var s=document.createElement("script");s.src="/static/js/vsp_cio_skeleton_kpi_v1.js?v=cio_sk_v1";s.defer=true;s.setAttribute("data-vsp-cio-skeleton","1");document.head.appendChild(s);}}catch(_e){};
// VSP_BADGEPIN_V2_LOADER
(function(){
  try{
    if (window.__VSP_BADGEPIN_V2_LOADER) return;
    window.__VSP_BADGEPIN_V2_LOADER = true;
    var id="vsp-pin-dataset-badge-v2";
    if (document.getElementById(id)) return;
    var sc=document.createElement("script");
    sc.id=id;
    sc.src="/static/js/vsp_pin_dataset_badge_v2.js?v=" + (window.__VSP_ASSET_V || Date.now());
    sc.async=true;
    sc.defer=true;
    (document.head||document.documentElement).appendChild(sc);
  }catch(e){}
})();

 // === END CIO hard-block luxe ===
/* ===== VSP_P1_RULE_OVERRIDES_RULES_ONLY_FINAL_V1 =====
   Normalize any API shape to {schema:"rules_v1", rules:[...]}.
*/
function __vspRO_pickRules(j){
  try{
    if(!j || typeof j!=="object") return [];
    // prefer top-level rules
    if(Array.isArray(j.rules)) return j.rules.filter(x=>x && typeof x==="object");
    // allow top-level items legacy
    if(Array.isArray(j.items)) return j.items.filter(x=>x && typeof x==="object");
    // allow data.* variants
    const d = (j.data && typeof j.data==="object") ? j.data : null;
    if(d){
      if(Array.isArray(d.rules)) return d.rules.filter(x=>x && typeof x==="object");
      if(Array.isArray(d.items)) return d.items.filter(x=>x && typeof x==="object");
    }
  }catch(e){}
  return [];
}
function __vspRO_norm(j){
  return { schema:"rules_v1", rules: __vspRO_pickRules(j) };
}
function __vspRO_normFromText(txt){
  try{
    const obj = JSON.parse(txt || "{}");
    return __vspRO_norm(obj);
  }catch(e){
    return { schema:"rules_v1", rules: [] };
  }
}
/* VSP_P2_JS_ASSET_V_PINNED_V1 */
(function(){
  try {
    if (!window.__VSP_ASSET_V) window.__VSP_ASSET_V = "20251224_122204";
  } catch(e) {}
})();
function __vspAssetV(){
  try {
    return (window.__VSP_ASSET_V || "20251224_122204");
  } catch(e) {
    return "20251224_122204";
  }
}

/* VSP_P2_TREND_PATH_FORCE_V2 */
/* ===================== VSP_P0_FETCH_CACHE_DEDUPE_V1K =====================
   Purpose: reduce XHR spam by caching/deduping a few hot JSON endpoints at FE layer.
   Targets: /api/vsp/rid_latest, /api/vsp/rid_latest_gate_root, /api/vsp/release_latest
   Notes: strips ts= query param; TTL default 30s; dedup in-flight; returns Response(JSON).
========================================================================= */

/* ===================== VSP_P0_GLOBAL_FETCH_CACHE_DEDUPE_V1N5 =====================
   Goal: reduce XHR spam by dedupe+TTL cache across ALL FE modules (single place).
   - Dedupe inflight identical GETs (same normalized URL)
   - TTL cache hot endpoints (rid_latest, release_latest, runs, dashboard, gate summary, trend, top_findings)
   - Strip noisy ts= and sort query params for stable keys
=============================================================================== */
(function(){
  try{
    if (window.__VSP_FETCHCACHE_V1N5__) return;
    window.__VSP_FETCHCACHE_V1N5__ = true;

    const _fetch = window.fetch ? window.fetch.bind(window) : null;
    if (!_fetch) return;

    const now = ()=> Date.now();
    const inflight = new Map(); // key -> Promise(entry)
    const cache = new Map();    // key -> { exp, status, headers, text }

    function normUrl(input){
      try{
        const u = (input instanceof URL) ? input : new URL(String(input), location.origin);
        if (u.origin !== location.origin) return null;

        // strip cache-busters
        u.searchParams.delete("ts");
        u.searchParams.delete("_ts");
        u.searchParams.delete("__ts");

        // sort params for stable key
        const keys = Array.from(u.searchParams.keys()).sort();
        const pairs = [];
        for(const k of keys){
          const vals = u.searchParams.getAll(k);
          for(const v of vals){
            pairs.push([k, v]);
          }
        }
        u.search = "";
        for(const [k,v] of pairs){
          u.searchParams.append(k, v);
        }
        return u.pathname + (u.search ? u.search : "");
      }catch(e){
        return null;
      }
    }

    function ttlFor(pathq){
      try{
        const path = (pathq||"").split("?")[0] || "";
        // HOT endpoints: cap spam hard
        if (path === "/api/vsp/rid_latest") return 30000;
        if (path === "/api/vsp/rid_latest_gate_root") return 30000;
        if (path === "/api/vsp/release_latest") return 60000;
        if (path === "/api/vsp/runs") return 30000;

        if (path === "/api/vsp/dashboard_v3") return 12000;
        if (path === "/api/vsp/run_gate_summary_v1") return 12000;

        if (path === "/api/vsp/trend_v1?path=") return 15000;
        if (path === "/api/vsp/top_findings_v2") return 15000;

        // Findings paging is noisy/variable => do NOT global-cache it by default
        if (path.startsWith("/api/vsp/findings_page_")) return 0;

        return 0;
      }catch(e){ return 0; }
    }

    function headersToObj(h){
      const o = {};
      try{
        if (!h || !h.forEach) return o;
        h.forEach((v,k)=>{ o[k]=v; });
      }catch(e){}
      return o;
    }
    function objToHeaders(o){
      const h = new Headers();
      try{
        for(const k in (o||{})) h.set(k, String(o[k]));
      }catch(e){}
      return h;
    }

    async function fetchAndStore(key, input, init, ttl){
      const r = await _fetch(input, init);
      try{
        const clone = r.clone();
        const text = await clone.text();
        const ent = { exp: now()+ttl, status: r.status, headers: headersToObj(r.headers), text };
        cache.set(key, ent);
        return ent;
      }catch(e){
        // If we can't read body, still don't break callers
        return { exp: now()+ttl, status: r.status, headers: headersToObj(r.headers), text: "" };
      }
    }

    window.fetch = function(input, init){
      try{
        const method = ((init && init.method) ? String(init.method) : "GET").toUpperCase();
        if (method !== "GET") return _fetch(input, init);

        const key = normUrl(input);
        if (!key) return _fetch(input, init);

        const ttl = ttlFor(key);
        if (!ttl) return _fetch(input, init);

        const c = cache.get(key);
        if (c && c.exp > now()){
          // serve from cache
          return Promise.resolve(new Response(c.text, { status: c.status, headers: objToHeaders(c.headers) }));
        }

        const inf = inflight.get(key);
        if (inf){
          return inf.then(ent => new Response(ent.text, { status: ent.status, headers: objToHeaders(ent.headers) }));
        }

        const prom = fetchAndStore(key, input, init, ttl)
          .finally(()=>{ try{ inflight.delete(key); }catch(e){} });
        inflight.set(key, prom);

        // Caller gets real network response (not cached one) to preserve streaming semantics.
        // But to keep it simple and consistent, return a cloned Response built from stored entry.
        return prom.then(ent => new Response(ent.text, { status: ent.status, headers: objToHeaders(ent.headers) }));
      }catch(e){
        return _fetch(input, init);
      }
    };

  }catch(e){}
})(); 
/* ===================== /VSP_P0_GLOBAL_FETCH_CACHE_DEDUPE_V1N5 ===================== */

/* ===================== VSP_P0_FE_REQ_COUNTER_V1N5B =====================
   Lightweight request telemetry for commercial audit (no server access log needed).
   Use in DevTools console:
     __vspReqTop(10)  // top endpoints in last 10 seconds
     __vspReqClear()
============================================================================ */
(function(){
  try{
    if (window.__VSP_REQ_COUNTER_V1N5B__) return;
    window.__VSP_REQ_COUNTER_V1N5B__ = true;

    window.__VSP_REQ_LOG = window.__VSP_REQ_LOG || [];
    function norm(u){
      try{
        const x = new URL(String(u), location.origin);
        if (x.origin !== location.origin) return null;
        if (!x.pathname.startsWith("/api/vsp/")) return null;
        x.searchParams.delete("ts"); x.searchParams.delete("_ts"); x.searchParams.delete("__ts");
        // keep rid but normalize ordering
        const keys = Array.from(x.searchParams.keys()).sort();
        const pairs=[];
        for(const k of keys){
          const vals=x.searchParams.getAll(k);
          for(const v of vals) pairs.push([k,v]);
        }
        x.search="";
        for(const [k,v] of pairs) x.searchParams.append(k,v);
        return x.pathname + (x.search?x.search:"");
      }catch(e){ return null; }
    }

    const _fetch = window.fetch ? window.fetch.bind(window) : null;
    if (!_fetch) return;

    window.fetch = function(input, init){
      try{
        const method = ((init&&init.method)?String(init.method):"GET").toUpperCase();
        const key = norm(input);
        if (key){
          window.__VSP_REQ_LOG.push({ t: Date.now(), m: method, u: key });
          // cap memory
          if (window.__VSP_REQ_LOG.length > 2000) window.__VSP_REQ_LOG.splice(0, 500);
        }
      }catch(e){}
      return _fetch(input, init);
    };

    window.__vspReqClear = function(){ try{ window.__VSP_REQ_LOG = []; }catch(e){} };

    window.__vspReqTop = function(seconds){
      try{
        const sec = Math.max(1, Number(seconds||10));
        const cut = Date.now() - sec*1000;
        const arr = (window.__VSP_REQ_LOG||[]).filter(x=>x && x.t>=cut);
        const m = new Map();
        for(const x of arr){
          const k = x.u;
          m.set(k, (m.get(k)||0)+1);
        }
        const out = Array.from(m.entries()).sort((a,b)=>b[1]-a[1]).slice(0,25);
        console.log("[VSP_REQ_TOP]", { window_sec: sec, total: arr.length });
        for(const [k,c] of out) console.log(String(c).padStart(4," "), k);
        return out;
      }catch(e){
        console.warn("[VSP_REQ_TOP] error", e);
        return [];
      }
    };

  }catch(e){}
})(); 
/* ===================== /VSP_P0_FE_REQ_COUNTER_V1N5B ===================== */


/* ===================== VSP_P0_SINGLEFLIGHT_HELPER_V1N7 =====================
   window.__vspSF(url, ttlMs): single-flight + TTL JSON cache for hot endpoints.
============================================================================ */
(function(){
  try{
    if (window.__VSP_SF_V1N7__) return;
    window.__VSP_SF_V1N7__ = true;
    const inflight = new Map(); // url -> Promise
    const cache = new Map();    // url -> { exp, val }
    function now(){ return Date.now(); }
    window.__vspSF = async function(url, ttlMs){
      const ttl = Math.max(0, Number(ttlMs||0));
      const key = String(url||"");
      const c = cache.get(key);
      if (c && c.exp > now()) return c.val;
      const inf = inflight.get(key);
      if (inf) return await inf;
      const prom = (async ()=>{
        const r = await fetch(key, { credentials:"same-origin" });
        if (!r.ok) throw new Error("HTTP "+r.status+" for "+key);
        const j = await r.json();
        if (ttl) cache.set(key, { exp: now()+ttl, val: j });
        return j;
      })().finally(()=>{ try{ inflight.delete(key); }catch(e){} });
      inflight.set(key, prom);
      return await prom;
    };
  }catch(e){}
})(); 
/* ===================== /VSP_P0_SINGLEFLIGHT_HELPER_V1N7 ===================== */






(function(){
  try{
    if (window.__VSP_FETCH_CACHE_DEDUPE_V1K__) return;
    window.__VSP_FETCH_CACHE_DEDUPE_V1K__ = true;

    const TTL_MS = 30 * 1000;
    const cache = new Map();     // key -> {ts, status, json}
    const inflight = new Map();  // key -> Promise<{status,json}>

    function isSameOrigin(u){
      try{ return (new URL(u, location.origin)).origin === location.origin; }
      catch(e){ return false; }
    }
    function normUrl(u){
      try{
        const url = new URL(u, location.origin);
        if (url.searchParams.has("ts")) url.searchParams.delete("ts");
        return url.pathname + (url.search ? url.search : "");
      }catch(e){
        return String(u||"");
      }
    }
    function shouldCache(u){
      try{
        const url = new URL(u, location.origin);
        const p = url.pathname || "";
        if (!p.startsWith("/api/vsp/")) return false;
        return (
          p === "/api/vsp/rid_latest" ||
          p === "/api/vsp/rid_latest_gate_root" ||
          p === "/api/vsp/release_latest"
        );
      }catch(e){
        return false;
      }
    }
    function makeJsonResp(obj, status){
      try{
        return new Response(JSON.stringify(obj ?? {}), {
          status: status || 200,
          headers: { "Content-Type": "application/json; charset=utf-8" }
        });
      }catch(e){
        return new Response("{}", {status: status || 200, headers: {"Content-Type":"application/json"}});
      }
    }

    const origFetch = window.fetch.bind(window);
    window.fetch = function(resource, init){
      try{
        const method = ((init && init.method) || (resource && resource.method) || "GET").toUpperCase();
        const urlStr = (typeof resource === "string") ? resource : (resource && resource.url) ? resource.url : String(resource||"");
        if (method !== "GET") return origFetch(resource, init);
        if (!isSameOrigin(urlStr)) return origFetch(resource, init);
        if (!shouldCache(urlStr)) return origFetch(resource, init);

        const key = method + " " + normUrl(urlStr);
        const now = Date.now();

        const hit = cache.get(key);
        if (hit && (now - hit.ts) < TTL_MS){
          return Promise.resolve(makeJsonResp(hit.json, hit.status));
        }

        const inF = inflight.get(key);
        if (inF){
          return inF.then(r => makeJsonResp(r.json, r.status));
        }

        const pReq = origFetch(resource, init)
          .then(async (r) => {
            let j = {};
            try{ j = await r.clone().json(); }catch(e){ j = {}; }
            const pack = { status: r.status || 200, json: j };
            cache.set(key, { ts: Date.now(), status: pack.status, json: pack.json });
            return pack;
          })
          .finally(() => { try{ inflight.delete(key); }catch(e){} });

        inflight.set(key, pReq);
        return pReq.then(pack => makeJsonResp(pack.json, pack.status));
      }catch(e){
        return origFetch(resource, init);
      }
    };
  }catch(e){}
})(); 
/* ===================== /VSP_P0_FETCH_CACHE_DEDUPE_V1K ===================== */

/* ===================== VSP_P0_FETCH_CACHE_DEDUPE_V1K2 =====================
   Upgrade:
   - strip ts= for ALL /api/vsp/*
   - also cache rid-scoped heavy endpoints: dashboard_v3, run_gate_summary_v1 (TTL 12s)
========================================================================= */
(function(){
  try{
    if (!window.__VSP_FETCH_CACHE_DEDUPE_V1K__) return;
    if (window.__VSP_FETCH_CACHE_DEDUPE_V1K2__) return;
    window.__VSP_FETCH_CACHE_DEDUPE_V1K2__ = true;

    const TTL_HEAVY_MS = 12 * 1000;

    // Wrap fetch again but delegate to the already-wrapped fetch cache if present.
    const prevFetch = window.fetch.bind(window);

    function isSameOrigin(u){
      try{ return (new URL(u, location.origin)).origin === location.origin; }
      catch(e){ return false; }
    }
    function stripTsAll(u){
      try{
        const url = new URL(u, location.origin);
        if (url.pathname.startsWith("/api/vsp/") && url.searchParams.has("ts")) url.searchParams.delete("ts");
        return url.pathname + (url.search ? url.search : "");
      }catch(e){ return String(u||""); }
    }
    function isHeavy(u){
      try{
        const url = new URL(u, location.origin);
        if (!url.pathname.startsWith("/api/vsp/")) return false;
        return (url.pathname === "/api/vsp/dashboard_v3" || url.pathname === "/api/vsp/run_gate_summary_v1");
      }catch(e){ return false; }
    }

    const heavyCache = new Map();   // key -> {ts, status, json}
    const heavyIn = new Map();      // key -> Promise

    function makeJsonResp(obj, status){
      try{
        return new Response(JSON.stringify(obj ?? {}), {
          status: status || 200,
          headers: { "Content-Type": "application/json; charset=utf-8" }
        });
      }catch(e){
        return new Response("{}", {status: status || 200, headers: {"Content-Type":"application/json"}});
      }
    }

    window.fetch = function(resource, init){
      try{
        const method = ((init && init.method) || (resource && resource.method) || "GET").toUpperCase();
        const urlStr = (typeof resource === "string") ? resource : (resource && resource.url) ? resource.url : String(resource||"");
        if (method !== "GET") return prevFetch(resource, init);
        if (!isSameOrigin(urlStr)) return prevFetch(resource, init);

        const n = stripTsAll(urlStr);

        // Heavy rid-scoped cache
        if (isHeavy(urlStr)){
          const key = method + " " + n;
          const now = Date.now();
          const hit = heavyCache.get(key);
          if (hit && (now - hit.ts) < TTL_HEAVY_MS){
            return Promise.resolve(makeJsonResp(hit.json, hit.status));
          }
          const infl = heavyIn.get(key);
          if (infl){
            return infl.then(pack => makeJsonResp(pack.json, pack.status));
          }
          const pReq = prevFetch(n, init)
            .then(async (r)=>{
              let j = {};
              try{ j = await r.clone().json(); }catch(e){ j = {}; }
              const pack = {status: r.status || 200, json: j};
              heavyCache.set(key, {ts: Date.now(), status: pack.status, json: pack.json});
              return pack;
            })
            .finally(()=>{ try{ heavyIn.delete(key); }catch(e){} });
          heavyIn.set(key, pReq);
          return pReq.then(pack => makeJsonResp(pack.json, pack.status));
        }

        // For all /api/vsp/* just strip ts and delegate
        if (n !== urlStr && n.startsWith("/api/vsp/")){
          return prevFetch(n, init);
        }

        return prevFetch(resource, init);
      }catch(e){
        return prevFetch(resource, init);
      }
    };
  }catch(e){}
})();
 /* ===================== /VSP_P0_FETCH_CACHE_DEDUPE_V1K2 ===================== */




/* VSP_P2_BUNDLE_TABS5_V1
 * Router-bundle: load page modules by route, keep templates minimal:
 * Only include: vsp_tabs4_autorid_v1.js + this file.
 */
(function(){
  "use strict";

  function log(){ try{ console.log.apply(console, arguments); }catch(e){} }
  function warn(){ try{ console.warn.apply(console, arguments); }catch(e){} }

  function getAssetV(){
    // Try to reuse existing ?v=<digits> from any script tag.
    var scripts = document.getElementsByTagName("script");
    for (var i=0;i<scripts.length;i++){
      var src = scripts[i].getAttribute("src") || "";
      var m = src.match(/[?&]v=([0-9]{6,})/);
      if (m) return m[1];
    }
    return "";
  }

  function withV(url){
    var v = getAssetV();
    if(!v) return url;
    return url + (url.indexOf("?")>=0 ? "&" : "?") + "v=" + encodeURIComponent(v);
  }

  function loadScript(url){
    return new Promise(function(resolve, reject){
      var s = document.createElement("script");
      s.defer = true;
      s.src = withV(url);
      s.onload = function(){ resolve(url); };
      s.onerror = function(){ reject(new Error("load fail: "+url)); };
      document.head.appendChild(s);
    });
  }

  function exists(url){
    // Avoid noisy 404s: HEAD first (fallback GET if HEAD not allowed)
    var u = withV(url);
    return fetch(u, { method: "GET", credentials: "same-origin", cache: "no-store" })
      .then(function(r){
        if(r && r.ok) return true;
        if(r && (r.status === 405 || r.status === 403)) {
          return fetch(u, { method: "GET", credentials: "same-origin", cache: "no-store" })
            .then(function(r2){ return !!(r2 && r2.ok); })
            .catch(function(){ return false; });
        }
        return false;
      })
      .catch(function(){ return false; });
  }

  function loadIfExists(url){
    return exists(url).then(function(ok){
      if(!ok) return false;
      return loadScript(url).then(function(){ return true; }).catch(function(){ return false; });
    });
  }

  function pickRoute(){
    var p = (location.pathname || "/").toLowerCase();
    // normalize
    if (p === "/" || p === "/index") return "/vsp5";
    return p;
  }

  // Candidate modules: router will only load ones that exist.
  var ROUTES = {
    "/vsp5": [
      "/static/js/vsp_dash_only_v1.js",
      "/static/js/vsp_dashboard_kpi_force_any_v1.js",
      "/static/js/vsp_dashboard_gate_story_v1.js",
      "/static/js/vsp_dashboard_charts_pretty_v3.js"
    ],
    "/runs": [
      "/static/js/vsp_runs_reports_overlay_v1.js",
      "/static/js/vsp_runs_quick_actions_v1.js",
      "/static/js/vsp_runs_tab_resolved_v1.js"
    ],
    "/settings": [
      "/static/js/vsp_settings_tab_v1.js"
    ],
    "/data_source": [
      "/static/js/vsp_data_source_lazy_v1.js"
    ],
    "/rule_overrides": [
      "/static/js/vsp_rule_overrides_v1.js"
    ]
  };

  var route = pickRoute();
  var list = ROUTES[route] || [];
  if(!list.length){
    warn("[BundleTabs5] no modules mapped for route:", route);
    return;
  }

  log("[BundleTabs5] route=", route, "candidates=", list.length);

  // Load sequentially to keep deterministic order
  (function seq(i){
    if(i >= list.length){
      log("[BundleTabs5] done route=", route);
      return;
    }
    loadIfExists(list[i]).then(function(loaded){
      if(loaded) log("[BundleTabs5] loaded:", list[i]);
      seq(i+1);
    });
  })(0);


  // ===================== VSP_P2_BADGES_RID_OVERALL_V1 =====================
  (function(){
    function safeLog(){ try{ console.log.apply(console, arguments); }catch(e){} }
    function safeWarn(){ try{ console.warn.apply(console, arguments); }catch(e){} }

    function ensureStyle(){
      if (document.getElementById("vsp_p2_badges_style")) return;
      var st = document.createElement("style");
      st.id = "vsp_p2_badges_style";
      st.textContent = `
        .vsp-p2-badges{display:flex;gap:8px;align-items:center;margin-left:auto}
        .vsp-badge{font:12px/1.2 ui-sans-serif,system-ui; padding:4px 8px; border-radius:999px;
          border:1px solid rgba(255,255,255,.18); background:rgba(255,255,255,.06); color:#e8eefc;
          letter-spacing:.2px; white-space:nowrap}
        .vsp-badge b{font-weight:700}
        .vsp-badge.green{border-color:rgba(46,204,113,.45); background:rgba(46,204,113,.12)}
        .vsp-badge.amber{border-color:rgba(241,196,15,.45); background:rgba(241,196,15,.12)}
        .vsp-badge.red{border-color:rgba(231,76,60,.45); background:rgba(231,76,60,.12)}
        .vsp-badge.gray{opacity:.85}
        .vsp-badge-click:hover{filter:brightness(1.18)}
      `;
      document.head.appendChild(st);
    }

    function findTopbar(){
      // Your pages use .topnav in /vsp5; other tabs may also have it.
      return document.querySelector(".topnav") || document.querySelector("#topbar") || null;
    }

    function ensureContainer(topbar){
      var id = "vsp_p2_badges";
      var c = document.getElementById(id);
      if (c) return c;
      c = document.createElement("div");
      c.id = id;
      c.className = "vsp-p2-badges";
      if (topbar){
        topbar.appendChild(c);
      } else {
        // fallback: put at top of body (should rarely happen)
        c.style.position = "fixed";
        c.style.top = "10px";
        c.style.right = "10px";
        c.style.zIndex = "9999";
        document.body.appendChild(c);
      }
      return c;
    }

    
    function mkBadge(cls, text, opts){
      opts = opts || {};
      var el = document.createElement("span");
      el.className = "vsp-badge " + cls + (opts.click ? " vsp-badge-click" : "");
      el.textContent = text;
      if (opts.click){
        el.style.cursor = "pointer";
        el.title = opts.title || "Open";
        if (opts.action) el.dataset.vspAction = opts.action;
        if (opts.payload) el.dataset.vspPayload = opts.payload;
        el.addEventListener("click", function(){
          try{
            var a = el.dataset.vspAction || "";
            var p = el.dataset.vspPayload || "";
            if (a === "runs_rid"){
              // p is rid
              location.href = "/runs?rid=" + encodeURIComponent(p);
            } else if (a === "dash_gate"){
              location.href = "/vsp5?gate=1";
            }
          }catch(e){}
        });
      }
      return el;
    }


    function timeoutFetch(url, ms){
      var ctrl = new AbortController();
      var t = setTimeout(function(){ try{ ctrl.abort(); }catch(e){} }, ms);
      return fetch(url, {cache:"no-store", credentials:"same-origin", signal: ctrl.signal})
        .finally(function(){ clearTimeout(t); });
    }

    function pickOverallClass(v){
      v = (v || "").toString().toUpperCase();
      if (v === "GREEN" || v === "PASS" || v === "OK") return "green";
      if (v === "AMBER" || v === "WARN" || v === "WARNING" || v === "DEGRADED") return "amber";
      if (v === "RED" || v === "FAIL" || v === "BLOCK") return "red";
      return "gray";
    }

    function shortRid(rid){
      rid = (rid || "").toString();
      if (rid.length <= 18) return rid;
      return rid.slice(0, 10) + "..." + rid.slice(-6);
    }

    async function run(){
      try{
        ensureStyle();
        var topbar = findTopbar();
        var c = ensureContainer(topbar);

        // clear old
        c.innerHTML = "";
        c.appendChild(mkBadge("gray", "RID: ..."));
        c.appendChild(mkBadge("gray", "Overall: ..."));

        // 1) rid_latest
        var rid = "";
        try{
          var r1 = await timeoutFetch("/api/vsp/rid_latest", 3500);
          var j1 = await r1.json();
          rid = (j1 && j1.rid) ? j1.rid : "";
        }catch(e){
          safeWarn("[P2Badges] rid_latest fetch fail", e);
        }

        // 2) run_gate_summary
        var overall = "";
        var degraded = false;
        try{
          if (rid){
            var url = "/api/vsp/run_gate_summary_v1?rid=" + encodeURIComponent(rid);
            var r2 = await timeoutFetch(url, 4000);
            var j2 = await r2.json();

            overall = (j2 && j2.overall) ? j2.overall : "";
            // Best-effort degraded detection (flexible)
            degraded = !!(
              (j2 && j2.degraded) ||
              (j2 && j2.status && (""+j2.status).toUpperCase().includes("DEGRADED")) ||
              (j2 && j2.degraded_tools && Array.isArray(j2.degraded_tools) && j2.degraded_tools.length) ||
              (j2 && j2.missing_tools && Array.isArray(j2.missing_tools) && j2.missing_tools.length)
            );
          }
        }catch(e){
          safeWarn("[P2Badges] run_gate_summary fetch fail", e);
        }

        // render
        c.innerHTML = "";
        c.appendChild(mkBadge("gray", "RID: " + (rid ? shortRid(rid) : "n/a"), {click:true, action:"runs_rid", payload: rid || "", title:"Open Runs & Reports (RID)"}));
        var oc = pickOverallClass(overall);
        c.appendChild(mkBadge(oc, "Overall: " + (overall ? overall.toString().toUpperCase() : "n/a"), {click:true, action:"dash_gate", payload:"1", title:"Open Dashboard (Gate)"}));
        if (degraded){
          c.appendChild(mkBadge("amber", "DEGRADED", {click:true, action:"dash_gate", payload:"1", title:"Open Dashboard (Gate)"}));
        }

        safeLog("[P2Badges] ok rid=", rid, "overall=", overall, "degraded=", degraded);
      }catch(e){
        // no throw to avoid breaking UI
      }
    }

    // Run after DOM is ready enough
    if (document.readyState === "loading"){
      document.addEventListener("DOMContentLoaded", run);
    } else {
      run();
    }
  })();
  // ===================== /VSP_P2_BADGES_RID_OVERALL_V1 =====================

})();

/* VSP_P2_BADGES_CLICK_ACTIONS_V1 */


/* VSP_P2_SETTINGS_TOOL_POLICY_PANEL_V1 */
(function(){
  function _vspEl(tag, attrs, html){
    const e = document.createElement(tag);
    if (attrs) for (const k of Object.keys(attrs)) e.setAttribute(k, attrs[k]);
    if (html != null) e.innerHTML = html;
    return e;
  }

  function _vspTryMountSettingsPanel(){
    try {
      if (location.pathname !== "/settings") return;
      if (document.getElementById("vsp-settings-commercial-panel")) return;

      const anchor = document.querySelector("#vsp-settings-main") || document.querySelector("main") || document.body;
      const panel = _vspEl("div", {id:"vsp-settings-commercial-panel"}, `
        <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;">
          <div style="font-weight:800;letter-spacing:.2px;">Tool Coverage & Policy (Commercial)</div>
          <div style="opacity:.75;font-size:12px;">8 tools • degrade-graceful • evidence-first</div>
        </div>
        <div style="margin-top:10px;display:flex;flex-wrap:wrap;gap:8px;">
          <span class="vsp-pill">Bandit</span>
          <span class="vsp-pill">Semgrep</span>
          <span class="vsp-pill">Gitleaks</span>
          <span class="vsp-pill">KICS</span>
          <span class="vsp-pill">Trivy</span>
          <span class="vsp-pill">Syft</span>
          <span class="vsp-pill">Grype</span>
          <span class="vsp-pill">CodeQL</span>
        </div>
        <div style="margin-top:10px;opacity:.85;font-size:13px;line-height:1.5;">
          <ul style="margin:0;padding-left:18px;">
            <li><b>Timeout & degrade:</b> long tools (KICS/CodeQL) must timeout and mark <i>degraded</i>, not hang the pipeline.</li>
            <li><b>Severity normalization:</b> CRITICAL/HIGH/MEDIUM/LOW/INFO/TRACE.</li>
            <li><b>Artifacts:</b> always keep logs + raw outputs + unified findings + reports for audit/ISO mapping.</li>
            <li><b>Dashboard:</b> if KPI is disabled by policy, UI should show a degraded badge (not blank).</li>
          </ul>
        </div>
      `);

      // lightweight styling (works even without CSS)
      panel.style.cssText = "background:rgba(70,130,255,0.08);border:1px solid rgba(70,130,255,0.22);border-radius:14px;padding:12px 14px;margin:12px auto;max-width:1200px;color:#e9edf6;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial;";
      // add pill style if missing
      if (!document.getElementById("vsp-pill-style")) {
        const st = _vspEl("style", {id:"vsp-pill-style"}, `
          .vsp-pill{display:inline-block;padding:5px 10px;border-radius:999px;
          background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.14);
          font-size:12px;opacity:.92;}
        `);
        document.head.appendChild(st);
      }

      // insert near top
      try {
        if (anchor && anchor.firstChild) anchor.insertBefore(panel, anchor.firstChild);
        else anchor.appendChild(panel);
      } catch(e) {
        document.body.insertBefore(panel, document.body.firstChild);
      }
      console.log("[VSP][P2] settings commercial panel injected");
    } catch(e) {
      console.warn("[VSP][P2] settings panel inject failed:", e);
    }
  }

  if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", _vspTryMountSettingsPanel);
  else _vspTryMountSettingsPanel();
})();


/* VSP_P2_RULE_OVERRIDES_SAVE_BAR_V1 */
(function(){
  function _vspEl(tag, attrs, html){
    const e = document.createElement(tag);
    if (attrs) for (const k of Object.keys(attrs)) e.setAttribute(k, attrs[k]);
    if (html != null) e.innerHTML = html;
    return e;
  }

  function _pickStringKey(obj){
    if (!obj || typeof obj !== "object") return null;
    const prefer = ["text","content","raw","rules","overrides","yaml","json","data","value","body"];
    for (const k of prefer) if (typeof obj[k] === "string") return k;
    // fallback: first string field
    for (const k of Object.keys(obj)) if (typeof obj[k] === "string") return k;
    return null;
  }

  async function _ensureRuleOverridesBar(){
    try {
      if (location.pathname !== "/rule_overrides") return;
      if (document.getElementById("vsp-ro-savebar")) return;

      const anchor = document.querySelector("#vsp-rule-overrides-main") || document.querySelector("main") || document.body;

      // find textarea (existing editor) or create one
      let ta = document.querySelector("textarea");
      if (!ta) {
        ta = _vspEl("textarea", {id:"vsp-ro-textarea"}, "");
        ta.style.cssText = "width:100%;min-height:360px;background:rgba(0,0,0,0.25);border:1px solid rgba(255,255,255,0.18);border-radius:12px;padding:10px;color:#e9edf6;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,'Liberation Mono','Courier New',monospace;font-size:12px;line-height:1.45;";
        anchor.appendChild(ta);
      }

      const bar = _vspEl("div", {id:"vsp-ro-savebar"}, `
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;">
          <div style="font-weight:800;">Rule Overrides</div>
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
            <button id="vsp-ro-reload" type="button">Reload</button>
            <button id="vsp-ro-save" type="button">Save</button>
            <span id="vsp-ro-status" style="opacity:.8;font-size:12px;"></span>
          </div>
        </div>
      `);
      bar.style.cssText = "background:rgba(0,255,170,0.06);border:1px solid rgba(0,255,170,0.20);border-radius:14px;padding:10px 12px;margin:12px auto;max-width:1200px;color:#e9edf6;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial;";

      // button style
      const st = _vspEl("style", {id:"vsp-ro-btn-style"}, `
        #vsp-ro-savebar button{padding:7px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.18);
          background:rgba(255,255,255,0.08);color:#e9edf6;cursor:pointer;}
        #vsp-ro-savebar button:hover{background:rgba(255,255,255,0.12);}
      `);
      document.head.appendChild(st);

      try {
        if (anchor && anchor.firstChild) anchor.insertBefore(bar, anchor.firstChild);
        else anchor.appendChild(bar);
      } catch(e) {
        document.body.insertBefore(bar, document.body.firstChild);
      }

      const status = document.getElementById("vsp-ro-status");
      const setStatus = (t, isErr=false)=>{ if(status) status.textContent = t; if(status) status.style.opacity=isErr? "1":"0.85"; };

      let apiKey = null;

      async function load() {
        setStatus("Loading...");
        const j = await fetch("/api/ui/rule_overrides_v2", {credentials:"same-origin"}).then(r=>r.json());
        apiKey = _pickStringKey(j);
        if (apiKey && typeof j[apiKey] === "string") {
          ta.value = j[apiKey];
          setStatus("Loaded ("+apiKey+")");
        } else {
          // if server returns structured JSON, store pretty text
          ta.value = JSON.stringify(__vspRO_norm(j), null, 2);
          setStatus("Loaded (json)");
        }
      }

      async function save() {
        setStatus("Saving...");
        let payload = null;
        if (apiKey) {
          payload = {[apiKey]: ta.value};
        } else {
          // fallback - try common key
          payload = {text: ta.value};
        }
        const res = await fetch("/api/ui/rule_overrides_v2", {
          method: "POST",
          credentials: "same-origin",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify(__vspRO_norm(payload)),
        });
        const txt = await res.text();
        if (res.ok) {
          setStatus("Saved ✓");
        } else {
          setStatus("Save failed: HTTP "+res.status, true);
          console.warn("[VSP][P2] rule_overrides save failed:", res.status, txt.slice(0,300));
        }
      }

      document.getElementById("vsp-ro-reload")?.addEventListener("click", ()=>load().catch(e=>setStatus("Load error", true)));
      document.getElementById("vsp-ro-save")?.addEventListener("click", ()=>save().catch(e=>setStatus("Save error", true)));

      await load();
      console.log("[VSP][P2] rule_overrides save bar injected");
    } catch(e) {
      console.warn("[VSP][P2] rule_overrides inject failed:", e);
    }
  }

  if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", _ensureRuleOverridesBar);
  else _ensureRuleOverridesBar();
})();


/* VSP_P2_RULE_OVERRIDES_SAVE_CONTRACT_RULES_V1C
   Backend:
     GET  /api/ui/rule_overrides_v2 -> {"ok":true,"schema":"rules_v1","rules":[...],...}
     POST /api/ui/rule_overrides_v2 expects same shape (schema + rules at least)
*/
(function(){
  async function roFix(){
    try{
      if (location.pathname !== "/rule_overrides") return;

      var btnSave = document.getElementById("vsp-ro-save");
      var btnReload = document.getElementById("vsp-ro-reload");
      var ta = document.querySelector("textarea");
      var status = document.getElementById("vsp-ro-status");

      if (!btnSave || !btnReload || !ta) return;

      function setStatus(t, isErr){
        if (!status) return;
        status.textContent = t;
        status.style.opacity = isErr ? "1" : "0.85";
      }

      var schema = "rules_v1";

      async function loadRules(){
        setStatus("Loading...", false);
        var j = await fetch("/api/ui/rule_overrides_v2", {credentials:"same-origin"}).then(function(r){return r.json();});
        schema = (j && j.schema) ? j.schema : "rules_v1";
        var rules = (j && Array.isArray(j.rules)) ? j.rules : [];
        ta.value = JSON.stringify((Array.isArray(rules)?{schema:"rules_v1",rules:rules}:__vspRO_norm(rules)), null, 2);
        setStatus("Loaded (" + schema + "), rules=" + rules.length, false);
      }

      async function saveRules(){
        setStatus("Saving...", false);
        var parsed;
        try{
          parsed = JSON.parse(ta.value || "[]");
        }catch(e){
          setStatus("Textarea is not valid JSON", true);
          return;
        }

        var rules = [];
        if (Array.isArray(parsed)) rules = parsed;
        else if (parsed && Array.isArray(parsed.rules)) rules = parsed.rules;
        else{
          setStatus("JSON must be an array or object with 'rules' array", true);
          return;
        }

        var payload = {schema: (schema || "rules_v1"), rules: rules, notes: "ui"};
        var res = await fetch("/api/ui/rule_overrides_v2", {
          method: "POST",
          credentials: "same-origin",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify(__vspRO_norm(payload))
        });

        var txt = await res.text();
        if (!res.ok){
          setStatus("Save failed HTTP " + res.status, true);
          try{ console.warn("[VSP][P2] rule_overrides save failed:", res.status, txt.slice(0,300)); }catch(e){}
          return;
        }

        // try parse {ok:true}
        try{
          var j2 = JSON.parse(txt);
          if (j2 && j2.ok === true) setStatus("Saved ✓ rules=" + rules.length, false);
          else setStatus("Saved (server response not ok?)", false);
        }catch(e){
          setStatus("Saved ✓ rules=" + rules.length, false);
        }
      }

      // Override handlers at capture phase (stop older injected handlers)
      btnReload.addEventListener("click", function(ev){
        ev.preventDefault(); ev.stopImmediatePropagation();
        loadRules().catch(function(){ setStatus("Load error", true); });
      }, true);

      btnSave.addEventListener("click", function(ev){
        ev.preventDefault(); ev.stopImmediatePropagation();
        saveRules().catch(function(){ setStatus("Save error", true); });
      }, true);

      if (!window.__VSP_RO_FIX_V1C__){
        window.__VSP_RO_FIX_V1C__ = 1;
        loadRules().catch(function(){});
        try{ console.log("[VSP][P2] rule_overrides save contract fixed (rules_v1) v1c"); }catch(e){}
      }
    }catch(e){
      try{ console.warn("[VSP][P2] roFix v1c error:", e); }catch(_e){}
    }
  }

  if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", roFix);
  else roFix();
})();


/* VSP_P0_SETTINGS_RENDER_TOOLS_TABLE_V1
   Render a real tools table on /settings using /api/ui/settings_v2
*/
(function(){
  function el(tag, cls, html){
    var d=document.createElement(tag);
    if (cls) d.className=cls;
    if (html!=null) d.innerHTML=html;
    return d;
  }
  function cssOnce(){
    if (document.getElementById("vsp-settings-tools-style")) return;
    var st=el("style", null, `
      .vsp-tools-wrap{margin-top:12px;padding:14px;border-radius:16px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.03)}
      .vsp-tools-h{display:flex;align-items:center;justify-content:space-between;gap:10px}
      .vsp-tools-title{font-weight:800;font-size:14px;opacity:.92}
      .vsp-tools-sub{font-size:12px;opacity:.75;margin-top:4px;line-height:1.35}
      .vsp-tools-meta{font-size:11px;opacity:.7}
      .vsp-tools-table{width:100%;border-collapse:separate;border-spacing:0;margin-top:10px;overflow:hidden;border-radius:14px}
      .vsp-tools-table th{font-size:11px;letter-spacing:.02em;text-transform:uppercase;opacity:.75;padding:10px 10px;background:rgba(0,0,0,.25);border-bottom:1px solid rgba(255,255,255,.08);text-align:left}
      .vsp-tools-table td{padding:10px 10px;border-bottom:1px solid rgba(255,255,255,.06);font-size:12px;opacity:.92}
      .vsp-pill{display:inline-flex;align-items:center;gap:6px;padding:3px 10px;border-radius:999px;font-size:11px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.18)}
      .vsp-dot{width:8px;height:8px;border-radius:50%;background:rgba(255,255,255,.35)}
      .vsp-dot.on{background:rgba(140,255,170,.9)}
      .vsp-dot.off{background:rgba(255,120,120,.9)}
      .vsp-mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
      .vsp-right{margin-left:auto}
      .vsp-btn{cursor:pointer;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.2);color:inherit;padding:6px 10px;border-radius:12px;font-size:12px;opacity:.9}
      .vsp-btn:hover{opacity:1}
    `);
    st.id="vsp-settings-tools-style";
    document.head.appendChild(st);
  }

  async function getJSON(url){
    try{
      var r=await fetch(url,{credentials:"same-origin"});
      return await r.json();
    }catch(e){ return null; }
  }

  function pickSettingsMount(){
    // Try common containers: a main content div, or fallback to body
    return document.querySelector("#vsp-settings-main")
      || document.querySelector("#vsp-settings")
      || document.querySelector(".vsp-settings-main")
      || document.querySelector("main")
      || document.body;
  }

  function renderTable(mount, data){
    cssOnce();
    if (document.getElementById("vsp-tools-wrap")) return;

    var wrap=el("div","vsp-tools-wrap","");
    wrap.id="vsp-tools-wrap";

    var h=el("div","vsp-tools-h","");
    var left=el("div","", "");
    left.appendChild(el("div","vsp-tools-title","Tool Coverage & Policy"));
    var sub="Live data from <span class='vsp-mono'>/api/ui/settings_v2</span>.";
    if (data && data.ui && data.ui.kpi_mode) sub += " KPI mode: <span class='vsp-mono'>"+data.ui.kpi_mode+"</span>.";
    left.appendChild(el("div","vsp-tools-sub",sub));
    h.appendChild(left);

    var meta=el("div","vsp-tools-meta vsp-right","");
    var via = (data && (data.__via__ || data.notes || data.source)) ? (data.__via__ || data.notes || data.source) : "-";
    meta.innerHTML = "source: <span class='vsp-mono'>"+ String(via).slice(0,120) +"</span>";
    h.appendChild(meta);

    var btn=el("button","vsp-btn","Refresh");
    btn.onclick = async function(){
      var d = await getJSON("/api/ui/settings_v2");
      if (!d || !d.tools){ alert("settings_v2 unavailable"); return; }
      // simple refresh: remove + re-render
      try{ wrap.remove(); }catch(e){}
      renderTable(pickSettingsMount(), d);
    };
    h.appendChild(btn);

    wrap.appendChild(h);

    var tbl=el("table","vsp-tools-table","");
    var thead=el("thead","", "");
    thead.appendChild(el("tr","",
      "<th>Tool</th><th>Enabled</th><th>Timeout</th><th>Degrade</th><th>Notes</th>"
    ));
    tbl.appendChild(thead);

    var tb=el("tbody","", "");
    var tools = (data && data.tools) ? data.tools : {};
    var order = ["BANDIT","SEMGREP","GITLEAKS","KICS","TRIVY","SYFT","GRYPE","CODEQL"];
    order.forEach(function(tid){
      var t = tools[tid] || {};
      var en = !!t.enabled;
      var dot = "<span class='vsp-dot "+(en?"on":"off")+"'></span>";
      var pill = "<span class='vsp-pill'>"+dot+(en?"Enabled":"Disabled")+"</span>";
      var tout = (t.timeout_sec==null || t.timeout_sec==="") ? "-" : String(t.timeout_sec)+"s";
      var deg = (t.degrade_on_fail===false) ? "No" : "Yes";
      var notes = (t.notes||"").toString();
      var tr=el("tr","",
        "<td class='vsp-mono'>"+tid+"</td>"+
        "<td>"+pill+"</td>"+
        "<td class='vsp-mono'>"+tout+"</td>"+
        "<td>"+deg+"</td>"+
        "<td>"+(notes ? notes.replace(/[<>]/g,"") : "-")+"</td>"
      );
      tb.appendChild(tr);
    });
    tbl.appendChild(tb);
    wrap.appendChild(tbl);

    // insert near top of settings page
    mount.prepend(wrap);
  }

  async function init(){
    try{
      if (location.pathname !== "/settings") return;
      // wait for page JS to build layout
      for (var i=0;i<12;i++){
        await new Promise(r=>setTimeout(r,120));
        var mount = pickSettingsMount();
        if (mount) break;
      }
      var d = await getJSON("/api/ui/settings_v2");
      if (!d || !d.tools){
        var mount = pickSettingsMount();
        if (!mount) return;
        cssOnce();
        var warn=el("div","vsp-tools-wrap","<div class='vsp-tools-title'>Tool Coverage & Policy</div><div class='vsp-tools-sub'>settings_v2 unavailable. (degraded)</div>");
        warn.id="vsp-tools-wrap";
        mount.prepend(warn);
        return;
      }
      renderTable(pickSettingsMount(), d);
    }catch(e){}
  }

  if (document.readyState==="loading") document.addEventListener("DOMContentLoaded", init);
  else init();
})();

/* VSP_SAFE_INTERVAL_V1 */

/* VSP_SAFE_INTERVAL_V1 */
(function(){
  try{
    // default: live OFF, only ON if /vsp5?live=1
    if (typeof window.__VSP_SAFE_LIVE === "undefined") {
      var sp = new URLSearchParams(location.search||"");
      window.__VSP_SAFE_LIVE = (sp.get("live")==="1");
    }
    window.__vspSafeInterval = window.__vspSafeInterval || function(fn, ms){
      var safeMs = Math.max(parseInt(ms||0,10) || 0, 2000);
      return window.__vspSafeInterval(function(){
        try{
          if (document.hidden) return;
          if (window.__VSP_SAFE_LIVE === false) return;
          fn && fn();
        }catch(e){
          console.warn("[VSP_SAFE_INTERVAL]", e);
        }
      }, safeMs);
    };
    window.__vspSafeTimeout = window.__vspSafeTimeout || function(fn, ms){
      var safeMs = Math.max(parseInt(ms||0,10) || 0, 200);
      return setTimeout(function(){
        try{
          if (window.__VSP_SAFE_LIVE === false && safeMs < 800) return;
          fn && fn();
        }catch(e){
          console.warn("[VSP_SAFE_TIMEOUT]", e);
        }
      }, safeMs);
    };
  }catch(e){
    console.warn("[VSP_SAFE_INIT]", e);
  }
})();

/* VSP_SAFE_INTERVAL_V2 */
(function(){
  try{
    var nativeSI = (window.__vspNativeSetInterval) ? window.__vspNativeSetInterval : window.setInterval.bind(window);
    // commercial-safe clamp: >=800ms, <=30000ms
    window.__vspSafeInterval = function(fn, ms){
      var v = Number(ms);
      if(!isFinite(v)) v = 0;
      if(v < 800) v = 800;
      if(v > 30000) v = 30000;
      return nativeSI(fn, v);
    };
  }catch(e){}
})();


/* VSP_COMMERCE_UI5_LOADER_V1 */
(function(){
  try{
    var p = (location && location.pathname) ? String(location.pathname) : "";
    if (!p.startsWith("/c/")) return;
    // CSS
    var l=document.createElement("link");
    l.rel="stylesheet";
    l.href="/static/css/vsp_commercial_ui5_v1.css?v=" + (window.__VSP_ASSET_V || Date.now());
    document.head.appendChild(l);
    // JS
    var sc=document.createElement("script");
    sc.src="/static/js/vsp_commercial_ui5_v1.js?v=" + (window.__VSP_ASSET_V || Date.now());
    sc.defer=true;
    document.head.appendChild(sc);
  }catch(e){}
})();


/* ===== VSP_P1_DASH_MINICHARTS_V12B_PREFER_PAGE_RID_V1 ===== */
(function(){
  try{
    var qs = new URLSearchParams(location.search || "");
    var mcdebug = qs.get("mcdebug") === "1";
    var mcforce = qs.get("mcforce") === "1";

    try{
      if(mcforce){
        try{ localStorage.removeItem("vsp_minicharts_off"); }catch(e){}
      }
      if(!mcforce){
        try{
          if(localStorage.getItem("vsp_minicharts_off") === "1"){ return; }
        }catch(e){}
      }
    }catch(e){}

    function log(){
      if(!mcdebug) return;
      try{ console.log.apply(console, ["[minicharts_v12b]"].concat([].slice.call(arguments))); }catch(e){}
    }

    function getPageRid(){
      try{
        var rid = (new URLSearchParams(location.search||"")).get("rid") || "";
        rid = String(rid||"").trim();
        if(!rid) return "";
        if(rid === "YOUR_RID") return "";
        if(rid.toLowerCase() === "null" || rid.toLowerCase() === "undefined") return "";
        return rid;
      }catch(e){ return ""; }
    }

    function safeText(x){ return (x==null) ? "" : String(x); }

    function buildPanel(){
      var panel = document.getElementById("__vsp_minicharts_v12b");
      if(panel) return panel;

      panel = document.createElement("div");
      panel.id="__vsp_minicharts_v12b";
      panel.style.position="fixed";
      panel.style.right="16px";
      panel.style.bottom="16px";
      panel.style.width="360px";
      panel.style.maxWidth="calc(100vw - 32px)";
      panel.style.zIndex="99999";
      panel.style.border="1px solid rgba(255,255,255,0.08)";
      panel.style.borderRadius="12px";
      panel.style.background="rgba(10,14,22,0.92)";
      panel.style.backdropFilter="blur(8px)";
      panel.style.boxShadow="0 10px 30px rgba(0,0,0,0.45)";
      panel.style.color="rgba(255,255,255,0.86)";
      panel.style.fontFamily="ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif";
      panel.style.fontSize="12px";
      panel.style.overflow="hidden";

      var head = document.createElement("div");
      head.style.display="flex";
      head.style.alignItems="center";
      head.style.justifyContent="space-between";
      head.style.padding="10px 10px 8px 10px";
      head.style.borderBottom="1px solid rgba(255,255,255,0.06)";

      var title = document.createElement("div");
      title.innerHTML = '<div style="font-weight:700; letter-spacing:0.2px">Mini Charts</div>'
                      + '<div id="__vsp_minicharts_v12b_meta" style="margin-top:2px; opacity:0.75; font-size:11px">loading…</div>';

      var btn = document.createElement("button");
      btn.textContent="×";
      btn.title="Hide (persist)";
      btn.style.border="1px solid rgba(255,255,255,0.10)";
      btn.style.background="rgba(255,255,255,0.04)";
      btn.style.color="rgba(255,255,255,0.85)";
      btn.style.borderRadius="10px";
      btn.style.width="34px";
      btn.style.height="26px";
      btn.style.cursor="pointer";
      btn.onclick=function(){
        try{ localStorage.setItem("vsp_minicharts_off","1"); }catch(e){}
        try{ panel.remove(); }catch(e){}
      };

      head.appendChild(title);
      head.appendChild(btn);

      var body = document.createElement("div");
      body.id="__vsp_minicharts_v12b_body";
      body.style.padding="10px";
      body.style.maxHeight="40vh";
      body.style.overflow="auto";

      panel.appendChild(head);
      panel.appendChild(body);

      try{ document.body.appendChild(panel); }catch(e){}
      return panel;
    }

    function barRow(label, val, total){
      var pct = (total>0) ? Math.round((val*1000)/total)/10 : 0; // 1 decimal
      var row = document.createElement("div");
      row.style.display="grid";
      row.style.gridTemplateColumns="90px 1fr 52px";
      row.style.gap="8px";
      row.style.alignItems="center";
      row.style.margin="6px 0";

      var l = document.createElement("div");
      l.textContent = label;
      l.style.opacity="0.85";

      var track = document.createElement("div");
      track.style.height="10px";
      track.style.borderRadius="999px";
      track.style.background="rgba(255,255,255,0.08)";
      track.style.overflow="hidden";

      var fill = document.createElement("div");
      fill.style.height="100%";
      fill.style.width = Math.max(0, Math.min(100, pct)) + "%";
      fill.style.background="rgba(130,190,255,0.75)";
      track.appendChild(fill);

      var r = document.createElement("div");
      r.style.textAlign="right";
      r.style.opacity="0.82";
      r.textContent = val + " (" + pct + "%)";

      row.appendChild(l); row.appendChild(track); row.appendChild(r);
      return row;
    }

    function renderFromItems(items, pageRid, apiRid){
      var panel = buildPanel();
      var meta = panel.querySelector("#__vsp_minicharts_v12b_meta");
      var body = panel.querySelector("#__vsp_minicharts_v12b_body");
      if(meta) meta.textContent = "RID(page)=" + (pageRid||"(none)") + " • RID(api)=" + (apiRid||"(none)") + " • n=" + (items?items.length:0);

      if(!body) return;
      body.innerHTML = "";

      var total = items.length || 0;
      if(total <= 0){
        body.textContent = "No data (items=0).";
        return;
      }

      var sevOrder = ["CRITICAL","HIGH","MEDIUM","LOW","INFO","TRACE"];
      var sevCount = {};
      for(var i=0;i<sevOrder.length;i++) sevCount[sevOrder[i]]=0;

      var toolCount = {}; // only HIGH/CRITICAL
      for(var k=0;k<items.length;k++){
        var it = items[k] || {};
        var sev = safeText(it.severity).toUpperCase().trim();
        if(!sev) continue;
        if(sevCount.hasOwnProperty(sev)) sevCount[sev] += 1;

        if(sev === "CRITICAL" || sev === "HIGH"){
          var t = safeText(it.tool).toLowerCase().trim() || "unknown";
          toolCount[t] = (toolCount[t]||0) + 1;
        }
      }

      var h = document.createElement("div");
      h.textContent = "Severity Distribution";
      h.style.fontWeight="700";
      h.style.margin="2px 0 8px 0";
      body.appendChild(h);

      for(var j=0;j<sevOrder.length;j++){
        var sname = sevOrder[j];
        var v = sevCount[sname] || 0;
        body.appendChild(barRow(sname, v, total));
      }

      var h2 = document.createElement("div");
      h2.textContent = "Critical/High by Tool";
      h2.style.fontWeight="700";
      h2.style.margin="12px 0 6px 0";
      body.appendChild(h2);

      var entries = Object.entries(toolCount).sort(function(a,b){ return (b[1]||0) - (a[1]||0); }).slice(0,10);
      if(entries.length === 0){
        var em = document.createElement("div");
        em.textContent = "(none)";
        em.style.opacity="0.75";
        body.appendChild(em);
      }else{
        var sum = entries.reduce(function(acc,x){ return acc + (x[1]||0); }, 0);
        for(var z=0; z<entries.length; z++){
          body.appendChild(barRow(entries[z][0], entries[z][1]||0, sum));
        }
      }
    }

    async function run(){
      var pageRid = getPageRid();
      var url = "/api/vsp/top_findings_v2?limit=200";
      if(pageRid){
        url += "&rid=" + encodeURIComponent(pageRid);
      }

      var panel = buildPanel();
      var meta = panel.querySelector("#__vsp_minicharts_v12b_meta");
      var body = panel.querySelector("#__vsp_minicharts_v12b_body");
      if(meta) meta.textContent = "loading… " + url;
      if(body) body.textContent = "Loading…";

      try{
        var res = await fetch(url, {credentials:"same-origin", cache:"no-store"});
        if(!res.ok){
          if(body) body.textContent = "HTTP " + res.status + " for " + url;
          log("http_fail", res.status, url);
          return;
        }
        var j = await res.json();
        var items = (j && j.items) ? j.items : [];
        var apiRid = (j && j.rid) ? String(j.rid) : "";
        log("ok", "pageRid=", pageRid, "apiRid=", apiRid, "items=", items.length);
        renderFromItems(items, pageRid, apiRid);
      }catch(e){
        if(body) body.textContent = "Fetch/parse error: " + (e && e.message ? e.message : String(e));
        log("err", e);
      }
    }

    setTimeout(run, 450);
  }catch(e){}
})();


/* ===== VSP_P1_MINICHARTS_USE_TOPFIND_V2_V1 ===== */
try{
  window.__VSP_TOPFIND_ENDPOINT = "/api/vsp/top_findings_v2";
}catch(e){}

