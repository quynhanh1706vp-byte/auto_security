/* VSP_P120_C_COMMON_SHIM_V1
 * Purpose:
 * - Provide a stable global window.VSPC for /c/* suite
 * - Fix: "Cannot read properties of undefined (reading 'onRefresh')"
 * - Provide refresh event bus + RID resolution (latest) + fetchJSON with timeout
 */
(function(){
  'use strict';

  const log = (...a)=>{ try{ console.log('[VSPC]', ...a); }catch(e){} };
  const warn = (...a)=>{ try{ console.warn('[VSPC]', ...a); }catch(e){} };

  function qs(sel, root){ return (root||document).querySelector(sel); }
  function qsa(sel, root){ return Array.from((root||document).querySelectorAll(sel)); }

  function sanitizeRid(x){
    x = (x||'').toString().trim();
    // allow VSP_CI_YYYYmmdd_HHMMSS and RUN_* style, block accidental "VSP_FILL_..." junk
    if(!x) return '';
    if(x.length > 128) return '';
    if(!/^[A-Za-z0-9_.:-]+$/.test(x)) return '';
    if(/^VSP_FILL_/i.test(x)) return '';
    return x;
  }

  function getUrlParam(name){
    try{
      const u = new URL(window.location.href);
      return u.searchParams.get(name) || '';
    }catch(e){ return ''; }
  }

  function setUrlParam(name, value){
    try{
      const u = new URL(window.location.href);
      if(value) u.searchParams.set(name, value);
      else u.searchParams.delete(name);
      history.replaceState({}, '', u.toString());
    }catch(e){}
  }

  async function fetchJSON(url, opt){
    opt = opt || {};
    const timeoutMs = opt.timeoutMs || 2500;
    const ctrl = new AbortController();
    const t = setTimeout(()=>ctrl.abort(), timeoutMs);
    try{
      const r = await fetch(url, {signal: ctrl.signal, cache:'no-store', credentials:'same-origin'});
      const ct = (r.headers.get('content-type')||'').toLowerCase();
      const txt = await r.text();
      let j = null;
      if(ct.includes('application/json')){
        try{ j = JSON.parse(txt); }catch(e){ j = null; }
      }else{
        // best effort JSON parse
        try{ j = JSON.parse(txt); }catch(e){ j = null; }
      }
      return {ok: r.ok, status: r.status, json: j, text: txt, headers: r.headers};
    }catch(e){
      return {ok:false, status:0, json:null, text:String(e)};
    }finally{
      clearTimeout(t);
    }
  }

  async function resolveLatestRid(base){
    const url = `${base}/api/ui/runs_v3?limit=1&include_ci=1`;
    const r = await fetchJSON(url, {timeoutMs: 2500});
    try{
      const rid = sanitizeRid(r.json && r.json.items && r.json.items[0] && r.json.items[0].rid);
      return rid || '';
    }catch(e){ return ''; }
  }

  function dispatchRefresh(){
    try{
      window.dispatchEvent(new CustomEvent('vsp:refresh', {detail:{ts: Date.now()}}));
    }catch(e){}
  }

  function onRefresh(fn){
    window.addEventListener('vsp:refresh', (ev)=>{ try{ fn(ev); }catch(e){} });
  }

  function ensureHeaderHook(){
    // try attach refresh button (id-based first, fallback by text)
    const btn = qs('#b-refresh') || qsa('button').find(b => (b.textContent||'').trim().toUpperCase() === 'REFRESH');
    if(btn && !btn.__vspc_bound){
      btn.__vspc_bound = 1;
      btn.addEventListener('click', ()=>dispatchRefresh());
    }
  }

  function setText(id, txt){
    const el = qs('#'+id);
    if(el) el.textContent = (txt==null?'':String(txt));
  }

  const base = (function(){
    try{ return window.location.origin; }catch(e){ return ''; }
  })();

  // Export global
  window.VSPC = window.VSPC || {};
  Object.assign(window.VSPC, {
    ver: 'P120',
    base,
    sanitizeRid,
    getUrlParam,
    setUrlParam,
    fetchJSON,
    resolveLatestRid,
    onRefresh,
    dispatchRefresh,
    setText,
    ensureHeaderHook
  });

  // bind header on load
  document.addEventListener('DOMContentLoaded', ()=>{
    try{
      ensureHeaderHook();
      log('installed', window.VSPC.ver);
    }catch(e){}
  });
})();


/* VSP_P122_POLISH_C_SUITE_COLORS_AND_RUNS_V1
 * - Make /c/* look consistent (dark pill buttons instead of blue links)
 * - Auto-style action links in Runs tab (Dashboard/CSV/Reports.tgz/Use RID...)
 */
(function(){
  try{
    var path = (location && location.pathname) ? String(location.pathname) : "";
    var page = "";
    if (path.startsWith("/c/")) {
      var seg = path.split("/").filter(Boolean);
      page = "c-" + (seg[1] || "dashboard");
    }
    // dataset markers for CSS targeting
    try{
      document.documentElement.dataset.vspSuite = "c";
      document.documentElement.dataset.vspPage = page;
      if (document.body){
        document.body.dataset.vspSuite = "c";
        document.body.dataset.vspPage = page;
      }
    }catch(_){}

    // inject CSS once
    var STYLE_ID="VSP_P122_STYLE";
    if (!document.getElementById(STYLE_ID)){
      var st=document.createElement("style");
      st.id=STYLE_ID;
      st.textContent = `
/* --- P122 C-suite theme polish --- */
[data-vsp-suite="c"] a{ color:rgba(210,225,255,.92); text-decoration:none; }
[data-vsp-suite="c"] a:hover{ text-decoration:underline; }

/* generic pill for action links (we add class in JS too) */
[data-vsp-suite="c"] a.vsp-btnlink{
  display:inline-block;
  padding:4px 10px;
  margin-right:6px;
  border-radius:999px;
  background:rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.14);
  color:rgba(235,242,255,.95);
  text-decoration:none !important;
  font-size:12px;
  line-height:1.2;
}
[data-vsp-suite="c"] a.vsp-btnlink:hover{
  background:rgba(255,255,255,.10);
  border-color:rgba(255,255,255,.22);
}

/* button polish (Use RID etc) */
[data-vsp-suite="c"] button.vsp-btn{
  padding:5px 10px;
  border-radius:999px;
  background:rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.14);
  color:rgba(235,242,255,.95);
  cursor:pointer;
}
[data-vsp-suite="c"] button.vsp-btn:hover{
  background:rgba(255,255,255,.10);
  border-color:rgba(255,255,255,.22);
}
[data-vsp-suite="c"] button.vsp-btn.vsp-btn-mini{
  padding:4px 10px;
  font-size:12px;
}

/* Runs tab: treat table links like buttons even if no class */
[data-vsp-page="c-runs"] table a{
  display:inline-block;
  padding:4px 10px;
  margin-right:6px;
  border-radius:999px;
  background:rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.14);
  color:rgba(235,242,255,.95);
  text-decoration:none !important;
  font-size:12px;
  line-height:1.2;
}
[data-vsp-page="c-runs"] table a:hover{
  background:rgba(255,255,255,.10);
  border-color:rgba(255,255,255,.22);
}

/* soften “link blue” in headers/toolstrips */
[data-vsp-suite="c"] .vsp-toolbar a,
[data-vsp-suite="c"] .toolbar a{
  display:inline-block;
  padding:4px 10px;
  border-radius:999px;
  background:rgba(255,255,255,.05);
  border:1px solid rgba(255,255,255,.12);
  color:rgba(235,242,255,.95);
  text-decoration:none !important;
  font-size:12px;
}
[data-vsp-suite="c"] .vsp-toolbar a:hover,
[data-vsp-suite="c"] .toolbar a:hover{
  background:rgba(255,255,255,.10);
  border-color:rgba(255,255,255,.22);
}
      `;
      document.head.appendChild(st);
    }

    // JS class helper: “button-hoá” một số link action phổ biến
    var WANT = {
      "dashboard":1, "csv":1, "reports.tgz":1, "reports":1, "html":1, "sarif":1, "summary":1, "open":1, "sha":1, "use rid":1
    };

    var _scheduled = false;
    function polish(){
      _scheduled = false;
      try{
        var as = document.querySelectorAll("a");
        for (var i=0;i<as.length;i++){
          var a=as[i];
          var t=(a.textContent||"").trim().toLowerCase();
          if (WANT[t]) a.classList.add("vsp-btnlink");
        }
        var bs = document.querySelectorAll("button");
        for (var j=0;j<bs.length;j++){
          var b=bs[j];
          var tb=(b.textContent||"").trim().toLowerCase();
          if (tb==="use rid" || tb==="refresh" || tb==="load" || tb==="save" || tb==="export"){
            b.classList.add("vsp-btn","vsp-btn-mini");
          }
        }
      }catch(_){}
    }
    function schedule(){
      if (_scheduled) return;
      _scheduled = true;
      (window.requestAnimationFrame||setTimeout)(polish, 16);
    }

    schedule();
    window.addEventListener("load", schedule, {once:true});
    try{
      new MutationObserver(schedule).observe(document.documentElement, {subtree:true, childList:true});
    }catch(_){}
  }catch(e){
    try{ console.warn("[P122] polish failed", e); }catch(_){}
  }
})();


/* ===== VSP_P123_POLISH_CSUITE_LAYOUT_V1 ===== */
;(function(){
  if (window.__VSP_P123__) return;
  window.__VSP_P123__ = 1;

  function onReady(fn){
    if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", fn, {once:true});
    else fn();
  }

  function addStyle(id, css){
    if (document.getElementById(id)) return;
    const st = document.createElement("style");
    st.id = id;
    st.textContent = css;
    document.head.appendChild(st);
  }

  function normText(el){
    return (el && el.textContent ? el.textContent.trim().toLowerCase() : "");
  }

  function hideLegacyTables(){
    // Hide tables that look like legacy header tables (only <thead> or very few rows)
    const tables = Array.from(document.querySelectorAll("table"));
    for (const t of tables){
      try{
        const ths = Array.from(t.querySelectorAll("thead th")).map(x=>normText(x)).filter(Boolean);
        const rows = t.querySelectorAll("tbody tr").length;
        const looksLikeLegacyHeader =
          ths.length >= 4 && ths.includes("rid") && (ths.includes("actions") || ths.includes("overall") || ths.includes("summary"));
        if (looksLikeLegacyHeader && rows <= 1){
          t.style.display = "none";
        }
      }catch(_){}
    }
  }

  function decorateActionChips(){
    // Turn all “action” links/buttons into consistent chips (Runs tab is the biggest win)
    const els = Array.from(document.querySelectorAll("a,button"));
    for (const el of els){
      const t = normText(el);
      if (!t) continue;

      const isAction =
        ["dashboard","csv","reports.tgz","reports","sarif","html","summary","use rid","open","sha","refresh","load","save","export","json"].includes(t);

      if (!isAction) continue;

      el.classList.add("vsp-chip");
      if (t === "dashboard") el.classList.add("vsp-chip--primary");
      else if (t === "use rid") el.classList.add("vsp-chip--accent");
      else if (t === "refresh" || t === "load") el.classList.add("vsp-chip--ghost");
      else el.classList.add("vsp-chip--muted");
    }
  }

  function polishTables(){
    // Add classes to big tables to apply zebra/hover/spacing
    const tables = Array.from(document.querySelectorAll("table"));
    for (const t of tables){
      // Skip tiny layout tables (if any)
      const rows = t.querySelectorAll("tr").length;
      if (rows < 3) continue;
      t.classList.add("vsp-table");
    }
  }

  function collapseHugePre(){
    // Collapse very large <pre> blocks (Settings/Rule Overrides raw JSON) into <details>
    const pres = Array.from(document.querySelectorAll("pre"));
    for (const pre of pres){
      try{
        const txt = (pre.textContent || "").trim();
        if (!txt) continue;
        // Heuristic: looks like JSON and is long
        const looksJson = (txt.startsWith("{") && txt.endsWith("}")) || (txt.startsWith("[") && txt.endsWith("]"));
        const lines = txt.split("\n").length
        const VSP_P127_MINLINES = (/(?:^|\/)c\/(settings|rule_overrides)(?:$|)/.test((location.pathname||"")));
        const minLines = VSP_P127_MINLINES ? 8 : 30;
        if (!looksJson || lines < minLines) continue;

        // avoid double wrap
        if (pre.closest("details")) continue;

        const details = document.createElement("details");
        details.className = "vsp-details";
        details.open = false;

        const sum = document.createElement("summary");
        sum.textContent = "Raw JSON (click to expand)";
        details.appendChild(sum);

        // Keep the pre but constrain height
        pre.classList.add("vsp-pre");
        details.appendChild(pre.cloneNode(true));
        pre.replaceWith(details);
      }catch(_){}
    }
  }

  onReady(function(){
    addStyle("vsp-p123-style", `
      :root{
        --vsp-bg0:#0b1220;
        --vsp-bg1:#0f1a2d;
        --vsp-card:rgba(255,255,255,.035);
        --vsp-card2:rgba(255,255,255,.055);
        --vsp-border:rgba(255,255,255,.08);
        --vsp-border2:rgba(255,255,255,.12);
        --vsp-text:rgba(255,255,255,.86);
        --vsp-text2:rgba(255,255,255,.68);
        --vsp-blue:rgba(96,165,250,.95);
        --vsp-cyan:rgba(34,211,238,.92);
      }

      /* Tables */
      table.vsp-table{
        width:100%;
        border-collapse:separate;
        border-spacing:0;
        background:var(--vsp-card);
        border:1px solid var(--vsp-border);
        border-radius:14px;
        overflow:hidden;
      }
      table.vsp-table thead th{
        text-transform:uppercase;
        letter-spacing:.06em;
        font-size:11px;
        color:var(--vsp-text2);
        background:rgba(255,255,255,.03);
        border-bottom:1px solid var(--vsp-border);
        padding:10px 12px;
      }
      table.vsp-table tbody td{
        padding:10px 12px;
        border-bottom:1px solid rgba(255,255,255,.06);
        color:var(--vsp-text);
        font-size:12px;
      }
      table.vsp-table tbody tr:nth-child(odd){
        background:rgba(255,255,255,.018);
      }
      table.vsp-table tbody tr:hover{
        background:rgba(96,165,250,.08);
      }
      table.vsp-table tbody td:first-child{
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
        font-size:11.5px;
        color:rgba(255,255,255,.78);
      }

      /* Chips */
      .vsp-chip{
        display:inline-flex;
        align-items:center;
        justify-content:center;
        gap:6px;
        padding:5px 10px;
        margin-right:8px;
        border-radius:999px;
        border:1px solid var(--vsp-border2);
        background:rgba(255,255,255,.03);
        color:rgba(255,255,255,.86) !important;
        font-size:12px;
        line-height:1;
        text-decoration:none !important;
        cursor:pointer;
        transition:transform .08s ease, background .12s ease, border-color .12s ease;
      }
      .vsp-chip:hover{ transform:translateY(-1px); background:rgba(255,255,255,.06); border-color:rgba(255,255,255,.18); }
      .vsp-chip--primary{ border-color:rgba(96,165,250,.45); background:rgba(96,165,250,.12); }
      .vsp-chip--accent{ border-color:rgba(34,211,238,.45); background:rgba(34,211,238,.10); }
      .vsp-chip--muted{ border-color:rgba(255,255,255,.14); background:rgba(255,255,255,.035); }
      .vsp-chip--ghost{ border-color:rgba(255,255,255,.10); background:transparent; }

      /* Collapsible raw JSON */
      .vsp-details{
        background:var(--vsp-card);
        border:1px solid var(--vsp-border);
        border-radius:14px;
        padding:10px 12px;
        margin:10px 0;
      }
      .vsp-details > summary{
        cursor:pointer;
        color:var(--vsp-text2);
        font-size:12px;
        list-style:none;
      }
      .vsp-pre{
        max-height:420px;
        overflow:auto;
        margin-top:10px;
        padding:10px;
        border-radius:12px;
        border:1px solid rgba(255,255,255,.08);
        background:rgba(0,0,0,.22);
      }
    `);

    hideLegacyTables();
    polishTables();
    decorateActionChips();
    collapseHugePre();

    // Re-run after async renders (Runs/DataSource sometimes render later)
    setTimeout(function(){
      hideLegacyTables();
      polishTables();
      decorateActionChips();
      collapseHugePre();
    }, 350);
  });
})();



/* === VSP_P124_C_SUITE_RUNS_CONTRAST_V1 ===
   Goals:
   - Fix low-contrast visited links in Runs table
   - Make buttons (esp. Use RID) dark-theme instead of white
   - Clamp huge JSON <pre> blocks in Settings/Rule Overrides
*/
(function(){
  try{
    if (window.__VSP_P124_CSUITE__) return;
    window.__VSP_P124_CSUITE__ = 1;

    var css = `
/* --- palette knobs --- */
:root{
  --vspc-link: #86c5ff;
  --vspc-link-hover: #b7dcff;
  --vspc-btn-bg: rgba(255,255,255,0.06);
  --vspc-btn-bg-hover: rgba(255,255,255,0.10);
  --vspc-btn-bd: rgba(255,255,255,0.14);
  --vspc-btn-bd-hover: rgba(255,255,255,0.22);
  --vspc-text: rgba(255,255,255,0.88);
  --vspc-muted: rgba(255,255,255,0.68);
}

/* --- links: unify normal/visited to avoid purple shock --- */
.vsp-c a, .vspc a{
  color: var(--vspc-link) !important;
  text-decoration: none;
}
.vsp-c a:visited, .vspc a:visited{
  color: var(--vspc-link) !important;
}
.vsp-c a:hover, .vspc a:hover{
  color: var(--vspc-link-hover) !important;
  text-decoration: underline;
}

/* --- buttons: kill white default buttons --- */
.vsp-c button, .vspc button,
.vsp-c .btn, .vspc .btn{
  background: var(--vspc-btn-bg) !important;
  border: 1px solid var(--vspc-btn-bd) !important;
  color: var(--vspc-text) !important;
  border-radius: 10px !important;
  padding: 6px 10px !important;
  font-size: 12px !important;
  line-height: 1 !important;
  box-shadow: none !important;
}
.vsp-c button:hover, .vspc button:hover,
.vsp-c .btn:hover, .vspc .btn:hover{
  background: var(--vspc-btn-bg-hover) !important;
  border-color: var(--vspc-btn-bd-hover) !important;
}

/* --- Runs table: tighten actions look like pills --- */
.vsp-c table td a, .vsp-c table th a{
  display: inline-block;
  padding: 2px 8px;
  border-radius: 999px;
  background: rgba(255,255,255,0.04);
  border: 1px solid rgba(255,255,255,0.10);
  margin-right: 6px;
}
.vsp-c table td a:hover{
  background: rgba(255,255,255,0.08);
  border-color: rgba(255,255,255,0.18);
}

/* --- clamp huge JSON blocks --- */
.vsp-c pre, .vspc pre{
  max-height: 280px;
  overflow: auto;
  color: var(--vspc-text);
}
.vsp-c pre, .vspc pre{
  scrollbar-width: thin;
}

/* --- subtle table readability --- */
.vsp-c table{
  color: var(--vspc-text);
}
.vsp-c table tr{
  border-bottom: 1px solid rgba(255,255,255,0.06);
}
.vsp-c table tr:hover{
  background: rgba(255,255,255,0.03);
}
`;

    var st = document.getElementById("VSP_P124_STYLE");
    if(!st){
      st = document.createElement("style");
      st.id = "VSP_P124_STYLE";
      st.type = "text/css";
      st.appendChild(document.createTextNode(css));
      (document.head || document.documentElement).appendChild(st);
    }
  }catch(e){
    try{ console.warn("[VSPC] P124 inject failed:", e); }catch(_){}
  }
})();



/* VSP_P125_C_SUITE_CLEANUP_V1 */
(function(){
  try{
    if(!location.pathname.startsWith('/c/')) return;

    function hidePanelByNeedles(needles){
      const els = Array.from(document.querySelectorAll('div,section,article'));
      for(const el of els){
        const t = (el.innerText || '').trim();
        if(!t) continue;
        const hit = needles.every(nd => t.includes(nd));
        if(hit){
          // if it contains the big JSON block, hide the whole container
          if(el.querySelector('pre, textarea')){
            el.style.display = 'none';
            return true;
          }
        }
      }
      return false;
    }

    function p125(){
      const path = location.pathname;

      // Remove the "live JSON" top panels (rác) but keep the editor panels below.
      if(path === '/c/settings' || path.startsWith('/c/settings')){
        hidePanelByNeedles(['Settings (live links', 'tool legend']);
        // fallback: hide panel that shows lots of JSON and has "Tools (8)" + "Exports:"
        hidePanelByNeedles(['Tools (8)', 'Exports:']);
      }

      if(path === '/c/rule_overrides' || path.startsWith('/c/rule_overrides')){
        hidePanelByNeedles(['Rule Overrides (live from', '/api/vsp/rule_overrides']);
        // fallback: hide panel with "Open JSON"
        hidePanelByNeedles(['Open JSON']);
      }
    }

    if(document.readyState === 'loading'){
      document.addEventListener('DOMContentLoaded', p125);
    } else {
      p125();
    }
  }catch(e){
    console.warn('[VSP][P125] cleanup failed', e);
  }
})();

/* VSP_P125_C_SUITE_CONTRAST_V1 */
(function(){
  try{
    if(!location.pathname.startsWith('/c/')) return;
    const css = `
      .vsp-card a, a.vsp-link, .vsp-table a { text-decoration: none; }
      .vsp-card a:hover, a.vsp-link:hover, .vsp-table a:hover { text-decoration: underline; }
    `;
    const st = document.createElement('style');
    st.setAttribute('data-vsp', 'p125');
    st.textContent = css;
    document.head.appendChild(st);
  }catch(_){}
})();

/* VSP_P126_FIX_BOOL_TOKENS_V1
   - replace bare 'and'/'or' tokens to JS '&&'/'||' safely
   - hide legacy live JSON debug panels on Settings / Rule Overrides
*/
(function(){
  try{
    const p = (location && location.pathname) ? location.pathname : "";
    const isSettings = /\/c\/settings\/?$/.test(p);
    const isOverrides = /\/c\/rule_overrides\/?$/.test(p);
    if(!(isSettings || isOverrides)) return;

    // Hide big "live JSON" panels (legacy debug)
    const needles = [
      "live links",
      "live from /api",
      "Rule Overrides (live",
      "Settings (live"
    ];

    const all = Array.from(document.querySelectorAll("h1,h2,h3,div,span"));
    for(const el of all){
      const t = (el.textContent || "").trim();
      if(!t) continue;
      const hit = needles.some(k => t.toLowerCase().includes(k.toLowerCase()));
      if(!hit) continue;

      // climb up to a reasonable panel container
      let box = el;
      for(let k=0;k<8;k++){
        if(!box || !box.parentElement) break;
        const cls = box.className || "";
        if(typeof cls === "string" && (cls.includes("panel") || cls.includes("card") || cls.includes("box") || cls.includes("container"))){
          break;
        }
        box = box.parentElement;
      }
      if(box && box.style){
        box.style.display = "none";
      }
    }

    // Also hide any large PRE blocks near top area (defensive)
    const pres = Array.from(document.querySelectorAll("pre"));
    for(const pre of pres){
      const txt = (pre.textContent || "");
      if(txt.includes('"updated_by"') || txt.includes('"overrides"') || txt.includes('"evidence"')){
        // heuristic: only hide if it is not inside the editor area
        const par = pre.closest(".rule-editor,.editor,.override-editor");
        if(!par){
          pre.style.display = "none";
          const wrap = pre.parentElement;
          if(wrap && wrap.style) wrap.style.display = "none";
        }
      }
    }
  }catch(_){}
})();



// VSP_P128_FORCE_COLLAPSE_JSON_PANELS
(function(){
  try{
    const MARK = "VSP_P128_FORCE_COLLAPSE_JSON_PANELS";

    function inTargetTabs(){
      const path = (location.pathname || "");
      return /(?:^|\/)c\/(settings|rule_overrides)(?:$)/.test(path);
    }

    function looksLikeJson(txt){
      if(!txt) return false;
      const t = String(txt).trim();
      if(!t) return false;
      // Accept "startsWith { or [" even if not endsWith (sometimes truncated)
      return (t.startsWith("{") || t.startsWith("["));
    }

    function wrapPreIntoDetails(pre, label){
      if(!pre || pre.__vsp_p128_wrapped) return false;
      const txt = (pre.textContent || "").trim();
      if(!looksLikeJson(txt)) return false;

      // avoid double wrap
      if(pre.closest("details")) { pre.__vsp_p128_wrapped = true; return false; }

      const details = document.createElement("details");
      details.className = "vsp-details vsp-details--json";
      details.open = false;

      const sum = document.createElement("summary");
      sum.textContent = label || "Raw JSON (click to expand)";
      details.appendChild(sum);

      const holder = document.createElement("div");
      holder.style.maxHeight = "320px";
      holder.style.overflow = "auto";

      // Move original <pre> into holder, then replace it with <details>
      const parent = pre.parentNode;
      if(!parent) return false;

      parent.replaceChild(details, pre);
      holder.appendChild(pre);
      details.appendChild(holder);

      pre.__vsp_p128_wrapped = true;
      return true;
    }

    function collapseJsonPanels(){
      if(!inTargetTabs()) return;

      // Collapse all JSON-ish <pre>
      const pres = Array.from(document.querySelectorAll("pre"));
      for(const pre of pres){
        const txt = (pre.textContent || "").trim();
        if(!txt) continue;

        let label = "Raw JSON (click to expand)";
        const ctx = (pre.parentElement && pre.parentElement.textContent) ? pre.parentElement.textContent : "";
        if(/live\s+from/i.test(ctx) || /\/api\/vsp\//i.test(ctx)) label = "Live JSON (debug) — click to expand";

        wrapPreIntoDetails(pre, label);
      }

      // Extra: sometimes raw JSON is inside a big <div> (no <pre>) -> convert & wrap
      const bigBlocks = Array.from(document.querySelectorAll("div"));
      for(const b of bigBlocks){
        if(b.querySelector("pre,details")) continue;
        const t = (b.textContent || "").trim();
        if(t.length < 400) continue;
        if(!looksLikeJson(t)) continue;

        const pre = document.createElement("pre");
        pre.textContent = t;
        b.textContent = "";
        b.appendChild(pre);
        wrapPreIntoDetails(pre, "Raw JSON (click to expand)");
      }
    }

    function installObserver(){
      if(!inTargetTabs()) return;
      const root = document.documentElement || document.body;
      if(!root) return;

      const mo = new MutationObserver(() => { try{ collapseJsonPanels(); }catch(_){ } });
      mo.observe(root, { subtree:true, childList:true });

      // delayed passes for late-render
      let n = 0;
      const iv = setInterval(() => {
        n++;
        try{ collapseJsonPanels(); }catch(_){ }
        if(n >= 12) clearInterval(iv);
      }, 400);
    }

    // Silence noisy AbortError in console (doesn't hide real errors)
    window.addEventListener("unhandledrejection", function(ev){
      try{
        const r = ev && ev.reason;
        const name = r && r.name;
        const msg = (r && r.message) ? String(r.message) : "";
        if(name === "AbortError" || /aborted/i.test(msg)){
          ev.preventDefault();
        }
      }catch(_){}
    });

    // run now + after DOM ready
    try{ collapseJsonPanels(); installObserver(); }catch(_){}
    document.addEventListener("DOMContentLoaded", function(){
      try{ collapseJsonPanels(); installObserver(); }catch(_){}
    });

    console.log("[VSPC] installed P128");
  }catch(_){}
})();




/* VSP_P129_FORCE_JSON_OBSERVER */
(function(){
  try{
    if (window.__VSP_P129_INSTALLED__) return;
    window.__VSP_P129_INSTALLED__ = true;

    const onTarget = /(?:^|\/)c\/(settings|rule_overrides)(?:$|[?#])/.test(location.pathname||"");

    function wrapPre(pre){
      if (!pre || pre.nodeType !== 1) return;
      if (pre.closest && pre.closest("details.vsp-details")) return;

      const txt = ((pre.textContent || "")).trim();
      if (!txt) return;

      const looksJson = (txt.startsWith("{") && txt.endsWith("}")) || (txt.startsWith("[") && txt.endsWith("]"));
      if (!looksJson) return;

      const lines = txt.split("\n").length;
      const minLines = onTarget ? 8 : 30;
      if (lines < minLines) return;

      const details = document.createElement("details");
      details.className = "vsp-details";
      details.open = false;

      const sum = document.createElement("summary");
      sum.textContent = "Raw JSON (click to expand)";
      details.appendChild(sum);

      const parent = pre.parentNode;
      if (!parent) return;

      parent.insertBefore(details, pre);
      details.appendChild(pre);

      pre.style.maxHeight = onTarget ? "260px" : "220px";
      pre.style.overflow = "auto";
      pre.style.marginTop = "10px";
    }

    function scan(){
      document.querySelectorAll("pre").forEach(wrapPre);
    }

    if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", scan);
    else scan();

    const obs = new MutationObserver((mut)=>{
      for (const m of mut){
        for (const n of (m.addedNodes || [])){
          if (!n || n.nodeType !== 1) continue;
          if (n.tagName === "PRE") wrapPre(n);
          else if (n.querySelectorAll) n.querySelectorAll("pre").forEach(wrapPre);
        }
      }
    });

    obs.observe(document.documentElement || document.body, {subtree:true, childList:true});
    try{ console.log("[VSP] P129 installed (collapse JSON observer)"); }catch(_){}
  }catch(e){
    try{ console.warn("[VSP] P129 failed:", e); }catch(_){}
  }
})();

/* VSP_P130_HIDE_LIVE_JSON_PANELS_V1 (runtime) */
(function(){
  const RX_PATH = /(?:^|\/)c\/(settings|rule_overrides)(?:$)/;
  const RX_SETTINGS = /Gate summary\s*\(live\)/i;
  const RX_RAW = /Raw JSON\s*\(click to expand\)/i;
  const RX_OVR_LIVE = /Rule Overrides\s*\(live\b/i;
  const RX_LIVE_FROM_API = /live from\s*\/api/i;

  function onReady(fn){
    if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", fn, {once:true});
    else fn();
  }
  function isTooBroad(box){
    const t = (box && box.textContent) ? box.textContent : "";
    return /Endpoint Probes/i.test(t) || /Runs & Reports/i.test(t);
  }
  function findPanelFrom(el){
    let cur = el;
    for (let i=0; i<12 && cur && cur !== document.body; i++){
      if (cur.matches && cur.matches(".vsp-card,.vsp-panel,.card,.panel,section,article,div")){
        const hasPreOrDetails = !!(cur.querySelector && (cur.querySelector("pre") || cur.querySelector("details")));
        if (hasPreOrDetails && !isTooBroad(cur)) return cur;
      }
      cur = cur.parentElement;
    }
    return null;
  }
  function hideBox(box){
    if (!box || box.dataset.vspHideLiveJson === "1") return;
    box.dataset.vspHideLiveJson = "1";
    box.style.display = "none";
  }
  function hasBtnText(box, rx){
    if (!box || !box.querySelectorAll) return false;
    return Array.from(box.querySelectorAll("button,a")).some(x => rx.test(((x.textContent||"").trim())));
  }

  function sweep(){
    try{
      const path = location.pathname || "";
      if (!RX_PATH.test(path)) return;

      // /c/settings: remove Gate summary (live) debug panel
      if (/\/c\/settings$/.test(path)){
        const nodes = Array.from(document.querySelectorAll("pre,details,summary,div,section,article"));
        for (const n of nodes){
          const t = ((n.textContent||"").trim());
          if (!t) continue;
          if (!(RX_SETTINGS.test(t) || RX_RAW.test(t))) continue;

          const box = findPanelFrom(n);
          if (!box) continue;
          const bt = (box.textContent||"");
          if (RX_SETTINGS.test(bt) || RX_RAW.test(bt)) hideBox(box);
        }
      }

      // /c/rule_overrides: remove the live-from-api debug panel; keep editor (LOAD/SAVE/EXPORT)
      if (/\/c\/rule_overrides$/.test(path)){
        const pres = Array.from(document.querySelectorAll("pre"));
        for (const pre of pres){
          const box = findPanelFrom(pre);
          if (!box) continue;

          const bt = (box.textContent||"");
          const looksLikeLive = RX_OVR_LIVE.test(bt) || RX_LIVE_FROM_API.test(bt);
          if (!looksLikeLive) continue;

          const hasOpen = hasBtnText(box, /\bopen\b/i);
          const hasLoad = hasBtnText(box, /^load$/i);
          const hasSave = hasBtnText(box, /^save$/i);
          const hasExport = hasBtnText(box, /^export$/i);

          // Live panel usually has Open (and maybe JSON). Editor has LOAD/SAVE/EXPORT.
          if (hasOpen && !(hasLoad || hasSave || hasExport)) hideBox(box);
        }
      }
    }catch(e){}
  }

  onReady(() => {
    sweep();
    setTimeout(sweep, 150);
    setTimeout(sweep, 600);
    setTimeout(sweep, 1500);
  });

  try{
    const mo = new MutationObserver(() => sweep());
    mo.observe(document.documentElement, {subtree:true, childList:true});
  }catch(e){}

  console.log("[VSP] installed P130 (hide live JSON panels)");
})();


/* VSP_P131_HARD_HIDE_LIVE_JSON_PANELS_V1 */
(function(){
  try{
    if (window.__VSP_P131_INSTALLED__) return;
    window.__VSP_P131_INSTALLED__ = 1;

    const isTarget = /(?:^|\/)c\/(settings|rule_overrides)(?:$)/.test(location.pathname || "");
    if (!isTarget) return;

    const norm = (x)=>String(x||"").toLowerCase().replace(/\s+/g," ").trim();

    function looksLikeJsonText(txt){
      txt = String(txt||"").trim();
      if (!txt) return false;
      if (!(txt.startsWith("{") || txt.startsWith("["))) return false;
      if (txt.startsWith("{") && !txt.endsWith("}")) return false;
      if (txt.startsWith("[") && !txt.endsWith("]")) return false;
      return true;
    }

    function isEditorPanel(node){
      try{
        if (!node || !node.querySelectorAll) return false;
        const btns = Array.from(node.querySelectorAll("button,a"));
        const texts = btns.map(b=>norm(b.textContent));
        // protect editor area (LOAD/SAVE/EXPORT)
        return texts.includes("load") || texts.includes("save") || texts.includes("export");
      }catch(_){ return false; }
    }

    function findHideContainer(el){
      let cur = el;
      for (let i=0;i<10 && cur && cur!==document.body;i++){
        if (isEditorPanel(cur)) return null; // never hide editor
        if (cur.classList){
          if (cur.classList.contains("vsp-card") || cur.classList.contains("vsp-panel") ||
              cur.classList.contains("card") || cur.classList.contains("panel")) return cur;
        }
        cur = cur.parentElement;
      }
      return el && el.parentElement ? el.parentElement : el;
    }

    function hideNode(n){
      if (!n) return;
      try{
        n.setAttribute("data-vsp-hidden","p131");
        n.style.display="none";
      }catch(_){}
    }

    function sweep(){
      // 1) hide <details> "Raw JSON ..."
      for (const det of Array.from(document.querySelectorAll("details"))){
        const sum = det.querySelector("summary");
        if (!sum) continue;
        if (/raw json/.test(norm(sum.textContent))){
          const c = findHideContainer(det) || det;
          hideNode(c);
        }
      }

      // 2) hide containers that have "Open JSON" button AND a <pre> json
      for (const btn of Array.from(document.querySelectorAll("button,a"))){
        const t = norm(btn.textContent);
        if (t !== "open json") continue;
        const c = findHideContainer(btn);
        if (!c) continue;
        if (c.querySelector && c.querySelector("pre")) hideNode(c);
      }

      // 3) hide big <pre> JSON blocks (but keep editor)
      for (const pre of Array.from(document.querySelectorAll("pre"))){
        const txt = (pre.textContent || "").trim();
        if (!looksLikeJsonText(txt)) continue;
        const lines = txt.split("\n").length;
        if (lines < 5) continue;
        const c = findHideContainer(pre) || pre;
        hideNode(c);
      }

      // 4) hide "Gate summary" / "Rule Overrides (live...)" header panels if they include pre
      for (const el of Array.from(document.querySelectorAll("h1,h2,h3,h4,div,span"))){
        const t = norm(el.textContent);
        if (!(t.startsWith("gate summary") || t.startsWith("rule overrides (live"))) continue;
        const c = findHideContainer(el);
        if (c && c.querySelector && c.querySelector("pre")) hideNode(c);
      }
    }

    const safeSweep = ()=>{ try{sweep();}catch(e){ console.warn("[VSP] P131 sweep error", e); } };

    if (document.readyState === "loading"){
      document.addEventListener("DOMContentLoaded", safeSweep, {once:true});
    } else {
      safeSweep();
    }

    // observe future insertions (some pages render async)
    const mo = new MutationObserver(()=>safeSweep());
    mo.observe(document.documentElement, {childList:true, subtree:true});

    console.log("[VSP] installed P131 (hard hide live JSON panels)");
  }catch(_){}
})();

