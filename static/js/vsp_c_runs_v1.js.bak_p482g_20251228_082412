/* VSP_P121B_C_RUNS_V1 - safe, no template literal */
(function(){
  "use strict";

  function qs(sel, root){ return (root||document).querySelector(sel); }
  function qsa(sel, root){ return Array.prototype.slice.call((root||document).querySelectorAll(sel)); }
  function log(){ console.log.apply(console, ["[VSPC][runs]"].concat([].slice.call(arguments))); }
  function warn(){ console.warn.apply(console, ["[VSPC][runs]"].concat([].slice.call(arguments))); }

  function sanitizeRid(r){
    r = (r==null ? "" : String(r)).trim();
    r = r.replace(/[^\w\-:.]/g, "");
    if (r.length > 160) r = r.slice(0,160);
    return r;
  }
  function getParam(name){
    try { return (new URLSearchParams(location.search)).get(name) || ""; }
    catch(e){ return ""; }
  }
  function getRid(){
    var u = sanitizeRid(getParam("rid"));
    var ls = sanitizeRid(localStorage.getItem("VSP_C_RID") || "");
    return u || ls || "";
  }
  function setRid(rid){
    rid = sanitizeRid(rid);
    if (rid) localStorage.setItem("VSP_C_RID", rid);
    return rid;
  }

  function fetchJSON(url, timeoutMs){
    timeoutMs = timeoutMs || 9000;
    var ctl = new AbortController();
    var t = setTimeout(function(){ try{ctl.abort();}catch(e){} }, timeoutMs);
    return fetch(url, {signal: ctl.signal, cache:"no-store", credentials:"same-origin"})
      .then(function(r){
        return r.text().then(function(txt){
          var j=null; try{ j=JSON.parse(txt); }catch(e){}
          return {ok:r.ok, status:r.status, json:j, text:txt, url:url};
        });
      })
      .finally(function(){ clearTimeout(t); });
  }

  function firstOK(urls){
    var p = Promise.resolve(null);
    urls.forEach(function(u){
      p = p.then(function(prev){
        if (prev) return prev;
        return fetchJSON(u, 9000).then(function(res){
          if (res && res.ok && res.json) return res;
          return null;
        }).catch(function(){ return null; });
      });
    });
    return p;
  }

  function findRunsTable(){
    var tables = qsa("table");
    for (var i=0;i<tables.length;i++){
      var t = tables[i];
      var th = qsa("th", t).map(function(x){ return (x.textContent||"").trim().toLowerCase(); }).join("|");
      if (th.indexOf("rid")>=0 && th.indexOf("action")>=0) return t;
    }
    return qs("#runs_table") || qs("table");
  }

  function renderRows(tbody, items){
    tbody.innerHTML = "";
    for (var i=0;i<items.length;i++){
      var it = items[i] || {};
      var rid = sanitizeRid(it.rid || it.run_id || it.id || "");
      var label = String(it.label || it.ts || it.when || it.created_at || "");
      var verdict = String(it.verdict || it.overall || it.status || "");

      var tr = document.createElement("tr");

      var tdRid = document.createElement("td");
      tdRid.textContent = rid || "(none)";
      tdRid.style.whiteSpace = "nowrap";

      var tdLabel = document.createElement("td");
      tdLabel.textContent = label;

      var tdAct = document.createElement("td");
      tdAct.style.whiteSpace = "nowrap";

      function mkA(href, txt){
        var a=document.createElement("a");
        a.href=href; a.textContent=txt;
        a.style.marginRight="10px";
        return a;
      }

      if (rid){
        tdAct.appendChild(mkA("/c/dashboard?rid="+encodeURIComponent(rid), "Dashboard"));
        tdAct.appendChild(mkA("/api/vsp/export_findings_csv_v1?rid="+encodeURIComponent(rid), "CSV"));
        tdAct.appendChild(mkA("/api/vsp/export_reports_tgz_v1?rid="+encodeURIComponent(rid), "Reports.tgz"));
        if (verdict){
          var sp=document.createElement("span");
          sp.textContent = verdict;
          sp.style.opacity="0.75";
          sp.style.marginLeft="6px";
          tdAct.appendChild(sp);
        }
        var btn=document.createElement("button");
        btn.textContent="Use RID";
        btn.style.marginLeft="10px";
        btn.onclick=function(r){
          return function(){ setRid(r); location.href="/c/runs?rid="+encodeURIComponent(r); };
        }(rid);
        tdAct.appendChild(btn);
      } else {
        tdAct.textContent = verdict || "";
      }

      tr.appendChild(tdRid);
      tr.appendChild(tdLabel);
      tr.appendChild(tdAct);
      tbody.appendChild(tr);
    }
  }

  function main(){
    var rid = getRid();
    if (rid) log("rid=", rid);

    var tbl = findRunsTable();
    if (!tbl){ warn("table not found"); return; }

    var tb = qs("tbody", tbl);
    if (!tb){ tb=document.createElement("tbody"); tbl.appendChild(tb); }

    var inp = null;
    var ins = qsa("input");
    for (var i=0;i<ins.length;i++){
      var ph = (ins[i].placeholder||"").toLowerCase();
      if (ph.indexOf("filter")>=0){ inp=ins[i]; break; }
    }

    tb.innerHTML = '<tr><td colspan="3" style="opacity:.7">Loading...</td></tr>';

    firstOK([
      "/api/vsp/runs_v3?limit=200&include_ci=1",
      "/api/vsp/runs_v3?limit=200&include_ci=1",
      "/api/vsp/runs_v2?limit=200"
    ]).then(function(res){
      if (!res){
        tb.innerHTML = '<tr><td colspan="3" style="color:#ffb">Cannot load runs API</td></tr>';
        return;
      }
      var items = res.json.items || res.json.data || res.json.runs || [];
      var norm = items.map(function(x){
        return {
          rid: x.rid || x.run_id || x.id,
          label: x.label || x.ts || x.when || x.created_at || "",
          verdict: x.verdict || x.overall || x.status || ""
        };
      });
      var view = norm.slice();
      renderRows(tb, view);

      if (inp){
        inp.addEventListener("input", function(){
          var q=(inp.value||"").toLowerCase().trim();
          if (!q){ view=norm.slice(); renderRows(tb, view); return; }
          view = norm.filter(function(x){
            return (String(x.rid||"").toLowerCase().indexOf(q)>=0) ||
                   (String(x.label||"").toLowerCase().indexOf(q)>=0);
          });
          renderRows(tb, view);
        });
      }
    }).catch(function(e){
      console.error(e);
      tb.innerHTML = '<tr><td colspan="3" style="color:#ffb">runs error</td></tr>';
    });
  }

  window.addEventListener("DOMContentLoaded", main);
})();

/* VSP_P450_APIUI_TO_APIVSP_V1 */


;/* ===================== VSP_P471B_C_RUNS_PRO_SINGLE_V1 ===================== */
(function(){
  if (window.__VSP_P471B_C_RUNS_PRO_SINGLE_V1) return;
  window.__VSP_P471B_C_RUNS_PRO_SINGLE_V1 = true;

  const BUILD = "20251228_012428";
  const log = (...a)=>console.log("[P471B]", ...a);

  function qs(sel, root=document){ try{ return root.querySelector(sel); }catch(e){ return null; } }
  function qsa(sel, root=document){ try{ return Array.from(root.querySelectorAll(sel)); }catch(e){ return []; } }

  function isCRuns(){
    try{ return location && location.pathname && location.pathname.startsWith("/c/runs"); }
    catch(e){ return false; }
  }
  function getRidFromUrl(){
    try{ const u = new URL(location.href); return (u.searchParams.get("rid")||"").trim(); }
    catch(e){ return ""; }
  }
  function setRid(rid){
    const r=(rid||"").trim(); if(!r) return;
    location.href = "/c/runs?rid=" + encodeURIComponent(r);
  }
  function fmtTs(ts){
    if(!ts) return "";
    try{
      const d=new Date(ts);
      if(String(d)==="Invalid Date") return "";
      const pad=n=>String(n).padStart(2,"0");
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }catch(e){ return ""; }
  }

  async function fetchJson(url, toMs=8000){
    const ctl=new AbortController();
    const t=setTimeout(()=>ctl.abort(), toMs);
    try{
      const r=await fetch(url,{signal:ctl.signal,credentials:"same-origin"});
      const j=await r.json();
      return {ok:true,status:r.status,json:j};
    }catch(e){
      return {ok:false,err:String(e)};
    }finally{ clearTimeout(t); }
  }

  async function fetchRunsAny(){
    const tries=[
      "/api/vsp/runs?limit=250&offset=0",
      "/api/vsp/runs?limit=250",
      "/api/vsp/runs_v3?limit=250&include_ci=1",
      "/api/vsp/runs_v3?limit=250",
      "/api/ui/runs_v3?limit=250&include_ci=1",
      "/api/ui/runs_v3?limit=250",
    ];
    for(const u of tries){
      const r=await fetchJson(u,8000);
      if(!r.ok || !r.json) continue;
      const j=r.json;
      let items=[];
      if(Array.isArray(j.runs)){
        items=j.runs.map(x=>({
          rid:String(x.rid||x.run_id||""),
          ts:(x.ts?Date.parse(x.ts):(x.mtime?Number(x.mtime)*1000:0)),
          label:String(x.label||""),
        }));
      }else if(Array.isArray(j.items)){
        items=j.items.map(x=>({
          rid:String(x.rid||x.run_id||x.name||""),
          ts:(x.ts?Date.parse(x.ts):0),
          label:String(x.label||""),
        }));
      }
      items=items.filter(x=>x.rid);
      if(items.length){
        items.sort((a,b)=>(b.ts||0)-(a.ts||0));
        return {ok:true,src:u,items,total:(j.total||items.length)};
      }
    }
    return {ok:false,items:[],total:0};
  }

  async function headOK(url, toMs=2500){
    const ctl=new AbortController();
    const t=setTimeout(()=>ctl.abort(),toMs);
    try{
      const r=await fetch(url,{method:"HEAD",signal:ctl.signal,credentials:"same-origin"});
      return r && r.status>=200 && r.status<400;
    }catch(e){ return false; }
    finally{ clearTimeout(t); }
  }

  async function guessDownload(kind,rid){
    const r=encodeURIComponent(rid);
    const cands=(kind==="csv")?[
      `/api/vsp/findings_csv?rid=${r}`,
      `/api/vsp/download_findings_csv?rid=${r}`,
      `/api/vsp/findings?rid=${r}&fmt=csv`,
      `/api/vsp/export_findings_csv?rid=${r}`,
      `/api/vsp/findings.csv?rid=${r}`,
    ]:[
      `/api/vsp/reports_tgz?rid=${r}`,
      `/api/vsp/download_reports_tgz?rid=${r}`,
      `/api/vsp/reports?rid=${r}&fmt=tgz`,
      `/api/vsp/reports.tgz?rid=${r}`,
    ];
    for(const u of cands){ if(await headOK(u)) return u; }
    return "";
  }

  function injectStyles(){
    if(qs("#vsp_p471b_style")) return;
    const st=document.createElement("style");
    st.id="vsp_p471b_style";
    st.textContent=`
      .vsp-p471b-card{margin:12px 12px 18px;padding:14px 14px 10px;border:1px solid rgba(120,140,180,.22);border-radius:14px;background:rgba(12,16,28,.55);backdrop-filter:blur(10px)}
      .vsp-p471b-title{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:10px}
      .vsp-p471b-title h2{margin:0;font-size:15px;letter-spacing:.2px}
      .vsp-p471b-sub{opacity:.75;font-size:12px}
      .vsp-p471b-toolbar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin:10px 0 12px}
      .vsp-p471b-input{height:32px;padding:0 10px;border-radius:10px;border:1px solid rgba(120,140,180,.22);background:rgba(8,10,18,.55);color:inherit;outline:none}
      .vsp-p471b-btn{height:32px;padding:0 10px;border-radius:10px;border:1px solid rgba(120,140,180,.22);background:rgba(18,24,44,.55);color:inherit;cursor:pointer}
      .vsp-p471b-btn:hover{filter:brightness(1.08)}
      .vsp-p471b-chip{padding:4px 10px;border-radius:999px;border:1px solid rgba(120,140,180,.22);background:rgba(18,24,44,.35);font-size:12px;opacity:.9}
      .vsp-p471b-table{width:100%;border-collapse:collapse;font-size:13px}
      .vsp-p471b-table th,.vsp-p471b-table td{padding:10px 8px;border-bottom:1px solid rgba(120,140,180,.12);vertical-align:middle}
      .vsp-p471b-actions{display:flex;flex-wrap:wrap;gap:8px;justify-content:flex-end}
      .vsp-p471b-pill{padding:6px 10px;border-radius:999px;border:1px solid rgba(120,140,180,.22);background:rgba(18,24,44,.35);cursor:pointer;font-size:12px}
      .vsp-p471b-pill:hover{filter:brightness(1.08)}
      .vsp-p471b-scan-grid{display:grid;grid-template-columns:1.6fr .9fr;gap:12px}
      .vsp-p471b-scan-row{display:flex;gap:10px;align-items:center}
      .vsp-p471b-box{border:1px solid rgba(120,140,180,.18);border-radius:12px;background:rgba(8,10,18,.35);padding:10px;min-height:48px;overflow:auto;font-family:ui-monospace,Menlo,Monaco,Consolas,"Courier New",monospace;font-size:12px;white-space:pre-wrap}
      @media(max-width:980px){.vsp-p471b-scan-grid{grid-template-columns:1fr}}
    `;
    document.head.appendChild(st);
  }

  function hideLegacySafely(){
    const blocks=[];
    for(const el of qsa("div,section")){
      if(!el || (el.dataset && el.dataset.vspP471b==="1")) continue;
      const txt=(el.innerText||"").trim();
      if(!txt) continue;

      const looksLegacyRuns = txt.includes("Filter by RID") || txt.includes("Pick a RID") || (txt.includes("Runs & Reports") && txt.includes("client-side"));
      const looksLegacyScan = txt.includes("Scan / Start Run") || txt.includes("Kick off via /api/vsp/run_v1");
      if(looksLegacyRuns || looksLegacyScan){
        if(el.closest && el.closest("#vsp_p471b_root")) continue;
        blocks.push(el);
      }
    }
    let n=0;
    for(const el of blocks){
      if(el===document.body || el===document.documentElement) continue;
      el.style.display="none";
      n++;
    }
    log("legacy blocks hidden:", n);
  }

  function ensureMount(){
    let root=qs("#vsp_p471b_root");
    if(root) return root;
    root=document.createElement("div");
    root.id="vsp_p471b_root";
    root.dataset.vspP471b="1";
    const body=document.body;
    body.insertBefore(root, body.firstElementChild || null);
    return root;
  }

  function buildRuns(root){
    const ridSel=getRidFromUrl();
    const card=document.createElement("div");
    card.className="vsp-p471b-card";
    card.dataset.vspP471b="1";
    card.innerHTML=`
      <div class="vsp-p471b-title">
        <div>
          <h2>Runs & Reports (commercial)</h2>
          <div class="vsp-p471b-sub">P471b • single-source • API-driven • rid=${ridSel?ridSel:"(none)"} • build=${BUILD}</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:flex-end">
          <span class="vsp-p471b-chip" id="p471b_total">Total: -</span>
          <span class="vsp-p471b-chip" id="p471b_shown">Shown: -</span>
          <span class="vsp-p471b-chip" id="p471b_sel">Selected: ${ridSel?ridSel:"-"}</span>
        </div>
      </div>

      <div class="vsp-p471b-toolbar">
        <input class="vsp-p471b-input" id="p471b_q" placeholder="Search RID..." style="min-width:220px" />
        <select class="vsp-p471b-input" id="p471b_page">
          <option value="20">20/page</option>
          <option value="50">50/page</option>
          <option value="100">100/page</option>
          <option value="200">200/page</option>
        </select>
        <button class="vsp-p471b-btn" id="p471b_refresh">Refresh</button>
        <button class="vsp-p471b-btn" id="p471b_open_runs">Open Exports (/runs)</button>
      </div>

      <div style="overflow:auto">
        <table class="vsp-p471b-table">
          <thead><tr>
            <th style="text-align:left;width:44%">RID</th>
            <th style="text-align:left;width:18%">DATE</th>
            <th style="text-align:left;width:18%">STATUS</th>
            <th style="text-align:right;width:20%">ACTIONS</th>
          </tr></thead>
          <tbody id="p471b_tbody"><tr><td colspan="4" style="opacity:.75">Loading…</td></tr></tbody>
        </table>
      </div>
    `;
    root.appendChild(card);
  }

  function buildScan(root){
    const card=document.createElement("div");
    card.className="vsp-p471b-card";
    card.dataset.vspP471b="1";
    card.innerHTML=`
      <div class="vsp-p471b-title">
        <div>
          <h2>Scan / Start Run</h2>
          <div class="vsp-p471b-sub">Kick off via <code>/api/vsp/run_v1</code> • Poll via <code>/api/vsp/run_status_v1</code> (best-effort)</div>
        </div>
        <div class="vsp-p471b-chip" id="p471b_scan_rid">RID: (none)</div>
      </div>

      <div class="vsp-p471b-scan-grid">
        <div>
          <div class="vsp-p471b-sub" style="margin:0 0 6px 2px">Target path</div>
          <input class="vsp-p471b-input" id="p471b_target" style="width:100%" value="/home/test/Data/SECURITY_BUNDLE" />
          <div class="vsp-p471b-sub" style="margin:10px 0 6px 2px">Note</div>
          <input class="vsp-p471b-input" id="p471b_note" style="width:100%" placeholder="optional note for audit trail" />
        </div>
        <div>
          <div class="vsp-p471b-sub" style="margin:0 0 6px 2px">Mode</div>
          <select class="vsp-p471b-input" id="p471b_mode" style="width:100%">
            <option value="FULL">FULL (8 tools)</option>
            <option value="FAST">FAST</option>
          </select>
          <div class="vsp-p471b-scan-row" style="margin-top:12px;justify-content:flex-end">
            <button class="vsp-p471b-btn" id="p471b_start">Start scan</button>
            <button class="vsp-p471b-btn" id="p471b_poll">Refresh status</button>
          </div>
        </div>
      </div>

      <div style="margin-top:10px" class="vsp-p471b-box" id="p471b_scan_out">Ready.</div>
    `;
    root.appendChild(card);
  }

  function render(rows,pageSize,q){
    const tb=qs("#p471b_tbody");
    if(!tb) return;
    const query=(q||"").trim().toLowerCase();
    let list=rows||[];
    if(query) list=list.filter(x=>(x.rid||"").toLowerCase().includes(query));
    const shown=list.slice(0,pageSize);

    const shownChip=qs("#p471b_shown");
    if(shownChip) shownChip.textContent="Shown: "+shown.length;

    tb.innerHTML="";
    if(!shown.length){
      tb.innerHTML=`<tr><td colspan="4" style="opacity:.75">No runs.</td></tr>`;
      return;
    }
    for(const r of shown){
      const tr=document.createElement("tr");
      const date=r.ts?fmtTs(r.ts):(r.label||"");
      tr.innerHTML=`
        <td style="font-family:ui-monospace,Menlo,Monaco,Consolas,'Courier New',monospace">${r.rid}</td>
        <td style="opacity:.9">${date}</td>
        <td style="opacity:.8">UNKNOWN</td>
        <td>
          <div class="vsp-p471b-actions">
            <span class="vsp-p471b-pill" data-act="use" data-rid="${r.rid}">Use RID</span>
            <span class="vsp-p471b-pill" data-act="dash" data-rid="${r.rid}">Dashboard</span>
            <span class="vsp-p471b-pill" data-act="csv" data-rid="${r.rid}">CSV</span>
            <span class="vsp-p471b-pill" data-act="tgz" data-rid="${r.rid}">TGZ</span>
          </div>
        </td>
      `;
      tb.appendChild(tr);
    }
  }

  async function boot(fromRefresh=false){
    if(!isCRuns()) return;
    injectStyles();

    const root=ensureMount();
    root.innerHTML="";
    buildRuns(root);
    buildScan(root);

    // hide legacy AFTER we mount ours (avoid blank)
    hideLegacySafely();

    const tb=qs("#p471b_tbody");
    if(tb) tb.innerHTML=`<tr><td colspan="4" style="opacity:.75">Loading from API…</td></tr>`;

    const r=await fetchRunsAny();
    const rows=(r && r.ok) ? r.items : [];
    const totalChip=qs("#p471b_total");
    if(totalChip) totalChip.textContent="Total: "+(r.total||rows.length||0);
    log("runs src:", (r.src||"n/a"), "items:", rows.length, "refresh:", !!fromRefresh);

    let pageSize=20, q="";
    render(rows,pageSize,q);

    const pageSel=qs("#p471b_page");
    const qInp=qs("#p471b_q");
    const refreshBtn=qs("#p471b_refresh");
    const openRunsBtn=qs("#p471b_open_runs");

    const rer=()=>render(rows,pageSize,q);
    if(pageSel) pageSel.addEventListener("change",()=>{ pageSize=Number(pageSel.value||"20")||20; rer(); });
    if(qInp) qInp.addEventListener("input",()=>{ q=qInp.value||""; rer(); });
    if(refreshBtn) refreshBtn.addEventListener("click",()=>boot(true));
    if(openRunsBtn) openRunsBtn.addEventListener("click",()=>{
      const rid=getRidFromUrl();
      window.open(rid?("/runs?rid="+encodeURIComponent(rid)):"/runs","_blank");
    });

    document.addEventListener("click", async (ev)=>{
      const t=ev.target;
      if(!t || !t.getAttribute) return;
      const act=t.getAttribute("data-act");
      const rid=t.getAttribute("data-rid");
      if(!act || !rid) return;

      if(act==="use") return setRid(rid);
      if(act==="dash") return (location.href="/c/dashboard?rid="+encodeURIComponent(rid));
      if(act==="csv"){
        const u=await guessDownload("csv",rid);
        if(u) window.open(u,"_blank"); else alert("CSV endpoint not found (tried common candidates).");
      }
      if(act==="tgz"){
        const u=await guessDownload("tgz",rid);
        if(u) window.open(u,"_blank"); else alert("TGZ endpoint not found (tried common candidates).");
      }
    }, true);

    // Scan UI (best-effort)
    const out=qs("#p471b_scan_out");
    const ridChip=qs("#p471b_scan_rid");
    const startBtn=qs("#p471b_start");
    const pollBtn=qs("#p471b_poll");
    const targetInp=qs("#p471b_target");
    const noteInp=qs("#p471b_note");
    const modeSel=qs("#p471b_mode");

    async function postRun(){
      const target=(targetInp?.value||"").trim();
      const note=(noteInp?.value||"").trim();
      const mode=(modeSel?.value||"FULL").trim();
      if(!target) return alert("Target path is empty.");

      if(out) out.textContent="Starting…";
      try{
        const rr=await fetch("/api/vsp/run_v1",{
          method:"POST",
          headers:{"Content-Type":"application/json"},
          credentials:"same-origin",
          body: JSON.stringify({target_path: target, mode, note})
        });
        const jj=await rr.json().catch(()=>null);
        const rid=(jj && (jj.rid||jj.run_id)) ? String(jj.rid||jj.run_id) : "";
        if(ridChip) ridChip.textContent="RID: "+(rid||"(unknown)");
        if(out) out.textContent=JSON.stringify(jj||{status:rr.status}, null, 2);
      }catch(e){
        if(out) out.textContent="Start failed: "+String(e);
      }
    }
    async function poll(){
      if(out) out.textContent="Polling…";
      try{
        const rr=await fetch("/api/vsp/run_status_v1",{credentials:"same-origin"});
        const jj=await rr.json().catch(()=>null);
        if(out) out.textContent=JSON.stringify(jj||{status:rr.status}, null, 2);
      }catch(e){
        if(out) out.textContent="Poll failed: "+String(e);
      }
    }

    if(startBtn) startBtn.onclick=postRun;
    if(pollBtn) pollBtn.onclick=poll;
  }

  if(document.readyState==="loading"){
    document.addEventListener("DOMContentLoaded", ()=>boot(false), {once:true});
  }else{
    boot(false);
  }
})();
;/* ===================== /VSP_P471B_C_RUNS_PRO_SINGLE_V1 ===================== */



/* VSP_P472B_SIDEBAR_IN_RUNS_V1 */
(function(){
  const LABELS = [
    ["Dashboard","/c/dashboard"],
    ["Runs & Reports","/c/runs"],
    ["Data Source","/c/data_source"],
    ["Settings","/c/settings"],
    ["Rule Overrides","/c/rule_overrides"],
  ];
  function addCss(){
    if(document.getElementById("vsp_side_menu_v1_css")) return;
    const st=document.createElement("style");
    st.id="vsp_side_menu_v1_css";
    st.textContent = `
#vsp_side_menu_v1{position:fixed;top:0;left:0;bottom:0;width:220px;z-index:999999;
  background:rgba(10,14,22,0.98);border-right:1px solid rgba(255,255,255,0.08);
  padding:14px 12px;font-family:inherit}
#vsp_side_menu_v1 .vsp_brand{font-weight:800;letter-spacing:.3px;font-size:13px;margin:2px 0 12px 2px;opacity:.95}
#vsp_side_menu_v1 a{display:flex;align-items:center;gap:10px;text-decoration:none;
  color:rgba(255,255,255,0.84);padding:10px 10px;border-radius:12px;margin:6px 0;
  background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06)}
#vsp_side_menu_v1 a:hover{background:rgba(255,255,255,0.06)}
#vsp_side_menu_v1 a.active{background:rgba(99,179,237,0.14);border-color:rgba(99,179,237,0.35);color:#fff}
html.vsp_p472b_pad, body.vsp_p472b_pad{padding-left:220px}
.vsp_p472b_hide_nav{display:none!important}
`;
    document.head.appendChild(st);
  }
  function addMenu(){
    if(document.getElementById("vsp_side_menu_v1")) return;
    addCss();
    const menu=document.createElement("div");
    menu.id="vsp_side_menu_v1";
    const brand=document.createElement("div");
    brand.className="vsp_brand";
    brand.textContent="VSP • Commercial";
    menu.appendChild(brand);

    const path=location.pathname || "";
    for(const [name,href] of LABELS){
      const a=document.createElement("a");
      a.href=href;
      a.textContent=name;
      if(path===href) a.classList.add("active");
      menu.appendChild(a);
    }
    document.body.appendChild(menu);

    document.documentElement.classList.add("vsp_p472b_pad");
    document.body.classList.add("vsp_p472b_pad");

    // hide bottom nav buttons if any (best-effort)
    document.querySelectorAll("a,button,div").forEach(el=>{
      const t=(el.textContent||"").trim();
      if(t==="Dashboard" || t==="Runs & Reports" || t==="Data Source" || t==="Settings" || t==="Rule Overrides"){
        // only hide if this element looks like a nav pill (avoid hiding row buttons)
        const cls=(el.className||"").toString();
        if(cls.includes("tab") || cls.includes("nav") || cls.includes("pill") || cls.includes("btn")){
          el.classList.add("vsp_p472b_hide_nav");
        }
      }
    });

    console && console.log && console.log("[P472b] sidebar injected in runs");
  }
  function boot(){
    try{ addMenu(); }catch(e){ console && console.warn && console.warn("[P472b] err", e); }
  }
  if(document.readyState==="loading") document.addEventListener("DOMContentLoaded", ()=>setTimeout(boot, 50));
  else setTimeout(boot, 50);
})();


/* VSP_P473_LOADER_SNIPPET_V1 */
(function(){
  try{
    if (window.__VSP_SIDEBAR_FRAME_V1__) return;
    if (document.getElementById("vsp_c_sidebar_v1_loader")) return;
    var s=document.createElement("script");
    s.id="vsp_c_sidebar_v1_loader";
    s.src="/static/js/vsp_c_sidebar_v1.js?v="+Date.now();
    document.head.appendChild(s);
  }catch(e){}
})();



/* VSP_P477C_EMPTY_STATE_ONLY_V1 */
(function(){
  function ensureCss(){
    if(document.getElementById("vsp_p477c_css")) return;
    const st=document.createElement("style");
    st.id="vsp_p477c_css";
    st.textContent=`
#vsp_runs_empty_v1{
  margin:14px 0;
  padding:16px 16px;
  border-radius:16px;
  border:1px solid rgba(255,255,255,0.06);
  background:rgba(255,255,255,0.02);
}
#vsp_runs_empty_v1 .t{font-weight:900;font-size:14px;letter-spacing:.2px}
#vsp_runs_empty_v1 .d{opacity:.8;margin-top:6px;line-height:1.5}
`;
    document.head.appendChild(st);
  }

  function insertEmptyCard(){
    ensureCss();
    if(document.getElementById("vsp_runs_empty_v1")) return;

    // only show if page looks empty (no RID-like strings)
    const txt = (document.body && document.body.innerText) ? document.body.innerText : "";
    const hasRid = /VSP_CI_|RUN_|VSP_/.test(txt);
    if(hasRid) return;

    const root = document.querySelector(".vsp_p473_frame") || document.getElementById("vsp_p473_wrap") || document.body;
    if(!root) return;

    const card=document.createElement("div");
    card.id="vsp_runs_empty_v1";
    const t=document.createElement("div");
    t.className="t";
    t.textContent="No runs found (yet)";
    const d=document.createElement("div");
    d.className="d";
    d.textContent="This environment has no run history loaded. When runs exist, they will appear here automatically.";
    card.appendChild(t);
    card.appendChild(d);

    const tb=document.getElementById("vsp_p474_titlebar");
    if(tb && tb.parentNode) tb.parentNode.insertBefore(card, tb.nextSibling);
    else root.insertBefore(card, root.firstChild);
  }

  function boot(){
    setTimeout(insertEmptyCard, 700);
    setTimeout(insertEmptyCard, 1400);
  }

  if(document.readyState==="loading") document.addEventListener("DOMContentLoaded", boot);
  else boot();
})();


/* VSP_P482_RUNS_TOOLBAR_SORT_FILTER_NO_RUN_V1 */
(function(){
  if (window.__VSP_P482__) return;
  window.__VSP_P482__ = 1;

  function onRuns(){ return location.pathname.includes("/c/runs"); }

  function ensureCss(){
    if(document.getElementById("vsp_p482_css")) return;
    const st=document.createElement("style");
    st.id="vsp_p482_css";
    st.textContent=`
/* fixed toolbar for runs */
#vsp_p482_bar{
  position: fixed;
  top: 74px;
  left: 240px;
  right: 20px;
  z-index: 9999;
  border-radius: 14px;
  border: 1px solid rgba(255,255,255,0.10);
  background: rgba(12,16,24,0.92);
  backdrop-filter: blur(10px);
  padding: 10px 10px;
  display:flex;
  gap: 8px;
  flex-wrap: wrap;
  align-items: center;
  box-shadow: 0 10px 30px rgba(0,0,0,0.35);
}
@media (max-width: 980px){
  #vsp_p482_bar{ left: 14px; right: 14px; top: 64px; }
}
#vsp_p482_q{
  flex: 1;
  min-width: 260px;
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,0.10);
  background: rgba(255,255,255,0.02);
  color: rgba(255,255,255,0.92);
  padding: 7px 10px;
  font-size: 12px;
}
#vsp_p482_sort{
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,0.10);
  background: rgba(255,255,255,0.02);
  color: rgba(255,255,255,0.90);
  padding: 7px 10px;
  font-size: 12px;
}
.vsp_p482_chip{
  border-radius:999px;
  border:1px solid rgba(255,255,255,0.10);
  background:rgba(255,255,255,0.03);
  color:rgba(255,255,255,0.86);
  padding:6px 10px;
  font-size:12px;
  cursor:pointer;
  user-select:none;
}
.vsp_p482_chip.on{
  border-color:rgba(99,179,237,0.35);
  background:rgba(99,179,237,0.12);
  color:#fff;
}
#vsp_p482_bar .mini{
  margin-left:auto;
  display:flex;
  gap:8px;
  align-items:center;
  flex-wrap:wrap;
  font-size:11px;
  opacity:.78;
}
#vsp_p482_bar button{
  border-radius:12px;
  border:1px solid rgba(255,255,255,0.10);
  background:rgba(255,255,255,0.03);
  color:rgba(255,255,255,0.88);
  padding:6px 10px;
  font-size:12px;
  cursor:pointer;
}
#vsp_p482_bar button:hover{ background:rgba(255,255,255,0.06); }

/* sticky header for the chosen runs table */
.vsp_p482_table thead th{
  position: sticky;
  top: 0;
  z-index: 2;
  background: rgba(10,14,22,0.96);
  backdrop-filter: blur(8px);
}

/* avoid toolbar overlap */
body.vsp_p482_pad_top{
  padding-top: 58px;
}
`;
    document.head.appendChild(st);
  }

  function chooseRunsTable(){
    const tables=[...document.querySelectorAll("table")];
    let best=null, bestScore=0;

    for(const tb of tables){
      const rows=tb.querySelectorAll("tbody tr").length;
      if(rows < 8) continue;
      const head=(tb.querySelector("thead")?.innerText||"").toLowerCase();
      const score = rows + (head.includes("rid") ? 50 : 0) + (head.includes("status") ? 10 : 0);
      if(score > bestScore){ bestScore=score; best=tb; }
    }
    return best;
  }

  function findColIndex(tb, key){
    const ths=[...tb.querySelectorAll("thead th")];
    for(let i=0;i<ths.length;i++){
      const t=(ths[i].innerText||"").toLowerCase();
      if(t.includes(key)) return i;
    }
    return -1;
  }

  function getCellText(tr, idx){
    const tds=[...tr.querySelectorAll("td")];
    if(idx < 0 || idx >= tds.length) return "";
    return (tds[idx].innerText||"").trim();
  }

  function parseDate(s){
    // try "YYYY-MM-DD HH:MM" first
    const m = s.match(/(\d{4})-(\d{2})-(\d{2})[ T](\d{2}):(\d{2})/);
    if(m){
      const y=int(m[1]); const mo=int(m[2]); const d=int(m[3]); const h=int(m[4]); const mi=int(m[5]);
      return new Date(y,mo-1,d,h,mi,0).getTime();
    }
    // fallback Date.parse
    const t = Date.parse(s);
    return isNaN(t) ? 0 : t;
    function int(x){ try{return parseInt(x,10)}catch(e){return 0} }
  }

  function applyFilterAndSort(tb, st){
    const ridIdx = findColIndex(tb, "rid");
    const dateIdx = findColIndex(tb, "date");
    const statusIdx = findColIndex(tb, "status");

    const rows=[...tb.querySelectorAll("tbody tr")];
    const q=(st.q||"").trim().toLowerCase();
    const wantStatus=(st.status||"ALL").toUpperCase();

    // filter
    let shown=0;
    const kept=[];
    for(const tr of rows){
      const rid = getCellText(tr, ridIdx);
      const date = getCellText(tr, dateIdx);
      const status = getCellText(tr, statusIdx) || "UNKNOWN";
      const blob=(rid+" "+date+" "+status+" "+(tr.innerText||"")).toLowerCase();

      let ok=true;
      if(q) ok = ok && blob.includes(q);
      if(wantStatus !== "ALL"){
        ok = ok && (status.toUpperCase().includes(wantStatus));
      }
      tr.style.display = ok ? "" : "none";
      if(ok){
        shown++;
        kept.push(tr);
      }
    }

    // sort (only visible rows)
    const mode=st.sort||"DATE_DESC";
    kept.sort((a,b)=>{
      const ra=getCellText(a,ridIdx), rb=getCellText(b,ridIdx);
      const da=parseDate(getCellText(a,dateIdx)), db=parseDate(getCellText(b,dateIdx));
      if(mode==="RID_ASC") return ra.localeCompare(rb);
      if(mode==="RID_DESC") return rb.localeCompare(ra);
      if(mode==="DATE_ASC") return da-db;
      return db-da; // DATE_DESC
    });

    const tbody=tb.querySelector("tbody");
    if(tbody){
      for(const tr of kept){ tbody.appendChild(tr); }
    }

    const lab=document.getElementById("vsp_p482_count");
    if(lab) lab.textContent = `shown=${shown}/${rows.length}`;
  }

  function ensureBar(tb){
    if(document.getElementById("vsp_p482_bar")) return;

    document.body.classList.add("vsp_p482_pad_top");
    tb.classList.add("vsp_p482_table");

    const st={ q:"", status:"ALL", sort:"DATE_DESC" };

    const bar=document.createElement("div");
    bar.id="vsp_p482_bar";

    function mkChip(name){
      const c=document.createElement("span");
      c.className="vsp_p482_chip";
      c.textContent=name;
      c.onclick=()=>{
        [...bar.querySelectorAll('.vsp_p482_chip[data-k="status"]')].forEach(x=>x.classList.remove("on"));
        c.classList.add("on");
        st.status=name;
        applyFilterAndSort(tb, st);
      };
      c.dataset.k="status";
      return c;
    }

    // status chips
    const chips=["ALL","OK","WARN","FAIL","UNKNOWN"];
    for(const x of chips){
      const c=mkChip(x);
      if(x==="ALL") c.classList.add("on");
      bar.appendChild(c);
    }

    // search
    const q=document.createElement("input");
    q.id="vsp_p482_q";
    q.placeholder="Search RID / status / anything…";
    q.oninput=()=>{ st.q=q.value||""; applyFilterAndSort(tb, st); };
    bar.appendChild(q);

    // sort
    const sel=document.createElement("select");
    sel.id="vsp_p482_sort";
    const opts=[
      ["DATE_DESC","Date ↓ (newest)"],
      ["DATE_ASC","Date ↑ (oldest)"],
      ["RID_DESC","RID ↓"],
      ["RID_ASC","RID ↑"],
    ];
    for(const [v,t] of opts){
      const o=document.createElement("option");
      o.value=v; o.textContent=t;
      sel.appendChild(o);
    }
    sel.value=st.sort;
    sel.onchange=()=>{ st.sort=sel.value; applyFilterAndSort(tb, st); };
    bar.appendChild(sel);

    // right mini
    const mini=document.createElement("div");
    mini.className="mini";

    const cnt=document.createElement("span");
    cnt.id="vsp_p482_count";
    cnt.textContent="shown=?";
    mini.appendChild(cnt);

    const bTop=document.createElement("button");
    bTop.textContent="Top";
    bTop.onclick=()=>{ window.scrollTo({top:0, behavior:"smooth"}); };
    mini.appendChild(bTop);

    const bClear=document.createElement("button");
    bClear.textContent="Clear";
    bClear.onclick=()=>{
      st.q=""; st.status="ALL"; st.sort="DATE_DESC";
      q.value=""; sel.value=st.sort;
      [...bar.querySelectorAll('.vsp_p482_chip.on')].forEach(x=>x.classList.remove("on"));
      [...bar.querySelectorAll('.vsp_p482_chip[data-k="status"]')].find(x=>x.textContent==="ALL")?.classList.add("on");
      applyFilterAndSort(tb, st);
    };
    mini.appendChild(bClear);

    bar.appendChild(mini);

    document.body.appendChild(bar);
    applyFilterAndSort(tb, st);
    console.log("[P482] runs toolbar ready");
  }

  function boot(){
    if(!onRuns()) return;
    ensureCss();

    const tb=chooseRunsTable();
    if(!tb){
      console.log("[P482] no runs table yet, retry...");
      setTimeout(boot, 900);
      return;
    }
    ensureBar(tb);
  }

  if(document.readyState==="loading") document.addEventListener("DOMContentLoaded", ()=>setTimeout(boot, 700));
  else setTimeout(boot, 700);
})();



/* [P482c] removed bad P482b block */


/* VSP_P482C_RUNS_TOOLBAR_V2_LIST_OK_V1
 * Runs tab: list rows (has button 'Use RID'). Add toolbar V2 + hide legacy controls.
 */
(function(){
  function onReady(fn){
    if(document.readyState === 'complete' || document.readyState === 'interactive') return fn();
    document.addEventListener('DOMContentLoaded', fn, {once:true});
  }

  function injectCss(){
    if(document.getElementById('vsp-runs-toolbar-v2-css')) return;
    var st=document.createElement('style');
    st.id='vsp-runs-toolbar-v2-css';
    st.textContent =
      ".vsp-runs-toolbar-v2{display:flex;gap:8px;align-items:center;flex-wrap:wrap;padding:10px 12px;margin:10px 0 12px 0;border:1px solid rgba(255,255,255,.08);background:rgba(0,0,0,.18);border-radius:12px;position:sticky;top:10px;z-index:20;backdrop-filter:blur(10px);}"+
      ".vsp-runs-toolbar-v2 input,.vsp-runs-toolbar-v2 select{height:32px;border-radius:10px;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.25);color:#dfe7ff;padding:0 10px;outline:none;}"+
      ".vsp-runs-toolbar-v2 input{min-width:260px;}"+
      ".vsp-runs-toolbar-v2 .btn{height:32px;padding:0 10px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.22);color:#dfe7ff;cursor:pointer;}"+
      ".vsp-runs-toolbar-v2 .btn:hover{border-color:rgba(255,255,255,.22);}"+
      ".vsp-runs-toolbar-v2 .hint{opacity:.75;font-size:12px;margin-left:auto;}"+
      ".vsp-hide-legacy{display:none !important;}";
    document.head.appendChild(st);
  }

  function findRunsPanel(){
    var nodes=[].slice.call(document.querySelectorAll('h1,h2,h3,div,span'));
    for(var i=0;i<nodes.length;i++){
      var t=(nodes[i].textContent||'').trim();
      if(/Runs\s*&\s*Reports/i.test(t) || /^Runs$/i.test(t)){
        return nodes[i].closest('section,article,div') || nodes[i].parentElement || document.body;
      }
    }
    return document.querySelector('#app') || document.querySelector('.vsp-page') || document.body;
  }

  function hideLegacy(panel){
    // Hide old search/export bars if they exist
    var els=[].slice.call(panel.querySelectorAll('button,input,select,div,span'));
    for(var i=0;i<els.length;i++){
      var el=els[i];
      var txt=((el.textContent||'')+'').trim();
      var ph=(el.getAttribute && el.getAttribute('placeholder')) ? el.getAttribute('placeholder') : '';
      if(/Open\s+Exports/i.test(txt) || /Open\s+Exports/i.test(ph) || /Search\s+RID/i.test(ph) || /Search\s+RID/i.test(txt)){
        var box=el.closest('div,section,article') || el;
        box.classList.add('vsp-hide-legacy');
      }
    }
  }

  function uniq(arr){
    var out=[], seen=new Set();
    for(var i=0;i<arr.length;i++){
      var x=arr[i];
      if(x && !seen.has(x)){ seen.add(x); out.push(x); }
    }
    return out;
  }

  function closestRow(btn){
    // prefer smaller containers: try known row tags/classes first
    return btn.closest('tr,[role="row"],li,.vsp-run-row,.run-row') ||
           btn.closest('div') ||
           btn.parentElement;
  }

  function getRows(panel){
    var btns=[].slice.call(panel.querySelectorAll('button')).filter(function(b){
      return /Use\s*RID/i.test((b.textContent||''));
    });
    if(btns.length){
      var rows=btns.map(closestRow);
      return uniq(rows);
    }
    return [];
  }

  function parseRid(text){
    var m=(text||'').match(/\b(VSP[_-][A-Za-z0-9_:-]+)\b/);
    return m ? m[1] : '';
  }
  function parseDate(text){
    var m=(text||'').match(/\b(20\d{2}-\d{2}-\d{2})\b/);
    return m ? m[1] : '';
  }
  function parseStatus(text){
    var tx=((text||'')+'').toUpperCase();
    if(tx.indexOf('DEGRADED')>=0) return 'DEGRADED';
    if(tx.indexOf('RUNNING')>=0) return 'RUNNING';
    if(tx.indexOf('FAIL')>=0) return 'FAIL';
    if(tx.indexOf('OK')>=0) return 'OK';
    if(tx.indexOf('UNKNOWN')>=0) return 'UNKNOWN';
    return 'UNKNOWN';
  }

  function ensureToolbar(panel){
    if(panel.querySelector('.vsp-runs-toolbar-v2')) return;

    var bar=document.createElement('div');
    bar.className='vsp-runs-toolbar-v2';

    var q=document.createElement('input');
    q.type='text';
    q.placeholder='Filter (RID / date / status)…';

    var st=document.createElement('select');
    st.innerHTML =
      '<option value="">Status: ALL</option>'+
      '<option value="OK">OK</option>'+
      '<option value="FAIL">FAIL</option>'+
      '<option value="DEGRADED">DEGRADED</option>'+
      '<option value="RUNNING">RUNNING</option>'+
      '<option value="UNKNOWN">UNKNOWN</option>';

    var sort=document.createElement('select');
    sort.innerHTML =
      '<option value="newest">Sort: Newest</option>'+
      '<option value="oldest">Sort: Oldest</option>'+
      '<option value="rid_asc">Sort: RID A→Z</option>'+
      '<option value="rid_desc">Sort: RID Z→A</option>';

    var btnClear=document.createElement('button');
    btnClear.className='btn';
    btnClear.textContent='Clear';

    var btnRefresh=document.createElement('button');
    btnRefresh.className='btn';
    btnRefresh.textContent='Refresh';

    var hint=document.createElement('div');
    hint.className='hint';
    hint.textContent='rows: 0';

    bar.appendChild(q);
    bar.appendChild(st);
    bar.appendChild(sort);
    bar.appendChild(btnClear);
    bar.appendChild(btnRefresh);
    bar.appendChild(hint);

    // place at top of panel
    var host = panel.querySelector('div,section,article') || panel;
    host.insertBefore(bar, host.firstChild);

    function apply(){
      var rows=getRows(panel);
      var needle=(q.value||'').trim().toLowerCase();
      var want=(st.value||'').trim().toUpperCase();

      var visible=[];
      for(var i=0;i<rows.length;i++){
        var r=rows[i];
        var tx=(r && r.textContent) ? r.textContent : '';
        var rid=parseRid(tx);
        var dt=parseDate(tx);
        var status=parseStatus(tx);
        var hay=(tx+' '+rid+' '+dt+' '+status).toLowerCase();

        var ok=true;
        if(needle && hay.indexOf(needle)<0) ok=false;
        if(want && status!==want) ok=false;

        r.style.display = ok ? '' : 'none';
        if(ok) visible.push(r);
      }

      // sort visible
      var mode=sort.value||'newest';
      visible.sort(function(a,b){
        var ta=(a.textContent||'');
        var tb=(b.textContent||'');
        var ra=parseRid(ta).toLowerCase();
        var rb=parseRid(tb).toLowerCase();
        var da=parseDate(ta) || '';
        var db=parseDate(tb) || '';
        if(mode==='rid_asc') return ra.localeCompare(rb);
        if(mode==='rid_desc') return rb.localeCompare(ra);
        if(mode==='oldest') return da.localeCompare(db);
        // newest default
        return db.localeCompare(da);
      });

      // re-append in best parent
      if(visible.length){
        var count=new Map();
        for(var i=0;i<visible.length;i++){
          var p=visible[i].parentElement;
          if(!p) continue;
          count.set(p, (count.get(p)||0)+1);
        }
        var best=null, bestN=0;
        count.forEach(function(v,k){ if(v>bestN){bestN=v; best=k;} });
        if(best){
          for(var i=0;i<visible.length;i++){
            try{ best.appendChild(visible[i]); }catch(e){}
          }
        }
      }

      hint.textContent = 'rows: '+visible.length+'/'+rows.length;
    }

    q.addEventListener('input', apply);
    st.addEventListener('change', apply);
    sort.addEventListener('change', apply);
    btnClear.addEventListener('click', function(){
      q.value=''; st.value=''; sort.value='newest'; apply();
    });
    btnRefresh.addEventListener('click', function(){
      // try click an existing refresh button in the panel
      var bs=[].slice.call(panel.querySelectorAll('button'));
      var b=null;
      for(var i=0;i<bs.length;i++){
        if(bs[i]!==btnRefresh && /refresh/i.test((bs[i].textContent||''))){ b=bs[i]; break; }
      }
      if(b) b.click(); else location.reload();
    });

    setTimeout(apply, 200);
    setTimeout(apply, 900);
    console.log('[P482c] runs toolbar V2 ready');
  }

  onReady(function(){
    injectCss();
    var panel=findRunsPanel();
    hideLegacy(panel);
    ensureToolbar(panel);
  });
})();


/* VSP_P482E_FIX_KEPT_KEEP_APPEND_TO_PUSH_V1 kept=1 keep=0 */


/* ===== VSP_P482F_RUNS_LIST_V3_FORCE_RENDER_HIDE_LEGACY_V1 =====
 * Commercial Runs: hide legacy list/header, render Runs List V3 from /api/vsp/runs
 * - keeps Scan/Start Run block intact (RUN button later)
 * - resilient selectors (no reliance on legacy table existing)
 */
(function(){
  const TAG = "[P482f]";
  const API = "/api/vsp/runs?limit=250&offset=0";
  const LS_KEYS = ["VSP_PIN_RID","VSP_RID","VSP_LAST_RID","RID","vsp_rid"];

  function log(){ try{ console.log.apply(console, [TAG].concat([].slice.call(arguments))); }catch(e){} }

  function qsa(sel, root){ try{ return Array.prototype.slice.call((root||document).querySelectorAll(sel)); }catch(e){ return []; } }
  function qs(sel, root){ try{ return (root||document).querySelector(sel); }catch(e){ return null; } }

  function textIncludes(el, needle){
    try{
      const t = (el && (el.innerText||el.textContent)||"").toLowerCase();
      return t.indexOf(needle.toLowerCase()) >= 0;
    }catch(e){ return false; }
  }

  function hideEl(el){
    if(!el) return;
    el.style.display = "none";
    el.setAttribute("data-vsp-hidden", "1");
  }

  function findByText(needle){
    const cands = qsa("div,section,article,p,span");
    for(const el of cands){
      if(textIncludes(el, needle)) return el;
    }
    return null;
  }

  function ensureStyle(){
    if(qs("#vsp_runs_v3_style")) return;
    const st = document.createElement("style");
    st.id = "vsp_runs_v3_style";
    st.textContent = `
      .vsp-runs-v3-wrap{ margin: 10px 0 12px 0; }
      .vsp-runs-v3-toolbar{ position: sticky; top: 8px; z-index: 5; backdrop-filter: blur(6px); }
      .vsp-runs-v3-bar{ display:flex; gap:8px; align-items:center; justify-content:space-between; padding:10px 12px; border-radius:12px;
        border:1px solid rgba(255,255,255,.08); background: rgba(10,14,24,.55); }
      .vsp-runs-v3-left{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
      .vsp-runs-v3-chip{ font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid rgba(255,255,255,.10);
        color: rgba(255,255,255,.86); cursor:pointer; user-select:none; }
      .vsp-runs-v3-chip[data-on="1"]{ border-color: rgba(255,255,255,.28); background: rgba(255,255,255,.06); }
      .vsp-runs-v3-input{ min-width: 280px; max-width: 520px; width: 36vw;
        font-size:12px; padding:6px 10px; border-radius:10px; outline:none;
        border:1px solid rgba(255,255,255,.10); background: rgba(0,0,0,.25); color: rgba(255,255,255,.90); }
      .vsp-runs-v3-right{ display:flex; gap:8px; align-items:center; }
      .vsp-runs-v3-sel{ font-size:12px; padding:6px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.10);
        background: rgba(0,0,0,.25); color: rgba(255,255,255,.90); }
      .vsp-runs-v3-btn{ font-size:12px; padding:6px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.10);
        background: rgba(255,255,255,.05); color: rgba(255,255,255,.90); cursor:pointer; }
      .vsp-runs-v3-tablewrap{ margin-top:10px; border-radius:12px; overflow:hidden; border:1px solid rgba(255,255,255,.08); }
      .vsp-runs-v3-table{ width:100%; border-collapse: collapse; }
      .vsp-runs-v3-table thead th{ font-size:12px; text-align:left; padding:10px 10px; color: rgba(255,255,255,.70);
        background: rgba(255,255,255,.03); border-bottom:1px solid rgba(255,255,255,.08); }
      .vsp-runs-v3-table tbody td{ font-size:12px; padding:9px 10px; border-bottom:1px solid rgba(255,255,255,.06);
        color: rgba(255,255,255,.85); vertical-align: top; }
      .vsp-runs-v3-table tbody tr:hover td{ background: rgba(255,255,255,.03); }
      .vsp-runs-v3-actions{ display:flex; gap:6px; flex-wrap:wrap; }
      .vsp-runs-v3-mini{ font-size:11px; padding:4px 8px; border-radius:10px; border:1px solid rgba(255,255,255,.12);
        background: rgba(255,255,255,.04); color: rgba(255,255,255,.88); cursor:pointer; text-decoration:none; }
      .vsp-runs-v3-muted{ color: rgba(255,255,255,.55); }
    `;
    document.head.appendChild(st);
  }

  function setRid(rid){
    try{
      LS_KEYS.forEach(k => { try{ localStorage.setItem(k, String(rid)); }catch(e){} });
      log("set RID =>", rid);
    }catch(e){}
  }

  function normStatus(x){
    const s = String(x||"").toUpperCase();
    if(!s) return "UNKNOWN";
    if(["OK","GREEN","PASS","PASSED"].includes(s)) return "OK";
    if(["WARN","AMBER"].includes(s)) return "WARN";
    if(["FAIL","RED","ERROR","FAILED"].includes(s)) return "FAIL";
    if(["UNKNOWN","NA","N/A","NONE"].includes(s)) return "UNKNOWN";
    return s;
  }

  function pick(obj, keys, dflt){
    for(const k of keys){
      if(obj && obj[k] != null && obj[k] !== "") return obj[k];
    }
    return dflt;
  }

  function pickDate(obj){
    const v = pick(obj, ["date","ts","time","started_at","ended_at","created_at"], "");
    if(!v) return "";
    // already looks like "2025-12-28 07:..." or ISO => keep
    return String(v).replace("T"," ").replace("Z","");
  }

  function hideLegacyRunsList(){
    // Hide legacy “No runs found” message only (keep Scan/Start Run)
    const noRuns = findByText("No runs found");
    if(noRuns) hideEl(noRuns);

    const noRuns2 = findByText("This environment has no run history");
    if(noRuns2) hideEl(noRuns2);

    // Hide legacy header row that shows: RID OVERALL CSV HTML SARIF SUMMARY ACTIONS
    const blocks = qsa("div,section,article");
    for(const el of blocks){
      const t = (el.innerText||"").trim().replace(/\s+/g," ");
      if(t === "RID OVERALL CSV HTML SARIF SUMMARY ACTIONS"){
        hideEl(el);
      }
    }
  }

  function findInsertPoint(){
    // Prefer inserting before “Scan / Start Run” block
    const scan = findByText("Scan / Start Run");
    if(scan){
      // walk up a bit to get a stable container
      let node = scan;
      for(let i=0;i<6 && node && node.parentElement;i++){
        if(node.classList && (node.classList.contains("card") || node.classList.contains("panel"))) break;
        node = node.parentElement;
      }
      return { parent: (scan.parentElement || document.body), before: scan };
    }
    // fallback: main content
    const main = qs("main") || qs("#content") || qs(".content") || document.body;
    return { parent: main, before: null };
  }

  function buildFrame(){
    ensureStyle();
    hideLegacyRunsList();

    if(qs("#vsp_runs_v3_wrap")) return;

    const ins = findInsertPoint();
    const wrap = document.createElement("div");
    wrap.id = "vsp_runs_v3_wrap";
    wrap.className = "vsp-runs-v3-wrap";

    wrap.innerHTML = `
      <div class="vsp-runs-v3-toolbar">
        <div class="vsp-runs-v3-bar">
          <div class="vsp-runs-v3-left">
            <span class="vsp-runs-v3-chip" data-k="ALL" data-on="1">ALL</span>
            <span class="vsp-runs-v3-chip" data-k="OK" data-on="0">OK</span>
            <span class="vsp-runs-v3-chip" data-k="WARN" data-on="0">WARN</span>
            <span class="vsp-runs-v3-chip" data-k="FAIL" data-on="0">FAIL</span>
            <span class="vsp-runs-v3-chip" data-k="UNKNOWN" data-on="0">UNKNOWN</span>
            <input class="vsp-runs-v3-input" id="vsp_runs_v3_q" placeholder="Search RID / status / anything..." />
          </div>
          <div class="vsp-runs-v3-right">
            <select class="vsp-runs-v3-sel" id="vsp_runs_v3_sort">
              <option value="date_desc">Date ↓ (newest)</option>
              <option value="date_asc">Date ↑ (oldest)</option>
              <option value="rid_desc">RID ↓</option>
              <option value="rid_asc">RID ↑</option>
            </select>
            <span class="vsp-runs-v3-muted" id="vsp_runs_v3_count">...</span>
            <button class="vsp-runs-v3-btn" id="vsp_runs_v3_reload">Reload</button>
          </div>
        </div>
      </div>

      <div class="vsp-runs-v3-tablewrap">
        <table class="vsp-runs-v3-table" id="vsp_runs_v3_table">
          <thead>
            <tr>
              <th style="width:32%">RID</th>
              <th style="width:12%">STATUS</th>
              <th style="width:20%">DATE</th>
              <th style="width:36%">ACTIONS</th>
            </tr>
          </thead>
          <tbody id="vsp_runs_v3_tbody">
            <tr><td colspan="4" class="vsp-runs-v3-muted">Loading…</td></tr>
          </tbody>
        </table>
      </div>
    `;

    if(ins.before) ins.parent.insertBefore(wrap, ins.before);
    else ins.parent.appendChild(wrap);

    // events
    const chips = qsa(".vsp-runs-v3-chip", wrap);
    chips.forEach(ch => {
      ch.addEventListener("click", () => {
        const k = ch.getAttribute("data-k");
        if(k === "ALL"){
          chips.forEach(x => x.setAttribute("data-on", x.getAttribute("data-k")==="ALL" ? "1":"0"));
        }else{
          qs('.vsp-runs-v3-chip[data-k="ALL"]', wrap).setAttribute("data-on","0");
          const cur = ch.getAttribute("data-on")==="1";
          ch.setAttribute("data-on", cur ? "0":"1");
        }
        renderLast();
      });
    });

    qs("#vsp_runs_v3_q", wrap).addEventListener("input", () => renderLast());
    qs("#vsp_runs_v3_sort", wrap).addEventListener("change", () => renderLast());
    qs("#vsp_runs_v3_reload", wrap).addEventListener("click", () => load());
  }

  let LAST_ITEMS = [];

  function applyFilters(items){
    const wrap = qs("#vsp_runs_v3_wrap");
    if(!wrap) return items;
    const q = (qs("#vsp_runs_v3_q", wrap).value||"").trim().toLowerCase();
    const chips = qsa(".vsp-runs-v3-chip", wrap).filter(x => x.getAttribute("data-on")==="1").map(x => x.getAttribute("data-k"));
    const active = chips.length ? chips : ["ALL"];

    let out = items.slice();

    if(active.indexOf("ALL")<0){
      out = out.filter(it => active.indexOf(it._status)>=0);
    }
    if(q){
      out = out.filter(it => (it._rid + " " + it._status + " " + it._date + " " + it._raw).toLowerCase().indexOf(q) >= 0);
    }

    const sort = qs("#vsp_runs_v3_sort", wrap).value;
    out.sort((a,b)=>{
      if(sort==="date_asc") return (a._date||"").localeCompare(b._date||"");
      if(sort==="rid_desc") return (b._rid||"").localeCompare(a._rid||"");
      if(sort==="rid_asc")  return (a._rid||"").localeCompare(b._rid||"");
      return (b._date||"").localeCompare(a._date||""); // date_desc
    });

    return out;
  }

  function render(items){
    LAST_ITEMS = items || LAST_ITEMS || [];
    const wrap = qs("#vsp_runs_v3_wrap");
    if(!wrap) return;
    const tbody = qs("#vsp_runs_v3_tbody", wrap);
    const count = qs("#vsp_runs_v3_count", wrap);

    const vis = applyFilters(LAST_ITEMS);
    count.textContent = `total=${LAST_ITEMS.length} shown=${vis.length}`;

    if(!vis.length){
      tbody.innerHTML = `<tr><td colspan="4" class="vsp-runs-v3-muted">No runs match filters.</td></tr>`;
      return;
    }

    tbody.innerHTML = "";
    for(const it of vis){
      const tr = document.createElement("tr");
      const dash = document.createElement("a");
      dash.className = "vsp-runs-v3-mini";
      dash.textContent = "Dashboard";
      dash.href = "/c/dashboard?rid="+encodeURIComponent(it._rid);
      dash.addEventListener("click", (e)=>{ try{ setRid(it._rid); }catch(_e){} });

      const use = document.createElement("span");
      use.className = "vsp-runs-v3-mini";
      use.textContent = "Use RID";
      use.addEventListener("click", ()=>{ setRid(it._rid); location.reload(); });

      const csv = document.createElement("a");
      csv.className = "vsp-runs-v3-mini";
      csv.textContent = "CSV";
      csv.href = "/api/vsp/export_csv?rid="+encodeURIComponent(it._rid);

      const sum = document.createElement("a");
      sum.className = "vsp-runs-v3-mini";
      sum.textContent = "Summary";
      sum.href = "/api/vsp/run_file_allow?rid="+encodeURIComponent(it._rid)+"&path="+encodeURIComponent("reports/run_gate_summary.json");

      const act = document.createElement("div");
      act.className = "vsp-runs-v3-actions";
      act.appendChild(use);
      act.appendChild(dash);
      act.appendChild(csv);
      act.appendChild(sum);

      tr.innerHTML = `
        <td><div style="font-weight:600">${it._rid||""}</div></td>
        <td>${it._status||"UNKNOWN"}</td>
        <td class="vsp-runs-v3-muted">${it._date||""}</td>
        <td></td>
      `;
      tr.children[3].appendChild(act);
      tbody.appendChild(tr);
    }
  }

  function renderLast(){ try{ render(LAST_ITEMS); }catch(e){ log("render err", e); } }

  async function load(){
    buildFrame();
    const wrap = qs("#vsp_runs_v3_wrap");
    if(!wrap) return;

    const tbody = qs("#vsp_runs_v3_tbody", wrap);
    tbody.innerHTML = `<tr><td colspan="4" class="vsp-runs-v3-muted">Loading…</td></tr>`;

    try{
      const r = await fetch(API, { credentials: "same-origin" });
      const j = await r.json();
      const items = (j && (j.items || j.data || j.runs || [])) || [];
      const norm = [];
      for(const x of items){
        const rid = String(pick(x, ["rid","RID","run_id","id"], "")||"");
        if(!rid) continue;
        const st = normStatus(pick(x, ["status","overall","verdict","gate","result"], "UNKNOWN"));
        const dt = pickDate(x);
        norm.push({
          _rid: rid,
          _status: st,
          _date: dt,
          _raw: JSON.stringify(x).slice(0,4000)
        });
      }
      log("runs fetched", "items=", items.length, "norm=", norm.length);
      render(norm);
      hideLegacyRunsList(); // keep legacy hidden after render
    }catch(e){
      log("load err", e);
      tbody.innerHTML = `<tr><td colspan="4" class="vsp-runs-v3-muted">Failed to load runs. Check console/network.</td></tr>`;
    }
  }

  function boot(){
    try{
      if(location.pathname.indexOf("/c/runs")<0 && location.pathname.indexOf("/runs")<0) return;
      buildFrame();
      load();
      log("runs list v3 ready");
    }catch(e){ log("boot err", e); }
  }

  if(document.readyState === "loading") document.addEventListener("DOMContentLoaded", boot);
  else boot();
})();

