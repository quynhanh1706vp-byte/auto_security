// VSP_P3K6_DISABLE_DASH_WATCHDOG_V1
(function(){
  try {
    const u = new URL(location.href);
    if (u.searchParams.get("watchdog") === "1") return; // debug only
  } catch (e) {}
  window.__VSP_DISABLE_DASH_WATCHDOG = 1;
  const noop = function(){};
  // common watchdog / degraded hooks (safe no-op)
  window.__vspDashWatchdog = noop;
  window.__vspDashboardWatchdog = noop;
  window.__vspWatchdogArm = noop;
  window.__vspWatchdogStart = noop;
  window.__vspWatchdogTrip = noop;
  window.__vspSetDegraded = noop;
  window.__vspMarkDegraded = noop;
  window.__vspCheckDegraded = function(){ return; };
  // best-effort hide banners if any
  try {
    const st=document.createElement("style");
    st.textContent = `
      .vsp-watchdog, .vsp-degraded, .degraded, .degraded-banner,
      [data-vsp-watchdog], [data-vsp-degraded] { display:none !important; }
    `;
    document.head.appendChild(st);
  } catch(e) {}
})();

(function(){try{if(window.__VSP_PIN_BADGE_V1)return;var s=document.createElement("script");s.src="/static/js/vsp_pin_dataset_badge_v1.js?v="+Date.now();document.head.appendChild(s);}catch(e){}})();

// VSP_BADGEPIN_V2_LOADER
(function(){
  try{
    if (window.__VSP_BADGEPIN_V2_LOADER) return;
    window.__VSP_BADGEPIN_V2_LOADER = true;
    var id="vsp-pin-dataset-badge-v2";
    if (document.getElementById(id)) return;
    var sc=document.createElement("script");
    sc.id=id;
    sc.src="/static/js/vsp_pin_dataset_badge_v2.js?v=" + (window.__VSP_ASSET_V || Date.now());
    sc.async=true;
    sc.defer=true;
    (document.head||document.documentElement).appendChild(sc);
  }catch(e){}
})();

/* VSP_P2_JS_ASSET_V_PINNED_V1 */
(function(){
  try {
    if (!window.__VSP_ASSET_V) window.__VSP_ASSET_V = "20251224_122204";
  } catch(e) {}
})();
function __vspAssetV(){
  try {
    return (window.__VSP_ASSET_V || "20251224_122204");
  } catch(e) {
    return "20251224_122204";
  }
}

/* VSP_P2_TREND_PATH_FORCE_V2 */
/* VSP_P0_CIO_GATECOUNTS_FALLBACK_V1P4C */
/* ===================== VSP_P0_CIO_GATECOUNTS_FALLBACK_V1P4C ===================== */
(function(){
  try{
    if (window.__VSP_GATECOUNTS_FALLBACK_V1P4C__) return;
    window.__VSP_GATECOUNTS_FALLBACK_V1P4C__ = true;

    function qp(name){
      try { return new URL(location.href).searchParams.get(name) || ""; } catch(e){ return ""; }
    }
    function num(v){ const n=Number(v); return Number.isFinite(n)?n:0; }
    function upper(k){ try{return String(k||"").toUpperCase();}catch(e){return "";} }

    function deriveCountsTotalFromObj(obj){
      try{
        if(!obj || typeof obj!=="object") return null;
        const bag = obj.counts_total || obj.counts_by_severity || obj.by_severity || obj.severity || obj.counts || null;
        if(!bag || typeof bag!=="object") return null;
        const sev = {CRITICAL:0,HIGH:0,MEDIUM:0,LOW:0,INFO:0,0};
        for (const k in bag){
          const uk=upper(k);
          if(uk in sev) sev[uk]=num(bag[k]);
        }
        const total = num(bag.TOTAL ?? bag.total) || (sev.CRITICAL+sev.HIGH+sev.MEDIUM+sev.LOW+sev.INFO+sev.TRACE);
        return {...sev, TOTAL: total};
      }catch(e){ return null; }
    }

    async function fetchJson(url){
      const r = await fetch(url, { credentials: "same-origin" });
      if(!r.ok) throw new Error("HTTP "+r.status+" "+url);
      return await r.json();
    }

    // Main: if dashboard payload has no counts_total, fetch gate summary and merge.
    window.__vspEnsureCountsTotalV1P4C = async function(payload){
      try{
        const rid = qp("rid");
        if(!rid) return payload;

        // If payload already has counts_total with TOTAL -> done
        const ct0 = deriveCountsTotalFromObj(payload);
      }catch(e){}
      return payload;
    };
  }catch(e){}
})();


/* ===================== VSP_P0_CIO_KPI_NO_NA_CONSIST_V1P4 ===================== */
(function(){
  try{
    if (window.__VSP_CIO_KPI_V1P4__) return;
    window.__VSP_CIO_KPI_V1P4__ = true;

    function _num(v){
      const n = Number(v);
      return Number.isFinite(n) ? n : 0;
    }
    function _upperKey(k){ try{return String(k||"").toUpperCase();}catch(e){return "";} }

    function _extractSevBag(obj){
      if(!obj || typeof obj !== "object") return null;
      return obj.counts_by_severity || obj.by_severity || obj.severity || obj.counts || null;
    }

    window.__vspCioNormalizeCountsV1P4 = function(obj){
      try{
        if(!obj || typeof obj !== "object") return obj;

        // normalize severity bucket
        const bag = _extractSevBag(obj);
        const sev = { CRITICAL:0, HIGH:0, MEDIUM:0, LOW:0, INFO:0, 0 };
        if (bag && typeof bag === "object"){
          for (const k in bag){
            const uk = _upperKey(k);
            if (uk in sev) sev[uk] = _num(bag[k]);
          }
        }

        // prefer explicit totals if present, else compute from sev
        const explicitTotal =
          obj.total ??
          obj.total_findings ??
          obj.findings_total ??
          (obj.counts_total && (obj.counts_total.TOTAL ?? obj.counts_total.total)) ??
          null;

        const computedTotal = sev.CRITICAL + sev.HIGH + sev.MEDIUM + sev.LOW + sev.INFO + sev.TRACE;
        const total = _num(explicitTotal) || computedTotal;

        // stamp back stable keys (no —)
        obj.total = total;
        obj.total_findings = total;
        obj.findings_total = total;

        obj.critical = _num(obj.critical) || sev.CRITICAL;
        obj.high = _num(obj.high) || sev.HIGH;

        obj.counts_by_severity = { ...sev };
        obj.by_severity = { ...sev };

        // stable counts_total shape
        obj.counts_total = { ...sev, TOTAL: total };

        return obj;
      }catch(e){ return obj; }
    };

    window.__vspCioNormalizePayloadV1P4 = function(payload){
      try{
        if(!payload || typeof payload !== "object") return payload;

        // common containers
        const cands = [
          payload,
          payload.data,
          payload.dashboard,
          payload.summary,
          payload.gate,
          payload.run_gate,
          payload.run,
          payload.counts_total
        ];
        for (const c of cands){
          if (c && typeof c === "object") window.__vspCioNormalizeCountsV1P4(c);
        }

        // if payload has counts_total as object with sev keys, also ensure TOTAL
        if (payload.counts_total && typeof payload.counts_total === "object"){
          const sev = { CRITICAL:0,HIGH:0,MEDIUM:0,LOW:0,INFO:0,0 };
          for (const k in payload.counts_total){
            const uk = _upperKey(k);
            if (uk in sev) sev[uk] = _num(payload.counts_total[k]);
          }
          const tot = _num(payload.counts_total.TOTAL ?? payload.counts_total.total) || (sev.CRITICAL+sev.HIGH+sev.MEDIUM+sev.LOW+sev.INFO+sev.TRACE);
          payload.counts_total = { ...sev, TOTAL: tot };
        }

        return payload;
      }catch(e){ return payload; }
    };

    // scrub any "—" appearing in UI (CIO trust)
    function scrubNA(root){
      try{
        root = root || document;
        const nodes = root.querySelectorAll("*");
        for (const n of nodes){
          const t = (n && n.childNodes && n.childNodes.length===1 && n.childNodes[0].nodeType===3) ? (n.textContent||"") : "";
          if(!t) continue;
          if (t.trim() === "—" || t.trim() === "-"){
            n.textContent = "0";
            n.setAttribute("title","No data for this run");
          }
          // common pattern: "Total findings: —"
          if (t.includes("—")){
            const tt = t.replace(/\bN\/A\b/g, "0").replace(/-/gi,"0");
            if (tt !== t){
              n.textContent = tt;
              n.setAttribute("title","No data for this run");
            }
          }
        }
      }catch(e){}
    }

    function attachObserver(){
      try{
        scrubNA(document);
        const obs = new MutationObserver(function(){ scrubNA(document); });
        obs.observe(document.documentElement || document.body, { childList:true, subtree:true, characterData:true });
      }catch(e){}
    }

    if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", attachObserver, { once:true });
    else attachObserver();

  }catch(e){}
})();
/* ===================== /VSP_P0_CIO_KPI_NO_NA_CONSIST_V1P4 ===================== */

/* VSP_P0_COMMERCIAL_DASH_STUB_V1J
   Purpose: replace corrupted luxe JS with a clean, stateless, commercial-safe dashboard renderer.
   Guarantees:
   - NO run_file_allow calls
   - No debug/internal file leaks
   - Safe parsing (node --check should PASS)
*/
(function(){
  "use strict";
  if (window.__VSP_DASH_STUB_V1J__) return;
  window.__VSP_DASH_STUB_V1J__ = true;

  function esc(s){
    try{
      return (s==null ? "" : String(s))
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;");
    }catch(e){ return ""; }
  }

  function qp(name){
    try{ return new URL(location.href).searchParams.get(name) || ""; }
    catch(e){ return ""; }
  }
  function lsGet(k){ try{ return localStorage.getItem(k) || ""; }catch(e){ return ""; } }
  function lsSet(k,v){ try{ localStorage.setItem(k, v); }catch(e){} }

  async function fetchJson(url){
    const r = await fetch(url, {credentials:"same-origin"});
    if(!r.ok) throw new Error("HTTP "+r.status+" for "+url);
    return await r.json();
  }

  function ensureAnchor(){
    try{
      if (document.getElementById("vsp-dashboard-main")) return document.getElementById("vsp-dashboard-main");
      const root = document.getElementById("vsp5_root") || document.body;
      const div = document.createElement("div");
      div.id = "vsp-dashboard-main";
      div.style.maxWidth = "1200px";
      div.style.margin = "0 auto";
      div.style.padding = "12px 12px 24px 12px";
      if (root && root.parentNode) root.parentNode.insertBefore(div, root);
      else document.body.insertBefore(div, document.body.firstChild);
      return div;
    }catch(e){ return null; }
  }

  function styleOnce(){
    if (document.getElementById("vsp-stub-style")) return;
    const st = document.createElement("style");
    st.id = "vsp-stub-style";
    st.textContent = `
      .vsp-stub-row{display:flex;gap:12px;flex-wrap:wrap;margin:10px 0 14px 0}
      .vsp-stub-card{flex:1;min-width:220px;padding:14px;border-radius:14px;border:1px solid rgba(255,255,255,.10);background:rgba(20,22,28,.65)}
      .vsp-stub-k{opacity:.75;font-size:12px}
      .vsp-stub-v{margin-top:6px;font-weight:900;font-size:26px;letter-spacing:.2px}
      .vsp-stub-h{font-weight:900;font-size:18px;margin:6px 0 8px 0}
      .vsp-stub-sub{opacity:.7;font-size:12px}
      .vsp-stub-pill{display:inline-flex;gap:8px;align-items:center;padding:7px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.18)}
      .vsp-stub-table{width:100%;border-collapse:collapse;margin-top:10px}
      .vsp-stub-table th,.vsp-stub-table td{padding:8px 10px;border-bottom:1px solid rgba(255,255,255,.08);font-size:12px}
      .vsp-stub-muted{opacity:.72}
      .vsp-stub-btn{cursor:pointer;user-select:none}
      .vsp-stub-btn:hover{filter:brightness(1.07)}
      code{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    `;
    document.head.appendChild(st);
  }

  async function resolveRid(){
    const rid = qp("rid") || lsGet("vsp_rid_selected") || lsGet("vsp_rid") || "";
    if (rid) return rid;
    try{
      const j = await fetchJson("/api/vsp/rid_latest");
      const r = (j && j.rid) ? String(j.rid) : "";
      if (r) lsSet("vsp_rid_selected", r);
      return r;
    }catch(e){
      return "";
    }
  }

  function renderShell(main, rid){
    main.innerHTML = `
      <div class="vsp-stub-row" style="align-items:center;justify-content:space-between;">
        <div>
          <div class="vsp-stub-h">Dashboard</div>
          <div class="vsp-stub-sub">Unified Findings (8 tools) • RID: <code>${esc(rid||"—")}</code></div>
        </div>
        <div class="vsp-stub-pill vsp-stub-btn" id="vsp-stub-reload">↻ Refresh</div>
      </div>

      <div class="vsp-stub-row" id="vsp-stub-kpis">
        <div class="vsp-stub-card"><div class="vsp-stub-k">Total Findings</div><div class="vsp-stub-v" id="k_total">—</div><div class="vsp-stub-sub vsp-stub-muted" id="k_total_sub"></div></div>
        <div class="vsp-stub-card"><div class="vsp-stub-k">Critical</div><div class="vsp-stub-v" id="k_crit">—</div></div>
        <div class="vsp-stub-card"><div class="vsp-stub-k">High</div><div class="vsp-stub-v" id="k_high">—</div></div>
        <div class="vsp-stub-card"><div class="vsp-stub-k">Medium</div><div class="vsp-stub-v" id="k_med">—</div></div>
      </div>

      <div class="vsp-stub-card">
        <div class="vsp-stub-h" style="font-size:14px;">Top Findings</div>
        <div class="vsp-stub-sub vsp-stub-muted">Stateless via APIs (no internal file paths).</div>
        <table class="vsp-stub-table">
          <thead><tr><th>Severity</th><th>Title</th><th>Tool</th><th>File</th></tr></thead>
          <tbody id="top_body"><tr><td colspan="4" class="vsp-stub-muted">Loading…</td></tr></tbody>
        </table>
      </div>
    `;
    const btn = document.getElementById("vsp-stub-reload");
    if (btn) btn.onclick = ()=>{ try{ location.reload(); }catch(e){} };
  }

  function setText(id, v){
    const el = document.getElementById(id);
    if (el) el.textContent = (v==null ? "—" : String(v));
  }

  function normalizeCounts(j){
    const counts = (j && (j.counts_total || j.counts_by_severity || (j.meta && j.meta.counts_by_severity))) || null;
    if (!counts || typeof counts !== "object") return null;
    const g = (k)=> parseInt((counts[k] ?? 0) || 0, 10) || 0;
    return {
      total: g("TOTAL") || (g("CRITICAL")+g("HIGH")+g("MEDIUM")+g("LOW")+g("INFO")+g("TRACE")),
      CRITICAL: g("CRITICAL"),
      HIGH: g("HIGH"),
      MEDIUM: g("MEDIUM"),
      LOW: g("LOW"),
      INFO: g("INFO"),
      g("TRACE"),
    };
  }

  async function loadAndRender(rid){
    const main = ensureAnchor();
    if (!main) return;
    styleOnce();
    renderShell(main, rid);

    if (!rid){
      setText("k_total","—"); setText("k_crit","—"); setText("k_high","—"); setText("k_med","—");
      const sub = document.getElementById("k_total_sub");
      if (sub) sub.textContent = "Select a valid RID.";
      const tb = document.getElementById("top_body");
      if (tb) tb.innerHTML = `<tr><td colspan="4" class="vsp-stub-muted">No RID selected.</td></tr>`;
      return;
    }

    // KPI from run_gate_summary_v1 (commercial contract)
    try{
      const j = await fetchJson("/api/vsp/run_gate_summary_v1?rid=" + encodeURIComponent(rid));
      const c = normalizeCounts(j) || {total:0,CRITICAL:0,HIGH:0,MEDIUM:0};
      setText("k_total", c.total);
      setText("k_crit", c.CRITICAL);
      setText("k_high", c.HIGH);
      setText("k_med", c.MEDIUM);
      const sub = document.getElementById("k_total_sub");
      if (sub) sub.textContent = (c.total===0 ? "No data for this run." : "");
    }catch(e){
      const sub = document.getElementById("k_total_sub");
      if (sub) sub.textContent = "Cannot load KPI. Retry.";
    }

    // Top findings
    try{
      const tj = await fetchJson("/api/vsp/top_findings_v3c?rid=" + encodeURIComponent(rid) + "&limit=8");
      const items = (tj && (tj.items || tj.findings || tj.data)) || [];
      const tb = document.getElementById("top_body");
      if (!tb) return;
      if (!items.length){
        tb.innerHTML = `<tr><td colspan="4" class="vsp-stub-muted">No findings.</td></tr>`;
        return;
      }
      tb.innerHTML = items.slice(0,8).map(it=>{
        const sev = esc((it && it.severity) || "INFO");
        const title = esc((it && it.title) || "");
        const tool = esc((it && it.tool) || "");
        const file = esc((it && it.file) || "");
        return `<tr><td>${sev}</td><td>${title}</td><td>${tool}</td><td class="vsp-stub-muted">${file}</td></tr>`;
      }).join("");
    }catch(e){
      const tb = document.getElementById("top_body");
      if (tb) tb.innerHTML = `<tr><td colspan="4" class="vsp-stub-muted">Cannot load top findings.</td></tr>`;
    }
  }

  async function boot(){
    try{
      if (location.pathname !== "/vsp5") return;
      const rid = await resolveRid();
      await loadAndRender(rid);
    }catch(e){}
  }

  if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", boot);
  else boot();
})();


/* VSP_P1_REQUIRED_MARKERS_DASH_V1 */
(function(){
  function ensureAttr(el, k, v){ try{ if(el && !el.getAttribute(k)) el.setAttribute(k,v); }catch(e){} }
  function ensureId(el, v){ try{ if(el && !el.id) el.id=v; }catch(e){} }
  function ensureTestId(el, v){ ensureAttr(el, "data-testid", v); }
  function ensureHiddenKpi(container){
    // Create hidden markers so gate can verify presence without altering layout
    try{
      const ids = ["kpi_total","kpi_critical","kpi_high","kpi_medium","kpi_low","kpi_info_trace"];
      let box = container.querySelector('#vsp-kpi-testids');
      if(!box){
        box = document.createElement('div');
        box.id = "vsp-kpi-testids";
        box.style.display = "none";
        container.appendChild(box);
      }
      ids.forEach(id=>{
        if(!box.querySelector('[data-testid="'+id+'"]')){
          const d=document.createElement('span');
          d.setAttribute('data-testid', id);
          box.appendChild(d);
        }
      });
    }catch(e){}
  }

  function run(){
    try {
      // Dashboard
      const dash = document.getElementById("vsp-dashboard-main") || document.querySelector('[id="vsp-dashboard-main"], #vsp-dashboard, .vsp-dashboard, main, body');
      if(dash) {
        ensureId(dash, "vsp-dashboard-main");
        // add required KPI data-testid markers
        ensureHiddenKpi(dash);
      }

      // Runs
      const runs = document.getElementById("vsp-runs-main") || document.querySelector('#vsp-runs, .vsp-runs, main, body');
      if(runs) ensureId(runs, "vsp-runs-main");

      // Data Source
      const ds = document.getElementById("vsp-data-source-main") || document.querySelector('#vsp-data-source, .vsp-data-source, main, body');
      if(ds) ensureId(ds, "vsp-data-source-main");

      // Settings
      const st = document.getElementById("vsp-settings-main") || document.querySelector('#vsp-settings, .vsp-settings, main, body');
      if(st) ensureId(st, "vsp-settings-main");

      // Rule overrides
      const ro = document.getElementById("vsp-rule-overrides-main") || document.querySelector('#vsp-rule-overrides, .vsp-rule-overrides, main, body');
      if(ro) ensureId(ro, "vsp-rule-overrides-main");
    } catch(e) {}
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", run, { once:true });
  } else {
    run();
  }
  // re-run after soft refresh renders
  setTimeout(run, 300);
  setTimeout(run, 1200);
})();
/* end VSP_P1_REQUIRED_MARKERS_DASH_V1 */




/* VSP_P2_DASHBOARD_CIO_WIDGETS_V1 */
(function(){
  function el(tag, attrs, html){
    const e=document.createElement(tag);
    if(attrs){ for(const k of Object.keys(attrs)) e.setAttribute(k, attrs[k]); }
    if(html!==undefined) e.innerHTML=html;
    return e;
  }
  function esc(s){ return String(s??"").replace(/[&<>"]/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;" }[c])); }

  async function jget(url){
    const r=await fetch(url, {credentials:"same-origin"});
    const t=await r.text();
    try { return {ok:true, code:r.status, json: JSON.parse(t)}; }
    catch(e){ return {ok:false, code:r.status, text:t}; }
  }

  function postureScore(counts){
    // simple heuristic: heavier weight for higher severity
    const c=counts||{};
    const crit=+(c.CRITICAL||0), hi=+(c.HIGH||0), med=+(c.MEDIUM||0), lo=+(c.LOW||0), info=+(c.INFO||0), trace=+(c.TRACE||0);
    const total=crit+hi+med+lo+info+trace;
    if(total<=0) return {score:100, label:"Clean"};
    const penalty = crit*20 + hi*10 + med*5 + lo*2 + info*1 + trace*0.2;
    const score = Math.max(0, Math.round(100 - Math.min(100, penalty)));
    const label = score>=90?"Strong": score>=75?"Good": score>=55?"Watch": "Risk";
    return {score, label, total};
  }

  function renderTrend(points){
    // lightweight sparkline using SVG, no libs
    const w=420,h=64,pad=6;
    const pts=(points||[]).slice(-40);
    if(!pts.length) return `<div style="opacity:.8">No trend data</div>`;
    const vals=pts.map(x=>+((x.total??x.value??x.y??0)));
    const min=Math.min(...vals), max=Math.max(...vals);
    const sx=(i)=> pad + i*( (w-2*pad) / Math.max(1, vals.length-1) );
    const sy=(v)=> {
      if(max===min) return h/2;
      return pad + (h-2*pad) * (1 - (v-min)/(max-min));
    };
    const d=vals.map((v,i)=> (i? "L":"M")+sx(i).toFixed(1)+","+sy(v).toFixed(1)).join(" ");
    return `
      <svg width="${w}" height="${h}" viewBox="0 0 ${w} ${h}" role="img" aria-label="trend">
        <path d="${d}" fill="none" stroke="currentColor" stroke-width="2" opacity="0.9"/>
      </svg>
      <div style="font-size:12px;opacity:.8;margin-top:4px">${esc(pts[pts.length-1].label||"")}</div>
    `;
  }

  function ensureContainer(){
    const host = document.querySelector('#vsp-dashboard-main') || document.querySelector('[data-testid="vsp-dashboard-main"]') || document.body;
    let root = document.querySelector('#vsp-cio-root');
    if(root) return root;
    root = el('div', {id:'vsp-cio-root', 'data-testid':'vsp-cio-root'});
    // minimal layout; rely on existing dark css; keep inline for safety
    root.style.cssText = "margin:16px auto;max-width:1200px;padding:0 12px;";
    host.prepend(root);
    return root;
  }

  function card(title, bodyHtml){
    const c=el('div', {'data-testid':'vsp-card'});
    c.style.cssText="background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);border-radius:14px;padding:14px;box-shadow:0 10px 25px rgba(0,0,0,0.25)";
    const h=el('div', null, `<div style="font-size:12px;letter-spacing:.08em;opacity:.75;text-transform:uppercase">${esc(title)}</div>`);
    const b=el('div', null, bodyHtml);
    b.style.cssText="margin-top:10px";
    c.appendChild(h); c.appendChild(b);
    return c;
  }

  function row(){
    const r=el('div');
    r.style.cssText="display:grid;gap:12px;grid-template-columns:repeat(12,1fr);align-items:stretch;margin-top:12px";
    return r;
  }

  function col(span, node){
    const wrap=el('div');
    wrap.style.cssText=`grid-column: span ${span};`;
    wrap.appendChild(node);
    return wrap;
  }

  function kpiTile(label, value){
    return `
      <div style="display:flex;flex-direction:column;gap:4px">
        <div style="font-size:12px;opacity:.75">${esc(label)}</div>
        <div style="font-size:22px;font-weight:700">${esc(value)}</div>
      </div>
    `;
  }

  function topFindingsTable(items){
    const rows=(items||[]).slice(0,10).map(it=>{
      const sev=esc(it.severity||"");
      const tool=esc(it.tool||"");
      const title=esc(it.title||"");
      const file=esc(it.file||"");
      return `<tr>
        <td style="padding:8px 10px;opacity:.9">${sev}</td>
        <td style="padding:8px 10px;opacity:.85">${tool}</td>
        <td style="padding:8px 10px;max-width:520px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${title}</td>
        <td style="padding:8px 10px;opacity:.75;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:360px">${file}</td>
      </tr>`;
    }).join("");
    if(!rows) return `<div style="opacity:.8">No findings</div>`;
    return `
      <div style="overflow:auto">
        <table style="width:100%;border-collapse:collapse;font-size:13px">
          <thead>
            <tr style="text-align:left;opacity:.75">
              <th style="padding:8px 10px">Severity</th>
              <th style="padding:8px 10px">Tool</th>
              <th style="padding:8px 10px">Title</th>
              <th style="padding:8px 10px">File</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      </div>`;
  }

  async function run(){
    try{
      const root=ensureContainer();
      root.innerHTML = `<div data-testid="vsp-cio-loading" style="opacity:.8">Loading dashboard…</div>`;

      const ridRes=await jget('/api/vsp/rid_latest');
      const rid = ridRes.ok ? (ridRes.json.rid||"") : "";
      const trendRes=await jget('/api/vsp/trend_v1?path=');
      const topRes=await jget('/api/vsp/top_findings_v3c?limit=10');

      // try counts from 
      let counts=null;
      if(rid){
        const gate=await jget(`/api/vsp/run_gate_v3?rid=${encodeURIComponent(rid)}`);
        if(gate.ok && gate.json && gate.json.by_severity) counts = gate.json.by_severity;
        else if(gate.ok && gate.json && gate.json.counts_total) counts = gate.json.counts_total;
      }

      const ps=postureScore(counts||{});
      const kpi = `
        <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap">
          ${kpiTile("Latest RID", rid || "—")}
          ${kpiTile("Posture", ps.score + " / 100 ("+ps.label+")")}
          ${kpiTile("Total", (ps.total??(topRes.ok? (topRes.json.total??0):0)) )}
        </div>
      `;

      const r1=row();
      r1.appendChild(col(7, card("Security Posture", kpi)));
      r1.appendChild(col(5, card("Trend", renderTrend(trendRes.ok ? (trendRes.json.points||[]) : []))));

      const r2=row();
      r2.appendChild(col(12, card("Top Findings", topFindingsTable(topRes.ok ? (topRes.json.items||[]) : []))));

      root.innerHTML="";
      root.appendChild(r1);
      root.appendChild(r2);
    }catch(e){
      try{
        const root=ensureContainer();
        root.innerHTML = `<div style="opacity:.8">Dashboard error: ${esc(e && e.message ? e.message : e)}</div>`;
      }catch(_){}
    }
  }

  if(document.readyState==="loading") document.addEventListener("DOMContentLoaded", run);
  else run();
})();



/* VSP_P2_DASHBOARD_CIO_POLISH_V2 */
(function(){
  function esc(s){ return String(s??"").replace(/[&<>"]/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;" }[c])); }
  function sevBadge(sev){
    const S=(sev||"").toUpperCase();
    const map={
      "CRITICAL":["rgba(255,64,80,0.18)","rgba(255,64,80,0.55)"],
      "HIGH":["rgba(255,140,64,0.18)","rgba(255,140,64,0.55)"],
      "MEDIUM":["rgba(255,214,64,0.16)","rgba(255,214,64,0.55)"],
      "LOW":["rgba(120,200,255,0.14)","rgba(120,200,255,0.50)"],
      "INFO":["rgba(170,170,170,0.14)","rgba(170,170,170,0.45)"],
      "TRACE":["rgba(120,255,180,0.12)","rgba(120,255,180,0.45)"]
    };
    const c=map[S]||["rgba(255,255,255,0.08)","rgba(255,255,255,0.18)"];
    return `<span style="
      display:inline-flex;align-items:center;gap:6px;
      padding:4px 10px;border-radius:999px;
      background:${c[0]};border:1px solid ${c[1]};
      font-size:12px;letter-spacing:.04em">
      <span style="width:7px;height:7px;border-radius:50%;background:${c[1]}"></span>${esc(S||"—")}
    </span>`;
  }

  async function jget(url){
    const r=await fetch(url, {credentials:"same-origin"});
    const t=await r.text();
    try { return {ok:true, code:r.status, json: JSON.parse(t)}; }
    catch(e){ return {ok:false, code:r.status, text:t}; }
  }

  function upgradeTopFindings(){
    const root=document.querySelector("#vsp-cio-root");
    if(!root) return;

    // find the Top Findings card table (created by V1)
    const tables=root.querySelectorAll("table");
    if(!tables || !tables.length) return;

    // apply table polish
    for(const tb of tables){
      tb.style.borderCollapse="separate";
      tb.style.borderSpacing="0";
      tb.style.width="100%";
      const ths=tb.querySelectorAll("thead th");
      ths.forEach(th=>{
        th.style.position="sticky";
        th.style.top="0";
        th.style.background="rgba(15,18,24,0.92)";
        th.style.backdropFilter="blur(8px)";
        th.style.zIndex="1";
        th.style.borderBottom="1px solid rgba(255,255,255,0.10)";
      });

      const trs=tb.querySelectorAll("tbody tr");
      trs.forEach(tr=>{
        tr.style.transition="background 120ms ease";
        tr.addEventListener("mouseenter", ()=> tr.style.background="rgba(255,255,255,0.05)");
        tr.addEventListener("mouseleave", ()=> tr.style.background="transparent");
        const tds=tr.querySelectorAll("td");
        if(tds && tds.length){
          // first col is severity text -> replace with badge
          const sev = tds[0].textContent || "";
          tds[0].innerHTML = sevBadge(sev.trim());
        }
      });
    }
  }

  async function addExportButtons(){
    const root=document.querySelector("#vsp-cio-root");
    if(!root) return;

    // put buttons above first row
    let bar=root.querySelector('[data-testid="vsp-cio-exportbar"]');
    if(bar) return;

    const rel=await jget("/api/vsp/release_latest");
    const dl = rel.ok ? (rel.json.download_url || "") : "";
    const audit = rel.ok ? (rel.json.audit_url || "") : "";
    const manifest = rel.ok ? (rel.json.manifest_path || "") : "";

    bar=document.createElement("div");
    bar.setAttribute("data-testid","vsp-cio-exportbar");
    bar.style.cssText="display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:12px 0 4px 0";

    function btn(label, href){
      const a=document.createElement("a");
      a.textContent=label;
      a.href=href||"#";
      a.target="_blank";
      a.rel="noopener";
      a.style.cssText="display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:12px;border:1px solid rgba(255,255,255,0.12);background:rgba(255,255,255,0.04);text-decoration:none;color:inherit;font-size:13px";
      a.onmouseenter=()=>a.style.background="rgba(255,255,255,0.06)";
      a.onmouseleave=()=>a.style.background="rgba(255,255,255,0.04)";
      if(!href){ a.style.opacity="0.45"; a.onclick=(e)=>e.preventDefault(); }
      return a;
    }

    bar.appendChild(btn("Download ZIP", dl));
    bar.appendChild(btn("Open Audit", audit));
    // manifest_path is a path inside run dir; if you have an endpoint to fetch it, change here later.
    bar.appendChild(btn("Manifest (path)", manifest ? "#" : ""));

    root.prepend(bar);
  }

  function run(){
    // delay a bit to let V1 render
    setTimeout(()=>{
      addExportButtons().finally(()=>{});
      upgradeTopFindings();
    }, 350);
  }

  if(document.readyState==="loading") document.addEventListener("DOMContentLoaded", run);
  else run();
})();


/* VSP_DASH_LUXE_GRID_SHELLS_V1 */
(function(){
  function q(sel){ return document.querySelector(sel); }
  function wrapDash(){
    // Only on /vsp5
    if (location.pathname !== "/vsp5") return;

    // prefer existing root(s)
    var root = q("#vsp-dashboard-main") || q("#vsp_tab_root") || document.body;
    if (!root) return;

    // create dashboard grid container once
    var grid = q(".vsp-dash-grid");
    if (!grid){
      grid = document.createElement("div");
      grid.className = "vsp-dash-grid";
      // move visible dashboard content into grid
      var kids = Array.from(root.children);
      kids.forEach(function(el){ grid.appendChild(el); });
      root.appendChild(grid);
    }

    // hero header placeholder (if no top header exists)
    if (!q(".vsp-dash-hero")){
      var hero = document.createElement("div");
      hero.className="vsp-dash-hero";
      hero.innerHTML = '<div style="display:flex;justify-content:space-between;align-items:center;gap:12px">' +
        '<div><div style="font-size:14px;color:rgba(226,232,240,.95);font-weight:800">VSP 2025 — Security Overview</div>' +
        '<div style="font-size:12px;color:rgba(148,163,184,.85);margin-top:4px">Commercial CIO view • unified findings • 8-tool pipeline</div></div>' +
        '<div class="vsp-badge" style="font-family:var(--mono)">/vsp5</div>' +
      '</div>';
      grid.prepend(hero);
    }

    // Try detect KPI container; if not, create shell that existing code can fill later
    var kpi = q("#vsp-kpi-root") || q(".vsp-kpi-grid");
    if (!kpi){
      kpi = document.createElement("div");
      kpi.id="vsp-kpi-root";
      kpi.className="vsp-kpi-grid";
      // insert after hero
      var hero2=q(".vsp-dash-hero");
      hero2 && hero2.insertAdjacentElement("afterend", kpi);
    } else {
      kpi.classList.add("vsp-kpi-grid");
      kpi.id = kpi.id || "vsp-kpi-root";
    }

    // Create 4 section shells (charts/tables placeholders) if missing
    function ensureSection(id,title,full){
      var el=q("#"+id);
      if (el) return el;
      el=document.createElement("div");
      el.id=id;
      el.className="vsp-section"+(full?" vsp-section--full":"");
      el.innerHTML = '<div class="vsp-section-h"><div class="vsp-section-title">'+title+'</div></div>' +
                     '<div class="vsp-section-body"><div class="vsp-skeleton">Loading…</div></div>';
      grid.appendChild(el);
      return el;
    }
    ensureSection("vsp-sec-chart-sev","Severity Distribution",false);
    ensureSection("vsp-sec-chart-trend","Trend (Findings over time)",false);
    ensureSection("vsp-sec-chart-tool","Critical/High by Tool",false);
    ensureSection("vsp-sec-chart-cwe","Top CWE Exposure",false);
    ensureSection("vsp-sec-table-top","Top Risk Findings",true);
    ensureSection("vsp-sec-table-bytool","By Tool Buckets",true);
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", wrapDash);
  } else {
    wrapDash();
  }
})();
/* ===== VSP_P2_FILTERBAR_V1 (luxe) ===== */
(function(){
  function ready(fn){ if(document.readyState!=="loading") fn(); else document.addEventListener("DOMContentLoaded", fn); }
  function qs(sel,root){ return (root||document).querySelector(sel); }

  function mount(){
    if (document.getElementById("vsp-p2-filterbar")) return;

    var nav = qs(".topnav.vsp5nav");
    var host = nav ? nav.parentNode : document.body;

    var bar = document.createElement("div");
    bar.id="vsp-p2-filterbar";
    bar.style.cssText="margin:10px 12px 0 12px;padding:10px 12px;border:1px solid #333;border-radius:12px;background:#0f1218;color:#ddd;font:12px/1.2 monospace;display:flex;gap:10px;align-items:center;flex-wrap:wrap";
    bar.innerHTML =
      '<span style="opacity:.9">FILTER</span>' +
      '<select id="vsp-p2-sev" style="background:#111;border:1px solid #333;color:#ddd;border-radius:10px;padding:6px 10px">' +
        '<option value="">severity=ALL</option>' +
        '<option>CRITICAL</option><option>HIGH</option><option>MEDIUM</option><option>LOW</option><option>INFO</option><option>TRACE</option>' +
      '</select>' +
      '<input id="vsp-p2-q" placeholder="search title/file/tool/cwe" style="min-width:260px;background:#111;border:1px solid #333;color:#ddd;border-radius:10px;padding:6px 10px" />' +
      '<button id="vsp-p2-apply" style="background:#111;border:1px solid #333;color:#bfffe8;border-radius:10px;padding:6px 10px;cursor:pointer">Apply → Data Source</button>' +
      '<button id="vsp-p2-clear" style="background:#111;border:1px solid #333;color:#ffe6bf;border-radius:10px;padding:6px 10px;cursor:pointer">Clear</button>';

    if (nav && nav.nextSibling) host.insertBefore(bar, nav.nextSibling);
    else host.insertBefore(bar, host.firstChild);

    function go(){
      var sev = (qs("#vsp-p2-sev")||{}).value || "";
      var q = (qs("#vsp-p2-q")||{}).value || "";
      var url = new URL("/data_source", window.location.origin);
      if (sev) url.searchParams.set("severity", sev);
      if (q) url.searchParams.set("q", q);
      window.location.href = url.toString();
    }

    qs("#vsp-p2-apply").addEventListener("click", go);
    qs("#vsp-p2-clear").addEventListener("click", function(){
      qs("#vsp-p2-sev").value="";
      qs("#vsp-p2-q").value="";
    });

    // Quick drilldown: Ctrl+click any severity word → Data Source severity
    document.addEventListener("click", function(e){
      if(!e.ctrlKey) return;
      var t=(e.target && e.target.textContent || "").trim().toUpperCase();
      var S=["CRITICAL","HIGH","MEDIUM","LOW","INFO","TRACE"];
      if(S.indexOf(t)>=0){
        var url = new URL("/data_source", window.location.origin);
        url.searchParams.set("severity", t);
        window.location.href=url.toString();
      }
    }, true);
  }

  ready(mount);
})();


// VSP_P3K6_DISABLE_DASH_WATCHDOG_V1 (tail)
try {
  if (window.__VSP_DISABLE_DASH_WATCHDOG) {
    const noop = function(){};
    window.__vspDashWatchdog = noop;
    window.__vspDashboardWatchdog = noop;
    window.__vspWatchdogArm = noop;
    window.__vspWatchdogStart = noop;
    window.__vspWatchdogTrip = noop;
    window.__vspSetDegraded = noop;
    window.__vspMarkDegraded = noop;
    window.__vspCheckDegraded = function(){ return; };
  }
} catch(e) {}

