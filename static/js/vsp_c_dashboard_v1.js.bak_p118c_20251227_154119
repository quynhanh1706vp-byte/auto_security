/* VSP_P117_C_DASHBOARD_FILL_DATA_V1
 * - sanitize RID + auto pick latest real RID
 * - fetch: /api/vsp/dashboard_kpis_v4, /api/vsp/top_findings_v2, /api/vsp/trend_v1, /api/vsp/topcwe_v1
 * - render: KPI texts, Top Findings table, Trend mini (SVG), TopCWE bars (if container exists)
 * No external libs.
 */
(() => {
  const $ = (sel) => document.querySelector(sel);
  const $$ = (sel) => Array.from(document.querySelectorAll(sel));

  function qparam(name){
    try { return new URLSearchParams(location.search).get(name); } catch(e){ return null; }
  }
  function setText(id, v){
    const el = document.getElementById(id);
    if (!el) return;
    el.textContent = (v === null || v === undefined) ? "" : String(v);
  }

  function isValidRid(r){
    if (!r) return false;
    r = String(r).trim();
    if (!r) return false;

    const up = r.toUpperCase();
    if (/FILL_REAL_DATA|\.JS|\.CSS|TABS_P1_V1/.test(up)) return false;

    if (/^(VSP_CI_\d{8}_\d{6})$/.test(r)) return true;
    if (/^(RUN_)/.test(r) && /\d/.test(r) && r.length > 12) return true;
    if (/^(RUN_VSP_)/.test(r) && /\d/.test(r)) return true;

    if (!/^(VSP_|RUN_)/.test(r)) return false;
    if (!/\d/.test(r)) return false;
    if (!/^[A-Za-z0-9_:-]+$/.test(r)) return false;
    return true;
  }

  async function fetchJson(url){
    const r = await fetch(url, { credentials: "same-origin" });
    const t = await r.text();
    let j=null; try{ j=JSON.parse(t); }catch(e){}
    return { ok:r.ok, status:r.status, json:j, text:t };
  }

  async function resolveRid(){
    // URL rid
    let rid = qparam("rid");
    if (rid !== null) rid = (rid || "").trim();
    if (isValidRid(rid)) return rid;

    // If URL had invalid rid -> remove to avoid loops
    if (rid !== null && rid && !isValidRid(rid)) {
      try {
        const u = new URL(location.href);
        u.searchParams.delete("rid");
        location.replace(u.toString());
        return null;
      } catch(e){}
    }

    // Latest from API
    const runs = await fetchJson(`/api/ui/runs_v3?limit=1&include_ci=1`);
    const latest = (runs?.json?.items?.[0]?.rid || "").trim();
    if (isValidRid(latest)) return latest;

    // localStorage (only if valid)
    try {
      const last = (localStorage.getItem("vsp_rid") || "").trim();
      if (isValidRid(last)) return last;
      if (last && !isValidRid(last)) localStorage.removeItem("vsp_rid");
    } catch(e){}
    return "";
  }

  function findTopFindingsTable(){
    const tables = $$("table");
    for (const t of tables){
      const head = t.querySelector("thead") || t;
      const txt = (head.textContent || "").toUpperCase();
      if (txt.includes("SEVERITY") && txt.includes("TITLE")) return t;
    }
    return null;
  }

  function normalizeFinding(it){
    if (!it) return null;
    const severity =
      it.severity || it.sev || it.level || it.priority || it.impact || "";
    const title =
      it.title || it.message || it.rule_message || it.check_name || it.id || it.cwe || it.cve || "";
    const tool =
      it.tool || it.engine || it.source || it.scanner || "";
    const file =
      it.file || it.path || it.location?.path || it.location?.file || it.artifact || "";
    return {
      severity: String(severity || "").toUpperCase(),
      title: String(title || ""),
      tool: String(tool || ""),
      file: String(file || ""),
    };
  }

  function renderTopFindings(items){
    const table = findTopFindingsTable();
    if (!table) return;

    let body = table.querySelector("tbody");
    if (!body){
      body = document.createElement("tbody");
      table.appendChild(body);
    }
    body.innerHTML = "";

    const rows = (Array.isArray(items) ? items : [])
      .map(normalizeFinding)
      .filter(Boolean)
      .slice(0, 20);

    if (!rows.length){
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="4" style="opacity:.75;padding:10px">No findings</td>`;
      body.appendChild(tr);
      return;
    }

    for (const r of rows){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td style="padding:8px 10px;opacity:.9;white-space:nowrap">${r.severity || "-"}</td>
        <td style="padding:8px 10px;opacity:.95">${escapeHtml(r.title)}</td>
        <td style="padding:8px 10px;opacity:.85;white-space:nowrap">${escapeHtml(r.tool)}</td>
        <td style="padding:8px 10px;opacity:.75">${escapeHtml(r.file)}</td>
      `;
      body.appendChild(tr);
    }
  }

  function escapeHtml(s){
    s = String(s || "");
    return s.replace(/[&<>"']/g, (c) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));
  }

  function renderTrendMini(points){
    const host = $("#trend-mini");
    if (!host) return;

    let series = [];
    if (Array.isArray(points)) {
      for (const p of points) {
        if (!p) continue;
        const y =
          (typeof p.total === "number" ? p.total :
          typeof p.count === "number" ? p.count :
          typeof p.value === "number" ? p.value :
          typeof p.y === "number" ? p.y : null);
        const xLabel = (p.label ?? p.x ?? p.ts ?? p.time ?? "");
        if (y === null) continue;
        series.push({ xLabel, y });
      }
    }
    if (series.length < 2){
      host.innerHTML = `<div style="opacity:.75;font-size:12px">No trend data</div>`;
      return;
    }

    const W = 520, H = 90, P = 10;
    const ys = series.map(s => s.y);
    const minY = Math.min(...ys), maxY = Math.max(...ys);
    const span = (maxY - minY) || 1;

    const xAt = (i) => P + (i * (W - P*2) / (series.length - 1));
    const yAt = (y) => (H - P) - ((y - minY) * (H - P*2) / span);

    let d = "";
    for (let i=0;i<series.length;i++){
      const x = xAt(i), y = yAt(series[i].y);
      d += (i===0 ? `M ${x} ${y}` : ` L ${x} ${y}`);
    }

    const last = series[series.length-1];
    const first = series[0];

    host.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
        <div style="font-size:12px;opacity:.85">Trend (last=${last.y})</div>
        <div style="font-size:11px;opacity:.7">${String(first.xLabel).slice(0,16)} → ${String(last.xLabel).slice(0,16)}</div>
      </div>
      <svg viewBox="0 0 ${W} ${H}" width="100%" height="${H}" style="border:1px solid rgba(255,255,255,.06);border-radius:10px">
        <path d="${d}" fill="none" stroke="rgba(80,180,255,.95)" stroke-width="2"/>
        <circle cx="${xAt(series.length-1)}" cy="${yAt(last.y)}" r="3.5" fill="rgba(255,255,255,.95)"/>
      </svg>
    `;
  }

  function renderTopCwe(items){
    const tb = $("#tb");
    if (!tb) return;
    let rows = [];
    if (Array.isArray(items)) {
      for (const it of items) {
        if (!it) continue;
        const name = it.cwe || it.id || it.key || it.name || it.title || "CWE";
        const n = it.count ?? it.total ?? it.n ?? it.value ?? 0;
        if (typeof n !== "number") continue;
        rows.push({ name: String(name), n });
      }
    }
    if (!rows.length){
      tb.innerHTML = `<div style="opacity:.75;font-size:12px">No TopCWE data</div>`;
      return;
    }
    rows = rows.sort((a,b)=>b.n-a.n).slice(0,8);
    const max = Math.max(...rows.map(r=>r.n)) || 1;
    tb.innerHTML = rows.map(r => {
      const w = Math.max(2, Math.round((r.n/max)*100));
      return `
        <div style="display:grid;grid-template-columns: 140px 1fr 50px;gap:10px;align-items:center;margin:6px 0">
          <div style="font-size:12px;opacity:.85;white-space:nowrap;overflow:hidden;text-overflow:ellipsis" title="${escapeHtml(r.name)}">${escapeHtml(r.name)}</div>
          <div style="height:10px;background:rgba(255,255,255,.06);border-radius:999px;overflow:hidden">
            <div style="height:10px;width:${w}%;background:rgba(255,120,120,.95);border-radius:999px"></div>
          </div>
          <div style="text-align:right;font-size:12px;opacity:.85">${r.n}</div>
        </div>
      `;
    }).join("");
  }

  async function main(){
    const rid = await resolveRid();
    if (rid === null) return; // redirected
    if (isValidRid(rid)) {
      try { localStorage.setItem("vsp_rid", rid); } catch(e){}
      try { window.VSP_RID = rid; } catch(e){}
    }

    // ensure URL has rid for shareable link
    try {
      const u = new URL(location.href);
      const cur = (u.searchParams.get("rid") || "").trim();
      if (!cur && isValidRid(rid)) {
        u.searchParams.set("rid", rid);
        location.replace(u.toString());
        return;
      }
    } catch(e){}

    setText("p-rid", rid || "(no rid)");
    setText("k-status", "Loading…");
    setText("k-time", new Date().toLocaleString());

    // hook refresh button (bypass cache)
    const br = document.getElementById("b-refresh");
    if (br && !br.dataset.p117){
      br.dataset.p117="1";
      br.addEventListener("click", () => {
        const u = new URL(location.href);
        u.searchParams.set("nocache","1");
        location.href = u.toString();
      });
    }

    const qs = rid ? `?rid=${encodeURIComponent(rid)}` : "";
    const [kpis, top, trend, topcwe] = await Promise.all([
      fetchJson(`/api/vsp/dashboard_kpis_v4${qs}`),
      fetchJson(`/api/vsp/top_findings_v2?limit=20${rid ? `&rid=${encodeURIComponent(rid)}` : ""}`),
      fetchJson(`/api/vsp/trend_v1${qs}`),
      fetchJson(`/api/vsp/topcwe_v1${qs}`),
    ]);

    // KPI texts (best-effort)
    if (kpis.ok && kpis.json){
      const j = kpis.json;
      setText("k-total", j.total ?? j.kpi_total ?? j.summary?.total ?? "");
      setText("k-from", j.from ?? j.label ?? j.ts ?? "");
    }

    // Top Findings table
    if (top.ok && top.json){
      const items = top.json.items ?? top.json.data ?? top.json.rows ?? [];
      renderTopFindings(Array.isArray(items) ? items : []);
      setText("k-toplen", top.json.total ?? (Array.isArray(items)?items.length:"") );
      setText("k-topmeta", top.status);
    } else {
      renderTopFindings([]);
      setText("k-topmeta", `top ${top.status}`);
    }

    // Trend mini
    if (trend.ok && trend.json){
      const pts = trend.json.points ?? trend.json.items ?? trend.json.data ?? [];
      renderTrendMini(Array.isArray(pts) ? pts : []);
      setText("k-trend", Array.isArray(pts) ? pts.length : "");
      setText("k-trendmeta", trend.status);
    } else {
      renderTrendMini([]);
      setText("k-trendmeta", `trend ${trend.status}`);
    }

    // TopCWE (optional container #tb)
    if (topcwe.ok && topcwe.json){
      const items = topcwe.json.items ?? topcwe.json.data ?? topcwe.json.rows ?? topcwe.json;
      renderTopCwe(Array.isArray(items) ? items : []);
    } else {
      renderTopCwe([]);
    }

    const okAll = kpis.ok && top.ok && trend.ok;
    setText("k-status", okAll ? "OK" : "DEGRADED");
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", main);
  } else {
    main();
  }
})();
