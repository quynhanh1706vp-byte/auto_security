/* VSP_P121B_C_SETTINGS_V1 - safe */
(function(){
  "use strict";

  function qs(sel, root){ return (root||document).querySelector(sel); }
  function qsa(sel, root){ return Array.prototype.slice.call((root||document).querySelectorAll(sel)); }
  function log(){ console.log.apply(console, ["[VSPC][settings]"].concat([].slice.call(arguments))); }

  function sanitizeRid(r){
    r = (r==null ? "" : String(r)).trim();
    r = r.replace(/[^\w\-:.]/g, "");
    if (r.length > 160) r = r.slice(0,160);
    return r;
  }
  function getParam(name){
    try { return (new URLSearchParams(location.search)).get(name) || ""; }
    catch(e){ return ""; }
  }
  function getRid(){
    var u = sanitizeRid(getParam("rid"));
    var ls = sanitizeRid(localStorage.getItem("VSP_C_RID") || "");
    return u || ls || "";
  }

  function fetchJSON(url, timeoutMs){
    timeoutMs = timeoutMs || 8000;
    var ctl = new AbortController();
    var t = setTimeout(function(){ try{ctl.abort();}catch(e){} }, timeoutMs);
    return fetch(url, {signal: ctl.signal, cache:"no-store", credentials:"same-origin"})
      .then(function(r){
        return r.text().then(function(txt){
          var j=null; try{ j=JSON.parse(txt); }catch(e){}
          return {ok:r.ok, status:r.status, json:j, text:txt, url:url};
        });
      })
      .finally(function(){ clearTimeout(t); });
  }

  function firstOK(urls){
    var p = Promise.resolve(null);
    urls.forEach(function(u){
      p = p.then(function(prev){
        if (prev) return prev;
        return fetchJSON(u, 8000).then(function(res){
          if (res && res.ok && res.json) return res;
          return null;
        }).catch(function(){ return null; });
      });
    });
    return p;
  }

  function findProbeTable(){
    var tables = qsa("table");
    for (var i=0;i<tables.length;i++){
      var t=tables[i];
      var head = qsa("th", t).map(function(x){ return (x.textContent||"").trim().toLowerCase(); }).join("|");
      if (head.indexOf("endpoint")>=0 || head.indexOf("status")>=0) return t;
    }
    return null;
  }

  function main(){
    var rid = getRid();
    var pre = null;
    var pres = qsa("pre");
    for (var i=0;i<pres.length;i++){
      if ((pres[i].textContent||"").indexOf("{")>=0){ pre=pres[i]; break; }
    }

    var probes = [
      {name:"runs_v3", url:"/api/ui/runs_v3?limit=1&include_ci=1"},
      {name:"dashboard_kpis_v4", url:"/api/vsp/dashboard_kpis_v4" + (rid ? ("?rid="+encodeURIComponent(rid)) : "")},
      {name:"top_findings_v2", url:"/api/vsp/top_findings_v2?limit=1" + (rid ? ("&rid="+encodeURIComponent(rid)) : "")},
      {name:"trend_v1", url:"/api/vsp/trend_v1"}
    ];

    var t = findProbeTable();
    if (t){
      var tb = qs("tbody", t);
      if (!tb){ tb=document.createElement("tbody"); t.appendChild(tb); }
      tb.innerHTML = "";

      // sequential to keep it simple
      var seq = Promise.resolve();
      probes.forEach(function(p){
        seq = seq.then(function(){
          var tr=document.createElement("tr");
          var td1=document.createElement("td"); td1.textContent=p.name; td1.style.whiteSpace="nowrap";
          var td2=document.createElement("td"); td2.textContent="Loading..."; td2.style.opacity="0.7";
          tr.appendChild(td1); tr.appendChild(td2);
          tb.appendChild(tr);
          return fetchJSON(p.url, 7000).then(function(res){
            td2.textContent = res.ok ? ("OK ("+res.status+")") : ("FAIL ("+res.status+")");
          });
        });
      });
    }

    if (pre){
      firstOK(["/api/vsp/settings_v1", "/api/vsp/policy_v1", "/api/vsp/config_v1"])
        .then(function(res){
          if (res && res.json) pre.textContent = JSON.stringify(res.json, null, 2);
        });
    }

    log("ok rid=", rid || "(none)");
  }

  window.addEventListener("DOMContentLoaded", main);
})();
