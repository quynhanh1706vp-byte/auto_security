/* VSP_P2_RUNS_KPI_COMPACT_V3_SAFE_V4 (single endpoint; layout-safe; no run_file_allow) */
(()=> {
  if (window.__vsp_runs_kpi_compact_v3_safe_v4) return;
  window.__vsp_runs_kpi_compact_v3_safe_v4 = true;

  const $ = (q)=> document.querySelector(q);

  let inflight = false;
  let lastTs = 0;
  let lastDays = null;

  function setText(id, v){
    const el = document.getElementById(id);
    if (!el) return;
    el.textContent = (v===null || v===undefined || v==="") ? "—" : String(v);
  }

  function hideHeavy(){
    const ids = ["vsp_runs_kpi_canvas_overall","vsp_runs_kpi_canvas_sev","vsp_runs_kpi_canvas_wrap_overall","vsp_runs_kpi_canvas_wrap_sev"];
    for (const id of ids){
      const el = document.getElementById(id);
      if (el) el.style.display = "none";
    }
  }

  async function fetchKpi(days){
    const now = Date.now();
    const d = String(days || 30);

    if (inflight) return null;
    if (lastDays === d && (now - lastTs) < 2500) return null;

    inflight = true;
    lastDays = d;
    lastTs = now;

    const q = encodeURIComponent(d);
    const urls = [
      `/api/ui/runs_kpi_v2?days=${q}`,
      `/api/ui/runs_kpi_v2?days=${q}`,
      `/api/ui/runs_kpi_v1?days=${q}`,
    ];

    try{
      let lastErr = null;
      for (const u of urls){
        try{
          const r = await fetch(u, {cache:"no-store"});
          const j = await r.json();
          if (j && j.ok) return j;
          lastErr = new Error(j?.err || "not ok");
        }catch(e){ lastErr = e; }
      }
      throw lastErr || new Error("kpi fetch failed");
    } finally {
      inflight = false;
    }
  }

  function renderTrendOverall(resp){
    const root = document.getElementById("vsp_runs_kpi_trend_overall_compact");
    if (!root) return;

    const t = resp && resp.trend_overall;
    const labels = t && Array.isArray(t.labels) ? t.labels : [];
    const series = t && t.series ? t.series : null;

    if (!labels.length || !series){
      root.innerHTML = '<div style="color:#94a3b8;font-size:12px">No trend data (server-side)</div>';
      return;
    }

    // last 14 points
    const take = Math.min(14, labels.length);
    const start = labels.length - take;

    const keys = ["GREEN","AMBER","RED","UNKNOWN"];
    let max = 1;
    for (let i=start;i<labels.length;i++){
      let sum = 0;
      for (const k of keys) sum += (Number((series[k]||[])[i]||0) || 0);
      if (sum > max) max = sum;
    }

    const rows = [];
    for (let i=start;i<labels.length;i++){
      const d = labels[i];
      const parts = [];
      for (const k of keys){
        const v = Number((series[k]||[])[i]||0) || 0;
        const w = Math.round((v / max) * 100);
        parts.push(`<div title="${k}: ${v}" style="height:10px;width:${w}%;background:rgba(148,163,184,.18);border-radius:10px;margin-right:6px"></div>`);
      }
      rows.push(`
        <div style="display:flex;align-items:center;gap:10px;margin:6px 0">
          <div style="width:92px;font-size:11px;color:#94a3b8">${d}</div>
          <div style="flex:1;display:flex;align-items:center;gap:6px">${parts.join("")}</div>
        </div>
      `);
    }

    root.innerHTML = `
      <div style="margin-top:6px;padding-top:8px;border-top:1px solid rgba(148,163,184,.10)">
        <div style="font-size:12px;color:#cbd5e1;margin-bottom:4px">Overall trend (server)</div>
        ${rows.join("")}
      </div>
    `;
  }

  async function fill(days){
    hideHeavy();
    setText("vsp_runs_kpi_meta", "Loading KPI…");

    try{
      const j = await fetchKpi(days);
      if (!j) return;

      setText("vsp_runs_kpi_total_runs_window", j.total_runs);
      const bo = j.by_overall || {};
      setText("vsp_runs_kpi_GREEN", bo.GREEN ?? 0);
      setText("vsp_runs_kpi_AMBER", bo.AMBER ?? 0);
      setText("vsp_runs_kpi_RED", bo.RED ?? 0);
      setText("vsp_runs_kpi_UNKNOWN", bo.UNKNOWN ?? 0);
      setText("vsp_runs_kpi_findings", j.has_findings ?? "—");
      setText("vsp_runs_kpi_latest", j.latest_rid ?? "—");
      setText("vsp_runs_kpi_meta", `ts=${j.ts} • gate=${j.has_gate ?? "—"} • source=v4/v2`);

      renderTrendOverall(j);
    }catch(e){
      setText("vsp_runs_kpi_meta", `KPI error: ${String(e && e.message ? e.message : e)}`);
    }
  }

  function boot(){
    const sel = document.getElementById("vsp_runs_kpi_window_days");
    const btn = document.getElementById("vsp_runs_kpi_reload_btn");
    const days = sel ? (parseInt(sel.value||"30",10) || 30) : 30;

    if (sel){
      sel.addEventListener("change", ()=> fill(parseInt(sel.value||"30",10) || 30));
    }
    if (btn){
      btn.addEventListener("click", ()=> fill(sel ? (parseInt(sel.value||"30",10) || 30) : 30));
    }
    fill(days);
  }

  if (document.readyState === "loading"){
    document.addEventListener("DOMContentLoaded", boot, {once:true});
  } else {
    boot();
  }
})();



/* VSP_P2_RUNS_FILTERS_SORT_V1B (real asset) */
(function(){
  function esc(s){ return String(s??"").replace(/[&<>"]/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;" }[c])); }
  function el(tag, attrs, html){
    const e=document.createElement(tag);
    if(attrs){ for(const k of Object.keys(attrs)) e.setAttribute(k, attrs[k]); }
    if(html!==undefined) e.innerHTML=html;
    return e;
  }
  async function jget(url){
    const r=await fetch(url, {credentials:"same-origin"});
    const t=await r.text();
    try { return {ok:true, json: JSON.parse(t)}; } catch(e){ return {ok:false, text:t}; }
  }
  function isRuns(){ return String(location.pathname||"").includes("/runs"); }

  function findRoot(){
    return document.querySelector('[data-testid="vsp-runs-main"]') || document.body;
  }

  function mount(root, onChange){
    let bar=document.querySelector('[data-testid="runs-filterbar"]');
    if(bar) return bar;

    bar=el('div', {'data-testid':'runs-filterbar'});
    bar.style.cssText="max-width:1200px;margin:12px auto 8px auto;padding:0 12px;display:flex;gap:10px;flex-wrap:wrap;align-items:center";

    const q=el('input', {'data-testid':'runs-q', 'placeholder':'Search RID…'});
    q.style.cssText="flex:1;min-width:220px;padding:9px 10px;border-radius:12px;border:1px solid rgba(255,255,255,0.12);background:rgba(255,255,255,0.04);color:inherit";

    const sort=el('select', {'data-testid':'runs-sort'});
    sort.style.cssText="padding:9px 10px;border-radius:12px;border:1px solid rgba(255,255,255,0.12);background:rgba(255,255,255,0.04);color:inherit";
    sort.innerHTML = `
      <option value="ts_desc">Newest</option>
      <option value="ts_asc">Oldest</option>
      <option value="rid_asc">RID A→Z</option>
      <option value="rid_desc">RID Z→A</option>
    `;

    const lim=el('select', {'data-testid':'runs-limit'});
    lim.style.cssText=sort.style.cssText;
    lim.innerHTML = `<option>20</option><option selected>50</option><option>100</option>`;

    const btn=el('button', {'data-testid':'runs-refresh'}, 'Refresh');
    btn.style.cssText="padding:9px 12px;border-radius:12px;border:1px solid rgba(255,255,255,0.12);background:rgba(255,255,255,0.04);color:inherit;cursor:pointer";
    btn.onmouseenter=()=>btn.style.background="rgba(255,255,255,0.06)";
    btn.onmouseleave=()=>btn.style.background="rgba(255,255,255,0.04)";

    bar.appendChild(q); bar.appendChild(sort); bar.appendChild(lim); bar.appendChild(btn);
    root.prepend(bar);

    function fire(){ onChange({q:q.value||"", sort:sort.value, limit:+lim.value}); }
    q.addEventListener("input", fire);
    sort.addEventListener("change", fire);
    lim.addEventListener("change", fire);
    btn.addEventListener("click", fire);
    return bar;
  }

  function render(root, runs){
    let host=document.querySelector('[data-testid="runs-table-host"]');
    if(!host){
      host=el('div', {'data-testid':'runs-table-host'});
      host.style.cssText="max-width:1200px;margin:0 auto;padding:0 12px 18px 12px;";
      root.appendChild(host);
    }
    if(!runs || !runs.length){
      host.innerHTML = `<div style="opacity:.8;padding:14px;border:1px solid rgba(255,255,255,0.10);border-radius:14px;background:rgba(255,255,255,0.03)">No runs</div>`;
      return;
    }
    const rows=runs.map(r=>{
      const rid=esc(r.rid||r.run_id||"");
      const ts=esc(r.ts||r.created_ts||"");
      const rootDir=esc(r.root||"");
      return `<tr data-rid="${rid}">
        <td style="padding:10px 12px;font-weight:700;white-space:nowrap">${rid}</td>
        <td style="padding:10px 12px;opacity:.85;white-space:nowrap">${ts}</td>
        <td style="padding:10px 12px;opacity:.75;max-width:520px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${rootDir}</td>
      </tr>`;
    }).join("");
    host.innerHTML = `
      <div style="border:1px solid rgba(255,255,255,0.10);border-radius:14px;overflow:hidden;background:rgba(255,255,255,0.03)">
        <table style="width:100%;border-collapse:separate;border-spacing:0;font-size:13px">
          <thead>
            <tr style="text-align:left;opacity:.75;background:rgba(15,18,24,0.92)">
              <th style="padding:10px 12px;border-bottom:1px solid rgba(255,255,255,0.10)">RID</th>
              <th style="padding:10px 12px;border-bottom:1px solid rgba(255,255,255,0.10)">Time</th>
              <th style="padding:10px 12px;border-bottom:1px solid rgba(255,255,255,0.10)">Root</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
      <div style="opacity:.7;margin-top:8px">Tip: click a RID row to copy RID.</div>
    `;
    host.querySelectorAll("tbody tr").forEach(tr=>{
      tr.style.cursor="pointer";
      tr.style.transition="background 120ms ease";
      tr.onmouseenter=()=>tr.style.background="rgba(255,255,255,0.05)";
      tr.onmouseleave=()=>tr.style.background="transparent";
      tr.onclick=()=>{
        const rid=tr.getAttribute("data-rid")||"";
        if(rid) navigator.clipboard?.writeText(rid).catch(()=>{});
      };
    });
  }

  async function main(){
    const root=findRoot();
    mount(root, async (st)=>{
      const lim=st.limit||50;
      const res=await jget(`/api/vsp/runs?limit=${encodeURIComponent(lim)}&offset=0`);
      const runs=(res.ok && res.json && res.json.runs) ? res.json.runs : [];
      const q=(st.q||"").toLowerCase().trim();
      let out=runs;
      if(q) out=out.filter(r=>String(r.rid||r.run_id||"").toLowerCase().includes(q));
      const sort=st.sort||"ts_desc";
      out=[...out].sort((a,b)=>{
        const ar=String(a.rid||a.run_id||"");
        const br=String(b.rid||b.run_id||"");
        const at=String(a.ts||a.created_ts||"");
        const bt=String(b.ts||b.created_ts||"");
        if(sort==="rid_asc") return ar.localeCompare(br);
        if(sort==="rid_desc") return br.localeCompare(ar);
        if(sort==="ts_asc") return at.localeCompare(bt);
        return bt.localeCompare(at);
      });
      render(root, out);
    });
    document.querySelector('[data-testid="runs-refresh"]')?.click();
  }

  if(isRuns()){
    if(document.readyState==="loading") document.addEventListener("DOMContentLoaded", main);
    else main();
  }
})();
