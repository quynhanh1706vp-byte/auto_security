/* VSP_P2_POLISH_V1 (safe applier) */
(function(){
  if (window.__VSP_P2_POLISH_V1__) return;
  window.__VSP_P2_POLISH_V1__ = { ok: true, ts: Date.now() };

  function onReady(fn){
    if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", fn);
    else fn();
  }

  function addClass(el, cls){
    if (!el) return;
    cls.split(/\s+/).filter(Boolean).forEach(c => el.classList.add(c));
  }

  function polish(){
    try{
      var path = (location && location.pathname) ? location.pathname : "";
      // Apply mainly for /vsp5, but harmless elsewhere
      var root = document.getElementById("vsp-dashboard-main") || document.body;
      if (!root) return;

      // KPI grid heuristics
      var kpiGrid =
        document.querySelector("#vsp-kpi-grid") ||
        document.querySelector(".vsp-kpi-grid") ||
        document.querySelector(".kpi-grid") ||
        document.querySelector("[data-kpi-grid]");

      if (kpiGrid) addClass(kpiGrid, "vsp-kpi-grid");

      // KPI cards heuristics
      var kpiCards = [];
      [
        ".kpi-card",
        ".vsp-kpi-card",
        "[data-kpi-card]",
        ".kpi",
        ".kpiItem",
        ".kpi-item"
      ].forEach(sel => {
        document.querySelectorAll(sel).forEach(el => kpiCards.push(el));
      });

      // De-dup
      kpiCards = Array.from(new Set(kpiCards));

      kpiCards.forEach(function(card){
        addClass(card, "vsp-card vsp-kpi-card");

        // Try to tag inner text nodes if structure is simple
        // Title
        var title = card.querySelector(".title, .kpi-title, h4, h5");
        if (title) addClass(title, "vsp-kpi-title");
        // Value
        var val = card.querySelector(".value, .kpi-value, .num, .number, strong");
        if (val) addClass(val, "vsp-kpi-value");
        // Sub
        var sub = card.querySelector(".sub, .hint, .desc, small");
        if (sub) addClass(sub, "vsp-kpi-sub");
      });

      // Section panels: wrap common blocks
      var sections = [];
      [
        ".vsp-section",
        ".section",
        ".panel",
        ".box",
        ".card"
      ].forEach(sel => {
        document.querySelectorAll(sel).forEach(el => sections.push(el));
      });
      sections = Array.from(new Set(sections));

      sections.forEach(function(el){
        // Skip KPI cards already styled
        if (el.classList && el.classList.contains("vsp-kpi-card")) return;

        // Make bigger containers look like panels
        var rect = el.getBoundingClientRect ? el.getBoundingClientRect() : null;
        var big = rect ? (rect.width > 420 && rect.height > 120) : true;
        if (big) addClass(el, "vsp-panel");
      });

      // Tables tighten (for data_source / runs too, safe)
      document.querySelectorAll("table").forEach(function(tbl){
        var host = tbl.closest(".vsp-table-tight") || tbl.parentElement;
        if (host) addClass(host, "vsp-table-tight");
      });

      // Optional: add a clean section title wrapper if header exists
      document.querySelectorAll("h2, h3").forEach(function(h){
        if (!h || !h.parentElement) return;
        // already wrapped?
        if (h.parentElement.classList && h.parentElement.classList.contains("vsp-section-title")) return;
        // if next sibling is actions (buttons/links), wrap
        var next = h.nextElementSibling;
        if (next && (next.matches("div") || next.matches("nav"))){
          var wrap = document.createElement("div");
          wrap.className = "vsp-section-title";
          h.parentElement.insertBefore(wrap, h);
          wrap.appendChild(h);
          wrap.appendChild(next);
        }
      });

      // Mark
      window.__VSP_P2_POLISH_V1__.applied = true;
      window.__VSP_P2_POLISH_V1__.path = path;
    }catch(e){
      window.__VSP_P2_POLISH_V1__.err = String(e && e.message ? e.message : e);
    }
  }

  onReady(polish);
})();
