/* VSP_P120_PRELUDE_SHIM_V1 */
(function(){
  if(window.VSPC) return;
  window.VSPC = {
    ver:'P120-prelude',
    base:(location && location.origin)||'',
    onRefresh:(fn)=>window.addEventListener('vsp:refresh', fn),
    dispatchRefresh:()=>{ try{ window.dispatchEvent(new CustomEvent('vsp:refresh',{detail:{ts:Date.now()}})); }catch(e){} },
  };
})();

(function(){
  const U = window.__VSPC;
  const rid = U.rid();
  const tb = document.getElementById("ds-tb");
  const q  = document.getElementById("ds-q");
  const more = document.getElementById("ds-more");
  const offP = document.getElementById("ds-off");

  let offset = 0;
  let items = [];

  function row(it){
    const sev=(it.severity||"INFO").toUpperCase();
    return `<tr>
      <td><span class="sev"><span class="s-dot ${U.sevDot(sev)}"></span>${U.esc(sev)}</span></td>
      <td>${U.esc(it.title||"(no title)")}</td>
      <td>${U.esc(it.tool||it.scanner||"")}</td>
      <td class="muted">${U.esc(U.shortFile(it.file||""))}</td>
    </tr>`;
  }

  function render(){
    const s = (q.value||"").toLowerCase().trim();
    const show = s ? items.filter(it => U.searchable(it).includes(s)) : items;
    tb.innerHTML = show.length ? show.slice(0,2000).map(row).join("") : `<tr><td colspan="4" class="muted">No rows</td></tr>`;
    document.getElementById("ds-meta").textContent = `loaded=${items.length}  showing=${show.length}`;
  }

  async function loadPage(){
    offP.textContent = "offset=" + offset;
    const j = await U.jget(`/api/vsp/findings_page_v3?rid=${encodeURIComponent(rid)}&limit=200&offset=${offset}&pin=${encodeURIComponent(U.mode())}`);
    if (j && j.ok){
      U.paintPills(j);
      document.getElementById("ds-from").textContent = "from_path: " + (j.from_path||"â€”");
      const got = j.items || [];
      items = items.concat(got);
      offset += got.length;
      render();
    } else {
      tb.innerHTML = `<tr><td colspan="4" class="muted">API error</td></tr>`;
    }
  }

  q.addEventListener("input", ()=>render(), {passive:true});
  more.addEventListener("click", ()=>loadPage(), {passive:true});
  document.addEventListener("DOMContentLoaded", ()=>loadPage(), {once:true});
  U.onRefresh(()=>{ offset=0; items=[]; loadPage(); });
})();
