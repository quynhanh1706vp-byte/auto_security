/* VSP_P121B_C_DATA_SOURCE_V1 - safe, no template literal */
(function(){
  "use strict";

  function qs(sel, root){ return (root||document).querySelector(sel); }
  function qsa(sel, root){ return Array.prototype.slice.call((root||document).querySelectorAll(sel)); }
  function log(){ console.log.apply(console, ["[VSPC][ds]"].concat([].slice.call(arguments))); }
  function warn(){ console.warn.apply(console, ["[VSPC][ds]"].concat([].slice.call(arguments))); }

  function sanitizeRid(r){
    r = (r==null ? "" : String(r)).trim();
    r = r.replace(/[^\w\-:.]/g, "");
    if (r.length > 160) r = r.slice(0,160);
    return r;
  }
  function getParam(name){
    try { return (new URLSearchParams(location.search)).get(name) || ""; }
    catch(e){ return ""; }
  }
  function getRid(){
    var u = sanitizeRid(getParam("rid"));
    var ls = sanitizeRid(localStorage.getItem("VSP_C_RID") || "");
    return u || ls || "";
  }

  function fetchJSON(url, timeoutMs){
    timeoutMs = timeoutMs || 9000;
    var ctl = new AbortController();
    var t = setTimeout(function(){ try{ctl.abort();}catch(e){} }, timeoutMs);
    return fetch(url, {signal: ctl.signal, cache:"no-store", credentials:"same-origin"})
      .then(function(r){
        return r.text().then(function(txt){
          var j=null; try{ j=JSON.parse(txt); }catch(e){}
          return {ok:r.ok, status:r.status, json:j, text:txt, url:url};
        });
      })
      .finally(function(){ clearTimeout(t); });
  }

  function firstOK(urls){
    var p = Promise.resolve(null);
    urls.forEach(function(u){
      p = p.then(function(prev){
        if (prev) return prev;
        return fetchJSON(u, 9000).then(function(res){
          if (res && res.ok && res.json) return res;
          return null;
        }).catch(function(){ return null; });
      });
    });
    return p;
  }

  function findDataTable(){
    var tables = qsa("table");
    var best=null, bestScore=-1;
    for (var i=0;i<tables.length;i++){
      var t=tables[i];
      var th = qsa("th", t).map(function(x){ return (x.textContent||"").trim().toLowerCase(); });
      var score = 0;
      if (th.indexOf("severity")>=0) score += 2;
      if (th.indexOf("title")>=0) score += 2;
      if (th.indexOf("tool")>=0) score += 1;
      if (th.indexOf("location")>=0) score += 1;
      if (th.length >= 6) score += 1;
      if (score > bestScore){ best=t; bestScore=score; }
    }
    return best || qs("table");
  }

  function td(v){
    var x=document.createElement("td");
    x.textContent = (v==null ? "" : String(v));
    return x;
  }

  function render(tbody, rows){
    tbody.innerHTML="";
    for (var i=0;i<rows.length;i++){
      var r=rows[i]||{};
      var tr=document.createElement("tr");
      tr.appendChild(td(r.id||""));
      tr.appendChild(td(r.tool||""));
      tr.appendChild(td(r.type||""));
      tr.appendChild(td(r.severity||""));
      tr.appendChild(td(r.title||""));
      tr.appendChild(td(r.component||""));
      tr.appendChild(td(r.version||""));
      tr.appendChild(td(r.location||""));
      tr.appendChild(td(r.fix||""));
      tbody.appendChild(tr);
    }
  }

  function main(){
    var rid = getRid();
    var tbl = findDataTable();
    if (!tbl){ warn("table not found"); return; }

    var tb = qs("tbody", tbl);
    if (!tb){ tb=document.createElement("tbody"); tbl.appendChild(tb); }

    var offset = 0;
    var limit = 200;

    function load(){
      tb.innerHTML = '<tr><td colspan="12" style="opacity:.7">Loading...</td></tr>';
      var r = encodeURIComponent(rid || "");
      var urls = [
        "/api/vsp/datasource_v3?rid="+r+"&limit="+limit+"&offset="+offset,
        "/api/vsp/datasource?rid="+r+"&limit="+limit+"&offset="+offset,
        "/api/vsp/findings_unified_v1?rid="+r+"&limit="+limit+"&offset="+offset,
        "/api/vsp/data_source_v1?rid="+r+"&limit="+limit+"&offset="+offset
      ];
      firstOK(urls).then(function(res){
        if (!res){
          tb.innerHTML = '<tr><td colspan="12" style="color:#ffb">Cannot load datasource API</td></tr>';
          return;
        }
        var j=res.json||{};
        var rows = j.items || j.rows || j.data || [];
        render(tb, rows);
        log("rows=", rows.length, "offset=", offset);
      }).catch(function(e){
        console.error(e);
        tb.innerHTML = '<tr><td colspan="12" style="color:#ffb">datasource error</td></tr>';
      });
    }

    // hook "Next" button if exists
    var nextBtn = null;
    var bs = qsa("button");
    for (var i=0;i<bs.length;i++){
      var t=(bs[i].textContent||"").toLowerCase();
      if (t.indexOf("next")>=0){ nextBtn=bs[i]; break; }
    }
    if (nextBtn){
      nextBtn.onclick = function(){ offset += limit; load(); };
    }

    load();
  }

  window.addEventListener("DOMContentLoaded", main);
})();


/* VSP_P473_LOADER_SNIPPET_V1 */
(function(){
  try{
    if (window.__VSP_SIDEBAR_FRAME_V1__) return;
    if (document.getElementById("vsp_c_sidebar_v1_loader")) return;
    var s=document.createElement("script");
    s.id="vsp_c_sidebar_v1_loader";
    s.src="/static/js/vsp_c_sidebar_v1.js?v="+Date.now();
    document.head.appendChild(s);
  }catch(e){}
})();


/* VSP_P481C_DS_POLISH_FORCE_IN_DS_JS_V1 */
(function(){
  if (window.__VSP_P481C__) return;
  window.__VSP_P481C__ = 1;

  const LEVELS=["CRITICAL","HIGH","MEDIUM","LOW","INFO","TRACE"];

  function onDS(){ return location.pathname.includes("/c/data_source"); }

  function ensureCss(){
    if(document.getElementById("vsp_p481c_css")) return;
    const st=document.createElement("style");
    st.id="vsp_p481c_css";
    st.textContent=`
/* tiny visible badge to prove it's running */
#vsp_p481c_badge{
  position:fixed; right:14px; bottom:14px;
  z-index:9999;
  border-radius:999px;
  border:1px solid rgba(255,255,255,0.12);
  background:rgba(0,0,0,0.35);
  color:rgba(255,255,255,0.88);
  padding:6px 10px;
  font-size:11px;
  backdrop-filter: blur(6px);
}

/* chips */
#vsp_p481_bar{
  margin:10px 0 12px 0;
  display:flex;gap:8px;flex-wrap:wrap;align-items:center;
}
.vsp_p481_chip{
  border-radius:999px;
  border:1px solid rgba(255,255,255,0.10);
  background:rgba(255,255,255,0.03);
  color:rgba(255,255,255,0.86);
  padding:6px 10px;
  font-size:12px;
  cursor:pointer;
  user-select:none;
}
.vsp_p481_chip.on{
  border-color:rgba(99,179,237,0.35);
  background:rgba(99,179,237,0.12);
  color:#fff;
}
.vsp_p481_sep{opacity:.35;margin:0 4px}

/* sticky wrap */
.vsp_p481_table_wrap{
  border-radius:16px;
  border:1px solid rgba(255,255,255,0.06);
  background:rgba(255,255,255,0.02);
  overflow:hidden;
}
.vsp_p481_table_scroller{ max-height:66vh; overflow:auto; }
.vsp_p481_table_scroller table{ width:100%; border-collapse:collapse; }
.vsp_p481_table_scroller thead th{
  position: sticky; top:0; z-index:2;
  background: rgba(20,24,33,0.98);
  backdrop-filter: blur(6px);
  border-bottom:1px solid rgba(255,255,255,0.06);
}
.vsp_p481_table_scroller td, .vsp_p481_table_scroller th{
  padding:8px 10px; font-size:12px; text-align:left;
  border-bottom:1px solid rgba(255,255,255,0.05);
}
.vsp_p481_row{ cursor:pointer; }
.vsp_p481_row:hover{ background:rgba(255,255,255,0.03); }

/* drawer */
#vsp_p481_drawer_backdrop{ position:fixed; inset:0; background:rgba(0,0,0,0.55); z-index:9998; }
#vsp_p481_drawer{
  position:fixed; top:0; right:0; height:100vh; width:520px; max-width:92vw;
  z-index:9999;
  border-left:1px solid rgba(255,255,255,0.08);
  background: rgba(12,16,24,0.98);
  backdrop-filter: blur(8px);
  padding:14px;
  overflow:auto;
}
#vsp_p481_drawer .t{font-weight:900;font-size:14px}
#vsp_p481_drawer .x{margin-top:10px;opacity:.86;font-size:12px;line-height:1.6}
#vsp_p481_drawer .kv{
  border:1px solid rgba(255,255,255,0.08);
  border-radius:14px;
  background:rgba(255,255,255,0.02);
  padding:10px 12px;
  margin-top:10px;
}
#vsp_p481_drawer .k{opacity:.65;font-size:11px}
#vsp_p481_drawer .v{margin-top:4px;font-size:12px;word-break:break-word}
#vsp_p481_drawer button{
  border-radius:12px;
  border:1px solid rgba(255,255,255,0.10);
  background:rgba(255,255,255,0.03);
  color:rgba(255,255,255,0.88);
  padding:7px 10px;
  font-size:12px;
}
#vsp_p481_drawer button:hover{background:rgba(255,255,255,0.06)}
#vsp_p481_drawer .btns{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
`;
    document.head.appendChild(st);
  }

  function badge(){
    if(document.getElementById("vsp_p481c_badge")) return;
    const b=document.createElement("div");
    b.id="vsp_p481c_badge";
    b.textContent="DS polish ON (P481c)";
    document.body.appendChild(b);
    setTimeout(()=>{ try{ b.remove(); }catch(e){} }, 4500);
  }

  function closeDrawer(){
    const bd=document.getElementById("vsp_p481_drawer_backdrop");
    const dr=document.getElementById("vsp_p481_drawer");
    if(bd) bd.remove();
    if(dr) dr.remove();
  }
  function openDrawer(obj){
    closeDrawer();
    const bd=document.createElement("div");
    bd.id="vsp_p481_drawer_backdrop";
    bd.onclick=closeDrawer;

    const dr=document.createElement("div");
    dr.id="vsp_p481_drawer";

    const t=document.createElement("div");
    t.className="t"; t.textContent="Finding details";
    dr.appendChild(t);

    const btns=document.createElement("div");
    btns.className="btns";
    const b1=document.createElement("button");
    b1.textContent="Copy JSON";
    b1.onclick=()=>{ try{ navigator.clipboard.writeText(JSON.stringify(obj,null,2)); }catch(e){} };
    const b2=document.createElement("button");
    b2.textContent="Close";
    b2.onclick=closeDrawer;
    btns.appendChild(b1); btns.appendChild(b2);
    dr.appendChild(btns);

    const x=document.createElement("div");
    x.className="x";
    x.textContent="Click outside to close. Copy JSON to attach evidence into ticket.";
    dr.appendChild(x);

    Object.keys(obj||{}).forEach(k=>{
      const kv=document.createElement("div"); kv.className="kv";
      const kk=document.createElement("div"); kk.className="k"; kk.textContent=k;
      const vv=document.createElement("div"); vv.className="v"; vv.textContent=(obj[k]==null?"":String(obj[k]));
      kv.appendChild(kk); kv.appendChild(vv);
      dr.appendChild(kv);
    });

    document.body.appendChild(bd);
    document.body.appendChild(dr);
  }

  function parseRow(tr){
    const tb=tr.closest("table"); if(!tb) return {};
    const ths=[...tb.querySelectorAll("thead th")].map(x=>(x.innerText||"").trim()||"col");
    const tds=[...tr.querySelectorAll("td")].map(x=>(x.innerText||"").trim());
    const obj={};
    for(let i=0;i<tds.length;i++) obj[ths[i]||("col"+i)] = tds[i];
    obj.__row_text__=(tr.innerText||"").trim();
    return obj;
  }

  function chooseBestTable(){
    const tables=[...document.querySelectorAll("table")];
    let best=null, bestScore=0;
    for(const tb of tables){
      const rows=tb.querySelectorAll("tbody tr").length;
      const cols=Math.max(tb.querySelectorAll("thead th").length, 1);
      if(rows < 8) continue;
      const score = rows * Math.min(cols, 50);
      if(score > bestScore){ bestScore=score; best=tb; }
    }
    return best;
  }

  function wrapSticky(tb){
    if(tb.closest(".vsp_p481_table_wrap")) return;
    const wrap=document.createElement("div"); wrap.className="vsp_p481_table_wrap";
    const sc=document.createElement("div"); sc.className="vsp_p481_table_scroller";
    tb.parentNode.insertBefore(wrap, tb);
    wrap.appendChild(sc); sc.appendChild(tb);
  }

  function applyFilter(tb, st){
    const rows=[...tb.querySelectorAll("tbody tr")];
    for(const tr of rows){
      const txt=(tr.innerText||"");
      let ok=true;
      if(st.level) ok = ok && txt.toUpperCase().includes(st.level);
      if(st.tool) ok = ok && txt.toLowerCase().includes(st.tool.toLowerCase());
      tr.style.display = ok ? "" : "none";
    }
  }

  function ensureBar(tb){
    if(document.getElementById("vsp_p481_bar")) return;
    const bar=document.createElement("div"); bar.id="vsp_p481_bar";
    const st={level:null, tool:null};

    function chip(lv){
      const c=document.createElement("span");
      c.className="vsp_p481_chip";
      c.textContent=lv;
      c.onclick=()=>{
        if(st.level===lv){ st.level=null; c.classList.remove("on"); }
        else{
          [...bar.querySelectorAll('.vsp_p481_chip[data-k="level"]')].forEach(x=>x.classList.remove("on"));
          st.level=lv; c.classList.add("on");
        }
        applyFilter(tb, st);
      };
      c.dataset.k="level";
      return c;
    }
    LEVELS.forEach(l=>bar.appendChild(chip(l)));

    const sep=document.createElement("span"); sep.className="vsp_p481_sep"; sep.textContent="|";
    bar.appendChild(sep);

    const inp=document.createElement("input");
    inp.placeholder="Filter tool (e.g. grype, semgrep)...";
    inp.style.cssText="flex:1;min-width:220px;border-radius:12px;border:1px solid rgba(255,255,255,0.10);background:rgba(255,255,255,0.02);color:rgba(255,255,255,0.9);padding:7px 10px;font-size:12px;";
    inp.oninput=()=>{ st.tool=(inp.value||"").trim()||null; applyFilter(tb, st); };
    bar.appendChild(inp);

    tb.parentNode.insertBefore(bar, tb);
  }

  function wireRows(tb){
    const rows=[...tb.querySelectorAll("tbody tr")];
    for(const tr of rows){
      if(tr.dataset.vspP481cWired==="1") continue;
      tr.dataset.vspP481cWired="1";
      tr.classList.add("vsp_p481_row");
      tr.addEventListener("click", ()=>openDrawer(parseRow(tr)));
    }
    document.addEventListener("keydown",(e)=>{ if(e.key==="Escape") closeDrawer(); });
  }

  function run(){
    if(!onDS()) return;
    ensureCss(); badge();

    const tb=chooseBestTable();
    if(!tb){ console.log("[P481c] no table yet, retry"); setTimeout(run, 900); return; }

    ensureBar(tb);
    wrapSticky(tb);
    wireRows(tb);

    console.log("[P481c] applied to best table");
  }

  function boot(){
    if(!onDS()) return;
    setTimeout(run, 700);
    setTimeout(run, 1600);
    setTimeout(run, 2600);
  }

  if(document.readyState==="loading") document.addEventListener("DOMContentLoaded", boot);
  else boot();
})();
