/* VSP_P121B_C_DATA_SOURCE_V1 - safe, no template literal */
(function(){
  "use strict";

  function qs(sel, root){ return (root||document).querySelector(sel); }
  function qsa(sel, root){ return Array.prototype.slice.call((root||document).querySelectorAll(sel)); }
  function log(){ console.log.apply(console, ["[VSPC][ds]"].concat([].slice.call(arguments))); }
  function warn(){ console.warn.apply(console, ["[VSPC][ds]"].concat([].slice.call(arguments))); }

  function sanitizeRid(r){
    r = (r==null ? "" : String(r)).trim();
    r = r.replace(/[^\w\-:.]/g, "");
    if (r.length > 160) r = r.slice(0,160);
    return r;
  }
  function getParam(name){
    try { return (new URLSearchParams(location.search)).get(name) || ""; }
    catch(e){ return ""; }
  }
  function getRid(){
    var u = sanitizeRid(getParam("rid"));
    var ls = sanitizeRid(localStorage.getItem("VSP_C_RID") || "");
    return u || ls || "";
  }

  function fetchJSON(url, timeoutMs){
    timeoutMs = timeoutMs || 9000;
    var ctl = new AbortController();
    var t = setTimeout(function(){ try{ctl.abort();}catch(e){} }, timeoutMs);
    return fetch(url, {signal: ctl.signal, cache:"no-store", credentials:"same-origin"})
      .then(function(r){
        return r.text().then(function(txt){
          var j=null; try{ j=JSON.parse(txt); }catch(e){}
          return {ok:r.ok, status:r.status, json:j, text:txt, url:url};
        });
      })
      .finally(function(){ clearTimeout(t); });
  }

  function firstOK(urls){
    var p = Promise.resolve(null);
    urls.forEach(function(u){
      p = p.then(function(prev){
        if (prev) return prev;
        return fetchJSON(u, 9000).then(function(res){
          if (res && res.ok && res.json) return res;
          return null;
        }).catch(function(){ return null; });
      });
    });
    return p;
  }

  function findDataTable(){
    var tables = qsa("table");
    var best=null, bestScore=-1;
    for (var i=0;i<tables.length;i++){
      var t=tables[i];
      var th = qsa("th", t).map(function(x){ return (x.textContent||"").trim().toLowerCase(); });
      var score = 0;
      if (th.indexOf("severity")>=0) score += 2;
      if (th.indexOf("title")>=0) score += 2;
      if (th.indexOf("tool")>=0) score += 1;
      if (th.indexOf("location")>=0) score += 1;
      if (th.length >= 6) score += 1;
      if (score > bestScore){ best=t; bestScore=score; }
    }
    return best || qs("table");
  }

  function td(v){
    var x=document.createElement("td");
    x.textContent = (v==null ? "" : String(v));
    return x;
  }

  function render(tbody, rows){
    tbody.innerHTML="";
    for (var i=0;i<rows.length;i++){
      var r=rows[i]||{};
      var tr=document.createElement("tr");
      tr.appendChild(td(r.id||""));
      tr.appendChild(td(r.tool||""));
      tr.appendChild(td(r.type||""));
      tr.appendChild(td(r.severity||""));
      tr.appendChild(td(r.title||""));
      tr.appendChild(td(r.component||""));
      tr.appendChild(td(r.version||""));
      tr.appendChild(td(r.location||""));
      tr.appendChild(td(r.fix||""));
      tbody.appendChild(tr);
    }
  }

  function main(){
    var rid = getRid();
    var tbl = findDataTable();
    if (!tbl){ warn("table not found"); return; }

    var tb = qs("tbody", tbl);
    if (!tb){ tb=document.createElement("tbody"); tbl.appendChild(tb); }

    var offset = 0;
    var limit = 200;

    function load(){
      tb.innerHTML = '<tr><td colspan="12" style="opacity:.7">Loading...</td></tr>';
      var r = encodeURIComponent(rid || "");
      var urls = [
        "/api/vsp/datasource_v3?rid="+r+"&limit="+limit+"&offset="+offset,
        "/api/vsp/datasource?rid="+r+"&limit="+limit+"&offset="+offset,
        "/api/vsp/findings_unified_v1?rid="+r+"&limit="+limit+"&offset="+offset,
        "/api/vsp/data_source_v1?rid="+r+"&limit="+limit+"&offset="+offset
      ];
      firstOK(urls).then(function(res){
        if (!res){
          tb.innerHTML = '<tr><td colspan="12" style="color:#ffb">Cannot load datasource API</td></tr>';
          return;
        }
        var j=res.json||{};
        var rows = j.items || j.rows || j.data || [];
        render(tb, rows);
        log("rows=", rows.length, "offset=", offset);
      }).catch(function(e){
        console.error(e);
        tb.innerHTML = '<tr><td colspan="12" style="color:#ffb">datasource error</td></tr>';
      });
    }

    // hook "Next" button if exists
    var nextBtn = null;
    var bs = qsa("button");
    for (var i=0;i<bs.length;i++){
      var t=(bs[i].textContent||"").toLowerCase();
      if (t.indexOf("next")>=0){ nextBtn=bs[i]; break; }
    }
    if (nextBtn){
      nextBtn.onclick = function(){ offset += limit; load(); };
    }

    load();
  }

  window.addEventListener("DOMContentLoaded", main);
})();


/* VSP_P473_LOADER_SNIPPET_V1 */
(function(){
  try{
    if (window.__VSP_SIDEBAR_FRAME_V1__) return;
    if (document.getElementById("vsp_c_sidebar_v1_loader")) return;
    var s=document.createElement("script");
    s.id="vsp_c_sidebar_v1_loader";
    s.src="/static/js/vsp_c_sidebar_v1.js?v="+Date.now();
    document.head.appendChild(s);
  }catch(e){}
})();
