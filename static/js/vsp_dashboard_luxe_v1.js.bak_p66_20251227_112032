/* VSP_DASHBOARD_LUXE_SAFE_V2 - minimal, no-crash dashboard bootstrap */
(function(){
  'use strict';

  function el(tag, attrs){
    const x = document.createElement(tag);
    if(attrs){ for(const k of Object.keys(attrs)) x.setAttribute(k, attrs[k]); }
    return x;
  }
  function safeText(x, t){ try{ x.textContent = t; } catch(_){} }

  function renderOverlay(stats){
    const id="vsp_dash_luxe_safe_v2";
    let box = document.getElementById(id);
    if(!box){
      box = el("div", { id });
      box.style.position="fixed";
      box.style.right="14px";
      box.style.bottom="14px";
      box.style.zIndex="99999";
      box.style.padding="12px 14px";
      box.style.borderRadius="14px";
      box.style.background="rgba(10,16,28,0.92)";
      box.style.border="1px solid rgba(255,255,255,0.08)";
      box.style.boxShadow="0 10px 30px rgba(0,0,0,0.35)";
      box.style.fontFamily="ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto";
      box.style.fontSize="12px";
      box.style.color="rgba(255,255,255,0.86)";
      box.style.minWidth="260px";

      const title = el("div");
      title.style.fontWeight="700";
      title.style.marginBottom="8px";
      safeText(title, "VSP Dashboard (SAFE)");
      box.appendChild(title);

      const body = el("div", { id: id+"_body" });
      box.appendChild(body);

      document.body.appendChild(box);
    }
    const body = document.getElementById(id+"_body");
    if(!body) return;

    body.innerHTML = "";
    const lines = [
      ["RID", stats.rid || "(none)"],
      ["Total", String(stats.total || 0)],
      ["CRITICAL", String(stats.CRITICAL||0)],
      ["HIGH", String(stats.HIGH||0)],
      ["MEDIUM", String(stats.MEDIUM||0)],
      ["LOW", String(stats.LOW||0)],
      ["INFO", String(stats.INFO||0)],
      ["TRACE", String(stats.TRACE||0)]
    ];
    for(const [k,v] of lines){
      const row = el("div");
      row.style.display="flex";
      row.style.justifyContent="space-between";
      row.style.gap="10px";
      row.style.padding="2px 0";
      const a=el("span"); a.style.opacity="0.75"; safeText(a,k);
      const b=el("span"); b.style.fontWeight="700"; safeText(b,v);
      row.appendChild(a); row.appendChild(b);
      body.appendChild(row);
    }
  }

  function normSev(s){
    s = String(s||"").toUpperCase().trim();
    if(["CRITICAL","HIGH","MEDIUM","LOW","INFO","TRACE"].includes(s)) return s;
    if(s==="INFORMATIONAL") return "INFO";
    return "TRACE";
  }

  async function fetchTop(){
    const u = "/api/vsp/top_findings_v2?limit=200";
    const res = await fetch(u, { credentials:"same-origin" });
    if(!res.ok) throw new Error("HTTP "+res.status);
    return await res.json();
  }

  async function boot(){
    const stats = {CRITICAL:0,HIGH:0,MEDIUM:0,LOW:0,INFO:0,TRACE:0,total:0,rid:(window.__VSP_RID||null)};
    try{
      const j = await fetchTop();
      const items = Array.isArray(j.items) ? j.items : [];
      stats.total = (typeof j.total==="number") ? j.total : items.length;
      stats.rid = j.run_id || j.rid || stats.rid || null;
      for(const it of items){
        const sev = normSev(it.severity || it.sev || it.level);
        stats[sev] = (stats[sev]||0) + 1;
      }
    }catch(e){
      stats.err = String(e||"");
      try{ console.warn("[VSP] dashboard safe fetch failed", e); }catch(_){}
    }
    renderOverlay(stats);
    window.__VSP_DASHBOARD_LUXE_SAFE_V2 = { ok:true, stats };
  }

  if(document.readyState === "loading"){
    document.addEventListener("DOMContentLoaded", () => boot().catch(()=>{}));
  } else {
    boot().catch(()=>{});
  }
})();
