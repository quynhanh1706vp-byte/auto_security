/* VSP_RULE_OVERRIDES_P405 - keep P404 panel, kill BOTH legacy pre+legacy editor (limited reaper) */
(function(){
  "use strict";
  const log=(...a)=>console.log("[ovr:p405]",...a);

  const ROOT_ID="vsp_ovr_p405_root";

  function el(tag, attrs, html){
    const e=document.createElement(tag);
    if(attrs) for(const [k,v] of Object.entries(attrs)){
      if(k==="class") e.className=v;
      else if(k==="style") e.setAttribute("style",v);
      else e.setAttribute(k,v);
    }
    if(html!==undefined) e.innerHTML=html;
    return e;
  }

  function cssOnce(){
    if(document.getElementById("vsp_ovr_css_p405")) return;
    const css=`
      html,body{ background:#0b1020; }
      #${ROOT_ID}{ padding:16px; color:#eaeaea; }
      #${ROOT_ID} .h1{ font-size:18px; margin:0 0 12px 0; }
      #${ROOT_ID} .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
      #${ROOT_ID} .card{ border:1px solid rgba(255,255,255,.10); background:rgba(0,0,0,.18); border-radius:14px; padding:12px; min-height:120px; }
      #${ROOT_ID} .card h2{ font-size:13px; margin:0 0 10px 0; opacity:.9; }
      #${ROOT_ID} textarea{ width:100%; min-height:240px; resize:vertical; border-radius:12px; padding:10px; border:1px solid rgba(255,255,255,.12); background:rgba(0,0,0,.25); color:#eaeaea;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:12px; line-height:1.4; }
      .vsp_p405_hidden{ display:none !important; }
      @media (max-width: 1100px){ #${ROOT_ID} .grid{ grid-template-columns:1fr; } }
    `;
    document.head.appendChild(el("style",{id:"vsp_ovr_css_p405"},css));
  }

  function neverHide(node){
    if(!node) return true;
    if(node === document.documentElement || node === document.body) return true;
    const root=document.getElementById(ROOT_ID);
    if(root && (node===root || node.contains(root) || root.contains(node))) return true;
    return false;
  }

  function hideLegacyOnce(){
      // hard-kill top legacy JSON block by exact signature inside PRE
      const preSig = 'VSP_RULE_OVERRIDES_EDITOR_P0_V1';
      for (const pre of Array.from(document.querySelectorAll("pre"))) {
        const t = (pre.innerText || "");
        if (!t.includes(preSig)) continue;
        let p = pre;
        for (let i=0; i<14 && p && p!==document.body; i++){
          const cls = (p.className||"").toString();
          const h = (p.getBoundingClientRect? p.getBoundingClientRect().height:0) || 0;
          if (cls.includes("card")||cls.includes("panel")||cls.includes("container")||h>=160) break;
          p = p.parentElement;
        }
        const target = p || pre;
        if (neverHide(target)) continue;
        target.classList.add("vsp_p405_hidden");
        target.setAttribute("data-vsp-legacy-hidden","1");
      }

    // 1) legacy PRE block at top: has "Rule Overrides (live from" / "Open JSON"
    // 2) legacy editor at bottom: has "Prefer backend" + buttons "LOAD" "SAVE" "EXPORT" or placeholder "Paste overrides JSON"
    const signatures = [
      "Rule Overrides (live from",
      "Open JSON",
      "Prefer backend",
      "fallback localStorage",
      "Paste overrides JSON here",
      "EXPORT"
    ];

    const nodes=Array.from(document.querySelectorAll("section,article,div,pre"));
    for(const n of nodes){
      const t=(n.innerText||"").trim();
      if(!t) continue;
      if(!signatures.some(x=>t.includes(x))) continue;

      // tighten matching for legacy blocks:
      const isLegacyPre = t.includes("Rule Overrides (live from") && (t.includes("Open JSON") || t.includes("Open  JSON"));
      const isLegacyEditor = (t.includes("Paste overrides JSON here") || (t.includes("Prefer backend") && t.includes("EXPORT")));

      if(!isLegacyPre && !isLegacyEditor) continue;

      let p=n;
      for(let i=0;i<14 && p && p!==document.body; i++){
        const cls=(p.className||"").toString();
        const h=(p.getBoundingClientRect? p.getBoundingClientRect().height:0) || 0;
        if(cls.includes("card")||cls.includes("panel")||cls.includes("container")||h>=180) break;
        p=p.parentElement;
      }
      const target=p||n;
      if(neverHide(target)) continue;
      target.classList.add("vsp_p405_hidden");
      target.setAttribute("data-vsp-legacy-hidden","1");
    }
  }

  async function ensureViewerLoaded(){
    if(window.VSP && window.VSP.jsonViewer) return true;
    return await new Promise((resolve)=>{
      const s=document.createElement("script");
      s.src="/static/js/vsp_json_viewer_v1.js?v="+Date.now();
      s.onload=()=>resolve(true);
      s.onerror=()=>resolve(false);
      document.head.appendChild(s);
    });
  }

  async function fetchJson(url){
    try{
      const r=await fetch(url,{cache:"no-store",credentials:"same-origin"});
      const text=await r.text();
      let data=null; try{ data=JSON.parse(text);}catch(_){}
      return {ok:r.ok,status:r.status,text,data};
    }catch(e){
      return {ok:false,status:0,text:String(e),data:null};
    }
  }

  async function detectEndpoint(){
    const cands=["/api/vsp/rule_overrides_v1","/api/vsp/overrides_v1","/api/vsp/rule_overrides","/api/vsp/overrides"];
    for(const u of cands){
      const r=await fetchJson(u);
      if(r.ok && r.data!==null) return u;
    }
    return cands[0];
  }

  async function render(){
    cssOnce();

    let root=document.getElementById(ROOT_ID);
    if(!root){
      root=el("div",{id:ROOT_ID});
      document.body.prepend(root);
    }
    root.innerHTML="";
    root.appendChild(el("div",{class:"h1"},"Rule Overrides â€¢ P405 (legacy reaped)"));

    const grid=el("div",{class:"grid"});
    const left=el("div",{class:"card"});
    const right=el("div",{class:"card"});
    left.appendChild(el("h2",null,"Live view (stable JSON)"));
    right.appendChild(el("h2",null,"Editor (read-only safe)"));

    const jsonBox=el("div"); left.appendChild(jsonBox);
    const ta=el("textarea",{spellcheck:"false"}); right.appendChild(ta);
    const msg=el("div",{style:"margin-top:8px;font-size:12px;opacity:.8"},""); right.appendChild(msg);

    grid.appendChild(left); grid.appendChild(right);
    root.appendChild(grid);

    const endpoint=await detectEndpoint();
    const r=await fetchJson(endpoint);
    msg.textContent=`endpoint=${endpoint} status=${r.status}`;
    ta.value=r.data ? JSON.stringify(r.data,null,2) : (r.text||"");

    const viewerOk=await ensureViewerLoaded();
    if(viewerOk && window.VSP && window.VSP.jsonViewer){
      window.VSP.jsonViewer.render(jsonBox,{endpoint,payload:(r.data||{raw:r.text})},{title:"RuleOverrides",maxDepth:8});
    } else {
      jsonBox.innerHTML=`<pre style="white-space:pre-wrap;word-break:break-word;opacity:.9">${(r.text||"").slice(0,3000)}</pre>`;
    }

    log("rendered");
  }

  function startLimitedReaper(){
    let n=0;
    const max=40; // 10s // 5s
    const timer=setInterval(()=>{
      try{ hideLegacyOnce(); }catch(_){}
      n++;
      if(n>=max) clearInterval(timer);
    },250);
    hideLegacyOnce();
  }

  async function main(){
    startLimitedReaper();
    await render();
    startLimitedReaper();
  }

  if(document.readyState==="loading") document.addEventListener("DOMContentLoaded", main);
  else main();
})();
