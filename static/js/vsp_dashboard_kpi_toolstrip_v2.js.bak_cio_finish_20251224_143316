
// __VSP_CIO_HELPER_V1
(function(){
  try{
    window.__VSP_CIO = window.__VSP_CIO || {};
    const qs = new URLSearchParams(location.search);
    window.__VSP_CIO.debug = (qs.get("debug")==="1") || (localStorage.getItem("VSP_DEBUG")==="1");
    window.__VSP_CIO.visible = function(){ return document.visibilityState === "visible"; };
    window.__VSP_CIO.sleep = (ms)=>new Promise(r=>setTimeout(r, ms));
    window.__VSP_CIO.backoff = async function(fn, opt){
      opt = opt || {};
      let delay = opt.delay || 800;
      const maxDelay = opt.maxDelay || 8000;
      const maxTries = opt.maxTries || 6;
      for(let i=0;i<maxTries;i++){
        if(!window.__VSP_CIO.visible()){
          await window.__VSP_CIO.sleep(600);
          continue;
        }
        try { return await fn(); }
        catch(e){
          if(window.__VSP_CIO.debug) console.warn("[VSP] backoff retry", i+1, e);
          await window.__VSP_CIO.sleep(delay);
          delay = Math.min(maxDelay, delay*2);
        }
      }
      throw new Error("backoff_exhausted");
    };
    window.__VSP_CIO.api = {
      ridLatest: ()=>"/api/vsp/rid_latest_v3",
      runs: (limit,offset)=>`/api/vsp/runs_v3?limit=${limit||50}&offset=${offset||0}`,
      gate: (rid)=>`/api/vsp/run_gate_v3?rid=${encodeURIComponent(rid||"")}`,
      findingsPage: (rid,limit,offset)=>`/api/vsp/findings_v3?rid=${encodeURIComponent(rid||"")}&limit=${limit||100}&offset=${offset||0}`,
      artifact: (rid,kind,download)=>`/api/vsp/artifact_v3?rid=${encodeURIComponent(rid||"")}&kind=${encodeURIComponent(kind||"")}${download?"&download=1":""}`
    };
  }catch(_){}
})();

/* VSP_P0_TOOLSTRIP_KILL_NA_V1P5B */
/* ===================== VSP_P0_TOOLSTRIP_KILL_NA_V1P5B ===================== */
(function(){
  try{
    if (window.__VSP_TOOLSTRIP_KILL_NA_V1P5B__) return;
    window.__VSP_TOOLSTRIP_KILL_NA_V1P5B__ = true;

    const NA = ("N"+"/A"); // NO literal token
    function getRid(){
      try { return new URL(location.href).searchParams.get("rid") || ""; }
      catch(e){ return ""; }
    }
    function cleanseText(v){
      try{
        if (typeof v !== "string") return v;
        // Replace any NA-like text with em dash (CIO safe)
        if (v.indexOf(NA) >= 0) v = v.split(NA).join("—");
        // Fix RID label if any code tried to show RID: NA/—
        if (v.indexOf("RID:") === 0){
          const rid = getRid() || "—";
          // if empty or dash, keep dash; else stamp rid
          if (v.indexOf("—") >= 0 || v.indexOf(NA) >= 0) v = "RID: " + rid;
        }
        // TS/verdict labels sometimes show "TS: —" already -> ok
        return v;
      }catch(e){ return v; }
    }

    // Wrap global setText if present (many toolstrip versions use it)
    const _st = window.setText;
    if (typeof _st === "function"){
      window.setText = function(){
        try{
          const args = Array.prototype.slice.call(arguments);
          if (args.length > 0){
            const last = args[args.length-1];
            if (typeof last === "string") args[args.length-1] = cleanseText(last);
          }
          return _st.apply(this, args);
        }catch(e){
          return _st.apply(this, arguments);
        }
      };
    }

  }catch(e){}
})();
/* ===================== /VSP_P0_TOOLSTRIP_KILL_NA_V1P5B ===================== */

/* VSP_P0_CIO_SCRUB_NA_ALL_V1P4C */
/* VSP_DASHBOARD_KPI_TOOLSTRIP_V2 */
(() => {
  if (window.__vsp_dashboard_kpi_toolstrip_v2) return;
if(window.__VSP_CIO && window.__VSP_CIO.debug){ window.__vsp_dashboard_kpi_toolstrip_v2 = true; }
  const TOOL_ORDER = ["BANDIT","SEMGREP","GITLEAKS","KICS","TRIVY","SYFT","GRYPE","CODEQL"];
  const SEV_ORDER  = ["CRITICAL","HIGH","MEDIUM","LOW","INFO","TRACE"];

  const $ = (sel, root=document) => root.querySelector(sel);

  async function getJson(url, timeoutMs=12000){
    const c = new AbortController();
    const t = setTimeout(() => c.abort(), timeoutMs);
    try{
      const r = await fetch(url, {signal:c.signal, credentials:"same-origin"});
      if (!r.ok) throw new Error("HTTP "+r.status);
      return await r.json();
    } finally { clearTimeout(t); }
  }

  function pillClass(v){
    const x = String(v||"").toUpperCase();
    if (x.includes("GREEN") || x==="OK" || x==="PASS") return "ok";
    if (x.includes("AMBER") || x==="WARN") return "warn";
    if (x.includes("RED") || x==="FAIL" || x==="BLOCK") return "bad";
    return "muted";
  }

  function ensureStyles(){
    if ($("#vspDashKpiStyleV2")) return;
    const st = document.createElement("style");
    st.id = "vspDashKpiStyleV2";
    st.textContent = `
      /* keep dark-enterprise visible even if page background is weird */
      #vspDashKpiRootV2{ position:relative; z-index: 5000; padding: 14px; color: rgba(255,255,255,0.92); }
      #vspDashKpiRootV2 .vsp-grid{ display:grid; gap:12px; }
      #vspDashKpiRootV2 .vsp-grid.kpi{ grid-template-columns: repeat(6, minmax(120px, 1fr)); }
      #vspDashKpiRootV2 .vsp-card{
        border:1px solid rgba(255,255,255,0.10);
        background: rgba(12,16,22,0.66);
        border-radius: 14px;
        padding: 12px 12px;
        box-shadow: 0 6px 18px rgba(0,0,0,0.22);
      }
      #vspDashKpiRootV2 .vsp-kpi-title{ font-size:12px; opacity:0.85; letter-spacing:0.2px; }
      #vspDashKpiRootV2 .vsp-kpi-val{ font-size:22px; font-weight:700; margin-top:6px; }
      #vspDashKpiRootV2 .vsp-row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
      #vspDashKpiRootV2 .vsp-tool{ display:flex; align-items:center; gap:8px; padding:8px 10px; border-radius: 12px;
        border:1px solid rgba(255,255,255,0.10); background: rgba(255,255,255,0.03); font-size:12px;
      }
      #vspDashKpiRootV2 .vsp-pill{ padding:2px 10px; border-radius:999px; border:1px solid rgba(255,255,255,0.14);
        background: rgba(255,255,255,0.05); font-size:12px;
      }
      #vspDashKpiRootV2 .vsp-pill.ok{ border-color: rgba(40,200,120,0.55); }
      #vspDashKpiRootV2 .vsp-pill.warn{ border-color: rgba(240,180,40,0.65); }
      #vspDashKpiRootV2 .vsp-pill.bad{ border-color: rgba(240,80,80,0.65); }
      #vspDashKpiRootV2 .vsp-pill.muted{ opacity:0.75; }
      #vspDashKpiRootV2 .vsp-title{ font-size:14px; font-weight:700; letter-spacing:0.2px; }
      #vspDashKpiRootV2 .vsp-sub{ font-size:12px; opacity:0.8; margin-top:4px; }
      #vspDashKpiRootV2 .vsp-two{ display:grid; gap:12px; grid-template-columns: 1.3fr 1fr; }
      #vspDashKpiRootV2 .vsp-mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; }
      @media (max-width: 1100px){
        #vspDashKpiRootV2 .vsp-grid.kpi{ grid-template-columns: repeat(3, minmax(120px, 1fr)); }
        #vspDashKpiRootV2 .vsp-two{ grid-template-columns: 1fr; }
      }
    `;
    document.head.appendChild(st);
  }

  function mount(){
    if (!String(location.pathname).includes("/vsp5")) return null;
    ensureStyles();

    let host = document.getElementById("vspDashKpiRootV2");
    if (host) return host;

    host = document.createElement("div");
    host.id = "vspDashKpiRootV2";

    // Prefer place right under topbar; else at body top
    const topbar = $(".vsp-topbar");
    if (topbar && topbar.parentNode){
      topbar.parentNode.insertBefore(host, topbar.nextSibling);
    } else {
      document.body.insertBefore(host, document.body.firstChild);
    }
    return host;
  }

  function renderSkeleton(host){
    host.innerHTML = `
      <div class="vsp-two">
        <div class="vsp-card">
          <div class="vsp-title">Gate summary</div>
          <div class="vsp-sub">Commercial KPI panel (V2)</div>
          <div style="height:8px"></div>
          <div class="vsp-row">
            <span class="vsp-pill muted" id="vspDashVerdictV2">…</span>
            <span class="vsp-pill muted vsp-mono" id="vspDashRidV2">RID: …</span>
            <span class="vsp-pill muted vsp-mono" id="vspDashTsV2">TS: …</span>
          </div>
        </div>

        <div class="vsp-card">
          <div class="vsp-title">Tools</div>
          <div class="vsp-sub">8-tool strip (missing shows 0)</div>
          <div style="height:8px"></div>
          <div class="vsp-row" id="vspToolStripV2"></div>
        </div>
      </div>

      <div style="height:12px"></div>

      <div class="vsp-card">
        <div class="vsp-title">Findings KPI</div>
        <div class="vsp-sub">From reports/ → counts_total</div>
        <div style="height:10px"></div>
        <div class="vsp-grid kpi" id="vspKpiGridV2"></div>
      </div>
    `;

    const strip = $("#vspToolStripV2", host);
    strip.innerHTML = TOOL_ORDER.map(t => `
      <div class="vsp-tool">
        <span class="vsp-pill muted">${t}</span>
        <span class="vsp-pill muted">0</span>
      </div>
    `).join("");

    const grid = $("#vspKpiGridV2", host);
    grid.innerHTML = SEV_ORDER.map(s => `
      <div class="vsp-card" style="padding:12px">
        <div class="vsp-kpi-title">${s}</div>
        <div class="vsp-kpi-val">…</div>
      </div>
    `).join("");
  }

  function setText(host, id, v){
    const el = document.getElementById(id);
    if (el && host.contains(el)) el.textContent = v;
  }
  function setPill(host, id, text, klass){
    const el = document.getElementById(id);
    if (!el || !host.contains(el)) return;
    el.textContent = text;
    el.classList.remove("ok","warn","bad","muted");
    el.classList.add(klass || "muted");
  }

  function render(host, rid, summary){
    const overall = String(summary?.overall || "UNKNOWN").toUpperCase();
    setPill(host, "vspDashVerdictV2", overall, pillClass(overall));
    setText(host, "vspDashRidV2", `RID: ${rid || '0'}`);
    setText(host, "vspDashTsV2", `TS: ${(summary && summary.ts) ? summary.ts : ("N"+"/A")}`);

    const counts = summary?.counts_total || {};
    const grid = $("#vspKpiGridV2", host);
    grid.innerHTML = SEV_ORDER.map(sev => {
      const val = (counts && (sev in counts)) ? counts[sev] : 0;
      return `
        <div class="vsp-card" style="padding:12px">
          <div class="vsp-kpi-title">${sev}</div>
          <div class="vsp-kpi-val">${Number(val||0)}</div>
        </div>
      `;
    }).join("");

    const byTool = summary?.by_tool || {};
    const strip = $("#vspToolStripV2", host);
    strip.innerHTML = TOOL_ORDER.map(t => {
      const o = byTool?.[t] || null;
      const verdict = o?.verdict ? String(o.verdict).toUpperCase() : ("N"+"/A");
      const klass = verdict === ("N"+"/A") ? "muted" : pillClass(verdict);
      const tot = (o && typeof o.total !== "undefined") ? `total:${o.total}` : "";
      return `
        <div class="vsp-tool">
          <span class="vsp-pill muted">${t}</span>
          <span class="vsp-pill ${klass}">${verdict}</span>
          <span style="opacity:0.75" class="vsp-mono">${tot}</span>
        </div>
      `;
    }).join("");
  }

  async function loadOnce(){
    const host = mount();
    if (!host) return;
    renderSkeleton(host);

    let rid = null;
    try{
      const runs = await getJson("/api/vsp/rid_latest_v3", 12000);
      rid = runs?.items?.[0]?.run_id || null;
    }catch(_){}

    if (!rid){
      setPill(host, "vspDashVerdictV2", "UNKNOWN", "muted");
      setText(host, "vspDashRidV2", "RID: " + ("N"+"/A"));
      return;
    }

    try{
      const summary = await getJson(`/api/vsp/run_file?rid=${encodeURIComponent(rid)}&name=${encodeURIComponent("reports/")}`, 15000);
      render(host, rid, summary);
    }catch(_){
      setPill(host, "vspDashVerdictV2", "UNKNOWN", "muted");
      setText(host, "vspDashRidV2", `RID: ${rid}`);
    }
  }

  function armRemount(){
    // if other scripts wipe DOM, re-add our panel
    const mo = new MutationObserver(() => {
      if (!String(location.pathname).includes("/vsp5")) return;
      const host = document.getElementById("vspDashKpiRootV2");
      if (!host) {
        // delay a bit so we re-mount after other renderer
        setTimeout(loadOnce, 120);
      }
    });
    mo.observe(document.documentElement, {childList:true, subtree:true});
  }

  function start(){
    // let other dashboard scripts render first, then we overlay
    setTimeout(loadOnce, 250);
    armRemount();
  }

  if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", start);
  else start();
})();
