/* VSP_P0_CIO_GATECOUNTS_FALLBACK_V1P4C */
/* ===================== VSP_P0_CIO_GATECOUNTS_FALLBACK_V1P4C ===================== */
(function(){
  try{
    if (window.__VSP_GATECOUNTS_FALLBACK_V1P4C__) return;
    window.__VSP_GATECOUNTS_FALLBACK_V1P4C__ = true;

    function qp(name){
      try { return new URL(location.href).searchParams.get(name) || ""; } catch(e){ return ""; }
    }
    function num(v){ const n=Number(v); return Number.isFinite(n)?n:0; }
    function upper(k){ try{return String(k||"").toUpperCase();}catch(e){return "";} }

    function deriveCountsTotalFromObj(obj){
      try{
        if(!obj || typeof obj!=="object") return null;
        const bag = obj.counts_total || obj.counts_by_severity || obj.by_severity || obj.severity || obj.counts || null;
        if(!bag || typeof bag!=="object") return null;
        const sev = {CRITICAL:0,HIGH:0,MEDIUM:0,LOW:0,INFO:0, TRACE:0};
        for (const k in bag){
          const uk=upper(k);
          if(uk in sev) sev[uk]=num(bag[k]);
        }
        const total = num(bag.TOTAL ?? bag.total) || (sev.CRITICAL+sev.HIGH+sev.MEDIUM+sev.LOW+sev.INFO+sev.TRACE);
        return {...sev, TOTAL: total};
      }catch(e){ return null; }
    }

    async function fetchJson(url){
      const r = await fetch(url, { credentials: "same-origin" });
      if(!r.ok) throw new Error("HTTP "+r.status+" "+url);
      return await r.json();
    }

    // Main: if dashboard payload has no counts_total, fetch gate summary and merge.
    window.__vspEnsureCountsTotalV1P4C = async function(payload){
      try{
        const rid = qp("rid");
        if(!rid) return payload;

        // If payload already has counts_total with TOTAL -> done
        const ct0 = deriveCountsTotalFromObj(payload);
      }catch(e){}
      return payload;
    };
  }catch(e){}
})();


/* ===================== VSP_P0_CIO_KPI_NO_NA_CONSIST_V1P4 ===================== */
(function(){
  try{
    if (window.__VSP_CIO_KPI_V1P4__) return;
    window.__VSP_CIO_KPI_V1P4__ = true;

    function _num(v){
      const n = Number(v);
      return Number.isFinite(n) ? n : 0;
    }
    function _upperKey(k){ try{return String(k||"").toUpperCase();}catch(e){return "";} }

    function _extractSevBag(obj){
      if(!obj || typeof obj !== "object") return null;
      return obj.counts_by_severity || obj.by_severity || obj.severity || obj.counts || null;
    }

    window.__vspCioNormalizeCountsV1P4 = function(obj){
      try{
        if(!obj || typeof obj !== "object") return obj;

        // normalize severity bucket
        const bag = _extractSevBag(obj);
        const sev = { CRITICAL:0, HIGH:0, MEDIUM:0, LOW:0, INFO:0, TRACE:0 };
        if (bag && typeof bag === "object"){
          for (const k in bag){
            const uk = _upperKey(k);
            if (uk in sev) sev[uk] = _num(bag[k]);
          }
        }

        // prefer explicit totals if present, else compute from sev
        const explicitTotal =
          obj.total ??
          obj.total_findings ??
          obj.findings_total ??
          (obj.counts_total && (obj.counts_total.TOTAL ?? obj.counts_total.total)) ??
          null;

        const computedTotal = sev.CRITICAL + sev.HIGH + sev.MEDIUM + sev.LOW + sev.INFO + sev.TRACE;
        const total = _num(explicitTotal) || computedTotal;

        // stamp back stable keys (no —)
        obj.total = total;
        obj.total_findings = total;
        obj.findings_total = total;

        obj.critical = _num(obj.critical) || sev.CRITICAL;
        obj.high = _num(obj.high) || sev.HIGH;

        obj.counts_by_severity = { ...sev };
        obj.by_severity = { ...sev };

        // stable counts_total shape
        obj.counts_total = { ...sev, TOTAL: total };

        return obj;
      }catch(e){ return obj; }
    };

    window.__vspCioNormalizePayloadV1P4 = function(payload){
      try{
        if(!payload || typeof payload !== "object") return payload;

        // common containers
        const cands = [
          payload,
          payload.data,
          payload.dashboard,
          payload.summary,
          payload.gate,
          payload.run_gate,
          payload.run,
          payload.counts_total
        ];
        for (const c of cands){
          if (c && typeof c === "object") window.__vspCioNormalizeCountsV1P4(c);
        }

        // if payload has counts_total as object with sev keys, also ensure TOTAL
        if (payload.counts_total && typeof payload.counts_total === "object"){
          const sev = { CRITICAL:0,HIGH:0,MEDIUM:0,LOW:0,INFO:0, TRACE:0 };
          for (const k in payload.counts_total){
            const uk = _upperKey(k);
            if (uk in sev) sev[uk] = _num(payload.counts_total[k]);
          }
          const tot = _num(payload.counts_total.TOTAL ?? payload.counts_total.total) || (sev.CRITICAL+sev.HIGH+sev.MEDIUM+sev.LOW+sev.INFO+sev.TRACE);
          payload.counts_total = { ...sev, TOTAL: tot };
        }

        return payload;
      }catch(e){ return payload; }
    };

    // scrub any "—" appearing in UI (CIO trust)
    function scrubNA(root){
      try{
        root = root || document;
        const nodes = root.querySelectorAll("*");
        for (const n of nodes){
          const t = (n && n.childNodes && n.childNodes.length===1 && n.childNodes[0].nodeType===3) ? (n.textContent||"") : "";
          if(!t) continue;
          if (t.trim() === "—" || t.trim() === "-"){
            n.textContent = "0";
            n.setAttribute("title","No data for this run");
          }
          // common pattern: "Total findings: —"
          if (t.includes("—")){
            const tt = t.replace(/\bN\/A\b/g, "0").replace(/-/gi,"0");
            if (tt !== t){
              n.textContent = tt;
              n.setAttribute("title","No data for this run");
            }
          }
        }
      }catch(e){}
    }

    function attachObserver(){
      try{
        scrubNA(document);
        const obs = new MutationObserver(function(){ scrubNA(document); });
        obs.observe(document.documentElement || document.body, { childList:true, subtree:true, characterData:true });
      }catch(e){}
    }

    if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", attachObserver, { once:true });
    else attachObserver();

  }catch(e){}
})();
/* ===================== /VSP_P0_CIO_KPI_NO_NA_CONSIST_V1P4 ===================== */

/* VSP_P0_DASH_MIN_STABLE_V1
   Purpose: eliminate all loops/bind storms; render a small stable panel that proves dashboard works.
*/
(()=> {
  if (window.__VSP_P0_DASH_MIN_STABLE_V1) return; if (new URLSearchParams(location.search).get("debug")!=="1") return;
  window.__VSP_P0_DASH_MIN_STABLE_V1 = true;

  const log=(...a)=>console.log("[VSP][MIN_STABLE]",...a);

  function esc(s){
    return String(s??"").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  function ensurePanel(){
    let el = document.getElementById("vsp_min_stable_panel_v1");
    if (el) return el;

    el = document.createElement("div");
    el.id = "vsp_min_stable_panel_v1";
    el.style.cssText = [
      "position:fixed","right:16px","bottom:16px","z-index:99999",
      "width:520px","max-width:calc(100vw - 32px)",
      "background:rgba(10,14,26,.92)","color:#e6e9f2",
      "border:1px solid rgba(255,255,255,.14)","border-radius:14px",
      "box-shadow:0 18px 48px rgba(0,0,0,.45)",
      "backdrop-filter: blur(8px)",
      "font:13px/1.35 system-ui,Segoe UI,Arial",
      "padding:12px"
    ].join(";");

    el.innerHTML = `
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
        <div style="font-weight:700">VSP • Dashboard (MIN_STABLE)</div>
        <button id="vsp_ms_close" style="cursor:pointer;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.06);color:#e6e9f2;border-radius:10px;padding:6px 10px">Close</button>
      </div>

      <div style="margin-top:8px;opacity:.85">
        RID: <span id="vsp_ms_rid" style="font-family:ui-monospace,Menlo,Consolas,monospace">...</span>
        <span style="margin-left:10px">Overall: <b id="vsp_ms_overall">...</b></span>
      </div>

      <div id="vsp_ms_status" style="margin-top:8px;opacity:.85">booting…</div>

      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px">
        <div style="flex:1;min-width:110px;border:1px solid rgba(255,255,255,.10);border-radius:12px;padding:8px;background:rgba(255,255,255,.03)">
          <div style="opacity:.75">HIGH</div><div id="vsp_ms_high" style="font-weight:800;font-size:18px">-</div>
        </div>
        <div style="flex:1;min-width:110px;border:1px solid rgba(255,255,255,.10);border-radius:12px;padding:8px;background:rgba(255,255,255,.03)">
          <div style="opacity:.75">MEDIUM</div><div id="vsp_ms_medium" style="font-weight:800;font-size:18px">-</div>
        </div>
        <div style="flex:1;min-width:110px;border:1px solid rgba(255,255,255,.10);border-radius:12px;padding:8px;background:rgba(255,255,255,.03)">
          <div style="opacity:.75">LOW</div><div id="vsp_ms_low" style="font-weight:800;font-size:18px">-</div>
        </div>
        <div style="flex:1;min-width:110px;border:1px solid rgba(255,255,255,.10);border-radius:12px;padding:8px;background:rgba(255,255,255,.03)">
          <div style="opacity:.75">INFO</div><div id="vsp_ms_info" style="font-weight:800;font-size:18px">-</div>
        </div>
      </div>

      <div style="display:flex;align-items:center;gap:8px;margin-top:10px">
        <button id="vsp_ms_reload" style="cursor:pointer;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.06);color:#e6e9f2;border-radius:10px;padding:8px 12px">Reload summary</button>
        <button id="vsp_ms_top" style="cursor:pointer;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.06);color:#e6e9f2;border-radius:10px;padding:8px 12px">Load top findings (25)</button>
      </div>

      <div id="vsp_ms_tablewrap" style="margin-top:10px;max-height:320px;overflow:auto;border:1px solid rgba(255,255,255,.10);border-radius:12px;background:rgba(255,255,255,.02)">
        <table style="width:100%;border-collapse:collapse">
          <thead>
            <tr style="opacity:.8">
              <th style="text-align:left;padding:8px;border-bottom:1px solid rgba(255,255,255,.08)">Sev</th>
              <th style="text-align:left;padding:8px;border-bottom:1px solid rgba(255,255,255,.08)">Tool</th>
              <th style="text-align:left;padding:8px;border-bottom:1px solid rgba(255,255,255,.08)">Title</th>
              <th style="text-align:left;padding:8px;border-bottom:1px solid rgba(255,255,255,.08)">Loc</th>
            </tr>
          </thead>
          <tbody id="vsp_ms_rows">
            <tr><td colspan="4" style="padding:10px;opacity:.75">Not loaded</td></tr>
          </tbody>
        </table>
      </div>
    `;

    document.body.appendChild(el);

    el.querySelector("#vsp_ms_close").addEventListener("click", ()=> el.remove(), {once:true});
    return el;
  }

  function setStatus(t){
    const el = document.getElementById("vsp_ms_status");
    if (el) el.textContent = t;
  }

  async function getLatestRid(){
    const r = await fetch("/api/vsp/rid_latest_gate_root", {cache:"no-store"});
    const j = await r.json();
    return j && j.rid ? j.rid : "";
  }

  async function loadSummary(rid){
    // prefer  (you already have it OK)
    const url = `/api/vsp/run_gate_summary_v1?rid=${encodeURIComponent(rid)}`;
    const r = await fetch(url, {cache:"no-store"});
    const j = await r.json();
    return j || {};
  }

  function applyCounts(j){
    const c = (j && j.counts_total) ? j.counts_total : {};
    const set=(id,v)=>{ const e=document.getElementById(id); if(e) e.textContent = (v===0? "0" : (v||"-")); };
    set("vsp_ms_high", c.HIGH);
    set("vsp_ms_medium", c.MEDIUM);
    set("vsp_ms_low", c.LOW);
    set("vsp_ms_info", c.INFO);

    const ov = (j && j.overall) ? j.overall : "-";
    const eov = document.getElementById("vsp_ms_overall");
    if (eov) eov.textContent = ov;
  }

  function renderRows(items){
    const tb = document.getElementById("vsp_ms_rows");
    if (!tb) return;
    if (!Array.isArray(items) || items.length === 0){
      tb.innerHTML = `<tr><td colspan="4" style="padding:10px;opacity:.75">No items</td></tr>`;
      return;
    }
    tb.innerHTML = items.map(it => {
      const sev = esc(it.severity||"");
      const tool = esc(it.tool||"");
      const title = esc(it.title||"");
      const loc = esc((it.file||"") + (it.line? (":" + it.line) : ""));
      return `<tr>
        <td style="padding:8px;border-top:1px solid rgba(255,255,255,.06)">${sev}</td>
        <td style="padding:8px;border-top:1px solid rgba(255,255,255,.06)">${tool}</td>
        <td style="padding:8px;border-top:1px solid rgba(255,255,255,.06)">${title}</td>
        <td style="padding:8px;border-top:1px solid rgba(255,255,255,.06);font-family:ui-monospace,Menlo,Consolas,monospace">${loc}</td>
      </tr>`;
    }).join("");
  }

  async function loadTop(rid, limit=25){
    // this one you validated returns real rows
    const url = `/api/vsp/top_findings_v4?rid=${encodeURIComponent(rid)}&limit=${encodeURIComponent(limit)}`;
    const r = await fetch(url, {cache:"no-store"});
    const j = await r.json();
    if (!j || !j.ok) return {ok:false, err:(j&&j.err)||"err", items:[]};
    return {ok:true, items:Array.isArray(j.items)?j.items:[], src:j.source||"v4"};
  }

  async function boot(){
    ensurePanel();
    try{
      setStatus("Fetching rid_latest_gate_root…");
      const rid = await getLatestRid();
      const ridEl = document.getElementById("vsp_ms_rid");
      if (ridEl) ridEl.textContent = rid || "<none>";
      if (!rid){
        setStatus("No RID from /api/vsp/rid_latest_gate_root");
        return;
      }

      setStatus("Loading …");
      const sum = await loadSummary(rid);
      applyCounts(sum);
      setStatus("Summary loaded. Click 'Load top findings'.");

      const btnReload = document.getElementById("vsp_ms_reload");
      const btnTop = document.getElementById("vsp_ms_top");

      if (btnReload){
        btnReload.onclick = async ()=>{
          try{
            setStatus("Reloading summary…");
            const s2 = await loadSummary(rid);
            applyCounts(s2);
            setStatus("Summary reloaded.");
          }catch(e){
            console.error("[VSP][MIN_STABLE] reload err", e);
            setStatus("Reload error (see console)");
          }
        };
      }

      if (btnTop){
        btnTop.onclick = async ()=>{
          try{
            setStatus("Loading top findings via /api/vsp/top_findings_v4…");
            const t = await loadTop(rid, 25);
            if (!t.ok){
              renderRows([]);
              setStatus("Topfind: " + (t.err||"no data"));
              return;
            }
            renderRows(t.items);
            setStatus(`Topfind loaded: ${t.items.length} • ${t.src} • ${rid}`);
          }catch(e){
            console.error("[VSP][MIN_STABLE] topfind err", e);
            setStatus("Topfind error (see console)");
          }
        };
      }

      log("boot ok", {rid});
    }catch(e){
      console.error("[VSP][MIN_STABLE] boot err", e);
      setStatus("Boot error (see console)");
    }
  }

  if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", boot, {once:true});
  else boot();
})();



/* ===================== VSP_P1_UI_OK_BADGE_V1 ===================== */
(()=> {
  if (window.__vsp_p1_ui_ok_badge_v1) return;
  window.__vsp_p1_ui_ok_badge_v1 = true;

  async function ping(){
    try{
      const r = await fetch("/api/vsp/rid_latest_gate_root", {credentials:"same-origin"});
      if(!r.ok) return {ok:false, status:r.status};
      const j = await r.json().catch(()=>null);
      return {ok: !!(j && (j.ok || j.rid)), status:200};
    }catch(e){
      return {ok:false, status:0};
    }
  }

  function mount(){
    if (document.getElementById("vsp_ui_ok_badge_v1")) return;

    const host =
      document.querySelector("header") ||
      document.querySelector(".topbar") ||
      document.querySelector("#topbar") ||
      document.body;

    const b = document.createElement("span");
    b.id = "vsp_ui_ok_badge_v1";
    b.textContent = "UI: …";
    b.style.cssText =
      "display:inline-flex;align-items:center;gap:6px;" +
      "padding:4px 10px;border-radius:999px;" +
      "border:1px solid rgba(255,255,255,.12);" +
      "background:rgba(255,255,255,.06);" +
      "color:#d8ecff;font:12px/1.2 system-ui,Segoe UI,Roboto;" +
      "margin-left:10px;";

    // If host is body (fallback), make fixed
    if (host === document.body){
      b.style.cssText += "position:fixed;z-index:99998;top:10px;right:12px;";
      document.body.appendChild(b);
    } else {
      host.appendChild(b);
    }

    async function refresh(){
      const res = await ping();
      if(res.ok){
        b.textContent = "UI: OK";
        b.style.borderColor = "rgba(90,255,170,.35)";
        b.style.background = "rgba(20,80,40,.35)";
        b.style.color = "#c9ffe0";
      } else {
        b.textContent = "UI: DEGRADED";
        b.style.borderColor = "rgba(255,210,120,.35)";
        b.style.background = "rgba(80,60,20,.35)";
        b.style.color = "#ffe7b7";
      }
    }

    refresh();
    setInterval(refresh, 30000);
  }

  if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", mount);
  else mount();
})();
/* ===================== /VSP_P1_UI_OK_BADGE_V1 ===================== */




/* ===================== VSP_P0_DASH_FILL_MAIN_KPI_TOPFIND_V1 =====================
   Goal: Populate main KPI cards + main Top Findings table by hooking MIN_STABLE overlay buttons.
   Safe: no loops, no bind storms.
*/
(()=> {
  try{
    if (window.__VSP_P0_DASH_FILL_MAIN_KPI_TOPFIND_V1) return;
    window.__VSP_P0_DASH_FILL_MAIN_KPI_TOPFIND_V1 = true;

    const log=(...a)=>console.log("[VSP][FILL_MAIN_V1]",...a);

    function esc(s){
      return String(s ?? "").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    function u(s){ return String(s||"").trim().toUpperCase(); }
    function l(s){ return String(s||"").trim().toLowerCase(); }

    // ---- KPI fill by label text (TOTAL/CRITICAL/HIGH/MEDIUM/LOW/INFO/TRACE) ----
    function findLabelEl(label){
      const want = u(label);
      const all = document.querySelectorAll("div,span,small,strong,b,h1,h2,h3,h4");
      for (const el of all){
        const t = u(el.textContent || "");
        if (t === want) return el;
      }
      return null;
    }

    function fillOneKpi(label, value){
      const labEl = findLabelEl(label);
      if (!labEl) return false;

      // climb to a reasonable card container
      let root = labEl;
      for (let i=0; i<8 && root && root.parentElement; i++){
        root = root.parentElement;
        const txt = u(root.textContent||"");
        // heuristic: container includes label and at least one dash
        if (txt.indexOf(u(label)) >= 0 && (root.textContent||"").indexOf("—") >= 0) break;
      }
      if (!root) return false;

      // replace first dash-like element inside the container
      const els = root.querySelectorAll("div,span,strong,b");
      for (const el of els){
        const t = (el.textContent||"").trim();
        if (t === "—" || t === "-" || t === "--"){
          el.textContent = String(value ?? "-");
          return true;
        }
      }
      return false;
    }

    function fillKpisFromSummary(summary){
      const c = (summary && summary.counts_total) ? summary.counts_total : {};
      const total = ["CRITICAL","HIGH","MEDIUM","LOW","INFO","TRACE"].reduce((a,k)=>a+(Number(c[k]||0)||0),0);
      fillOneKpi("TOTAL", total);
      fillOneKpi("CRITICAL", c.CRITICAL);
      fillOneKpi("HIGH", c.HIGH);
      fillOneKpi("MEDIUM", c.MEDIUM);
      fillOneKpi("LOW", c.LOW);
      fillOneKpi("INFO", c.INFO);
      fillOneKpi("TRACE", c.TRACE);
      log("kpi filled", {total});
    }

    // ---- Top findings main table: pick table that has headers Severity/Tool/Title/Location ----
    function findMainTopTableTbody(){
      const tables = Array.from(document.querySelectorAll("table"));
      for (const t of tables){
        const h = l(t.innerText || "");
        if (h.includes("severity") && h.includes("tool") && h.includes("title") && (h.includes("location") || h.includes("loc"))){
          const tb = t.querySelector("tbody");
          if (tb) return tb;
        }
      }
      return null;
    }

    function renderTopFindingsInMain(items){
      const tbody = findMainTopTableTbody();
      if (!tbody){
        log("cannot find main Top findings table");
        return false;
      }
      if (!Array.isArray(items) || items.length === 0){
        tbody.innerHTML = '<tr><td colspan="4" style="padding:10px;opacity:.75">No items</td></tr>';
        return true;
      }
      tbody.innerHTML = items.map(it=>{
        const sev = esc(it.severity||"");
        const tool = esc(it.tool||"");
        const title = esc(it.title||"");
        const loc = esc((it.file||"") + (it.line ? (":" + it.line) : ""));
        return `<tr>
          <td style="padding:10px;border-top:1px solid rgba(255,255,255,.06)">${sev}</td>
          <td style="padding:10px;border-top:1px solid rgba(255,255,255,.06)">${tool}</td>
          <td style="padding:10px;border-top:1px solid rgba(255,255,255,.06)">${title}</td>
          <td style="padding:10px;border-top:1px solid rgba(255,255,255,.06);font-family:ui-monospace,Menlo,Consolas,monospace">${loc}</td>
        </tr>`;
      }).join("");
      return true;
    }

    // ---- Hook MIN_STABLE overlay buttons ----
    async function getRidFromPanel(){
      const ridEl = document.getElementById("vsp_ms_rid");
      const rid = ridEl ? (ridEl.textContent||"").trim() : "";
      return rid || "";
    }

    function hookOnce(){
      const btnReload = document.getElementById("vsp_ms_reload");
      const btnTop = document.getElementById("vsp_ms_top");

      if (btnReload && !btnReload.__vsp_fill_main_hooked){
        btnReload.__vsp_fill_main_hooked = true;
        btnReload.addEventListener("click", async ()=>{
          try{
            const rid = await getRidFromPanel();
            if (!rid) return;
            const url = `/api/vsp/run_gate_summary_v1?rid=${encodeURIComponent(rid)}`;
            const res = await fetch(url, {cache:"no-store"});
            const j = await res.json();
            fillKpisFromSummary(j);
          }catch(e){ console.error("[VSP][FILL_MAIN_V1] reload hook err", e); }
        });
      }

      if (btnTop && !btnTop.__vsp_fill_main_hooked){
        btnTop.__vsp_fill_main_hooked = true;
        btnTop.addEventListener("click", async ()=>{
          try{
            const rid = await getRidFromPanel();
            if (!rid) return;
            const url = `/api/vsp/top_findings_v4?rid=${encodeURIComponent(rid)}&limit=25`;
            const res = await fetch(url, {cache:"no-store"});
            const j = await res.json();
            if (j && j.ok) renderTopFindingsInMain(j.items||[]);
            else log("top findings not ok", j);
          }catch(e){ console.error("[VSP][FILL_MAIN_V1] top hook err", e); }
        });
      }

      log("hooked MIN_STABLE buttons -> main fill");
    }

    // try a few times (very light) to wait overlay creation
    let tries = 0;
    const iv = setInterval(()=>{
      tries++;
      hookOnce();
      if (document.getElementById("vsp_ms_top") || tries >= 10) clearInterval(iv);
    }, 200);

  }catch(e){
    console.error("[VSP][FILL_MAIN_V1] fatal", e);
  }
})();
/* ===================== /VSP_P0_DASH_FILL_MAIN_KPI_TOPFIND_V1 ===================== */





/* ===================== VSP_P1_UI_OK_BADGE_V2_FORCE_FIXED ===================== */
(()=> {
  if (window.__vsp_p1_ui_ok_badge_v2) return;
  window.__vsp_p1_ui_ok_badge_v2 = true;

  async function ping(){
    try{
      const r = await fetch("/api/vsp/rid_latest_gate_root", {credentials:"same-origin"});
      if(!r.ok) return {ok:false, status:r.status};
      const j = await r.json().catch(()=>null);
      return {ok: !!(j && (j.ok || j.rid)), status:200};
    }catch(e){
      return {ok:false, status:0};
    }
  }

  function mount(){
    let b = document.getElementById("vsp_ui_ok_badge_v2");
    if (!b){
      b = document.createElement("div");
      b.id = "vsp_ui_ok_badge_v2";
      b.style.cssText =
        "position:fixed;z-index:999999;top:10px;right:12px;" +
        "display:inline-flex;align-items:center;gap:8px;" +
        "padding:6px 12px;border-radius:999px;" +
        "border:1px solid rgba(255,255,255,.12);" +
        "background:rgba(10,18,32,.82);" +
        "backdrop-filter: blur(10px);" +
        "color:#d8ecff;font:12px/1.2 system-ui,Segoe UI,Roboto;" +
        "box-shadow:0 10px 30px rgba(0,0,0,.35)";
      b.textContent = "UI: …";
      document.body.appendChild(b);
    }

    async function refresh(){
      const res = await ping();
      if(res.ok){
        b.textContent = "UI: OK";
        b.style.borderColor = "rgba(90,255,170,.35)";
        b.style.background = "rgba(20,80,40,.35)";
        b.style.color = "#c9ffe0";
      } else {
        b.textContent = "UI: DEGRADED";
        b.style.borderColor = "rgba(255,210,120,.35)";
        b.style.background = "rgba(80,60,20,.35)";
        b.style.color = "#ffe7b7";
      }
    }
    refresh();
    setInterval(refresh, 20000);
  }

  if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", mount);
  else mount();
})();
/* ===================== /VSP_P1_UI_OK_BADGE_V2_FORCE_FIXED ===================== */




/* ===================== VSP_P0_DASH_FILL_MAIN_KPI_TOPFIND_V1C =====================
   Robust fill for main KPI cards + Top findings table by label proximity.
   - No loops/bind storms
   - Hooks MIN_STABLE buttons if present
*/
(()=> {
  try{
    if (window.__VSP_P0_DASH_FILL_MAIN_KPI_TOPFIND_V1C) return;
    window.__VSP_P0_DASH_FILL_MAIN_KPI_TOPFIND_V1C = true;

    const log=(...a)=>console.log("[VSP][FILL_MAIN_V1C]",...a);
    const LABELS=["TOTAL","CRITICAL","HIGH","MEDIUM","LOW","INFO","TRACE"];

    const U=s=>String(s||"").trim().toUpperCase();
    const L=s=>String(s||"").trim().toLowerCase();

    function esc(s){
      return String(s ?? "").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    function isDashLike(t){
      t = String(t||"").trim();
      return t==="" || t==="—" || t==="-" || t==="--";
    }

    function numLike(t){
      const x = String(t||"").trim();
      if (!x) return false;
      return /^[0-9]{1,9}$/.test(x);
    }

    // Find the element that displays the label (exact match)
    function findLabelEl(label){
      const want = U(label);
      // Prefer small texts (labels are short)
      const cands = document.querySelectorAll("div,span,small,strong,b");
      for (const el of cands){
        const t = U(el.textContent||"");
        if (t === want) return el;
      }
      return null;
    }

    // Given label element, pick best nearby "value" element to set.
    function pickValueElFromLabel(labelEl){
      if (!labelEl) return null;

      // 1) sibling candidates
      const sibs = [];
      if (labelEl.parentElement){
        for (const ch of Array.from(labelEl.parentElement.children)){
          if (ch === labelEl) continue;
          sibs.push(ch);
        }
      }

      // 2) within parent: any element that looks like a value
      const parent = labelEl.parentElement || labelEl;
      const within = Array.from(parent.querySelectorAll("div,span,strong,b")).filter(x => x !== labelEl);

      const pool = [...sibs, ...within].filter(Boolean);

      // Prefer dash/empty or numeric placeholders, and prefer "bigger" font-size.
      let best = null;
      let bestScore = -1;

      for (const el of pool){
        const t = (el.textContent||"").trim();
        if (U(t) === U(labelEl.textContent||"")) continue;
        // ignore if it contains too much text (likely container)
        if (t.length > 20 && !numLike(t) && !isDashLike(t)) continue;

        let score = 0;
        if (isDashLike(t)) score += 3;
        if (numLike(t)) score += 2;

        // font size heuristic
        try{
          const fs = parseFloat(getComputedStyle(el).fontSize || "0") || 0;
          score += Math.min(3, fs / 10);
        }catch(e){}

        // nearer sibling bonus
        if (el.parentElement === parent) score += 1;

        if (score > bestScore){
          bestScore = score;
          best = el;
        }
      }

      // 3) fallback: previous sibling chain
      if (!best && labelEl.previousElementSibling) best = labelEl.previousElementSibling;

      return best;
    }

    function fillOne(label, value){
      const lab = findLabelEl(label);
      if (!lab) return false;
      const valEl = pickValueElFromLabel(lab);
      if (!valEl) return false;
      valEl.textContent = String(value ?? "-");
      return true;
    }

    function fillKpisFromSummary(summary){
      const c = (summary && summary.counts_total) ? summary.counts_total : {};
      const total = ["CRITICAL","HIGH","MEDIUM","LOW","INFO","TRACE"].reduce((a,k)=>a+(Number(c[k]||0)||0),0);

      const map = {
        TOTAL: total,
        CRITICAL: c.CRITICAL ?? 0,
        HIGH: c.HIGH ?? 0,
        MEDIUM: c.MEDIUM ?? 0,
        LOW: c.LOW ?? 0,
        INFO: c.INFO ?? 0,
        c.TRACE ?? 0,
      };

      let ok=0;
      for (const k of LABELS){
        if (fillOne(k, map[k])) ok++;
      }
      log("kpi filled", {ok, rid: summary && summary.rid, overall: summary && summary.overall});
      return ok;
    }

    // --- Top findings main section/table ---
    function findTopSection(){
      const els = document.querySelectorAll("h1,h2,h3,h4,div,span,strong,b");
      for (const el of els){
        const t = L(el.textContent||"");
        if (t.includes("top findings")){
          // climb to a section-like container
          let root = el;
          for (let i=0;i<10 && root && root.parentElement;i++){
            root = root.parentElement;
            if (root.querySelector && root.querySelector("table")) return root;
          }
          return el.parentElement || el;
        }
      }
      return null;
    }

    function getTopTableBody(){
      const sec = findTopSection();
      if (!sec) return null;
      let table = sec.querySelector("table");
      if (!table){
        // create table minimal (rare)
        table = document.createElement("table");
        table.style.width="100%";
        sec.appendChild(table);
      }
      let tbody = table.querySelector("tbody");
      if (!tbody){
        tbody = document.createElement("tbody");
        table.appendChild(tbody);
      }
      return tbody;
    }

    function renderTop(items){
      const tbody = getTopTableBody();
      if (!tbody){
        log("cannot find top table");
        return false;
      }
      if (!Array.isArray(items) || items.length===0){
        tbody.innerHTML = '<tr><td colspan="4" style="padding:10px;opacity:.75">No items</td></tr>';
        return true;
      }
      tbody.innerHTML = items.map(it=>{
        const sev = esc(it.severity||"");
        const tool = esc(it.tool||"");
        const title = esc(it.title||"");
        const loc = esc((it.file||"") + (it.line ? (":" + it.line) : ""));
        return `<tr>
          <td style="padding:10px;border-top:1px solid rgba(255,255,255,.06)">${sev}</td>
          <td style="padding:10px;border-top:1px solid rgba(255,255,255,.06)">${tool}</td>
          <td style="padding:10px;border-top:1px solid rgba(255,255,255,.06)">${title}</td>
          <td style="padding:10px;border-top:1px solid rgba(255,255,255,.06);font-family:ui-monospace,Menlo,Consolas,monospace">${loc}</td>
        </tr>`;
      }).join("");
      return true;
    }

    async function getRidFromPanelOrApi(){
      const ridEl = document.getElementById("vsp_ms_rid");
      const rid = ridEl ? (ridEl.textContent||"").trim() : "";
      if (rid) return rid;
      const res = await fetch("/api/vsp/rid_latest_gate_root", {cache:"no-store"});
      const j = await res.json();
      return (j && j.rid) ? String(j.rid) : "";
    }

    async function loadSummaryAndFill(){
      const rid = await getRidFromPanelOrApi();
      if (!rid) return;
      const url = `/api/vsp/run_gate_summary_v1?rid=${encodeURIComponent(rid)}`;
      const res = await fetch(url, {cache:"no-store"});
      const j = await res.json();
      j.rid = rid;
      fillKpisFromSummary(j);
    }

    async function loadTopAndRender(){
      const rid = await getRidFromPanelOrApi();
      if (!rid) return;
      const url = `/api/vsp/top_findings_v4?rid=${encodeURIComponent(rid)}&limit=25`;
      const res = await fetch(url, {cache:"no-store"});
      const j = await res.json();
      if (j && j.ok){
        renderTop(j.items||[]);
        log("top rendered", {n:(j.items||[]).length, rid, source:j.source});
      }else{
        log("top not ok", j);
      }
    }

    // Hook MIN_STABLE buttons if exist
    function hook(){
      const btnReload = document.getElementById("vsp_ms_reload");
      const btnTop = document.getElementById("vsp_ms_top");

      if (btnReload && !btnReload.__vsp_fill_v1c){
        btnReload.__vsp_fill_v1c = true;
        btnReload.addEventListener("click", ()=>{ loadSummaryAndFill(); });
      }
      if (btnTop && !btnTop.__vsp_fill_v1c){
        btnTop.__vsp_fill_v1c = true;
        btnTop.addEventListener("click", ()=>{ loadTopAndRender(); });
      }
      if (btnReload || btnTop) log("hooked MIN_STABLE buttons");
    }

    // Light bootstrap (no loops): try hook a few times only
    let tries=0;
    const iv=setInterval(()=>{
      tries++;
      hook();
      if (document.getElementById("vsp_ms_reload") || tries>=10) clearInterval(iv);
    }, 200);

    // Auto-fill KPI once after load (safe, tiny JSON)
    setTimeout(()=>{ loadSummaryAndFill(); }, 600);

  }catch(e){
    console.error("[VSP][FILL_MAIN_V1C] fatal", e);
  }
})();
/* ===================== /VSP_P0_DASH_FILL_MAIN_KPI_TOPFIND_V1C ===================== */




/* ===================== VSP_P0_DASH_WIRE_MAIN_TOPFIND_V1D =====================
   Hard-wire "Load top findings" button -> render into MAIN Top findings table
   by matching table header text (Severity/Tool/Title/Location).
*/
(()=> {
  try{
    if (window.__VSP_P0_DASH_WIRE_MAIN_TOPFIND_V1D) return;
    window.__VSP_P0_DASH_WIRE_MAIN_TOPFIND_V1D = true;

    const log=(...a)=>console.log("[VSP][WIRE_TOPFIND_V1D]",...a);
    const esc=s=>String(s??"").replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));

    function findMainTopTable(){
      const tables = Array.from(document.querySelectorAll("table"));
      for (const t of tables){
        const txt = (t.textContent||"").toLowerCase();
        if (txt.includes("severity") && txt.includes("tool") && txt.includes("title") && (txt.includes("location") || txt.includes("loc"))){
          return t;
        }
      }
      // fallback: table inside section containing "Top findings"
      const nodes = Array.from(document.querySelectorAll("h1,h2,h3,h4,div,span,strong,b"));
      for (const n of nodes){
        const tt=(n.textContent||"").toLowerCase();
        if (tt.includes("top findings")){
          let root=n;
          for (let i=0;i<12 && root && root.parentElement;i++){
            root=root.parentElement;
            const t=root.querySelector && root.querySelector("table");
            if (t) return t;
          }
        }
      }
      return null;
    }

    function getTbody(table){
      if (!table) return null;
      let tb = table.querySelector("tbody");
      if (!tb){
        tb = document.createElement("tbody");
        table.appendChild(tb);
      }
      return tb;
    }

    function renderMain(items){
      const table = findMainTopTable();
      const tbody = getTbody(table);
      if (!tbody){
        log("no main top table found");
        return false;
      }
      if (!Array.isArray(items) || items.length===0){
        tbody.innerHTML = '<tr><td colspan="4" style="padding:10px;opacity:.75">No items</td></tr>';
        return true;
      }
      tbody.innerHTML = items.map(it=>{
        const sev=esc(it.severity||"");
        const tool=esc(it.tool||"");
        const title=esc(it.title||"");
        const loc=esc((it.file||"") + (it.line?(":"+it.line):""));
        return `<tr>
          <td style="padding:10px;border-top:1px solid rgba(255,255,255,.06)">${sev}</td>
          <td style="padding:10px;border-top:1px solid rgba(255,255,255,.06)">${tool}</td>
          <td style="padding:10px;border-top:1px solid rgba(255,255,255,.06)">${title}</td>
          <td style="padding:10px;border-top:1px solid rgba(255,255,255,.06);font-family:ui-monospace,Menlo,Consolas,monospace">${loc}</td>
        </tr>`;
      }).join("");
      return true;
    }

    async function getRid(){
      const ridEl = document.getElementById("vsp_ms_rid");
      const rid = ridEl ? (ridEl.textContent||"").trim() : "";
      if (rid) return rid;
      const res = await fetch("/api/vsp/rid_latest_gate_root", {cache:"no-store"});
      const j = await res.json();
      return j && j.rid ? String(j.rid) : "";
    }

    async function loadAndRender(limit=25){
      const rid = await getRid();
      if (!rid){ log("no rid"); return; }
      const url = `/api/vsp/top_findings_v4?rid=${encodeURIComponent(rid)}&limit=${encodeURIComponent(limit)}`;
      log("fetch", url);
      const res = await fetch(url, {cache:"no-store"});
      const j = await res.json();
      if (j && j.ok){
        renderMain(j.items||[]);
        log("render ok", {n:(j.items||[]).length, rid, source:j.source});
      }else{
        log("render not ok", j);
      }
    }

    function bindButtons(){
      const btns = Array.from(document.querySelectorAll("button,[role='button']"));
      let bound=0;
      for (const b of btns){
        const t=(b.textContent||"").toLowerCase().trim();
        if (!t.includes("load top findings")) continue;
        if (b.__vsp_wire_v1d) continue;
        b.__vsp_wire_v1d = true;
        b.addEventListener("click", (e)=>{ e.preventDefault(); loadAndRender(25); });
        bound++;
      }
      log("bound buttons", bound);
    }

    // bind once after DOM ready (no loops)
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", bindButtons, {once:true});
    } else {
      bindButtons();
    }

  }catch(e){
    console.error("[VSP][WIRE_TOPFIND_V1D] fatal", e);
  }
})();
/* ===================== /VSP_P0_DASH_WIRE_MAIN_TOPFIND_V1D ===================== */




/* ===================== VSP_P0_TOPFIND_INJECT_MAIN_PANEL_V1E =====================
   Guarantee Top findings renders in MAIN panel by injecting our own table into
   the "Top findings" section (no dependency on existing DOM/table structure).
*/
(()=> {
  try{
    if (window.__VSP_P0_TOPFIND_INJECT_MAIN_PANEL_V1E) return;
    window.__VSP_P0_TOPFIND_INJECT_MAIN_PANEL_V1E = true;

    const log=(...a)=>console.log("[VSP][TOPFIND_INJECT_V1E]",...a);
    const esc=s=>String(s??"").replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));

    function findTopFindingsSection(){
      const needles=["top findings (sample)","top findings"];
      const els = Array.from(document.querySelectorAll("h1,h2,h3,h4,div,span,strong,b,p"));
      for (const el of els){
        const t=(el.textContent||"").toLowerCase().trim();
        if (!t) continue;
        if (!needles.some(n=>t.includes(n))) continue;
        // climb to a container that likely is the section card
        let cur=el;
        for (let i=0;i<10 && cur && cur.parentElement;i++){
          cur=cur.parentElement;
          // heuristic: section should contain the headings "Severity Tool Title"
          const tx=(cur.textContent||"").toLowerCase();
          if (tx.includes("severity") && tx.includes("tool") && tx.includes("title")) return cur;
        }
      }
      return null;
    }

    function ensureInjectedUI(){
      const sec = findTopFindingsSection();
      if (!sec){ log("no section found"); return null; }

      let box = sec.querySelector("#vsp_topfind_live_box_v1e");
      if (box) return box;

      box = document.createElement("div");
      box.id = "vsp_topfind_live_box_v1e";
      box.style.marginTop = "10px";
      box.style.padding = "10px";
      box.style.border = "1px solid rgba(255,255,255,.08)";
      box.style.borderRadius = "12px";
      box.style.background = "rgba(10,14,26,.35)";

      box.innerHTML = `
        <div style="display:flex;align-items:center;gap:10px;justify-content:space-between;">
          <div style="font-weight:600">Top findings (live)</div>
          <div id="vsp_topfind_live_status_v1e" style="opacity:.75;font-size:12px">Idle</div>
        </div>
        <div style="overflow:auto;margin-top:8px">
          <table style="width:100%;border-collapse:collapse;font-size:12px">
            <thead>
              <tr style="opacity:.85">
                <th style="text-align:left;padding:8px;border-bottom:1px solid rgba(255,255,255,.08)">Severity</th>
                <th style="text-align:left;padding:8px;border-bottom:1px solid rgba(255,255,255,.08)">Tool</th>
                <th style="text-align:left;padding:8px;border-bottom:1px solid rgba(255,255,255,.08)">Title</th>
                <th style="text-align:left;padding:8px;border-bottom:1px solid rgba(255,255,255,.08)">Location</th>
              </tr>
            </thead>
            <tbody id="vsp_topfind_live_tbody_v1e">
              <tr><td colspan="4" style="padding:10px;opacity:.75">Not loaded</td></tr>
            </tbody>
          </table>
        </div>
      `;

      // insert near bottom of section
      sec.appendChild(box);
      log("injected live box ok");
      return box;
    }

    function setStatus(msg){
      const el=document.getElementById("vsp_topfind_live_status_v1e");
      if (el) el.textContent = msg;
    }

    function render(items){
      const tb=document.getElementById("vsp_topfind_live_tbody_v1e");
      if (!tb) return;
      if (!Array.isArray(items) || items.length===0){
        tb.innerHTML = '<tr><td colspan="4" style="padding:10px;opacity:.75">No items</td></tr>';
        return;
      }
      tb.innerHTML = items.map(it=>{
        const sev=esc(it.severity||"");
        const tool=esc(it.tool||"");
        const title=esc(it.title||"");
        const loc=esc((it.file||"") + (it.line?(":"+it.line):""));
        return `<tr>
          <td style="padding:8px;border-top:1px solid rgba(255,255,255,.06)">${sev}</td>
          <td style="padding:8px;border-top:1px solid rgba(255,255,255,.06)">${tool}</td>
          <td style="padding:8px;border-top:1px solid rgba(255,255,255,.06)">${title}</td>
          <td style="padding:8px;border-top:1px solid rgba(255,255,255,.06);font-family:ui-monospace,Menlo,Consolas,monospace">${loc}</td>
        </tr>`;
      }).join("");
    }

    async function getRid(){
      // try MIN_STABLE label first if exists
      const ridEl = document.getElementById("vsp_ms_rid");
      const rid = ridEl ? (ridEl.textContent||"").trim() : "";
      if (rid) return rid;
      const res = await fetch("/api/vsp/rid_latest_gate_root", {cache:"no-store"});
      const j = await res.json();
      return j && j.rid ? String(j.rid) : "";
    }

    async function load(limit=25){
      ensureInjectedUI();
      setStatus("Loading…");
      const rid = await getRid();
      if (!rid){ setStatus("No RID"); return; }
      const url = `/api/vsp/top_findings_v4?rid=${encodeURIComponent(rid)}&limit=${encodeURIComponent(limit)}`;
      log("fetch", url);
      const res = await fetch(url, {cache:"no-store"});
      const j = await res.json();
      if (!j || !j.ok){
        setStatus(`No data (${(j&&j.err)||"err"})`);
        log("no data", j);
        render([]);
        return;
      }
      render(Array.isArray(j.items)?j.items:[]);
      setStatus(`Loaded ${(j.items||[]).length} • ${j.source||"v4"} • ${rid}`);
      log("render ok", {n:(j.items||[]).length, rid, source:j.source});
    }

    function bind(){
      // bind all "Load top findings" buttons
      const btns = Array.from(document.querySelectorAll("button,[role='button']"));
      let bound=0;
      for (const b of btns){
        const t=(b.textContent||"").toLowerCase().trim();
        if (!t.includes("load top findings")) continue;
        if (b.__vsp_inject_v1e) continue;
        b.__vsp_inject_v1e = true;
        b.addEventListener("click", (e)=>{ e.preventDefault(); load(25); }, {capture:true});
        bound++;
      }
      log("bound buttons", bound);
    }

    function boot(){
      ensureInjectedUI();
      bind();
      // do NOT auto-load (commercial safe). user click triggers load.
      log("boot ok");
    }

    if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", boot, {once:true});
    else boot();

  }catch(e){
    console.error("[VSP][TOPFIND_INJECT_V1E] fatal", e);
  }
})();
/* ===================== /VSP_P0_TOPFIND_INJECT_MAIN_PANEL_V1E ===================== */



/* ===================== VSP_P0_DASH_RELEASEDL_BTN_V1 ===================== */
(()=> {
  try{
    const onlyOnDash = () => {
      const pn = (location && location.pathname) ? location.pathname : "";
      // Dashboard route in your UI is /vsp5 (keep it strict to avoid touching other tabs)
      if (pn !== "/vsp5") return false;
      return true;
    };

    const ensure = () => {
      if (!onlyOnDash()) return;
      if (window.__vsp_release_dl_btn_v1) return;
      window.__vsp_release_dl_btn_v1 = true;

      const wrap = document.createElement("div");
      wrap.id = "vsp_release_dl_wrap_v1";
      wrap.style.cssText = [
        "position:fixed",
        "right:16px",
        "bottom:16px",
        "z-index:99999",
        "display:flex",
        "align-items:center",
        "gap:10px",
        "padding:10px 12px",
        "border-radius:14px",
        "background:rgba(10,16,32,.92)",
        "border:1px solid rgba(255,255,255,.10)",
        "box-shadow:0 10px 30px rgba(0,0,0,.45)",
        "backdrop-filter: blur(6px)",
        "font: 12px/1.35 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial",
        "color:rgba(255,255,255,.92)"
      ].join(";");

      const label = document.createElement("div");
      label.innerHTML = `<div style="font-weight:700;letter-spacing:.2px">Release</div>
                         <div id="vsp_release_dl_status_v1" style="opacity:.78;margin-top:2px">ready</div>`;

      const btn = document.createElement("button");
      btn.type = "button";
      btn.id = "vsp_release_dl_btn_v1";
      btn.textContent = "Download latest package";
      btn.style.cssText = [
        "cursor:pointer",
        "border:1px solid rgba(255,255,255,.14)",
        "background:rgba(255,255,255,.06)",
        "color:rgba(255,255,255,.92)",
        "padding:9px 12px",
        "border-radius:12px",
        "font-weight:700",
        "letter-spacing:.15px"
      ].join(";");

      const st = () => document.getElementById("vsp_release_dl_status_v1");
      const setStatus = (t)=>{ const el = st(); if (el) el.textContent = t || ""; };

      async function fetchLatest(){
        setStatus("checking…");
        const res = await fetch("/api/vsp/release_latest", { cache:"no-store" });
        let j = null;
        try{ j = await res.json(); }catch(e){ j = { ok:false, err:"bad json" }; }
        if (!j || !j.ok) {
          setStatus("no release");
          console.warn("[VSP][RELEASEDL_BTN_V1] no release:", j);
          return null;
        }
        setStatus(`ok • ${j.package_name || "package"}`);
        return j;
      }

      btn.addEventListener("click", async ()=>{
        try{
          btn.disabled = true;
          btn.style.opacity = "0.7";
          const j = await fetchLatest();
          const dl = j && j.download_url;
          if (!dl){
            setStatus("missing download_url");
            return;
          }
          setStatus("downloading…");
          window.location.href = dl;
        }catch(e){
          console.error("[VSP][RELEASEDL_BTN_V1] err", e);
          setStatus("error (console)");
        }finally{
          setTimeout(()=>{ btn.disabled = false; btn.style.opacity = "1"; }, 900);
        }
      });

      wrap.appendChild(label);
      wrap.appendChild(btn);
      document.body.appendChild(wrap);

      // prefetch once (non-blocking)
      setTimeout(()=>{ fetchLatest().catch(()=>{}); }, 400);
    };

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", ensure, { once:true });
    } else {
      ensure();
    }
  }catch(e){
    console.error("[VSP][RELEASEDL_BTN_V1] fatal", e);
  }
})();
/* ===================== /VSP_P0_DASH_RELEASEDL_BTN_V1 ===================== */



/* ===================== VSP_P0_DASH_TOPBAR_RELEASE_PRO_V1 ===================== */
(()=> {
  try{
    const onlyDash = () => (location && location.pathname === "/vsp5");
    if (!onlyDash()) return;

    const css = `
#vsp_cmdbar_v1{
  position:sticky; top:0; z-index:99998;
  margin: 10px 12px 8px 12px;
  padding: 10px 12px;
  border-radius: 16px;
  background: linear-gradient(180deg, rgba(11,18,34,.90), rgba(8,12,24,.86));
  border: 1px solid rgba(255,255,255,.10);
  box-shadow: 0 14px 36px rgba(0,0,0,.45);
  backdrop-filter: blur(7px);
  display:flex; align-items:center; justify-content:space-between; gap:12px;
  font: 12px/1.35 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial;
  color: rgba(255,255,255,.92);
}
#vsp_cmdbar_v1 .lhs{display:flex; align-items:center; gap:10px; min-width:260px;}
#vsp_cmdbar_v1 .brand{
  font-weight: 900; letter-spacing:.25px; font-size: 13px;
}
#vsp_cmdbar_v1 .chip{
  padding: 4px 8px; border-radius: 999px;
  border:1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.05);
  opacity:.95;
}
#vsp_cmdbar_v1 .mid{display:flex; align-items:center; gap:10px; flex:1; justify-content:center; min-width: 320px;}
#vsp_cmdbar_v1 .kv{display:flex; flex-direction:column; gap:2px; min-width: 280px;}
#vsp_cmdbar_v1 .k{opacity:.72; font-size: 11px;}
#vsp_cmdbar_v1 .v{font-weight:800; letter-spacing:.15px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
#vsp_cmdbar_v1 .rhs{display:flex; align-items:center; gap:8px;}
#vsp_cmdbar_v1 button{
  cursor:pointer;
  border:1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.06);
  color: rgba(255,255,255,.92);
  padding: 8px 10px;
  border-radius: 12px;
  font-weight: 800;
}
#vsp_cmdbar_v1 button:disabled{opacity:.55; cursor:not-allowed;}
#vsp_cmdbar_v1 .dot{
  width:10px; height:10px; border-radius:50%;
  background: rgba(255,255,255,.35);
  box-shadow: 0 0 0 4px rgba(255,255,255,.06);
  margin-right:4px;
}
#vsp_cmdbar_v1 .dot.ok{background:#24d17e; box-shadow:0 0 0 4px rgba(36,209,126,.12);}
#vsp_cmdbar_v1 .dot.warn{background:#f4b400; box-shadow:0 0 0 4px rgba(244,180,0,.12);}
#vsp_cmdbar_v1 .dot.err{background:#ff4d4f; box-shadow:0 0 0 4px rgba(255,77,79,.12);}
#vsp_cmdbar_v1 .mini{opacity:.76; font-weight:700;}
    `.trim();

    const ensureStyle = ()=>{
      if (document.getElementById("vsp_cmdbar_style_v1")) return;
      const st=document.createElement("style");
      st.id="vsp_cmdbar_style_v1";
      st.textContent=css;
      document.head.appendChild(st);
    };

    const humanBytes = (n)=>{
      if (!n && n!==0) return "";
      const u=["B","KB","MB","GB","TB"];
      let x=Number(n), i=0;
      while (x>=1024 && i<u.length-1){ x/=1024; i++; }
      return `${x.toFixed(i?1:0)} ${u[i]}`;
    };

    const pickAnchor = ()=>{
      const sels = [
        "#kpiRow",".kpi-row",".kpi-grid",".kpiGrid",
        "#vsp_kpis",".vsp-kpis",".vsp_top_cards",".vsp-top-cards",
        "main",".container",".page"
      ];
      for (const q of sels){
        const el=document.querySelector(q);
        if (el) return el;
      }
      return document.body;
    };

    const render = ()=>{
      if (!onlyDash()) return;
      if (document.getElementById("vsp_cmdbar_v1")) return;

      ensureStyle();

      const bar=document.createElement("div");
      bar.id="vsp_cmdbar_v1";
      bar.innerHTML = `
        <div class="lhs">
          <span class="dot" id="vsp_cmdbar_dot_v1"></span>
          <span class="brand">VSP • Dashboard</span>
          <span class="chip" id="vsp_cmdbar_env_v1">LIVE</span>
          <span class="mini" id="vsp_cmdbar_ts_v1">—</span>
        </div>

        <div class="mid">
          <div class="kv">
            <div class="k">Latest release</div>
            <div class="v" id="vsp_cmdbar_rel_v1">checking…</div>
          </div>
          <div class="kv" style="min-width:220px">
            <div class="k">Artifact</div>
            <div class="v" id="vsp_cmdbar_art_v1">—</div>
          </div>
        </div>

        <div class="rhs">
          <button id="vsp_cmdbar_btn_refresh_v1" title="Refresh release info">Refresh</button>
          <button id="vsp_cmdbar_btn_audit_v1" title="Open audit link (if available)">Audit</button>
          <button id="vsp_cmdbar_btn_dl_v1" title="Download latest package">Download</button>
        </div>
      `;

      // insert near top of dashboard layout
      const anchor = pickAnchor();
      const parent = anchor.parentElement || document.body;
      try{
        parent.insertBefore(bar, anchor);
      }catch(e){
        document.body.prepend(bar);
      }

      const $ = (id)=>document.getElementById(id);
      const dot = $("vsp_cmdbar_dot_v1");
      const rel = $("vsp_cmdbar_rel_v1");
      const art = $("vsp_cmdbar_art_v1");
      const ts  = $("vsp_cmdbar_ts_v1");
      const bR  = $("vsp_cmdbar_btn_refresh_v1");
      const bA  = $("vsp_cmdbar_btn_audit_v1");
      const bD  = $("vsp_cmdbar_btn_dl_v1");

      let last = null;

      const setDot = (mode)=>{
        dot.className = "dot " + (mode||"");
      };

      const tickTs = ()=>{
        const d=new Date();
        ts.textContent = d.toLocaleString();
      };
      tickTs(); setInterval(tickTs, 15000);

      async function load(){
        try{
          setDot("warn");
          rel.textContent = "checking…";
          art.textContent = "—";
          bD.disabled = true; bA.disabled = true;

          const res = await fetch("/api/vsp/release_latest", { cache:"no-store" });
          const j = await res.json();
          last = j;

          if (!j || !j.ok){
            setDot("err");
            rel.textContent = "no release";
            art.textContent = (j && j.err) ? String(j.err) : "—";
            return;
          }

          setDot("ok");

          const pn = j.package_name || "package";
          const sha = (j.sha256 || j.sha || "").toString();
          const shaShort = sha ? (sha.slice(0,8) + "…") : "";
          const size = j.size_bytes || j.size || j.bytes || null;

          rel.textContent = `${pn}${shaShort ? " • " + shaShort : ""}`;
          art.textContent = `${size ? humanBytes(size) : "artifact ready"}${j.release_ts ? " • " + j.release_ts : ""}`;

          bD.disabled = !j.download_url;
          bA.disabled = !j.audit_url;

        }catch(e){
          console.error("[VSP_CMD_BAR_V1] load err", e);
          setDot("err");
          rel.textContent = "error (see console)";
          art.textContent = "release_latest failed";
        }
      }

      bR.addEventListener("click", async ()=>{
        bR.disabled = true;
        try{ await load(); } finally { setTimeout(()=>bR.disabled=false, 450); }
      });

      bD.addEventListener("click", ()=>{
        if (!last || !last.download_url) return;
        window.location.href = last.download_url;
      });

      bA.addEventListener("click", ()=>{
        if (!last || !last.audit_url) return;
        window.open(last.audit_url, "_blank", "noopener,noreferrer");
      });

      // initial + periodic refresh
      load();
      setInterval(()=>{ if (onlyDash()) load(); }, 60000);
    };

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", render, { once:true });
    } else {
      render();
    }

  }catch(e){
    console.error("[VSP_CMD_BAR_V1] fatal", e);
  }
})();
/* ===================== /VSP_P0_DASH_TOPBAR_RELEASE_PRO_V1 ===================== */






/* ===================== VSP_P1_DASH_UNIFY_RELEASE_TOOLBADGES_V1 ===================== */
(()=> {
  try{
    if (!(location && location.pathname === "/vsp5")) return;

    const TOOLS = ["Bandit","Semgrep","Gitleaks","KICS","Trivy","Syft","Grype","CodeQL"];

    const css = `
#vsp_toollane_badges_v1{
  display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:center;
  padding: 6px 0 0 0;
  font: 12px/1.35 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial;
  color: rgba(255,255,255,.92);
}
#vsp_toollane_badges_v1 .lbl{opacity:.72; font-weight:900; margin-right:4px}
.vsp_tbadge_v1{
  display:inline-flex; gap:6px; align-items:center;
  padding:6px 8px; border-radius:999px;
  border:1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.05);
  font: 11px/1.2 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial;
  color: rgba(255,255,255,.92);
  cursor:pointer;
}
.vsp_tbadge_v1 .d{width:8px;height:8px;border-radius:50%;background:rgba(255,255,255,.30);box-shadow:0 0 0 3px rgba(255,255,255,.06)}
.vsp_tbadge_v1.ok  .d{background:#24d17e; box-shadow:0 0 0 3px rgba(36,209,126,.12)}
.vsp_tbadge_v1.warn .d{background:#f4b400; box-shadow:0 0 0 3px rgba(244,180,0,.12)}
.vsp_tbadge_v1.err .d{background:#ff4d4f; box-shadow:0 0 0 3px rgba(255,77,79,.12)}

#vsp_toollane_modal_v1{
  position:fixed; inset:0; z-index:100000;
  background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center;
}
#vsp_toollane_modal_v1 .card{
  width:min(920px, 92vw); max-height:82vh; overflow:auto;
  border-radius:16px;
  background:rgba(10,16,32,.96);
  border:1px solid rgba(255,255,255,.12);
  box-shadow:0 18px 55px rgba(0,0,0,.55);
  padding:14px;
  color:rgba(255,255,255,.92);
  font:12px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial;
}
#vsp_toollane_modal_v1 .top{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:8px}
#vsp_toollane_modal_v1 .ttl{font-weight:900;letter-spacing:.2px}
#vsp_toollane_modal_v1 button{
  cursor:pointer;border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.06); color:rgba(255,255,255,.92);
  padding:7px 10px;border-radius:12px;font-weight:800;
}
pre.vsp_pre_v1{
  margin:0; padding:10px; border-radius:12px;
  background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.10);
  overflow:auto;
}
    `.trim();

    const ensureStyle = ()=>{
      if (document.getElementById("vsp_toollane_style_v1")) return;
      const st=document.createElement("style");
      st.id="vsp_toollane_style_v1";
      st.textContent=css;
      document.head.appendChild(st);
    };

    const hideOldReleaseBox = ()=>{
      const el = document.getElementById("vsp_release_dl_wrap_v1");
      if (el) el.style.display = "none";
    };

    // RID sanitize
    const isRid = (v)=>{
      if (!v) return false;
      v = String(v).trim();
      if (v.length < 6 || v.length > 80) return false;
      if (/\s/.test(v)) return false;
      if (!/^[A-Za-z0-9][A-Za-z0-9_.:-]+$/.test(v)) return false;
      if (!/\d/.test(v)) return false;
      return true;
    };
    const short = (v)=>{
      v = String(v||"");
      if (v.length <= 28) return v;
      return v.slice(0,16) + "…" + v.slice(-8);
    };

    // fetch hook capture RID from real traffic
    const hookFetchRid = ()=>{
      if (window.__vsp_fetch_rid_hooked_v1) return;
      window.__vsp_fetch_rid_hooked_v1 = true;
      const orig = window.fetch;
      window.fetch = async function(input, init){
        try{
          const url = (typeof input === "string") ? input : (input && input.url) ? input.url : "";
          if (url && url.includes("/api/vsp/run_file") && url.includes("rid=")){
            const u = new URL(url, location.origin);
            const rid = (u.searchParams.get("rid") || "").trim();
            if (isRid(rid)) window.__vsp_last_rid_v1 = rid;
          }
        }catch(e){}
        return orig.apply(this, arguments);
      };
    };

    const getPinnedRid = ()=>{
      const keys = ["vsp5_pin_rid","vsp_pin_rid","VSP_PIN_RID","vsp5.rid.pinned","vsp_last_rid","vsp5_last_rid"];
      for (const k of keys){
        const v = (localStorage.getItem(k) || "").trim();
        if (isRid(v)) return v;
      }
      return "";
    };

    const getRidFromDom = ()=>{
      const direct = document.querySelector("#rid,#rid_input,#vsp_rid,#vsp5_rid,[data-rid],[name='rid'],.rid");
      if (direct){
        const v = (direct.value || direct.textContent || "").trim();
        if (isRid(v)) return v;
      }
      const sels = Array.from(document.querySelectorAll("select"));
      for (const sel of sels){
        const v = String(sel.value || "").trim();
        if (isRid(v)) return v;
        const opt = sel.querySelector("option:checked");
        if (opt){
          const ov = String(opt.value || opt.textContent || "").trim();
          if (isRid(ov)) return ov;
        }
      }
      return "";
    };

    const getRidFromApi = async ()=>{
      try{
        const r = await fetch("/api/vsp/rid_latest", { cache:"no-store" });
        const j = await r.json();
        const rid = (j && (j.rid || j.RID || (j.data && j.data.rid))) || "";
        const v = String(rid || "").trim();
        return isRid(v) ? v : "";
      }catch(e){
        return "";
      }
    };

    const getRid = async ()=>{
      const w = (window.__vsp_last_rid_v1 || "").trim();
      if (isRid(w)) return w;
      let rid = getRidFromDom();
      if (!rid) rid = getPinnedRid();
      if (!rid) rid = await getRidFromApi();
      return rid;
    };

    const fetchGateSummary = async (rid)=>{
      const url = `/api/vsp/run_gate_summary_v1?rid=${encodeURIComponent(rid)}`;
      const r = await fetch(url, { cache:"no-store" });
      return await r.json();
    };

    const classify = (o)=>{
      if (!o || typeof o !== "object") return "err";
      if (o.missing || o.is_missing) return "err";
      if (o.degraded || o.is_degraded || o.status === "degraded") return "warn";
      if (o.ok === true || o.status === "ok") return "ok";
      return "warn";
    };

    const ensureModal = ()=>{
      if (document.getElementById("vsp_toollane_modal_v1")) return;
      const m=document.createElement("div");
      m.id="vsp_toollane_modal_v1";
      m.innerHTML = `
        <div class="card">
          <div class="top">
            <div class="ttl" id="vsp_toollane_modal_ttl_v1">Tool details</div>
            <button id="vsp_toollane_modal_close_v1">Close</button>
          </div>
          <pre class="vsp_pre_v1" id="vsp_toollane_modal_pre_v1">{}</pre>
        </div>
      `;
      document.body.appendChild(m);
      m.addEventListener("click",(e)=>{ if (e.target===m) m.style.display="none"; });
      document.getElementById("vsp_toollane_modal_close_v1").addEventListener("click",()=>{ m.style.display="none"; });
    };

    const showModal = (title, obj)=>{
      ensureModal();
      const m=document.getElementById("vsp_toollane_modal_v1");
      document.getElementById("vsp_toollane_modal_ttl_v1").textContent = title;
      document.getElementById("vsp_toollane_modal_pre_v1").textContent = JSON.stringify(obj || {}, null, 2);
      m.style.display="flex";
    };

    const getToolObj = (by, toolName)=>{
      if (!by || typeof by !== "object") return null;
      const tn = toolName.toLowerCase();
      for (const k of Object.keys(by)){
        if (k.toLowerCase() === tn) return by[k];
      }
      return by[toolName] || null;
    };

    const attachBadgesIntoCmdbar = ()=>{
      const cmd = document.getElementById("vsp_cmdbar_v1");
      if (!cmd) return false;

      // Make cmdbar support 2-row layout
      cmd.style.flexWrap = "wrap";

      let wrap = document.getElementById("vsp_toollane_badges_v1");
      if (!wrap){
        ensureStyle();
        hideOldReleaseBox();
        wrap = document.createElement("div");
        wrap.id = "vsp_toollane_badges_v1";
        // full width row inside cmdbar
        wrap.style.flex = "0 0 100%";
        wrap.style.width = "100%";
        cmd.appendChild(wrap);
      }else{
        // ensure it is inside cmdbar (not afterend)
        if (wrap.parentElement !== cmd){
          wrap.remove();
          wrap.style.flex = "0 0 100%";
          wrap.style.width = "100%";
          cmd.appendChild(wrap);
        }
      }
      return true;
    };

    const renderBadges = async ()=>{
      if (!attachBadgesIntoCmdbar()) return;

      const wrap = document.getElementById("vsp_toollane_badges_v1");
      if (!wrap) return;

      wrap.innerHTML = `<span class="lbl">Tool lane</span><span style="opacity:.65">loading…</span>`;

      const rid = await getRid();
      if (!rid){
        wrap.innerHTML = `<span class="lbl">Tool lane</span><span style="opacity:.65">RID not ready</span>`;
        return;
      }

      let gs=null;
      try{
        gs = await fetchGateSummary(rid);
      }catch(e){
        wrap.innerHTML = `<span class="lbl">Tool lane</span><span style="opacity:.65">(RID ${short(rid)}) fetch failed</span>`;
        return;
      }

      const by = (gs && (gs.by_tool || gs.tools || gs.byTool)) || {};
      wrap.innerHTML = `<span class="lbl">Tool lane</span><span style="opacity:.60">(RID ${short(rid)})</span>`;

      for (const t of TOOLS){
        const obj = getToolObj(by, t);
        const st = classify(obj);
        const b=document.createElement("span");
        b.className = `vsp_tbadge_v1 ${st}`;
        b.innerHTML = `<span class="d"></span><span style="font-weight:900">${t}</span>`;
        b.title = "Click to view tool detail";
        b.addEventListener("click", ()=> showModal(`${t} • ${rid}`, obj || {}));
        wrap.appendChild(b);
      }
    };

    const boot = ()=>{
      if (!(location && location.pathname === "/vsp5")) return;
      hookFetchRid();

      let n=0;
      const timer = setInterval(()=>{
        n++;
        hideOldReleaseBox();
        const hasCmd = !!document.getElementById("vsp_cmdbar_v1");
        if (hasCmd){
          clearInterval(timer);
          renderBadges();
          setInterval(()=>{ hideOldReleaseBox(); renderBadges(); }, 60000);
        }
        if (n>120) clearInterval(timer);
      }, 250);
    };

    if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", boot, {once:true});
    else boot();

  }catch(e){
    console.error("[VSP_TOOLBADGES_V1] fatal", e);
  }
})();
/* ===================== /VSP_P1_DASH_UNIFY_RELEASE_TOOLBADGES_V1 ===================== */






/* ===================== VSP_P1_DASH_AUTOLATEST_AUTOREFRESH_GATECHIP_V1 ===================== */
(()=> {
  try{
    if (!(location && location.pathname === "/vsp5")) return;

    const css = `
#vsp_gatechip_v1{
  display:inline-flex; align-items:center; gap:6px;
  padding:4px 8px; border-radius:999px;
  border:1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.05);
  font-weight:900; letter-spacing:.2px;
}
#vsp_gatechip_v1 .d{width:8px;height:8px;border-radius:50%;background:rgba(255,255,255,.35);box-shadow:0 0 0 3px rgba(255,255,255,.06)}
#vsp_gatechip_v1.pass .d{background:#24d17e; box-shadow:0 0 0 3px rgba(36,209,126,.12)}
#vsp_gatechip_v1.fail .d{background:#ff4d4f; box-shadow:0 0 0 3px rgba(255,77,79,.12)}
#vsp_gatechip_v1.deg  .d{background:#f4b400; box-shadow:0 0 0 3px rgba(244,180,0,.12)}
#vsp_gatechip_v1 .t{opacity:.92}
#vsp_gatechip_v1 .s{opacity:.72; font-weight:800}
    `.trim();

    const ensureStyle = ()=>{
      if (document.getElementById("vsp_gatechip_style_v1")) return;
      const st=document.createElement("style");
      st.id="vsp_gatechip_style_v1";
      st.textContent=css;
      document.head.appendChild(st);
    };

    const isRid = (v)=>{
      if (!v) return false;
      v = String(v).trim();
      if (v.length < 6 || v.length > 80) return false;
      if (/\s/.test(v)) return false;
      if (!/^[A-Za-z0-9][A-Za-z0-9_.:-]+$/.test(v)) return false;
      if (!/\d/.test(v)) return false;
      return true;
    };

    const short = (v)=>{
      v = String(v||"");
      if (v.length <= 28) return v;
      return v.slice(0,16) + "…" + v.slice(-8);
    };

    // best-effort: use existing rid_latest if server has it; fallback to localStorage last rid
    const getRidLatest = async ()=>{
      try{
        const r = await fetch("/api/vsp/rid_latest", { cache:"no-store" });
        const j = await r.json();
        const rid = (j && (j.rid || j.RID || (j.data && j.data.rid))) || "";
        const v = String(rid||"").trim();
        return isRid(v) ? v : "";
      }catch(e){ return ""; }
    };

    const setPinnedRid = (rid)=>{
      if (!isRid(rid)) return;
      // write a couple of likely keys so your existing UI picks it up
      try{ localStorage.setItem("vsp5_pin_rid", rid); }catch(e){}
      try{ localStorage.setItem("vsp_pin_rid", rid); }catch(e){}
      try{ localStorage.setItem("VSP_PIN_RID", rid); }catch(e){}
      try{ localStorage.setItem("vsp5.rid.pinned", rid); }catch(e){}
      try{ localStorage.setItem("vsp5_last_rid", rid); }catch(e){}
    };

    const ensureGateChip = ()=>{
      const cmd = document.getElementById("vsp_cmdbar_v1");
      if (!cmd) return null;
      ensureStyle();
      if (document.getElementById("vsp_gatechip_v1")) return document.getElementById("vsp_gatechip_v1");

      // place chip near left side next to env
      const lhs = cmd.querySelector(".lhs") || cmd;
      const chip = document.createElement("span");
      chip.id = "vsp_gatechip_v1";
      chip.className = "";
      chip.innerHTML = `<span class="d"></span><span class="t">GATE</span><span class="s" id="vsp_gatechip_txt_v1">—</span>`;
      lhs.appendChild(chip);
      return chip;
    };

    const setGate = (mode, text)=>{
      const chip = ensureGateChip();
      if (!chip) return;
      chip.classList.remove("pass","fail","deg");
      if (mode) chip.classList.add(mode);
      const t = document.getElementById("vsp_gatechip_txt_v1");
      if (t) t.textContent = text || "—";
    };

    const fetchGate = async (rid)=>{
      // prefer run_gate.json (overall verdict), fallback to 
      const u1 = `/api/vsp/dashboard_v3?rid=${encodeURIComponent(rid)}`;
      const u2 = `/api/vsp/run_gate_summary_v1?rid=${encodeURIComponent(rid)}`;
      let j=null;
      try{
        const r = await fetch(u1, {cache:"no-store"});
        j = await r.json();
        if (j && j.ok !== False && j.ok !== false) return {src:"gate_json", j};
      }catch(e){}
      try{
        const r = await fetch(u2, {cache:"no-store"});
        j = await r.json();
        return {src:"gate_summary", j};
      }catch(e){}
      return {src:"", j:null};
    };

    const computeGateText = (obj)=>{
      // be conservative: parse common fields
      if (!obj) return {mode:"deg", txt:"UNKNOWN"};
      const j = obj;
      const overall = j.overall || j.verdict || j.status || (j.gate && j.gate.overall) || "";
      const degraded = j.degraded || j.is_degraded || (j.gate && j.gate.degraded) || false;
      const pass = (overall && String(overall).toLowerCase().includes("pass")) || (j.pass === true) || (j.ok === true);
      const fail = (overall && String(overall).toLowerCase().includes("fail")) || (j.fail === true);

      if (fail) return {mode:"fail", txt:"FAIL"};
      if (pass && degraded) return {mode:"deg", txt:"PASS (DEG)"};
      if (pass) return {mode:"pass", txt:"PASS"};
      if (degraded) return {mode:"deg", txt:"DEGRADED"};
      return {mode:"deg", txt:String(overall || "UNKNOWN").toUpperCase().slice(0,18)};
    };

    const clickIfExists = (text)=>{
      const btns = Array.from(document.querySelectorAll("button"));
      const b = btns.find(x => (x.textContent||"").trim().toLowerCase() === text.toLowerCase());
      if (b) { try{ b.click(); return true; }catch(e){} }
      return false;
    };

    // Try to trigger existing dashboard refresh flow (so KPIs update)
    const refreshDashboard = ()=>{
      // Your UI has Refresh / Pin RID buttons; best-effort click Refresh
      if (clickIfExists("Refresh")) return true;
      return false;
    };

    const autoLoop = async ()=>{
      // 1) auto-pick latest RID if available
      const rid = await getRidLatest();
      if (isRid(rid)) setPinnedRid(rid);

      // 2) trigger existing refresh (KPIs/top findings state)
      refreshDashboard();

      // 3) compute gate chip based on latest rid if we have it
      const rid2 = rid || (window.__vsp_last_rid_v1 || "") || "";
      const rid_use = isRid(rid2) ? rid2 : "";
      if (rid_use){
        const {j} = await fetchGate(rid_use);
        const g = computeGateText(j);
        setGate(g.mode, g.txt);
      }else{
        setGate("deg", "RID?");
      }
    };

    const boot = ()=>{
      if (!(location && location.pathname === "/vsp5")) return;
      // wait for cmdbar then attach
      let n=0;
      const t = setInterval(()=>{
        n++;
        if (document.getElementById("vsp_cmdbar_v1")){
          clearInterval(t);
          autoLoop();
          // light polling: 60s
          setInterval(autoLoop, 60000);
        }
        if (n>120) clearInterval(t);
      }, 250);
    };

    if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", boot, {once:true});
    else boot();

  }catch(e){
    console.error("[VSP_AUTOREFRESH_V1] fatal", e);
  }
})();
/* ===================== /VSP_P1_DASH_AUTOLATEST_AUTOREFRESH_GATECHIP_V1 ===================== */



/* ===================== VSP_P1_DASH_GATE_STORY_AUTOTOP25_V1 ===================== */
(()=> {
  try{
    if (!(location && location.pathname === "/vsp5")) return;

    const css = `
#vsp_gatestory_v1{
  margin: 10px 12px 10px 12px;
  border-radius: 16px;
  background: rgba(255,255,255,.03);
  border: 1px solid rgba(255,255,255,.10);
  box-shadow: 0 14px 36px rgba(0,0,0,.25);
  padding: 10px 12px;
  color: rgba(255,255,255,.92);
  font: 12px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial;
}
#vsp_gatestory_v1 .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
#vsp_gatestory_v1 .ttl{font-weight:900;letter-spacing:.2px}
#vsp_gatestory_v1 .chip{
  display:inline-flex;gap:6px;align-items:center;
  padding:4px 8px;border-radius:999px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.05);
  font-weight:900;
}
#vsp_gatestory_v1 .dot{width:8px;height:8px;border-radius:50%;background:rgba(255,255,255,.35);box-shadow:0 0 0 3px rgba(255,255,255,.06)}
#vsp_gatestory_v1 .pass .dot{background:#24d17e; box-shadow:0 0 0 3px rgba(36,209,126,.12)}
#vsp_gatestory_v1 .fail .dot{background:#ff4d4f; box-shadow:0 0 0 3px rgba(255,77,79,.12)}
#vsp_gatestory_v1 .deg  .dot{background:#f4b400; box-shadow:0 0 0 3px rgba(244,180,0,.12)}
#vsp_gatestory_v1 .muted{opacity:.72}
#vsp_gatestory_v1 a{color:rgba(255,255,255,.88); text-decoration:none}
#vsp_gatestory_v1 a:hover{text-decoration:underline}
    `.trim();

    const ensureStyle = ()=>{
      if (document.getElementById("vsp_gatestory_style_v1")) return;
      const st=document.createElement("style");
      st.id="vsp_gatestory_style_v1";
      st.textContent=css;
      document.head.appendChild(st);
    };

    const isRid = (v)=>{
      if (!v) return false;
      v = String(v).trim();
      if (v.length < 6 || v.length > 80) return false;
      if (/\s/.test(v)) return false;
      if (!/^[A-Za-z0-9][A-Za-z0-9_.:-]+$/.test(v)) return false;
      if (!/\d/.test(v)) return false;
      return true;
    };

    const getRid = ()=>{
      const v = (window.__vsp_last_rid_v1 || "").trim();
      return isRid(v) ? v : "";
    };

    const pickAnchor = ()=>{
      // put below cmdbar if exists, else top of body
      const cmd = document.getElementById("vsp_cmdbar_v1");
      if (cmd) return cmd;
      return document.body;
    };

    const ensurePanel = ()=>{
      ensureStyle();
      if (document.getElementById("vsp_gatestory_v1")) return document.getElementById("vsp_gatestory_v1");
      const a = pickAnchor();
      const p = document.createElement("div");
      p.id="vsp_gatestory_v1";
      p.innerHTML = `
        <div class="row">
          <div class="ttl">Gate story</div>
          <span class="chip deg" id="vsp_gs_chip_v1"><span class="dot"></span><span id="vsp_gs_txt_v1">—</span></span>
          <span class="muted" id="vsp_gs_rid_v1"></span>
          <span class="muted" id="vsp_gs_reasons_v1">loading…</span>
        </div>
        <div class="row" style="margin-top:6px">
          <span class="muted">Quick:</span>
          <a href="#" id="vsp_gs_open_summary_v1"></a>
          <span class="muted">•</span>
          <a href="#" id="vsp_gs_open_gate_v1">run_gate.json</a>
        </div>
      `;
      a.insertAdjacentElement("afterend", p);
      return p;
    };

    const setChip = (mode, text)=>{
      const c = document.getElementById("vsp_gs_chip_v1");
      const t = document.getElementById("vsp_gs_txt_v1");
      if (!c || !t) return;
      c.classList.remove("pass","fail","deg");
      c.classList.add(mode || "deg");
      t.textContent = text || "—";
    };

    const summarizeReasons = (gs)=>{
      // try common shapes
      const reasons = [];
      try{
        const by = (gs && (gs.by_tool || gs.tools || gs.byTool)) || {};
        for (const k of Object.keys(by)){
          const o = by[k] || {};
          if (o.missing || o.is_missing) reasons.push(`${k}: missing`);
          else if (o.degraded || o.is_degraded || o.status==="degraded") reasons.push(`${k}: degraded`);
        }
      }catch(e){}

      const counts = (gs && (gs.counts_total || (gs.meta && gs.meta.counts_by_severity) || gs.counts_by_severity)) || null;
      if (counts && typeof counts === "object"){
        const c = counts.CRITICAL || counts.critical || 0;
        const h = counts.HIGH || counts.high || 0;
        if (Number(c) > 0) reasons.unshift(`CRITICAL=${c}`);
        if (Number(h) > 0) reasons.unshift(`HIGH=${h}`);
      }
      if (!reasons.length) return "No major issues detected";
      return reasons.slice(0,4).join(" • ");
    };

    const fetchJson = async (rid, path)=>{
      const u = `/api/vsp/run_file?rid=${encodeURIComponent(rid)}&name=${encodeURIComponent(path)}`;
      const r = await fetch(u, {cache:"no-store"});
      return await r.json();
    };

    const openRunFile = (rid, path)=>{
      const u = `/api/vsp/run_file?rid=${encodeURIComponent(rid)}&name=${encodeURIComponent(path)}`;
      window.open(u, "_blank", "noopener,noreferrer");
    };

    const autoClickTop25 = ()=>{
      // find the button you already have
      const btns = Array.from(document.querySelectorAll("button"));
      const b = btns.find(x => (x.textContent||"").includes("Load top findings"));
      if (b) { try{ b.click(); return true; }catch(e){} }
      return false;
    };

    let lastRid = "";

    const tick = async ()=>{
      const rid = getRid();
      if (!rid){ ensurePanel(); return; }

      ensurePanel();

      const ridEl = document.getElementById("vsp_gs_rid_v1");
      if (ridEl) ridEl.textContent = `RID: ${rid}`;

      const linkS = document.getElementById("vsp_gs_open_summary_v1");
      const linkG = document.getElementById("vsp_gs_open_gate_v1");
      if (linkS) linkS.onclick = (e)=>{ e.preventDefault(); openRunFile(rid, "gate_summary"); };
      if (linkG) linkG.onclick = (e)=>{ e.preventDefault(); openRunFile(rid, "gate_json"); };

      // if RID changed -> auto click Top25 once
      if (rid !== lastRid){
        lastRid = rid;
        setTimeout(()=>autoClickTop25(), 600);
      }

      // compute gate chip
      let gate = null;
      try{ gate = await fetchJson(rid, "gate_json"); }catch(e){}
      let gs = null;
      try{ gs = await fetchJson(rid, "gate_summary"); }catch(e){}

      // choose text
      const pass = gate && (gate.pass === true || gate.ok === true || String(gate.overall||"").toLowerCase().includes("pass"));
      const fail = gate && (gate.fail === true || String(gate.overall||"").toLowerCase().includes("fail"));
      const degraded = (gate && (gate.degraded || gate.is_degraded)) || (gs && (gs.degraded || gs.is_degraded)) || false;

      if (fail) setChip("fail", "FAIL");
      else if (pass && degraded) setChip("deg", "PASS (DEG)");
      else if (pass) setChip("pass", "PASS");
      else if (degraded) setChip("deg", "DEGRADED");
      else setChip("deg", String((gate && gate.overall) || "UNKNOWN").toUpperCase().slice(0,18));

      const rEl = document.getElementById("vsp_gs_reasons_v1");
      if (rEl) rEl.textContent = summarizeReasons(gs);
    };

    const boot = ()=>{
      if (!(location && location.pathname === "/vsp5")) return;
      // wait cmdbar exists for best placement
      let n=0;
      const t = setInterval(()=>{
        n++;
        if (document.getElementById("vsp_cmdbar_v1")){
          clearInterval(t);
          tick();
          setInterval(tick, 30000); // 30s (lighter than 60s heavy)
        }
        if (n>120) clearInterval(t);
      }, 250);
    };

    if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", boot, {once:true});
    else boot();

  }catch(e){
    console.error("[VSP_GATE_STORY_V1] fatal", e);
  }
})();
/* ===================== /VSP_P1_DASH_GATE_STORY_AUTOTOP25_V1 ===================== */



/* ===================== VSP_P1_DASH_EXPORTS_EVIDENCE_MODAL_V1 ===================== */
(()=> {
  try{
    if (!(location && location.pathname === "/vsp5")) return;

    const css = `
#vsp_exp_btn_v1{
  cursor:pointer; border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.06); color:rgba(255,255,255,.92);
  padding:7px 10px; border-radius:12px; font-weight:900;
}
#vsp_copyrid_btn_v1{
  cursor:pointer; border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.06); color:rgba(255,255,255,.92);
  padding:7px 10px; border-radius:12px; font-weight:900;
}
#vsp_exp_modal_v1{
  position:fixed; inset:0; z-index:120000;
  background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center;
}
#vsp_exp_modal_v1 .card{
  width:min(940px, 94vw); max-height:82vh; overflow:auto;
  border-radius:16px;
  background:rgba(10,16,32,.96);
  border:1px solid rgba(255,255,255,.12);
  box-shadow:0 18px 55px rgba(0,0,0,.55);
  padding:14px;
  color:rgba(255,255,255,.92);
  font:12px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial;
}
#vsp_exp_modal_v1 .top{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px}
#vsp_exp_modal_v1 .ttl{font-weight:900;letter-spacing:.2px}
#vsp_exp_modal_v1 button{
  cursor:pointer;border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.06); color:rgba(255,255,255,.92);
  padding:7px 10px;border-radius:12px;font-weight:900;
}
#vsp_exp_modal_v1 .grid{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
#vsp_exp_modal_v1 .item{
  border:1px solid rgba(255,255,255,.10);
  background:rgba(255,255,255,.04);
  border-radius:14px;
  padding:10px;
}
#vsp_exp_modal_v1 .item .h{font-weight:900; margin-bottom:6px}
#vsp_exp_modal_v1 a{
  color:rgba(255,255,255,.90);
  text-decoration:none;
  border-bottom:1px dashed rgba(255,255,255,.22);
}
#vsp_exp_modal_v1 a:hover{border-bottom-color:rgba(255,255,255,.55)}
#vsp_exp_modal_v1 .muted{opacity:.72}
    `.trim();

    const ensureStyle=()=>{
      if (document.getElementById("vsp_exp_style_v1")) return;
      const st=document.createElement("style");
      st.id="vsp_exp_style_v1";
      st.textContent=css;
      document.head.appendChild(st);
    };

    const isRid=(v)=>{
      if (!v) return false;
      v=String(v).trim();
      if (v.length<6||v.length>80) return false;
      if (/\s/.test(v)) return false;
      if (!/^[A-Za-z0-9][A-Za-z0-9_.:-]+$/.test(v)) return false;
      if (!/\d/.test(v)) return false;
      return true;
    };

    const getRid=()=>{
      const v=(window.__vsp_last_rid_v1||"").trim();
      return isRid(v)?v:"";
    };

    const runFileUrl=(rid, path)=>`/api/vsp/run_file?rid=${encodeURIComponent(rid)}&name=${encodeURIComponent(path)}`;

    const ensureModal=()=>{
      ensureStyle();
      if (document.getElementById("vsp_exp_modal_v1")) return;
      const m=document.createElement("div");
      m.id="vsp_exp_modal_v1";
      m.innerHTML=`
        <div class="card">
          <div class="top">
            <div class="ttl" id="vsp_exp_ttl_v1">Exports & Evidence</div>
            <button id="vsp_exp_close_v1">Close</button>
          </div>
          <div class="muted" id="vsp_exp_rid_v1" style="margin-bottom:10px">RID: —</div>
          <div class="grid" id="vsp_exp_grid_v1"></div>
        </div>
      `;
      document.body.appendChild(m);
      m.addEventListener("click",(e)=>{ if(e.target===m) m.style.display="none"; });
      document.getElementById("vsp_exp_close_v1").addEventListener("click",()=>{ m.style.display="none"; });
    };

    const openModal=()=>{
      ensureModal();
      const rid=getRid();
      const m=document.getElementById("vsp_exp_modal_v1");
      const ridEl=document.getElementById("vsp_exp_rid_v1");
      const grid=document.getElementById("vsp_exp_grid_v1");
      const ttl=document.getElementById("vsp_exp_ttl_v1");
      if (!rid){
        ttl.textContent="Exports & Evidence";
        ridEl.textContent="RID: (not ready) — bấm Refresh/Pin RID trước";
        grid.innerHTML=`<div class="item"><div class="h">Tip</div><div class="muted">Hãy bấm Refresh hoặc Pin RID để Dashboard có RID, rồi mở lại Export.</div></div>`;
        m.style.display="flex";
        return;
      }
      ttl.textContent="Exports & Evidence";
      ridEl.textContent=`RID: ${rid}`;
      const items = [
        ["Gate summary", [
          ["gate_summary","gate_summary"],
          ["gate_json","gate_json"],
        ]],
        ["Unified findings", [
          ["unified","unified"],
          ["reports/findings_unified.csv","reports/findings_unified.csv"],
          ["reports/findings_unified.sarif","reports/findings_unified.sarif"],
          ["unified","unified"],
        ]],
        ["Per-tool summaries", [
          ["semgrep_summary.json","semgrep_summary.json"],
          ["gitleaks_summary.json","gitleaks_summary.json"],
          ["kics_summary.json","kics_summary.json"],
          ["trivy_summary.json","trivy_summary.json"],
          ["syft_summary.json","syft_summary.json"],
          ["grype_summary.json","grype_summary.json"],
          ["bandit_summary.json","bandit_summary.json"],
          ["codeql_summary.json","codeql_summary.json"],
        ]],
        ["Evidence index", [
          ["run_manifest.json","run_manifest.json"],
          ["run_evidence_index.json","run_evidence_index.json"],
          ["SUMMARY.txt","SUMMARY.txt"],
        ]],
      ];

      grid.innerHTML = "";
      for (const [title, links] of items){
        const box=document.createElement("div");
        box.className="item";
        const html = links.map(([label,path])=>{
          const u = runFileUrl(rid, path);
          return `<div style="margin:4px 0"><a href="${u}" target="_blank" rel="noopener noreferrer">${label}</a> <span class="muted">(${path})</span></div>`;
        }).join("");
        box.innerHTML = `<div class="h">${title}</div>${html}`;
        grid.appendChild(box);
      }
      m.style.display="flex";
    };

    const copyRid=async()=>{
      const rid=getRid();
      if (!rid) return;
      try{ await navigator.clipboard.writeText(rid); }catch(e){}
    };

    const injectButtons=()=>{
      const cmd=document.getElementById("vsp_cmdbar_v1");
      if (!cmd) return false;

      // Put buttons on RHS near existing actions
      const rhs = cmd.querySelector(".rhs") || cmd;

      if (!document.getElementById("vsp_copyrid_btn_v1")){
        const b=document.createElement("button");
        b.id="vsp_copyrid_btn_v1";
        b.textContent="Copy RID";
        b.onclick=()=>copyRid();
        rhs.insertAdjacentElement("afterbegin", b);
      }

      if (!document.getElementById("vsp_exp_btn_v1")){
        const b=document.createElement("button");
        b.id="vsp_exp_btn_v1";
        b.textContent="Export";
        b.onclick=()=>openModal();
        rhs.insertAdjacentElement("afterbegin", b);
      }
      return true;
    };

    const boot=()=>{
      if (!(location && location.pathname==="/vsp5")) return;
      let n=0;
      const t=setInterval(()=>{
        n++;
        if (injectButtons()){ clearInterval(t); }
        if (n>120) clearInterval(t);
      }, 250);
    };

    if (document.readyState==="loading") document.addEventListener("DOMContentLoaded", boot, {once:true});
    else boot();

  }catch(e){
    console.error("[VSP_EXPORT_MODAL_V1] fatal", e);
  }
})();
/* ===================== /VSP_P1_DASH_EXPORTS_EVIDENCE_MODAL_V1 ===================== */





/* ===================== VSP_P1_DASH_DEGRADED_PANEL_V1 ===================== */
(()=> {
  try{
    if (!(location && location.pathname === "/vsp5")) return;

    const TOOLS = ["Bandit","Semgrep","Gitleaks","KICS","Trivy","Syft","Grype","CodeQL"];

    const css = `
#vsp_degraded_v1{
  margin: 10px 12px 10px 12px;
  border-radius: 16px;
  background: rgba(255,255,255,.03);
  border: 1px solid rgba(255,255,255,.10);
  box-shadow: 0 14px 36px rgba(0,0,0,.25);
  padding: 10px 12px;
  color: rgba(255,255,255,.92);
  font: 12px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial;
}
#vsp_degraded_v1 .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
#vsp_degraded_v1 .ttl{font-weight:900;letter-spacing:.2px}
#vsp_degraded_v1 .muted{opacity:.72}
#vsp_degraded_v1 .pill{
  display:inline-flex;align-items:center;gap:6px;
  padding:4px 8px;border-radius:999px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.05);
  font-weight:900;
}
#vsp_degraded_v1 .pill .d{width:8px;height:8px;border-radius:50%;background:rgba(255,255,255,.35);box-shadow:0 0 0 3px rgba(255,255,255,.06)}
#vsp_degraded_v1 .pill.ok .d{background:#24d17e; box-shadow:0 0 0 3px rgba(36,209,126,.12)}
#vsp_degraded_v1 .pill.warn .d{background:#f4b400; box-shadow:0 0 0 3px rgba(244,180,0,.12)}
#vsp_degraded_v1 .pill.err .d{background:#ff4d4f; box-shadow:0 0 0 3px rgba(255,77,79,.12)}
#vsp_degraded_v1 table{width:100%; border-collapse:collapse; margin-top:8px}
#vsp_degraded_v1 th, #vsp_degraded_v1 td{padding:8px; border-top:1px solid rgba(255,255,255,.08); vertical-align:top}
#vsp_degraded_v1 th{opacity:.72; text-align:left; font-weight:900}
#vsp_degraded_v1 a{
  color:rgba(255,255,255,.90);
  text-decoration:none;
  border-bottom:1px dashed rgba(255,255,255,.22);
}
#vsp_degraded_v1 a:hover{border-bottom-color:rgba(255,255,255,.55)}
    `.trim();

    const ensureStyle=()=>{
      if (document.getElementById("vsp_degraded_style_v1")) return;
      const st=document.createElement("style");
      st.id="vsp_degraded_style_v1";
      st.textContent=css;
      document.head.appendChild(st);
    };

    const isRid=(v)=>{
      if (!v) return false;
      v=String(v).trim();
      if (v.length<6||v.length>80) return false;
      if (/\s/.test(v)) return false;
      if (!/^[A-Za-z0-9][A-Za-z0-9_.:-]+$/.test(v)) return false;
      if (!/\d/.test(v)) return false;
      return true;
    };

    const getPinnedRid=()=>{
      const keys=["vsp5_pin_rid","vsp_pin_rid","VSP_PIN_RID","vsp5.rid.pinned","vsp5_last_rid","vsp_last_rid"];
      for (const k of keys){
        try{
          const v=(localStorage.getItem(k)||"").trim();
          if (isRid(v)) return v;
        }catch(e){}
      }
      return "";
    };

    const getRid=()=>{
      const pin=getPinnedRid();
      if (isRid(pin)) return pin;
      const v=(window.__vsp_last_rid_v1||"").trim();
      return isRid(v)?v:"";
    };

    const runFileUrl=(rid, path)=>`/api/vsp/run_file?rid=${encodeURIComponent(rid)}&name=${encodeURIComponent(path)}`;

    const pickAnchor=()=>{
      const gs = document.getElementById("vsp_gatestory_v1");
      if (gs) return gs;
      const cmd = document.getElementById("vsp_cmdbar_v1");
      if (cmd) return cmd;
      return document.body;
    };

    const ensurePanel=()=>{
      ensureStyle();
      if (document.getElementById("vsp_degraded_v1")) return document.getElementById("vsp_degraded_v1");
      const a = pickAnchor();
      const p = document.createElement("div");
      p.id="vsp_degraded_v1";
      p.innerHTML = `
        <div class="row">
          <div class="ttl">Degraded / Missing tools</div>
          <span class="pill ok" id="vsp_deg_pill_v1"><span class="d"></span><span id="vsp_deg_txt_v1">OK</span></span>
          <span class="muted" id="vsp_deg_rid_v1"></span>
        </div>
        <div class="muted" id="vsp_deg_hint_v1" style="margin-top:6px">
          Commercial-safe: only raises flags when run is DEGRADED or tools are explicitly missing/degraded.
        </div>
        <div id="vsp_deg_tbl_wrap_v1"></div>
      `;
      a.insertAdjacentElement("afterend", p);
      return p;
    };

    const setPill=(mode, text)=>{
      const pill=document.getElementById("vsp_deg_pill_v1");
      const txt=document.getElementById("vsp_deg_txt_v1");
      if (!pill || !txt) return;
      pill.classList.remove("ok","warn","err");
      pill.classList.add(mode||"warn");
      txt.textContent=text||"—";
    };

    const toolStatusSafe=(o)=>{
      if (!o || typeof o !== "object") return {cls:"unk", st:"UNKNOWN", why:"no data"};

      if (o.missing || o.is_missing) return {cls:"err", st:"MISSING", why:(o.reason||o.err||o.message||"missing")};
      if (o.degraded || o.is_degraded || o.status==="degraded") return {cls:"warn", st:"DEGRADED", why:(o.reason||o.err||o.message||"degraded")};

      // strong OK signals
      if (o.ok === true || o.status==="ok") return {cls:"ok", st:"OK", why:(o.reason||"")};

      // common summary shape: counts => treat OK
      const hasCounts = !!(o.counts_total || o.counts_by_severity || (o.meta && o.meta.counts_by_severity));
      const hasTotals = (o.findings_count != null) || (o.total_findings != null) || (o.total != null);
      if (hasCounts || hasTotals) return {cls:"ok", st:"OK", why:""};

      // explicit error hint
      if (o.err || o.error || o.message) return {cls:"warn", st:"WARN", why:(o.err||o.error||o.message||"warn")};

      return {cls:"unk", st:"UNKNOWN", why:""};
    };

    const guessSummaryPath=(tool)=>{
      const t=tool.toLowerCase();
      if (t==="codeql") return "codeql_summary.json";
      return `${t}_summary.json`;
    };

    const guessLogPaths=(tool)=>{
      const t=tool.toLowerCase();
      const cands=[];
      if (t==="kics") cands.push("kics/kics.log","kics.log");
      if (t==="codeql") cands.push("codeql/codeql.log","codeql.log");
      if (t==="semgrep") cands.push("semgrep/semgrep.log","semgrep.log");
      if (t==="trivy") cands.push("trivy/trivy.log","trivy.log");
      if (t==="gitleaks") cands.push("gitleaks/gitleaks.log","gitleaks.log");
      if (t==="syft") cands.push("syft/syft.log","syft.log");
      if (t==="grype") cands.push("grype/grype.log","grype.log");
      if (t==="bandit") cands.push("bandit/bandit.log","bandit.log");
      return cands;
    };

    const fetchGateSummary=async(rid)=>{
      const u = runFileUrl(rid, "gate_summary");
      const r = await fetch(u, {cache:"no-store"});
      return await r.json();
    };

    const openFirstAvailable = async (rid, paths)=>{
      for (const path of paths){
        const u = runFileUrl(rid, path);
        try{
          const r = await fetch(u, {cache:"no-store"});
          if (r && r.status === 200){
            window.open(u, "_blank", "noopener,noreferrer");
            return true;
          }
        }catch(e){}
      }
      const u0 = runFileUrl(rid, paths[0] || "");
      window.open(u0, "_blank", "noopener,noreferrer");
      return false;
    };

    let lastRid="";

    const render = async ()=>{
      const rid=getRid();
      ensurePanel();

      const ridEl=document.getElementById("vsp_deg_rid_v1");
      if (ridEl) ridEl.textContent = rid ? `RID: ${rid}` : "RID: —";

      const w=document.getElementById("vsp_deg_tbl_wrap_v1");
      if (!rid){
        setPill("warn","RID not ready");
        if (w) w.innerHTML = `<div class="muted" style="margin-top:8px">Bấm Refresh/Pin RID để có dữ liệu.</div>`;
        return;
      }

      let gs=null;
      try{ gs = await fetchGateSummary(rid); }catch(e){}

      const runDegraded = !!(gs && (gs.degraded || gs.is_degraded || (gs.gate && gs.gate.degraded)));

      const by = (gs && (gs.by_tool || gs.tools || gs.byTool)) || {};
      const rows=[];

      for (const tool of TOOLS){
        const obj = (()=> {
          const tl = tool.toLowerCase();
          for (const k of Object.keys(by||{})){
            if (k.toLowerCase() === tl) return by[k];
          }
          return by[tool] || null;
        })();

        const st = toolStatusSafe(obj);
        const explicitBad = (st.cls === "err" || st.st === "DEGRADED");
        const showWhenDegraded = runDegraded && (st.cls === "warn" || st.cls === "unk" || st.st === "WARN" || st.st === "UNKNOWN");

        if (explicitBad || showWhenDegraded){
          rows.push({tool, st});
        }
      }

      if (!runDegraded && !rows.length){
        setPill("ok","No degraded/missing");
        if (w) w.innerHTML = `<div class="muted" style="margin-top:8px">Run is not degraded. Panel stays quiet (commercial-safe).</div>`;
        return;
      }

      if (runDegraded && !rows.length){
        setPill("warn","Degraded (no detail)");
        if (w) w.innerHTML = `<div class="muted" style="margin-top:8px">Run marked degraded but by_tool has no details.</div>`;
        return;
      }

      const hasMissing = rows.some(r=>r.st.st==="MISSING");
      setPill(hasMissing ? "err" : "warn", hasMissing ? "Missing tools" : "Degraded tools");

      const htmlRows = rows.map(r=>{
        const summaryPath = guessSummaryPath(r.tool);
        const sumUrl = runFileUrl(rid, summaryPath);
        const why = String(r.st.why||"").slice(0,240);
        const pillClass = (r.st.cls === "err") ? "err" : "warn";
        return `
          <tr>
            <td><span class="pill ${pillClass}"><span class="d"></span><span>${r.tool}</span></span></td>
            <td><b>${r.st.st}</b><div class="muted" style="margin-top:4px">${why || ""}</div></td>
            <td>
              <div><a href="${sumUrl}" target="_blank" rel="noopener noreferrer">summary</a> <span class="muted">(${summaryPath})</span></div>
              <div style="margin-top:6px"><a href="#" data-tool="${r.tool}">open log</a> <span class="muted">(best-effort)</span></div>
            </td>
          </tr>
        `;
      }).join("");

      if (w){
        w.innerHTML = `
          <table>
            <thead><tr><th style="width:170px">Tool</th><th>Status / reason</th><th style="width:240px">Links</th></tr></thead>
            <tbody>${htmlRows}</tbody>
          </table>
        `;

        w.querySelectorAll('a[data-tool]').forEach(a=>{
          a.addEventListener("click",(e)=>{
            e.preventDefault();
            const tool = a.getAttribute("data-tool") || "";
            const paths = guessLogPaths(tool);
            if (paths.length) openFirstAvailable(rid, paths);
          });
        });
      }

      if (rid !== lastRid){
        lastRid = rid;
        setTimeout(()=>render(), 1200);
      }
    };

    const boot=()=>{
      if (!(location && location.pathname==="/vsp5")) return;
      let n=0;
      const t=setInterval(()=>{
        n++;
        if (document.getElementById("vsp_cmdbar_v1")){
          clearInterval(t);
          render();
          setInterval(render, 60000);
        }
        if (n>120) clearInterval(t);
      }, 250);
    };

    if (document.readyState==="loading") document.addEventListener("DOMContentLoaded", boot, {once:true});
    else boot();

  }catch(e){
    console.error("[VSP_DEGRADED_PANEL_V1] fatal", e);
  }
})();
/* ===================== /VSP_P1_DASH_DEGRADED_PANEL_V1 ===================== */





/* ===================== VSP_P1_DASH_TOPFINDINGS_UX_FILTER_MODAL_V1 ===================== */
(()=> {
  try{
    if (!(location && location.pathname === "/vsp5")) return;

    const css = `
#vsp_topux_bar_v1{
  display:flex; gap:8px; align-items:center; flex-wrap:wrap;
  margin: 6px 0 8px 0;
}
#vsp_topux_bar_v1 select, #vsp_topux_bar_v1 input{
  border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.05);
  color:rgba(255,255,255,.92);
  padding:7px 10px;
  border-radius:12px;
  outline:none;
  font-weight:800;
}
#vsp_topux_bar_v1 input{min-width:260px}
#vsp_topux_bar_v1 .muted{opacity:.72; font-weight:800}
#vsp_topux_modal_v1{
  position:fixed; inset:0; z-index:130000;
  background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center;
}
#vsp_topux_modal_v1 .card{
  width:min(980px, 94vw); max-height:84vh; overflow:auto;
  border-radius:16px;
  background:rgba(10,16,32,.96);
  border:1px solid rgba(255,255,255,.12);
  box-shadow:0 18px 55px rgba(0,0,0,.55);
  padding:14px;
  color:rgba(255,255,255,.92);
  font:12px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial;
}
#vsp_topux_modal_v1 .top{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px}
#vsp_topux_modal_v1 .ttl{font-weight:900;letter-spacing:.2px}
#vsp_topux_modal_v1 button{
  cursor:pointer;border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.06); color:rgba(255,255,255,.92);
  padding:7px 10px;border-radius:12px;font-weight:900;
}
#vsp_topux_modal_v1 pre{
  white-space:pre-wrap; word-break:break-word;
  background:rgba(255,255,255,.04);
  border:1px solid rgba(255,255,255,.10);
  padding:10px; border-radius:14px;
}
    `.trim();

    const ensureStyle=()=>{
      if (document.getElementById("vsp_topux_style_v1")) return;
      const st=document.createElement("style");
      st.id="vsp_topux_style_v1";
      st.textContent=css;
      document.head.appendChild(st);
    };

    const ensureModal=()=>{
      ensureStyle();
      if (document.getElementById("vsp_topux_modal_v1")) return;
      const m=document.createElement("div");
      m.id="vsp_topux_modal_v1";
      m.innerHTML = `
        <div class="card">
          <div class="top">
            <div class="ttl" id="vsp_topux_ttl_v1">Finding detail</div>
            <div style="display:flex;gap:8px;align-items:center">
              <button id="vsp_topux_copy_v1">Copy</button>
              <button id="vsp_topux_close_v1">Close</button>
            </div>
          </div>
          <div class="muted" id="vsp_topux_meta_v1" style="margin-bottom:10px"></div>
          <pre id="vsp_topux_pre_v1">{}</pre>
        </div>
      `;
      document.body.appendChild(m);
      m.addEventListener("click",(e)=>{ if(e.target===m) m.style.display="none"; });
      document.getElementById("vsp_topux_close_v1").addEventListener("click",()=>{ m.style.display="none"; });
      document.getElementById("vsp_topux_copy_v1").addEventListener("click",async()=>{
        try{
          const t=(document.getElementById("vsp_topux_pre_v1")||{}).textContent||"";
          await navigator.clipboard.writeText(t);
        }catch(e){}
      });
    };

    const showModal=(obj)=>{
      ensureModal();
      const m=document.getElementById("vsp_topux_modal_v1");
      const pre=document.getElementById("vsp_topux_pre_v1");
      const meta=document.getElementById("vsp_topux_meta_v1");
      if (pre) pre.textContent = JSON.stringify(obj||{}, null, 2);
      const sev=(obj && (obj.severity||obj.sev||obj.level))||"";
      const tool=(obj && (obj.tool||obj.source||obj.engine))||"";
      const loc=(obj && (obj.location||obj.path||obj.file))||"";
      if (meta) meta.textContent = `${sev} • ${tool} • ${loc}`.trim();
      if (m) m.style.display="flex";
    };

    // Find the "Top findings (sample)" table, then enhance it.
    const findTopTable = ()=>{
      // heuristic: the sample table has headers Severity/Tool/Title/Location
      const tables=[...document.querySelectorAll("table")];
      for (const t of tables){
        const th=[...t.querySelectorAll("th")].map(x=>(x.textContent||"").trim().toLowerCase());
        if (th.includes("severity") && th.includes("tool") && th.includes("title") && th.includes("location")) return t;
      }
      return null;
    };

    const normalize=(v)=>String(v||"").toLowerCase();

    const parseRow = (tr)=>{
      const tds=[...tr.querySelectorAll("td")];
      if (tds.length<4) return null;
      const sev=(tds[0].textContent||"").trim();
      const tool=(tds[1].textContent||"").trim();
      const title=(tds[2].textContent||"").trim();
      const loc=(tds[3].textContent||"").trim();
      return {severity:sev, tool:tool, title:title, location:loc};
    };

    const state = {
      tool:"ALL",
      sev:"ALL",
      q:"",
      rows:[], // {tr,obj}
    };

    const applyFilter=()=>{
      const q=normalize(state.q);
      for (const r of state.rows){
        const o=r.obj||{};
        const okTool = (state.tool==="ALL") || normalize(o.tool)===normalize(state.tool);
        const okSev  = (state.sev==="ALL")  || normalize(o.severity)===normalize(state.sev);
        const okQ = (!q) || (normalize(o.title).includes(q) || normalize(o.location).includes(q) || normalize(o.tool).includes(q));
        r.tr.style.display = (okTool && okSev && okQ) ? "" : "none";
      }
      const cnt = state.rows.filter(r=>r.tr.style.display!=="none").length;
      const hint=document.getElementById("vsp_topux_hint_v1");
      if (hint) hint.textContent = `${cnt}/${state.rows.length}`;
    };

    const buildBar=(table)=>{
      if (document.getElementById("vsp_topux_bar_v1")) return;
      const wrap = table.parentElement || table;
      const bar=document.createElement("div");
      bar.id="vsp_topux_bar_v1";
      bar.innerHTML = `
        <span class="muted">Filter:</span>
        <select id="vsp_topux_sev_v1"><option value="ALL">Severity: ALL</option></select>
        <select id="vsp_topux_tool_v1"><option value="ALL">Tool: ALL</option></select>
        <input id="vsp_topux_q_v1" placeholder="Search title/location/tool… (live)" />
        <span class="muted">show</span> <span class="muted" id="vsp_topux_hint_v1">0/0</span>
      `;
      wrap.insertBefore(bar, table);

      const sevSel=document.getElementById("vsp_topux_sev_v1");
      const toolSel=document.getElementById("vsp_topux_tool_v1");
      const q=document.getElementById("vsp_topux_q_v1");

      sevSel.addEventListener("change",()=>{ state.sev=sevSel.value; applyFilter(); });
      toolSel.addEventListener("change",()=>{ state.tool=toolSel.value; applyFilter(); });
      q.addEventListener("input",()=>{ state.q=q.value||""; applyFilter(); });
    };

    const refreshOptions=()=>{
      const sevSel=document.getElementById("vsp_topux_sev_v1");
      const toolSel=document.getElementById("vsp_topux_tool_v1");
      if (!sevSel || !toolSel) return;

      const sevs=[...new Set(state.rows.map(r=>(r.obj.severity||"").trim()).filter(Boolean))].sort();
      const tools=[...new Set(state.rows.map(r=>(r.obj.tool||"").trim()).filter(Boolean))].sort();

      const curSev=state.sev, curTool=state.tool;

      sevSel.innerHTML = `<option value="ALL">Severity: ALL</option>` + sevs.map(x=>`<option value="${x}">${x}</option>`).join("");
      toolSel.innerHTML = `<option value="ALL">Tool: ALL</option>` + tools.map(x=>`<option value="${x}">${x}</option>`).join("");

      if ([...sevSel.options].some(o=>o.value===curSev)) sevSel.value=curSev; else { sevSel.value="ALL"; state.sev="ALL"; }
      if ([...toolSel.options].some(o=>o.value===curTool)) toolSel.value=curTool; else { toolSel.value="ALL"; state.tool="ALL"; }
    };

    const bindRows=(table)=>{
      const tbody=table.querySelector("tbody");
      if (!tbody) return;
      const trs=[...tbody.querySelectorAll("tr")];
      state.rows=[];
      for (const tr of trs){
        const obj=parseRow(tr);
        if (!obj) continue;
        state.rows.push({tr, obj});
        // row click => modal
        tr.style.cursor="pointer";
        tr.addEventListener("click",(e)=>{
          // avoid clicking links if any
          const a=e.target && e.target.closest && e.target.closest("a");
          if (a) return;
          showModal(obj);
        });
      }
    };

    const enhance=()=>{
      const t=findTopTable();
      if (!t) return false;
      buildBar(t);
      bindRows(t);
      refreshOptions();
      applyFilter();
      return true;
    };

    // Re-run enhancer when table content changes (after clicking "Load top findings")
    const attachObserver=()=>{
      const root=document.body;
      const obs=new MutationObserver(()=>{
        const t=findTopTable();
        if (!t) return;
        // refresh binding if row count changed
        const tbody=t.querySelector("tbody");
        const rc=tbody ? tbody.querySelectorAll("tr").length : 0;
        const cur=state.rows.length;
        if (rc && rc !== cur){
          bindRows(t);
          refreshOptions();
          applyFilter();
        }
      });
      obs.observe(root, {subtree:true, childList:true});
    };

    const boot=()=>{
      if (!(location && location.pathname==="/vsp5")) return;
      ensureStyle();
      ensureModal();
      let n=0;
      const t=setInterval(()=>{
        n++;
        if (enhance()){
          clearInterval(t);
          attachObserver();
        }
        if (n>140) clearInterval(t);
      }, 250);
    };

    if (document.readyState==="loading") document.addEventListener("DOMContentLoaded", boot, {once:true});
    else boot();

  }catch(e){
    console.error("[VSP_TOPFINDINGS_UX_V1] fatal", e);
  }
})();
/* ===================== /VSP_P1_DASH_TOPFINDINGS_UX_FILTER_MODAL_V1 ===================== */




/* ===================== VSP_P1_DASH_TOPFINDINGS_MODAL_DETAIL_DATASOURCE_V1 ===================== */
(()=> {
  try{
    if (!(location && location.pathname === "/vsp5")) return;

    const isRid=(v)=>{
      if (!v) return false;
      v=String(v).trim();
      if (v.length<6||v.length>80) return false;
      if (/\s/.test(v)) return false;
      if (!/^[A-Za-z0-9][A-Za-z0-9_.:-]+$/.test(v)) return false;
      if (!/\d/.test(v)) return false;
      return true;
    };
    const getPinnedRid=()=>{
      const keys=["vsp5_pin_rid","vsp_pin_rid","VSP_PIN_RID","vsp5.rid.pinned","vsp5_last_rid","vsp_last_rid"];
      for (const k of keys){
        try{
          const v=(localStorage.getItem(k)||"").trim();
          if (isRid(v)) return v;
        }catch(e){}
      }
      return "";
    };
    const getRid=()=>{
      const pin=getPinnedRid();
      if (isRid(pin)) return pin;
      const v=(window.__vsp_last_rid_v1||"").trim();
      return isRid(v)?v:"";
    };
    const runFileUrl=(rid, path)=>`/api/vsp/run_file?rid=${encodeURIComponent(rid)}&name=${encodeURIComponent(path)}`;
    const norm=(v)=>String(v||"").toLowerCase().trim();

    // global cache by RID (commercial-safe)
    if (!window.__vsp_findings_cache_v2) window.__vsp_findings_cache_v2 = {};
    const cache = window.__vsp_findings_cache_v2;

    const ensureExtraButtons=()=>{
      const modal=document.getElementById("vsp_topux_modal_v1");
      if (!modal) return;
      const top=modal.querySelector(".top > div:last-child");
      if (!top) return;
      if (!document.getElementById("vsp_topux_ds_v1")){
        const b=document.createElement("button");
        b.id="vsp_topux_ds_v1";
        b.textContent="Open Data Source";
        top.insertBefore(b, top.firstChild);
      }
    };

    const openDataSource=(obj)=>{
      const q = new URLSearchParams();
      if (obj && obj.tool) q.set("tool", obj.tool);
      if (obj && obj.severity) q.set("severity", obj.severity);
      const qq = (obj && (obj.title || obj.location)) ? (obj.title || obj.location) : "";
      if (qq) q.set("q", qq.slice(0,160));
      const rid=getRid();
      if (rid) q.set("rid", rid);
      window.open("/data_source?" + q.toString(), "_blank", "noopener,noreferrer");
    };

    const setModal=(title, meta, payloadObj)=>{
      const ttl=document.getElementById("vsp_topux_ttl_v1");
      const metaEl=document.getElementById("vsp_topux_meta_v1");
      const pre=document.getElementById("vsp_topux_pre_v1");
      if (ttl) ttl.textContent = title || "Finding detail";
      if (metaEl) metaEl.textContent = meta || "";
      if (pre) pre.textContent = JSON.stringify(payloadObj||{}, null, 2);
      const m=document.getElementById("vsp_topux_modal_v1");
      if (m) m.style.display="flex";
      ensureExtraButtons();
      const ds=document.getElementById("vsp_topux_ds_v1");
      if (ds) ds.onclick = ()=>openDataSource(payloadObj || {});
    };

    const fetchFindingsCached = async (rid)=>{
      if (cache[rid] && Array.isArray(cache[rid])) return cache[rid];

      const ctrl=new AbortController();
      const to=setTimeout(()=>ctrl.abort(), 4000); // timeout 4s
      try{
        const u = runFileUrl(rid, "unified");
        const r = await fetch(u, {cache:"no-store", signal: ctrl.signal});
        const j = await r.json();
        const arr = (j && (j.findings || j.items || j.data)) || [];
        cache[rid] = Array.isArray(arr) ? arr : [];
        return cache[rid];
      } finally {
        clearTimeout(to);
      }
    };

    const findDetailRecord = async (rowObj)=>{
      const rid=getRid();
      if (!rid) return null;
      const arr = await fetchFindingsCached(rid);
      if (!arr || !arr.length) return null;

      const wantTool=norm(rowObj.tool);
      const wantSev=norm(rowObj.severity);
      const wantTitle=norm(rowObj.title);
      const wantLoc=norm(rowObj.location);

      const N = Math.min(arr.length, 2000);
      let best=null; let bestScore=-1;
      for (let i=0;i<N;i++){
        const f=arr[i]||{};
        const ftool=norm(f.tool||f.source||f.engine);
        if (wantTool && ftool && ftool!==wantTool) continue;

        const fsev=norm(f.severity||f.sev||f.level);
        const ftitle=norm(f.title||f.message||f.rule_name||f.rule||"");
        const floc=norm(f.location||f.path||f.file||"");

        let score=0;
        if (wantSev && fsev===wantSev) score+=2;
        if (wantTitle && ftitle && (ftitle===wantTitle || ftitle.includes(wantTitle.slice(0,80)))) score+=5;
        if (wantLoc && floc && (floc===wantLoc || floc.includes(wantLoc.slice(0,80)))) score+=5;

        if (score>bestScore){
          bestScore=score; best=f;
        }
        if (score>=9) break; // good enough
      }
      if (bestScore>=5) return best;
      return null;
    };

    const attach=()=>{
      const tables=[...document.querySelectorAll("table")];
      let topTable=null;
      for (const t of tables){
        const th=[...t.querySelectorAll("th")].map(x=>(x.textContent||"").trim().toLowerCase());
        if (th.includes("severity") && th.includes("tool") && th.includes("title") && th.includes("location")) { topTable=t; break; }
      }
      if (!topTable) return false;

      // prevent multiple attaches
      if (topTable.__vsp_topux2_attached) return true;
      topTable.__vsp_topux2_attached = true;

      topTable.addEventListener("click", async (e)=>{
        const tr = e.target && e.target.closest && e.target.closest("tr");
        if (!tr) return;
        const td = tr.querySelectorAll("td");
        if (!td || td.length<4) return;

        const modal=document.getElementById("vsp_topux_modal_v1");
        const pre=document.getElementById("vsp_topux_pre_v1");
        if (!modal || !pre) return;

        // stop other handlers
        e.stopPropagation();
        e.preventDefault();

        const rowObj={
          severity:(td[0].textContent||"").trim(),
          tool:(td[1].textContent||"").trim(),
          title:(td[2].textContent||"").trim(),
          location:(td[3].textContent||"").trim(),
        };
        const rid=getRid();
        const meta = `${rowObj.severity} • ${rowObj.tool} • ${rowObj.location} ${rid?("• RID "+rid):""}`.trim();
        setModal("Finding detail (loading…)", meta, rowObj);

        try{
          const detail = await findDetailRecord(rowObj);
          if (detail){
            const merged = Object.assign({}, rowObj, detail);
            setModal("Finding detail (full)", meta, merged);
          } else {
            setModal("Finding detail (basic)", meta, rowObj);
          }
        }catch(err){
          setModal("Finding detail (basic)", meta + " • detail fetch failed/timeout", rowObj);
        }
      }, true);

      return true;
    };

    const boot=()=>{
      if (!(location && location.pathname==="/vsp5")) return;
      let n=0;
      const t=setInterval(()=>{
        n++;
        if (attach()) clearInterval(t);
        if (n>160) clearInterval(t);
      }, 250);
    };

    if (document.readyState==="loading") document.addEventListener("DOMContentLoaded", boot, {once:true});
    else boot();

  }catch(e){
    console.error("[VSP_TOPFINDINGS_MODAL_DETAIL_DS_V2] fatal", e);
  }
})();
/* ===================== /VSP_P1_DASH_TOPFINDINGS_MODAL_DETAIL_DATASOURCE_V1 ===================== */


/* VSP_P1_REQUIRED_MARKERS_DASH2_V1 */
(function(){
  function ensureAttr(el, k, v){ try{ if(el && !el.getAttribute(k)) el.setAttribute(k,v); }catch(e){} }
  function ensureId(el, v){ try{ if(el && !el.id) el.id=v; }catch(e){} }
  function ensureTestId(el, v){ ensureAttr(el, "data-testid", v); }
  function ensureHiddenKpi(container){
    // Create hidden markers so gate can verify presence without altering layout
    try{
      const ids = ["kpi_total","kpi_critical","kpi_high","kpi_medium","kpi_low","kpi_info_trace"];
      let box = container.querySelector('#vsp-kpi-testids');
      if(!box){
        box = document.createElement('div');
        box.id = "vsp-kpi-testids";
        box.style.display = "none";
        container.appendChild(box);
      }
      ids.forEach(id=>{
        if(!box.querySelector('[data-testid="'+id+'"]')){
          const d=document.createElement('span');
          d.setAttribute('data-testid', id);
          box.appendChild(d);
        }
      });
    }catch(e){}
  }

  function run(){
    try {
      // Dashboard
      const dash = document.getElementById("vsp-dashboard-main") || document.querySelector('[id="vsp-dashboard-main"], #vsp-dashboard, .vsp-dashboard, main, body');
      if(dash) {
        ensureId(dash, "vsp-dashboard-main");
        // add required KPI data-testid markers
        ensureHiddenKpi(dash);
      }

      // Runs
      const runs = document.getElementById("vsp-runs-main") || document.querySelector('#vsp-runs, .vsp-runs, main, body');
      if(runs) ensureId(runs, "vsp-runs-main");

      // Data Source
      const ds = document.getElementById("vsp-data-source-main") || document.querySelector('#vsp-data-source, .vsp-data-source, main, body');
      if(ds) ensureId(ds, "vsp-data-source-main");

      // Settings
      const st = document.getElementById("vsp-settings-main") || document.querySelector('#vsp-settings, .vsp-settings, main, body');
      if(st) ensureId(st, "vsp-settings-main");

      // Rule overrides
      const ro = document.getElementById("vsp-rule-overrides-main") || document.querySelector('#vsp-rule-overrides, .vsp-rule-overrides, main, body');
      if(ro) ensureId(ro, "vsp-rule-overrides-main");
    } catch(e) {}
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", run, { once:true });
  } else {
    run();
  }
  // re-run after soft refresh renders
  setTimeout(run, 300);
  setTimeout(run, 1200);
})();
/* end VSP_P1_REQUIRED_MARKERS_DASH2_V1 */

