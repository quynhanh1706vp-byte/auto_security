/* VSP_RULE_OVERRIDES_P403 - harden legacy hide */
(function(){
  "use strict";
  const log = (...a)=>console.log("[ovr:p403]", ...a);

  function el(tag, attrs, html){
    const e = document.createElement(tag);
    if (attrs) for (const [k,v] of Object.entries(attrs)) {
      if (k === "class") e.className = v;
      else if (k === "style") e.setAttribute("style", v);
      else e.setAttribute(k, v);
    }
    if (html !== undefined) e.innerHTML = html;
    return e;
  }

  function hideLegacy(){
    const needles = [
      "Rule Overrides (live from",
      "VSP_RULE_OVERRIDES_EDITOR_P0_V1",
      "/api/vsp/rule_overrides",
      "Open JSON",
      "Open  JSON"
    ];
    const body = document.body;
    if (!body) return;
    const candidates = Array.from(body.querySelectorAll("section,article,div,main,pre"));
    for (const n of candidates){
      const t = (n.innerText || "").trim();
      if (!t) continue;
      if (!needles.some(x => t.includes(x))) continue;

      let p = n;
      for (let i=0;i<16 && p && p !== body; i++){
        const cls = (p.className || "").toString();
        const h = (p.getBoundingClientRect && p.getBoundingClientRect().height) ? p.getBoundingClientRect().height : 0;
        if (cls.includes("card") || cls.includes("panel") || cls.includes("container") || h >= 160) break;
        p = p.parentElement;
      }
      (p || n).setAttribute("data-vsp-legacy-hidden","1");
      (p || n).style.display="none";
    }
  }

  function cssOnce(){
    if (document.getElementById("vsp_ovr_css_p403")) return;
    const css = `
      .ovr-p403{ padding:16px; }
      .ovr-h1{ font-size:18px; margin:0 0 12px 0; }
      .ovr-grid{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
      .ovr-card{ border:1px solid rgba(255,255,255,.10); background:rgba(0,0,0,.18); border-radius:14px; padding:12px; min-height:120px; }
      .ovr-card h2{ font-size:13px; margin:0 0 10px 0; opacity:.9; }
      .ovr-row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin:0 0 10px 0; }
      .ovr-btn{ cursor:pointer; border:1px solid rgba(255,255,255,.15); background:rgba(255,255,255,.06); color:#eaeaea; padding:6px 10px; border-radius:10px; font-size:12px; }
      textarea.ovr-ta{ width:100%; min-height:240px; resize:vertical; border-radius:12px; padding:10px; border:1px solid rgba(255,255,255,.12); background:rgba(0,0,0,.25); color:#eaeaea; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:12px; line-height:1.4; }
      .ovr-msg{ margin-top:8px; font-size:12px; opacity:.8; }
      @media (max-width: 1100px){ .ovr-grid{ grid-template-columns:1fr; } }
    `;
    document.head.appendChild(el("style",{id:"vsp_ovr_css_p403"},css));
  }

  function findMount(){
    return document.querySelector("#vsp_tab_content")
      || document.querySelector("#content")
      || document.querySelector("main")
      || document.body;
  }

  async function ensureViewerLoaded(){
    if (window.VSP && window.VSP.jsonViewer) return true;
    return await new Promise((resolve)=>{
      const s = document.createElement("script");
      s.src = "/static/js/vsp_json_viewer_v1.js?v=" + Date.now();
      s.onload = ()=>resolve(true);
      s.onerror = ()=>resolve(false);
      document.head.appendChild(s);
    });
  }

  async function fetchJson(url){
    try{
      const r = await fetch(url, { cache:"no-store", credentials:"same-origin" });
      const text = await r.text();
      let data=null; try{ data=JSON.parse(text); }catch(_){}
      return { ok:r.ok, status:r.status, text, data };
    }catch(e){
      return { ok:false, status:0, text:String(e), data:null };
    }
  }

  async function detectEndpoint(){
    const fixed = (window.VSP_OVR_ENDPOINT || "").trim();
    if (fixed) return fixed;
    const cands = ["/api/vsp/rule_overrides_v1","/api/vsp/overrides_v1","/api/vsp/rule_overrides","/api/vsp/overrides"];
    for (const u of cands){
      const r = await fetchJson(u);
      if (r.ok && r.data !== null) return u;
    }
    return cands[0];
  }

  async function main(){
    hideLegacy();
    cssOnce();
    const mount = findMount();

    const root = el("div",{class:"ovr-p403"});
    root.appendChild(el("div",{class:"ovr-h1"},"Rule Overrides â€¢ P403 (legacy hidden harder)"));

    const grid = el("div",{class:"ovr-grid"});
    const left = el("div",{class:"ovr-card"});
    const right = el("div",{class:"ovr-card"});
    left.appendChild(el("h2",null,"Live view (stable JSON)"));
    right.appendChild(el("h2",null,"Editor (read-only safe)"));

    const jsonBox = el("div"); left.appendChild(jsonBox);
    const ta = el("textarea",{class:"ovr-ta",spellcheck:"false"}); right.appendChild(ta);
    const msg = el("div",{class:"ovr-msg"},""); right.appendChild(msg);

    grid.appendChild(left); grid.appendChild(right);
    root.appendChild(grid);
    mount.prepend(root);

    const endpoint = await detectEndpoint();
    const r = await fetchJson(endpoint);
    msg.textContent = `endpoint=${endpoint} status=${r.status}`;
    ta.value = r.data ? JSON.stringify(r.data, null, 2) : (r.text || "");

    const viewerOk = await ensureViewerLoaded();
    if (viewerOk && window.VSP && window.VSP.jsonViewer){
      window.VSP.jsonViewer.render(jsonBox, { endpoint, payload: (r.data||{raw:r.text}) }, { title:"RuleOverrides", maxDepth: 8 });
    } else {
      jsonBox.innerHTML = `<pre style="white-space:pre-wrap;word-break:break-word;opacity:.9">${(r.text||"").slice(0,3000)}</pre>`;
    }

    log("rendered");
  }

  if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", main);
  else main();
})();
