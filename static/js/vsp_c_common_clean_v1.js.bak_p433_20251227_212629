/* VSP_C_COMMON_CLEAN_V1
   - Minimal, safe helpers (no override existing behavior)
   - installOnce registry to stop duplicate installers (P421-ready)
   - log wrappers
*/
(function(){
  'use strict';
  const W = window;
  W.VSP = W.VSP || {};

  // --- logging (prefix, can be silenced by setting VSP_LOG=0) ---
  const LOG_ON = (W.VSP_LOG === undefined) ? 1 : (W.VSP_LOG ? 1 : 0);
  function _pfx(){ return '[VSP]'; }
  W.VSP.log = function(){ if(!LOG_ON) return; try{ console.log(_pfx(), ...arguments); }catch(e){} };
  W.VSP.warn = function(){ if(!LOG_ON) return; try{ console.warn(_pfx(), ...arguments); }catch(e){} };
  W.VSP.err = function(){ if(!LOG_ON) return; try{ console.error(_pfx(), ...arguments); }catch(e){} };

  // --- DOM helpers (non-invasive) ---
  W.VSP.q  = W.VSP.q  || function(sel, root){ return (root||document).querySelector(sel); };
  W.VSP.qa = W.VSP.qa || function(sel, root){ return Array.prototype.slice.call((root||document).querySelectorAll(sel)); };
  W.VSP.on = W.VSP.on || function(el, ev, fn, opt){ if(el && el.addEventListener) el.addEventListener(ev, fn, opt||false); };

  // --- installOnce (idempotent) ---
  const _reg = W.VSP.__install_registry = W.VSP.__install_registry || Object.create(null);
  W.VSP.installOnce = W.VSP.installOnce || function(key, fn){
    try{
      if(_reg[key]) return false;
      _reg[key] = 1;
      fn && fn();
      return true;
    }catch(e){
      try{ W.VSP.err('installOnce failed', key, e); }catch(_) {}
      return false;
    }
  };

  // --- small utils ---
  W.VSP.nowISO = W.VSP.nowISO || function(){ try{ return new Date().toISOString(); }catch(e){ return ''; } };

  // mark loaded
  W.VSP.__c_common_clean_v1 = 1;
})();
