#!/usr/bin/env bash
set -euo pipefail
cd /home/test/Data/SECURITY_BUNDLE/ui

need(){ command -v "$1" >/dev/null 2>&1 || { echo "[ERR] missing: $1"; exit 2; }; }
need python3; need date

F="vsp_demo_app.py"
MARK="VSP_SERVE_FINDINGS_UNIFIED_P0_V1"

[ -f "$F" ] || { echo "[ERR] missing $F"; exit 3; }

TS="$(date +%Y%m%d_%H%M%S)"
cp -f "$F" "$F.bak_${MARK}_${TS}"
echo "[BACKUP] $F.bak_${MARK}_${TS}"

python3 - <<'PY'
from pathlib import Path
import re

p = Path("vsp_demo_app.py")
s = p.read_text(encoding="utf-8", errors="replace")

if "VSP_SERVE_FINDINGS_UNIFIED_P0_V1" in s:
    print("[OK] already patched:", "VSP_SERVE_FINDINGS_UNIFIED_P0_V1")
    raise SystemExit(0)

# ensure imports: send_file, Response not needed; we use send_file
if re.search(r"\bfrom\s+flask\s+import\b", s) and "send_file" not in s:
    s = re.sub(r"from\s+flask\s+import\s+([^\n]+)",
               lambda m: m.group(0) + ", send_file" if "send_file" not in m.group(1) else m.group(0),
               s, count=1)

# fallback: if import block is different, inject a dedicated import line near top
if "send_file" not in s:
    # inject after first flask import line or after "from flask import Flask"
    m = re.search(r"^from\s+flask\s+import\s+.*$", s, flags=re.M)
    if m:
        line = m.group(0)
        if "send_file" not in line:
            s = s[:m.end()] + "\nfrom flask import send_file\n" + s[m.end():]
    else:
        s = "from flask import send_file\n" + s

# choose injection point: after app = Flask(...) (first occurrence)
m = re.search(r"^app\s*=\s*Flask\([^\n]*\)\s*$", s, flags=re.M)
if not m:
    # fallback: insert near top after imports
    m = re.search(r"^\s*app\s*=", s, flags=re.M)

inj = r'''
# === %s ===
@app.get("/findings_unified.json")
def vsp_findings_unified_json():
    """
    Serve unified findings for UI widgets (banner/KPIs) in same-origin mode.
    Source file: UI_ROOT/findings_unified.json (generated by unify).
    """
    try:
        base = Path(__file__).resolve().parent
        fp = base / "findings_unified.json"
        if not fp.exists():
            # also allow the common layout: ../out_ci/... but we keep it simple
            return ("{\"ok\":false,\"error\":\"missing findings_unified.json\"}", 404, {"Content-Type":"application/json"})
        return send_file(str(fp), mimetype="application/json", as_attachment=False)
    except Exception as e:
        return (("{\"ok\":false,\"error\":\"%s\"}" % (str(e).replace('"','\\"'))), 500, {"Content-Type":"application/json"})
# === /%s ===
''' % ("VSP_SERVE_FINDINGS_UNIFIED_P0_V1", "VSP_SERVE_FINDINGS_UNIFIED_P0_V1")

if m:
    insert_at = m.end()
    s = s[:insert_at] + "\n" + inj + "\n" + s[insert_at:]
else:
    s = inj + "\n" + s

p.write_text(s, encoding="utf-8")
print("[OK] injected route /findings_unified.json into", p)
PY

python3 -m py_compile "$F"
echo "[OK] py_compile OK: $F"

echo "[VERIFY] curl -sS http://127.0.0.1:8910/findings_unified.json | jq .ok,.notes -C"
echo "[NEXT] restart UI 8910 then Ctrl+Shift+R"
