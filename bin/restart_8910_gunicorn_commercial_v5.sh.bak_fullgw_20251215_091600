#!/usr/bin/env bash
set -euo pipefail



ROOT="/home/test/Data/SECURITY_BUNDLE/ui"
cd "$ROOT"



# gunicorn runner (commercial-safe)
GUNI_BIN=""
if [ -x "$ROOT/.venv/bin/gunicorn" ]; then
  GUNI_BIN="$ROOT/.venv/bin/gunicorn"
elif command -v gunicorn >/dev/null 2>&1; then
  GUNI_BIN="gunicorn"
else
  GUNI_BIN="python3 -m gunicorn"
fi

mkdir -p out_ci

LOCK="out_ci/ui_8910.lock"
PIDFILE="out_ci/ui_8910.pid"
NOHUP="out_ci/ui_8910.nohup.log"
ACCESS="out_ci/ui_8910.access.log"
ERROR="out_ci/ui_8910.error.log"

HOST="127.0.0.1"
PORT="8910"
APP_MODULE="wsgi_vsp_ui_gateway_exportpdf_only:application"

# clear stale lock
rm -f "$LOCK"
: > "$LOCK"

# stop old pid
if [ -f "$PIDFILE" ]; then
  OLD="$(cat "$PIDFILE" 2>/dev/null || true)"
  if [ -n "${OLD:-}" ] && kill -0 "$OLD" 2>/dev/null; then
    echo "[STOP] pid=$OLD"
    kill "$OLD" 2>/dev/null || true
    sleep 1
    kill -9 "$OLD" 2>/dev/null || true
  fi
  rm -f "$PIDFILE" || true
fi

# free port
if command -v lsof >/dev/null 2>&1; then
  P="$(lsof -ti tcp:${PORT} 2>/dev/null || true)"
  if [ -n "${P:-}" ]; then
    echo "[KILL] port ${PORT} pid=$P"
    kill -9 $P 2>/dev/null || true
  fi
fi

# clean caches so module reloads
rm -rf __pycache__ 2>/dev/null || true
rm -rf "$ROOT"/__pycache__ 2>/dev/null || true

echo "== start gunicorn ${APP_MODULE} ${PORT} =="

nohup $GUNI_BIN "${APP_MODULE}" \
  --workers 2 \
  --worker-class gthread \
  --threads 4 \
  --timeout 60 \
  --graceful-timeout 15 \
  --chdir "$ROOT" \
  --pythonpath "$ROOT" \
  --bind "${HOST}:${PORT}" \
  --pid "$PIDFILE" \
  --access-logfile "$ROOT/$ACCESS" \
  --error-logfile "$ROOT/$ERROR" \
  >> "$ROOT/$NOHUP" 2>&1 &

sleep 1

if command -v ss >/dev/null 2>&1; then
  if ss -lntp | grep -q ":${PORT}"; then
    echo "[OK] ${PORT} listening"
  else
    echo "[ERR] ${PORT} not listening"
    echo "== last nohup =="; tail -n 120 "$ROOT/$NOHUP" || true
    echo "== last error =="; tail -n 120 "$ROOT/$ERROR" || true
    rm -f "$LOCK" || true
    exit 1
  fi
fi

curl -sS "http://${HOST}:${PORT}/healthz" >/dev/null 2>&1 && echo "[OK] healthz reachable" || echo "[WARN] healthz not reachable yet"
rm -f "$LOCK" || true
