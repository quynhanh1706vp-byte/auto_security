#!/usr/bin/env bash
set -euo pipefail

SVC="${VSP_UI_SVC:-vsp-ui-8910.service}"
BASE="${VSP_UI_BASE:-http://127.0.0.1:8910}"
WD="/home/test/Data/SECURITY_BUNDLE/ui"

need(){ command -v "$1" >/dev/null 2>&1 || { echo "[ERR] missing: $1"; exit 2; }; }
need sudo; need systemctl; need date; need grep; need sed; need head; need curl

TS="$(date +%Y%m%d_%H%M%S)"
OUT="/home/test/Data/SECURITY_BUNDLE/ui/out_ci"
mkdir -p "$OUT"
LOG="$OUT/p47_force_bind_ipv4_${TS}.txt"

ok(){ echo "[OK] $*" | tee -a "$LOG"; }
warn(){ echo "[WARN] $*" | tee -a "$LOG" >&2; }
fail(){ echo "[FAIL] $*" | tee -a "$LOG" >&2; exit 2; }

UNIT_PATH="$(systemctl show -p FragmentPath --value "$SVC" 2>/dev/null || true)"
[ -n "${UNIT_PATH:-}" ] || fail "cannot resolve unit FragmentPath for $SVC"
ok "unit=$UNIT_PATH"

# Extract ExecStart line from unit (known-good v4 bind line exists in your unit file)
EXECLINE="$(sudo grep -m1 -E '^ExecStart=' "$UNIT_PATH" | sed 's/^ExecStart=//')"
[ -n "${EXECLINE:-}" ] || fail "cannot read ExecStart= from unit"

# Force bind to 127.0.0.1:8910 regardless of what drop-ins did
# Replace any --bind X:8910 or --bind "[::]:8910" with --bind 127.0.0.1:8910
EXECLINE_FIXED="$(printf "%s" "$EXECLINE" \
  | sed -E 's/--bind[[:space:]]+"?\[[^]]+\]:8910"?/--bind 127.0.0.1:8910/g' \
  | sed -E 's/--bind[[:space:]]+[0-9a-zA-Z\.\:]+:8910/--bind 127.0.0.1:8910/g')"

ok "execstart_fixed (preview):"
echo "$EXECLINE_FIXED" | head -c 220 | sed 's/$/.../' | tee -a "$LOG"

OVDIR="/etc/systemd/system/${SVC}.d"
sudo mkdir -p "$OVDIR"

# Must sort after zzzz-999-final.conf
DROP="$OVDIR/zzzz-9999-bindv4.conf"
if sudo test -f "$DROP"; then
  sudo cp -f "$DROP" "${DROP}.bak_${TS}"
  ok "backup: ${DROP}.bak_${TS}"
fi

sudo tee "$DROP" >/dev/null <<EOF
# Auto-generated by p47_force_bind_ipv4_lastdropin_v1.sh at $TS
[Service]
# Reset then force ExecStart to IPv4 bind (last drop-in wins)
ExecStart=
ExecStart=$EXECLINE_FIXED

# Keep manager env pin for tools
Environment=VSP_UI_BASE=$BASE
WorkingDirectory=$WD
EOF

ok "wrote drop-in: $DROP"

sudo systemctl daemon-reload
sudo systemctl restart "$SVC"

ok "wait /vsp5 on 127.0.0.1:8910 ..."
pass=0
for i in $(seq 1 20); do
  code="$(curl -sS -o /dev/null -w "%{http_code}" --connect-timeout 1 --max-time 2 "http://127.0.0.1:8910/vsp5" 2>/dev/null || true)"
  if [ "$code" = "200" ]; then pass=1; break; fi
  sleep 0.4
done

if [ "$pass" -eq 1 ]; then
  ok "UP: http://127.0.0.1:8910/vsp5 => 200"
  ok "effective ExecStart (systemctl show -p ExecStart):"
  systemctl show "$SVC" -p ExecStart --no-pager | tee -a "$LOG" >/dev/null || true
  exit 0
fi

warn "still not reachable on v4; show status + last journal"
systemctl status "$SVC" --no-pager | tee -a "$LOG" >/dev/null || true
sudo journalctl -u "$SVC" --no-pager -n 120 | tee -a "$LOG" >/dev/null || true
fail "not healthy on 127.0.0.1:8910 (see $LOG)"
