#!/usr/bin/env bash
set -euo pipefail
cd /home/test/Data/SECURITY_BUNDLE/ui

SVC="${VSP_UI_SVC:-vsp-ui-8910.service}"
BASE="${VSP_UI_BASE:-http://127.0.0.1:8910}"
WD="/home/test/Data/SECURITY_BUNDLE/ui"

VENV_PY="$WD/../.venv/bin/python"
VENV_GUNICORN="$WD/../.venv/bin/gunicorn"

need(){ command -v "$1" >/dev/null 2>&1 || { echo "[ERR] missing: $1"; exit 2; }; }
need sudo; need systemctl; need date; need curl; need grep; need head

TS="$(date +%Y%m%d_%H%M%S)"
OUT="out_ci"
mkdir -p "$OUT"
LOG="$OUT/p47_force_execstart_${TS}.txt"

ok(){ echo "[OK] $*" | tee -a "$LOG"; }
fail(){ echo "[FAIL] $*" | tee -a "$LOG" >&2; exit 2; }

ok "== [P47-FIX] force ExecStart gunicorn bind 8910 =="
ok "SVC=$SVC BASE=$BASE WD=$WD"

[ -x "$VENV_PY" ] || fail "missing venv python: $VENV_PY (expected ../.venv)"
if [ ! -x "$VENV_GUNICORN" ]; then
  ok "gunicorn not found at $VENV_GUNICORN -> try python -m gunicorn"
  USE_PY_M=1
else
  USE_PY_M=0
fi

# Decide module
MOD=""
if [ -f "$WD/wsgi_vsp_ui_gateway.py" ]; then MOD="wsgi_vsp_ui_gateway:app"; fi
if [ -z "$MOD" ] && [ -f "$WD/vsp_demo_app.py" ]; then MOD="vsp_demo_app:app"; fi
[ -n "$MOD" ] || fail "cannot find wsgi_vsp_ui_gateway.py or vsp_demo_app.py to serve"

ok "module=$MOD"

# Quick import test (best-effort)
set +e
"$VENV_PY" -c "import importlib; m=importlib.import_module('${MOD%%:*}'); assert hasattr(m,'app'); print('import_ok')" >>"$LOG" 2>&1
rc_imp=$?
set -e
[ "$rc_imp" -eq 0 ] || ok "import test not clean (see log) but continue to run gunicorn"

OVDIR="/etc/systemd/system/${SVC}.d"
OVCONF="${OVDIR}/override.conf"

sudo mkdir -p "$OVDIR"
if sudo test -f "$OVCONF"; then
  sudo cp -f "$OVCONF" "${OVCONF}.bak_force_${TS}"
  ok "backup override: ${OVCONF}.bak_force_${TS}"
fi

# IMPORTANT: reset ExecStart then set new ExecStart
if [ "$USE_PY_M" -eq 1 ]; then
  EXEC="ExecStart=$VENV_PY -m gunicorn --workers 2 --bind 127.0.0.1:8910 --timeout 60 $MOD"
else
  EXEC="ExecStart=$VENV_GUNICORN --workers 2 --bind 127.0.0.1:8910 --timeout 60 $MOD"
fi

sudo tee "$OVCONF" >/dev/null <<EOF
# Auto-generated by p47_force_execstart_gunicorn_8910_v1.sh at $TS
[Service]
WorkingDirectory=$WD
Environment=VSP_UI_BASE=$BASE
Restart=always
RestartSec=2
TimeoutStartSec=25
TimeoutStopSec=15

# Reset inherited ExecStart then force our known-good command
ExecStart=
$EXEC
EOF

ok "wrote override: $OVCONF"
sudo systemctl daemon-reload
sudo systemctl restart "$SVC"

# Wait up to ~12 tries for /vsp5 (no networkidle)
ok "wait /vsp5 200..."
pass=0
for i in $(seq 1 12); do
  code="$(curl -sS -o /dev/null -w "%{http_code}" --connect-timeout 1 --max-time 2 "http://127.0.0.1:8910/vsp5" 2>/dev/null || true)"
  if [ "$code" = "200" ]; then pass=1; break; fi
  sleep 1
done

if [ "$pass" -eq 1 ]; then
  ok "UP: http://127.0.0.1:8910/vsp5 => 200"
  systemctl is-active "$SVC" | tee -a "$LOG" >/dev/null || true
  exit 0
fi

ok "still not up -> show status + journal tail"
systemctl status "$SVC" --no-pager | tee -a "$LOG" >/dev/null || true
sudo journalctl -u "$SVC" --no-pager -n 120 | tee -a "$LOG" >/dev/null || true
fail "service not healthy on 8910 after forcing ExecStart (see $LOG)"
