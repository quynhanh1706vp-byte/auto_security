#!/usr/bin/env bash
set -euo pipefail
cd /home/test/Data/SECURITY_BUNDLE/ui

BASE="${VSP_UI_BASE:-http://127.0.0.1:8910}"
RELROOT="out_ci/releases"
TS="$(date +%Y%m%d_%H%M%S)"
OUT="out_ci/p525v4_${TS}"
mkdir -p "$OUT"

log(){ echo "$*" | tee -a "$OUT/run.log"; }
need(){ command -v "$1" >/dev/null 2>&1 || { echo "[ERR] missing: $1"; exit 2; }; }
need curl; need tar; need sha256sum; need head; need ls; need grep; need wc

latest_dir="$(ls -1dt "$RELROOT"/RELEASE_UI_* 2>/dev/null | head -n1 || true)"
[ -n "$latest_dir" ] || { echo "[FAIL] no RELEASE_UI_* under $RELROOT"; exit 2; }

tgz="$(ls -1 "$latest_dir"/support_bundle_*.tgz 2>/dev/null | head -n1 || true)"
[ -n "$tgz" ] || { echo "[FAIL] no support_bundle_*.tgz found in $latest_dir"; exit 2; }

log "[P525v4] BASE=$BASE"
log "[P525v4] latest_dir=$latest_dir"
log "[P525v4] tgz=$tgz"

log "== [1] service readiness =="
curl -fsS --connect-timeout 2 --max-time 6 "$BASE/healthz" >/dev/null && log "[OK] healthz 200" || { log "[FAIL] healthz fail"; exit 3; }
curl -fsS --connect-timeout 2 --max-time 6 "$BASE/readyz"  >/dev/null && log "[OK] readyz 200"  || { log "[FAIL] readyz fail"; exit 3; }

log "== [2] sha256 verify =="
if [ ! -f "$latest_dir/SHA256SUMS.txt" ]; then
  log "[WARN] missing SHA256SUMS -> generating"
  ( cd "$latest_dir" && sha256sum * > SHA256SUMS.txt )
  log "[OK] SHA256SUMS generated"
fi

log "\=\= \[3\] contract check \(NEW commercial\) \=\="

log "== [3] contract check (NEW commercial) =="
# --- P570_CHECK_INSIDE_CODE_TGZ ---
code_tgz="$(ls -1 "$latest_dir"/VSP_UI_*.tgz 2>/dev/null | head -n1 || true)"
[ -n "$code_tgz" ] || { echo "[FAIL] missing VSP_UI_*.tgz in $latest_dir"; exit 5; }

# Must exist INSIDE code tgz (not only workspace)
required_inside=(
  "config/systemd_unit.template"
  "config/logrotate_vsp-ui.template"
  "config/production.env.example"
  "RELEASE_NOTES.md"
  "bin/ui_gate.sh"
  "bin/verify_release_and_customer_smoke.sh"
  "bin/pack_release.sh"
  "bin/ops.sh"
)

# --- P571_PATHMATCH_V1 ---
tar_list="$(tar -tzf "$code_tgz")"

has_in_tgz(){
  local r="$1"
  echo "$tar_list" | grep -qx "$r" && return 0
  echo "$tar_list" | grep -qx "./$r" && return 0
  return 1
}

missing_inside=()
for r in "${required_inside[@]}"; do
  if ! has_in_tgz "$r"; then
    missing_inside+=("$r")
  fi
done
# --- END P571_PATHMATCH_V1 ---

if [ "${#missing_inside[@]}" -gt 0 ]; then
  echo "MISSING_IN_CODE_TGZ:${missing_inside[*]}"
  exit 5
fi

log "[OK] contract inside code tgz PASS: $(basename "$code_tgz")"
exit 0
# --- END P570_CHECK_INSIDE_CODE_TGZ ---


for f in config/systemd_unit.template config/logrotate_vsp-ui.template config/production.env.example RELEASE_NOTES.md; do
  [ -f "/home/test/Data/SECURITY_BUNDLE/ui/$f" ] || missing+=("$f")
done

# Also require 4 entrypoints exist
for f in bin/ui_gate.sh bin/verify_release_and_customer_smoke.sh bin/pack_release.sh bin/ops.sh; do
  [ -e "/home/test/Data/SECURITY_BUNDLE/ui/$f" ] || missing+=("$f")
done

# MUST NOT require p523 anymore (it is legacy by design)
if [ "${#missing[@]}" -gt 0 ]; then
  echo "MISSING:${missing[*]}"
  exit 5
fi

log "[OK] contract check PASS"
