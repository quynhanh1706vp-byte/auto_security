#!/usr/bin/env bash
set -euo pipefail
cd /home/test/Data/SECURITY_BUNDLE/ui

SVC="${VSP_UI_SVC:-vsp-ui-8910.service}"
BASE="${VSP_UI_BASE:-http://127.0.0.1:8910}"
WD="/home/test/Data/SECURITY_BUNDLE/ui"

OUT="out_ci"
mkdir -p "$OUT"

ERRLOG="$WD/out_ci/ui_8910.error.log"
LOGR="/etc/logrotate.d/vsp-ui-8910"

need(){ command -v "$1" >/dev/null 2>&1 || { echo "[ERR] missing: $1"; exit 2; }; }
need date; need awk; need sed; need grep; need head; need tail; need wc; need curl; need python3; need systemctl; need sudo

TS="$(date +%Y%m%d_%H%M%S)"
LOG_TXT="$OUT/p47_service_hardening_${TS}.txt"
LOG_JSON="$OUT/p47_service_hardening_${TS}.json"
VERDICT="$OUT/p47_verdict_${TS}.json"

ok(){ echo "[OK] $*" | tee -a "$LOG_TXT"; }
warn(){ echo "[WARN] $*" | tee -a "$LOG_TXT" >&2; }
fail(){ echo "[FAIL] $*" | tee -a "$LOG_TXT" >&2; write_verdict 0; exit 2; }

write_verdict(){
  local pass="$1"
  python3 - <<PY > "$VERDICT"
import json
print(json.dumps({
  "ok": bool($pass),
  "ts": "$TS",
  "service": "$SVC",
  "base": "$BASE",
  "workdir": "$WD",
  "errlog": "$ERRLOG",
  "logrotate": "$LOGR",
  "logs": {"txt":"$LOG_TXT","json":"$LOG_JSON","verdict":"$VERDICT"}
}, indent=2))
PY
  ok "verdict: $VERDICT"
}

echo "== [P47] service hardening ==" | tee "$LOG_TXT"
echo "[INFO] SVC=$SVC BASE=$BASE WD=$WD" | tee -a "$LOG_TXT"

# ---- A) Backup current unit + override (if any) ----
ok "== [A] backup unit/override =="
UNIT_PATH="$(systemctl show -p FragmentPath --value "$SVC" 2>/dev/null || true)"
[ -n "${UNIT_PATH:-}" ] || fail "cannot resolve unit FragmentPath for $SVC"
ok "unit: $UNIT_PATH"

sudo cp -f "$UNIT_PATH" "${UNIT_PATH}.bak_${TS}" || true
ok "backup: ${UNIT_PATH}.bak_${TS}"

OVDIR="/etc/systemd/system/${SVC}.d"
OVCONF="${OVDIR}/override.conf"
if sudo test -f "$OVCONF"; then
  sudo cp -f "$OVCONF" "${OVCONF}.bak_${TS}"
  ok "backup: ${OVCONF}.bak_${TS}"
else
  ok "no existing override.conf (will create)"
fi

# ---- B) Install/Update systemd override ----
ok "== [B] write systemd override.conf =="
sudo mkdir -p "$OVDIR"

# We only set runtime hardening settings here, not changing ExecStart.
# Keep it safe: pin WorkingDirectory + restart policy + timeouts + env BASE.
sudo tee "$OVCONF" >/dev/null <<EOF
# Auto-generated by p47_service_hardening_v1.sh at $TS
[Service]
WorkingDirectory=$WD
Restart=always
RestartSec=2
TimeoutStartSec=20
TimeoutStopSec=15

# Pin base for scripts/tools that read it from manager env
Environment=VSP_UI_BASE=$BASE
EOF

ok "wrote: $OVCONF"

ok "daemon-reload + restart"
sudo systemctl daemon-reload
sudo systemctl restart "$SVC"

# ---- C) Port sanity (avoid 8911/8910 mix) ----
ok "== [C] port sanity =="
# Must be listening on 8910 if BASE is 127.0.0.1:8910
# We keep it light: curl root + /vsp5 should be 200 quickly.
set +e
code_root="$(curl -sS -o /dev/null -w "%{http_code}" --connect-timeout 2 --max-time 4 "$BASE/" 2>/dev/null)"
code_vsp5="$(curl -sS -o /dev/null -w "%{http_code}" --connect-timeout 2 --max-time 4 "$BASE/vsp5" 2>/dev/null)"
set -e
echo "[INFO] curl / => $code_root ; /vsp5 => $code_vsp5" | tee -a "$LOG_TXT"
[ "$code_vsp5" = "200" ] || fail "BASE not healthy after restart (expected /vsp5=200)"

# ---- D) Healthcheck stability + speed ----
ok "== [D] /api/vsp/selfcheck_p0 speed =="
# measure time_total
set +e
time_total="$(curl -sS -o /tmp/p47_selfcheck_${TS}.json -w "%{time_total}" --connect-timeout 2 --max-time 6 "$BASE/api/vsp/selfcheck_p0" 2>/dev/null)"
rc=$?
set -e
[ "$rc" -eq 0 ] || fail "selfcheck_p0 curl failed"
ok "selfcheck time_total=${time_total}s (target: fast & stable)"

# Basic json sanity: ok:true
python3 - <<PY >>"$LOG_TXT" 2>&1 || fail "selfcheck_p0 json not ok:true"
import json,sys
p="/tmp/p47_selfcheck_${TS}.json"
j=json.load(open(p,"r",encoding="utf-8"))
assert j.get("ok") is True, j
print("[OK] selfcheck ok:true")
PY

# ---- E) logrotate (prevent errlog growth) ----
ok "== [E] logrotate install =="
# Create logrotate rule (safe defaults)
sudo tee "$LOGR" >/dev/null <<EOF
$ERRLOG {
  daily
  rotate 14
  compress
  delaycompress
  missingok
  notifempty
  copytruncate
  maxsize 50M
}
EOF
ok "wrote: $LOGR"

# Try a dry-run if logrotate exists
if command -v logrotate >/dev/null 2>&1; then
  set +e
  sudo logrotate -d "$LOGR" >>"$LOG_TXT" 2>&1
  rc_lr=$?
  set -e
  [ "$rc_lr" -eq 0 ] || warn "logrotate -d returned rc=$rc_lr (see log)"
  ok "logrotate -d executed"
else
  warn "logrotate not installed; rule created but not testable"
fi

# ---- F) Summary JSON + PASS ----
python3 - <<PY > "$LOG_JSON"
import json
print(json.dumps({
  "ok": True,
  "ts": "$TS",
  "service": "$SVC",
  "base": "$BASE",
  "override_conf": "$OVCONF",
  "unit_path": "$UNIT_PATH",
  "logrotate": "$LOGR",
  "checks": {
    "vsp5_200": True,
    "selfcheck_ok": True,
    "selfcheck_time_total": "$time_total"
  }
}, indent=2))
PY

write_verdict 1
ok "DONE: PASS"
