#!/usr/bin/env bash
set -euo pipefail
cd /home/test/Data/SECURITY_BUNDLE/ui

BASE="${VSP_UI_BASE:-http://127.0.0.1:8910}"
OUT="out_ci/p523_$(date +%Y%m%d_%H%M%S)"
mkdir -p "$OUT"

fail(){ echo "[FAIL] $*" | tee -a "$OUT/gate.log"; exit 1; }
ok(){ echo "[OK] $*" | tee -a "$OUT/gate.log"; }

pages=(/vsp5 /runs /data_source /settings /rule_overrides)
apis=(/api/healthz /api/readyz /api/vsp/top_findings_v2?limit=5 /api/ui/runs_v3?limit=10&include_ci=1)

ok "BASE=$BASE"
ok "OUT=$OUT"

# 1) HTML pages must return 200 and not be empty/blank
for p in "${pages[@]}"; do
  f="$OUT/$(echo "$p" | tr '/?' '__').html"
  code="$(curl -sS -o "$f" -w "%{http_code}" "$BASE$p" || true)"
  [ "$code" = "200" ] || fail "$p http=$code"
  sz="$(wc -c < "$f" | tr -d ' ')"
  [ "$sz" -ge 800 ] || fail "$p too small (${sz} bytes)"
  grep -qiE "<html|<!doctype" "$f" || fail "$p no html doctype"
  ok "$p 200 size=$sz"
done

# 2) APIs must return 200 (readyz can be 503 only if readiness broken)
for a in "${apis[@]}"; do
  hdr="$OUT/api_$(echo "$a" | tr '/?&=' '____').hdr"
  body="$OUT/api_$(echo "$a" | tr '/?&=' '____').json"
  code="$(curl -sS -D "$hdr" -o "$body" -w "%{http_code}" "$BASE$a" || true)"
  if [[ "$a" == "/api/readyz" ]]; then
    [ "$code" = "200" ] || fail "readyz not ready (http=$code). Fix readiness first."
  else
    [ "$code" = "200" ] || fail "$a http=$code"
  fi
  ok "$a http=$code"
done

# 3) CSP headers existence sanity (not full policy parse)
hdr="$OUT/vsp5_headers.txt"
curl -sS -D "$hdr" -o /dev/null "$BASE/vsp5"
grep -qi '^Content-Security-Policy:' "$hdr" || fail "missing CSP header on /vsp5"
ok "CSP header present"

# 4) Optional: Playwright visual check (if available)
if command -v node >/dev/null 2>&1 && node -e 'require("playwright");' >/dev/null 2>&1; then
  ok "Playwright detected -> running visual smoke"
  cat > "$OUT/pw_smoke.mjs" <<'JS'
import { chromium } from "playwright";
const base = process.env.VSP_UI_BASE || "http://127.0.0.1:8910";
const pages = ["/vsp5","/runs","/data_source","/settings","/rule_overrides"];
const out = process.env.OUT_DIR || ".";
const browser = await chromium.launch();
const page = await browser.newPage();
page.on("console", msg => {
  const t = msg.type();
  if (t === "error") console.log("[CONSOLE_ERROR]", msg.text());
});
for (const p of pages) {
  const url = base + p;
  await page.goto(url, { waitUntil: "domcontentloaded", timeout: 20000 });
  // basic DOM sanity (avoid "blank app")
  const html = await page.content();
  if (html.length < 800) throw new Error(`Too small HTML for ${p}`);
  await page.waitForTimeout(400);
  await page.screenshot({ path: `${out}/shot_${p.replaceAll("/","_")}.png`, fullPage: true });
}
await browser.close();
console.log("[OK] playwright visual smoke done");
JS
  OUT_DIR="$OUT" VSP_UI_BASE="$BASE" node "$OUT/pw_smoke.mjs" | tee -a "$OUT/gate.log"
  ok "Screenshots saved under $OUT/shot_*.png"
else
  ok "Playwright not found -> skipped visual smoke (curl gate still enforced)"
fi

ok "P523 PASS => UI commercial gate OK"
echo "EVIDENCE: $OUT"
