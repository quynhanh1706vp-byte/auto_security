#!/usr/bin/env bash
set -euo pipefail
BASE="${VSP_UI_BASE:-http://127.0.0.1:8910}"
need(){ command -v "$1" >/dev/null 2>&1 || { echo "[ERR] missing: $1"; exit 2; }; }
need curl; need grep; need head

ok(){ echo "[OK]   $*"; }
miss(){ echo "[MISS] $*"; }

tmp="$(mktemp -d /tmp/vsp_ui_feature_gapb_XXXXXX)"
trap 'rm -rf "$tmp"' EXIT

curl -fsS "$BASE/vsp5" -o "$tmp/_vsp5.html"
curl -fsS "$BASE/settings" -o "$tmp/_settings.html"
curl -fsS "$BASE/rule_overrides" -o "$tmp/_ro.html"

DASH_JS="static/js/vsp_dashboard_luxe_v1.js"
BUNDLE_JS="static/js/vsp_bundle_tabs5_v1.js"

echo "== DASHBOARD banner (degraded KPI) =="

# 1) API indicates degraded?
K="$(curl -fsS "$BASE/api/vsp/dash_kpis" | head -c 400)"
C="$(curl -fsS "$BASE/api/vsp/dash_charts" | head -c 400)"
echo "dash_kpis: $K"
echo "dash_charts: $C"
echo

# 2) HTML includes the JS assets?
if grep -q "vsp_dashboard_luxe_v1.js" "$tmp/_vsp5.html"; then ok "vsp5 includes vsp_dashboard_luxe_v1.js"; else miss "vsp5 missing vsp_dashboard_luxe_v1.js include"; fi

# 3) JS contains marker?
if grep -q "VSP_P2_DEGRADED_BANNER_V1" "$DASH_JS"; then ok "marker in $DASH_JS"; else miss "marker missing in $DASH_JS"; fi

# 4) If API empty, we consider banner requirement satisfied (JS will render)
if echo "$K" | grep -q '"kpis"\s*:\s*{\s*}'; then
  ok "KPI empty => banner should render (JS runtime)"
else
  ok "KPI not empty => banner not required"
fi

echo
echo "== SETTINGS policy/tool panel =="
if grep -q "vsp_bundle_tabs5_v1.js" "$tmp/_settings.html"; then ok "settings includes vsp_bundle_tabs5_v1.js"; else miss "settings missing bundle include"; fi
if grep -q "VSP_P2_SETTINGS_TOOL_POLICY_PANEL_V1" "$BUNDLE_JS"; then ok "settings panel marker in bundle"; else miss "settings panel marker missing"; fi

echo
echo "== RULE OVERRIDES save/apply =="
if grep -q "VSP_P2_RULE_OVERRIDES_SAVE_CONTRACT_RULES_V1C" "$BUNDLE_JS"; then ok "save contract marker in bundle"; else miss "save contract marker missing"; fi

# API write test (non-destructive)
R="$(curl -fsS -X POST "$BASE/api/ui/rule_overrides_v2" -H 'Content-Type: application/json' --data '{"schema":"rules_v1","rules":[],"notes":"feature-gapb"}' | head -c 250)"
echo "POST rule_overrides => $R"
if echo "$R" | grep -q '"ok"\s*:\s*true'; then ok "rule_overrides save works"; else miss "rule_overrides save failed"; fi

echo
echo "[OK] v1b is JS-aware; ignore raw-HTML heuristics for runtime UI."
