#!/usr/bin/env bash
set -euo pipefail
cd /home/test/Data/SECURITY_BUNDLE/ui

F="wsgi_vsp_ui_gateway.py"
SVC="${VSP_UI_SVC:-vsp-ui-8910.service}"
[ -f "$F" ] || { echo "[ERR] missing $F"; exit 2; }

TS="$(date +%Y%m%d_%H%M%S)"
cp -f "$F" "${F}.bak_p31_vsp5cache_${TS}"
echo "[BACKUP] ${F}.bak_p31_vsp5cache_${TS}"

python3 - <<'PY'
from pathlib import Path
import py_compile, sys
p=Path("wsgi_vsp_ui_gateway.py")
s=p.read_text(encoding="utf-8", errors="replace")

MARK="VSP_P31_VSP5_HTML_CACHE_V1"
if MARK in s:
    print("[OK] already patched", MARK)
    py_compile.compile(str(p), doraise=True)
    sys.exit(0)

block=r'''
# ===================== VSP_P31_VSP5_HTML_CACHE_V1 =====================
# Cache /vsp5 HTML shell (RAM + disk) with short TTL to reduce cold/warm latency.
try:
    import os, time, re, hashlib
    from pathlib import Path as _Path

    _VSP_P31_DIR = _Path("/home/test/Data/SECURITY_BUNDLE/ui/out_ci/cache_vsp5")
    _VSP_P31_DIR.mkdir(parents=True, exist_ok=True)

    _VSP_P31_TTL = int(os.environ.get("VSP_P31_VSP5_TTL_SEC", "30"))
    _VSP_P31_RAM = {}  # key -> (ts, body_bytes)

    def _vsp_p31__key(environ):
        # vary by query to keep rid=... variants correct
        pi = (environ.get("PATH_INFO") or "")
        qs = (environ.get("QUERY_STRING") or "")
        raw = (pi+"?"+qs).encode("utf-8", errors="ignore")
        return hashlib.sha256(raw).hexdigest()

    def _vsp_p31__target(environ):
        return (environ.get("PATH_INFO") or "") == "/vsp5"

    def _vsp_p31__disk(key):
        return (_VSP_P31_DIR / f"{key}.html", _VSP_P31_DIR / f"{key}.ts")

    def _vsp_p31__read_disk(key):
        f,t=_vsp_p31__disk(key)
        if not f.is_file() or not t.is_file(): return None
        try:
            ts=float(t.read_text().strip() or "0")
            if (time.time()-ts) > _VSP_P31_TTL: return None
            b=f.read_bytes()
            return (ts,b) if b else None
        except Exception:
            return None

    def _vsp_p31__write_disk(key, body):
        try:
            f,t=_vsp_p31__disk(key)
            f.write_bytes(body)
            t.write_text(str(time.time()))
        except Exception:
            pass

    def _vsp_p31__wrap(_wsgi_app):
        if not callable(_wsgi_app): return _wsgi_app
        def _app(environ, start_response):
            try:
                if _vsp_p31__target(environ):
                    key=_vsp_p31__key(environ)
                    it=_VSP_P31_RAM.get(key)
                    if it:
                        ts, body = it
                        if (time.time()-ts) <= _VSP_P31_TTL and body:
                            start_response("200 OK", [
                                ("Content-Type","text/html; charset=utf-8"),
                                ("Cache-Control","no-store"),
                                ("X-VSP-P31-VSP5-CACHE","HIT-RAM"),
                            ])
                            return [body]
                    dk=_vsp_p31__read_disk(key)
                    if dk:
                        ts, body = dk
                        _VSP_P31_RAM[key]=(ts, body)
                        start_response("200 OK", [
                            ("Content-Type","text/html; charset=utf-8"),
                            ("Cache-Control","no-store"),
                            ("X-VSP-P31-VSP5-CACHE","HIT-DISK"),
                        ])
                        return [body]

                    status_box={"st":None}
                    def _sr(st, hdrs, exc_info=None):
                        status_box["st"]=st
                        return start_response(st, hdrs, exc_info)

                    resp=_wsgi_app(environ,_sr)
                    chunks=[]
                    for ch in resp:
                        if ch is None: continue
                        if isinstance(ch,str): ch=ch.encode("utf-8","ignore")
                        chunks.append(ch)
                    body=b"".join(chunks)

                    if (status_box["st"] or "").startswith("200") and body:
                        ts=time.time()
                        _VSP_P31_RAM[key]=(ts, body)
                        _vsp_p31__write_disk(key, body)
                    return [body]
            except Exception:
                pass
            return _wsgi_app(environ, start_response)
        return _app

    if "application" in globals() and callable(globals().get("application")):
        globals()["application"]=_vsp_p31__wrap(globals()["application"])
    if "app" in globals() and callable(globals().get("app")):
        globals()["app"]=_vsp_p31__wrap(globals()["app"])

    print("[VSP_P31] /vsp5 cache installed TTL=%ss" % _VSP_P31_TTL)
except Exception as _e:
    print("[VSP_P31] ERROR:", _e)
# ===================== /VSP_P31_VSP5_HTML_CACHE_V1 =====================
'''
p.write_text(s.rstrip()+"\n\n"+block+"\n", encoding="utf-8")
print("[OK] appended", MARK)
py_compile.compile(str(p), doraise=True)
print("[OK] py_compile OK")
PY

if command -v systemctl >/dev/null 2>&1; then
  echo "== [RESTART] $SVC =="
  sudo systemctl restart "$SVC"
fi

BASE="${BASE:-http://127.0.0.1:8910}"
echo "== [SMOKE] /vsp5 cache header + time =="
for i in $(seq 1 40); do
  curl -fsS -o /dev/null "$BASE/api/vsp/selfcheck_p0" && break || sleep 0.2
done
echo "-- first --"
curl -sS -D- -o /dev/null -w "time_total=%{time_total}\n" "$BASE/vsp5" | awk 'BEGIN{IGNORECASE=1} /^HTTP\/|^X-VSP-P31-VSP5-CACHE:/ {print}'
echo "-- second --"
curl -sS -D- -o /dev/null -w "time_total=%{time_total}\n" "$BASE/vsp5" | awk 'BEGIN{IGNORECASE=1} /^HTTP\/|^X-VSP-P31-VSP5-CACHE:/ {print}'
