#!/usr/bin/env bash
set -euo pipefail
cd /home/test/Data/SECURITY_BUNDLE/ui

BASE="${BASE:-http://127.0.0.1:8910}"
BUNDLE="${BUNDLE:-/home/test/Data/SECURITY_BUNDLE}"
TS="$(date +%Y%m%d_%H%M%S)"

echo "== VSP ISO EVIDENCE PACK P4 =="
echo "[BASE]=$BASE [TS]=$TS"

# 1) resolve RID + RUN_DIR
J="out_ci/_latest_rid_${TS}.json"
mkdir -p out_ci
curl -sS "$BASE/api/vsp/latest_rid_v1?ts=$TS" > "$J"
RID="$(python3 -c 'import json,sys; j=json.load(open(sys.argv[1])); print(j.get("rid") or j.get("ci_rid") or "")' "$J")"
RUN_DIR="$(python3 -c 'import json,sys; j=json.load(open(sys.argv[1])); print(j.get("ci_run_dir") or "")' "$J")"
[ -n "${RID:-}" ] || { echo "[ERR] RID empty"; exit 2; }
[ -d "${RUN_DIR:-}" ] || { echo "[ERR] RUN_DIR missing: $RUN_DIR"; exit 3; }
echo "[RID]=$RID"
echo "[RUN_DIR]=$RUN_DIR"

# 2) write ISO evidence under report/__meta/iso
ISO_DIR="$RUN_DIR/report/__meta/iso"
mkdir -p "$ISO_DIR"

python3 - <<PY
import os, json, hashlib, time
from pathlib import Path

rid=os.environ.get("RID","")
run_dir=Path(os.environ["RUN_DIR"])
iso_dir=Path(os.environ["ISO_DIR"])

def fmeta(p: Path):
    if not p.exists(): 
        return {"path": str(p), "exists": False}
    h=hashlib.sha256()
    try:
        with p.open("rb") as f:
            for ch in iter(lambda: f.read(1024*1024), b""):
                h.update(ch)
        return {"path": str(p), "exists": True, "size": p.stat().st_size, "sha256": h.hexdigest()}
    except Exception as e:
        return {"path": str(p), "exists": True, "size": p.stat().st_size, "sha256_err": str(e)}

# common artifacts (safe list)
candidates = [
  run_dir/"run_gate_summary.json",
  run_dir/"run_gate.json",
  run_dir/"run_manifest.json",
  run_dir/"findings_unified.json",
  run_dir/"reports"/"findings_unified.sarif",
  run_dir/"report"/"findings.json",
  run_dir/"report"/"summary_matrix.csv",
  run_dir/"report"/"security_resilient.html",
]
# tool outputs (exist-only)
tool_paths = [
  run_dir/"semgrep"/"semgrep.json",
  run_dir/"gitleaks"/"gitleaks.json",
  run_dir/"kics"/"kics.json",
  run_dir/"trivy"/"fs.json",
  run_dir/"grype"/"grype.json",
  run_dir/"syft"/"sbom.json",
  run_dir/"bandit"/"results.json",
  run_dir/"codeql"/"results.sarif",
]
# report tgz + sha
for p in run_dir.glob("*__REPORT.tgz"):
    candidates.append(p)
for p in [run_dir/"SHA256SUMS.txt"]:
    candidates.append(p)

evidence = {
  "schema": "VSP_ISO_EVIDENCE_INDEX_P4_V1",
  "rid": rid,
  "run_dir": str(run_dir),
  "created_at": time.strftime("%Y-%m-%dT%H:%M:%S%z"),
  "host": os.uname().nodename,
  "user": os.environ.get("USER",""),
  "artifacts": [fmeta(p) for p in candidates + tool_paths],
}

(iso_dir/"ISO_EVIDENCE_INDEX.json").write_text(json.dumps(evidence, indent=2), encoding="utf-8")

# Minimal ISO 27001:2022 mapping (practical for CIO/DepSecOps)
rows = [
 ("A.5.8","Information security in project management","run_manifest.json / run_gate.json / audit bundle","Platform/Gate"),
 ("A.5.23","Information security for use of cloud services","trivy/grype/syft outputs (SBOM+vuln)","Trivy+Grype+Syft"),
 ("A.8.8","Management of technical vulnerabilities","findings.json + run_gate_summary.json + tool outputs","All 8 tools"),
 ("A.8.9","Configuration management","settings endpoints + VERSION.txt + tool config in bundle","UI/Settings"),
 ("A.8.15","Logging","ui_8910.access.log/ui_8910.error.log (if bundled)","UI Gateway"),
 ("A.8.28","Secure coding","semgrep/bandit/codeql findings + severities","Semgrep+Bandit+CodeQL"),
 ("A.8.32","Change management","Rule Overrides (policy exceptions tracked)","Rule Overrides"),
]
csv = "control,objective,evidence,source\n" + "\n".join([",".join(map(lambda x: '"' + x.replace('"','""') + '"', r)) for r in rows]) + "\n"
(iso_dir/"ISO_27001_MAP.csv").write_text(csv, encoding="utf-8")
print("[OK] wrote", iso_dir/"ISO_EVIDENCE_INDEX.json")
print("[OK] wrote", iso_dir/"ISO_27001_MAP.csv")
PY

# 3) ensure pack_report includes iso meta (patch once)
PR="$BUNDLE/bin/pack_report.sh"
if grep -q "VSP_PACK_REPORT_INCLUDE_ISO_P4_V1" "$PR"; then
  echo "[OK] pack_report already ISO-enabled"
else
  TS2="$(date +%Y%m%d_%H%M%S)"
  cp -f "$PR" "$PR.bak_iso_${TS2}"
  echo "[BACKUP] $PR.bak_iso_${TS2}"
  python3 - <<'PY'
from pathlib import Path
p=Path("/home/test/Data/SECURITY_BUNDLE/bin/pack_report.sh")
s=p.read_text(encoding="utf-8", errors="replace")
mark="VSP_PACK_REPORT_INCLUDE_ISO_P4_V1"
if mark in s:
    raise SystemExit(0)
needle='for f in "$REP/security_resilient.html" "$REP/findings.json" "$REP/findings.csv" "$REP/summary_matrix.csv" "$VER_DIR/VERSION.txt"; do'
if needle not in s:
    print("[WARN] cannot find insertion needle; skip patch safely")
    raise SystemExit(0)
ins = needle + "\n" + '  # ' + mark + ': include ISO meta if present\n' + '  if [ -d "$VER_DIR/iso" ]; then\n' + '    for z in "$VER_DIR"/iso/*; do [ -e "$z" ] && FILES+=("${z#$RUN_DIR/}"); done\n' + '  fi\n'
s=s.replace(needle, ins, 1)
p.write_text(s, encoding="utf-8")
print("[OK] patched pack_report to include iso meta")
PY
  bash -n "$PR"
fi

# 4) rebuild report tgz + verify sha
echo "== rebuild report tgz =="
"$BUNDLE/bin/pack_report.sh" "$RUN_DIR"
echo "== verify sha =="
( cd "$RUN_DIR" && sha256sum -c SHA256SUMS.txt )

# 5) repack audit bundle (includes refreshed report tgz + iso meta)
echo "== repack audit bundle =="
bash /home/test/Data/SECURITY_BUNDLE/ui/bin/vsp_pack_audit_bundle_p2_v1.sh

echo "== DONE P4 ISO =="
echo "[ISO_DIR]=$ISO_DIR"
echo "[HINT] open ISO files:"
echo "  ls -la \"$ISO_DIR\""
