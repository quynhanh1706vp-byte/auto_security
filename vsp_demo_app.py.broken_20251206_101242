from flask import Flask, jsonify, request, render_template, redirect\nfrom pathlib import Path\nimport json\nfrom vsp_run_exports_api_v3 import vsp_exports_bp\n\n# BASE_DIR = /home/test/Data/SECURITY_BUNDLE/ui\nBASE_DIR = Path(__file__).resolve().parent\n# ROOT_DIR = /home/test/Data/SECURITY_BUNDLE\nROOT_DIR = BASE_DIR.parent\nOUT_DIR = ROOT_DIR / "out"\n\napp = Flask(__name__, template_folder="templates", static_folder="static")\n\n\n# ======================= Utils =======================\n\ndef _iter_full_ext_runs():\n    """\n    Liệt kê các RUN_VSP_FULL_EXT_* trong thư mục out/.\n    """\n    if not OUT_DIR.is_dir():\n        return []\n    for d in OUT_DIR.iterdir():\n        if d.is_dir() and d.name.startswith("RUN_VSP_FULL_EXT"):\n            yield d\n\n\ndef _find_run_dir(run_id: str | None):\n    """\n    - Nếu run_id rỗng hoặc 'latest' → chọn run mới nhất.\n    - Nếu có run_id → dùng run đó nếu tồn tại.\n    """\n    if not OUT_DIR.is_dir():\n        return None\n\n    if not run_id or run_id == "latest":\n        runs = sorted(_iter_full_ext_runs(), key=lambda p: p.stat().st_mtime, reverse=True)\n        return runs[0] if runs else None\n\n    candidate = OUT_DIR / run_id\n    return candidate if candidate.is_dir() else None\n\n\n# ======================= Routes UI =======================\n\n@app.route("/")\ndef index():\n    # Giữ nguyên hành vi: vào / → nhảy sang /security_bundle\n    return redirect("/security_bundle")\n\n\n@app.route("/security_bundle")\ndef security_bundle():\n    # Giữ nguyên template UI VSP 2025\n    return render_template("vsp_dashboard_2025.html")\n\n\n# ======================= API: /api/vsp/dashboard_v3 =======================\n\n@app.route("/api/vsp/dashboard_v3")\ndef api_vsp_dashboard_v3():\n    """\n    Trả về dashboard data cho 1 run:\n    {\n      ok: true/false,\n      run_id: "...",\n      total_findings: int,\n      by_severity: {...},\n      security_score: ...,\n      top_risky_tool: ...,\n      top_cwe: ...,\n      top_module: ...\n      + giữ nguyên các field khác nếu summary_unified.json có\n    }\n    """\n    run_id = request.args.get("run_id")\n    run_dir = _find_run_dir(run_id)\n    if not run_dir:\n        return jsonify({"ok": False, "error": "run_not_found", "run_id": run_id}), 404\n\n    report_dir = run_dir / "report"\n    summary_file = report_dir / "summary_unified.json"\n    findings_file = report_dir / "findings_unified.json"\n\n    data = {}\n    findings = []\n\n    # Đọc summary_unified.json nếu có\n    if summary_file.is_file():\n        try:\n            with summary_file.open("r", encoding="utf-8") as f:\n                data = json.load(f)\n        except Exception:\n            data = {}\n\n    # Đọc findings_unified.json nếu cần\n    if findings_file.is_file():\n        try:\n            with findings_file.open("r", encoding="utf-8") as f:\n                findings = json.load(f)\n        except Exception:\n            findings = []\n\n    # Fallback: tự tính total_findings nếu chưa có\n    if "total_findings" not in data and isinstance(findings, list):\n        data["total_findings"] = len(findings)\n\n    # Fallback: tự tính by_severity nếu chưa có\n    if "by_severity" not in data and isinstance(findings, list):\n        by_sev = {}\n        for it in findings:\n            sev = it.get("severity_effective") or it.get("severity") or "INFO"\n            by_sev[sev] = by_sev.get(sev, 0) + 1\n        data["by_severity"] = by_sev\n\n    # Đảm bảo có các field KPI chính, nếu thiếu thì fill default\n    data.setdefault("security_score", data.get("security_score", 0))\n    data.setdefault("top_risky_tool", data.get("top_risky_tool"))\n    data.setdefault("top_cwe", data.get("top_cwe"))\n    data.setdefault("top_module", data.get("top_module"))\n\n    data["ok"] = True\n    data["run_id"] = run_dir.name\n    return jsonify(data)\n\n\n# ======================= API: /api/vsp/runs_index_v3 =======================\n\n@app.route("/api/vsp/runs_index_v3")\ndef api_vsp_runs_index_v3():\n    """\n    Trả về list các run để tab Runs & Reports dùng:\n    [\n      {\n        run_id: "...",\n        total_findings: int,\n        by_severity: {...},\n        by_tool: {...},\n        ts: ...\n      },\n      ...\n    ]\n    """\n    limit = request.args.get("limit", type=int) or 200\n    runs = sorted(_iter_full_ext_runs(), key=lambda p: p.stat().st_mtime, reverse=True)\n\n    items = []\n    for d in runs:\n        report_dir = d / "report"\n        summary_file = report_dir / "summary_unified.json"\n        findings_file = report_dir / "findings_unified.json"\n\n        total = 0\n        by_sev = {}\n        by_tool = {}\n        findings = []\n\n        # Cố gắng lấy từ summary_unified.json\n        if summary_file.is_file():\n            try:\n                with summary_file.open("r", encoding="utf-8") as f:\n                    sdata = json.load(f)\n                total = sdata.get("total_findings", total)\n                by_sev = sdata.get("by_severity", by_sev)\n                by_tool = sdata.get("by_tool", by_tool)\n            except Exception:\n                pass\n\n        # Nếu thiếu, fallback đọc findings_unified.json\n        if findings_file.is_file():\n            try:\n                with findings_file.open("r", encoding="utf-8") as f:\n                    findings = json.load(f)\n            except Exception:\n                findings = []\n\n        if not total and isinstance(findings, list):\n            total = len(findings)\n        if not by_sev and isinstance(findings, list):\n            for it in findings:\n                sev = it.get("severity_effective") or it.get("severity") or "INFO"\n                by_sev[sev] = by_sev.get(sev, 0) + 1\n        if not by_tool and isinstance(findings, list):\n            for it in findings:\n                tool = it.get("tool") or it.get("scanner") or "unknown"\n                by_tool[tool] = by_tool.get(tool, 0) + 1\n\n        items.append({\n            "run_id": d.name,\n            "total_findings": total,\n            "by_severity": by_sev,\n            "by_tool": by_tool,\n            "ts": None,\n        })\n        if len(items) >= limit:\n            break\n\n    return jsonify(items)\n\n\n# ======================= API: /api/vsp/datasource_v2 =======================\n\n@app.route("/api/vsp/datasource_v2")\n@app.route("/api/vsp/datasource")\ndef api_vsp_datasource_v2():\n    """\n    Data source cho tab Data Source / Dashboard:\n    {\n      ok: true,\n      run_id: "...",\n      filters: {...},\n      total: N,\n      items: [...]\n    }\n    Có filter theo:\n      - severity (severity_effective / severity)\n      - tool (tool / scanner)\n      - q (search trong message, rule_id, rule_name, file, path)\n    """\n    run_id = request.args.get("run_id")\n    q = request.args.get("q")\n    severity_filter = request.args.get("severity")\n    tool_filter = request.args.get("tool")\n    limit = request.args.get("limit", type=int) or 1000\n\n    run_dir = _find_run_dir(run_id)\n    if not run_dir:\n        return jsonify({"ok": False, "error": "run_not_found", "run_id": run_id}), 404\n\n    report_dir = run_dir / "report"\n    findings_file = report_dir / "findings_unified.json"\n    if not findings_file.is_file():\n        return jsonify({"ok": False, "error": "findings_not_found", "run_id": run_dir.name}), 404\n\n    try:\n        with findings_file.open("r", encoding="utf-8") as f:\n            items = json.load(f)\n    except Exception:\n        items = []\n\n    if not isinstance(items, list):\n        return jsonify({"ok": False, "error": "bad_findings_format"}), 500\n\n    result = []\n    q_lower = q.lower() if q else None\n\n    for it in items:\n        sev = it.get("severity_effective") or it.get("severity")\n        tool = it.get("tool") or it.get("scanner")\n\n        if severity_filter and sev != severity_filter:\n            continue\n        if tool_filter and tool != tool_filter:\n            continue\n        if q_lower:\n            blob = " ".join(str(it.get(k, "")) for k in ("message", "rule_id", "rule_name", "file", "path"))\n            if q_lower not in blob.lower():\n                continue\n\n        result.append(it)\n        if len(result) >= limit:\n            break\n\n    payload = {\n        "ok": True,\n        "run_id": run_dir.name,\n        "filters": {\n            "limit": limit,\n            "q": q,\n            "severity": severity_filter,\n            "tool": tool_filter,\n        },\n        "total": len(result),\n        "items": result,\n    }\n    return jsonify(payload)\n\n\n# ======================= API: /api/vsp/settings/get =======================\n\n@app.route("/api/vsp/settings/get")\ndef api_vsp_settings_get():\n    """\n    Settings đơn giản cho tab Settings:\n    - env: thông tin môi trường\n    - tools: list tool + enabled\n    """\n    tools = {\n        "gitleaks":  {"enabled": True, "label": "Gitleaks (Secrets)"},\n        "semgrep":   {"enabled": True, "label": "Semgrep (SAST)"},\n        "kics":      {"enabled": True, "label": "KICS (IaC)"},\n        "codeql":    {"enabled": True, "label": "CodeQL"},\n        "bandit":    {"enabled": True, "label": "Bandit (Python)"},\n        "trivy_fs":  {"enabled": True, "label": "Trivy FS"},\n        "syft":      {"enabled": True, "label": "Syft (SBOM)"},\n        "grype":     {"enabled": True, "label": "Grype (Vuln)"},\n    }\n    env = {\n        "profile": "EXT+",\n        "root_dir": str(ROOT_DIR),\n        "out_dir": str(OUT_DIR),\n    }\n    return jsonify({"ok": True, "env": env, "tools": tools})\n\n\n# ======================= API: /api/vsp/overrides/list =======================\n\n@app.route("/api/vsp/overrides/list")\ndef api_vsp_overrides_list():\n    """\n    Trả danh sách override rule (tạm thời để trống).\n    UI vẫn render được, không lỗi.\n    """\n    return jsonify({"ok": True, "total": 0, "items": []})\n\n\n# ======================= Main =======================\n\napp.register_blueprint(vsp_exports_bp)\nif __name__ == "__main__":\n    # Giữ nguyên port 8910 cho VSP UI\n    app.run(host="0.0.0.0", port=8910, debug=True)\n