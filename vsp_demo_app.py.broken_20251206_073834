from __future__ import annotations\nfrom vsp_run_exports_api_v3 import vsp_exports_bp\n\nimport json\nfrom datetime import datetime\nfrom pathlib import Path\nfrom typing import Any, Dict, List, Optional\n\nfrom flask import Flask, jsonify, redirect, render_template, request, url_for\n\n# ====== PATHS ======\nHERE = Path(__file__).resolve().parent\nROOT = HERE.parent           # /home/test/Data/SECURITY_BUNDLE\nOUT_DIR = ROOT / "out"       # chứa RUN_VSP_FULL_EXT_.../\nDATA_DIR = HERE / "static" / "data"\n\napp = Flask(\n\n    __name__,\n    static_folder="static",\n    template_folder="templates",\n)\n\n\n# ====== HELPERS ======\n\ndef _load_json(path: Path) -> Optional[Dict[str, Any]]:\n    try:\n        if path.is_file():\n            with path.open("r", encoding="utf-8") as f:\n                return json.load(f)\n    except Exception as e:\n        print(f"[WARN] Cannot read JSON {path}: {e}")\n    return None\n\n\ndef _get_run_dirs() -> List[Path]:\n    if not OUT_DIR.is_dir():\n        return []\n    runs = [p for p in OUT_DIR.iterdir()\n            if p.is_dir() and p.name.startswith("RUN_VSP_FULL_EXT_")]\n    # sort newest first (by name, vì tên chứa timestamp)\n    return sorted(runs, key=lambda p: p.name, reverse=True)\n\n\ndef _get_latest_run_dir() -> Optional[Path]:\n    runs = _get_run_dirs()\n    return runs[0] if runs else None\n\n\ndef _load_run_summary(run_dir: Path) -> Optional[Dict[str, Any]]:\n    # chuẩn: out/RUN_.../report/summary_unified.json\n    cand = [\n        run_dir / "report" / "summary_unified.json",\n        run_dir / "summary_unified.json",\n    ]\n    for p in cand:\n        data = _load_json(p)\n        if data is not None:\n            return data\n    return None\n\n\ndef _load_run_findings(run_dir: Path) -> List[Dict[str, Any]]:\n    """\n    Tìm mọi file *findings*.json trong thư mục run,\n    ưu tiên report/findings_unified.json. Trả về list findings.\n    """\n    from typing import List, Dict, Any  # type: ignore\n\n    candidates = []\n\n    # các path chuẩn\n    candidates.append(run_dir / "report" / "findings_unified.json")\n    candidates.append(run_dir / "findings_unified.json")\n\n    # thêm mọi file có chữ 'finding' trong report/\n    report_dir = run_dir / "report"\n    if report_dir.is_dir():\n        for p in report_dir.glob("*findings*.json"):\n            if p not in candidates:\n                candidates.append(p)\n\n    for path in candidates:\n        data = _load_json(path)\n        if not data:\n            continue\n        if isinstance(data, list):\n            print(f"[VSP] Loaded findings from {path} (list, {len(data)} items)")\n            return data\n        if isinstance(data, dict) and isinstance(data.get("items"), list):\n            print(f"[VSP] Loaded findings from {path} (items, {len(data['items'])} items)")\n            return data["items"]\n\n    print(f"[VSP] No findings JSON found for run {run_dir.name}")\n    return []\n\n\ndef _severity_order(sev: str) -> int:\n    order = {\n        "CRITICAL": 0,\n        "HIGH": 1,\n        "MEDIUM": 2,\n        "LOW": 3,\n        "INFO": 4,\n        "TRACE": 5,\n    }\n    return order.get((sev or "").upper(), 99)\n\n\n# ====== ROUTES: UI ======\n\n@app.route("/")\ndef index() -> Any:\n    return redirect(url_for("security_bundle"))\n\n\n@app.route("/security_bundle")\ndef security_bundle() -> Any:\n    return render_template("vsp_dashboard_2025.html")\n\n\n# ====== API: DASHBOARD V3 ======\n\n@app.route("/api/vsp/dashboard_v3")\ndef api_vsp_dashboard_v3() -> Any:\n    """\n    Trả về summary cho CIO Dashboard & Data Source mini overview.\n    Ưu tiên:\n      1) ui/static/data/vsp_dashboard_v3_latest.json (nếu có)\n      2) Tự build từ RUN_VSP_FULL_EXT_* mới nhất\n    """\n    # 1) static data nếu có\n    static_path = DATA_DIR / "vsp_dashboard_v3_latest.json"\n    data = _load_json(static_path)\n\n    latest_run_dir = _get_latest_run_dir()\n    if data is None and latest_run_dir:\n        summary = _load_run_summary(latest_run_dir)\n        if summary:\n            run_id = latest_run_dir.name\n            by_sev = summary.get("by_severity") or summary.get("severity") or {}\n            by_tool = summary.get("by_tool") or {}\n            total = summary.get("total_findings") or summary.get("total") or 0\n            security_score = summary.get("security_score", 0)\n            top_tool = summary.get("top_risky_tool")\n            top_cwe = summary.get("top_cwe") or summary.get("top_CWE")\n            top_module = summary.get("top_module")\n\n            data = {\n                "run_id": run_id,\n                "total_findings": total,\n                "by_severity": by_sev,\n                "by_tool": by_tool,\n                "security_score": security_score,\n                "top_risky_tool": top_tool,\n                "top_cwe": top_cwe,\n                "top_module": top_module,\n            }\n\n    if data is None:\n        # fallback demo\n        data = {\n            "run_id": "RUN_VSP_FULL_EXT_DEMO",\n            "total_findings": 0,\n            "by_severity": {\n                "CRITICAL": 0,\n                "HIGH": 0,\n                "MEDIUM": 0,\n                "LOW": 0,\n                "INFO": 0,\n                "TRACE": 0,\n            },\n            "by_tool": {},\n            "security_score": 0,\n            "top_risky_tool": None,\n            "top_cwe": None,\n            "top_module": None,\n        }\n\n    resp = {\n        "ok": True,\n        "run_id": data.get("run_id"),\n        "total_findings": data.get("total_findings", 0),\n        "by_severity": data.get("by_severity", {}),\n        "by_tool": data.get("by_tool", {}),\n        "security_score": data.get("security_score", 0),\n        "top_risky_tool": data.get("top_risky_tool"),\n        "top_cwe": data.get("top_cwe"),\n        "top_module": data.get("top_module"),\n    }\n    return jsonify(resp)\n\n\n# ====== API: RUNS INDEX V3 ======\n\n@app.route("/api/vsp/runs_index_v3")\ndef api_vsp_runs_index_v3() -> Any:\n    """\n    Danh sách các RUN_VSP_FULL_EXT_* (cho tab Runs & Reports).\n    Format: list[ {run_id, total_findings, by_severity, by_tool, ts}, ... ]\n    """\n    runs = []\n    for run_dir in _get_run_dirs():\n        summary = _load_run_summary(run_dir)\n        if not summary:\n            continue\n        run_id = run_dir.name\n        total = summary.get("total_findings") or summary.get("total") or 0\n        by_sev = summary.get("by_severity") or {}\n        by_tool = summary.get("by_tool") or {}\n\n        # cố gắng lấy timestamp\n        ts_str = summary.get("ts") or summary.get("timestamp")\n        if not ts_str:\n            # parse từ tên RUN_VSP_FULL_EXT_YYYYmmdd_HHMMSS\n            try:\n                parts = run_id.split("_")\n                date_part = parts[-2]\n                time_part = parts[-1]\n                dt = datetime.strptime(date_part + time_part, "%Y%m%d%H%M%S")\n                ts_str = dt.isoformat()\n            except Exception:\n                ts_str = None\n\n        runs.append({\n            "run_id": run_id,\n            "total_findings": total,\n            "by_severity": by_sev,\n            "by_tool": by_tool,\n            "ts": ts_str,\n        })\n\n    return jsonify(runs)\n\n\n# ====== API: DATASOURCE V2 + alias /datasource ======\n\n@app.route("/api/vsp/datasource_v2")\n@app.route("/api/vsp/datasource")\ndef api_vsp_datasource_v2() -> Any:\n    """\n    Unified findings cho tab Data Source.\n    → Luôn chọn run mới nhất CÓ findings_unified.json.\n    Hỗ trợ filter: severity, tool, q (search), limit, offset.\n    """\n    findings = []\n    latest_run_dir = None\n\n    # tìm run mới nhất có findings\n    for run_dir in _get_run_dirs():\n        data = _load_run_findings(run_dir)\n        if data:\n            latest_run_dir = run_dir\n            findings = data\n            print(f"[VSP] Using findings from run {run_dir.name} (count={len(data)})")\n            break\n\n    total_all = len(findings)\n\n    # filters\n    severity = (request.args.get("severity") or "").upper()\n    tool = request.args.get("tool") or ""\n    q = request.args.get("q") or request.args.get("search") or ""\n\n    def _match(it: Dict[str, Any]) -> bool:\n        if severity and (it.get("severity") or "").upper() != severity:\n            return False\n        if tool and (it.get("tool") or "") != tool:\n            return False\n        if q:\n            ql = q.lower()\n            text = " ".join([\n                str(it.get("file") or ""),\n                str(it.get("rule_id") or ""),\n                str(it.get("message") or ""),\n            ]).lower()\n            if ql not in text:\n                return False\n        return True\n\n    # Chuẩn hóa\n    normalized = []\n    for f in findings:\n        it = {\n            "tool": f.get("tool"),\n            "severity": f.get("severity"),\n            "file": f.get("file") or f.get("location") or "",\n            "line": f.get("line") or f.get("line_number") or 0,\n            "rule_id": f.get("rule_id") or f.get("rule") or "",\n            "message": f.get("message") or f.get("description") or "",\n        }\n        if _match(it):\n            normalized.append(it)\n\n    # paging\n    try:\n        limit = int(request.args.get("limit", "100"))\n    except ValueError:\n        limit = 100\n    try:\n        offset = int(request.args.get("offset", "0"))\n    except ValueError:\n        offset = 0\n    if limit <= 0:\n        limit = 100\n    if offset < 0:\n        offset = 0\n\n    page_items = normalized[offset: offset + limit]\n\n    for i, it in enumerate(page_items, start=offset + 1):\n        it["index"] = i\n\n    resp = {\n        "ok": True,\n        "total": len(normalized),\n        "total_all": total_all,\n        "offset": offset,\n        "limit": limit,\n        "items": page_items,\n    }\n    return jsonify(resp)\n\n\n@app.route("/api/vsp/settings/get")\ndef api_vsp_settings_get() -> Any:\n    latest_run_dir = _get_latest_run_dir()\n    last_run_id = latest_run_dir.name if latest_run_dir else None\n    last_summary = _load_run_summary(latest_run_dir) if latest_run_dir else None\n    last_ts = None\n    if last_summary:\n        last_ts = last_summary.get("ts") or last_summary.get("timestamp")\n    resp = {\n        "ok": True,\n        "profile": "EXT+",\n        "src": str(ROOT),\n        "bundle_out_dir": str(OUT_DIR),\n        "last_run_id": last_run_id,\n        "last_run_ts": last_ts,\n    }\n    return jsonify(resp)\n\n\n@app.route("/api/vsp/overrides/list")\ndef api_vsp_overrides_list() -> Any:\n    demo = [\n        {\n            "tool": "semgrep",\n            "rule_id": "python.django.security.xss",\n            "scope": "path:src/legacy/",\n            "action": "severity:LOW",\n            "note": "Legacy module, under deprecation, monitored manually.",\n        },\n        {\n            "tool": "gitleaks",\n            "rule_id": "generic-api-key",\n            "scope": "file:config/demo.env",\n            "action": "ignore",\n            "note": "Demo env file, not used in production.",\n        },\n    ]\n    resp = {\n        "ok": True,\n        "items": demo,\n        "metrics": {\n            "active_overrides": len(demo),\n            "critical_downgraded": 1,\n            "most_ignored_rule": "generic-api-key",\n        },\n    }\n    return jsonify(resp)\n\n\n# ====== MAIN ======\n\napp.register_blueprint(vsp_exports_bp)\nif __name__ == "__main__":\n    print("[VSP] ROOT =", ROOT)\n    print("[VSP] OUT_DIR =", OUT_DIR)\n    app.run(host="0.0.0.0", port=8910, debug=True)\n\n\n# ======================= VSP_RUN_EXPORTS_API_V3 =======================\nfrom flask import send_file, abort, request\nfrom pathlib import Path as _VSPPath\nimport json as _vsp_json\nimport csv as _vsp_csv\nimport sys as _vsp_sys\nimport traceback as _vsp_tb\n\ndef _vsp3_run_dir(run_id: str) -> _VSPPath | None:\n    """Map run_id thẳng vào /out/<run_id>."""\n    base = _VSPPath(__file__).resolve().parents[1]  # /home/test/Data/SECURITY_BUNDLE\n    out_dir = base / "out"\n    run_dir = out_dir / run_id\n    if run_dir.is_dir():\n        print("[VSP_EXPORT_V3] Using run_dir:", run_dir, file=_vsp_sys.stderr, flush=True)\n        return run_dir\n    print("[VSP_EXPORT_V3] Run dir not found for:", run_id, file=_vsp_sys.stderr, flush=True)\n    return None\n\ndef _vsp3_load_json(run_dir: _VSPPath, patterns):\n    """Tìm và load JSON theo danh sách tên ưu tiên."""\n    report_dir = run_dir / "report"\n    roots = [report_dir, run_dir]\n    for root in roots:\n        if not root.exists():\n            continue\n        for name in patterns:\n            p = root / name\n            if p.is_file():\n                try:\n                    print("[VSP_EXPORT_V3] Load JSON:", p, file=_vsp_sys.stderr, flush=True)\n                    return _vsp_json.loads(p.read_text(encoding="utf-8"))\n                except Exception:\n                    print("[VSP_EXPORT_V3] Failed to load JSON:", p, file=_vsp_sys.stderr, flush=True)\n                    _vsp_tb.print_exc()\n    return None\n\ndef _vsp3_generate_html(run_dir: _VSPPath) -> _VSPPath:\n    """Generate HTML report nhẹ nhưng vẫn đúng style thương mại."""\n    summary = _vsp3_load_json(run_dir, [\n        "summary_unified.json",\n        "summary_full_ext.json",\n        "summary.json",\n    ]) or {}\n\n    findings_data = _vsp3_load_json(run_dir, [\n        "findings_unified.json",\n        "findings.json",\n    ]) or []\n\n    findings = []\n    if isinstance(findings_data, list):\n        findings = findings_data\n    elif isinstance(findings_data, dict):\n        if isinstance(findings_data.get("items"), list):\n            findings = findings_data["items"]\n        elif isinstance(findings_data.get("results"), list):\n            findings = findings_data["results"]\n\n    max_rows = 500\n    findings = findings[:max_rows]\n\n    summary_root = summary.get("summary", summary)\n    run_id  = summary_root.get("run_id", summary.get("run_id", run_dir.name))\n    ts      = summary_root.get("ts", summary.get("ts", ""))\n    total   = summary_root.get("total_findings", summary.get("total_findings", len(findings)))\n    score   = summary_root.get("security_score", summary.get("security_score", 0))\n    by_sev  = summary_root.get("by_severity", {})\n    top_tool   = summary_root.get("top_risky_tool", summary.get("top_risky_tool", "—"))\n    top_cwe    = summary_root.get("top_cwe", summary.get("top_cwe", "—"))\n    top_module = summary_root.get("top_module", summary.get("top_module", "—"))\n\n    crit  = by_sev.get("CRITICAL", 0)\n    high  = by_sev.get("HIGH", 0)\n    med   = by_sev.get("MEDIUM", 0)\n    low   = by_sev.get("LOW", 0)\n    info  = by_sev.get("INFO", 0)\n    trace = by_sev.get("TRACE", 0)\n\n    def _fv(item, key, default=""):\n        v = item.get(key, default)\n        if isinstance(v, (list, dict)):\n            return _vsp_json.dumps(v, ensure_ascii=False)\n        return v\n\n    html = []\n    html.append("<!DOCTYPE html><html lang='en'><head><meta charset='utf-8' />")\n    html.append(f"<title>VSP Run Report – {run_id}</title>")\n    html.append("""<style>\n      :root {\n        --bg-body: #020617;\n        --bg-card: #020617;\n        --accent: #22c55e;\n        --border-subtle: #1f2937;\n        --text-main: #e5e7eb;\n        --text-soft: #9ca3af;\n      }\n      * { box-sizing: border-box; }\n      body {\n        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;\n        background: radial-gradient(circle at top, #020617 0, #020617 45%, #0b1120 100%);\n        color: var(--text-main);\n        margin: 0;\n        padding: 24px 32px 40px;\n      }\n      .vsp-header {\n        display: flex;\n        align-items: center;\n        justify-content: space-between;\n        margin-bottom: 24px;\n        padding: 16px 20px;\n        border-radius: 18px;\n        background: radial-gradient(circle at 0 0, rgba(56,189,248,0.25), transparent 55%),\n                    radial-gradient(circle at 100% 0, rgba(34,197,94,0.28), transparent 55%),\n                    #020617;\n        border: 1px solid rgba(148,163,184,0.28);\n        box-shadow: 0 18px 45px rgba(15,23,42,0.85);\n      }\n      .vsp-header-left {\n        display: flex;\n        align-items: center;\n        gap: 14px;\n      }\n      .vsp-logo-mark {\n        width: 40px;\n        height: 40px;\n        border-radius: 14px;\n        background: radial-gradient(circle at 30% 0, #4ade80 0, #22c55e 40%, #15803d 100%);\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        font-weight: 700;\n        font-size: 16px;\n        letter-spacing: 0.08em;\n        color: #0b1120;\n        box-shadow: 0 10px 30px rgba(34,197,94,0.65);\n      }\n      .vsp-title-block { display: flex; flex-direction: column; gap: 2px; }\n      .vsp-title {\n        font-size: 18px;\n        font-weight: 600;\n        letter-spacing: 0.03em;\n        text-transform: uppercase;\n      }\n      .vsp-subtitle { font-size: 12px; color: var(--text-soft); }\n      .vsp-header-right { text-align: right; font-size: 12px; color: var(--text-soft); }\n      .vsp-header-right strong { color: var(--text-main); }\n      .kpi-grid {\n        display: grid;\n        grid-template-columns: repeat(4, minmax(0, 1fr));\n        gap: 16px;\n        margin-bottom: 24px;\n      }\n      .kpi-card {\n        background: radial-gradient(circle at 0 0, rgba(37,99,235,0.18), transparent 55%),\n                    #020617;\n        border-radius: 18px;\n        padding: 14px 16px 16px;\n        border: 1px solid rgba(31,41,55,0.85);\n        box-shadow: 0 16px 32px rgba(0,0,0,0.55);\n      }\n      .kpi-label {\n        font-size: 11px;\n        text-transform: uppercase;\n        letter-spacing: 0.10em;\n        color: var(--text-soft);\n        margin-bottom: 4px;\n      }\n      .kpi-value { font-size: 22px; font-weight: 600; }\n      .kpi-sub { font-size: 11px; color: var(--text-soft); margin-top: 2px; }\n      .pill-sev {\n        display: inline-flex;\n        align-items: center;\n        border-radius: 999px;\n        padding: 2px 8px;\n        font-size: 11px;\n        margin-right: 4px;\n        background: rgba(15,23,42,0.9);\n        border: 1px solid rgba(55,65,81,0.85);\n      }\n      .pill-sev span { margin-right: 4px; text-transform: uppercase; letter-spacing: 0.08em; }\n      .sev-CRITICAL { color: #fecaca; }\n      .sev-HIGH { color: #fed7aa; }\n      .sev-MEDIUM { color: #facc15; }\n      .sev-LOW { color: #bbf7d0; }\n      .sev-INFO { color: #bae6fd; }\n      .sev-TRACE { color: #e5e7eb; }\n      table {\n        border-collapse: collapse;\n        width: 100%;\n        margin-top: 12px;\n        font-size: 12px;\n      }\n      th, td {\n        border-bottom: 1px solid #1f2933;\n        padding: 7px 6px;\n        text-align: left;\n        vertical-align: top;\n      }\n      th {\n        background: radial-gradient(circle at 0 0, rgba(15,23,42,1), transparent 70%);\n        position: sticky;\n        top: 0;\n        z-index: 2;\n      }\n      tr:nth-child(even) { background: rgba(15,23,42,0.7); }\n      code {\n        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;\n        font-size: 11px;\n      }\n      .loc-cell { font-size: 11px; color: var(--text-soft); }\n      .msg-cell { font-size: 12px; }\n    </style>""")\n    html.append("</head><body>")\n\n    # Header\n    html.append("<div class='vsp-header'>")\n    html.append("<div class='vsp-header-left'>")\n    html.append("<div class='vsp-logo-mark'>VSP</div>")\n    html.append("<div class='vsp-title-block'>")\n    html.append("<div class='vsp-title'>VersaSecure Platform 2025</div>")\n    html.append("<div class='vsp-subtitle'>EXT+ Enterprise Security Profile – Run Report</div>")\n    html.append("</div></div>")\n    html.append("<div class='vsp-header-right'>")\n    html.append(f"<div><strong>Run ID:</strong> {run_id}</div>")\n    if ts:\n        html.append(f"<div><strong>Timestamp:</strong> {ts}</div>")\n    html.append("</div></div>")\n\n    # KPI\n    html.append("<div class='kpi-grid'>")\n    html.append("<div class='kpi-card'><div class='kpi-label'>Total Findings</div>")\n    html.append(f"<div class='kpi-value'>{total}</div>")\n    html.append("<div class='kpi-sub'>Consolidated across all tools</div></div>")\n\n    html.append("<div class='kpi-card'><div class='kpi-label'>Security Score</div>")\n    html.append(f"<div class='kpi-value'>{score}</div>")\n    html.append("<div class='kpi-sub'>0–100 (higher is better)</div></div>")\n\n    html.append("<div class='kpi-card'><div class='kpi-label'>By Severity</div><div>")\n    html.append(f"<span class='pill-sev sev-CRITICAL'><span>CRIT</span>{crit}</span>")\n    html.append(f"<span class='pill-sev sev-HIGH'><span>HIGH</span>{high}</span>")\n    html.append(f"<span class='pill-sev sev-MEDIUM'><span>MED</span>{med}</span>")\n    html.append(f"<span class='pill-sev sev-LOW'><span>LOW</span>{low}</span>")\n    html.append(f"<span class='pill-sev sev-INFO'><span>INFO</span>{info}</span>")\n    html.append(f"<span class='pill-sev sev-TRACE'><span>TRACE</span>{trace}</span>")\n    html.append("</div></div>")\n\n    html.append("<div class='kpi-card'><div class='kpi-label'>Signals</div>")\n    html.append("<div class='kpi-sub'>")\n    html.append(f"<div><strong>Top Tool:</strong> {top_tool}</div>")\n    html.append(f"<div><strong>Top CWE:</strong> {top_cwe}</div>")\n    html.append(f"<div><strong>Top Module:</strong> {top_module}</div>")\n    html.append("</div></div>")\n    html.append("</div>")\n\n    # Table\n    html.append("<div class='section'>")\n    html.append("<div class='kpi-label' style='margin-top:4px;'>Consolidated Findings</div>")\n    if not findings:\n        html.append("<div class='kpi-sub'>Không có findings để hiển thị.</div>")\n    else:\n        html.append(f"<div class='kpi-sub'>Hiển thị {len(findings)} findings đầu tiên (tối đa {max_rows}).</div>")\n        html.append("<table><thead><tr><th>#</th><th>Severity</th><th>Tool</th><th>Rule</th><th>Location</th><th>Message</th></tr></thead><tbody>")\n        for idx, it in enumerate(findings, start=1):\n            sev  = str(_fv(it, "severity", "")).upper()\n            tool = _fv(it, "tool", _fv(it, "scanner", ""))\n            rule = _fv(it, "rule_id", _fv(it, "check_id", ""))\n            file_p = _fv(it, "file", _fv(it, "target", ""))\n            line = _fv(it, "line", _fv(it, "start_line", ""))\n            msg = _fv(it, "message", _fv(it, "description", ""))\n\n            sev_class = f"sev-{sev}" if sev else ""\n            loc = f"{file_p}:{line}" if (file_p or line) else ""\n            html.append("<tr>")\n            html.append(f"<td>{idx}</td>")\n            html.append(f"<td class='{sev_class}'>{sev}</td>")\n            html.append(f"<td>{tool}</td>")\n            html.append(f"<td><code>{rule}</code></td>")\n            html.append(f"<td class='loc-cell'><code>{loc}</code></td>")\n            html.append(f"<td class='msg-cell'>{msg}</td>")\n            html.append("</tr>")\n        html.append("</tbody></table>")\n    html.append("</div>")\n\n    html.append("</body></html>")\n\n    report_dir = run_dir / "report"\n    report_dir.mkdir(parents=True, exist_ok=True)\n    out_path = report_dir / "vsp_run_report.html"\n    out_path.write_text("".join(html), encoding="utf-8")\n    print("[VSP_EXPORT_V3] Generated HTML:", out_path, file=_vsp_sys.stderr, flush=True)\n    return out_path\n\ndef _vsp3_generate_csv(run_dir: _VSPPath) -> _VSPPath:\n    """Generate CSV findings_unified, nếu không có thì header rỗng."""\n    findings_data = _vsp3_load_json(run_dir, [\n        "findings_unified.json",\n        "findings.json",\n    ]) or []\n\n    items = []\n    if isinstance(findings_data, list):\n        items = findings_data\n    elif isinstance(findings_data, dict):\n        if isinstance(findings_data.get("items"), list):\n            items = findings_data["items"]\n        elif isinstance(findings_data.get("results"), list):\n            items = findings_data["results"]\n\n    cols = ["severity", "tool", "rule_id", "file", "line", "message", "cwe", "category"]\n\n    def _g(it, key):\n        v = it.get(key, "")\n        if isinstance(v, (list, dict)):\n            return _vsp_json.dumps(v, ensure_ascii=False)\n        return v\n\n    report_dir = run_dir / "report"\n    report_dir.mkdir(parents=True, exist_ok=True)\n    out_path = report_dir / "vsp_findings_unified.csv"\n\n    with out_path.open("w", encoding="utf-8", newline="") as f:\n        writer = _vsp_csv.writer(f)\n        writer.writerow(cols)\n        for it in items:\n            writer.writerow([\n                _g(it, "severity"),\n                _g(it, "tool") or _g(it, "scanner"),\n                _g(it, "rule_id") or _g(it, "check_id"),\n                _g(it, "file") or _g(it, "target"),\n                _g(it, "line") or _g(it, "start_line"),\n                _g(it, "message") or _g(it, "description"),\n                _g(it, "cwe") or _g(it, "cwe_id"),\n                _g(it, "category") or _g(it, "type"),\n            ])\n\n    print("[VSP_EXPORT_V3] Generated CSV:", out_path, file=_vsp_sys.stderr, flush=True)\n    return out_path\n\n@app.route("/api/vsp/run_exports", methods=["GET"])\ndef api_vsp_run_exports():\n    """Trả về file export cho 1 run: html/csv (V3, luôn tự generate nếu cần)."""\n    run_id = request.args.get("run_id", "").strip()\n    fmt = request.args.get("format", "html").strip().lower()\n    print(f"[VSP_EXPORT_V3] run_id={run_id} fmt={fmt}", file=_vsp_sys.stderr, flush=True)\n\n    if not run_id:\n        abort(400, "Missing run_id")\n\n    run_dir = _vsp3_run_dir(run_id)\n    if not run_dir:\n        abort(404, f"Run not found: {run_id}")\n\n    if fmt == "html":\n        target = _vsp3_generate_html(run_dir)\n    elif fmt == "csv":\n        target = _vsp3_generate_csv(run_dir)\n    else:\n        abort(400, f"Unsupported format: {fmt}")\n\n    return send_file(target, as_attachment=False)\n# ===================== END VSP_RUN_EXPORTS_API_V3 =====================\n\n\n# ======================= VSP_RUN_EXPORTS_API_V3 =======================\nfrom flask import send_file, abort, request\nfrom pathlib import Path as _VSPPath\nimport json as _vsp_json\nimport csv as _vsp_csv\nimport sys as _vsp_sys\nimport traceback as _vsp_tb\n\ndef _vsp3_run_dir(run_id: str) -> _VSPPath | None:\n    """Map run_id thẳng vào /out/<run_id>."""\n    base = _VSPPath(__file__).resolve().parents[1]  # /home/test/Data/SECURITY_BUNDLE\n    out_dir = base / "out"\n    run_dir = out_dir / run_id\n    if run_dir.is_dir():\n        print("[VSP_EXPORT_V3] Using run_dir:", run_dir, file=_vsp_sys.stderr, flush=True)\n        return run_dir\n    print("[VSP_EXPORT_V3] Run dir not found for:", run_id, file=_vsp_sys.stderr, flush=True)\n    return None\n\ndef _vsp3_load_json(run_dir: _VSPPath, patterns):\n    """Tìm và load JSON theo danh sách tên ưu tiên."""\n    report_dir = run_dir / "report"\n    roots = [report_dir, run_dir]\n    for root in roots:\n        if not root.exists():\n            continue\n        for name in patterns:\n            p = root / name\n            if p.is_file():\n                try:\n                    print("[VSP_EXPORT_V3] Load JSON:", p, file=_vsp_sys.stderr, flush=True)\n                    return _vsp_json.loads(p.read_text(encoding="utf-8"))\n                except Exception:\n                    print("[VSP_EXPORT_V3] Failed to load JSON:", p, file=_vsp_sys.stderr, flush=True)\n                    _vsp_tb.print_exc()\n    return None\n\ndef _vsp3_generate_html(run_dir: _VSPPath) -> _VSPPath:\n    """Generate HTML report nhẹ nhưng vẫn đúng style thương mại."""\n    summary = _vsp3_load_json(run_dir, [\n        "summary_unified.json",\n        "summary_full_ext.json",\n        "summary.json",\n    ]) or {}\n\n    findings_data = _vsp3_load_json(run_dir, [\n        "findings_unified.json",\n        "findings.json",\n    ]) or []\n\n    findings = []\n    if isinstance(findings_data, list):\n        findings = findings_data\n    elif isinstance(findings_data, dict):\n        if isinstance(findings_data.get("items"), list):\n            findings = findings_data["items"]\n        elif isinstance(findings_data.get("results"), list):\n            findings = findings_data["results"]\n\n    max_rows = 500\n    findings = findings[:max_rows]\n\n    summary_root = summary.get("summary", summary)\n    run_id  = summary_root.get("run_id", summary.get("run_id", run_dir.name))\n    ts      = summary_root.get("ts", summary.get("ts", ""))\n    total   = summary_root.get("total_findings", summary.get("total_findings", len(findings)))\n    score   = summary_root.get("security_score", summary.get("security_score", 0))\n    by_sev  = summary_root.get("by_severity", {})\n\n    top_tool   = summary_root.get("top_risky_tool", summary.get("top_risky_tool", "—"))\n    top_cwe    = summary_root.get("top_cwe", summary.get("top_cwe", "—"))\n    top_module = summary_root.get("top_module", summary.get("top_module", "—"))\n\n    crit  = by_sev.get("CRITICAL", 0)\n    high  = by_sev.get("HIGH", 0)\n    med   = by_sev.get("MEDIUM", 0)\n    low   = by_sev.get("LOW", 0)\n    info  = by_sev.get("INFO", 0)\n    trace = by_sev.get("TRACE", 0)\n\n    def _fv(item, key, default=""):\n        v = item.get(key, default)\n        if isinstance(v, (list, dict)):\n            return _vsp_json.dumps(v, ensure_ascii=False)\n        return v\n\n    html = []\n    html.append("<!DOCTYPE html><html lang='en'><head><meta charset='utf-8' />")\n    html.append(f"<title>VSP Run Report – {run_id}</title>")\n    html.append("""<style>\n      :root {\n        --bg-body: #020617;\n        --bg-card: #020617;\n        --accent: #22c55e;\n        --border-subtle: #1f2937;\n        --text-main: #e5e7eb;\n        --text-soft: #9ca3af;\n      }\n      * { box-sizing: border-box; }\n      body {\n        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;\n        background: radial-gradient(circle at top, #020617 0, #020617 45%, #0b1120 100%);\n        color: var(--text-main);\n        margin: 0;\n        padding: 24px 32px 40px;\n      }\n      .vsp-header {\n        display: flex;\n        align-items: center;\n        justify-content: space-between;\n        margin-bottom: 24px;\n        padding: 16px 20px;\n        border-radius: 18px;\n        background: radial-gradient(circle at 0 0, rgba(56,189,248,0.25), transparent 55%),\n                    radial-gradient(circle at 100% 0, rgba(34,197,94,0.28), transparent 55%),\n                    #020617;\n        border: 1px solid rgba(148,163,184,0.28);\n        box-shadow: 0 18px 45px rgba(15,23,42,0.85);\n      }\n      .vsp-header-left {\n        display: flex;\n        align-items: center;\n        gap: 14px;\n      }\n      .vsp-logo-mark {\n        width: 40px;\n        height: 40px;\n        border-radius: 14px;\n        background: radial-gradient(circle at 30% 0, #4ade80 0, #22c55e 40%, #15803d 100%);\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        font-weight: 700;\n        font-size: 16px;\n        letter-spacing: 0.08em;\n        color: #0b1120;\n        box-shadow: 0 10px 30px rgba(34,197,94,0.65);\n      }\n      .vsp-title-block { display: flex; flex-direction: column; gap: 2px; }\n      .vsp-title {\n        font-size: 18px;\n        font-weight: 600;\n        letter-spacing: 0.03em;\n        text-transform: uppercase;\n      }\n      .vsp-subtitle { font-size: 12px; color: var(--text-soft); }\n      .vsp-header-right { text-align: right; font-size: 12px; color: var(--text-soft); }\n      .vsp-header-right strong { color: var(--text-main); }\n      .kpi-grid {\n        display: grid;\n        grid-template-columns: repeat(4, minmax(0, 1fr));\n        gap: 16px;\n        margin-bottom: 24px;\n      }\n      .kpi-card {\n        background: radial-gradient(circle at 0 0, rgba(37,99,235,0.18), transparent 55%),\n                    #020617;\n        border-radius: 18px;\n        padding: 14px 16px 16px;\n        border: 1px solid rgba(31,41,55,0.85);\n        box-shadow: 0 16px 32px rgba(0,0,0,0.55);\n      }\n      .kpi-label {\n        font-size: 11px;\n        text-transform: uppercase;\n        letter-spacing: 0.10em;\n        color: var(--text-soft);\n        margin-bottom: 4px;\n      }\n      .kpi-value { font-size: 22px; font-weight: 600; }\n      .kpi-sub { font-size: 11px; color: var(--text-soft); margin-top: 2px; }\n      .pill-sev {\n        display: inline-flex;\n        align-items: center;\n        border-radius: 999px;\n        padding: 2px 8px;\n        font-size: 11px;\n        margin-right: 4px;\n        background: rgba(15,23,42,0.9);\n        border: 1px solid rgba(55,65,81,0.85);\n      }\n      .pill-sev span { margin-right: 4px; text-transform: uppercase; letter-spacing: 0.08em; }\n      .sev-CRITICAL { color: #fecaca; }\n      .sev-HIGH { color: #fed7aa; }\n      .sev-MEDIUM { color: #facc15; }\n      .sev-LOW { color: #bbf7d0; }\n      .sev-INFO { color: #bae6fd; }\n      .sev-TRACE { color: #e5e7eb; }\n      table {\n        border-collapse: collapse;\n        width: 100%;\n        margin-top: 12px;\n        font-size: 12px;\n      }\n      th, td {\n        border-bottom: 1px solid #1f2933;\n        padding: 7px 6px;\n        text-align: left;\n        vertical-align: top;\n      }\n      th {\n        background: radial-gradient(circle at 0 0, rgba(15,23,42,1), transparent 70%);\n        position: sticky;\n        top: 0;\n        z-index: 2;\n      }\n      tr:nth-child(even) { background: rgba(15,23,42,0.7); }\n      code {\n        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;\n        font-size: 11px;\n      }\n      .loc-cell { font-size: 11px; color: var(--text-soft); }\n      .msg-cell { font-size: 12px; }\n    </style>""")\n    html.append("</head><body>")\n\n    # Header\n    html.append("<div class='vsp-header'>")\n    html.append("<div class='vsp-header-left'>")\n    html.append("<div class='vsp-logo-mark'>VSP</div>")\n    html.append("<div class='vsp-title-block'>")\n    html.append("<div class='vsp-title'>VersaSecure Platform 2025</div>")\n    html.append("<div class='vsp-subtitle'>EXT+ Enterprise Security Profile – Run Report</div>")\n    html.append("</div></div>")\n    html.append("<div class='vsp-header-right'>")\n    html.append(f"<div><strong>Run ID:</strong> {run_id}</div>")\n    if ts:\n        html.append(f"<div><strong>Timestamp:</strong> {ts}</div>")\n    html.append("</div></div>")\n\n    # KPI\n    html.append("<div class='kpi-grid'>")\n    html.append("<div class='kpi-card'><div class='kpi-label'>Total Findings</div>")\n    html.append(f"<div class='kpi-value'>{total}</div>")\n    html.append("<div class='kpi-sub'>Consolidated across all tools</div></div>")\n\n    html.append("<div class='kpi-card'><div class='kpi-label'>Security Score</div>")\n    html.append(f"<div class='kpi-value'>{score}</div>")\n    html.append("<div class='kpi-sub'>0–100 (higher is better)</div></div>")\n\n    html.append("<div class='kpi-card'><div class='kpi-label'>By Severity</div><div>")\n    html.append(f"<span class='pill-sev sev-CRITICAL'><span>CRIT</span>{crit}</span>")\n    html.append(f"<span class='pill-sev sev-HIGH'><span>HIGH</span>{high}</span>")\n    html.append(f"<span class='pill-sev sev-MEDIUM'><span>MED</span>{med}</span>")\n    html.append(f"<span class='pill-sev sev-LOW'><span>LOW</span>{low}</span>")\n    html.append(f"<span class='pill-sev sev-INFO'><span>INFO</span>{info}</span>")\n    html.append(f"<span class='pill-sev sev-TRACE'><span>TRACE</span>{trace}</span>")\n    html.append("</div></div>")\n\n    html.append("<div class='kpi-card'><div class='kpi-label'>Signals</div>")\n    html.append("<div class='kpi-sub'>")\n    html.append(f"<div><strong>Top Tool:</strong> {top_tool}</div>")\n    html.append(f"<div><strong>Top CWE:</strong> {top_cwe}</div>")\n    html.append(f"<div><strong>Top Module:</strong> {top_module}</div>")\n    html.append("</div></div>")\n    html.append("</div>")\n\n    # Table\n    html.append("<div class='section'>")\n    html.append("<div class='kpi-label' style='margin-top:4px;'>Consolidated Findings</div>")\n    if not findings:\n        html.append("<div class='kpi-sub'>Không có findings để hiển thị.</div>")\n    else:\n        html.append(f"<div class='kpi-sub'>Hiển thị {len(findings)} findings đầu tiên (tối đa {max_rows}).</div>")\n        html.append("<table><thead><tr><th>#</th><th>Severity</th><th>Tool</th><th>Rule</th><th>Location</th><th>Message</th></tr></thead><tbody>")\n        for idx, it in enumerate(findings, start=1):\n            sev  = str(_fv(it, "severity", "")).upper()\n            tool = _fv(it, "tool", _fv(it, "scanner", ""))\n            rule = _fv(it, "rule_id", _fv(it, "check_id", ""))\n            file_p = _fv(it, "file", _fv(it, "target", ""))\n            line = _fv(it, "line", _fv(it, "start_line", ""))\n            msg = _fv(it, "message", _fv(it, "description", ""))\n\n            sev_class = f"sev-{sev}" if sev else ""\n            loc = f"{file_p}:{line}" if (file_p or line) else ""\n            html.append("<tr>")\n            html.append(f"<td>{idx}</td>")\n            html.append(f"<td class='{sev_class}'>{sev}</td>")\n            html.append(f"<td>{tool}</td>")\n            html.append(f"<td><code>{rule}</code></td>")\n            html.append(f"<td class='loc-cell'><code>{loc}</code></td>")\n            html.append(f"<td class='msg-cell'>{msg}</td>")\n            html.append("</tr>")\n        html.append("</tbody></table>")\n    html.append("</div>")\n\n    html.append("</body></html>")\n\n    report_dir = run_dir / "report"\n    report_dir.mkdir(parents=True, exist_ok=True)\n    out_path = report_dir / "vsp_run_report.html"\n    out_path.write_text("".join(html), encoding="utf-8")\n    print("[VSP_EXPORT_V3] Generated HTML:", out_path, file=_vsp_sys.stderr, flush=True)\n    return out_path\n\ndef _vsp3_generate_csv(run_dir: _VSPPath) -> _VSPPath:\n    """Generate CSV findings_unified, nếu không có thì header rỗng."""\n    findings_data = _vsp3_load_json(run_dir, [\n        "findings_unified.json",\n        "findings.json",\n    ]) or []\n\n    items = []\n    if isinstance(findings_data, list):\n        items = findings_data\n    elif isinstance(findings_data, dict):\n        if isinstance(findings_data.get("items"), list):\n            items = findings_data["items"]\n        elif isinstance(findings_data.get("results"), list):\n            items = findings_data["results"]\n\n    cols = ["severity", "tool", "rule_id", "file", "line", "message", "cwe", "category"]\n\n    def _g(it, key):\n        v = it.get(key, "")\n        if isinstance(v, (list, dict)):\n            return _vsp_json.dumps(v, ensure_ascii=False)\n        return v\n\n    report_dir = run_dir / "report"\n    report_dir.mkdir(parents=True, exist_ok=True)\n    out_path = report_dir / "vsp_findings_unified.csv"\n\n    with out_path.open("w", encoding="utf-8", newline="") as f:\n        writer = _vsp_csv.writer(f)\n        writer.writerow(cols)\n        for it in items:\n            writer.writerow([\n                _g(it, "severity"),\n                _g(it, "tool") or _g(it, "scanner"),\n                _g(it, "rule_id") or _g(it, "check_id"),\n                _g(it, "file") or _g(it, "target"),\n                _g(it, "line") or _g(it, "start_line"),\n                _g(it, "message") or _g(it, "description"),\n                _g(it, "cwe") or _g(it, "cwe_id"),\n                _g(it, "category") or _g(it, "type"),\n            ])\n\n    print("[VSP_EXPORT_V3] Generated CSV:", out_path, file=_vsp_sys.stderr, flush=True)\n    return out_path\n\n@app.route("/api/vsp/run_exports_v3", methods=["GET"])\ndef api_vsp_run_exports_v3():\n    """Export 1 run: html/csv – bản V3 (thương mại, tự generate nếu cần)."""\n    run_id = request.args.get("run_id", "").strip()\n    fmt = request.args.get("format", "html").strip().lower()\n    print(f"[VSP_EXPORT_V3] run_id={run_id} fmt={fmt}", file=_vsp_sys.stderr, flush=True)\n\n    if not run_id:\n        abort(400, "Missing run_id")\n\n    run_dir = _vsp3_run_dir(run_id)\n    if not run_dir:\n        abort(404, f"Run not found: {run_id}")\n\n    if fmt == "html":\n        target = _vsp3_generate_html(run_dir)\n    elif fmt == "csv":\n        target = _vsp3_generate_csv(run_dir)\n    else:\n        abort(400, f"Unsupported format: {fmt}")\n\n    return send_file(target, as_attachment=False)\n# ===================== END VSP_RUN_EXPORTS_API_V3 =====================\n\n