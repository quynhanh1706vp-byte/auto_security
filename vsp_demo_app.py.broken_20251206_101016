from flask import Flask, jsonify, request, render_template, redirect
from vsp_run_exports_api_v3 import vsp_exports_bp
from pathlib import Path
import json

# BASE_DIR = /home/test/Data/SECURITY_BUNDLE/ui
BASE_DIR = Path(__file__).resolve().parent
# ROOT_DIR = /home/test/Data/SECURITY_BUNDLE
ROOT_DIR = BASE_DIR.parent
OUT_DIR = ROOT_DIR / "out"

app = Flask(__name__, template_folder="templates", static_folder="static")
app.register_blueprint(vsp_exports_bp)


# ======================= Utils =======================

def _iter_full_ext_runs():
    """
    Liệt kê các RUN_VSP_FULL_EXT_* trong thư mục out/.
    """
    if not OUT_DIR.is_dir():
        return []
    for d in OUT_DIR.iterdir():
        if d.is_dir() and d.name.startswith("RUN_VSP_FULL_EXT"):
            yield d


def _find_run_dir(run_id: str | None):
    """
    - Nếu run_id rỗng hoặc 'latest' → chọn run mới nhất.
    - Nếu có run_id → dùng run đó nếu tồn tại.
    """
    if not OUT_DIR.is_dir():
        return None

    if not run_id or run_id == "latest":
        runs = sorted(_iter_full_ext_runs(), key=lambda p: p.stat().st_mtime, reverse=True)
        return runs[0] if runs else None

    candidate = OUT_DIR / run_id
    return candidate if candidate.is_dir() else None


# ======================= Routes UI =======================

@app.route("/")
def index():
    # Giữ nguyên hành vi: vào / → nhảy sang /security_bundle
    return redirect("/security_bundle")


@app.route("/security_bundle")
def security_bundle():
    # Giữ nguyên template UI VSP 2025
    return render_template("vsp_dashboard_2025.html")


# ======================= API: /api/vsp/dashboard_v3 =======================

@app.route("/api/vsp/dashboard_v3")
def api_vsp_dashboard_v3():
    """
    Trả về dashboard data cho 1 run:
    {
      ok: true/false,
      run_id: "...",
      total_findings: int,
      by_severity: {...},
      security_score: ...,
      top_risky_tool: ...,
      top_cwe: ...,
      top_module: ...
      + giữ nguyên các field khác nếu summary_unified.json có
    }
    """
    run_id = request.args.get("run_id")
    run_dir = _find_run_dir(run_id)
    if not run_dir:
        return jsonify({"ok": False, "error": "run_not_found", "run_id": run_id}), 404

    report_dir = run_dir / "report"
    summary_file = report_dir / "summary_unified.json"
    findings_file = report_dir / "findings_unified.json"

    data = {}
    findings = []

    # Đọc summary_unified.json nếu có
    if summary_file.is_file():
        try:
            with summary_file.open("r", encoding="utf-8") as f:
                data = json.load(f)
        except Exception:
            data = {}

    # Đọc findings_unified.json nếu cần
    if findings_file.is_file():
        try:
            with findings_file.open("r", encoding="utf-8") as f:
                findings = json.load(f)
        except Exception:
            findings = []

    # Fallback: tự tính total_findings nếu chưa có
    if "total_findings" not in data and isinstance(findings, list):
        data["total_findings"] = len(findings)

    # Fallback: tự tính by_severity nếu chưa có
    if "by_severity" not in data and isinstance(findings, list):
        by_sev = {}
        for it in findings:
            sev = it.get("severity_effective") or it.get("severity") or "INFO"
            by_sev[sev] = by_sev.get(sev, 0) + 1
        data["by_severity"] = by_sev

    # Đảm bảo có các field KPI chính, nếu thiếu thì fill default
    data.setdefault("security_score", data.get("security_score", 0))
    data.setdefault("top_risky_tool", data.get("top_risky_tool"))
    data.setdefault("top_cwe", data.get("top_cwe"))
    data.setdefault("top_module", data.get("top_module"))

    data["ok"] = True
    data["run_id"] = run_dir.name
    return jsonify(data)


# ======================= API: /api/vsp/runs_index_v3 =======================

@app.route("/api/vsp/runs_index_v3")
def api_vsp_runs_index_v3():
    """
    Trả về list các run để tab Runs & Reports dùng:
    [
      {
        run_id: "...",
        total_findings: int,
        by_severity: {...},
        by_tool: {...},
        ts: ...
      },
      ...
    ]
    """
    limit = request.args.get("limit", type=int) or 200
    runs = sorted(_iter_full_ext_runs(), key=lambda p: p.stat().st_mtime, reverse=True)

    items = []
    for d in runs:
        report_dir = d / "report"
        summary_file = report_dir / "summary_unified.json"
        findings_file = report_dir / "findings_unified.json"

        total = 0
        by_sev = {}
        by_tool = {}
        findings = []

        # Cố gắng lấy từ summary_unified.json
        if summary_file.is_file():
            try:
                with summary_file.open("r", encoding="utf-8") as f:
                    sdata = json.load(f)
                total = sdata.get("total_findings", total)
                by_sev = sdata.get("by_severity", by_sev)
                by_tool = sdata.get("by_tool", by_tool)
            except Exception:
                pass

        # Nếu thiếu, fallback đọc findings_unified.json
        if findings_file.is_file():
            try:
                with findings_file.open("r", encoding="utf-8") as f:
                    findings = json.load(f)
            except Exception:
                findings = []

        if not total and isinstance(findings, list):
            total = len(findings)
        if not by_sev and isinstance(findings, list):
            for it in findings:
                sev = it.get("severity_effective") or it.get("severity") or "INFO"
                by_sev[sev] = by_sev.get(sev, 0) + 1
        if not by_tool and isinstance(findings, list):
            for it in findings:
                tool = it.get("tool") or it.get("scanner") or "unknown"
                by_tool[tool] = by_tool.get(tool, 0) + 1

        items.append({
            "run_id": d.name,
            "total_findings": total,
            "by_severity": by_sev,
            "by_tool": by_tool,
            "ts": None,
        })
        if len(items) >= limit:
            break

    return jsonify(items)


# ======================= API: /api/vsp/datasource_v2 =======================

@app.route("/api/vsp/datasource_v2")
@app.route("/api/vsp/datasource")
def api_vsp_datasource_v2():
    """
    Data source cho tab Data Source / Dashboard:
    {
      ok: true,
      run_id: "...",
      filters: {...},
      total: N,
      items: [...]
    }
    Có filter theo:
      - severity (severity_effective / severity)
      - tool (tool / scanner)
      - q (search trong message, rule_id, rule_name, file, path)
    """
    run_id = request.args.get("run_id")
    q = request.args.get("q")
    severity_filter = request.args.get("severity")
    tool_filter = request.args.get("tool")
    limit = request.args.get("limit", type=int) or 1000

    run_dir = _find_run_dir(run_id)
    if not run_dir:
        return jsonify({"ok": False, "error": "run_not_found", "run_id": run_id}), 404

    report_dir = run_dir / "report"
    findings_file = report_dir / "findings_unified.json"
    if not findings_file.is_file():
        return jsonify({"ok": False, "error": "findings_not_found", "run_id": run_dir.name}), 404

    try:
        with findings_file.open("r", encoding="utf-8") as f:
            items = json.load(f)
    except Exception:
        items = []

    if not isinstance(items, list):
        return jsonify({"ok": False, "error": "bad_findings_format"}), 500

    result = []
    q_lower = q.lower() if q else None

    for it in items:
        sev = it.get("severity_effective") or it.get("severity")
        tool = it.get("tool") or it.get("scanner")

        if severity_filter and sev != severity_filter:
            continue
        if tool_filter and tool != tool_filter:
            continue
        if q_lower:
            blob = " ".join(str(it.get(k, "")) for k in ("message", "rule_id", "rule_name", "file", "path"))
            if q_lower not in blob.lower():
                continue

        result.append(it)
        if len(result) >= limit:
            break

    payload = {
        "ok": True,
        "run_id": run_dir.name,
        "filters": {
            "limit": limit,
            "q": q,
            "severity": severity_filter,
            "tool": tool_filter,
        },
        "total": len(result),
        "items": result,
    }
    return jsonify(payload)


# ======================= API: /api/vsp/settings/get =======================

@app.route("/api/vsp/settings/get")
def api_vsp_settings_get():
    """
    Settings đơn giản cho tab Settings:
    - env: thông tin môi trường
    - tools: list tool + enabled
    """
    tools = {
        "gitleaks":  {"enabled": True, "label": "Gitleaks (Secrets)"},
        "semgrep":   {"enabled": True, "label": "Semgrep (SAST)"},
        "kics":      {"enabled": True, "label": "KICS (IaC)"},
        "codeql":    {"enabled": True, "label": "CodeQL"},
        "bandit":    {"enabled": True, "label": "Bandit (Python)"},
        "trivy_fs":  {"enabled": True, "label": "Trivy FS"},
        "syft":      {"enabled": True, "label": "Syft (SBOM)"},
        "grype":     {"enabled": True, "label": "Grype (Vuln)"},
    }
    env = {
        "profile": "EXT+",
        "root_dir": str(ROOT_DIR),
        "out_dir": str(OUT_DIR),
    }
    return jsonify({"ok": True, "env": env, "tools": tools})


# ======================= API: /api/vsp/overrides/list =======================

@app.route("/api/vsp/overrides/list")
def api_vsp_overrides_list():
    """
    Trả danh sách override rule (tạm thời để trống).
    UI vẫn render được, không lỗi.
    """
    return jsonify({"ok": True, "total": 0, "items": []})


# ======================= Main =======================

if __name__ == "__main__":
    # Giữ nguyên port 8910 cho VSP UI
    app.run(host="0.0.0.0", port=8910, debug=True)
