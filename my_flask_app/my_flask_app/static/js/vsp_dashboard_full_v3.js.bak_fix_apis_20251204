// VSP Dashboard FULL v3
// Dùng /api/vsp/dashboard_v2, /api/vsp/dashboard_tables và /api/vsp/datasource
(function () {
  async function fetchJson(url) {
    try {
      const res = await fetch(url);
      if (!res.ok) {
        console.warn('[VSP][DASH_FULL] HTTP', url, res.status);
        return null;
      }
      return await res.json();
    } catch (e) {
      console.error('[VSP][DASH_FULL] fetch error', url, e);
      return null;
    }
  }

  function setText(id, value) {
    var el = document.getElementById(id);
    if (!el) return;
    el.textContent = value;
  }

  function computeSecurityScore(sev) {
    if (!sev) return null;
    var total =
      (sev.CRITICAL || 0) +
      (sev.HIGH || 0) +
      (sev.MEDIUM || 0) +
      (sev.LOW || 0) +
      (sev.INFO || 0) +
      (sev.TRACE || 0);
    if (!total) return null;
    var bad = (sev.CRITICAL || 0) + (sev.HIGH || 0);
    var score = Math.round(100 * (1 - bad / total));
    if (score < 0) score = 0;
    if (score > 100) score = 100;
    return score;
  }

  function topToolFromSummary(summary) {
    var byTool = summary.by_tool || {};
    var bestTool = null;
    var bestVal = -1;
    Object.keys(byTool).forEach(function (tool) {
      var v = byTool[tool];
      var num = (typeof v === 'number') ? v : (Number(v) || 0);
      if (num > bestVal) {
        bestVal = num;
        bestTool = tool;
      }
    });
    return bestTool;
  }

  function renderKpi(dashV2, tables) {
    var sev = (dashV2.summary && dashV2.summary.by_severity) || {};

    var total =
      (sev.CRITICAL || 0) +
      (sev.HIGH || 0) +
      (sev.MEDIUM || 0) +
      (sev.LOW || 0) +
      (sev.INFO || 0) +
      (sev.TRACE || 0);

    setText('kpi-total-findings-value', String(total));
    setText('kpi-critical-value', String(sev.CRITICAL || 0));
    setText('kpi-high-value', String(sev.HIGH || 0));
    setText('kpi-medium-value', String(sev.MEDIUM || 0));
    setText('kpi-low-value', String(sev.LOW || 0));
    setText('kpi-infotrace-value', String((sev.INFO || 0) + (sev.TRACE || 0)));

    var score = computeSecurityScore(sev);
    setText('kpi-security-score-value', score != null ? (score + '%') : 'N/A');

    var topTool = topToolFromSummary(dashV2.summary || {}) || 'N/A';
    setText('kpi-top-tool-value', topTool);

    var topCwe = (tables && tables.top_cwe) || 'N/A';
    setText('kpi-top-cwe-value', topCwe);

    var topModule = 'N/A';
    if (tables && Array.isArray(tables.top_modules) && tables.top_modules.length) {
      var m = tables.top_modules[0];
      topModule = m.module || m.name || 'N/A';
    }
    setText('kpi-top-module-value', topModule);
  }

  var chartDonut, chartTool, chartTrend, chartTopCwe;

  function renderSeverityDonut(sev) {
    if (!window.Chart) {
      console.warn('[VSP][DASH_FULL] Chart.js missing');
      return;
    }
    var ctx = document.getElementById('chart-severity-donut');
    if (!ctx) return;

    var labels = ['CRITICAL', 'HIGH', 'MEDIUM', 'LOW', 'INFO', 'TRACE'];
    var data = labels.map(function (l) { return sev[l] || 0; });

    if (chartDonut) chartDonut.destroy();
    chartDonut = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: labels,
        datasets: [{
          data: data
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        cutout: '65%',
        plugins: {
          legend: { display: true, position: 'bottom' }
        }
      }
    });

    var total = data.reduce(function (a, b) { return a + b; }, 0);
    var legendEl = document.getElementById('chart-severity-legend');
    if (legendEl) {
      legendEl.textContent =
        'Total ' + total + ' findings – ' +
        'CRIT ' + (sev.CRITICAL || 0) + ', ' +
        'HIGH ' + (sev.HIGH || 0) + ', ' +
        'MED ' + (sev.MEDIUM || 0) + ', ' +
        'LOW ' + (sev.LOW || 0) + ', ' +
        'INFO ' + (sev.INFO || 0) + ', ' +
        'TRACE ' + (sev.TRACE || 0);
    }
  }

  function renderCritHighByTool(summary) {
    if (!window.Chart) return;
    var ctx = document.getElementById('chart-crit-high-by-tool');
    if (!ctx) return;

    var byToolSev = summary.by_tool_severity || {};
    var byTool = summary.by_tool || {};
    var tools = Object.keys(byTool).sort();
    var values = tools.map(function (t) {
      var sev = byToolSev[t] || {};
      var crit = sev.CRITICAL || 0;
      var high = sev.HIGH || 0;
      var val = crit + high;
      if (!val) val = byTool[t] || 0;
      return val;
    });

    if (chartTool) chartTool.destroy();
    chartTool = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: tools,
        datasets: [{
          label: 'CRIT + HIGH',
          data: values
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          x: { ticks: { autoSkip: false } },
          y: { beginAtZero: true }
        }
      }
    });
  }

  function renderTrendSingleRun(total) {
    if (!window.Chart) return;
    var ctx = document.getElementById('chart-trend');
    if (!ctx) return;
    if (chartTrend) chartTrend.destroy();

    chartTrend = new Chart(ctx, {
      type: 'line',
      data: {
        labels: ['Latest run'],
        datasets: [{
          label: 'Total findings',
          data: [total]
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true } }
      }
    });
  }

  function renderTopCweChart(tables) {
    if (!window.Chart) return;
    var ctx = document.getElementById('chart-top-cwe');
    if (!ctx) return;

    var list = (tables && tables.top_cwe_list) || [];
    var labels = list.map(function (x) { return x.cwe || x.id || ''; });
    var values = list.map(function (x) { return x.count || 0; });

    if (chartTopCwe) chartTopCwe.destroy();
    chartTopCwe = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Findings',
          data: values
        }]
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: { x: { beginAtZero: true } }
      }
    });
  }

  function renderTopFindingsTable(items) {
    var table = document.getElementById('table-top-findings');
    if (!table) return;
    var tbody = table.querySelector('tbody');
    if (!tbody) return;
    tbody.innerHTML = '';

    if (!Array.isArray(items) || !items.length) {
      var tr = document.createElement('tr');
      var td = document.createElement('td');
      td.colSpan = 5;
      td.textContent = 'No HIGH/CRITICAL findings from latest run.';
      tr.appendChild(td);
      tbody.appendChild(tr);
      return;
    }

    items.forEach(function (it) {
      var tr = document.createElement('tr');

      var sev = String((it.severity || it.sev || '')).toUpperCase();
      var tool = it.tool || it.source || '';
      var rule = it.rule_id || it.rule || it.check_id || '';
      var file = it.file || it.path || it.location || '';
      var msg  = it.message || it.title || it.description || '';

      function td(text) {
        var c = document.createElement('td');
        c.textContent = text || '';
        return c;
      }

      tr.appendChild(td(sev));
      tr.appendChild(td(tool));
      tr.appendChild(td(rule));
      tr.appendChild(td(file));
      tr.appendChild(td(msg));

      tbody.appendChild(tr);
    });
  }

  function renderTopRiskFilesTable(topFiles) {
    var table = document.getElementById('table-top-risk-files');
    if (!table) return;
    var tbody = table.querySelector('tbody');
    if (!tbody) return;
    tbody.innerHTML = '';

    if (!Array.isArray(topFiles) || !topFiles.length) {
      var tr = document.createElement('tr');
      var td = document.createElement('td');
      td.colSpan = 5;
      td.textContent = 'No data in summary.top_files.';
      tr.appendChild(td);
      tbody.appendChild(tr);
      return;
    }

    topFiles.forEach(function (it) {
      var path = it.path || it.file || '';
      var crit = (it.CRIT  != null) ? it.CRIT  : (it.crit  || 0);
      var high = (it.HIGH  != null) ? it.HIGH  : (it.high  || 0);
      var med  = (it.MED   != null) ? it.MED   :
                 (it.MEDIUM != null ? it.MEDIUM : (it.medium || 0));
      var low  = (it.LOW   != null) ? it.LOW   : (it.low   || 0);

      var tr = document.createElement('tr');
      function td(text) {
        var c = document.createElement('td');
        c.textContent = String(text || '');
        return c;
      }

      tr.appendChild(td(path));
      tr.appendChild(td(crit));
      tr.appendChild(td(high));
      tr.appendChild(td(med));
      tr.appendChild(td(low));

      tbody.appendChild(tr);
    });
  }

  function renderTopCweTable(tables) {
    var table = document.getElementById('table-top-cwe');
    if (!table) return;
    var tbody = table.querySelector('tbody');
    if (!tbody) return;
    tbody.innerHTML = '';

    var list = (tables && tables.top_cwe_list) || [];
    if (!list.length) {
      var tr = document.createElement('tr');
      var td = document.createElement('td');
      td.colSpan = 2;
      td.textContent = 'No CWE data in summary.';
      tr.appendChild(td);
      tbody.appendChild(tr);
      return;
    }

    list.forEach(function (it) {
      var tr = document.createElement('tr');
      var cwe = it.cwe || it.id || '';
      var count = it.count || 0;

      var td1 = document.createElement('td');
      td1.textContent = cwe;
      var td2 = document.createElement('td');
      td2.textContent = String(count);

      tr.appendChild(td1);
      tr.appendChild(td2);
      tbody.appendChild(tr);
    });
  }

  function renderTopModulesTable(tables) {
    var table = document.getElementById('table-top-modules');
    if (!table) return;
    var tbody = table.querySelector('tbody');
    if (!tbody) return;
    tbody.innerHTML = '';

    var mods = (tables && tables.top_modules) || [];
    if (!mods.length) {
      var tr = document.createElement('tr');
      var td = document.createElement('td');
      td.colSpan = 2;
      td.textContent = 'No module/package stats in summary.';
      tr.appendChild(td);
      tbody.appendChild(tr);
      return;
    }

    mods.forEach(function (it) {
      var tr = document.createElement('tr');
      var name = it.module || it.name || '';
      var count = it.count || 0;

      var td1 = document.createElement('td');
      td1.textContent = name;
      var td2 = document.createElement('td');
      td2.textContent = String(count);

      tr.appendChild(td1);
      tr.appendChild(td2);
      tbody.appendChild(tr);
    });
  }

  function renderRiskSummaryText(dashV2) {
    var sev = (dashV2.summary && dashV2.summary.by_severity) || {};
    var total =
      (sev.CRITICAL || 0) +
      (sev.HIGH || 0) +
      (sev.MEDIUM || 0) +
      (sev.LOW || 0) +
      (sev.INFO || 0) +
      (sev.TRACE || 0);

    var txt =
      'Latest FULL EXT run detected ' + total + ' findings – ' +
      (sev.CRITICAL || 0) + ' CRITICAL, ' +
      (sev.HIGH || 0) + ' HIGH, ' +
      (sev.MEDIUM || 0) + ' MEDIUM and ' +
      ((sev.LOW || 0) + (sev.INFO || 0) + (sev.TRACE || 0)) + ' LOW/INFO/TRACE.';

    var el = document.getElementById('vsp-risk-summary-text');
    if (el) el.textContent = txt;
  }

  async function initDashboardFull() {
    var dashV2 = await fetchJson('/api/vsp/dashboard_v2');
    var tables = await fetchJson('/api/vsp/dashboard_tables');
    var topFindings = await fetchJson('/api/vsp/datasource?severity=HIGH&limit=10');

    if (!dashV2 || !dashV2.summary) {
      console.warn('[VSP][DASH_FULL] No summary from dashboard_v2');
      return;
    }

    renderKpi(dashV2, tables || {});

    var sev = dashV2.summary.by_severity || {};
    renderSeverityDonut(sev);
    renderCritHighByTool(dashV2.summary);

    var total =
      (sev.CRITICAL || 0) +
      (sev.HIGH || 0) +
      (sev.MEDIUM || 0) +
      (sev.LOW || 0) +
      (sev.INFO || 0) +
      (sev.TRACE || 0);
    renderTrendSingleRun(total);
    renderTopCweChart(tables || {});

    var items = (topFindings && topFindings.items) || [];
    renderTopFindingsTable(items);
    renderTopRiskFilesTable((tables && tables.top_files) || []);
    renderTopCweTable(tables || {});
    renderTopModulesTable(tables || {});
    renderRiskSummaryText(dashV2);
  }

  document.addEventListener('DOMContentLoaded', function () {
    var tab = document.getElementById('tab-dashboard');
    if (!tab) return;
    setTimeout(initDashboardFull, 800);
  });

  if (!window.VSP) window.VSP = {};
  window.VSP.initDashboardFull = initDashboardFull;
})();
