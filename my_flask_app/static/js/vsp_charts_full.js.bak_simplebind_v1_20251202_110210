/* ============================================================
   VSP Dashboard Charts – FULL COMMERCIAL STYLE
   (Trend + Top CWE + Critical/High by Tool)
   ============================================================ */

/* ------------------------------------------------------------
   1) TREND – FINDINGS OVER TIME
   ------------------------------------------------------------ */
function renderTrendFindingsOverTime(targetSelector, rows) {
  var card = typeof targetSelector === 'string'
    ? document.querySelector(targetSelector)
    : targetSelector;
  if (!card) return;

  if (!Array.isArray(rows)) rows = [];
  var data = rows.slice(0, 10);

  card.innerHTML = `
    <div class="chart-header">
      <div class="chart-title-main">TREND – FINDINGS OVER TIME</div>
      <div class="chart-sub">Last 10 runs.</div>
    </div>
  `;

  var canvas = document.createElement('canvas');
  canvas.className = 'vsp-chart-canvas';
  canvas.style.width = '100%';
  canvas.style.height = '200px';
  card.appendChild(canvas);

  var dpr  = window.devicePixelRatio || 1;
  var rect = canvas.getBoundingClientRect();
  var w    = rect.width || card.clientWidth || 450;
  var h    = 200;

  canvas.width  = w * dpr;
  canvas.height = h * dpr;

  var ctx = canvas.getContext('2d');
  ctx.scale(dpr, dpr);
  ctx.clearRect(0, 0, w, h);

  if (!data.length) {
    ctx.fillStyle = '#9ca3af';
    ctx.font = '12px Inter, sans-serif';
    ctx.textAlign   = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText('No data available.', w/2, h/2);
    return;
  }

  var ys = data.map(function(r){ return r.total_findings || r.findings || 0; });
  var minY = Math.min.apply(null, ys);
  var maxY = Math.max.apply(null, ys);
  if (minY === maxY) { minY -= 10; maxY += 10; }
  var pad = (maxY - minY) * 0.2;
  minY = Math.max(0, Math.floor((minY - pad)/10)*10);
  maxY = Math.ceil((maxY + pad)/10)*10;

  var marginLeft   = 50;
  var marginRight  = 20;
  var marginTop    = 18;
  var marginBottom = 32;

  var plotW = w - marginLeft - marginRight;
  var plotH = h - marginTop - marginBottom;

  function xAt(i) {
    if (data.length === 1) return marginLeft + plotW/2;
    var t = i / (data.length - 1);
    return marginLeft + t * plotW;
  }
  function yAt(v) {
    var t = (v - minY) / (maxY - minY);
    return marginTop + plotH - t * plotH;
  }

  // Grid Y
  var steps = 4;
  ctx.font = '10px Inter, sans-serif';
  ctx.fillStyle = '#cbd5e1';
  ctx.textAlign = 'right';
  ctx.textBaseline = 'middle';

  for (var s=0; s<=steps; s++) {
    var v = minY + (maxY - minY)*(s/steps);
    var y = yAt(v);

    ctx.strokeStyle = 'rgba(148,163,184,0.22)';
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(marginLeft, y);
    ctx.lineTo(marginLeft + plotW, y);
    ctx.stroke();

    ctx.fillText(Math.round(v), marginLeft - 6, y);
  }

  // Axis X
  ctx.strokeStyle = 'rgba(148,163,184,0.35)';
  ctx.lineWidth = 1.3;
  ctx.beginPath();
  ctx.moveTo(marginLeft, marginTop + plotH);
  ctx.lineTo(marginLeft + plotW, marginTop + plotH);
  ctx.stroke();

  // Labels X
  ctx.fillStyle = '#e5e7eb';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'top';

  data.forEach(function(_, i){
    var x = xAt(i);
    ctx.fillText('Run ' + (i+1), x, marginTop + plotH + 6);
  });

  // Area fill
  ctx.beginPath();
  data.forEach(function(r,i){
    var x = xAt(i);
    var y = yAt(r.total_findings || r.findings || 0);
    if (i===0) ctx.moveTo(x,y);
    else       ctx.lineTo(x,y);
  });
  ctx.lineTo(marginLeft+plotW, marginTop+plotH);
  ctx.lineTo(marginLeft,        marginTop+plotH);
  ctx.closePath();
  ctx.fillStyle = 'rgba(56,189,248,0.18)';
  ctx.fill();

  // Line
  ctx.beginPath();
  data.forEach(function(r,i){
    var x = xAt(i);
    var y = yAt(r.total_findings || r.findings || 0);
    if (i===0) ctx.moveTo(x,y);
    else       ctx.lineTo(x,y);
  });
  ctx.strokeStyle = '#38bdf8';
  ctx.lineWidth = 2;
  ctx.stroke();

  // Points
  data.forEach(function(r,i){
    var x = xAt(i);
    var y = yAt(r.total_findings || r.findings || 0);
    ctx.beginPath();
    ctx.arc(x,y,3,0,Math.PI*2);
    ctx.fillStyle='#0f172a';
    ctx.fill();
    ctx.strokeStyle='#38bdf8';
    ctx.lineWidth=2;
    ctx.stroke();
  });
}

/* ------------------------------------------------------------
   2) TOP CWE EXPOSURE – horizontal bar
   ------------------------------------------------------------ */
function renderTopCWEExposure(targetSelector, cweStats) {
  var card = typeof targetSelector === 'string'
    ? document.querySelector(targetSelector)
    : targetSelector;
  if (!card) return;

  if (!Array.isArray(cweStats)) cweStats = [];

  var sorted = cweStats
    .slice()
    .sort((a,b)=> (b.count||0)-(a.count||0))
    .slice(0,5);

  card.innerHTML = `
    <div class="chart-header">
      <div class="chart-title-main">TOP CWE EXPOSURE</div>
      <div class="chart-sub">Mapped from rules / CVEs.</div>
    </div>
  `;

  var canvas = document.createElement('canvas');
  canvas.style.width = '100%';
  canvas.style.height = '180px';
  card.appendChild(canvas);

  var dpr = window.devicePixelRatio || 1;
  var rect = canvas.getBoundingClientRect();
  var w = rect.width || card.clientWidth || 420;
  var h = 180;

  canvas.width = w*dpr;
  canvas.height = h*dpr;

  var ctx = canvas.getContext('2d');
  ctx.scale(dpr, dpr);
  ctx.clearRect(0,0,w,h);

  if (!sorted.length) {
    ctx.fillStyle='#9ca3af';
    ctx.font='12px Inter, sans-serif';
    ctx.textAlign='center';
    ctx.textBaseline='middle';
    ctx.fillText('No CWE mapped.', w/2, h/2);
    return;
  }

  var maxVal = sorted.reduce((m,r)=>Math.max(m,r.count||0), 0);
  if (maxVal===0) maxVal=1;

  var ml = 70, mr = 20, mt = 10, mb = 10;
  var plotW = w - ml - mr;
  var plotH = h - mt - mb;

  var barGap = 6;
  var barH = (plotH - barGap*(sorted.length-1)) / sorted.length;

  ctx.font='11px Inter, sans-serif';
  ctx.textBaseline='middle';

  sorted.forEach(function(row,i){
    var v = row.count || 0;
    var y = mt + i*(barH+barGap) + barH/2;

    ctx.fillStyle='#e5e7eb';
    ctx.textAlign='right';
    ctx.fillText(row.cwe || row.id || 'CWE', ml-10, y);

    var barW = plotW*(v/maxVal);

    ctx.fillStyle='rgba(59,130,246,0.85)';
    ctx.fillRect(ml, y - barH/2, barW, barH);

    ctx.fillStyle='#e5e7eb';
    ctx.textAlign='left';
    ctx.fillText(String(v), ml+barW+6, y);
  });
}

/* ------------------------------------------------------------
   3) CRITICAL / HIGH BY TOOL – grouped bars
   ------------------------------------------------------------ */
function renderCriticalHighByTool(targetSelector, toolStats) {
  var card = typeof targetSelector === 'string'
    ? document.querySelector(targetSelector)
    : targetSelector;
  if (!card) return;

  if (!Array.isArray(toolStats)) toolStats = [];

  var order = ['semgrep','codeql','trivy_fs','gitleaks','grype','kics','bandit'];
  toolStats = toolStats.slice().sort(function(a,b){
    var ia = order.indexOf(a.tool);
    var ib = order.indexOf(b.tool);
    if (ia===-1 && ib===-1) return a.tool.localeCompare(b.tool);
    if (ia===-1) return 1;
    if (ib===-1) return -1;
    return ia-ib;
  });

  card.innerHTML = `
    <div class="chart-header">
      <div class="chart-title-main">CRITICAL / HIGH BY TOOL</div>
      <div class="chart-sub">Semgrep, CodeQL, Trivy, Gitleaks, KICS…</div>
      <div class="chart-legend-row chart-legend-row--center">
        <div class="chart-legend-item"><span class="legend-color" style="background:#38bdf8"></span><span>Critical</span></div>
        <div class="chart-legend-item"><span class="legend-color" style="background:#fb7185"></span><span>High</span></div>
      </div>
    </div>
  `;

  var canvas = document.createElement('canvas');
  canvas.style.width = '100%';
  canvas.style.height = '180px';
  card.appendChild(canvas);

  var dpr = window.devicePixelRatio || 1;
  var rect = canvas.getBoundingClientRect();
  var w = rect.width || card.clientWidth || 440;
  var h = 180;

  canvas.width = w*dpr;
  canvas.height = h*dpr;

  var ctx = canvas.getContext('2d');
  ctx.scale(dpr, dpr);
  ctx.clearRect(0,0,w,h);

  if (!toolStats.length) {
    ctx.fillStyle='#9ca3af';
    ctx.font='12px Inter, sans-serif';
    ctx.textAlign='center';
    ctx.textBaseline='middle';
    ctx.fillText('No data.', w/2, h/2);
    return;
  }

  var maxVal = 0;
  toolStats.forEach(r=>{
    maxVal = Math.max(maxVal, r.critical||0, r.high||0);
  });
  if (maxVal===0) maxVal=1;

  var ml=40, mr=20, mt=10, mb=26;
  var plotW = w - ml - mr;
  var plotH = h - mt - mb;

  // Grid
  ctx.font='10px Inter, sans-serif';
  ctx.textBaseline='middle';
  ctx.textAlign='right';
  ctx.fillStyle='#e5e7eb';
  ctx.strokeStyle='rgba(148,163,184,0.2)';

  for (var s=0; s<=4; s++){
    var v = maxVal*(s/4);
    var y = mt + plotH - plotH*(v/maxVal);

    ctx.beginPath();
    ctx.moveTo(ml, y);
    ctx.lineTo(ml+plotW, y);
    ctx.stroke();

    ctx.fillText(Math.round(v), ml-6, y);
  }

  var n = toolStats.length;
  var groupW = plotW / n;
  var barW = groupW * 0.28;
  var gap = barW * 0.25;

  ctx.textAlign='center';
  ctx.textBaseline='top';
  ctx.fillStyle='#e5e7eb';

  toolStats.forEach(function(r,i){
    var gx = ml + groupW*(i+0.5);
    ctx.fillText(r.tool.toUpperCase(), gx, mt+plotH+4);

    var yc = (r.critical||0);
    var yh = (r.high||0);

    var hC = plotH*(yc/maxVal);
    var hH = plotH*(yh/maxVal);

    var xC = gx - gap - barW;
    var xH = gx + gap;

    ctx.fillStyle='#38bdf8';
    ctx.fillRect(xC, mt+plotH-hC, barW, hC);

    ctx.fillStyle='#fb7185';
    ctx.fillRect(xH, mt+plotH-hH, barW, hH);
  });
}

/* ===== VSP OVERRIDE – NORMALIZE DOUGHNUT (SEVERITY) ===== */
(function () {
  if (typeof Chart === "undefined") {
    if (window.console && console.warn) {
      console.warn("[VSP][CHARTS] Chart.js not found for donut override.");
    }
    return;
  }

  // Lấy default cho doughnut
  var dDefaults = Chart.defaults.doughnut || (Chart.defaults.doughnut = {});

  // KHÔNG giữ aspect ratio cố định theo width/height canvas
  dDefaults.maintainAspectRatio = true;
  dDefaults.aspectRatio = 1;

  // Độ dày vòng donut (70% rỗng bên trong)
  dDefaults.cutout = '70%';

  // Legend dưới đáy cho gọn
  dDefaults.plugins = dDefaults.plugins || {};
  dDefaults.plugins.legend = dDefaults.plugins.legend || {};
  dDefaults.plugins.legend.position = 'bottom';
  dDefaults.plugins.legend.labels = dDefaults.plugins.legend.labels || {};
  dDefaults.plugins.legend.labels.boxWidth = 10;

  // Padding trên/dưới cho đẹp
  dDefaults.layout = dDefaults.layout || {};
  dDefaults.layout.padding = { top: 10, bottom: 10 };
})();

/* ===== VSP OVERRIDE – DOUGHNUT (FINAL TUNING) ===== */
(function () {
  if (typeof Chart === "undefined") {
    if (window.console && console.warn) {
      console.warn("[VSP][CHARTS] Chart.js not found for donut final override.");
    }
    return;
  }

  // Lấy default cho doughnut và chỉnh lại 1 lần cuối
  var dDefaults = Chart.defaults.doughnut || (Chart.defaults.doughnut = {});

  // Luôn giữ tỉ lệ hình tròn
  dDefaults.maintainAspectRatio = true;
  dDefaults.aspectRatio = 1;

  // Độ dày vòng donut
  dDefaults.cutout = '70%';

  // Legend dưới, gọn
  dDefaults.plugins = dDefaults.plugins || {};
  dDefaults.plugins.legend = dDefaults.plugins.legend || {};
  dDefaults.plugins.legend.position = 'bottom';
  dDefaults.plugins.legend.labels = dDefaults.plugins.legend.labels || {};
  dDefaults.plugins.legend.labels.boxWidth = 10;

  // Padding cho gọn mắt
  dDefaults.layout = dDefaults.layout || {};
  dDefaults.layout.padding = { top: 10, bottom: 10 };
})();

/* ===== VSP PLUGIN – FIX SIZE FOR DOUGHNUT (SEVERITY) ===== */
(function () {
  if (typeof Chart === "undefined") {
    if (window.console && console.warn) {
      console.warn("[VSP][CHARTS] Chart.js not found for size plugin.");
    }
    return;
  }

  const vspSeveritySizeFix = {
    id: "vspSeveritySizeFix",
    afterInit(chart, args, opts) {
      if (chart.config.type !== "doughnut") return;

      const canvas = chart.canvas;
      const parent = canvas && canvas.parentNode;
      if (!parent) return;

      // Khung cố định cho donut, bất kể card to cỡ nào
      parent.style.display = "flex";
      parent.style.alignItems = "center";
      parent.style.justifyContent = "center";
      parent.style.height = "260px";

      canvas.style.maxWidth = "260px";
      canvas.style.maxHeight = "260px";
      canvas.style.width = "260px";
      canvas.style.height = "260px";
      canvas.style.margin = "0 auto";
      canvas.style.display = "block";
    }
  };

  Chart.register(vspSeveritySizeFix);
})();

/* ===== VSP DEFAULT – DOUGHNUT SHAPE ===== */
(function () {
  if (typeof Chart === "undefined") return;
  var dDefaults = Chart.defaults.doughnut || (Chart.defaults.doughnut = {});
  dDefaults.maintainAspectRatio = true;
  dDefaults.aspectRatio = 1;   // luôn tròn
  dDefaults.cutout = "70%";    // vòng donut dày vừa
})();

/* ===== VSP FIX – FORCE RESIZE DOUGHNUT ON FIRST LOAD ===== */
(function () {
  if (typeof window === "undefined") return;

  window.addEventListener("load", function () {
    // Đợi thêm 300ms cho CSS + font + layout settle
    setTimeout(function () {
      if (!window.Chart || !Chart.instances) return;

      try {
        Object.keys(Chart.instances).forEach(function (id) {
          var c = Chart.instances[id];
          if (!c || c.config.type !== "doughnut") return;
          if (c.resize) {
            c.resize();
          }
        });
      } catch (e) {
        if (window.console && console.warn) {
          console.warn("[VSP][CHARTS] Error while force-resizing doughnut:", e);
        }
      }
    }, 300);
  });
})();

// [VSP][PATCH] Override renderSeverityBuckets – bind real severity & colors
(function () {
  if (!window.VSP) window.VSP = {};

  window.VSP.renderSeverityBuckets = function (card, payload) {
    if (!card) return;
    if (!payload) payload = {};

    // Thử lấy 6 bucket từ nhiều dạng payload khác nhau
    var sev = payload.severity || (payload.summary && payload.summary.by_severity) || {};
    var crit  = Number(sev.CRITICAL || 0);
    var high  = Number(sev.HIGH     || 0);
    var med   = Number(sev.MEDIUM   || 0);
    var low   = Number(sev.LOW      || 0);
    var info  = Number(sev.INFO     || 0);
    var trace = Number(sev.TRACE    || 0);

    var total = crit + high + med + low + info + trace;

    // Layout card
    card.innerHTML = [
      '<div class="chart-header">',
      '  <div class="chart-title-main">SEVERITY DISTRIBUTION (6 BUCKETS)</div>',
      '  <div class="chart-sub">Normalized from unified findings.</div>',
      '</div>',
      '<div class="vsp-severity-main">',
      '  <div class="vsp-severity-donut-wrap">',
      '    <canvas class="vsp-severity-donut-canvas"></canvas>',
      '  </div>',
      '  <div class="vsp-severity-legend">',
      '    <div class="sev-item sev-critical"><span class="dot"></span>CRITICAL</div>',
      '    <div class="sev-item sev-high"><span class="dot"></span>HIGH</div>',
      '    <div class="sev-item sev-medium"><span class="dot"></span>MEDIUM</div>',
      '    <div class="sev-item sev-low"><span class="dot"></span>LOW</div>',
      '    <div class="sev-item sev-info"><span class="dot"></span>INFO</div>',
      '    <div class="sev-item sev-trace"><span class="dot"></span>TRACE</div>',
      '  </div>',
      '</div>',
      '<div class="vsp-severity-empty" style="display:none;">No severity data yet.</div>'
    ].join('\n');

    var emptyMsg = card.querySelector('.vsp-severity-empty');

    if (!total) {
      if (emptyMsg) emptyMsg.style.display = 'block';
      return;
    }

    if (emptyMsg) emptyMsg.style.display = 'none';

    var canvas = card.querySelector('.vsp-severity-donut-canvas');
    if (!canvas) return;
    var ctx = canvas.getContext('2d');

    var data = {
      labels: ['CRITICAL', 'HIGH', 'MEDIUM', 'LOW', 'INFO', 'TRACE'],
      datasets: [{
        data: [crit, high, med, low, info, trace],
        backgroundColor: [
          '#ff4d4f', // CRITICAL – đỏ
          '#fa8c16', // HIGH – cam
          '#fadb14', // MEDIUM – vàng
          '#52c41a', // LOW – xanh lá
          '#40a9ff', // INFO – xanh dương
          '#722ed1'  // TRACE – tím
        ],
        borderWidth: 0
      }]
    };

    new Chart(ctx, {
      type: 'doughnut',
      data: data,
      options: {
        responsive: true,
        maintainAspectRatio: false,
        cutout: '70%',
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: function (ctx) {
                var label = ctx.label || '';
                var value = ctx.parsed || 0;
                var pct = total ? ((value * 100) / total).toFixed(1) : '0.0';
                return label + ': ' + value + ' (' + pct + '%)';
              }
            }
          }
        }
      }
    });
  };
})();

// [VSP_SEVERITY_AUTO_INIT_V1]
// Tự gọi /api/vsp/dashboard_v2 và render donut severity khi load Dashboard.
(function () {
  if (!window.VSP) window.VSP = {};

  function findSeverityCardRoot() {
    // Tìm thẻ có title "SEVERITY DISTRIBUTION (6 BUCKETS)"
    var headers = document.querySelectorAll('.chart-title-main, .vsp-chart-title, .card-title');
    var target = null;
    for (var i = 0; i < headers.length; i++) {
      var txt = (headers[i].textContent || '').trim();
      if (txt.indexOf('SEVERITY DISTRIBUTION') === 0) {
        // card thường: header -> .chart-header -> card container
        target = headers[i].closest('.vsp-chart-card')
              || headers[i].closest('.vsp-card')
              || headers[i].closest('.card')
              || headers[i].parentElement && headers[i].parentElement.parentElement;
        break;
      }
    }
    return target || null;
  }

  function initSeverityFromApi() {
    var cardRoot = findSeverityCardRoot();
    if (!cardRoot) {
      if (window.console && console.warn) {
        console.warn('[VSP][SEVERITY] Không tìm thấy card severity để vẽ donut.');
      }
      return;
    }

    // Gọi API dash_v2 để lấy summary đầy đủ
    fetch('/api/vsp/dashboard_v2')
      .then(function (res) { return res.json(); })
      .then(function (data) {
        if (!data || data.ok === false) {
          if (window.console && console.warn) {
            console.warn('[VSP][SEVERITY] API /api/vsp/dashboard_v2 trả về lỗi hoặc ok=false');
          }
          return;
        }
        if (!window.VSP || typeof window.VSP.renderSeverityBuckets !== 'function') {
          if (window.console && console.warn) {
            console.warn('[VSP][SEVERITY] Không thấy VSP.renderSeverityBuckets để render.');
          }
          return;
        }
        // summary.by_severity, by_tool... đều nằm trong data.summary
        window.VSP.renderSeverityBuckets(cardRoot, { summary: data.summary });
      })
      .catch(function (e) {
        if (window.console && console.error) {
          console.error('[VSP][SEVERITY] Lỗi gọi API /api/vsp/dashboard_v2:', e);
        }
      });
  }

  // Chờ trang load xong rồi mới patch
  window.addEventListener('load', function () {
    // delay nhẹ để HTML gốc của Dashboard render xong
    setTimeout(initSeverityFromApi, 600);
  });
})();

// [VSP_SEVERITY_AUTO_INIT_V2]
// Auto-init SEVERITY donut từ /api/vsp/dashboard_v2 khi load Dashboard.
(function () {
  if (!window.VSP) window.VSP = {};

  function findSeverityCardRoot() {
    // Tìm title "SEVERITY DISTRIBUTION (6 BUCKETS)" hoặc tương tự
    var headers = document.querySelectorAll('.chart-title-main, .vsp-chart-title, .card-title');
    var card = null;
    for (var i = 0; i < headers.length; i++) {
      var txt = (headers[i].textContent || '').trim();
      if (txt.toUpperCase().indexOf('SEVERITY DISTRIBUTION') === 0) {
        card = headers[i].closest('.vsp-chart-card')
            || headers[i].closest('.vsp-card')
            || headers[i].closest('.card')
            || headers[i].parentElement && headers[i].parentElement.parentElement;
        break;
      }
    }
    return card;
  }

  function initSeverityFromApi() {
    console.log('[VSP][SEVERITY] auto-init start');
    var cardRoot = findSeverityCardRoot();
    if (!cardRoot) {
      console.warn('[VSP][SEVERITY] Không tìm thấy card severity.');
      return;
    }

    fetch('/api/vsp/dashboard_v2')
      .then(function (res) {
        console.log('[VSP][SEVERITY] /api/vsp/dashboard_v2 status', res.status);
        return res.json();
      })
      .then(function (data) {
        console.log('[VSP][SEVERITY] payload', data);
        if (!data || data.ok === false) {
          console.warn('[VSP][SEVERITY] payload lỗi hoặc ok=false');
          return;
        }
        if (!window.VSP || typeof window.VSP.renderSeverityBuckets !== 'function') {
          console.warn('[VSP][SEVERITY] Không thấy VSP.renderSeverityBuckets');
          return;
        }
        window.VSP.renderSeverityBuckets(cardRoot, { summary: data.summary });
      })
      .catch(function (e) {
        console.error('[VSP][SEVERITY] Lỗi fetch /api/vsp/dashboard_v2:', e);
      });
  }

  window.addEventListener('load', function () {
    // delay để HTML dashboard render xong
    setTimeout(initSeverityFromApi, 800);
  });
})();

// =====================================================
// [VSP_SEVERITY_OVERRIDE_V3]
// Override hàm VSP.renderSeverityBuckets để luôn
// vẽ donut từ /api/vsp/dashboard_v2 (6 buckets).
// =====================================================
(function () {
  if (!window.VSP) window.VSP = {};

  window.VSP.renderSeverityBuckets = function (cardRoot, payload) {
    try {
      // Lấy số liệu 6 mức
      payload = payload || {};
      var sev =
        payload.severity ||
        (payload.summary && payload.summary.by_severity) ||
        {};
      var labels = ["CRITICAL", "HIGH", "MEDIUM", "LOW", "INFO", "TRACE"];
      var values = labels.map(function (k) {
        return Number(sev[k] || 0);
      });
      var total = values.reduce(function (a, b) { return a + b; }, 0);

      // Tìm card nếu chưa truyền vào
      if (!cardRoot) {
        var headers = document.querySelectorAll(
          ".chart-title-main, .vsp-chart-title, .card-title"
        );
        for (var i = 0; i < headers.length; i++) {
          var txt = (headers[i].textContent || "").trim().toUpperCase();
          if (txt.indexOf("SEVERITY DISTRIBUTION") === 0) {
            cardRoot =
              headers[i].closest(".vsp-chart-card") ||
              headers[i].closest(".vsp-card") ||
              headers[i].closest(".card") ||
              headers[i].parentElement;
            break;
          }
        }
      }

      if (!cardRoot) {
        console.warn("[VSP][SEVERITY] Không tìm thấy cardRoot để vẽ donut.");
        return;
      }

      // Tìm hoặc tạo canvas
      var body =
        cardRoot.querySelector(".chart-body") ||
        cardRoot.querySelector(".vsp-chart-body") ||
        cardRoot;
      var canvas =
        body.querySelector("canvas") ||
        (function () {
          var c = document.createElement("canvas");
          c.id = "vsp-severity-donut-auto";
          c.style.width = "100%";
          c.style.height = "180px";
          body.appendChild(c);
          return c;
        })();

      var ctx = canvas.getContext("2d");

      // Destroy chart cũ nếu có
      if (canvas._vspChart && typeof canvas._vspChart.destroy === "function") {
        canvas._vspChart.destroy();
      }

      // Dataset 6 màu chuẩn
      var bgColors = [
        "#ff4b5c", // CRITICAL
        "#ff9f43", // HIGH
        "#fddb5d", // MEDIUM
        "#00c38a", // LOW
        "#3b82f6", // INFO
        "#a855f7"  // TRACE
      ];

      canvas._vspChart = new Chart(ctx, {
        type: "doughnut",
        data: {
          labels: labels,
          datasets: [
            {
              data: values,
              backgroundColor: bgColors,
              borderWidth: 0
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: "65%",
          plugins: {
            legend: { display: false },
            tooltip: { enabled: true }
          }
        }
      });

      // Ẩn dòng "No severity data yet." nếu có số liệu
      var nodes = cardRoot.querySelectorAll("p, span, div");
      for (var j = 0; j < nodes.length; j++) {
        var t = (nodes[j].textContent || "").trim().toLowerCase();
        if (t.indexOf("no severity data") === 0) {
          nodes[j].style.display = total > 0 ? "none" : "";
        }
      }

      console.log("[VSP][SEVERITY] donut rendered, total =", total);
    } catch (e) {
      console.error("[VSP][SEVERITY] Lỗi renderSeverityBuckets:", e);
    }
  };
})();

// [VSP_PATCH_CHARTS_V2]
// ======================================================================
// 1) SEVERITY DONUT – lấy từ /api/vsp/dashboard_v2 (6 bucket)
// ======================================================================
(function () {
  if (!window.VSP) window.VSP = {};
  var CHART = window.Chart;

  function log() {
    if (window.console && console.log) {
      console.log.apply(console, ['[VSP][SEVERITY]'].concat([].slice.call(arguments)));
    }
  }

  function findSeverityCard() {
    var cards = document.querySelectorAll('.vsp-card, .chart-card, .card');
    for (var i = 0; i < cards.length; i++) {
      var title = cards[i].querySelector('.chart-title-main, .chart-title, .card-title');
      if (!title) continue;
      var txt = (title.textContent || '').trim().toUpperCase();
      if (txt.indexOf('SEVERITY DISTRIBUTION') !== -1) {
        return cards[i];
      }
    }
    return null;
  }

  function renderSeverityDonutFromDashboard() {
    if (!CHART) {
      log('Chart.js not found, skip.');
      return;
    }

    var card = findSeverityCard();
    if (!card) {
      log('Không tìm thấy card SEVERITY DISTRIBUTION, skip.');
      return;
    }

    // Xóa canvas donut cũ (nếu có) rồi tạo mới
    var old = card.querySelectorAll('canvas.vsp-severity-donut');
    if (old && old.length) {
      old.forEach(function (c) { c.remove(); });
    }

    var canvas = document.createElement('canvas');
    canvas.className = 'vsp-severity-donut';
    canvas.style.width = '100%';
    canvas.style.height = '260px';
    card.appendChild(canvas);

    fetch('/api/vsp/dashboard_v2')
      .then(function (r) { return r.json(); })
      .then(function (payload) {
        if (!payload || !payload.summary || !payload.summary.by_severity) {
          log('Payload không có summary.by_severity,', payload);
          return;
        }
        var sev = payload.summary.by_severity || {};
        var crit  = Number(sev.CRITICAL || 0);
        var high  = Number(sev.HIGH     || 0);
        var med   = Number(sev.MEDIUM   || 0);
        var low   = Number(sev.LOW      || 0);
        var info  = Number(sev.INFO     || 0);
        var trace = Number(sev.TRACE    || 0);

        var total = crit + high + med + low + info + trace;
        log('donut rendered, total =', total);

        var ctx = canvas.getContext('2d');
        new CHART(ctx, {
          type: 'doughnut',
          data: {
            labels: ['Critical', 'High', 'Medium', 'Low', 'Info', 'Trace'],
            datasets: [{
              data: [crit, high, med, low, info, trace]
              // Màu: dùng cấu hình global của Chart.js hoặc màu đã set sẵn ở nơi khác
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '70%',
            plugins: {
              legend: {
                display: true,
                position: 'right'
              },
              tooltip: {
                enabled: true
              }
            }
          }
        });
      })
      .catch(function (e) {
        log('Error fetch /api/vsp/dashboard_v2', e);
      });
  }

  window.VSP.renderSeverityDonutFromDashboard = renderSeverityDonutFromDashboard;

  document.addEventListener('DOMContentLoaded', function () {
    // Cho backend/API có thời gian load
    setTimeout(renderSeverityDonutFromDashboard, 500);
  });
})();

// ======================================================================
// 2) CRITICAL/HIGH BY TOOL – stacked bar chart từ summary.by_tool_severity
// ======================================================================
(function () {
  if (!window.VSP) window.VSP = {};
  var CHART = window.Chart;

  function log() {
    if (window.console && console.log) {
      console.log.apply(console, ['[VSP][CHART][TOOL]'].concat([].slice.call(arguments)));
    }
  }

  function findToolBarCard() {
    var cards = document.querySelectorAll('.vsp-card, .chart-card, .card');
    for (var i = 0; i < cards.length; i++) {
      var title = cards[i].querySelector('.chart-title-main, .chart-title, .card-title');
      if (!title) continue;
      var txt = (title.textContent || '').trim().toUpperCase();
      if (txt.indexOf('CRITICAL/HIGH BY TOOL') !== -1 ||
          txt.indexOf('CRITICAL – HIGH BY TOOL') !== -1) {
        return cards[i];
      }
    }
    return null;
  }

  function renderCritHighByTool() {
    if (!CHART) {
      log('Chart.js not found, skip.');
      return;
    }

    var card = findToolBarCard();
    if (!card) {
      log('Không tìm thấy card Critical/High by Tool, skip.');
      return;
    }

    var old = card.querySelectorAll('canvas.vsp-tool-bar');
    if (old && old.length) {
      old.forEach(function (c) { c.remove(); });
    }

    var canvas = document.createElement('canvas');
    canvas.className = 'vsp-tool-bar';
    canvas.style.width = '100%';
    canvas.style.height = '260px';
    card.appendChild(canvas);

    fetch('/api/vsp/dashboard_v2')
      .then(function (r) { return r.json(); })
      .then(function (payload) {
        var map = (payload && payload.summary && payload.summary.by_tool_severity) || {};
        var labels = [];
        var critData = [];
        var highData = [];

        Object.keys(map).forEach(function (tool) {
          var sev = map[tool] || {};
          var crit = Number(sev.CRITICAL || 0);
          var high = Number(sev.HIGH || 0);
          if (crit + high === 0) return;
          labels.push(tool);
          critData.push(crit);
          highData.push(high);
        });

        log('Tools =', labels.length);

        var ctx = canvas.getContext('2d');
        new CHART(ctx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [
              {
                label: 'Critical',
                data: critData
              },
              {
                label: 'High',
                data: highData
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: true },
              tooltip: { enabled: true }
            },
            scales: {
              x: { stacked: true },
              y: { stacked: true, beginAtZero: true }
            }
          }
        });
      })
      .catch(function (e) {
        log('Error fetch /api/vsp/dashboard_v2', e);
      });
  }

  window.VSP.renderCritHighByTool = renderCritHighByTool;

  document.addEventListener('DOMContentLoaded', function () {
    setTimeout(renderCritHighByTool, 700);
  });
})();

// ======================================================================
// 3) BẢNG DƯỚI: Top Findings / Top CWE / Top Modules
// ======================================================================
(function () {
  if (!window.VSP) window.VSP = {};

  function log() {
    if (window.console && console.log) {
      console.log.apply(console, ['[VSP][TABLE]'].concat([].slice.call(arguments)));
    }
  }

  function fillSimpleTable(containerSelector, rows, fields) {
    var root = document.querySelector(containerSelector);
    if (!root) {
      log('Không tìm thấy table selector =', containerSelector);
      return;
    }
    var tbody = root.querySelector('tbody');
    if (!tbody) {
      log('Không tìm thấy <tbody> trong', containerSelector);
      return;
    }

    tbody.innerHTML = '';
    (rows || []).forEach(function (row) {
      var tr = document.createElement('tr');
      fields.forEach(function (f) {
        var td = document.createElement('td');
        td.textContent = row[f] != null ? String(row[f]) : '';
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
  }

  function renderTopCweAndModules() {
    fetch('/api/vsp/dashboard_v2')
      .then(function (r) { return r.json(); })
      .then(function (payload) {
        var summary = payload.summary || {};
        var topCwe = summary.top_cwe || [];
        var topDirs = summary.top_dirs || [];

        // HTML: cần có <table id="table-top-cwe"> và <table id="table-top-modules">
        fillSimpleTable('#table-top-cwe', topCwe, ['id', 'count']);
        fillSimpleTable('#table-top-modules', topDirs, ['path', 'count']);

        log('render top_cwe =', topCwe.length, 'top_dirs =', topDirs.length);
      })
      .catch(function (e) {
        log('Error renderTopCweAndModules', e);
      });
  }

  function renderTopFindings() {
    var table = document.querySelector('#table-top-findings');
    if (!table) {
      log('Không tìm thấy #table-top-findings');
      return;
    }
    var tbody = table.querySelector('tbody');
    if (!tbody) {
      log('Không tìm thấy <tbody> trong #table-top-findings');
      return;
    }

    // Lấy 10 finding severity >= HIGH (CRITICAL,HIGH)
    fetch('/api/vsp/datasource?severity=CRITICAL,HIGH&limit=10')
      .then(function (r) { return r.json(); })
      .then(function (payload) {
        var items = payload.items || [];
        tbody.innerHTML = '';

        items.forEach(function (f) {
          var tr = document.createElement('tr');

          function td(text) {
            var cell = document.createElement('td');
            cell.textContent = text != null ? String(text) : '';
            tr.appendChild(cell);
          }

          td(f.severity);                      // cột 1
          td(f.tool);                          // cột 2
          td(f.rule_id || f.cwe || '');        // cột 3
          td(f.message || '');                 // cột 4
          td(f.location || f.path || '');      // cột 5

          tbody.appendChild(tr);
        });

        log('renderTopFindings count =', items.length);
      })
      .catch(function (e) {
        log('Error renderTopFindings', e);
      });
  }

  window.VSP.renderTopCweAndModules = renderTopCweAndModules;
  window.VSP.renderTopFindings = renderTopFindings;

  document.addEventListener('DOMContentLoaded', function () {
    setTimeout(renderTopCweAndModules, 900);
    setTimeout(renderTopFindings, 1000);
  });
})();

// [VSP_PATCH_TABLES_V3]
// ======================================================================
// Sửa 3 bảng: Top Findings / Top CWE / Top Modules
// - Tự tìm bảng theo tiêu đề card (không phụ thuộc id)
// - Mapping field linh hoạt: cwe/id/count/path/module/dir/...
// - Log payload chi tiết để debug khi không có dữ liệu
// ======================================================================
(function () {
  if (!window.VSP) window.VSP = {};

  function log() {
    if (window.console && console.log) {
      console.log.apply(console, ['[VSP][TABLE][V3]'].concat([].slice.call(arguments)));
    }
  }

  // Tìm <table> theo tiêu đề card
  function findTableByTitle(keywords) {
    keywords = (keywords || []).map(function (k) { return String(k || '').toUpperCase(); });
    var cards = document.querySelectorAll('.vsp-card, .chart-card, .card');
    for (var i = 0; i < cards.length; i++) {
      var card = cards[i];
      var titleEl = card.querySelector('.chart-title-main, .chart-title, .card-title, .vsp-card-title');
      if (!titleEl) continue;
      var txt = (titleEl.textContent || '').trim().toUpperCase();
      var ok = keywords.some(function (kw) {
        return kw && txt.indexOf(kw) !== -1;
      });
      if (!ok) continue;

      var table = card.querySelector('table');
      if (!table) continue;
      var tbody = table.querySelector('tbody');
      if (!tbody) continue;

      return { card: card, table: table, tbody: tbody, title: txt };
    }
    return null;
  }

  // --------------------------------------------------------------------
  // Top CWE + Top Modules từ /api/vsp/dashboard_v2
  // --------------------------------------------------------------------
  function renderTopCweAndModulesV3() {
    fetch('/api/vsp/dashboard_v2')
      .then(function (r) { return r.json(); })
      .then(function (payload) {
        if (!payload || !payload.summary) {
          log('payload.summary không tồn tại:', payload);
          return;
        }
        var summary = payload.summary || {};
        var topCwe = summary.top_cwe || summary.topCwe || [];
        var topDirs = summary.top_dirs || summary.topDirs || summary.top_modules || [];

        log('dashboard_v2 summary:', summary);
        log('top_cwe length =', (topCwe || []).length, 'top_dirs length =', (topDirs || []).length);

        // ---- Bảng Top CWE ----
        var cweTableInfo = findTableByTitle(['TOP CWE']);
        if (!cweTableInfo) {
          log('Không tìm thấy bảng Top CWE theo tiêu đề.');
        } else {
          var tbody = cweTableInfo.tbody;
          tbody.innerHTML = '';
          (topCwe || []).forEach(function (row, idx) {
            if (!row || typeof row !== 'object') return;

            // Mapping linh hoạt
            var id = row.id || row.cwe || row.cwe_id || row.code || row.name || '';
            var count =
              row.count  || row.total  || row.findings ||
              row.value  || row.num    || row.cnt      || 0;

            var tr = document.createElement('tr');

            var td1 = document.createElement('td');
            td1.textContent = id;
            tr.appendChild(td1);

            var td2 = document.createElement('td');
            td2.textContent = String(count);
            tr.appendChild(td2);

            tbody.appendChild(tr);

            if (idx < 3) {
              log('TopCWE row', idx, row);
            }
          });
        }

        // ---- Bảng Top Modules / Paths ----
        var modTableInfo = findTableByTitle(['TOP MODULE', 'TOP MODULES', 'TOP PATH', 'TOP MODULE/PATH']);
        if (!modTableInfo) {
          log('Không tìm thấy bảng Top Modules theo tiêu đề.');
        } else {
          var tbody2 = modTableInfo.tbody;
          tbody2.innerHTML = '';
          (topDirs || []).forEach(function (row, idx) {
            if (!row || typeof row !== 'object') return;

            var name =
              row.path   || row.dir    || row.module || row.file ||
              row.name   || row.target || '';
            var count =
              row.count  || row.total  || row.findings ||
              row.value  || row.num    || row.cnt      || 0;

            var tr2 = document.createElement('tr');

            var t1 = document.createElement('td');
            t1.textContent = name;
            tr2.appendChild(t1);

            var t2 = document.createElement('td');
            t2.textContent = String(count);
            tr2.appendChild(t2);

            tbody2.appendChild(tr2);

            if (idx < 3) {
              log('TopModule row', idx, row);
            }
          });
        }
      })
      .catch(function (e) {
        log('Error renderTopCweAndModulesV3', e);
      });
  }

  // --------------------------------------------------------------------
  // Top Findings – lấy từ /api/vsp/datasource
  // --------------------------------------------------------------------
  function renderTopFindingsV3() {
    // Tìm card có title kiểu "TOP FINDINGS" / "TOP RISK FINDINGS"
    var info = findTableByTitle(['TOP FINDINGS', 'TOP RISK FINDINGS']);
    if (!info) {
      log('Không tìm thấy bảng Top Findings theo tiêu đề.');
      return;
    }

    var tbody = info.tbody;
    tbody.innerHTML = '';

    // Gọi API datasource: ưu tiên HIGH, backend đã từng ví dụ severity=HIGH
    fetch('/api/vsp/datasource?severity=HIGH&limit=10')
      .then(function (r) { return r.json(); })
      .then(function (payload) {
        if (!payload) {
          log('payload datasource rỗng.');
          return;
        }
        log('datasource payload keys:', Object.keys(payload || {}));
        log('datasource total =', payload.total, 'items length =', (payload.items || []).length);

        var items = payload.items || [];
        items.forEach(function (f, idx) {
          if (!f || typeof f !== 'object') return;

          var tr = document.createElement('tr');

          // severity
          var tdSev = document.createElement('td');
          tdSev.textContent = f.severity || '';
          tr.appendChild(tdSev);

          // tool
          var tdTool = document.createElement('td');
          tdTool.textContent = f.tool || '';
          tr.appendChild(tdTool);

          // rule/cwe
          var rule =
            f.rule_id  || f.rule   || f.cwe   || f.check_id ||
            f.policy   || f.code   || '';
          var tdRule = document.createElement('td');
          tdRule.textContent = rule;
          tr.appendChild(tdRule);

          // message
          var msg = f.message || f.title || f.description || '';
          var tdMsg = document.createElement('td');
          tdMsg.textContent = msg;
          tr.appendChild(tdMsg);

          // location/path
          var loc =
            f.location || f.path   || f.file   ||
            f.target   || f.module || '';
          var tdLoc = document.createElement('td');
          tdLoc.textContent = loc;
          tr.appendChild(tdLoc);

          tbody.appendChild(tr);

          if (idx < 3) {
            log('TopFinding row', idx, f);
          }
        });
      })
      .catch(function (e) {
        log('Error renderTopFindingsV3', e);
      });
  }

  // Expose cho debug tay nếu cần
  window.VSP.renderTopCweAndModulesV3 = renderTopCweAndModulesV3;
  window.VSP.renderTopFindingsV3 = renderTopFindingsV3;

  document.addEventListener('DOMContentLoaded', function () {
    // Cho backend có thời gian lên API
    setTimeout(renderTopCweAndModulesV3, 900);
    setTimeout(renderTopFindingsV3, 1000);
  });
})();

// [VSP_DASHBOARD_CLEAN_V1]
// ======================================================================
// Dashboard – đọc đúng payload BE & vẽ:
//  - Donut 6 severity từ summary.by_severity
//  - Bar CRITICAL/HIGH BY TOOL từ summary.by_tool_severity
//  - 3 bảng dưới từ summary.top_cwe / summary.top_dirs / /api/vsp/datasource
// YÊU CẦU HTML:
//  - <canvas id="chart-severity-6">
//  - <canvas id="chart-tool-crit-high">
//  - <table id="table-top-findings">
//  - <table id="table-top-cwe">
//  - <table id="table-top-modules">
// ======================================================================
(function () {
  if (!window.VSP) window.VSP = {};
  var CHART = window.Chart;

  function log() {
    if (window.console && console.log) {
      console.log.apply(console, ['[VSP][CLEAN]',].concat([].slice.call(arguments)));
    }
  }

  // --------------------------------------------------------------------
  // Fetch dashboard_v2 1 lần, cache lại
  // --------------------------------------------------------------------
  var DASHBOARD_V2_CACHE = null;
  var DASHBOARD_V2_PROMISE = null;

  function getDashboardV2() {
    if (DASHBOARD_V2_CACHE) return Promise.resolve(DASHBOARD_V2_CACHE);
    if (DASHBOARD_V2_PROMISE) return DASHBOARD_V2_PROMISE;

    DASHBOARD_V2_PROMISE = fetch('/api/vsp/dashboard_v2')
      .then(function (r) { return r.json(); })
      .then(function (payload) {
        DASHBOARD_V2_CACHE = payload || {};
        log('dashboard_v2 payload keys:', Object.keys(DASHBOARD_V2_CACHE));
        return DASHBOARD_V2_CACHE;
      })
      .catch(function (e) {
        log('Lỗi fetch /api/vsp/dashboard_v2:', e);
        return {};
      });

    return DASHBOARD_V2_PROMISE;
  }

  // --------------------------------------------------------------------
  // Donut 6 severity
  // --------------------------------------------------------------------
  function renderSeverityDonutClean() {
    if (!CHART) {
      log('Chart.js not found, skip donut.');
      return;
    }
    var canvas = document.getElementById('chart-severity-6');
    if (!canvas) {
      log('Không thấy canvas #chart-severity-6');
      return;
    }

    getDashboardV2().then(function (payload) {
      var sum = (payload && payload.summary) || {};
      var sev = sum.by_severity || {};
      var crit  = Number(sev.CRITICAL || 0);
      var high  = Number(sev.HIGH     || 0);
      var med   = Number(sev.MEDIUM   || 0);
      var low   = Number(sev.LOW      || 0);
      var info  = Number(sev.INFO     || 0);
      var trace = Number(sev.TRACE    || 0);
      var total = crit + high + med + low + info + trace;
      log('DonutClean total =', total, 'sev =', sev);

      var ctx = canvas.getContext('2d');
      new CHART(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Critical', 'High', 'Medium', 'Low', 'Info', 'Trace'],
          datasets: [{
            data: [crit, high, med, low, info, trace]
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: '70%'
        }
      });
    });
  }

  // --------------------------------------------------------------------
  // Bar CRITICAL/HIGH BY TOOL
  // --------------------------------------------------------------------
  function renderCritHighByToolClean() {
    if (!CHART) {
      log('Chart.js not found, skip tool chart.');
      return;
    }
    var canvas = document.getElementById('chart-tool-crit-high');
    if (!canvas) {
      log('Không thấy canvas #chart-tool-crit-high');
      return;
    }

    getDashboardV2().then(function (payload) {
      var sum = (payload && payload.summary) || {};
      var map = sum.by_tool_severity || {};
      var labels = [];
      var critData = [];
      var highData = [];

      Object.keys(map).forEach(function (tool) {
        var sev = map[tool] || {};
        var c = Number(sev.CRITICAL || 0);
        var h = Number(sev.HIGH || 0);
        if (c + h === 0) return;
        labels.push(tool);
        critData.push(c);
        highData.push(h);
      });

      log('ToolClean labels =', labels);

      var ctx = canvas.getContext('2d');
      new CHART(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            { label: 'Critical', data: critData },
            { label: 'High',     data: highData }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: { stacked: true },
            y: { stacked: true, beginAtZero: true }
          }
        }
      });
    });
  }

  // --------------------------------------------------------------------
  // 2 bảng: Top CWE + Top Modules
  // --------------------------------------------------------------------
  function renderTopCweAndModulesClean() {
    var tblCwe = document.getElementById('table-top-cwe');
    var tblMod = document.getElementById('table-top-modules');
    var tbCwe = tblCwe && tblCwe.querySelector('tbody');
    var tbMod = tblMod && tblMod.querySelector('tbody');

    if (!tbCwe && !tbMod) {
      log('Không tìm thấy table-top-cwe hoặc table-top-modules');
      return;
    }

    getDashboardV2().then(function (payload) {
      var sum = (payload && payload.summary) || {};
      var topCwe = sum.top_cwe || [];
      var topDirs = sum.top_dirs || [];

      log('TopCWE len =', topCwe.length, 'TopDirs len =', topDirs.length);

      if (tbCwe) {
        tbCwe.innerHTML = '';
        topCwe.forEach(function (row, i) {
          if (!row || typeof row !== 'object') return;
          var id = row.id || row.cwe || row.cwe_id || row.code || row.name || '';
          var count = row.count || row.total || row.findings || row.value || row.num || row.cnt || 0;

          var tr = document.createElement('tr');
          var td1 = document.createElement('td'); td1.textContent = id;    tr.appendChild(td1);
          var td2 = document.createElement('td'); td2.textContent = String(count); tr.appendChild(td2);
          tbCwe.appendChild(tr);

          if (i < 3) log('TopCWE row', i, row);
        });
      }

      if (tbMod) {
        tbMod.innerHTML = '';
        topDirs.forEach(function (row, i) {
          if (!row || typeof row !== 'object') return;
          var name = row.path || row.dir || row.module || row.file || row.name || row.target || '';
          var cnt = row.count || row.total || row.findings || row.value || row.num || row.cnt || 0;

          var tr2 = document.createElement('tr');
          var t1 = document.createElement('td'); t1.textContent = name;      tr2.appendChild(t1);
          var t2 = document.createElement('td'); t2.textContent = String(cnt); tr2.appendChild(t2);
          tbMod.appendChild(tr2);

          if (i < 3) log('TopModule row', i, row);
        });
      }
    });
  }

  // --------------------------------------------------------------------
  // Bảng Top Findings – từ /api/vsp/datasource
  // --------------------------------------------------------------------
  function renderTopFindingsClean() {
    var tbl = document.getElementById('table-top-findings');
    var tbody = tbl && tbl.querySelector('tbody');
    if (!tbody) {
      log('Không thấy #table-top-findings');
      return;
    }
    tbody.innerHTML = '';

    fetch('/api/vsp/datasource?severity=HIGH&limit=10')
      .then(function (r) { return r.json(); })
      .then(function (payload) {
        var items = (payload && payload.items) || [];
        log('TopFindingsClean len =', items.length);

        items.forEach(function (f, i) {
          if (!f || typeof f !== 'object') return;

          var tr = document.createElement('tr');

          function add(text) {
            var td = document.createElement('td');
            td.textContent = text != null ? String(text) : '';
            tr.appendChild(td);
          }

          add(f.severity);  // Sev
          add(f.tool);      // Tool
          add(f.rule_id || f.rule || f.cwe || f.check_id || f.policy || f.code || ''); // Rule
          add(f.message || f.title || f.description || ''); // Message
          add(f.location || f.path || f.file || f.target || f.module || ''); // Path

          tbody.appendChild(tr);
          if (i < 3) log('TopFinding row', i, f);
        });
      })
      .catch(function (e) {
        log('Lỗi fetch /api/vsp/datasource:', e);
      });
  }

  window.VSP.renderSeverityDonutClean = renderSeverityDonutClean;
  window.VSP.renderCritHighByToolClean = renderCritHighByToolClean;
  window.VSP.renderTopCweAndModulesClean = renderTopCweAndModulesClean;
  window.VSP.renderTopFindingsClean = renderTopFindingsClean;

  document.addEventListener('DOMContentLoaded', function () {
    setTimeout(renderSeverityDonutClean, 600);
    setTimeout(renderCritHighByToolClean, 700);
    setTimeout(renderTopCweAndModulesClean, 800);
    setTimeout(renderTopFindingsClean, 900);
  });
})();
