function vspNum(n) {
  if (n === null || n === undefined) return 0;
  const x = Number(n);
  return Number.isNaN(x) ? 0 : x;
}
function vspFmt(n) {
  return vspNum(n).toLocaleString("en-US");
}
async function vspGet(url) {
  const res = await fetch(url);
  if (!res.ok) throw new Error(url + " -> " + res.status);
  return await res.json();
}

/* ---------- TAB 1: DASHBOARD ---------- */
async function renderVspDashboard() {
  const sec = document.getElementById("tab-dashboard");
  if (!sec) return;
  const root = document.createElement("div");
  root.id = "vsp-dashboard-root";
  root.className = "vsp-dashboard-root";
  sec.innerHTML = "";
  sec.appendChild(root);

  root.innerHTML = '<div class="vsp-loading">Loading dashboard...</div>';

  try {
    const dash = await vspGet("/api/vsp/dashboard");
    const runsIndex = await vspGet("/api/vsp/runs_index");
    const datasource = await vspGet("/api/vsp/datasource?mode=dashboard");

    const kpi = dash.kpi || {};
    const sev = kpi.severity || {};
    const tools = kpi.tool_counts || {};
    const meta = dash.meta || {};
    const rowsData = datasource.rows || [];

    /* 4 bảng: triage / noisy / CVE / by tool */
    const sorted = [...rowsData].sort((a, b) => {
      const order = { CRITICAL: 0, HIGH: 1, MEDIUM: 2, LOW: 3, INFO: 4, TRACE: 5 };
      return (order[a.severity] ?? 9) - (order[b.severity] ?? 9);
    });

    const topRisk = sorted.filter(r => ["CRITICAL","HIGH"].includes(r.severity)).slice(0, 6);
    const noisy = sorted.filter(r => ["MEDIUM","LOW","INFO","TRACE"].includes(r.severity)).slice(0, 6);

    const byCve = {};
    rowsData.forEach(r => {
      if (!r.cve) return;
      byCve[r.cve] = (byCve[r.cve] || 0) + 1;
    });
    const topCve = Object.entries(byCve)
      .sort((a,b)=>b[1]-a[1])
      .slice(0,6)
      .map(([cve,count])=>({cve, count}));

    const byToolSev = {};
    rowsData.forEach(r => {
      const t = r.tool || "unknown";
      const s = r.severity || "INFO";
      if (!byToolSev[t]) byToolSev[t] = { CRITICAL:0,HIGH:0,MEDIUM:0,LOW:0,INFO:0,TRACE:0 };
      byToolSev[t][s] = (byToolSev[t][s] || 0) + 1;
    });

    function renderRows(list, cols) {
      if (!list.length) return `<tr><td colspan="${cols}">No data.</td></tr>`;
      return list.map((r, idx)=>`
        <tr>
          <td>${idx+1}</td>
          <td title="${r.file || ""}">${r.file || "-"}</td>
          <td>${r.line || "-"}</td>
          <td>${r.severity || "-"}</td>
          <td>${r.rule_id || r.check_id || "-"}</td>
          <td>${r.title || r.message || "-"}</td>
        </tr>`).join("");
    }

    const topRiskHtml = `
      <div class="vsp-card">
        <div class="vsp-card-title">Top risk findings (Critical/High)</div>
        <div class="vsp-table-wrapper">
          <table class="vsp-table">
            <thead>
              <tr>
                <th>#</th><th>File</th><th>Line</th><th>Severity</th><th>Rule</th><th>Message</th>
              </tr>
            </thead>
            <tbody>${renderRows(topRisk, 6)}</tbody>
          </table>
        </div>
      </div>`;

    const noisyHtml = `
      <div class="vsp-card">
        <div class="vsp-card-title">Top noisy findings (Medium/Low/Info/Trace)</div>
        <div class="vsp-table-wrapper">
          <table class="vsp-table">
            <thead>
              <tr>
                <th>#</th><th>File</th><th>Line</th><th>Severity</th><th>Rule</th><th>Message</th>
              </tr>
            </thead>
            <tbody>${renderRows(noisy, 6)}</tbody>
          </table>
        </div>
      </div>`;

    const cveRows = topCve.length
      ? topCve.map((r,i)=>`
        <tr>
          <td>${i+1}</td>
          <td>${r.cve}</td>
          <td class="text-right">${vspFmt(r.count)}</td>
        </tr>`).join("")
      : `<tr><td colspan="3">No CVE data.</td></tr>`;

    const cveHtml = `
      <div class="vsp-card">
        <div class="vsp-card-title">Top exploited CVEs</div>
        <div class="vsp-table-wrapper">
          <table class="vsp-table">
            <thead><tr><th>#</th><th>CVE</th><th class="text-right">Count</th></tr></thead>
            <tbody>${cveRows}</tbody>
          </table>
        </div>
      </div>`;

    const toolRows = Object.keys(byToolSev).length
      ? Object.entries(byToolSev).map(([t, s])=>`
        <tr>
          <td>${t}</td>
          <td class="text-right">${vspFmt(s.CRITICAL || 0)}</td>
          <td class="text-right">${vspFmt(s.HIGH || 0)}</td>
          <td class="text-right">${vspFmt(s.MEDIUM || 0)}</td>
          <td class="text-right">${vspFmt(s.LOW || 0)}</td>
          <td class="text-right">${vspFmt(s.INFO || 0)}</td>
          <td class="text-right">${vspFmt(s.TRACE || 0)}</td>
        </tr>`).join("")
      : `<tr><td colspan="7">No tool data.</td></tr>`;

    const toolHtml = `
      <div class="vsp-card">
        <div class="vsp-card-title">By tool – severity buckets</div>
        <div class="vsp-table-wrapper">
          <table class="vsp-table">
            <thead>
              <tr>
                <th>Tool</th>
                <th class="text-right">CRIT</th>
                <th class="text-right">HIGH</th>
                <th class="text-right">MED</th>
                <th class="text-right">LOW</th>
                <th class="text-right">INFO</th>
                <th class="text-right">TRACE</th>
              </tr>
            </thead>
            <tbody>${toolRows}</tbody>
          </table>
        </div>
      </div>`;

    /* KPI */
    const infoTrace = vspNum(sev.INFO) + vspNum(sev.TRACE);
    const kpiHtml = `
      <div class="vsp-kpi-row">
        <div class="vsp-kpi-card">
          <div class="vsp-kpi-label">Total findings</div>
          <div class="vsp-kpi-value">${vspFmt(kpi.total_findings)}</div>
        </div>
        <div class="vsp-kpi-card sev-critical">
          <div class="vsp-kpi-label">Critical</div>
          <div class="vsp-kpi-value">${vspFmt(sev.CRITICAL)}</div>
        </div>
        <div class="vsp-kpi-card sev-high">
          <div class="vsp-kpi-label">High</div>
          <div class="vsp-kpi-value">${vspFmt(sev.HIGH)}</div>
        </div>
        <div class="vsp-kpi-card sev-medium">
          <div class="vsp-kpi-label">Medium</div>
          <div class="vsp-kpi-value">${vspFmt(sev.MEDIUM)}</div>
        </div>
        <div class="vsp-kpi-card sev-low">
          <div class="vsp-kpi-label">Low</div>
          <div class="vsp-kpi-value">${vspFmt(sev.LOW)}</div>
        </div>
        <div class="vsp-kpi-card sev-info">
          <div class="vsp-kpi-label">Info/Trace</div>
          <div class="vsp-kpi-value">${vspFmt(infoTrace)}</div>
        </div>
        <div class="vsp-kpi-card">
          <div class="vsp-kpi-label">Security posture</div>
          <div class="vsp-kpi-value">${kpi.security_score == null ? "-" : kpi.security_score + " / 100"}</div>
        </div>
        <div class="vsp-kpi-card">
          <div class="vsp-kpi-label">Top risky tool</div>
          <div class="vsp-kpi-value">${kpi.top_risky_tool || "-"}</div>
        </div>
        <div class="vsp-kpi-card">
          <div class="vsp-kpi-label">Highest impacted CWE</div>
          <div class="vsp-kpi-value">${kpi.top_cwe || "-"}</div>
        </div>
        <div class="vsp-kpi-card">
          <div class="vsp-kpi-label">Top vulnerable module</div>
          <div class="vsp-kpi-value">${kpi.top_module || "-"}</div>
        </div>
      </div>`;

    /* Trend – bảng đơn giản cho “last 10 runs” */
    const runs = (runsIndex.runs || []).slice(0, 10);
    const trendRows = runs.length
      ? runs.map((r, i) => {
          const s = r.severity || {};
          return `
            <tr>
              <td>${i + 1}</td>
              <td>${r.run_id || "-"}</td>
              <td>${r.ts || "-"}</td>
              <td class="text-right">${vspFmt(r.total_findings || 0)}</td>
              <td class="text-right">${vspFmt(s.CRITICAL || 0)}</td>
              <td class="text-right">${vspFmt(s.HIGH || 0)}</td>
              <td class="text-right">${vspFmt(s.MEDIUM || 0)}</td>
              <td class="text-right">${vspFmt(s.LOW || 0)}</td>
            </tr>`;
        }).join("")
      : `<tr><td colspan="8">No runs.</td></tr>`;

    const trendHtml = `
      <div class="vsp-card full">
        <div class="vsp-card-title">Trend – findings over last ${runs.length || 0} runs</div>
        <div class="vsp-table-wrapper">
          <table class="vsp-table">
            <thead>
              <tr>
                <th>#</th><th>Run ID</th><th>Timestamp</th>
                <th class="text-right">Total</th>
                <th class="text-right">CRIT</th>
                <th class="text-right">HIGH</th>
                <th class="text-right">MED</th>
                <th class="text-right">LOW</th>
              </tr>
            </thead>
            <tbody>${trendRows}</tbody>
          </table>
        </div>
      </div>`;

    root.innerHTML = `
      <div class="vsp-dashboard-grid">
        ${kpiHtml}
        <div class="vsp-dashboard-bottom">
          ${trendHtml}
          ${topRiskHtml}
          ${noisyHtml}
          ${toolHtml}
        </div>
      </div>
    `;
  } catch (err) {
    console.error(err);
    root.innerHTML = '<div class="vsp-error">Không tải được dashboard.</div>';
  }
}

/* ---------- TAB 2: RUNS & REPORTS ---------- */
async function renderVspRuns() {
  const sec = document.getElementById("tab-runs");
  if (!sec) return;
  const root = document.createElement("div");
  root.id = "vsp-runs-root";
  root.className = "vsp-runs-root";
  sec.innerHTML = "";
  sec.appendChild(root);

  root.innerHTML = '<div class="vsp-loading">Loading runs...</div>';

  try {
    const data = await vspGet("/api/vsp/runs_index");
    const runs = data.runs || [];

    const totalRuns = runs.length;
    const last10 = runs.slice(0, 10);
    const successes = last10.length; // đơn giản: coi như success, sau này mapping status
    const avgFindings =
      runs.reduce((sum, r) => sum + vspNum(r.total_findings || 0), 0) /
      (runs.length || 1);

    const kpiHtml = `
      <div class="vsp-kpi-row">
        <div class="vsp-kpi-card">
          <div class="vsp-kpi-label">Total runs</div>
          <div class="vsp-kpi-value">${vspFmt(totalRuns)}</div>
        </div>
        <div class="vsp-kpi-card">
          <div class="vsp-kpi-label">Last 10 runs (ok)</div>
          <div class="vsp-kpi-value">${vspFmt(successes)}</div>
        </div>
        <div class="vsp-kpi-card">
          <div class="vsp-kpi-label">Avg findings/run</div>
          <div class="vsp-kpi-value">${vspFmt(Math.round(avgFindings))}</div>
        </div>
      </div>`;

    const rows = runs.length
      ? runs.map((r, i) => {
          const s = r.severity || {};
          const tools = (r.tools || []).join(", ");
          return `
            <tr>
              <td>${i + 1}</td>
              <td>${r.run_id || "-"}</td>
              <td>${r.ts || "-"}</td>
              <td>${r.profile || "-"}</td>
              <td title="${r.src_path || ""}">${r.src_path || "-"}</td>
              <td class="text-right">${vspFmt(r.total_findings || 0)}</td>
              <td class="text-right">${vspFmt(s.CRITICAL || 0)}</td>
              <td class="text-right">${vspFmt(s.HIGH || 0)}</td>
              <td class="text-right">${vspFmt(s.MEDIUM || 0)}</td>
              <td class="text-right">${vspFmt(s.LOW || 0)}</td>
              <td class="text-right">${vspFmt(s.INFO || 0)}</td>
              <td class="text-right">${vspFmt(s.TRACE || 0)}</td>
              <td>${tools}</td>
              <td>
                ${r.report_html ? `<a href="${r.report_html}" target="_blank">HTML</a>` : ""}
                ${r.report_pdf ? ` | <a href="${r.report_pdf}" target="_blank">PDF</a>` : ""}
              </td>
            </tr>`;
        }).join("")
      : `<tr><td colspan="14">No runs in out/.</td></tr>`;

    const tableHtml = `
      <div class="vsp-card full">
        <div class="vsp-card-title">Runs & Reports</div>
        <div class="vsp-table-wrapper">
          <table class="vsp-table">
            <thead>
              <tr>
                <th>#</th>
                <th>Run ID</th>
                <th>Timestamp</th>
                <th>Profile</th>
                <th>SRC path</th>
                <th class="text-right">Total</th>
                <th class="text-right">CRIT</th>
                <th class="text-right">HIGH</th>
                <th class="text-right">MED</th>
                <th class="text-right">LOW</th>
                <th class="text-right">INFO</th>
                <th class="text-right">TRACE</th>
                <th>Tools</th>
                <th>Reports</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        </div>
      </div>`;

    root.innerHTML = `
      <div class="vsp-runs-layout">
        ${kpiHtml}
        ${tableHtml}
      </div>
    `;
  } catch (err) {
    console.error(err);
    root.innerHTML = '<div class="vsp-error">Không tải được runs index.</div>';
  }
}

/* ---------- TAB 3: DATA SOURCE ---------- */
async function renderVspDataSource() {
  const sec = document.getElementById("tab-data");
  if (!sec) return;
  const root = document.createElement("div");
  root.id = "vsp-data-root";
  root.className = "vsp-data-root";
  sec.innerHTML = "";
  sec.appendChild(root);

  root.innerHTML = '<div class="vsp-loading">Loading datasource...</div>';

  try {
    const data = await vspGet("/api/vsp/datasource");
    const rowsData = data.rows || [];
    let currentSeverity = "ALL";
    let currentTool = "ALL";

    function renderTable() {
      const tbodyRows = rowsData
        .filter(r => currentSeverity === "ALL" || r.severity === currentSeverity)
        .filter(r => currentTool === "ALL" || (r.tool || "unknown") === currentTool)
        .slice(0, 300) // UI: 300 dòng đầu
        .map((r, idx) => `
          <tr>
            <td>${idx + 1}</td>
            <td>${r.tool || "-"}</td>
            <td>${r.severity || "-"}</td>
            <td>${r.rule_id || r.check_id || "-"}</td>
            <td>${r.title || r.message || "-"}</td>
            <td title="${r.file || ""}">${r.file || "-"}</td>
            <td>${r.line || "-"}</td>
            <td>${r.cwe || "-"}</td>
            <td>${r.cve || "-"}</td>
          </tr>
        `).join("") || `<tr><td colspan="9">No findings.</td></tr>`;

      const table = root.querySelector(".vsp-data-table-body");
      if (table) table.innerHTML = tbodyRows;
    }

    const sevSet = new Set(["ALL"]);
    rowsData.forEach(r => sevSet.add(r.severity || "INFO"));
    const toolSet = new Set(["ALL"]);
    rowsData.forEach(r => toolSet.add(r.tool || "unknown"));

    const severityOptions = Array.from(sevSet).map(s => `<option value="${s}">${s}</option>`).join("");
    const toolOptions = Array.from(toolSet).map(t => `<option value="${t}">${t}</option>`).join("");

    root.innerHTML = `
      <div class="vsp-card full">
        <div class="vsp-card-title">
          Data Source – unified findings
          <span class="vsp-subtitle">
            Run: ${data.run_id || "-"} – total: ${vspFmt(data.total_rows || rowsData.length)} (showing max 300)
          </span>
        </div>

        <div class="vsp-filter-row">
          <label>Severity:
            <select id="vsp-data-filter-sev">${severityOptions}</select>
          </label>
          <label>Tool:
            <select id="vsp-data-filter-tool">${toolOptions}</select>
          </label>
        </div>

        <div class="vsp-table-wrapper">
          <table class="vsp-table">
            <thead>
              <tr>
                <th>#</th>
                <th>Tool</th>
                <th>Severity</th>
                <th>Rule</th>
                <th>Title</th>
                <th>File</th>
                <th>Line</th>
                <th>CWE</th>
                <th>CVE</th>
              </tr>
            </thead>
            <tbody class="vsp-data-table-body"></tbody>
          </table>
        </div>
      </div>
    `;

    root.querySelector("#vsp-data-filter-sev").addEventListener("change", (e) => {
      currentSeverity = e.target.value;
      renderTable();
    });
    root.querySelector("#vsp-data-filter-tool").addEventListener("change", (e) => {
      currentTool = e.target.value;
      renderTable();
    });

    renderTable();
  } catch (err) {
    console.error(err);
    root.innerHTML = '<div class="vsp-error">Không tải được datasource.</div>';
  }
}

/* ---------- TAB 4: SETTINGS ---------- */
async function renderVspSettings() {
  const sec = document.getElementById("tab-settings");
  if (!sec) return;
  const root = document.createElement("div");
  root.id = "vsp-settings-root";
  root.className = "vsp-settings-root";
  sec.innerHTML = "";
  sec.appendChild(root);

  root.innerHTML = '<div class="vsp-loading">Loading settings...</div>';

  try {
    const data = await vspGet("/api/vsp/settings");
    const tools = data.tools_enabled || [];
    const pills = tools.length
      ? tools.map(t => `<span class="vsp-pill">${t}</span>`).join(" ")
      : "<span class='vsp-subtitle'>No tools detected.</span>";

    root.innerHTML = `
      <div class="vsp-settings-grid">
        <div class="vsp-card">
          <div class="vsp-card-title">Profile</div>
          <div class="vsp-kpi-value">${data.profile_label || "-"}</div>
        </div>
        <div class="vsp-card">
          <div class="vsp-card-title">Source path</div>
          <div class="vsp-kpi-value">${data.src_path || "-"}</div>
        </div>
        <div class="vsp-card">
          <div class="vsp-card-title">Engine mode</div>
          <div class="vsp-kpi-value">${data.engine_mode || "-"}</div>
        </div>
        <div class="vsp-card">
          <div class="vsp-card-title">Last run</div>
          <div class="vsp-kpi-value">${data.last_run_id || "-"}</div>
        </div>
      </div>

      <div class="vsp-card full">
        <div class="vsp-card-title">Tools enabled</div>
        <div class="vsp-pill-row">${pills}</div>
      </div>
    `;
  } catch (err) {
    console.error(err);
    root.innerHTML = '<div class="vsp-error">Không tải được settings.</div>';
  }
}

/* ---------- TAB 5: RULE OVERRIDES ---------- */
async function renderVspRules() {
  const sec = document.getElementById("tab-rules");
  if (!sec) return;
  const root = document.createElement("div");
  root.id = "vsp-rules-root";
  root.className = "vsp-rules-root";
  sec.innerHTML = "";
  sec.appendChild(root);

  root.innerHTML = '<div class="vsp-loading">Loading rule overrides...</div>';

  try {
    const data = await vspGet("/api/vsp/rule_overrides");
    const rules = data.rules || [];

    const rows = rules.length
      ? rules.map((r, i) => `
          <tr>
            <td>${i + 1}</td>
            <td>${r.tool || "-"}</td>
            <td>${r.rule_id || r.id || "-"}</td>
            <td>${r.match || r.scope || "-"}</td>
            <td>${r.action || r.severity || "-"}</td>
            <td>${r.note || r.description || "-"}</td>
          </tr>
        `).join("")
      : `<tr><td colspan="6">${data.note || "No overrides."}</td></tr>`;

    root.innerHTML = `
      <div class="vsp-card full">
        <div class="vsp-card-title">Rule Overrides</div>
        <div class="vsp-table-wrapper">
          <table class="vsp-table">
            <thead>
              <tr>
                <th>#</th>
                <th>Tool</th>
                <th>Rule ID</th>
                <th>Match / Scope</th>
                <th>Action</th>
                <th>Note</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        </div>
      </div>
    `;
  } catch (err) {
    console.error(err);
    root.innerHTML = '<div class="vsp-error">Không tải được rule overrides.</div>';
  }
}

/* ---------- INIT ON LOAD ---------- */
document.addEventListener("DOMContentLoaded", () => {
  renderVspDashboard();
  renderVspRuns();
  renderVspDataSource();
  renderVspSettings();
  renderVspRules();
});
