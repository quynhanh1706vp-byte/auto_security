from __future__ import annotations

from flask import Blueprint, jsonify, current_app, request
from pathlib import Path
import os
import json
import sys
import traceback

bp = Blueprint("vsp_dashboard_api", __name__)


def _get_vsp_root() -> Path:
    """
    Tìm VSP_ROOT theo thứ tự:
      1) ENV VSP_ROOT
      2) current_app.config["VSP_ROOT" / "VSP_ROOT_DIR"]
      3) 2 cấp cha của file này (…/SECURITY_BUNDLE)
    """
    env_root = os.environ.get("VSP_ROOT")
    if env_root:
        return Path(env_root).resolve()

    try:
        cfg = getattr(current_app, "config", {})
        cfg_root = cfg.get("VSP_ROOT") or cfg.get("VSP_ROOT_DIR")
        if cfg_root:
            return Path(cfg_root).resolve()
    except Exception:
        pass

    # fallback: my_flask_app/app.py nằm ở …/SECURITY_BUNDLE/ui/my_flask_app
    # → vsp_root = …/SECURITY_BUNDLE
    return Path(__file__).resolve().parents[2]


def _iter_full_ext_runs(out_dir: Path):
    """
    Duyệt các thư mục RUN_VSP_FULL_EXT_* có summary_unified.json
    (mới nhất trước, cũ sau).
    """
    if not out_dir.is_dir():
        return

    for d in sorted(out_dir.iterdir(), key=lambda p: p.name, reverse=True):
        if not d.is_dir():
            continue
        if not d.name.startswith("RUN_VSP_FULL_EXT_"):
            continue
        rep = d / "report"
        summary_path = rep / "summary_unified.json"
        if summary_path.is_file():
            yield d, summary_path


def _load_json(path: Path):
    try:
        return json.loads(path.read_text(encoding="utf-8"))
    except Exception as e:
        print(f"[DASH_V2][ERR] Cannot load JSON {path}: {e}", file=sys.stderr)
        traceback.print_exc()
        return None


@bp.route("/api/vsp/dashboard_v2", methods=["GET"])
def api_vsp_dashboard_v2():
    """
    Trả dashboard đơn giản cho my_flask_app dùng:
      - ok
      - run_id
      - total_findings
      - by_severity
      - security_score (nếu có)
      - top_risky_tool / top_cwe / top_module (nếu có)
    Đọc từ summary_unified.json của run_id yêu cầu hoặc run FULL_EXT mới nhất.
    """
    try:
        vsp_root = _get_vsp_root()
        out_dir = vsp_root / "out"

        requested_run = request.args.get("run_id")
        run_id = None
        summary_path = None

        if requested_run:
            cand = out_dir / requested_run / "report" / "summary_unified.json"
            if not cand.is_file():
                return (
                    jsonify(
                        {
                            "ok": False,
                            "error": f"summary_unified.json not found for run_id={requested_run}",
                        }
                    ),
                    404,
                )
            run_id = requested_run
            summary_path = cand
        else:
            # Tự tìm RUN_VSP_FULL_EXT_* mới nhất có summary_unified.json
            for d, s_path in _iter_full_ext_runs(out_dir):
                summary = _load_json(s_path)
                if summary is not None:
                    run_id = d.name
                    summary_path = s_path
                    break

            if run_id is None or summary_path is None:
                return (
                    jsonify(
                        {
                            "ok": False,
                            "error": "No RUN_VSP_FULL_EXT_* with summary_unified.json found",
                        }
                    ),
                    404,
                )

        summary = _load_json(summary_path)
        if summary is None:
            return (
                jsonify(
                    {
                        "ok": False,
                        "error": f"Cannot load summary from {summary_path}",
                    }
                ),
                500,
            )

        # Hỗ trợ cả kiểu mới (summary_unified.json) lẫn kiểu nested cũ
        by_sev = summary.get("by_severity") or summary.get("summary", {}).get("by_severity") or {}
        if isinstance(by_sev, dict):
            total = sum(v for v in by_sev.values() if isinstance(v, (int, float)))
        else:
            total = summary.get("total_findings")

        payload = {
            "ok": True,
            "run_id": run_id,
            "total_findings": total,
            "by_severity": by_sev,
            "security_score": summary.get("security_score", 0),
            "top_risky_tool": summary.get("top_risky_tool"),
            "top_cwe": summary.get("top_cwe"),
            "top_module": summary.get("top_module"),
        }

        return jsonify(payload)
    except Exception as e:
        print(f"[DASH_V2][FATAL] {e}", file=sys.stderr)
        traceback.print_exc()
        return jsonify({"ok": False, "error": str(e)}), 500
