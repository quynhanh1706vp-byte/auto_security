from __future__ import annotations

from pathlib import Path

from flask import Flask, jsonify, Blueprint

import api_vsp_dashboard_v2
import api_vsp_runs_v2
import api_vsp_datasource_v2
import api_vsp_settings_v1
import api_vsp_insights_v1


def create_app() -> Flask:
    app = Flask(__name__)

    # Thiết lập ROOT / OUT cho các module dùng chung
    root = Path(__file__).resolve().parents[2]
    out_dir = root / "out"
    app.config.setdefault("VSP_ROOT", str(root))
    app.config.setdefault("VSP_OUT_DIR", str(out_dir))

    # Tự động tìm và đăng ký mọi Blueprint được khai báo trong các module api_vsp_*
    modules = [
        api_vsp_dashboard_v2,
        api_vsp_runs_v2,
        api_vsp_datasource_v2,
        api_vsp_settings_v1,
        api_vsp_insights_v1,
    ]

    for mod in modules:
        for name in dir(mod):
            obj = getattr(mod, name)
            if isinstance(obj, Blueprint):
                app.register_blueprint(obj)

    @app.get("/healthz")
    def healthz():
        return jsonify({"app": "vsp_my_flask_app", "ok": True})

    return app


app = create_app()

if __name__ == "__main__":
    # Core API chạy port 8961
    app.run(host="0.0.0.0", port=8961, debug=True)
