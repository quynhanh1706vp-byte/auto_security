from flask import Blueprint, jsonify, request
from pathlib import Path
from collections import Counter
from typing import Any, Dict, List
import json

bp_vsp_datasource_v2 = Blueprint("vsp_datasource_v2", __name__)

ROOT = Path("/home/test/Data/SECURITY_BUNDLE")
RUN_DIR = ROOT / "out" / "RUN_VSP_FULL_EXT_20251203_145619"

SUMMARY_PATH = RUN_DIR / "report" / "summary_unified.json"
FINDINGS_PATH = RUN_DIR / "report" / "findings_unified.json"

SEVERITY_ORDER = ["CRITICAL", "HIGH", "MEDIUM", "LOW", "INFO", "TRACE"]
SEVERITY_WEIGHT = {
    "CRITICAL": 10.0,
    "HIGH": 5.0,
    "MEDIUM": 2.0,
    "LOW": 1.0,
    "INFO": 0.2,
    "TRACE": 0.0,
}

def _safe_int(val: Any) -> int:
    try:
        return int(val)
    except Exception:
        try:
            return int(float(val))
        except Exception:
            return 0

def _safe_float(val: Any):
    try:
        return float(val)
    except Exception:
        return None

def _norm_sev(value: Any) -> str:
    if not isinstance(value, str):
        return "TRACE"
    v = value.strip().upper()
    return v if v in SEVERITY_ORDER else "TRACE"

def _compute_by_severity_from_findings(findings: List[Dict[str, Any]]) -> Dict[str, int]:
    counts = {s: 0 for s in SEVERITY_ORDER}
    for f in findings:
        sev = _norm_sev(
            f.get("severity_effective")
            or f.get("severity")
            or f.get("severity_raw")
        )
        if sev in counts:
            counts[sev] += 1
    return counts

def _compute_security_score(by_sev: Dict[str, int]) -> int:
    if not by_sev:
        return 100
    total_penalty = 0.0
    for sev, count in by_sev.items():
        total_penalty += SEVERITY_WEIGHT.get(sev, 0.0) * count
    score = 100.0 - (total_penalty / 50.0) * 10.0
    score = max(0.0, min(100.0, score))
    return int(round(score))

def _compute_top_tool(findings: List[Dict[str, Any]]) -> str:
    ctr = Counter()
    for f in findings:
        sev = _norm_sev(f.get("severity_effective") or f.get("severity_raw"))
        if sev not in ("CRITICAL", "HIGH", "MEDIUM"):
            continue
        tool = (f.get("tool") or "").strip()
        if tool:
            ctr[tool] += 1
    return ctr.most_common(1)[0][0] if ctr else "-"

def _compute_top_cwe(findings: List[Dict[str, Any]]) -> str:
    ctr = Counter()
    for f in findings:
        sev = _norm_sev(f.get("severity_effective") or f.get("severity_raw"))
        if sev not in ("CRITICAL", "HIGH", "MEDIUM"):
            continue
        vuln = f.get("vuln") or {}
        extra = f.get("extra") or {}
        cwe_ids = vuln.get("cwe_ids")
        if isinstance(cwe_ids, list):
            for c in cwe_ids:
                if isinstance(c, str) and c.strip():
                    ctr[c.strip()] += 1
            continue
        cwe_id = vuln.get("cwe_id") or extra.get("cwe_id") or extra.get("cwe")
        if isinstance(cwe_id, str) and cwe_id.strip():
            ctr[cwe_id.strip()] += 1
    return ctr.most_common(1)[0][0] if ctr else "-"

def _compute_top_module(findings: List[Dict[str, Any]]) -> str:
    ctr = Counter()
    for f in findings:
        sev = _norm_sev(f.get("severity_effective") or f.get("severity_raw"))
        if sev not in ("CRITICAL", "HIGH", "MEDIUM"):
            continue
        ctx = f.get("code_context") or {}
        module = (f.get("module") or ctx.get("module") or "").strip()
        if module:
            ctr[module] += 1
    return ctr.most_common(1)[0][0] if ctr else "-"

# ============== /api/vsp/datasource_v2 ==============

# [VSP][CLEANUP] disabled duplicate datasource_v2 route
# @bp_vsp_datasource_v2.route("/api/vsp/datasource_v2", methods=["GET"])
def api_vsp_datasource_v2():
    if not FINDINGS_PATH.is_file():
        return jsonify({
            "ok": False,
            "run_id": None,
            "total": 0,
            "items": [],
            "message": f"Không tìm thấy findings_unified.json tại {str(FINDINGS_PATH)}",
        })
    try:
        with FINDINGS_PATH.open(encoding="utf-8") as f:
            all_rows = json.load(f)
    except Exception as exc:
        return jsonify({
            "ok": False,
            "run_id": None,
            "total": 0,
            "items": [],
            "message": f"Lỗi đọc findings_unified.json: {exc}",
        })
    if not all_rows:
        return jsonify({
            "ok": False,
            "run_id": RUN_DIR.name,
            "total": 0,
            "items": [],
            "message": "findings_unified.json rỗng.",
        })

    sev_param = (request.args.get("severity") or "").upper().strip()
    sev_mode = (request.args.get("sev_mode") or "effective").lower().strip()
    if sev_mode not in ("effective", "raw"):
        sev_mode = "effective"

    limit_raw = (request.args.get("limit") or "").strip()
    try:
        limit = int(limit_raw) if limit_raw else 50
    except Exception:
        limit = 50
    if limit <= 0:
        limit = 50

    filtered: List[Dict[str, Any]] = []
    for item in all_rows:
        sev_raw = (item.get("severity") or item.get("severity_raw") or "").upper().strip()
        sev_eff = (item.get("severity_effective") or sev_raw).upper().strip()
        sev_for_filter = sev_raw if sev_mode == "raw" else sev_eff
        if sev_param and sev_for_filter != sev_param:
            continue
        filtered.append(item)

    total = len(filtered)
    items = filtered[:limit]

    return jsonify({
        "ok": True,
        "run_id": RUN_DIR.name,
        "total": total,
        "items": items,
        "severity_param": sev_param,
        "severity_mode": sev_mode,
    })

# ============== /api/vsp/dashboard_v3 ==============

# [VSP][CLEANUP] disabled duplicate dashboard_v3 route
# @bp_vsp_datasource_v2.route("/api/vsp/dashboard_v3", methods=["GET"])
def api_vsp_dashboard_v3():
    if not SUMMARY_PATH.is_file():
        return jsonify({
            "ok": False,
            "run_id": None,
            "message": f"Không tìm thấy summary_unified.json tại {str(SUMMARY_PATH)}",
        })
    try:
        with SUMMARY_PATH.open(encoding="utf-8") as f:
            summary = json.load(f)
    except Exception as exc:
        return jsonify({
            "ok": False,
            "run_id": None,
            "message": f"Lỗi đọc summary_unified.json: {exc}",
        })

    findings: List[Dict[str, Any]] = []
    if FINDINGS_PATH.is_file():
        try:
            with FINDINGS_PATH.open(encoding="utf-8") as f:
                data_f = json.load(f)
            if isinstance(data_f, list):
                findings = data_f
            elif isinstance(data_f, dict) and isinstance(data_f.get("items"), list):
                findings = data_f["items"]
        except Exception:
            findings = []

    run_id = summary.get("run_id") or RUN_DIR.name

    # ✅ Luôn dùng severity_effective từ findings để tính by_severity
    if findings:
        by_severity = _compute_by_severity_from_findings(findings)
    else:
        raw_sev = (
            summary.get("by_severity")
            or summary.get("severity")
            or (summary.get("summary") or {}).get("by_severity")
            or {}
        )
        by_severity = {
            "CRITICAL": _safe_int(raw_sev.get("CRITICAL", 0)),
            "HIGH":     _safe_int(raw_sev.get("HIGH", 0)),
            "MEDIUM":   _safe_int(raw_sev.get("MEDIUM", 0)),
            "LOW":      _safe_int(raw_sev.get("LOW", 0)),
            "INFO":     _safe_int(raw_sev.get("INFO", 0)),
            "TRACE":    _safe_int(raw_sev.get("TRACE", 0)),
        }

    total_findings = (
        summary.get("total_findings")
        or summary.get("total")
        or sum(by_severity.values())
        or len(findings)
        or 0
    )
    total_findings = _safe_int(total_findings)

    security_score = _compute_security_score(by_severity) if total_findings > 0 else None

    # ✅ Top risky tool: ưu tiên tính lại từ findings (effective), fallback summary.by_tool
    top_risky_tool = "-"
    if findings:
        top_risky_tool = _compute_top_tool(findings)
    else:
        by_tool = summary.get("by_tool") or (summary.get("summary") or {}).get("by_tool") or {}
        best_tool = None
        best_val = -1
        if isinstance(by_tool, dict):
            for tool_name, meta in by_tool.items():
                if isinstance(meta, dict):
                    val = meta.get("total") or meta.get("TOTAL") or meta.get("count") or 0
                else:
                    val = meta or 0
                v = _safe_int(val)
                if v > best_val:
                    best_val = v
                    best_tool = tool_name
        if best_tool:
            top_risky_tool = best_tool

    top_cwe = _compute_top_cwe(findings) if findings else "-"
    top_module = _compute_top_module(findings) if findings else "-"

    payload = {
        "ok": True,
        "run_id": run_id,
        "total_findings": total_findings,
        "by_severity": by_severity,
        "severity": by_severity,
        "security_score": security_score,
        "top_risky_tool": top_risky_tool,
        "top_cwe": top_cwe,
        "top_module": top_module,
        "ts": None,
    }
    return jsonify(payload)
