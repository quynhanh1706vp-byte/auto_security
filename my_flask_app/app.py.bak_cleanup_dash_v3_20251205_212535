from importlib import import_module
from flask import Flask, render_template, redirect, url_for, Blueprint, jsonify, request


def _register_blueprints(app: Flask, module_name: str):
    """
    Import module_name và tự động register tất cả biến kiểu Blueprint
    có trong module đó. Không cần biết tên là bp / bp_dashboard / vsp_bp...
    """
    try:
        m = import_module(module_name)
    except Exception as e:
        print(f"[VSP][APP] Cannot import {module_name}: {e}")
        return

    count = 0
    for attr_name, attr_val in vars(m).items():
        if isinstance(attr_val, Blueprint):
            app.register_blueprint(attr_val)
            count += 1
            print(f"[VSP][APP] Registered blueprint from {module_name}: {attr_name} (name={attr_val.name})")
    if count == 0:
        print(f"[VSP][APP] No Blueprint found in {module_name}")


def create_app() -> Flask:
    """
    VERSASECURE PLATFORM (VSP) – UI/API app (factory chuẩn Flask).

    - Auto register blueprint cho VSP API:
        + api_vsp_dashboard_v2
        + api_vsp_datasource_v2
        + api_vsp_runs_v2

    - Route:
        /                    → redirect sang /security_bundle
        /security_bundle     → VSP 2025 UI thương mại (vsp_app.html)
        /security_bundle/v2  → legacy/index.html (nếu anh còn dùng)
    """
    app = Flask(
        __name__,
        static_folder="static",
        template_folder="templates",
    )

    # Đăng ký các blueprint API VSP (tự phát hiện biến Blueprint trong module)
    _register_blueprints(app, "api_vsp_dashboard_v2")
    _register_blueprints(app, "api_vsp_datasource_v2")
    _register_blueprints(app, "api_vsp_runs_v2")
    _register_blueprints(app, "api_vsp_insights_v1")

    # ==== ROUTES UI CHÍNH ====

    @app.route("/security_bundle")
    def security_bundle():
        # VERSASECURE PLATFORM – VSP 2025 UI thương mại (5 tab mới)
        return render_template("vsp_app.html")

    @app.route("/")
    def root():
        # Vào thẳng màn VSP
        return redirect(url_for("security_bundle"))

    @app.route("/security_bundle/v2")
    def vsp_security_bundle_legacy():
        """
        Legacy UI (index.html) nếu anh vẫn muốn giữ lại để so sánh.
        Có thể bỏ route này sau khi ổn định VSP 2025.
        """
        return render_template("index.html")

    return app


# Chạy trực tiếp: python app.py
if __name__ == "__main__":
    app = create_app()
    app.run(debug=True, port=8910)
