from flask import Blueprint, jsonify
from pathlib import Path
import json
import os

bp = Blueprint("vsp_dashboard_v3", __name__)

# ROOT = /home/test/Data/SECURITY_BUNDLE (hard-code cho chắc)
ROOT = Path("/home/test/Data/SECURITY_BUNDLE")
OUT_DIR = ROOT / "out"


def _get_latest_vsp_run_dir():
    """
    1) Nếu có env VSP_RUN_DIR thì dùng đúng thư mục đó.
    2) Nếu không, tìm RUN_VSP_FULL_EXT_* mới nhất trong OUT_DIR.
    """
    env_run = os.environ.get("VSP_RUN_DIR")
    if env_run:
        p = Path(env_run)
        if (p / "report" / "summary_unified.json").is_file():
            print(f"[VSP][DASH] dùng VSP_RUN_DIR={p}")
            return p
        else:
            print(f"[VSP][DASH][WARN] VSP_RUN_DIR={env_run} không hợp lệ.")

    candidates = sorted(OUT_DIR.glob("RUN_VSP_FULL_EXT_*"), reverse=True)
    for c in candidates:
        if (c / "report" / "summary_unified.json").is_file():
            print(f"[VSP][DASH] auto chọn run={c.name}")
            return c

    print(f"[VSP][DASH][ERR] Không tìm thấy RUN_VSP_FULL_EXT_* trong {OUT_DIR}")
    return None


def _safe_int(val):
    try:
        return int(val)
    except Exception:
        try:
            return int(float(val))
        except Exception:
            return 0


def _safe_float(val):
    try:
        return float(val)
    except Exception:
        return None


@bp.route("/api/vsp/dashboard_v3", methods=["GET"])
def api_vsp_dashboard_v3():
    """
    VSP 2025 – Dashboard v3
    Đọc data thật từ out/vsp_dashboard_v3_latest.json (build từ run FULL-EXT mới nhất).
    """
    from flask import jsonify
    from pathlib import Path
    import json

    # ROOT = .../SECURITY_BUNDLE
    root = Path(__file__).resolve().parents[2]
    data_path = root / "out" / "vsp_dashboard_v3_latest.json"

    if not data_path.exists():
        return jsonify(ok=False, error="vsp_dashboard_v3_latest.json not found"), 500

    try:
        data = json.loads(data_path.read_text(encoding="utf-8"))
    except Exception as e:
        return jsonify(ok=False, error=f"Failed to load dashboard data: {e}"), 500

    return jsonify(data)
@bp.route("/api/vsp/trend_v1", methods=["GET"])
def api_vsp_trend_v1():
    payload = _load_latest_dashboard_payload()
    total = int(payload.get("total_findings", 0))
    today = datetime.utcnow().date()
    series = []
    for i in range(7):  # hôm nay -6 -> hôm nay
        d = today - timedelta(days=(6 - i))
        series.append({"date": d.isoformat(), "total": total})
    return jsonify(series)


@bp.route("/api/vsp/top_findings_v1", methods=["GET"])
def api_vsp_top_findings_v1():
    run_dir = _get_latest_run_dir()
    if not run_dir:
        return jsonify({"items": []})
    fu_path = run_dir / "report" / "findings_unified.json"
    if not fu_path.exists():
        return jsonify({"items": []})

    with fu_path.open("r", encoding="utf-8") as f:
        findings = _json.load(f)

    high_crit = [
        f for f in findings
        if str(f.get("severity_effective") or f.get("severity") or "").upper()
        in ("CRITICAL", "HIGH")
    ]
    sev_rank = {"CRITICAL": 0, "HIGH": 1, "MEDIUM": 2, "LOW": 3, "INFO": 4, "TRACE": 5}
    high_crit.sort(
        key=lambda x: sev_rank.get(
            str(x.get("severity_effective") or x.get("severity") or "").upper(), 99
        )
    )

    top = []
    for fitem in high_crit[:10]:
        sev = str(fitem.get("severity_effective") or fitem.get("severity") or "")
        tool = fitem.get("tool") or fitem.get("source_tool") or ""
        rule = fitem.get("rule_id") or fitem.get("id") or ""
        file_path = fitem.get("file") or fitem.get("location") or ""
        line = fitem.get("line") or fitem.get("start_line")
        location = f"{file_path}:{line}" if (file_path and line) else file_path
        top.append(
            {"severity": sev, "rule_id": rule, "location": location, "tool": tool}
        )

    return jsonify({"items": top})


@bp.route("/api/vsp/datasource_stats_v1", methods=["GET"])
def api_vsp_datasource_stats_v1():
    payload = _load_latest_dashboard_payload()
    return jsonify(
        {
            "by_severity": payload.get("by_severity", {},),
            "by_tool": payload.get("by_tool", {},),
        }
    )


def _load_settings():
    if SETTINGS_PATH.exists():
        with SETTINGS_PATH.open("r", encoding="utf-8") as f:
            return _json.load(f)
    return {
        "profile": "default",
        "tools": {
            "semgrep": True,
            "gitleaks": True,
            "bandit": True,
            "trivy_fs": True,
            "grype": True,
            "kics": True,
            "codeql": True,
            "syft": True,
        },
        "limits": {
            "max_findings_per_tool": 5000,
            "top_findings_limit": 10,
        },
    }


@bp.route("/api/vsp/settings/get", methods=["GET"])
def api_vsp_settings_get():
    cfg = _load_settings()
    return jsonify(cfg)


@bp.route("/api/vsp/settings/save", methods=["POST"])
def api_vsp_settings_save():
    payload = request.get_json(force=True) or {}
    with SETTINGS_PATH.open("w", encoding="utf-8") as f:
        _json.dump(payload, f, indent=2, ensure_ascii=False)
    return jsonify({"ok": True})
