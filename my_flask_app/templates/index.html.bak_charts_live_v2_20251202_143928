<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>VersaSecure Platform (VSP)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Main VSP CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/vsp_main.css') }}">

  <!-- Chart.js CDN (dùng cho Dashboard & Data) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="vsp-body">
<div class="vsp-root">
  <!-- Sidebar -->
  <aside class="vsp-sidebar">
    <div class="vsp-logo">
      <div class="vsp-logo-icon">V</div>
      <div class="vsp-logo-text">
        <span class="vsp-logo-title">VersaSecure</span>
        <span class="vsp-logo-sub">Enterprise Security Profile (EXT+)</span>
      </div>
    </div>

    <nav class="vsp-nav">
      <button class="vsp-nav-item active" data-tab-target="tab-dashboard">
        <span class="vsp-nav-dot"></span>
        <span>Dashboard</span>
      </button>
      <button class="vsp-nav-item" data-tab-target="tab-runs">
        <span class="vsp-nav-dot"></span>
        <span>Runs & Reports</span>
      </button>
      <button class="vsp-nav-item" data-tab-target="tab-data">
        <span class="vsp-nav-dot"></span>
        <span>Data Source</span>
      </button>
      <button class="vsp-nav-item" data-tab-target="tab-settings">
        <span class="vsp-nav-dot"></span>
        <span>Settings</span>
      </button>
      <button class="vsp-nav-item" data-tab-target="tab-rules">
        <span class="vsp-nav-dot"></span>
        <span>Rule Overrides</span>
      </button>
    </nav>

    <div class="vsp-sidebar-footer">
      <div class="vsp-badge-profile">Profile: EXT+</div>
      <div class="vsp-badge-build">Build: 2025 Commercial</div>
    </div>
  </aside>

  <!-- Main content -->
  <main class="vsp-main">
    <!-- Top header bar -->
    <header class="vsp-header">
      <div class="vsp-header-left">
        <div class="vsp-header-title">
          <h1>Security Posture Overview</h1>
          <p class="vsp-header-sub">
            Unified findings from 7 tools – normalized into 6 severity levels (CRITICAL → TRACE)
          </p>
        </div>
      </div>
      <div class="vsp-header-right">
        <div class="vsp-header-run-meta">
          <span class="vsp-chip vsp-chip-green">Latest Run</span>
          <span class="vsp-chip vsp-chip-outline">Profile: EXT+</span>
          <span class="vsp-chip vsp-chip-outline">Tools: 7/7</span>
        </div>
        <button class="vsp-btn-primary">
          Run New Scan
        </button>
      </div>
    </header>

    <!-- TAB 1: Dashboard -->
    <section id="tab-dashboard" class="vsp-tab active">
      <!-- KPI row -->
      <div class="vsp-grid vsp-grid-4">
        <div class="vsp-card vsp-card-kpi">
          <div class="vsp-kpi-label">Total Findings</div>
          <div class="vsp-kpi-value" id="kpi-total">0</div>
          <div class="vsp-kpi-sub">Across all 6 severity levels</div>
        </div>
        <div class="vsp-card vsp-card-kpi">
          <div class="vsp-kpi-label">Critical</div>
          <div class="vsp-kpi-value vsp-kpi-critical" id="kpi-critical">0</div>
          <div class="vsp-kpi-sub">Highest risk issues</div>
        </div>
        <div class="vsp-card vsp-card-kpi">
          <div class="vsp-kpi-label">High</div>
          <div class="vsp-kpi-value vsp-kpi-high" id="kpi-high">0</div>
          <div class="vsp-kpi-sub">Priority remediation</div>
        </div>
        <div class="vsp-card vsp-card-kpi">
          <div class="vsp-kpi-label">Tools Active</div>
          <div class="vsp-kpi-value" id="kpi-tools">7</div>
          <div class="vsp-kpi-sub">Gitleaks, Semgrep, Bandit, Trivy, Grype, KICS, CodeQL</div>
        </div>
      </div>

      <!-- Charts row -->
      <div class="vsp-grid vsp-grid-2">
        <div class="vsp-card vsp-card-chart">
          <div class="vsp-card-header">
            <span class="vsp-card-title">Severity Distribution</span>
            <span class="vsp-card-sub">Normalized (CRITICAL → TRACE)</span>
          </div>
          <div class="vsp-chart-wrapper">
            <canvas id="chartSeverity"></canvas>
          </div>
        </div>
        <div class="vsp-card vsp-card-chart">
          <div class="vsp-card-header">
            <span class="vsp-card-title">Findings by Tool</span>
            <span class="vsp-card-sub">7-tool DevSecOps stack</span>
          </div>
          <div class="vsp-chart-wrapper">
            <canvas id="chartByTool"></canvas>
          </div>
        </div>
      </div>

      <!-- Top risk files row -->
      <div class="vsp-grid vsp-grid-1">
        <div class="vsp-card">
          <div class="vsp-card-header">
            <span class="vsp-card-title">Top Risk Files</span>
            <span class="vsp-card-sub">Sorted by CRITICAL + HIGH + MEDIUM</span>
          </div>
          <div class="vsp-table-wrapper">
            <table class="vsp-table">
              <thead>
              <tr>
                <th>File / Path</th>
                <th>CRIT</th>
                <th>HIGH</th>
                <th>MED</th>
                <th>LOW</th>
              </tr>
              </thead>
              <tbody id="table-top-files">
              <!-- Filled by JS -->
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Risk summary -->
      <div class="vsp-grid vsp-grid-1">
        <div class="vsp-card vsp-card-summary">
          <div class="vsp-card-header">
            <span class="vsp-card-title">Risk Summary (AI-style narrative)</span>
          </div>
          <p id="risk-summary-text" class="vsp-summary-text">
            Waiting for data from unified summary (summary_unified_v2.json)...
          </p>
        </div>
      </div>
    </section>

    <!-- TAB 2: Runs & Reports -->
    <section id="tab-runs" class="vsp-tab">
      <div class="vsp-card">
        <div class="vsp-card-header">
          <span class="vsp-card-title">Run History</span>
          <span class="vsp-card-sub">Each run is a unified scan for a source / URL</span>
        </div>
        <div class="vsp-table-toolbar">
          <div class="vsp-table-filters">
            <input class="vsp-input" placeholder="Filter by source / URL...">
          </div>
          <div class="vsp-table-actions">
            <button class="vsp-btn-secondary">Export Run Index</button>
          </div>
        </div>
        <div class="vsp-table-wrapper">
          <table class="vsp-table">
            <thead>
            <tr>
              <th>Run ID</th>
              <th>Source / URL</th>
              <th>Profile</th>
              <th>CRIT</th>
              <th>HIGH</th>
              <th>MED</th>
              <th>LOW</th>
              <th>INFO</th>
              <th>TRACE</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
            </thead>
            <tbody id="runs-table-body">
            <!-- JS sẽ fill từ /api sau này -->
            <tr>
              <td>URL_staging-zt_20251128_170001</td>
              <td>https://staging-zt.lab.linksafe.vn</td>
              <td>EXT+</td>
              <td>2</td>
              <td>21</td>
              <td>80</td>
              <td>40</td>
              <td>10</td>
              <td>3</td>
              <td><span class="vsp-badge-status success">Completed</span></td>
              <td>
                <button class="vsp-link-button">View</button>
                <button class="vsp-link-button">Export</button>
              </td>
            </tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- TAB 3: Data Source -->
    <section id="tab-data" class="vsp-tab">
      <div class="vsp-grid vsp-grid-3-1">
        <!-- Main table -->
        <div class="vsp-card">
          <div class="vsp-card-header">
            <span class="vsp-card-title">Unified Findings</span>
            <span class="vsp-card-sub">From report/findings_unified_v2.json</span>
          </div>
          <div class="vsp-table-toolbar">
            <div class="vsp-table-filters">
              <select class="vsp-input vsp-input-small">
                <option value="">Severity: All</option>
                <option>CRITICAL</option>
                <option>HIGH</option>
                <option>MEDIUM</option>
                <option>LOW</option>
                <option>INFO</option>
                <option>TRACE</option>
              </select>
              <select class="vsp-input vsp-input-small">
                <option value="">Tool: All</option>
                <option>Gitleaks</option>
                <option>Semgrep</option>
                <option>Bandit</option>
                <option>TrivyFS</option>
                <option>Grype</option>
                <option>KICS</option>
                <option>CodeQL</option>
              </select>
              <input class="vsp-input vsp-input-medium" placeholder="Search file / rule / message...">
            </div>
            <div class="vsp-table-actions">
              <button class="vsp-btn-secondary">Export CSV</button>
            </div>
          </div>
          <div class="vsp-table-wrapper vsp-table-wrapper-tall">
            <table class="vsp-table">
              <thead>
              <tr>
                <th>Severity</th>
                <th>Tool</th>
                <th>File</th>
                <th>Line</th>
                <th>Rule ID</th>
                <th>Message</th>
                <th>CWE</th>
              </tr>
              </thead>
              <tbody id="data-table-body">
              <!-- Sample row -->
              <tr>
                <td><span class="vsp-pill sev-high">HIGH</span></td>
                <td>Semgrep</td>
                <td>src/app/auth/login.py</td>
                <td>123</td>
                <td>python.jwt.insecure-decode</td>
                <td>JWT is decoded without verifying the signature</td>
                <td>CWE-347</td>
              </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Side mini charts -->
        <div class="vsp-card vsp-card-sidecharts">
          <div class="vsp-card-header">
            <span class="vsp-card-title">Data Insights</span>
          </div>
          <div class="vsp-chart-wrapper mini">
            <span class="vsp-sidechart-label">By severity</span>
            <canvas id="chartDataSeverity"></canvas>
          </div>
          <div class="vsp-chart-wrapper mini">
            <span class="vsp-sidechart-label">By tool</span>
            <canvas id="chartDataTool"></canvas>
          </div>
        </div>
      </div>
    </section>

    <!-- TAB 4: Settings -->
    <section id="tab-settings" class="vsp-tab">
      <div class="vsp-grid vsp-grid-3">
        <div class="vsp-card">
          <div class="vsp-card-header">
            <span class="vsp-card-title">General</span>
          </div>
          <div class="vsp-form-group">
            <label>Default Profile</label>
            <select class="vsp-input">
              <option selected>EXT+ (Enterprise)</option>
              <option>FAST (Smoke)</option>
              <option>AGGR (Deep)</option>
            </select>
          </div>
          <div class="vsp-form-group">
            <label>Max Findings per run (UI)</label>
            <input class="vsp-input" type="number" value="5000">
          </div>
        </div>

        <div class="vsp-card">
          <div class="vsp-card-header">
            <span class="vsp-card-title">Tool Stack</span>
          </div>
          <div class="vsp-toggle-row">
            <span>Gitleaks (Secrets)</span>
            <label class="vsp-switch">
              <input type="checkbox" checked>
              <span class="vsp-slider"></span>
            </label>
          </div>
          <div class="vsp-toggle-row">
            <span>Semgrep (SAST)</span>
            <label class="vsp-switch">
              <input type="checkbox" checked>
              <span class="vsp-slider"></span>
            </label>
          </div>
          <div class="vsp-toggle-row">
            <span>Bandit (Python SAST)</span>
            <label class="vsp-switch">
              <input type="checkbox" checked>
              <span class="vsp-slider"></span>
            </label>
          </div>
          <div class="vsp-toggle-row">
            <span>TrivyFS / Grype (Vuln / SBOM)</span>
            <label class="vsp-switch">
              <input type="checkbox" checked>
              <span class="vsp-slider"></span>
            </label>
          </div>
          <div class="vsp-toggle-row">
            <span>KICS (IaC)</span>
            <label class="vsp-switch">
              <input type="checkbox" checked>
              <span class="vsp-slider"></span>
            </label>
          </div>
          <div class="vsp-toggle-row">
            <span>CodeQL (Advanced SAST)</span>
            <label class="vsp-switch">
              <input type="checkbox" checked>
              <span class="vsp-slider"></span>
            </label>
          </div>
        </div>

        <div class="vsp-card">
          <div class="vsp-card-header">
            <span class="vsp-card-title">Export & Reporting</span>
          </div>
          <div class="vsp-form-group">
            <label>Default export format</label>
            <select class="vsp-input">
              <option>HTML</option>
              <option>PDF</option>
              <option>CSV</option>
              <option>SARIF</option>
            </select>
          </div>
          <div class="vsp-form-group">
            <label>Include ISO 27001 mapping</label>
            <label class="vsp-switch">
              <input type="checkbox" checked>
              <span class="vsp-slider"></span>
            </label>
          </div>
        </div>
      </div>
    </section>

    <!-- TAB 5: Rule Overrides -->
    <section id="tab-rules" class="vsp-tab">
      <div class="vsp-grid vsp-grid-3-2">
        <!-- Rule list -->
        <div class="vsp-card">
          <div class="vsp-card-header">
            <span class="vsp-card-title">Rule Sets</span>
            <span class="vsp-card-sub">Override severity / enable / disable per rule</span>
          </div>
          <ul class="vsp-rule-list">
            <li class="active">Semgrep – websec_profile.yml</li>
            <li>Semgrep – python_secure.yml</li>
            <li>KICS – aws_cloud_profile.yml</li>
            <li>CodeQL – default-queries.yml</li>
          </ul>
        </div>

        <!-- Editor -->
        <div class="vsp-card vsp-card-editor">
          <div class="vsp-card-header">
            <span class="vsp-card-title">Rule Override Editor</span>
            <span class="vsp-card-sub">YAML preview – not saved yet</span>
          </div>
          <textarea class="vsp-editor" spellcheck="false">
rules:
  - id: python.jwt.insecure-decode
    message: "JWT is decoded without verifying the signature"
    severity: HIGH   # override here (CRITICAL/HIGH/MEDIUM/LOW/INFO/TRACE)
    metadata:
      cwe: CWE-347
      owasp: A02:2021
      iso27001: A.14.2.5
  - id: sql.injection.generic
    severity: CRITICAL
    metadata:
      cwe: CWE-89
      owasp: A03:2021
          </textarea>
          <div class="vsp-editor-actions">
            <button class="vsp-btn-secondary">Validate YAML</button>
            <button class="vsp-btn-primary">Apply Override</button>
          </div>
        </div>
      </div>
    </section>
  </main>
</div>

<!-- Main JS -->
<script src="{{ url_for('static', filename='js/vsp_main.js') }}"></script>
    <script src="/static/js/vsp_dashboard_live_v2.js"></script>
</body>
</html>
