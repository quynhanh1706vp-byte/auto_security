<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Flask + PDF export demo</title>
</head>
<body>
<div class="sb-form-row">
  <div class="sb-form-field">
    <label for="src_path" class="sb-label">
      Thư mục / URL cần scan
    </label>
    <input
      type="text"
      id="src_path"
      name="src_path"
      class="sb-input"
      style="position:relative; z-index:9999; pointer-events:auto; background:#050814; color:#e5e7eb; border:1px solid #1f2933; border-radius:10px; padding:8px 12px; width:100%; position:relative; z-index:9999; pointer-events:auto;"
      placeholder="VD: /home/test/Data/khach6 hoặc https://example.com"
      autocomplete="off"
    />
  </div>
</div>

  <h1>Flask + PDF export demo</h1>
  <p>Nhấn nút bên dưới để xuất PDF từ HTML.</p>
  <div class="sb-form-row">
  <div class="sb-form-field">
    <label for="src_path" class="sb-label">
      Thư mục / URL cần scan
    </label>
    <input
      type="text"
      id="src_path"
      name="src_path"
      class="sb-input"
      style="pointer-events:auto; background:#050814; color:#e5e7eb; border:1px solid #1f2933; border-radius:10px; padding:8px 12px; width:100%;"
      placeholder="VD: /home/test/Data/khach6 hoặc https://example.com"
      autocomplete="off"
    />
  </div>
</div>
<div class="sb-form-row">
  <div class="sb-form-field">
    <label for="src_path" class="sb-label">
      Thư mục / URL cần scan
    </label>
    <input
      type="text"
      id="src_path"
      name="src_path"
      class="sb-input"
      style="pointer-events:auto; background:#050814; color:#e5e7eb; border:1px solid #1f2933; border-radius:10px; padding:8px 12px; width:100%;"
      placeholder="VD: /home/test/Data/khach6 hoặc https://example.com"
      autocomplete="off"
    />
  </div>
</div>
<form method="POST" action="/generate-pdf">
    <button type="submit" class="sb-run-btn">
  <span class="sb-run-btn-icon">▶</span>
  <span>Run VersaSecure Platform – VSP scan</span>
</button>
  </form>

  <script>
  /* SB_RUN_BTN_V1 */
  document.addEventListener('DOMContentLoaded', function () {
    // Tìm nút Run scan
    const btn =
      document.querySelector('[data-role="sb-run-ext-main"]') ||
      document.querySelector('#sb_run_btn') ||
      Array.from(document.querySelectorAll('button'))
        .find(b => (b.textContent || '').trim().includes('Run scan'));

    if (!btn) {
      console.warn('SB_RUN_BTN_V1: Không tìm thấy nút Run scan');
      return;
    }

    console.log('SB_RUN_BTN_V1: Đã bind vào nút Run scan', btn);

    btn.onclick = async function (e) {
      e.preventDefault();

      const srcEl =
        document.getElementById('sb_src_path') ||
        document.querySelector('input[name="src_path"]') ||
        document.querySelector('#src_path');

      const urlEl =
        document.getElementById('sb_target_url') ||
        document.querySelector('input[name="target_url"]') ||
        document.querySelector('#target_url');

      const src = srcEl ? srcEl.value.trim() : '';
      const target = urlEl ? urlEl.value.trim() : '';

      console.log('SB_RUN_BTN_V1: Run scan click', { src, target });

      try {
        const res = await fetch('/api/security_bundle/run_ext', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            src_path: src,
            target_url: target,
            profile: 'EXT'
          })
        });

        const data = await res.json().catch(() => ({}));
        console.log('SB_RUN_BTN_V1: API response', data);

        alert(
          data.message ||
          ('Đã start VersaSecure Platform – VSP EXT+. run_id=' + (data.run_id || 'N/A'))
        );
      } catch (err) {
        console.error('SB_RUN_BTN_V1: Lỗi gọi API', err);
        alert('Lỗi khi gọi API /api/security_bundle/run_ext. Xem console.');
      }
    };
  });
  </script>


  <script>
  // SB_RUN_BTN_V2
  (function () {
    console.log("SB_RUN_BTN_V2: init");

    function bind() {
      var btn =
        document.querySelector('[data-role="sb-run-ext-main"]') ||
        document.querySelector('#sb_run_btn') ||
        Array.from(document.querySelectorAll('button'))
          .find(function (b) {
            return (b.textContent || "").trim().indexOf("Run scan") !== -1;
          });

      if (!btn) {
        console.warn("SB_RUN_BTN_V2: Không tìm thấy nút Run scan");
        return;
      }

      console.log("SB_RUN_BTN_V2: Đã tìm thấy nút Run scan", btn);

      btn.addEventListener("click", function (e) {
        e.preventDefault();

        var srcEl =
          document.getElementById("sb_src_path") ||
          document.querySelector('input[name="src_path"]') ||
          document.querySelector("#src_path");

        var urlEl =
          document.getElementById("sb_target_url") ||
          document.querySelector('input[name="target_url"]') ||
          document.querySelector("#target_url");

        var src = srcEl ? (srcEl.value || "").trim() : "";
        var target = urlEl ? (urlEl.value || "").trim() : "";

        console.log("SB_RUN_BTN_V2: Click Run scan", { src: src, target: target });

        fetch("/api/security_bundle/run_ext_v1", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            src_path: src,
            target_url: target,
            profile: "EXT",
          }),
        })
          .then(function (res) {
            return res.json().catch(function () { return {}; });
          })
          .then(function (data) {
            console.log("SB_RUN_BTN_V2: API response", data);
            alert(
              data.message ||
                ("Đã start VersaSecure Platform – VSP EXT+. run_id=" + (data.run_id || "N/A"))
            );
          })
          .catch(function (err) {
            console.error("SB_RUN_BTN_V2: Lỗi khi gọi API", err);
            alert("Lỗi khi gọi API /api/security_bundle/run_ext_v1. Xem console.");
          });
      });
    }

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", bind);
    } else {
      bind();
    }
  })();
  </script>


  <script>
  // SB_HIDE_MODE_CHIPS_V1
  (function () {
    function hideChips() {
      var keywords = ["MODE Offline", "LAST RUN", "Target:", "Source:"];

      keywords.forEach(function(kw) {
        var all = Array.from(document.querySelectorAll("*"));
        all.forEach(function(el) {
          if (!el || !el.textContent) return;
          var txt = el.textContent.trim();
          if (txt.indexOf(kw) !== -1) {
            // cố gắng xoá nguyên pill/chip
            var target = el.closest(".chip-row, .meta-row, .badge-row, .flex, .d-flex, .pill, .tag") || el.parentElement || el;
            if (target && target.parentElement) {
              console.log("SB_HIDE_MODE_CHIPS_V1: remove block for", kw, target);
              target.parentElement.removeChild(target);
            }
          }
        });
      });
    }

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", hideChips);
    } else {
      hideChips();
    }
  })();
  </script>


  <script>
  // SB_HIDE_MODE_CHIPS_V2
  (function () {
    function hideMeta() {
      console.log("SB_HIDE_MODE_CHIPS_V2: init hideMeta()");
      var keywords = ["MODE ", "LAST RUN", "Target:", "Source:"];

      var all = Array.from(document.querySelectorAll("*"));
      all.forEach(function (el) {
        if (!el || !el.innerText) return;
        var txt = el.innerText.trim();
        keywords.forEach(function (kw) {
          if (txt.indexOf(kw) !== -1) {
            var block =
              el.closest(".chip-row, .meta-row, .badge-row, .flex, .d-flex, .row") ||
              el.parentElement ||
              el;
            if (block && !block.dataset.sbMetaHidden) {
              block.style.display = "none";
              block.dataset.sbMetaHidden = "1";
              console.log("SB_HIDE_MODE_CHIPS_V2: hide block for", kw, block);
            }
          }
        });
      });
    }

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", hideMeta);
    } else {
      hideMeta();
    }
    // chạy lại sau 500ms đề phòng lazy-render
    setTimeout(hideMeta, 500);
  })();
  </script>
\n</body>
</html>
