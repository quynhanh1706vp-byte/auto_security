<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Flask + PDF export demo</title>
</head>
<body>
<div class="sb-form-row">
  <div class="sb-form-field">
    <label for="src_path" class="sb-label">
      Thư mục / URL cần scan
    </label>
    <input
      type="text"
      id="src_path"
      name="src_path"
      class="sb-input"
      style="position:relative; z-index:9999; pointer-events:auto; background:#050814; color:#e5e7eb; border:1px solid #1f2933; border-radius:10px; padding:8px 12px; width:100%; position:relative; z-index:9999; pointer-events:auto;"
      placeholder="VD: /home/test/Data/khach6 hoặc https://example.com"
      autocomplete="off"
    />
  </div>
</div>

  <h1>Flask + PDF export demo</h1>
  <p>Nhấn nút bên dưới để xuất PDF từ HTML.</p>
  <div class="sb-form-row">
  <div class="sb-form-field">
    <label for="src_path" class="sb-label">
      Thư mục / URL cần scan
    </label>
    <input
      type="text"
      id="src_path"
      name="src_path"
      class="sb-input"
      style="pointer-events:auto; background:#050814; color:#e5e7eb; border:1px solid #1f2933; border-radius:10px; padding:8px 12px; width:100%;"
      placeholder="VD: /home/test/Data/khach6 hoặc https://example.com"
      autocomplete="off"
    />
  </div>
</div>
<div class="sb-form-row">
  <div class="sb-form-field">
    <label for="src_path" class="sb-label">
      Thư mục / URL cần scan
    </label>
    <input
      type="text"
      id="src_path"
      name="src_path"
      class="sb-input"
      style="pointer-events:auto; background:#050814; color:#e5e7eb; border:1px solid #1f2933; border-radius:10px; padding:8px 12px; width:100%;"
      placeholder="VD: /home/test/Data/khach6 hoặc https://example.com"
      autocomplete="off"
    />
  </div>
</div>
<form method="POST" action="/generate-pdf">
    <button type="submit" class="sb-run-btn">
  <span class="sb-run-btn-icon">▶</span>
  <span>Run SECURITY_BUNDLE scan</span>
</button>
  </form>

  <script>
  /* SB_RUN_BTN_V1 */
  document.addEventListener('DOMContentLoaded', function () {
    // Tìm nút Run scan
    const btn =
      document.querySelector('[data-role="sb-run-ext-main"]') ||
      document.querySelector('#sb_run_btn') ||
      Array.from(document.querySelectorAll('button'))
        .find(b => (b.textContent || '').trim().includes('Run scan'));

    if (!btn) {
      console.warn('SB_RUN_BTN_V1: Không tìm thấy nút Run scan');
      return;
    }

    console.log('SB_RUN_BTN_V1: Đã bind vào nút Run scan', btn);

    btn.onclick = async function (e) {
      e.preventDefault();

      const srcEl =
        document.getElementById('sb_src_path') ||
        document.querySelector('input[name="src_path"]') ||
        document.querySelector('#src_path');

      const urlEl =
        document.getElementById('sb_target_url') ||
        document.querySelector('input[name="target_url"]') ||
        document.querySelector('#target_url');

      const src = srcEl ? srcEl.value.trim() : '';
      const target = urlEl ? urlEl.value.trim() : '';

      console.log('SB_RUN_BTN_V1: Run scan click', { src, target });

      try {
        const res = await fetch('/api/security_bundle/run_ext', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            src_path: src,
            target_url: target,
            profile: 'EXT'
          })
        });

        const data = await res.json().catch(() => ({}));
        console.log('SB_RUN_BTN_V1: API response', data);

        alert(
          data.message ||
          ('Đã start SECURITY_BUNDLE EXT+. run_id=' + (data.run_id || 'N/A'))
        );
      } catch (err) {
        console.error('SB_RUN_BTN_V1: Lỗi gọi API', err);
        alert('Lỗi khi gọi API /api/security_bundle/run_ext. Xem console.');
      }
    };
  });
  </script>


  
  
  <script>
  // SB_RUN_BTN_V2
  (function () {
    console.log("SB_RUN_BTN_V2: init");

    function clearDemoMeta() {
      // Ẩn các chip demo lúc mới mở trang
      var all = Array.from(document.querySelectorAll("*"));
      all.forEach(function (el) {
        if (!el || !el.textContent) return;
        var txt = el.textContent.trim();

        // Các giá trị demo cần ẩn
        if (
          (txt.startsWith("Target:") && txt.indexOf("app.example.com") !== -1) ||
          (txt.startsWith("Source:") && txt.indexOf("/home/tests/Data/CODE_20110225_P") !== -1) ||
          (txt.startsWith("LAST RUN") && txt.indexOf("RUN_gitleaks_") !== -1)
        ) {
          // Ẩn cả chip / block chứa text đó
          var block = el.closest(".chip-row, .meta-row, .badge-row, .row") || el;
          if (block && !block.dataset.sbDemoHidden) {
            block.style.display = "none";
            block.dataset.sbDemoHidden = "1";
            console.log("SB_RUN_BTN_V2: clear demo meta -> hide", txt);
          }
        }
      });
    }

    function updateMeta(src, target, runId) {
      // Khi có run thật → hiển thị / cập nhật lại các chip
      var all = Array.from(document.querySelectorAll("*"));
      all.forEach(function (el) {
        if (!el || !el.textContent) return;
        var txt = el.textContent.trim();

        if (txt.startsWith("LAST RUN")) {
          el.textContent = "LAST RUN " + (runId || "N/A");
          el.style.display = "";
        } else if (txt.startsWith("Target:")) {
          el.textContent = "Target: " + (target || "");
          el.style.display = "";
        } else if (txt.startsWith("Source:")) {
          el.textContent = "Source: " + (src || "");
          el.style.display = "";
        }
      });
    }

    function bind() {
      clearDemoMeta();  // ẩn demo ngay khi DOM ready

      var btn =
        document.querySelector('[data-role="sb-run-ext-main"]') ||
        document.querySelector('#sb_run_btn') ||
        Array.from(document.querySelectorAll('button'))
          .find(function (b) {
            return (b.textContent || "").trim().indexOf("Run scan") !== -1;
          });

      if (!btn) {
        console.warn("SB_RUN_BTN_V2: Không tìm thấy nút Run scan");
        return;
      }

      console.log("SB_RUN_BTN_V2: Đã tìm thấy nút Run scan", btn);

      btn.addEventListener("click", function (e) {
        e.preventDefault();

        var srcEl =
          document.getElementById("sb_src_path") ||
          document.querySelector('input[name="src_path"]') ||
          document.querySelector("#src_path");

        var urlEl =
          document.getElementById("sb_target_url") ||
          document.querySelector('input[name="target_url"]') ||
          document.querySelector("#target_url");

        var src = srcEl ? (srcEl.value || "").trim() : "";
        var target = urlEl ? (urlEl.value || "").trim() : "";

        console.log("SB_RUN_BTN_V2: Click Run scan", { src: src, target: target });

        fetch("/api/security_bundle/run_ext_v1", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            src_path: src,
            target_url: target,
            profile: "EXT",
          }),
        })
          .then(function (res) {
            return res.json().catch(function () { return {}; });
          })
          .then(function (data) {
            console.log("SB_RUN_BTN_V2: API response", data);
            updateMeta(src, target, data.run_id || "N/A");
            alert(
              data.message ||
                ("Đã start SECURITY_BUNDLE EXT+. run_id=" + (data.run_id || "N/A"))
            );
          })
          .catch(function (err) {
            console.error("SB_RUN_BTN_V2: Lỗi khi gọi API", err);
            alert("Lỗi khi gọi API /api/security_bundle/run_ext_v1. Xem console.");
          });
      });
    }

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", bind);
    } else {
      bind();
    }
  })();
  </script>




  <script>
  // SB_HIDE_MODE_CHIPS_V1
  (function () {
    function hideChips() {
      var keywords = ["MODE Offline", "LAST RUN", "Target:", "Source:"];

      keywords.forEach(function(kw) {
        var all = Array.from(document.querySelectorAll("*"));
        all.forEach(function(el) {
          if (!el || !el.textContent) return;
          var txt = el.textContent.trim();
          if (txt.indexOf(kw) !== -1) {
            // cố gắng xoá nguyên pill/chip
            var target = el.closest(".chip-row, .meta-row, .badge-row, .flex, .d-flex, .pill, .tag") || el.parentElement || el;
            if (target && target.parentElement) {
              console.log("SB_HIDE_MODE_CHIPS_V1: remove block for", kw, target);
              target.parentElement.removeChild(target);
            }
          }
        });
      });
    }

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", hideChips);
    } else {
      hideChips();
    }
  })();
  </script>


  <script>
  // SB_HIDE_MODE_CHIPS_V2
  (function () {
    function hideMeta() {
      console.log("SB_HIDE_MODE_CHIPS_V2: init hideMeta()");
      var keywords = ["MODE ", "LAST RUN", "Target:", "Source:"];

      var all = Array.from(document.querySelectorAll("*"));
      all.forEach(function (el) {
        if (!el || !el.innerText) return;
        var txt = el.innerText.trim();
        keywords.forEach(function (kw) {
          if (txt.indexOf(kw) !== -1) {
            var block =
              el.closest(".chip-row, .meta-row, .badge-row, .flex, .d-flex, .row") ||
              el.parentElement ||
              el;
            if (block && !block.dataset.sbMetaHidden) {
              block.style.display = "none";
              block.dataset.sbMetaHidden = "1";
              console.log("SB_HIDE_MODE_CHIPS_V2: hide block for", kw, block);
            }
          }
        });
      });
    }

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", hideMeta);
    } else {
      hideMeta();
    }
    // chạy lại sau 500ms đề phòng lazy-render
    setTimeout(hideMeta, 500);
  })();
  </script>
\n
  <script>
  // SB_RUNS_EXPORT_V2
  (function () {
    function tableToData(table) {
      var rows = [];
      var head = table.querySelector("thead");
      if (head) {
        var headerCells = Array.from(head.querySelectorAll("th"));
        rows.push(headerCells.map(function (th) {
          return (th.innerText || "").trim();
        }));
      }
      var body = table.querySelector("tbody");
      if (body) {
        Array.from(body.querySelectorAll("tr")).forEach(function (tr) {
          var cells = Array.from(tr.querySelectorAll("td"));
          rows.push(cells.map(function (td) {
            return (td.innerText || "").trim();
          }));
        });
      }
      return rows;
    }

    function exportCSV(table) {
      var rows = tableToData(table);
      if (!rows.length) return;
      var csv = rows.map(function (r) {
        return r.map(function (cell) {
          var c = cell.replace(/"/g, '""');
          return '"' + c + '"';
        }).join(",");
      }).join("\n");
      var blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      var url = URL.createObjectURL(blob);
      var a = document.createElement("a");
      a.href = url;
      a.download = "security_bundle_runs.csv";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function exportHTML(table) {
      var html = "<html><head><meta charset=\"utf-8\"><title>SECURITY_BUNDLE Runs</title></head><body>" +
                 "<h2>History of SECURITY_BUNDLE runs</h2>" +
                 table.outerHTML +
                 "
  <script>
  // SB_RUNS_LAYOUT_EXPORT_V3
  (function () {
    function tableToData(table) {
      var rows = [];
      var head = table.querySelector("thead");
      if (head) {
        var headerCells = Array.from(head.querySelectorAll("th"));
        rows.push(headerCells.map(function (th) {
          return (th.innerText || "").trim();
        }));
      }
      var body = table.querySelector("tbody");
      if (body) {
        Array.from(body.querySelectorAll("tr")).forEach(function (tr) {
          var cells = Array.from(tr.querySelectorAll("td"));
          rows.push(cells.map(function (td) {
            return (td.innerText || "").trim();
          }));
        });
      }
      return rows;
    }

    function exportCSV(table) {
      var rows = tableToData(table);
      if (!rows.length) return;
      var csv = rows.map(function (r) {
        return r.map(function (cell) {
          var c = cell.replace(/"/g, '""');
          return '"' + c + '"';
        }).join(",");
      }).join("\n");
      var blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      var url = URL.createObjectURL(blob);
      var a = document.createElement("a");
      a.href = url;
      a.download = "security_bundle_runs.csv";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function exportHTML(table) {
      var html = "<html><head><meta charset=\"utf-8\"><title>SECURITY_BUNDLE Runs</title></head><body>" +
                 "<h2>History of SECURITY_BUNDLE runs</h2>" +
                 table.outerHTML +
                 "</body></html>";
      var blob = new Blob([html], { type: "text/html;charset=utf-8;" });
      var url = URL.createObjectURL(blob);
      var a = document.createElement("a");
      a.href = url;
      a.download = "security_bundle_runs.html";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function exportPDF(table) {
      var html = "<html><head><meta charset=\"utf-8\"><title>SECURITY_BUNDLE Runs PDF</title></head><body>" +
                 "<h2>History of SECURITY_BUNDLE runs</h2>" +
                 table.outerHTML +
                 "</body></html>";
      var w = window.open("", "_blank");
      if (!w) return;
      w.document.open();
      w.document.write(html);
      w.document.close();
      w.focus();
    }

    function initRunsLayoutExport() {
      var tab =
        document.getElementById("tab-runs") ||
        document.querySelector('[data-tab="runs"]') ||
        document.querySelector(".runs-root");

      if (!tab) {
        console.warn("SB_RUNS_LAYOUT_EXPORT_V3: không tìm thấy tab Runs.");
        return;
      }

      // Bỏ scroll nội bộ: bất kỳ div/section trong tab có overflow-y auto/scroll -> cho visible
      Array.from(tab.querySelectorAll("div,section")).forEach(function (el) {
        var st = window.getComputedStyle(el);
        if (st.overflowY === "auto" || st.overflowY === "scroll") {
          el.style.overflowY = "visible";
          el.style.maxHeight = "none";
          el.style.height = "auto";
        }
      });

      // Card full-width
      Array.from(tab.querySelectorAll(".card, .sb-card")).forEach(function (el) {
        el.style.width = "100%";
        el.style.margin = "0 auto";
        el.style.borderRadius = "24px";
        el.style.boxShadow = "0 18px 40px rgba(0,0,0,0.5)";
      });

      // Tìm table chính
      var table = tab.querySelector("table");
      if (!table) {
        console.warn("SB_RUNS_LAYOUT_EXPORT_V3: không thấy table trong tab runs.");
        return;
      }

      // Thanh Export (nếu chưa có)
      if (!tab.querySelector(".sb-runs-export-bar")) {
        var wrapper = table.parentElement || tab;
        var bar = document.createElement("div");
        bar.className = "sb-runs-export-bar";
        bar.style.display = "flex";
        bar.style.alignItems = "center";
        bar.style.justifyContent = "space-between";
        bar.style.marginBottom = "12px";

        bar.innerHTML = [
          '<div style="font-size:13px;opacity:0.85;">Export runs history</div>',
          '<div style="display:flex;gap:8px;">',
          '  <button type="button" data-fmt="csv">CSV</button>',
          '  <button type="button" data-fmt="html">HTML</button>',
          '  <button type="button" data-fmt="pdf">PDF</button>',
          "</div>"
        ].join("");

        if (wrapper.parentElement) {
          wrapper.parentElement.insertBefore(bar, wrapper);
        } else {
          tab.insertBefore(bar, wrapper);
        }

        // Styling nút nhanh bằng inline
        Array.from(bar.querySelectorAll("button[data-fmt]")).forEach(function (btn) {
          btn.style.fontSize = "12px";
          btn.style.padding = "6px 12px";
          btn.style.borderRadius = "999px";
          btn.style.border = "1px solid rgba(0,198,255,0.5)";
          btn.style.background = "rgba(0,0,0,0.25)";
          btn.style.cursor = "pointer";
          btn.addEventListener("mouseover", function () {
            btn.style.background = "rgba(0,198,255,0.2)";
          });
          btn.addEventListener("mouseout", function () {
            btn.style.background = "rgba(0,0,0,0.25)";
          });
          btn.addEventListener("click", function () {
            var fmt = btn.getAttribute("data-fmt");
            if (fmt === "csv") exportCSV(table);
            else if (fmt === "html") exportHTML(table);
            else if (fmt === "pdf") exportPDF(table);
          });
        });

        console.log("SB_RUNS_LAYOUT_EXPORT_V3: export bar initialized.");
      }
    }

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", initRunsLayoutExport);
    } else {
      initRunsLayoutExport();
    }
  })();
  </script>

</body></html>";
      var blob = new Blob([html], { type: "text/html;charset=utf-8;" });
      var url = URL.createObjectURL(blob);
      var a = document.createElement("a");
      a.href = url;
      a.download = "security_bundle_runs.html";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function exportPDF(table) {
      // Đơn giản: mở tab mới để user Print -> Save as PDF
      var html = "<html><head><meta charset=\"utf-8\"><title>SECURITY_BUNDLE Runs PDF</title></head><body>" +
                 "<h2>History of SECURITY_BUNDLE runs</h2>" +
                 table.outerHTML +
                 "
  <script>
  // SB_RUNS_LAYOUT_EXPORT_V3
  (function () {
    function tableToData(table) {
      var rows = [];
      var head = table.querySelector("thead");
      if (head) {
        var headerCells = Array.from(head.querySelectorAll("th"));
        rows.push(headerCells.map(function (th) {
          return (th.innerText || "").trim();
        }));
      }
      var body = table.querySelector("tbody");
      if (body) {
        Array.from(body.querySelectorAll("tr")).forEach(function (tr) {
          var cells = Array.from(tr.querySelectorAll("td"));
          rows.push(cells.map(function (td) {
            return (td.innerText || "").trim();
          }));
        });
      }
      return rows;
    }

    function exportCSV(table) {
      var rows = tableToData(table);
      if (!rows.length) return;
      var csv = rows.map(function (r) {
        return r.map(function (cell) {
          var c = cell.replace(/"/g, '""');
          return '"' + c + '"';
        }).join(",");
      }).join("\n");
      var blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      var url = URL.createObjectURL(blob);
      var a = document.createElement("a");
      a.href = url;
      a.download = "security_bundle_runs.csv";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function exportHTML(table) {
      var html = "<html><head><meta charset=\"utf-8\"><title>SECURITY_BUNDLE Runs</title></head><body>" +
                 "<h2>History of SECURITY_BUNDLE runs</h2>" +
                 table.outerHTML +
                 "</body></html>";
      var blob = new Blob([html], { type: "text/html;charset=utf-8;" });
      var url = URL.createObjectURL(blob);
      var a = document.createElement("a");
      a.href = url;
      a.download = "security_bundle_runs.html";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function exportPDF(table) {
      var html = "<html><head><meta charset=\"utf-8\"><title>SECURITY_BUNDLE Runs PDF</title></head><body>" +
                 "<h2>History of SECURITY_BUNDLE runs</h2>" +
                 table.outerHTML +
                 "</body></html>";
      var w = window.open("", "_blank");
      if (!w) return;
      w.document.open();
      w.document.write(html);
      w.document.close();
      w.focus();
    }

    function initRunsLayoutExport() {
      var tab =
        document.getElementById("tab-runs") ||
        document.querySelector('[data-tab="runs"]') ||
        document.querySelector(".runs-root");

      if (!tab) {
        console.warn("SB_RUNS_LAYOUT_EXPORT_V3: không tìm thấy tab Runs.");
        return;
      }

      // Bỏ scroll nội bộ: bất kỳ div/section trong tab có overflow-y auto/scroll -> cho visible
      Array.from(tab.querySelectorAll("div,section")).forEach(function (el) {
        var st = window.getComputedStyle(el);
        if (st.overflowY === "auto" || st.overflowY === "scroll") {
          el.style.overflowY = "visible";
          el.style.maxHeight = "none";
          el.style.height = "auto";
        }
      });

      // Card full-width
      Array.from(tab.querySelectorAll(".card, .sb-card")).forEach(function (el) {
        el.style.width = "100%";
        el.style.margin = "0 auto";
        el.style.borderRadius = "24px";
        el.style.boxShadow = "0 18px 40px rgba(0,0,0,0.5)";
      });

      // Tìm table chính
      var table = tab.querySelector("table");
      if (!table) {
        console.warn("SB_RUNS_LAYOUT_EXPORT_V3: không thấy table trong tab runs.");
        return;
      }

      // Thanh Export (nếu chưa có)
      if (!tab.querySelector(".sb-runs-export-bar")) {
        var wrapper = table.parentElement || tab;
        var bar = document.createElement("div");
        bar.className = "sb-runs-export-bar";
        bar.style.display = "flex";
        bar.style.alignItems = "center";
        bar.style.justifyContent = "space-between";
        bar.style.marginBottom = "12px";

        bar.innerHTML = [
          '<div style="font-size:13px;opacity:0.85;">Export runs history</div>',
          '<div style="display:flex;gap:8px;">',
          '  <button type="button" data-fmt="csv">CSV</button>',
          '  <button type="button" data-fmt="html">HTML</button>',
          '  <button type="button" data-fmt="pdf">PDF</button>',
          "</div>"
        ].join("");

        if (wrapper.parentElement) {
          wrapper.parentElement.insertBefore(bar, wrapper);
        } else {
          tab.insertBefore(bar, wrapper);
        }

        // Styling nút nhanh bằng inline
        Array.from(bar.querySelectorAll("button[data-fmt]")).forEach(function (btn) {
          btn.style.fontSize = "12px";
          btn.style.padding = "6px 12px";
          btn.style.borderRadius = "999px";
          btn.style.border = "1px solid rgba(0,198,255,0.5)";
          btn.style.background = "rgba(0,0,0,0.25)";
          btn.style.cursor = "pointer";
          btn.addEventListener("mouseover", function () {
            btn.style.background = "rgba(0,198,255,0.2)";
          });
          btn.addEventListener("mouseout", function () {
            btn.style.background = "rgba(0,0,0,0.25)";
          });
          btn.addEventListener("click", function () {
            var fmt = btn.getAttribute("data-fmt");
            if (fmt === "csv") exportCSV(table);
            else if (fmt === "html") exportHTML(table);
            else if (fmt === "pdf") exportPDF(table);
          });
        });

        console.log("SB_RUNS_LAYOUT_EXPORT_V3: export bar initialized.");
      }
    }

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", initRunsLayoutExport);
    } else {
      initRunsLayoutExport();
    }
  })();
  </script>

</body></html>";
      var w = window.open("", "_blank");
      if (!w) return;
      w.document.open();
      w.document.write(html);
      w.document.close();
      w.focus();
      // User tự Ctrl+P -> Save as PDF
    }

    function initRunsExport() {
      var tab = document.getElementById("tab-runs");
      if (!tab) return;

      var table = tab.querySelector("table");
      if (!table) {
        console.warn("SB_RUNS_EXPORT_V2: không tìm thấy table trong #tab-runs");
        return;
      }

      var wrapper = table.parentElement || tab;
      var existingBar = tab.querySelector(".sb-runs-export-bar");
      if (existingBar) return;

      var bar = document.createElement("div");
      bar.className = "sb-runs-export-bar";
      bar.innerHTML = [
        '<div class="sb-runs-export-title">Export runs history</div>',
        '<div class="sb-runs-export-actions">',
        '  <button type="button" data-fmt="csv">CSV</button>',
        '  <button type="button" data-fmt="html">HTML</button>',
        '  <button type="button" data-fmt="pdf">PDF</button>',
        "</div>"
      ].join("");

      // chèn export bar ngay trên wrapper chứa table
      if (wrapper.parentElement) {
        wrapper.parentElement.insertBefore(bar, wrapper);
      } else {
        tab.insertBefore(bar, wrapper);
      }

      var buttons = bar.querySelectorAll("button[data-fmt]");
      buttons.forEach(function (btn) {
        btn.addEventListener("click", function () {
          var fmt = btn.getAttribute("data-fmt");
          if (fmt === "csv") exportCSV(table);
          else if (fmt === "html") exportHTML(table);
          else if (fmt === "pdf") exportPDF(table);
        });
      });

      console.log("SB_RUNS_EXPORT_V2: export bar initialized");
    }

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", initRunsExport);
    } else {
      initRunsExport();
    }
  })();
  </script>


  <script>
  // SB_RUNS_LAYOUT_EXPORT_V3
  (function () {
    function tableToData(table) {
      var rows = [];
      var head = table.querySelector("thead");
      if (head) {
        var headerCells = Array.from(head.querySelectorAll("th"));
        rows.push(headerCells.map(function (th) {
          return (th.innerText || "").trim();
        }));
      }
      var body = table.querySelector("tbody");
      if (body) {
        Array.from(body.querySelectorAll("tr")).forEach(function (tr) {
          var cells = Array.from(tr.querySelectorAll("td"));
          rows.push(cells.map(function (td) {
            return (td.innerText || "").trim();
          }));
        });
      }
      return rows;
    }

    function exportCSV(table) {
      var rows = tableToData(table);
      if (!rows.length) return;
      var csv = rows.map(function (r) {
        return r.map(function (cell) {
          var c = cell.replace(/"/g, '""');
          return '"' + c + '"';
        }).join(",");
      }).join("\n");
      var blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      var url = URL.createObjectURL(blob);
      var a = document.createElement("a");
      a.href = url;
      a.download = "security_bundle_runs.csv";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function exportHTML(table) {
      var html = "<html><head><meta charset=\"utf-8\"><title>SECURITY_BUNDLE Runs</title></head><body>" +
                 "<h2>History of SECURITY_BUNDLE runs</h2>" +
                 table.outerHTML +
                 "</body></html>";
      var blob = new Blob([html], { type: "text/html;charset=utf-8;" });
      var url = URL.createObjectURL(blob);
      var a = document.createElement("a");
      a.href = url;
      a.download = "security_bundle_runs.html";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function exportPDF(table) {
      var html = "<html><head><meta charset=\"utf-8\"><title>SECURITY_BUNDLE Runs PDF</title></head><body>" +
                 "<h2>History of SECURITY_BUNDLE runs</h2>" +
                 table.outerHTML +
                 "</body></html>";
      var w = window.open("", "_blank");
      if (!w) return;
      w.document.open();
      w.document.write(html);
      w.document.close();
      w.focus();
    }

    function initRunsLayoutExport() {
      var tab =
        document.getElementById("tab-runs") ||
        document.querySelector('[data-tab="runs"]') ||
        document.querySelector(".runs-root");

      if (!tab) {
        console.warn("SB_RUNS_LAYOUT_EXPORT_V3: không tìm thấy tab Runs.");
        return;
      }

      // Bỏ scroll nội bộ: bất kỳ div/section trong tab có overflow-y auto/scroll -> cho visible
      Array.from(tab.querySelectorAll("div,section")).forEach(function (el) {
        var st = window.getComputedStyle(el);
        if (st.overflowY === "auto" || st.overflowY === "scroll") {
          el.style.overflowY = "visible";
          el.style.maxHeight = "none";
          el.style.height = "auto";
        }
      });

      // Card full-width
      Array.from(tab.querySelectorAll(".card, .sb-card")).forEach(function (el) {
        el.style.width = "100%";
        el.style.margin = "0 auto";
        el.style.borderRadius = "24px";
        el.style.boxShadow = "0 18px 40px rgba(0,0,0,0.5)";
      });

      // Tìm table chính
      var table = tab.querySelector("table");
      if (!table) {
        console.warn("SB_RUNS_LAYOUT_EXPORT_V3: không thấy table trong tab runs.");
        return;
      }

      // Thanh Export (nếu chưa có)
      if (!tab.querySelector(".sb-runs-export-bar")) {
        var wrapper = table.parentElement || tab;
        var bar = document.createElement("div");
        bar.className = "sb-runs-export-bar";
        bar.style.display = "flex";
        bar.style.alignItems = "center";
        bar.style.justifyContent = "space-between";
        bar.style.marginBottom = "12px";

        bar.innerHTML = [
          '<div style="font-size:13px;opacity:0.85;">Export runs history</div>',
          '<div style="display:flex;gap:8px;">',
          '  <button type="button" data-fmt="csv">CSV</button>',
          '  <button type="button" data-fmt="html">HTML</button>',
          '  <button type="button" data-fmt="pdf">PDF</button>',
          "</div>"
        ].join("");

        if (wrapper.parentElement) {
          wrapper.parentElement.insertBefore(bar, wrapper);
        } else {
          tab.insertBefore(bar, wrapper);
        }

        // Styling nút nhanh bằng inline
        Array.from(bar.querySelectorAll("button[data-fmt]")).forEach(function (btn) {
          btn.style.fontSize = "12px";
          btn.style.padding = "6px 12px";
          btn.style.borderRadius = "999px";
          btn.style.border = "1px solid rgba(0,198,255,0.5)";
          btn.style.background = "rgba(0,0,0,0.25)";
          btn.style.cursor = "pointer";
          btn.addEventListener("mouseover", function () {
            btn.style.background = "rgba(0,198,255,0.2)";
          });
          btn.addEventListener("mouseout", function () {
            btn.style.background = "rgba(0,0,0,0.25)";
          });
          btn.addEventListener("click", function () {
            var fmt = btn.getAttribute("data-fmt");
            if (fmt === "csv") exportCSV(table);
            else if (fmt === "html") exportHTML(table);
            else if (fmt === "pdf") exportPDF(table);
          });
        });

        console.log("SB_RUNS_LAYOUT_EXPORT_V3: export bar initialized.");
      }
    }

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", initRunsLayoutExport);
    } else {
      initRunsLayoutExport();
    }
  })();
  </script>

</body>
</html>
