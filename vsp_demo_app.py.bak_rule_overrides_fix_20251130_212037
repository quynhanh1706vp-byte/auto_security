from __future__ import annotations
import json
from pathlib import Path
from typing import Optional, Any

from flask import (
    Flask,
    jsonify,
    send_from_directory,
    request,
    render_template,
)

# --------------------------------------------------------------------
# Cấu hình Flask: static + templates của my_flask_app
# --------------------------------------------------------------------
UI_ROOT = Path(__file__).resolve().parent          # .../SECURITY_BUNDLE/ui
ROOT = UI_ROOT.parent                              # .../SECURITY_BUNDLE

app = Flask(
    __name__,
    static_folder="my_flask_app/static",
    template_folder="my_flask_app/templates",
)

OUT = ROOT / "out"
RULES = ROOT / "rules" / "vsp_rule_overrides.json"


# --------------------------------------------------------------------
# Helpers
# --------------------------------------------------------------------
def _discover_run_dirs(limit: int = 50):
    if not OUT.exists():
        return []
    dirs = sorted(
        [p for p in OUT.iterdir() if p.is_dir() and p.name.startswith("RUN_")],
        key=lambda p: p.stat().st_mtime,
        reverse=True,
    )
    return dirs[:limit]


def _get_latest_run() -> Optional[Path]:
    runs = _discover_run_dirs(limit=50)
    if not runs:
        return None
    # Ưu tiên RUN có report/findings_unified.json và file không rỗng
    for r in runs:
        f = r / "report" / "findings_unified.json"
        if f.exists() and f.stat().st_size > 0:
            return r
    # fallback: run mới nhất bất kỳ
    return runs[0]


def _load_json(path: Path) -> Any:
    if not path.exists():
        return None
    try:
        return json.loads(path.read_text(encoding="utf-8"))
    except Exception:
        return None


# --------------------------------------------------------------------
# Routes UI
# --------------------------------------------------------------------
@app.route("/")
def home():
    return "<meta http-equiv='refresh' content='0;URL=/security_bundle'>"


@app.route("/security_bundle")
def ui_main():
    # index.html dùng Jinja, url_for('static', ...) hoạt động
    return render_template("index.html")


# --------------------------------------------------------------------
# TAB 1 — DASHBOARD
# --------------------------------------------------------------------
@app.route("/api/vsp/dashboard")
def api_dashboard():
    run_dir = _get_latest_run()
    if not run_dir:
        return jsonify({"error": "no_run"}), 404

    summ = _load_json(run_dir / "report" / "summary_unified.json")
    if not summ:
        return jsonify({"error": "no_summary"}), 404

    return jsonify({
        "run_id": run_dir.name,
        "meta": summ.get("meta", {}),
        "kpi": {
            "total_findings": summ.get("total_findings", 0),
            "severity": summ.get("severity", {}),
            "tool_counts": summ.get("tool_counts", {}),
            "security_score": summ.get("security_score", None),
            "top_risky_tool": summ.get("top_risky_tool"),
            "top_cwe": summ.get("top_cwe"),
            "top_module": summ.get("top_module"),
        },
    })


# --------------------------------------------------------------------
# TAB 2 — RUNS & REPORTS
# --------------------------------------------------------------------
@app.route("/api/vsp/runs_index")
def api_runs_index():
    runs = _discover_run_dirs(limit=50)
    out = []
    for r in runs:
        summ = _load_json(r / "report" / "summary_unified.json")
        if not summ:
            continue
        meta = summ.get("meta", {})
        out.append({
            "run_id": r.name,
            "ts": meta.get("ts"),
            "src_path": meta.get("src_path"),
            "profile": meta.get("profile"),
            "engine_mode": meta.get("engine_mode"),
            "total_findings": summ.get("total_findings"),
            "severity": summ.get("severity", {}),
            "tools": list(summ.get("tool_counts", {}).keys()),
            "report_html": f"/out/{r.name}/report/report.html",
            "report_pdf": f"/out/{r.name}/report/report.pdf",
            "sbom": f"/out/{r.name}/report/sbom_trivy.json",
            "license_report": f"/out/{r.name}/report/license_report.json",
        })
    return jsonify({"runs": out})


# --------------------------------------------------------------------
# TAB 3 — DATA SOURCE
# --------------------------------------------------------------------
@app.route("/api/vsp/datasource")
def api_datasource():
    """
    mode = dashboard  -> chỉ trả sample ~1000 dòng cho Dashboard (nhanh)
    mode = None       -> trả full (tối đa 60000) cho tab Data Source
    """
    mode = request.args.get("mode")
    rid = request.args.get("run_id")
    run_dir: Optional[Path] = None

    if rid:
        cand = OUT / rid
        if cand.exists():
            run_dir = cand

    if not run_dir:
        run_dir = _get_latest_run()
    if not run_dir:
        return jsonify({"error": "no_run"}), 404

    fpath = run_dir / "report" / "findings_unified.json"
    data = _load_json(fpath)
    if not data:
        return jsonify({"error": "no_data"}), 404

    # hỗ trợ 2 dạng: list[] hoặc {rows: []}
    rows = data if isinstance(data, list) else data.get("rows", [])
    total = len(rows)

    if mode == "dashboard":
        visible = rows[:1000]   # đủ cho top risk / noisy / by tool
    else:
        visible = rows[:60000]  # trần cứng cho Data Source

    return jsonify({
        "run_id": run_dir.name,
        "total_rows": total,
        "rows": visible,
    })


# --------------------------------------------------------------------
# TAB 4 — SETTINGS
# --------------------------------------------------------------------
@app.route("/api/vsp/settings")
def api_settings():
    run_dir = _get_latest_run()
    if not run_dir:
        return jsonify({"error": "no_run"}), 404

    summ = _load_json(run_dir / "report" / "summary_unified.json")
    if not summ:
        return jsonify({"error": "no_summary"}), 404

    meta = summ.get("meta", {})
    return jsonify({
        "profile_label": meta.get("profile"),
        "src_path": meta.get("src_path"),
        "engine_mode": meta.get("engine_mode"),
        "last_run_id": run_dir.name,
        "tools_enabled": list(summ.get("tool_counts", {}).keys()),
        "max_rows_ui": meta.get("max_rows_ui", 300),
        "default_export": meta.get("default_export", "HTML"),
    })


# --------------------------------------------------------------------
# TAB 5 — RULE OVERRIDES
# --------------------------------------------------------------------
@app.route("/api/vsp/rule_overrides")
def api_rule_overrides():
    if not RULES.exists():
        return jsonify({
            "rules": [],
            "note": "nguồn: rules/vsp_rule_overrides.json – hiện chưa có rule override",
        })

    data = _load_json(RULES)
    if not data:
        return jsonify({
            "rules": [],
            "note": "nguồn: rules/vsp_rule_overrides.json – file trống hoặc lỗi",
        })

    rules = data.get("overrides", data)
    return jsonify({"rules": rules})


# --------------------------------------------------------------------
# Serve OUT/ (report HTML/PDF/JSON…)
# --------------------------------------------------------------------
@app.route("/out/<path:sub>")
def serve_out(sub: str):
    return send_from_directory(str(OUT), sub)


# --------------------------------------------------------------------
if __name__ == "__main__":
    app.run(host="0.0.0.0", port=8910)


# ===== VSP extra API routes (runs_index, settings, rule_overrides) =====

from flask import jsonify  # dùng cho các API bên dưới
import json

def _vsp_read_summary(run_dir: Path):
    """
    Đọc summary_unified.json trong RUN_DIR, trả về dict hoặc None.
    """
    report = run_dir / "report" / "summary_unified.json"
    if not report.is_file():
        return None
    try:
        data = json.loads(report.read_text(encoding="utf-8"))
    except Exception:
        return None
    return data


@app.get("/api/vsp/runs_index")
def api_vsp_runs_index():
    """
    Trả về danh sách các run để tab 'Runs & Reports' hiển thị RUN HISTORY.
    Dựa trên _discover_run_dirs() + summary_unified.json trong từng RUN_DIR.
    """
    runs = []
    # Hàm _discover_run_dirs() và _get_latest_run() đã có sẵn trong file gốc.
    try:
        run_dirs = _discover_run_dirs(limit=50)
    except Exception:
        run_dirs = []

    for run_dir in run_dirs:
        data = _vsp_read_summary(run_dir)
        if not data:
            # vẫn cho hiện row basic nếu thiếu summary
            runs.append({
                "run_id": run_dir.name,
                "ts": "-",
                "profile": "-",
                "src_path": "-",
                "total": 0,
                "crit": 0,
                "high": 0,
                "med": 0,
                "low": 0,
                "info": 0,
                "trace": 0,
                "tools": [],
            })
            continue

        sev = (
            data.get("severity_stats")
            or data.get("severity_counts")
            or {}
        )
        tools = data.get("tools") or data.get("tool_stats") or {}
        runs.append({
            "run_id": data.get("run_id") or run_dir.name,
            "ts": data.get("ts") or data.get("timestamp") or "-",
            "profile": data.get("profile") or data.get("scan_profile") or "-",
            "src_path": data.get("src_path") or data.get("source_path") or "-",
            "total": data.get("total_findings") or data.get("total") or 0,
            "crit": sev.get("CRITICAL", 0),
            "high": sev.get("HIGH", 0),
            "med": sev.get("MEDIUM", 0),
            "low": sev.get("LOW", 0),
            "info": sev.get("INFO", 0),
            "trace": sev.get("TRACE", 0),
            "tools": sorted(tools.keys()),
        })

    return jsonify({"runs": runs})


@app.get("/api/vsp/settings")
def api_vsp_settings():
    """
    Trả về thông tin cấu hình cơ bản cho tab Settings.
    Lấy thông tin SRC_PATH, LAST_RUN, TOTAL_FINDINGS từ run mới nhất (nếu có).
    """
    latest = None
    try:
        latest = _get_latest_run()
    except Exception:
        latest = None

    src_path = "-"
    total = 0
    if latest:
        data = _vsp_read_summary(latest)
        if data:
            src_path = data.get("src_path") or data.get("source_path") or "-"
            total = data.get("total_findings") or data.get("total") or 0

    payload = {
        "profile": "EXT+ (Enterprise Security Profile)",
        "engine_mode": "offline",
        "src_path": src_path,
        "last_run": latest.name if latest else None,
        "total_findings": total,
    }
    return jsonify(payload)


@app.get("/api/vsp/rule_overrides")
def api_vsp_rule_overrides():
    """
    Đọc rules/vsp_rule_overrides.json (nếu có) cho tab Rule Overrides.
    """
    root = Path(__file__).resolve().parent.parent
    rule_file = root / "rules" / "vsp_rule_overrides.json"
    rules = []

    if rule_file.is_file():
        try:
            data = json.loads(rule_file.read_text(encoding="utf-8"))
            # chấp nhận cả dạng list hoặc dict có key 'rules'
            if isinstance(data, dict):
                rules = data.get("rules") or []
            elif isinstance(data, list):
                rules = data
        except Exception:
            rules = []

    return jsonify({"rules": rules})

# ==== VSP SETTINGS & RULE OVERRIDES API (simple snapshot) ====
from pathlib import Path
from typing import Optional
import json

BASE_DIR = Path(__file__).resolve().parent.parent


def _vsp_latest_run_dir() -> Optional[Path]:
    out_dir = BASE_DIR / "out"
    if not out_dir.is_dir():
        return None
    runs = sorted(
        [p for p in out_dir.glob("RUN_VSP_*") if p.is_dir()],
        key=lambda p: p.name,
    )
    return runs[-1] if runs else None


@app.get("/api/vsp/settings")
def api_vsp_settings():
    """
    Simple snapshot cho tab Settings:
      - profile
      - source_path
      - engine_mode
      - last_run_id
      - tool_stack (danh sách tool đang bật)
    """
    run_dir = _vsp_latest_run_dir()
    last_run_id = run_dir.name if run_dir is not None else "-"

    # tạm thời hard-code, sau này mình có thể đọc từ config thật
    profile = "EXT+ / Multi-tool offline"
    engine_mode = "FULL_EXT"
    source_path = str((BASE_DIR / "khach6").resolve()) if (BASE_DIR / "khach6").exists() else "-"

    tool_stack = [
        {"tool": "gitleaks",  "category": "Secrets",      "enabled": True},
        {"tool": "semgrep",   "category": "SAST",         "enabled": True},
        {"tool": "kics",      "category": "IaC / Config", "enabled": True},
        {"tool": "bandit",    "category": "Python SAST",  "enabled": True},
        {"tool": "trivy_fs",  "category": "FS Scan",      "enabled": True},
        {"tool": "grype",     "category": "Vuln Scanner", "enabled": True},
        {"tool": "syft",      "category": "SBOM",         "enabled": True},
        {"tool": "codeql",    "category": "CodeQL SAST",  "enabled": True},
    ]

    payload = {
        "profile": profile,
        "source_path": source_path,
        "engine_mode": engine_mode,
        "last_run_id": last_run_id,
        "tool_stack": tool_stack,
    }
    return jsonify(payload)


@app.get("/api/vsp/rule_overrides")
def api_vsp_rule_overrides():
    """
    Đọc file rules/vsp_rule_overrides.json (nếu có)
    để feed cho tab Rule Overrides.
    """
    rules_file = BASE_DIR / "rules" / "vsp_rule_overrides.json"
    rows = []

    if rules_file.is_file():
        try:
            raw = json.loads(rules_file.read_text(encoding="utf-8"))
            if isinstance(raw, list):
                for idx, r in enumerate(raw, start=1):
                    rows.append(
                        {
                            "index": idx,
                            "tool": r.get("tool", "-"),
                            "rule_id": r.get("rule_id", "-"),
                            "match": r.get("match", "-"),
                            "action": r.get("action", "-"),
                            "note": r.get("note", "-"),
                        }
                    )
        except Exception as exc:  # chỉ log ra server, UI vẫn chạy
            print("[VSP] Error reading vsp_rule_overrides.json:", exc)

    payload = {
        "source": "rules/vsp_rule_overrides.json",
        "rows": rows,
    }
    return jsonify(payload)

