<!DOCTYPE html>
<html lang="en">
<head>

<!-- VSP_P1_EARLY_CONSOLE_FILTER_V3 -->
<script id="VSP_P1_EARLY_CONSOLE_FILTER_V3">
(()=> {
  if (window.__vsp_p1_early_console_filter_v3) return;
  window.__vsp_p1_early_console_filter_v3 = true;

  // drop ONLY our noisy diagnostics (keep real errors)
  const DROP_ANY = [
    /\[VSP\]\[P1\]\s*(fetch wrapper enabled|runs-fail banner auto-clear enabled|fetch limit patched|nav dedupe applied|rule overrides metrics\/table synced)/i,
    /\[VSP\]\[P1\]\s*(cleared stale RUNS API FAIL banner)/i,
    /\[VSP\]\[DASH\].*(check ids|ids=)/i,
    /\bgave up\b.*\(chart\/container missing\)/i,
    /\bchart\/container missing\b/i,
    /\bcanvas-rendered\b/i,
    /\bChartJs\s*=\s*false\b/i
  ];

  function s0(args){
    try{
      if (!args || !args.length) return "";
      if (typeof args[0] === "string") return args[0];
      return String(args[0] ?? "");
    }catch(_){ return ""; }
  }
  function shouldDrop(args){
    const t = s0(args);
    return DROP_ANY.some(rx => rx.test(t));
  }

  const wrap = (k) => {
    const orig = console[k] ? console[k].bind(console) : null;
    if (!orig) return;
    console[k] = (...a) => shouldDrop(a) ? void 0 : orig(...a);
  };

  ["log","info","warn","error","debug"].forEach(wrap);
})();
</script>



<!-- VSP_P1_EARLY_CONSOLE_FILTER_V3 -->
<script id="VSP_P1_EARLY_CONSOLE_FILTER_V3">
(()=> {
  if (window.__vsp_p1_early_console_filter_v3) return;
  window.__vsp_p1_early_console_filter_v3 = true;

  // drop ONLY our noisy diagnostics (keep real errors)
  const DROP_ANY = [
    /\[VSP\]\[P1\]\s*(fetch wrapper enabled|runs-fail banner auto-clear enabled|fetch limit patched|nav dedupe applied|rule overrides metrics\/table synced)/i,
    /\[VSP\]\[P1\]\s*(cleared stale RUNS API FAIL banner)/i,
    /\[VSP\]\[DASH\].*(check ids|ids=)/i,
    /\bgave up\b.*\(chart\/container missing\)/i,
    /\bchart\/container missing\b/i,
    /\bcanvas-rendered\b/i,
    /\bChartJs\s*=\s*false\b/i
  ];

  function s0(args){
    try{
      if (!args || !args.length) return "";
      if (typeof args[0] === "string") return args[0];
      return String(args[0] ?? "");
    }catch(_){ return ""; }
  }
  function shouldDrop(args){
    const t = s0(args);
    return DROP_ANY.some(rx => rx.test(t));
  }

  const wrap = (k) => {
    const orig = console[k] ? console[k].bind(console) : null;
    if (!orig) return;
    console[k] = (...a) => shouldDrop(a) ? void 0 : orig(...a);
  };

  ["log","info","warn","error","debug"].forEach(wrap);
})();
</script>

<!-- VSP_UI_DARK_CSS_P1_2_INJECT -->
  <link rel=\"stylesheet\" href="/static/css/vsp_dark_commercial_p1_2.css?v=1766111363\">
<meta charset="UTF-8">
  <title>VersaSecure Platform – VSP 2025 Enterprise V2</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Font Inter -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --vsp-bg: #050814;
      --vsp-surface: #0b1020;
      --vsp-surface-soft: #131832;
      --vsp-border-subtle: rgba(255, 255, 255, 0.06);
      --vsp-border-strong: rgba(255, 255, 255, 0.18);
      --vsp-text-main: #E5E7EB;
      --vsp-text-muted: #9CA3AF;
      --vsp-accent: #38bdf8;
      --vsp-critical: #f97373;
      --vsp-high: #fb923c;
      --vsp-medium: #facc15;
      --vsp-low: #22c55e;
      --vsp-info: #38bdf8;
      --vsp-trace: #64748b;
      --vsp-gate-green: #22c55e;
      --vsp-gate-amber: #facc15;
      --vsp-gate-red: #f97373;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 0;
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: radial-gradient(circle at top left, #111827 0, #020617 60%);
      color: var(--vsp-text-main);
      min-height: 100vh;
    }

    .vsp-app {
      max-width: 1440px;
      margin: 0 auto;
      padding: 24px 20px 40px;
    }

    .vsp-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }

    .vsp-title {
      font-size: 22px;
      font-weight: 600;
      letter-spacing: 0.02em;
    }

    .vsp-subtitle {
      font-size: 13px;
      color: var(--vsp-text-muted);
      margin-top: 4px;
    }

    .vsp-env-badge {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--vsp-border-subtle);
      background: linear-gradient(to right, #020617, #020617);
      font-size: 11px;
      color: var(--vsp-text-muted);
    }

    .vsp-tabs {
      display: inline-flex;
      gap: 8px;
      padding: 4px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid var(--vsp-border-subtle);
      margin-bottom: 20px;
    }

    .vsp-tab-btn {
      border: none;
      background: transparent;
      color: var(--vsp-text-muted);
      padding: 8px 12px;
      border-radius: 999px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .vsp-tab-btn:hover {
      color: #f9fafb;
      background: rgba(148, 163, 184, 0.18);
    }

    .vsp-tab-btn.active {
      color: #f9fafb;
      background: linear-gradient(135deg, #0ea5e9, #6366f1);
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.35);
    }

    .vsp-main {
      margin-top: 8px;
    }

    .vsp-pane {
      display: none;
      gap: 16px;
      flex-direction: column;
    }

    .vsp-pane.active {
      display: flex;
    }

    .vsp-kpi-grid {
      display: grid;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      gap: 12px;
      margin-bottom: 6px;
    }

    .vsp-card {
      background: linear-gradient(145deg, #020617, #020617);
      border-radius: 16px;
      border: 1px solid var(--vsp-border-subtle);
      padding: 14px 14px 12px;
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.75);
    }

    .vsp-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .vsp-card-title {
      font-size: 12px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--vsp-text-muted);
    }

    .vsp-card-meta {
      font-size: 11px;
      color: var(--vsp-text-muted);
    }

    .vsp-kpi-value {
      font-size: 22px;
      font-weight: 600;
    }

    .vsp-kpi-sub {
      margin-top: 2px;
      font-size: 11px;
      color: var(--vsp-text-muted);
    }

    .vsp-kpi-score {
      font-size: 22px;
      font-weight: 600;
    }

    .vsp-kpi-score.badge-green { color: var(--vsp-gate-green); }
    .vsp-kpi-score.badge-amber { color: var(--vsp-gate-amber); }
    .vsp-kpi-score.badge-red { color: var(--vsp-gate-red); }

    .vsp-gate-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 500;
    }
    .vsp-gate-green {
      background: rgba(34, 197, 94, 0.12);
      color: var(--vsp-gate-green);
      border: 1px solid rgba(34, 197, 94, 0.35);
    }
    .vsp-gate-amber {
      background: rgba(250, 204, 21, 0.12);
      color: var(--vsp-gate-amber);
      border: 1px solid rgba(250, 204, 21, 0.35);
    }
    .vsp-gate-red {
      background: rgba(248, 113, 113, 0.12);
      color: var(--vsp-gate-red);
      border: 1px solid rgba(248, 113, 113, 0.35);
    }

    .vsp-charts-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.3fr) minmax(0, 2fr);
      gap: 12px;
      margin-top: 4px;
    }

    .vsp-card-body {
      font-size: 12px;
      color: var(--vsp-text-muted);
    }

    .vsp-chart-placeholder {
      height: 220px;
      border-radius: 12px;
      border: 1px dashed rgba(148, 163, 184, 0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      color: var(--vsp-text-muted);
    }

    .vsp-split-grid-4 {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 12px;
      margin-top: 12px;
    }

    .vsp-table-wrapper {
      border-radius: 12px;
      border: 1px solid var(--vsp-border-subtle);
      overflow: hidden;
      background: linear-gradient(145deg, #020617, #020617);
    }

    table.vsp-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    table.vsp-table thead {
      background: rgba(15, 23, 42, 0.98);
    }

    table.vsp-table th,
    table.vsp-table td {
      padding: 8px 10px;
      border-bottom: 1px solid rgba(15, 23, 42, 0.9);
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
    }

    table.vsp-table th {
      font-weight: 500;
      color: var(--vsp-text-muted);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    table.vsp-table tbody tr:nth-child(even) {
      background: rgba(15, 23, 42, 0.8);
    }

    .vsp-sev-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 56px;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 500;
    }
    .sev-critical { background: rgba(248, 113, 113, 0.15); color: #fecaca; }
    .sev-high     { background: rgba(249, 115, 22, 0.18); color: #fed7aa; }
    .sev-medium   { background: rgba(234, 179, 8, 0.18);  color: #fef3c7; }
    .sev-low      { background: rgba(34, 197, 94, 0.18);  color: #bbf7d0; }
    .sev-info     { background: rgba(56, 189, 248, 0.18); color: #bae6fd; }
    .sev-trace    { background: rgba(148, 163, 184, 0.18);color: #e5e7eb; }

    .vsp-filters {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 10px;
      align-items: flex-end;
    }
    .vsp-field {
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-width: 140px;
    }
    .vsp-field label {
      font-size: 11px;
      color: var(--vsp-text-muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }
    .vsp-input,
    .vsp-select {
      border-radius: 999px;
      border: 1px solid var(--vsp-border-subtle);
      background: rgba(15, 23, 42, 0.9);
      color: var(--vsp-text-main);
      padding: 6px 10px;
      font-size: 12px;
    }

    .vsp-btn {
      border-radius: 999px;
      border: 1px solid rgba(56, 189, 248, 0.6);
      background: linear-gradient(135deg, #0ea5e9, #6366f1);
      color: #f9fafb;
      font-size: 12px;
      font-weight: 500;
      padding: 6px 14px;
      cursor: pointer;
      box-shadow: 0 12px 30px rgba(37, 99, 235, 0.35);
    }
    .vsp-btn-secondary {
      border-radius: 999px;
      border: 1px solid var(--vsp-border-subtle);
      background: rgba(15, 23, 42, 0.9);
      color: var(--vsp-text-muted);
      font-size: 12px;
      padding: 6px 12px;
      cursor: pointer;
    }

    .vsp-section-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .vsp-section-subtitle {
      font-size: 12px;
      color: var(--vsp-text-muted);
    }

    .vsp-layout-2col {
      display: grid;
      grid-template-columns: minmax(0, 2.3fr) minmax(0, 1.2fr);
      gap: 16px;
    }

    .vsp-mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    .vsp-tag {
      border-radius: 999px;
      border: 1px solid var(--vsp-border-subtle);
      padding: 2px 7px;
      font-size: 11px;
      color: var(--vsp-text-muted);
    }
  </style>

<script>/*VSP_CONSOLE_FILTER_DRILLDOWN_P0_V1*/
(function(){
  try{
    if (window.__VSP_CONSOLE_FILTER_DD_P0) return;
    window.__VSP_CONSOLE_FILTER_DD_P0 = 1;

    var needle = "drilldown real impl accepted";

    function wrap(k){
      try{
        var orig = console[k];
        if (typeof orig !== "function") return;
        console[k] = function(){
          try{
            var a0 = (arguments && arguments.length) ? String(arguments[0]) : "";
            if (a0 && a0.indexOf(needle) !== -1){
              if (window.__VSP_DD_ACCEPTED_ONCE) return;
              window.__VSP_DD_ACCEPTED_ONCE = 1;
            }
          }catch(_e){}
          return orig.apply(this, arguments);
        };
      }catch(_){}
    }

    ["log","info","debug","warn"].forEach(wrap);
  }catch(_){}
})();
</script>

<!-- VSP_GLOBAL_POLL_GUARD_P1_V1 -->
<script>
(function(){
  if (window.__VSP_GLOBAL_POLL_GUARD) return;
  window.__VSP_GLOBAL_POLL_GUARD = true;

  const nativeFetch = (globalThis.fetch ? globalThis.fetch.bind(globalThis) : null);

  const MIN = {
    runs: 12000,
    dash: 15000
  };
  const st = {
    last: Object.create(null),
    cache: Object.create(null),
    inflight: Object.create(null),
    backoffMs: 2000,
    nextTryAt: 0,
    lastWarnAt: 0
  };

  function now(){ return Date.now(); }
  function baseKey(u){ try{ return u.toString().split('?')[0]; }catch(e){ return ""; } }
  function urlStr(input){ try{ if (typeof input==="string") return input; if (input && input.url) return input.url; }catch(e){} return ""; }

  function shouldGuard(url){
    const s = (url||"").toString();
    if (!s.includes("/api/vsp/")) return false;

    // never guard downloads/exports/sha/file
    if (s.includes("/api/vsp/run_file")) return false;
    if (s.includes("/api/vsp/run_file2")) return false;
    if (s.includes("/api/vsp/export_")) return false;
    if (s.includes("/api/vsp/sha256")) return false;

    if (s.includes("/api/vsp/runs")) return true;
    if (s.includes("/api/vsp/dashboard")) return true; // includes dashboard_commercial_v2
    return false;
  }

  function minInterval(key){
    if (key.includes("/api/vsp/runs")) return MIN.runs;
    if (key.includes("/api/vsp/dashboard")) return MIN.dash;
    return 0;
  }

    // VSP_P0_MKJSONRESPONSE_DEFAULT200_V1
    
/* VSP_P0_MKJSONRESPONSE_RESPONSE_V1 */
function mkJsonResponse(obj, httpStatus, forceOk){
  try{
    const st = (typeof httpStatus === "number") ? httpStatus : 200;
    const ok = (forceOk === undefined) ? true : !!forceOk;

    if (obj && typeof obj === "object"){
      if (obj.ok === undefined) obj.ok = ok;
      if (obj._orig_status === undefined) obj._orig_status = st;
      if (obj._degraded === undefined) obj._degraded = (st >= 400) ? true : false;
    }

    const headers = new Headers({
      "Content-Type":"application/json; charset=utf-8",
      "Cache-Control":"no-store",
      "X-VSP-Degraded": (st >= 400) ? "1" : "0",
      "X-VSP-Fix": "mkJsonResponse_response_v1"
    });

    // Always 200 to prevent UI flicker; carry original status in obj._orig_status
    return new Response(JSON.stringify(obj || {ok:true,_degraded:false}), { status: 200, headers });
  }catch(e){
    return new Response(JSON.stringify({ok:true,_degraded:true,note:"mkJsonResponse-exception"}), {status:200, headers:{"Content-Type":"application/json"}});
  }
}

});
      } catch(e) {
        // response-like fallback (keep status 200 by default)
        return { ok: !!(obj && obj.ok), status: st, json: async()=>obj };
      }
    } else {
        obj = {ok:true,_degraded:true,_degraded_reason:"poll_guard_cached"};
      }
      return new Response(JSON.stringify(obj), {
        status: 200,
        headers: {
          "Content-Type":"application/json",
          "X-VSP-CACHED":"1",
          "X-VSP-ALWAYS200":"1"
        }
      });
    }catch(e){
      return new Response(JSON.stringify({ok:true,_degraded:true,_degraded_reason:"poll_guard_cached"}), {
        status: 200,
        headers: {
          "Content-Type":"application/json",
          "X-VSP-CACHED":"1",
          "X-VSP-ALWAYS200":"1"
        }
      });
    }
  }
      });
    } catch(e) {
      return mkJsonResponse(obj, 503, true);
    }
  }

  async function guardedFetch(input, init){
    if (!nativeFetch) return mkJsonResponse({ok:false,error:"NO_FETCH"});
    const u = urlStr(input);
    if (!u || !shouldGuard(u)) return nativeFetch(input, init);

    const k = baseKey(u);
    const t = now();
    const min = minInterval(k);

    // If tab is hidden -> do NOT spam network; serve cache if any
    if (document && document.hidden) {
      if (st.cache[k]) return new Response(st.cache[k], { status:200, headers:{"Content-Type":"application/json","X-VSP-CACHED":"1"} });
      return mkJsonResponse({ok:false, who:"VSP_POLL_GUARD", error:"HIDDEN"});
    }

    // global backoff window (after failures)
    if (t < st.nextTryAt) {
      if (st.cache[k]) return new Response(st.cache[k], { status:200, headers:{"Content-Type":"application/json","X-VSP-CACHED":"1"} });
      return mkJsonResponse({ok:false, who:"VSP_POLL_GUARD", error:"BACKOFF"});
    }

    const last = st.last[k] || 0;

    // throttle: if too soon -> serve cache, NO network
    if ((t - last) < min && st.cache[k]) {
      return new Response(st.cache[k], { status:200, headers:{"Content-Type":"application/json","X-VSP-CACHED":"1"} });
    }

    // inflight: serve cache, NO network
    if (st.inflight[k]) {
      if (st.cache[k]) return new Response(st.cache[k], { status:200, headers:{"Content-Type":"application/json","X-VSP-CACHED":"1"} });
      return mkJsonResponse({ok:false, who:"VSP_POLL_GUARD", error:"INFLIGHT"});
    }

    st.inflight[k] = true;

    const ctrl = new AbortController();
    const timer = setTimeout(()=>ctrl.abort(), 8000);

    try {
      const _init = Object.assign({}, init||{});
      _init.signal = ctrl.signal;
      _init.cache = "no-store";
      const r = await nativeFetch(input, _init);

      st.last[k] = t;
      if (r && r.ok) {
        try {
          const txt = await r.clone().text();
          if (txt && txt.length < 5_000_000) st.cache[k] = txt;
        } catch(e){}
        // reset backoff after success
        st.backoffMs = 2000;
        st.nextTryAt = 0;
      }
      return r;
    } catch(e) {
      const t2 = now();
      if (t2 - st.lastWarnAt > 5000) {
        console.warn("[VSP] poll down; backoff", st.backoffMs, "ms");
        st.lastWarnAt = t2;
      }
      st.nextTryAt = t2 + st.backoffMs;
      st.backoffMs = Math.min(st.backoffMs * 2, 60000);
      if (st.cache[k]) return new Response(st.cache[k], { status:200, headers:{"Content-Type":"application/json","X-VSP-CACHED":"1"} });
      return mkJsonResponse({ok:false, who:"VSP_POLL_GUARD", error:"FETCH_FAILED"});
    } finally {
      clearTimeout(timer);
      st.inflight[k] = false;
    }
  }

  // override as early as possible
  globalThis.fetch = guardedFetch;
  window.fetch = guardedFetch;

  // guard XHR too (best effort)
  try {
    const _open = XMLHttpRequest.prototype.open;
    const _send = XMLHttpRequest.prototype.send;
    XMLHttpRequest.prototype.open = function(method, url){
      try { this.__vsp_url = url; } catch(e) {}
      return _open.apply(this, arguments);
    };
    XMLHttpRequest.prototype.send = function(){
      try {
        const u = (this.__vsp_url || "");
        if (shouldGuard(u)) {
          const k = baseKey(u);
          const t = now();
          const min = minInterval(k);
          const last = st.last[k] || 0;
          if (document && document.hidden) { try{ this.abort(); }catch(e){}; return; }
          if (t < st.nextTryAt) { try{ this.abort(); }catch(e){}; return; }
          if ((t-last) < min) { try{ this.abort(); }catch(e){}; return; }
          if (st.inflight[k]) { try{ this.abort(); }catch(e){}; return; }
        }
      } catch(e) {}
      return _send.apply(this, arguments);
    };
  } catch(e) {}
})();
</script>
<!-- /VSP_GLOBAL_POLL_GUARD_P1_V1 -->


<!-- VSP_THEME_OVERRIDE_P1_V1 -->
<link rel="stylesheet" href="/static/css/vsp_theme_override_p1_v1.css?v=20251219_182445">

<link rel="stylesheet" href="/static/css/vsp_theme_override_p1_v2.css?v=20251219_184002">

<!-- VSP_P0_RUNS_FLICKER_DEFINITIVE_V1 -->
</head>
<body>
<!-- VSP_P1_NAV5_UNIFY_V1 -->
<div id="vspNav5" style="position:sticky;top:0;z-index:9999;background:rgba(10,14,20,.92);backdrop-filter: blur(6px);
  border-bottom:1px solid rgba(255,255,255,.08);padding:10px 12px;display:flex;gap:10px;align-items:center;">
  <div style="font-weight:900;letter-spacing:.4px;color:#cfe0ff;">VSP</div>

  <a class="pill" href="/" style="text-decoration:none;padding:8px 10px;border-radius:12px;
     background:rgba(255,255,255,.06);color:#dbe7ff;font-weight:700;">Dashboard</a>

  <a class="pill" href="/vsp5" style="text-decoration:none;padding:8px 10px;border-radius:12px;
     background:rgba(255,255,255,.06);color:#dbe7ff;font-weight:700;">Runs &amp; Reports</a>

  <a class="pill" href="/data_source" style="text-decoration:none;padding:8px 10px;border-radius:12px;
     background:rgba(255,255,255,.06);color:#dbe7ff;font-weight:700;">Data Source</a>

  <a class="pill" href="/settings" style="text-decoration:none;padding:8px 10px;border-radius:12px;
     background:rgba(255,255,255,.06);color:#dbe7ff;font-weight:700;">Settings</a>

  <a class="pill" href="/rule_overrides" style="text-decoration:none;padding:8px 10px;border-radius:12px;
     background:rgba(255,255,255,.06);color:#dbe7ff;font-weight:700;">Rule Overrides</a>

  <div style="margin-left:auto;opacity:.85;font-size:12px;color:#9bb2d9;">
    P1 UI • nav unified
  </div>
</div>


<!-- VSP_UI_TOPBAR_QUICKACTIONS_P8_V4 BEGIN -->
<style id="vspTopbarCssP8v4">
  #vspTopbarP8v4{
    position:fixed; top:0; left:0; right:0; height:52px;
    display:flex; align-items:center; justify-content:space-between;
    padding:0 14px; z-index:99999;
    background:rgba(10,14,24,.92);
    border-bottom:1px solid rgba(255,255,255,.08);
    backdrop-filter: blur(8px);
  }
  #vspTopbarP8v4 .l{display:flex; gap:10px; align-items:center; min-width:260px;}
  #vspTopbarP8v4 .r{display:flex; gap:8px; align-items:center;}
  #vspTopbarP8v4 .brand{font-weight:700; letter-spacing:.3px; font-size:14px; color:#e8eefc;}
  #vspTopbarP8v4 .chip{
    font-size:12px; padding:4px 8px; border-radius:999px;
    border:1px solid rgba(255,255,255,.10);
    color:rgba(232,238,252,.92);
    background:rgba(255,255,255,.04);
    white-space:nowrap;
  }
  #vspTopbarP8v4 .btn{
    font-size:12px; padding:7px 10px; border-radius:10px;
    border:1px solid rgba(255,255,255,.12);
    background:rgba(255,255,255,.06);
    color:#eef3ff; cursor:pointer;
  }
  #vspTopbarP8v4 .btn:hover{ background:rgba(255,255,255,.10); }
  body{ padding-top:52px !important; }
</style>

<div id="vspTopbarP8v4">
  <div class="l">
    <div class="brand">VersaSecure Platform — Commercial</div>
    <div class="chip" id="vspChipIsoP8v4">ISO 27001-ready</div>
    <div class="chip" id="vspChipToolsP8v4">8 tools</div>
    <div class="chip" id="vspChipDegradedP8v4">DEGRADED: …</div>
  </div>
  <div class="r">
    <button class="btn" id="vspBtnRefreshP8v4">Refresh</button>
    <button class="btn" id="vspBtnOpenHtmlP8v4">Open HTML</button>
    <button class="btn" id="vspBtnExportTgzP8v4">Export TGZ</button>
    <button class="btn" id="vspBtnVerifyShaP8v4">Verify SHA</button>
  </div>
</div>

<script id="vspTopbarJsP8v4">
(function(){
  if (window.__VSP_UI_TOPBAR_QUICKACTIONS_P8_V4) return;
  window.__VSP_UI_TOPBAR_QUICKACTIONS_P8_V4 = true;

  function norm(s){ return (s||"").replace(/\s+/g," ").trim().toLowerCase(); }
  function clickBtnContains(part){
    const want = norm(part);
    const btns = Array.from(document.querySelectorAll("button,a"));
    for (const b of btns){
      const t = norm(b.innerText || b.textContent || "");
      if (!t) continue;
      if (t.includes(want)){ b.click(); return true; }
    }
    return false;
  }
  const $ = (id)=>document.getElementById(id);

  $("vspBtnRefreshP8v4").onclick = function(){
    if (clickBtnContains("refresh")) return;
    location.reload();
  };
  $("vspBtnOpenHtmlP8v4").onclick = function(){
    if (clickBtnContains("open html")) return;
    alert("Open HTML button not found on this tab. Try Runs & Reports, then retry.");
  };
  $("vspBtnExportTgzP8v4").onclick = function(){
    if (clickBtnContains("export tgz")) return;
    alert("Export TGZ button not found on this tab. Try Runs & Reports, then retry.");
  };
  $("vspBtnVerifyShaP8v4").onclick = function(){
    if (clickBtnContains("verify sha")) return;
    alert("Verify SHA button not found on this tab. Try Runs & Reports, then retry.");
  };

  function safeGet(id){ try { return document.getElementById(id); } catch(_){ return null; } }
  function safeSetText(id, txt){
    const el = safeGet(id);
    if (el) el.textContent = txt;
  }
  function ensureTopbar(){
    // if topbar got wiped by SPA re-render, do nothing (avoid errors); we only silence console
    return !!safeGet("vspTopbarP8v4");
  }
  function updateDegraded(){
    if (!ensureTopbar()) return;
    fetch("/api/vsp/dashboard_commercial_v2?ts=" + Date.now())
      .then(r=>r.json())
      .then(j=>{
        const yes = !!(((j||{}).overall||{}).degraded_yes);
        safeSetText("vspChipDegradedP8v4", "DEGRADED: " + (yes ? "YES" : "NO"));
      })
      .catch(()=>{
        safeSetText("vspChipDegradedP8v4", "DEGRADED: N/A");
      });
  }
  updateDegraded();
  setInterval(updateDegraded, 15000);

})();
</script>
<!-- VSP_UI_TOPBAR_NULLSAFE_P8_V4H1 -->

<!-- VSP_UI_TOPBAR_QUICKACTIONS_P8_V4 END -->


  <div class="vsp-app">
    <header class="vsp-header">
      <div>
        <div class="vsp-title">VersaSecure Platform – SECURITY_BUNDLE</div>
        <div class="vsp-subtitle">
          CIO-level view – FULL_EXT / Unified security posture / CI/CD Gates
        </div>
      </div>
      <div class="vsp-env-badge">
        ENV: STAGING • RUN: <span id="vsp-header-run-id">RUN_VSP_FULL_EXT_20251208_142917</span>
      </div>
    </header>

    <nav class="vsp-tabs" id="vsp-tabs">
      <button class="vsp-tab-btn active" data-tab="dashboard">Dashboard</button>
      <button class="vsp-tab-btn" data-tab="runs">Runs &amp; Reports</button>
      <button class="vsp-tab-btn" data-tab="datasource">Data Source</button>
      <button class="vsp-tab-btn" data-tab="settings">Settings</button>
      <button class="vsp-tab-btn" data-tab="rules">Rule Overrides</button>
    </nav>

    <main class="vsp-main">
      <!-- TAB 1: DASHBOARD -->
      <section class="vsp-pane active" id="vsp-dashboard-main">
        <div class="vsp-kpi-grid">
          <!-- total -->
          <div class="vsp-card">
            <div class="vsp-card-header">
              <div class="vsp-card-title">Total Findings</div>
            </div>
            <div class="vsp-kpi-value" id="vsp-kpi-total-findings">15,189</div>
            <div class="vsp-kpi-sub">Tổng số phát hiện trong lần scan FULL_EXT mới nhất</div>
          </div>

          <!-- 5 severity -->
          <div class="vsp-card">
            <div class="vsp-card-header">
              <div class="vsp-card-title">Critical</div>
            </div>
            <div class="vsp-kpi-value" id="vsp-kpi-critical">30</div>
            <div class="vsp-kpi-sub">Phát hiện mức CRITICAL</div>
          </div>

          <div class="vsp-card">
            <div class="vsp-card-header">
              <div class="vsp-card-title">High</div>
            </div>
            <div class="vsp-kpi-value" id="vsp-kpi-high">3,405</div>
            <div class="vsp-kpi-sub">Phát hiện mức HIGH</div>
          </div>

          <div class="vsp-card">
            <div class="vsp-card-header">
              <div class="vsp-card-title">Medium</div>
            </div>
            <div class="vsp-kpi-value" id="vsp-kpi-medium">1,501</div>
            <div class="vsp-kpi-sub">Phát hiện mức MEDIUM</div>
          </div>

          <div class="vsp-card">
            <div class="vsp-card-header">
              <div class="vsp-card-title">Low</div>
            </div>
            <div class="vsp-kpi-value" id="vsp-kpi-low">1,330</div>
            <div class="vsp-kpi-sub">LOW + Info/Trace xem thêm ở chart</div>
          </div>
        </div>

        <!-- advanced KPI -->
        <div class="vsp-kpi-grid">
          <div class="vsp-card">
            <div class="vsp-card-header">
              <div class="vsp-card-title">Security Posture Score</div>
            </div>
            <div class="vsp-kpi-score badge-amber" id="vsp-kpi-score">20</div>
            <div class="vsp-kpi-sub">0–100 (higher is better)</div>
          </div>

          <div class="vsp-card">
            <div class="vsp-card-header">
              <div class="vsp-card-title">Top Risky Tool</div>
            </div>
            <div class="vsp-kpi-value" id="vsp-kpi-top-tool">gitleaks</div>
            <div class="vsp-kpi-sub">Tool sinh nhiều CRITICAL/HIGH nhất</div>
          </div>

          <div class="vsp-card">
            <div class="vsp-card-header">
              <div class="vsp-card-title">Top Impacted CWE</div>
            </div>
            <div class="vsp-kpi-value" id="vsp-kpi-top-cwe">CWE-396</div>
            <div class="vsp-kpi-sub">Mã CWE bị ảnh hưởng nhiều nhất</div>
          </div>

          <div class="vsp-card">
            <div class="vsp-card-header">
              <div class="vsp-card-title">Top Vulnerable Module</div>
            </div>
            <div class="vsp-kpi-value" id="vsp-kpi-top-module">/path/to/module</div>
            <div class="vsp-kpi-sub">Thư viện / module có rủi ro CVE cao nhất</div>
          </div>

          <div class="vsp-card">
            <div class="vsp-card-header">
              <div class="vsp-card-title">CI/CD Gate Status</div>
            </div>
            <div class="vsp-gate-badge vsp-gate-red" id="vsp-kpi-ci-gate">
              RED • Blocking pipeline
            </div>
            <div class="vsp-kpi-sub">
              Gate dựa trên CRITICAL/HIGH, security score &amp; coverage
            </div>
          </div>
        </div>

        <!-- charts -->
        <div class="vsp-charts-grid">
          <div class="vsp-card">
            <div class="vsp-card-header">
              <div class="vsp-card-title">Severity Distribution</div>
            </div>
            <div class="vsp-chart-placeholder" id="vsp-chart-severity">
              donut chart: 6 severity buckets
            </div>
          </div>

          <div class="vsp-card">
            <div class="vsp-card-header">
              <div class="vsp-card-title">Findings Trend</div>
            </div>
            <div class="vsp-chart-placeholder" id="vsp-chart-trend">
              line chart: total findings per run
            </div>
          </div>
        </div>

        <div class="vsp-charts-grid" style="margin-top: 12px;">
          <div class="vsp-card">
            <div class="vsp-card-header">
              <div class="vsp-card-title">Critical / High by Tool</div>
            </div>
            <div class="vsp-chart-placeholder" id="vsp-chart-bytool">
              bar chart: CRITICAL+HIGH per tool
            </div>
          </div>

          <div class="vsp-card">
            <div class="vsp-card-header">
              <div class="vsp-card-title">Top CWE Exposure</div>
            </div>
            <div class="vsp-chart-placeholder" id="vsp-chart-topcwe">
              horizontal bar: top CWE list
            </div>
          </div>
        </div>

        <!-- findings zone -->
        <div class="vsp-split-grid-4">
          <div class="vsp-card">
            <div class="vsp-card-header">
              <div class="vsp-card-title">Top Risk Findings</div>
            </div>
            <div class="vsp-card-body">
              <div class="vsp-table-wrapper">
                <table class="vsp-table">
                  <thead>
                    <tr>
                      <th>Sev</th><th>Tool</th><th>CWE</th><th>File</th>
                    </tr>
                  </thead>
                  <tbody id="vsp-dash-top-risk">
                    <tr>
                      <td><span class="vsp-sev-badge sev-critical">CRIT</span></td>
                      <td>semgrep</td>
                      <td>CWE-79</td>
                      <td>/src/web/login.py</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <div class="vsp-card">
            <div class="vsp-card-header">
              <div class="vsp-card-title">Top Noisy Paths</div>
            </div>
            <div class="vsp-card-body">
              <div class="vsp-table-wrapper">
                <table class="vsp-table">
                  <thead>
                    <tr>
                      <th>Path</th><th>Count</th>
                    </tr>
                  </thead>
                  <tbody id="vsp-dash-noisy-paths">
                    <tr>
                      <td>tests/</td><td>320</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <div class="vsp-card">
            <div class="vsp-card-header">
              <div class="vsp-card-title">Top Exploited CVEs</div>
            </div>
            <div class="vsp-card-body">
              <div class="vsp-table-wrapper">
                <table class="vsp-table">
                  <thead>
                    <tr>
                      <th>CVE</th><th>CVSS</th><th>Count</th>
                    </tr>
                  </thead>
                  <tbody id="vsp-dash-top-cve">
                    <tr>
                      <td>CVE-2023-12345</td><td>9.8</td><td>5</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <div class="vsp-card">
            <div class="vsp-card-header">
              <div class="vsp-card-title">By Tool – Severity Buckets</div>
            </div>
            <div class="vsp-card-body">
              <div class="vsp-table-wrapper">
                <table class="vsp-table">
                  <thead>
                    <tr>
                      <th>Tool</th><th>CRIT</th><th>HIGH</th><th>MED</th><th>LOW</th>
                    </tr>
                  </thead>
                  <tbody id="vsp-dash-bytool-table">
                    <tr>
                      <td>gitleaks</td><td>10</td><td>2800</td><td>1000</td><td>600</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- TAB 2: RUNS & REPORTS -->
      <section class="vsp-pane" id="vsp-runs-main">
        <div class="vsp-card">
          <div class="vsp-card-header">
            <div>
              <div class="vsp-section-title">Runs &amp; Reports</div>
              <div class="vsp-section-subtitle">Lịch sử scan &amp; CI/CD gate status</div>
            </div>
            <div>
              <button class="vsp-btn-secondary">Export index CSV</button>
            </div>
          </div>

          <div class="vsp-kpi-grid" style="grid-template-columns: repeat(4, minmax(0, 1fr)); margin-top: 6px;">
            <div class="vsp-card" style="box-shadow:none;">
              <div class="vsp-card-title">Total Runs</div>
              <div class="vsp-kpi-value" id="vsp-runs-total">298</div>
            </div>
            <div class="vsp-card" style="box-shadow:none;">
              <div class="vsp-card-title">Last 10 – Success</div>
              <div class="vsp-kpi-value" id="vsp-runs-success">7</div>
            </div>
            <div class="vsp-card" style="box-shadow:none;">
              <div class="vsp-card-title">Last 10 – Failed</div>
              <div class="vsp-kpi-value" id="vsp-runs-failed">3</div>
            </div>
            <div class="vsp-card" style="box-shadow:none;">
              <div class="vsp-card-title">Avg Findings / Run (Last 10)</div>
              <div class="vsp-kpi-value" id="vsp-runs-avg">9,624.8</div>
            </div>
          </div>

          <div class="vsp-filters" style="margin-top: 12px;">
            <div class="vsp-field">
              <label>Profile</label>
              <select class="vsp-select" id="vsp-runs-filter-profile">
                <option value="ALL">All profiles</option>
                <option value="FULL_EXT">FULL_EXT</option>
                <option value="FAST">FAST</option>
              </select>
            </div>
            <div class="vsp-field">
              <label>Gate</label>
              <select class="vsp-select" id="vsp-runs-filter-gate">
                <option value="ALL">Any</option>
                <option value="GREEN">GREEN</option>
                <option value="AMBER">AMBER</option>
                <option value="RED">RED</option>
              </select>
            </div>
            <div class="vsp-field">
              <label>Time</label>
              <select class="vsp-select" id="vsp-runs-filter-time">
                <option value="30d">Last 30 days</option>
                <option value="7d">Last 7 days</option>
                <option value="all">All time</option>
              </select>
            </div>
            <div class="vsp-field" style="flex:1; min-width:220px;">
              <label>Search run / SRC / URL</label>
              <input class="vsp-input" id="vsp-runs-search" placeholder="RUN_..., /path/to/src, https://..." />
            </div>
          </div>

          <div class="vsp-table-wrapper">
            <table class="vsp-table">
              <thead>
                <tr>
                  <th>Run ID</th>
                  <th>Started</th>
                  <th>Profile</th>
                  <th>SRC/URL</th>
                  <th>CRIT</th>
                  <th>HIGH</th>
                  <th>MED</th>
                  <th>LOW</th>
                  <th>INFO</th>
                  <th>TRACE</th>
                  <th>Total</th>
                  <th>Gate</th>
                  <th>Reports</th>
                </tr>
              </thead>
              <tbody id="vsp-runs-tbody">
                <tr>
                  <td class="vsp-mono">RUN_VSP_FULL_EXT_20251208_142917</td>
                  <td>2025-12-08 14:29</td>
                  <td>FULL_EXT</td>
                  <td>/home/test/Data/project-x</td>
                  <td>30</td><td>3405</td><td>1501</td><td>1330</td><td>2657</td><td>6266</td><td>15189</td>
                  <td><span class="vsp-gate-badge vsp-gate-red">RED</span></td>
                  <td><button class="vsp-btn-secondary">HTML</button></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- TAB 3: DATA SOURCE -->
      <section class="vsp-pane" id="vsp-datasource-main">
        <div class="vsp-layout-2col">
          <div class="vsp-card">
            <div class="vsp-card-header">
              <div>
                <div class="vsp-section-title">Unified Findings</div>
                <div class="vsp-section-subtitle">Dữ liệu thống nhất từ toàn bộ tool</div>
              </div>
              <div>
                <button class="vsp-btn-secondary">Export CSV</button>
                <button class="vsp-btn-secondary">Export SARIF</button>
                <button class="vsp-btn-secondary">ZIP</button>
              </div>
            </div>

            <div class="vsp-filters">
              <div class="vsp-field">
                <label>Severity</label>
                <select class="vsp-select">
                  <option>All</option>
                  <option>CRITICAL</option>
                  <option>HIGH</option>
                  <option>MEDIUM</option>
                  <option>LOW</option>
                  <option>INFO</option>
                  <option>TRACE</option>
                </select>
              </div>
              <div class="vsp-field">
                <label>Tool</label>
                <select class="vsp-select">
                  <option>All tools</option>
                  <option>semgrep</option>
                  <option>gitleaks</option>
                  <option>trivy-fs</option>
                </select>
              </div>
              <div class="vsp-field">
                <label>CWE/CVE</label>
                <input class="vsp-input" placeholder="CWE-79, CVE-2023-..." />
              </div>
              <div class="vsp-field">
                <label>Folder</label>
                <input class="vsp-input" placeholder="src/backend/" />
              </div>
              <div class="vsp-field" style="flex:1; min-width:220px;">
                <label>Search message / rule</label>
                <input class="vsp-input" placeholder="SQL injection, secret, ..." />
              </div>
            </div>

            <div class="vsp-table-wrapper">
              <table class="vsp-table vsp-table-datasource">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>Sev</th>
                    <th>Tool</th>
                    <th>File</th>
                    <th>Line</th>
                    <th>Rule</th>
                    <th>Message</th>
                    <th>CWE</th>
                    <th>CVE</th>
                    <th>Component</th>
                  </tr>
                </thead>
                <tbody id="vsp-ds-tbody">
                  <tr>
                    <td>1</td>
                    <td><span class="vsp-sev-badge sev-high">HIGH</span></td>
                    <td>gitleaks</td>
                    <td>/src/backend/config/settings.json</td>
                    <td>42</td>
                    <td>generic-api-key</td>
                    <td>Possible hard-coded API key</td>
                    <td>CWE-798</td>
                    <td>&mdash;</td>
                    <td>&mdash;</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <div class="vsp-card">
            <div class="vsp-card-header">
              <div class="vsp-section-title">Mini charts &amp; stats</div>
            </div>
            <div class="vsp-card-body">
              <div class="vsp-chart-placeholder" style="height:110px; margin-bottom:8px;">
                donut: severity (theo filter)
              </div>
              <div class="vsp-chart-placeholder" style="height:110px; margin-bottom:8px;">
                bar: findings by tool
              </div>
              <div class="vsp-chart-placeholder" style="height:110px;">
                top CWE / directories
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- TAB 4: SETTINGS -->
      <section class="vsp-pane" id="vsp-settings-main">
        <div class="vsp-layout-2col">
          <div class="vsp-card">
            <div class="vsp-card-header">
              <div class="vsp-section-title">General &amp; Tool Stack</div>
            </div>
            <div class="vsp-card-body">
              <pre class="vsp-mono" id="vsp-settings-json" style="font-size:11px; white-space:pre-wrap;">
{
  "general": { ... },
  "tools": {
    "semgrep": { "enabled": true, ... },
    "gitleaks": { "enabled": true, ... },
    "trivy-fs": { "enabled": true, ... }
  },
  "profiles": { "FAST": { ... }, "FULL_EXT": { ... } },
  "integrations": { "webhook": { ... }, "slack": { ... } },
  "ci_gate_policy": { "min_security_score": 50, "max_critical": 0, ... }
}
              </pre>
            </div>
          </div>

          <div class="vsp-card">
            <div class="vsp-card-header">
              <div class="vsp-section-title">Profile Manager &amp; Integrations</div>
            </div>
            <div class="vsp-card-body">
              <div style="display:flex; flex-wrap:wrap; gap:6px; margin-bottom:10px;">
                <span class="vsp-tag">Profile: FAST</span>
                <span class="vsp-tag">Profile: FULL_EXT</span>
                <span class="vsp-tag">Webhook: Enabled</span>
                <span class="vsp-tag">Slack Alerts: Enabled</span>
              </div>
              <p style="font-size:12px;">
                Tab này cho phép tạo/sửa profile scan, bật/tắt tool, cấu hình webhook,
                Slack/Teams, push SARIF, upload SBOM...
              </p>
            </div>
          </div>
        </div>
      </section>

      <!-- TAB 5: RULE OVERRIDES -->
      <section class="vsp-pane" id="vsp-rules-main">
        <div class="vsp-layout-2col">
          <div class="vsp-card">
            <div class="vsp-card-header">
              <div class="vsp-section-title">Rule Override Table</div>
            </div>
            <div class="vsp-table-wrapper">
              <table class="vsp-table">
                <thead>
                  <tr>
                    <th>Rule ID</th>
                    <th>Tool</th>
                    <th>Current</th>
                    <th>Override</th>
                    <th>Scope</th>
                    <th>Description</th>
                  </tr>
                </thead>
                <tbody id="vsp-rules-tbody">
                  <tr>
                    <td>GITLEAKS_GENERIC_API_KEY</td>
                    <td>gitleaks</td>
                    <td>HIGH</td>
                    <td>LOW</td>
                    <td>path:^tests/</td>
                    <td>Allow generic API key in test data</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <div class="vsp-card">
            <div class="vsp-card-header">
              <div class="vsp-section-title">JSON/YAML Editor &amp; Metrics</div>
            </div>
            <div class="vsp-card-body">
              <pre class="vsp-mono" style="font-size:11px; white-space:pre;">
overrides:
  - id: GITLEAKS_GENERIC_API_KEY
    tool: gitleaks
    severity: LOW
    scope: "path:^tests/"
  - id: SEMGREP_PYTHON_SQL
    tool: semgrep
    severity: CRITICAL
    scope: null
              </pre>
              <p style="font-size:12px; margin-top:6px;">
                Metrics: 12 overrides active, highest downgrade CRITICAL → LOW,
                237 findings ignored theo chính sách.
              </p>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    // Simple tab switcher (wireframe) – có thể bỏ nếu dùng router JS riêng
    (function () {
      var buttons = document.querySelectorAll(".vsp-tab-btn");
      var panes = {
        dashboard: document.getElementById("vsp-dashboard-main"),
        runs: document.getElementById("vsp-runs-main"),
        datasource: document.getElementById("vsp-datasource-main"),
        settings: document.getElementById("vsp-settings-main"),
        rules: document.getElementById("vsp-rules-main")
      };

      function show(tab) {
        buttons.forEach(function (b) {
          b.classList.toggle("active", b.getAttribute("data-tab") === tab);
        });
        Object.keys(panes).forEach(function (k) {
          panes[k].classList.toggle("active", k === tab);
        });
      }

      buttons.forEach(function (btn) {
        btn.addEventListener("click", function () {
          var t = btn.getAttribute("data-tab");
          show(t);
        });
      });

      // default dashboard
      show("dashboard");
    })();
  </script>

<script defer src="/static/js/vsp_bundle_commercial_v2.js?v={{ asset_v }}"></script>

<!-- VSP5_INCLUDE_RUNS_ENHANCER_P0_V3 -->
<script defer src="/static/js/vsp_runs_tab_resolved_v1.js?v=20251218_185216"></script>

<script defer src="/static/js/vsp_p1_page_boot_v1.js?v="></script>
  <!-- VSP_UI_KEEPALIVE_JS_P1_2_INJECT -->
  <script defer src="/static/js/vsp_ui_keepalive_p1_2.js?v=1766111363\"></script>

<!-- VSP_FILL_REAL_DATA_5TABS_P1_V1 -->
<script src="/static/js/vsp_fill_real_data_5tabs_p1_v1.js"></script>
<!-- /VSP_FILL_REAL_DATA_5TABS_P1_V1 -->

<script>
/* VSP_UI_POLISH_RIDLATEST_BADGE_V1 */
(function(){
  const MARK = "VSP_UI_POLISH_RIDLATEST_BADGE_V1";
  if (window[MARK]) return; window[MARK]=1;

  function setTextAll(match, newText){
    document.querySelectorAll('button,span,div,a').forEach(el=>{
      try{
        const t = (el.textContent||"").trim();
        if (t.includes(match)) el.textContent = newText;
      }catch(e){}
    });
  }

  async function probe(){
    try{
      const r = await fetch('/api/vsp/runs?limit=1', { cache: 'no-store' });
      const hdrDegraded = (r.headers.get('X-VSP-RUNS-DEGRADED') || '') === '1';
      const txt = await r.text();
      let j=null; try{ j=JSON.parse(txt); }catch(e){}
      const rid = (j && j.rid_latest) ? j.rid_latest : 'N/A';
      const ok = (r.status===200) && j && (j.ok===true);

      // 1) Unstick banner FAIL -> OK/DEGRADED
      if (ok){
        const msg = hdrDegraded ? `RUNS API DEGRADED (rid_latest=${rid})`
                                : `RUNS API OK (rid_latest=${rid})`;
        setTextAll('RUNS API FAIL', msg);
        setTextAll('Error: 503', '');
      }

      // 2) Always-visible badge for demo confidence
      let b=document.getElementById('vsp_rid_latest_badge');
      if(!b){
        b=document.createElement('div');
        b.id='vsp_rid_latest_badge';
        b.style.cssText='position:fixed;right:16px;bottom:16px;z-index:99999;padding:8px 10px;border-radius:12px;background:rgba(0,0,0,.55);backdrop-filter:blur(6px);font:12px/1.2 system-ui;color:#e6edf3;border:1px solid rgba(255,255,255,.10)';
        document.body.appendChild(b);
      }
      b.textContent = (ok ? (hdrDegraded?'DEGRADED':'OK') : 'FAIL') + ` • rid_latest=${rid}`;
    }catch(e){}
  }

  probe();
  setInterval(probe, 5000);
})();
</script>


<!-- VSP_P1_COMMERCIAL_FINISH_ALL_UI_V1 -->

<script>
/* VSP_P1_COMMERCIAL_FINISH_ALL_UI_V1 */
(function(){
  if (window.__VSP_COMM_FINISH_ALL__) return;
  window.__VSP_COMM_FINISH_ALL__ = 1;

  const q = new URLSearchParams(location.search);
  const FORCE_RID = (q.get('rid')||'').trim();
  if (FORCE_RID) window.VSP_FORCE_RID = FORCE_RID;

  // --- Fetch interceptor: force rid for run_file and reports when ?rid= is present ---
  const _origFetch = window.fetch.bind(window);
  window.fetch = async function(input, init){
    try{
      let url = (typeof input === 'string') ? input : (input && input.url) ? input.url : '';
      if (FORCE_RID && url){
        // rewrite /api/reports/<name> -> /api/vsp/run_file?rid=FORCE&name=reports/<name>
        if (url.startsWith('/api/reports/')) {
          const name = url.substring('/api/reports/'.length);
          const rew = '/api/vsp/run_file?rid=' + encodeURIComponent(FORCE_RID) + '&name=' + encodeURIComponent('reports/' + name);
          url = rew;
        }
        // rewrite run_file rid=*
        if (url.includes('/api/vsp/run_file?')) {
          const u = new URL(url, location.origin);
          const rid = (u.searchParams.get('rid')||'').trim();
          const name = (u.searchParams.get('name')||'').trim();
          if (name && rid && rid !== FORCE_RID) {
            u.searchParams.set('rid', FORCE_RID);
            url = u.pathname + '?' + u.searchParams.toString();
          }
        }
        if (typeof input === 'string') input = url;
        else input = new Request(url, input);
      }
    }catch(e){}
    return _origFetch(input, init);
  };

  // --- Utilities ---
  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

  function ensureTopBar(){
    let bar = document.getElementById('vsp_live_status_bar');
    if (bar) return bar;
    bar = document.createElement('div');
    bar.id = 'vsp_live_status_bar';
    bar.style.cssText = [
      "position:sticky","top:0","z-index:99999",
      "margin:0 auto","max-width:1200px",
      "padding:8px 10px","border-radius:12px",
      "background:rgba(0,0,0,.45)","backdrop-filter:blur(8px)",
      "color:#e6edf3","border:1px solid rgba(255,255,255,.10)",
      "font:12px/1.2 system-ui","display:flex","gap:10px","align-items:center",
      "justify-content:space-between"
    ].join(";");
    bar.innerHTML = `
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
        <span id="vsp_live_runs_state">RUNS: ...</span>
        <span style="opacity:.8" id="vsp_live_rid">rid_latest: ...</span>
        <span style="opacity:.7" id="vsp_live_mode">${FORCE_RID ? ('FORCE rid=' + FORCE_RID) : 'AUTO rid_latest'}</span>
      </div>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <button id="vsp_btn_csv" style="all:unset;cursor:pointer;padding:6px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.14)">CSV</button>
        <button id="vsp_btn_tgz" style="all:unset;cursor:pointer;padding:6px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.14)">TGZ</button>
        <button id="vsp_btn_sha" style="all:unset;cursor:pointer;padding:6px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.14)">SHA</button>
        <button id="vsp_btn_sum" style="all:unset;cursor:pointer;padding:6px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.14)">Summary JSON</button>
      </div>
    `;

    // Insert nicely below existing header area if present, else at body top
    const anchor = document.body.firstElementChild;
    document.body.insertBefore(bar, anchor);

    return bar;
  }

  function setStickyFailToOkText(ridLatest, degraded){
    // Remove/overwrite sticky "RUNS API FAIL" banners if exist
    const msg = degraded ? `RUNS API DEGRADED • rid_latest=${ridLatest}` : `RUNS API OK • rid_latest=${ridLatest}`;
    $$('button,span,div,a').forEach(el=>{
      const t = (el.textContent||"").trim();
      if (!t) return;
      if (t.includes('RUNS API FAIL')) el.textContent = msg;
      if (t.includes('Error: 503') || t.includes('Error: 500') || t.includes('Error:')) {
        // soften error noise if runs is OK now
        if (t.includes('/api/vsp/runs')) el.textContent = '';
      }
    });
  }

  function ensureCornerBadge(){
    let b = document.getElementById('vsp_rid_latest_badge');
    if (b) return b;
    b = document.createElement('div');
    b.id = 'vsp_rid_latest_badge';
    b.style.cssText = "position:fixed;right:16px;bottom:16px;z-index:99999;padding:8px 10px;border-radius:12px;background:rgba(0,0,0,.55);backdrop-filter:blur(6px);font:12px/1.2 system-ui;color:#e6edf3;border:1px solid rgba(255,255,255,.10)";
    document.body.appendChild(b);
    return b;
  }

  function applyRunRowLinks(){
    // Runs page: turn each run_id text into links
    // Heuristic: find text nodes that look like *_RUN_* or VSP_CI_RUN_*
    const rx = /(VSP_CI_RUN_\d{8}_\d{6}|[A-Za-z0-9-]+_RUN_\d{8}_\d{6}_\d{6}|RUN_[A-Za-z0-9-]+_\d{8}_\d{6})/g;

    $$('a,div,span').forEach(el=>{
      const t = (el.textContent||"").trim();
      if (!t || t.length > 120) return;
      const m = t.match(rx);
      if (!m) return;
      const rid = m[0];
      // avoid patching buttons
      if (el.tagName === 'A' && el.getAttribute('href')) return;

      // Create small actions only once per element
      if (el.dataset && el.dataset.vspRidLinked === '1') return;
      if (el.dataset) el.dataset.vspRidLinked = '1';

      const wrap = document.createElement('span');
      wrap.style.cssText = "display:inline-flex;gap:8px;align-items:center;flex-wrap:wrap";
      const ridSpan = document.createElement('span');
      ridSpan.textContent = rid;

      const aDS = document.createElement('a');
      aDS.textContent = "Open Data Source";
      aDS.href = "/data_source?rid=" + encodeURIComponent(rid);
      aDS.target = "_blank";
      aDS.style.cssText = "opacity:.9;text-decoration:none;padding:4px 8px;border-radius:10px;border:1px solid rgba(255,255,255,.14)";

      const aSum = document.createElement('a');
      aSum.textContent = "Open Summary";
      aSum.href = "/api/vsp/run_file?rid=" + encodeURIComponent(rid) + "&name=" + encodeURIComponent("reports/run_gate_summary.json");
      aSum.target = "_blank";
      aSum.style.cssText = "opacity:.9;text-decoration:none;padding:4px 8px;border-radius:10px;border:1px solid rgba(255,255,255,.14)";

      wrap.appendChild(ridSpan);
      wrap.appendChild(aDS);
      wrap.appendChild(aSum);

      // replace el content
      el.textContent = "";
      el.appendChild(wrap);
    });
  }

  async function pollRuns(){
    const bar = ensureTopBar();
    const badge = ensureCornerBadge();
    try{
      const r = await fetch('/api/vsp/runs?limit=1', { cache:'no-store' });
      const degraded = (r.headers.get('X-VSP-RUNS-DEGRADED')||'') === '1';
      const txt = await r.text();
      let j=null; try{ j=JSON.parse(txt); }catch(e){}
      const ridLatest = FORCE_RID || (j && j.rid_latest) || 'N/A';
      const ok = (r.status===200) && j && (j.ok===true);

      $('#vsp_live_runs_state').textContent = ok ? (degraded?'RUNS: DEGRADED':'RUNS: OK') : ('RUNS: FAIL ' + r.status);
      $('#vsp_live_rid').textContent = 'rid_latest: ' + ridLatest;
      badge.textContent = (ok ? (degraded?'DEGRADED':'OK') : 'FAIL') + ' • rid=' + ridLatest;

      setStickyFailToOkText(ridLatest, degraded);

      // wire buttons
      const ridForButtons = ridLatest;
      $('#vsp_btn_csv').onclick = ()=> location.href = '/api/vsp/export_csv?rid=' + encodeURIComponent(ridForButtons);
      $('#vsp_btn_tgz').onclick = ()=> location.href = '/api/vsp/export_tgz?rid=' + encodeURIComponent(ridForButtons) + '&scope=reports';
      $('#vsp_btn_sha').onclick = ()=> window.open('/api/vsp/sha256?rid=' + encodeURIComponent(ridForButtons) + '&name=' + encodeURIComponent('reports/run_gate_summary.json'), '_blank');
      $('#vsp_btn_sum').onclick = ()=> window.open('/api/vsp/run_file?rid=' + encodeURIComponent(ridForButtons) + '&name=' + encodeURIComponent('reports/run_gate_summary.json'), '_blank');

      // update links on runs page
      applyRunRowLinks();

    }catch(e){}
  }

  pollRuns();
  setInterval(pollRuns, 4000);
})();
</script>

<script src="/static/js/vsp_runs_guard_final_p0_v1.js?v={{ asset_v }}"></script>
</body>
</html>

<!-- VSP_UI_TOPBAR_QUICKACTIONS_P8_V4 -->
