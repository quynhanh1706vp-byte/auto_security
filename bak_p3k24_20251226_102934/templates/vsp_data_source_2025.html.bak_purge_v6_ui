<!doctype html>
<html lang="vi">
<head>
<!-- VSP_P1_NETGUARD_GLOBAL_V6 -->
<script id="VSP_P1_NETGUARD_GLOBAL_V6">
(()=> {
  if (window.__vsp_p1_netguard_global_v6) return;
  window.__vsp_p1_netguard_global_v6 = true;

  const HOLD_MS = 15000;
  let holdUntil = 0;

  const DROP = [
    /\[VSP\]\s*poll down; backoff/i,
    /runs fetch guard\/backoff enabled/i,
    /VSP_ROUTE_GUARD_RUNS_ONLY_/i,
    /Fetch failed loading/i,
    /ERR_CONNECTION/i,
    /Fetch finished loading:\s*GET\s*"<URL>"/i
  ];

  function shouldDrop(args){
    try{
      const a0 = (args && args.length && typeof args[0]==="string") ? args[0] : "";
      return DROP.some(rx => rx.test(a0));
    }catch(_){ return false; }
  }

  // console filter (for inline poll logs on vsp5:390)
  if (!window.__vsp_console_filtered_v6){
    window.__vsp_console_filtered_v6 = true;
    for (const k of ["log","info","warn","error"]){
      const orig = console[k].bind(console);
      console[k] = (...args)=>{ if (shouldDrop(args)) return; return orig(...args); };
    }
  }

  function isApiVsp(u){
    if (!u) return false;
    return (u.includes("/api/vsp/"));
  }
  function isPlaceholder(u){
    if (!u) return false;
    return (u === "<URL>" || u.includes("<URL>"));
  }
  function cacheKey(u){
    // normalize: drop origin
    try{
      const uu = new URL(u, location.origin);
      return "vsp_api_cache_v6::" + (uu.pathname + (uu.search or ""));
    }catch(_){
      return "vsp_api_cache_v6::" + String(u);
    }
  }
  function loadCache(u){
    try{
      const raw = localStorage.getItem(cacheKey(u));
      if (!raw) return null;
      return JSON.parse(raw);
    }catch(_){ return null; }
  }
  function saveCache(u, obj){
    try{
      localStorage.setItem(cacheKey(u), JSON.stringify(obj));
    }catch(_){}
  }
  function respJson(obj, hdr){
    const h = new Headers({"Content-Type":"application/json; charset=utf-8"});
    try{ if (hdr) for (const [k,v] of Object.entries(hdr)) h.set(k, String(v)); }catch(_){}
    return new Response(JSON.stringify(obj), {status:200, headers:h});
  }

  // --- fetch wrapper
  if (window.fetch && !window.__vsp_fetch_wrapped_v6){
    window.__vsp_fetch_wrapped_v6 = true;
    const orig = window.fetch.bind(window);
    window.fetch = async (input, init)=>{
      let u="";
      try{ u = (typeof input==="string") ? input : (input && input.url) ? input.url : ""; }catch(_){}
      if (isPlaceholder(u)){
        return respJson({ok:false, note:"intercepted <URL>", marker:"V6"}, {"X-VSP-Intercept":"1"});
      }
      if (isApiVsp(u)){
        const now = Date.now();
        if (now < holdUntil){
          const cached = loadCache(u) || {ok:false, note:"degraded-cache-empty"};
          return respJson(cached, {"X-VSP-Hold":"1","X-VSP-Cache":"1"});
        }
        try{
          const r = await orig(input, init);
          if (r && r.ok){
            try{
              const j = await r.clone().json();
              if (j && typeof j==="object") saveCache(u, j);
            }catch(_){}
            return r;
          }
          holdUntil = Date.now() + HOLD_MS;
          const cached = loadCache(u) || {ok:false, note:"degraded-cache-empty"};
          return respJson(cached, {"X-VSP-Hold":"1","X-VSP-Cache":"1","X-VSP-Non200": r ? r.status : "NA"});
        }catch(_e){
          holdUntil = Date.now() + HOLD_MS;
          const cached = loadCache(u) || {ok:false, note:"degraded-cache-empty"};
          return respJson(cached, {"X-VSP-Hold":"1","X-VSP-Cache":"1","X-VSP-NetFail":"1"});
        }
      }
      return orig(input, init);
    };
  }

  // --- XHR wrapper (stops DevTools XHR spam)
  if (window.XMLHttpRequest && !window.__vsp_xhr_wrapped_v6){
    window.__vsp_xhr_wrapped_v6 = true;
    const _open = XMLHttpRequest.prototype.open;
    const _send = XMLHttpRequest.prototype.send;

    XMLHttpRequest.prototype.open = function(method, url){
      try{ this.__vsp_url = String(url || ""); }catch(_){}
      return _open.apply(this, arguments);
    };

    XMLHttpRequest.prototype.send = function(body){
      const u = (this && this.__vsp_url) ? String(this.__vsp_url) : "";
      if (isPlaceholder(u) || isApiVsp(u)){
        const now = Date.now();
        if (isPlaceholder(u) || (now < holdUntil && isApiVsp(u))){
          const cached = isPlaceholder(u) ? {ok:false, note:"intercepted <URL>", marker:"V6"} : (loadCache(u) || {ok:false, note:"degraded-cache-empty"});
          const txt = JSON.stringify(cached);

          try{
            Object.defineProperty(this, "status", { get: ()=>200, configurable:true });
            Object.defineProperty(this, "responseText", { get: ()=>txt, configurable:true });
            Object.defineProperty(this, "response", { get: ()=>txt, configurable:true });
          }catch(_){}

          const self=this;
          setTimeout(()=>{
            try{ if (typeof self.onreadystatechange==="function") self.onreadystatechange(); }catch(_){}
            try{ if (typeof self.onload==="function") self.onload(); }catch(_){}
            try{ self.dispatchEvent && self.dispatchEvent(new Event("load")); }catch(_){}
          },0);

          return; // IMPORTANT: no network
        }

        // attach cache+hold behavior
        const self=this;
        const onLoad = ()=>{
          try{
            if (self.status === 200){
              let j=null;
              try{ j = JSON.parse(self.responseText || "null"); }catch(_){}
              if (j && typeof j==="object") saveCache(u, j);
            }else{
              holdUntil = Date.now() + HOLD_MS;
            }
          }catch(_){}
        };
        const onErr = ()=>{ holdUntil = Date.now() + HOLD_MS; };
        try{ self.addEventListener("load", onLoad, {once:true}); }catch(_){}
        try{ self.addEventListener("error", onErr, {once:true}); }catch(_){}
        try{ self.addEventListener("timeout", onErr, {once:true}); }catch(_){}
      }
      return _send.apply(this, arguments);
    };
  }
})();
</script>

  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>VSP • Data Source</title>
  <link rel="stylesheet" href="/static/css/vsp_data_source_tab_v1.css?v=VSP_DATA_P0_V1"/>

<!-- VSP_GLOBAL_POLL_GUARD_P1_V1 -->
<script>
(function(){
  if (window.__VSP_GLOBAL_POLL_GUARD) return;
  window.__VSP_GLOBAL_POLL_GUARD = true;

  const nativeFetch = (globalThis.fetch ? globalThis.fetch.bind(globalThis) : null);

  const MIN = {
    runs: 12000,
    dash: 15000
  };
  const st = {
    last: Object.create(null),
    cache: Object.create(null),
    inflight: Object.create(null),
    backoffMs: 2000,
    nextTryAt: 0,
    lastWarnAt: 0
  };

  function now(){ return Date.now(); }
  function baseKey(u){ try{ return u.toString().split('?')[0]; }catch(e){ return ""; } }
  function urlStr(input){ try{ if (typeof input==="string") return input; if (input && input.url) return input.url; }catch(e){} return ""; }

  function shouldGuard(url){
    const s = (url||"").toString();
    if (!s.includes("/api/vsp/")) return false;

    // never guard downloads/exports/sha/file
    if (s.includes("/api/vsp/run_file")) return false;
    if (s.includes("/api/vsp/run_file2")) return false;
    if (s.includes("/api/vsp/export_")) return false;
    if (s.includes("/api/vsp/sha256")) return false;

    if (s.includes("/api/vsp/runs")) return true;
    if (s.includes("/api/vsp/dashboard")) return true; // includes dashboard_commercial_v2
    return false;
  }

  function minInterval(key){
    if (key.includes("/api/vsp/runs")) return MIN.runs;
    if (key.includes("/api/vsp/dashboard")) return MIN.dash;
    return 0;
  }

  function mkJsonResponse(obj, status){
    try {
      return new Response(JSON.stringify(obj), {
        status: status || 503,
        headers: { "Content-Type":"application/json", "X-VSP-CACHED":"1" }
      });
    } catch(e) {
      return { ok:false, status:status||503, json: async()=>obj };
    }
  }

  async function guardedFetch(input, init){
    if (!nativeFetch) return mkJsonResponse({ok:false,error:"NO_FETCH"},503);
    const u = urlStr(input);
    if (!u || !shouldGuard(u)) return nativeFetch(input, init);

    const k = baseKey(u);
    const t = now();
    const min = minInterval(k);

    // If tab is hidden -> do NOT spam network; serve cache if any
    if (document && document.hidden) {
      if (st.cache[k]) return new Response(st.cache[k], { status:200, headers:{"Content-Type":"application/json","X-VSP-CACHED":"1"} });
      return mkJsonResponse({ok:false, who:"VSP_POLL_GUARD", error:"HIDDEN"}, 503);
    }

    // global backoff window (after failures)
    if (t < st.nextTryAt) {
      if (st.cache[k]) return new Response(st.cache[k], { status:200, headers:{"Content-Type":"application/json","X-VSP-CACHED":"1"} });
      return mkJsonResponse({ok:false, who:"VSP_POLL_GUARD", error:"BACKOFF"}, 503);
    }

    const last = st.last[k] || 0;

    // throttle: if too soon -> serve cache, NO network
    if ((t - last) < min && st.cache[k]) {
      return new Response(st.cache[k], { status:200, headers:{"Content-Type":"application/json","X-VSP-CACHED":"1"} });
    }

    // inflight: serve cache, NO network
    if (st.inflight[k]) {
      if (st.cache[k]) return new Response(st.cache[k], { status:200, headers:{"Content-Type":"application/json","X-VSP-CACHED":"1"} });
      return mkJsonResponse({ok:false, who:"VSP_POLL_GUARD", error:"INFLIGHT"}, 503);
    }

    st.inflight[k] = true;

    const ctrl = new AbortController();
    const timer = setTimeout(()=>ctrl.abort(), 8000);

    try {
      const _init = Object.assign({}, init||{});
      _init.signal = ctrl.signal;
      _init.cache = "no-store";
      const r = await nativeFetch(input, _init);

      st.last[k] = t;
      if (r && r.ok) {
        try {
          const txt = await r.clone().text();
          if (txt && txt.length < 5_000_000) st.cache[k] = txt;
        } catch(e){}
        // reset backoff after success
        st.backoffMs = 2000;
        st.nextTryAt = 0;
      }
      return r;
    } catch(e) {
      const t2 = now();
      if (t2 - st.lastWarnAt > 5000) {
        console.warn("[VSP] poll down; backoff", st.backoffMs, "ms");
        st.lastWarnAt = t2;
      }
      st.nextTryAt = t2 + st.backoffMs;
      st.backoffMs = Math.min(st.backoffMs * 2, 60000);
      if (st.cache[k]) return new Response(st.cache[k], { status:200, headers:{"Content-Type":"application/json","X-VSP-CACHED":"1"} });
      return mkJsonResponse({ok:false, who:"VSP_POLL_GUARD", error:"FETCH_FAILED"}, 503);
    } finally {
      clearTimeout(timer);
      st.inflight[k] = false;
    }
  }

  // override as early as possible
  globalThis.fetch = guardedFetch;
  window.fetch = guardedFetch;

  // guard XHR too (best effort)
  try {
    const _open = XMLHttpRequest.prototype.open;
    const _send = XMLHttpRequest.prototype.send;
    XMLHttpRequest.prototype.open = function(method, url){
      try { this.__vsp_url = url; } catch(e) {}
      return _open.apply(this, arguments);
    };
    XMLHttpRequest.prototype.send = function(){
      try {
        const u = (this.__vsp_url || "");
        if (shouldGuard(u)) {
          const k = baseKey(u);
          const t = now();
          const min = minInterval(k);
          const last = st.last[k] || 0;
          if (document && document.hidden) { try{ this.abort(); }catch(e){}; return; }
          if (t < st.nextTryAt) { try{ this.abort(); }catch(e){}; return; }
          if ((t-last) < min) { try{ this.abort(); }catch(e){}; return; }
          if (st.inflight[k]) { try{ this.abort(); }catch(e){}; return; }
        }
      } catch(e) {}
      return _send.apply(this, arguments);
    };
  } catch(e) {}
})();
</script>
<!-- /VSP_GLOBAL_POLL_GUARD_P1_V1 -->

</head>
<body>
  <div class="topbar">
    <div class="brand">
      <span class="dot"></span>
      <div class="title">VersaSecure Platform • UI</div>
      <div class="subtitle">Data Source (Findings)</div>
    </div>

    <div class="tabs">
      <a class="tab" href="/vsp4">Dashboard</a>
      <a class="tab" href="/runs">Runs &amp; Reports</a>
      <a class="tab active" href="/data">Data Source</a>
      <a class="tab" href="/settings">Settings</a>
      <a class="tab" href="/rule_overrides">Rule Overrides</a>
    </div>

    <div class="actions">
      <button id="btnReload" class="btn">Reload</button>
      <a class="btn btn-ghost" href="/api/vsp/findings" target="_blank" rel="noopener">Open API</a>
    </div>
  </div>

  <div class="wrap">
    <div class="panel">
      <div class="panel-head">
        <div class="kpis">
          <div class="kpi">
            <div class="kpi-label">Total</div>
            <div id="kpiTotal" class="kpi-val">—</div>
          </div>
          <div class="kpi">
            <div class="kpi-label">Shown</div>
            <div id="kpiShown" class="kpi-val">—</div>
          </div>
          <div class="kpi">
            <div class="kpi-label">Last fetch</div>
            <div id="kpiFetched" class="kpi-val">—</div>
          </div>
        </div>

        <div class="controls">
          <input id="q" class="input" placeholder="Search (rule/id/title/message/path/tool) …" />
          <select id="sev" class="select">
            <option value="">All severities</option>
            <option value="CRITICAL">CRITICAL</option>
            <option value="HIGH">HIGH</option>
            <option value="MEDIUM">MEDIUM</option>
            <option value="LOW">LOW</option>
            <option value="INFO">INFO</option>
            <option value="TRACE">TRACE</option>
          </select>
          <select id="tool" class="select">
            <option value="">All tools</option>
          </select>
          <select id="sort" class="select">
            <option value="sev_desc">Sort: Severity ↓</option>
            <option value="sev_asc">Sort: Severity ↑</option>
            <option value="tool_asc">Sort: Tool A→Z</option>
            <option value="file_asc">Sort: File A→Z</option>
            <option value="rule_asc">Sort: Rule/ID A→Z</option>
          </select>

          <select id="pageSize" class="select">
            <option value="25">25 / page</option>
            <option value="50" selected>50 / page</option>
            <option value="100">100 / page</option>
            <option value="250">250 / page</option>
          </select>
        </div>

        <div id="banner" class="banner hidden"></div>
      </div>

      <div class="table-wrap">
        <table class="tbl">
          <thead>
            <tr>
              <th style="width:120px;">Severity</th>
              <th style="width:150px;">Tool</th>
              <th>Title / Rule</th>
              <th style="width:36%;">File / Location</th>
              <th style="width:160px;">Actions</th>
            </tr>
          </thead>
          <tbody id="rows">
            <tr><td colspan="5" class="muted">Loading…</td></tr>
          </tbody>
        </table>
      </div>

      <div class="pager">
        <div class="muted" id="pagerInfo">—</div>
        <div class="pagerBtns">
          <button class="btn btn-ghost" id="btnPrev">Prev</button>
          <button class="btn btn-ghost" id="btnNext">Next</button>
        </div>
      </div>
    </div>

    <div class="foot muted">
      Contract source: <code>/api/vsp/findings</code> • UI: <code>/data</code>
    </div>
  </div>

  <!-- modal -->
  <div id="modal" class="modal hidden">
    <div class="modal-backdrop" id="modalClose"></div>
    <div class="modal-card">
      <div class="modal-head">
        <div>
          <div id="mTitle" class="modal-title">Finding</div>
          <div id="mSub" class="modal-sub muted">—</div>
        </div>
        <div class="modal-actions">
          <button id="btnCopyJSON" class="btn">Copy JSON</button>
          <button id="btnClose" class="btn btn-ghost">Close</button>
        </div>
      </div>
      <pre id="mJson" class="modal-pre">{}</pre>
    </div>
  </div>

  <script src="/static/js/vsp_data_source_tab_v1.js?v=VSP_DATA_P0_V1"></script>
</body>
</html>
