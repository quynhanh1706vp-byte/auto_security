<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <meta http-equiv="Cache-Control" content="no-store"/>
  <title>VSP Runs & Reports</title>
  <style>
    :root{color-scheme:dark;}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial;
         background:#0b1020;color:#dbe7ff;}
    .top{position:sticky;top:0;background:rgba(8,12,24,.92);backdrop-filter: blur(8px);
         border-bottom:1px solid rgba(255,255,255,.08);padding:14px 16px;z-index:10}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .brand{font-weight:700;letter-spacing:.2px}
    .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid rgba(255,255,255,.10);
          padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.04);font-size:12px}
    .btn{cursor:pointer;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);
         color:#dbe7ff;border-radius:10px;padding:8px 10px;font-weight:600}
    .btn:hover{background:rgba(255,255,255,.10)}
    .wrap{padding:14px 16px}
    .card{border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.03);
          border-radius:16px;padding:12px}
    input{border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);color:#dbe7ff;
          border-radius:10px;padding:8px 10px;outline:none;min-width:280px}
    table{width:100%;border-collapse:collapse;margin-top:10px;font-size:13px}
    th,td{padding:10px 8px;border-bottom:1px solid rgba(255,255,255,.07);vertical-align:middle}
    th{color:#9db6ff;text-align:left;font-weight:700}
    .muted{color:rgba(219,231,255,.70)}
    .tag{display:inline-block;padding:3px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.12);
         background:rgba(255,255,255,.05);font-size:12px}
    .ok{color:#77ffb0;border-color:rgba(119,255,176,.25);background:rgba(119,255,176,.08)}
    .no{color:#ff7a7a;border-color:rgba(255,122,122,.25);background:rgba(255,122,122,.08)}
    .right{display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap}
    a.link{color:#9db6ff;text-decoration:none}
    a.link:hover{text-decoration:underline}
    .err{color:#ffb86b}
    .small{font-size:12px}
  </style>
</head>
<body>
  <!-- VSP_RUNS_PAGE_FACTORY_RESET_STATIC_P0_V1 -->
  <div class="top">
    <div class="row">
      <div class="brand">VSP Runs & Reports</div>
      <span class="pill">source: <span id="src" class="muted">(unknown)</span></span>
      <span class="pill">rid_latest: <span id="rid" class="muted">(n/a)</span></span>
      <span class="pill">api: <span id="api" class="muted">idle</span></span>
      <button class="btn" id="btnRefresh">Refresh</button>
      <a class="btn link" href="/vsp5">Go /vsp5</a>
      <a class="btn link" href="/data_source">Go /data_source</a>
      <a class="btn link" href="/settings">Go /settings</a>
    </div>
  </div>

  <div class="wrap">
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div class="row">
          <input id="q" placeholder="Filter by run_id..."/>
          <span class="pill">showing: <b id="n">0</b></span>
        </div>
        <div class="row small muted" id="hint">If you ever see blank again: this page is self-contained (no bundle JS).</div>
      </div>

      <table>
        <thead>
          <tr>
            <th style="width:44%">run_id</th>
            <th style="width:18%">artifacts</th>
            <th style="width:38%">quick open</th>
          </tr>
        </thead>
        <tbody id="tb">
          <tr><td colspan="3" class="muted">Loading…</td></tr>
        </tbody>
      </table>
    </div>
  </div>

<script>
(function(){
  function esc(s){
    s = (s === undefined || s === null) ? "" : String(s);
    return s.replace(/[&<>"]/g, function(c){
      return ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;" })[c] || c;
    });
  }
  function byId(id){ return document.getElementById(id); }
  function setApi(t, cls){
    var el = byId("api");
    el.textContent = t;
    el.className = cls ? cls : "muted";
  }
  function tag(ok, label){
    var c = ok ? "tag ok" : "tag no";
    return '<span class="'+c+'">'+label+'</span>';
  }
  function mkLinks(rid){
    var s = [];
    // Summary JSON
    s.push('<a class="link" target="_blank" href="/api/vsp/run_file?rid='+encodeURIComponent(rid)+'&name=reports/run_gate_summary.json">Summary</a>');
    // TGZ reports
    s.push('<a class="link" target="_blank" href="/api/vsp/export_tgz?rid='+encodeURIComponent(rid)+'&scope=reports">TGZ</a>');
    // CSV unified
    s.push('<a class="link" target="_blank" href="/api/vsp/export_csv?rid='+encodeURIComponent(rid)+'">CSV</a>');
    // SHA for summary
    s.push('<a class="link" target="_blank" href="/api/vsp/sha256?rid='+encodeURIComponent(rid)+'&name=reports/run_gate_summary.json">SHA</a>');
    return s.join(' &nbsp;•&nbsp; ');
  }

  var all = [];
  function render(){
    var q = (byId("q").value || "").trim().toLowerCase();
    var items = all;
    if(q){
      items = all.filter(function(x){ return (x.run_id||"").toLowerCase().indexOf(q) >= 0; });
    }
    byId("n").textContent = String(items.length);

    var tb = byId("tb");
    if(!items.length){
      tb.innerHTML = '<tr><td colspan="3" class="muted">No runs.</td></tr>';
      return;
    }
    var html = "";
    for(var i=0;i<items.length;i++){
      var it = items[i] || {};
      var rid = it.run_id || "";
      var has = it.has || {};
      var artifacts =
        tag(!!has.json, "json") + " " +
        tag(!!has.csv, "csv") + " " +
        tag(!!has.sarif, "sarif") + " " +
        tag(!!has.summary, "summary");
      html += "<tr>";
      html += '<td><div style="font-weight:700">'+esc(rid)+'</div></td>';
      html += '<td class="small">'+artifacts+'</td>';
      html += '<td class="small"><div class="right">'+mkLinks(rid)+'</div></td>';
      html += "</tr>";
    }
    tb.innerHTML = html;
  }

  function fetchRuns(){
    setApi("fetching…", "err");
    var url = "/api/vsp/runs?limit=200&_ts=" + Date.now();
    return fetch(url, {cache:"no-store"}).then(function(r){
      if(!r.ok) throw new Error("HTTP "+r.status);
      return r.json();
    }).then(function(j){
      if(!j || !j.items) throw new Error("bad json");
      all = j.items || [];
      byId("rid").textContent = j.rid_latest || "(n/a)";
      byId("src").textContent = (j.roots_used && j.roots_used[0]) ? j.roots_used[0] : "(unknown)";
      setApi("OK ("+all.length+")", "muted");
      render();
    }).catch(function(e){
      all = [];
      byId("tb").innerHTML = '<tr><td colspan="3" class="err">Runs API error: '+esc(e && e.message ? e.message : e)+'</td></tr>';
      setApi("FAIL", "err");
      byId("n").textContent = "0";
    });
  }

  byId("q").addEventListener("input", function(){ render(); });
  byId("btnRefresh").addEventListener("click", function(){ fetchRuns(); });

  // boot
  fetchRuns();
})();
</script>
</body>
</html>
