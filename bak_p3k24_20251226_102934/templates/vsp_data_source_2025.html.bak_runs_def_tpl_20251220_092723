<!doctype html>
<html lang="vi">
<head>

<!-- VSP_P0_RUNS_FETCH_LOCK_V1 -->
<!-- VSP_P0_RUNS_FETCH_LOCK_V1 -->
<script id="VSP_P0_RUNS_FETCH_LOCK_V1">
(()=> {
  if (window.__vsp_p0_runs_fetch_lock_v1) return;
  window.__vsp_p0_runs_fetch_lock_v1 = true;

  // clear stale persisted RUNS fail flags to stop boot-flicker
  try{
    const ks = Object.keys(localStorage || {});
    for (const k of ks){
      if (/runs/i.test(k) && /(fail|degrad|503|error)/i.test(k)) localStorage.removeItem(k);
      if (/vsp_?runs/i.test(k) && /(fail|degrad|503|error)/i.test(k)) localStorage.removeItem(k);
      if (/VSP/i.test(k) && /(RUNS).*?(FAIL|503|DEGRA)/i.test(k)) localStorage.removeItem(k);
    }
  }catch(_){}

  const orig = (window.fetch && window.fetch.bind) ? window.fetch.bind(window) : null;
  if (!orig) return;

  const CACHE_KEY = "vsp_runs_cache_last_ok";

  const mkResp = (obj, degraded) => {
    const headers = new Headers({
      "Content-Type":"application/json; charset=utf-8",
      "Cache-Control":"no-store",
      "X-VSP-Degraded": String(degraded ? 1 : 0),
      "X-VSP-Fix": "runs_fetch_lock_v1"
    });
    return new Response(JSON.stringify(obj), { status: 200, headers });
  };

  const isRuns = (u) => !!u && (String(u).includes("/api/vsp/runs"));

  async function wrapRuns(input, init){
    let url = "";
    try{ url = (typeof input === "string") ? input : (input && input.url) ? input.url : ""; }catch(_){}
    if (!isRuns(url)) return orig(input, init);

    try{
      const r = await orig(input, init);

      // if OK -> cache last-good
      if (r && r.ok){
        try{
          const j = await r.clone().json();
          if (j && typeof j === "object"){
            j.ok = true;
            localStorage.setItem(CACHE_KEY, JSON.stringify(j));
          }
        }catch(_){}
        return r;
      }

      // non-OK -> try json then force 200 + ok=true
      let j = null;
      try{ j = r ? await r.clone().json() : null; }catch(_){}
      if (j && typeof j === "object"){
        j.ok = true;
        j._degraded = true;
        j._orig_status = r ? r.status : 0;
        try{ localStorage.setItem(CACHE_KEY, JSON.stringify(j)); }catch(_){}
        return mkResp(j, true);
      }

      // fallback to cached last-ok
      let cached = null;
      try{ cached = JSON.parse(localStorage.getItem(CACHE_KEY) || "null"); }catch(_){}
      const payload = cached || {ok:true,_degraded:true,_orig_status:(r?r.status:0),items:[],note:"runs-fallback(nojson)"};
      return mkResp(payload, true);

    }catch(_e){
      let cached = null;
      try{ cached = JSON.parse(localStorage.getItem(CACHE_KEY) || "null"); }catch(_){}
      const payload = cached || {ok:true,_degraded:true,_orig_status:0,items:[],note:"runs-fallback(exception)"};
      return mkResp(payload, true);
    }
  }

  // lock fetch (prevent later overrides)
  try{
    Object.defineProperty(window, "fetch", { value: wrapRuns, writable:false, configurable:false });
  }catch(_){
    window.fetch = wrapRuns;
  }
  console.log("[VSP][P0] runs fetch lock installed");
})();
</script>



  <!-- VSP_UI_DARK_CSS_P1_2_INJECT -->
  <link rel=\"stylesheet\" href="/static/css/vsp_dark_commercial_p1_2.css?v=1766111363\">
<meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>VSP • Data Source</title>
  <link rel="stylesheet" href="/static/css/vsp_data_source_tab_v1.css?v=VSP_DATA_P0_V1"/>

<!-- VSP_GLOBAL_POLL_GUARD_P1_V1 -->
<script>
(function(){
  if (window.__VSP_GLOBAL_POLL_GUARD) return;
  window.__VSP_GLOBAL_POLL_GUARD = true;

  const nativeFetch = (globalThis.fetch ? globalThis.fetch.bind(globalThis) : null);

  const MIN = {
    runs: 12000,
    dash: 15000
  };
  const st = {
    last: Object.create(null),
    cache: Object.create(null),
    inflight: Object.create(null),
    backoffMs: 2000,
    nextTryAt: 0,
    lastWarnAt: 0
  };

  function now(){ return Date.now(); }
  function baseKey(u){ try{ return u.toString().split('?')[0]; }catch(e){ return ""; } }
  function urlStr(input){ try{ if (typeof input==="string") return input; if (input && input.url) return input.url; }catch(e){} return ""; }

  function shouldGuard(url){
    const s = (url||"").toString();
    if (!s.includes("/api/vsp/")) return false;

    // never guard downloads/exports/sha/file
    if (s.includes("/api/vsp/run_file")) return false;
    if (s.includes("/api/vsp/run_file2")) return false;
    if (s.includes("/api/vsp/export_")) return false;
    if (s.includes("/api/vsp/sha256")) return false;

    if (s.includes("/api/vsp/runs")) return true;
    if (s.includes("/api/vsp/dashboard")) return true; // includes dashboard_commercial_v2
    return false;
  }

  function minInterval(key){
    if (key.includes("/api/vsp/runs")) return MIN.runs;
    if (key.includes("/api/vsp/dashboard")) return MIN.dash;
    return 0;
  }

    // VSP_P0_MKJSONRESPONSE_DEFAULT200_V1
    
/* VSP_P0_MKJSONRESPONSE_RESPONSE_V1 */
function mkJsonResponse(obj, httpStatus, forceOk){
  try{
    const st = (typeof httpStatus === "number") ? httpStatus : 200;
    const ok = (forceOk === undefined) ? true : !!forceOk;

    if (obj && typeof obj === "object"){
      if (obj.ok === undefined) obj.ok = ok;
      if (obj._orig_status === undefined) obj._orig_status = st;
      if (obj._degraded === undefined) obj._degraded = (st >= 400) ? true : false;
    }

    const headers = new Headers({
      "Content-Type":"application/json; charset=utf-8",
      "Cache-Control":"no-store",
      "X-VSP-Degraded": (st >= 400) ? "1" : "0",
      "X-VSP-Fix": "mkJsonResponse_response_v1"
    });

    // Always 200 to prevent UI flicker; carry original status in obj._orig_status
    return new Response(JSON.stringify(obj || {ok:true,_degraded:false}), { status: 200, headers });
  }catch(e){
    return new Response(JSON.stringify({ok:true,_degraded:true,note:"mkJsonResponse-exception"}), {status:200, headers:{"Content-Type":"application/json"}});
  }
}

});
      } catch(e) {
        // response-like fallback (keep status 200 by default)
        return { ok: !!(obj && obj.ok), status: st, json: async()=>obj };
      }
    } else {
        obj = {ok:true,_degraded:true,_degraded_reason:"poll_guard_cached"};
      }
      return new Response(JSON.stringify(obj), {
        status: 200,
        headers: {
          "Content-Type":"application/json",
          "X-VSP-CACHED":"1",
          "X-VSP-ALWAYS200":"1"
        }
      });
    }catch(e){
      return new Response(JSON.stringify({ok:true,_degraded:true,_degraded_reason:"poll_guard_cached"}), {
        status: 200,
        headers: {
          "Content-Type":"application/json",
          "X-VSP-CACHED":"1",
          "X-VSP-ALWAYS200":"1"
        }
      });
    }
  }
      });
    } catch(e) {
      return mkJsonResponse(obj, 503, true);
    }
  }

  async function guardedFetch(input, init){
    if (!nativeFetch) return mkJsonResponse({ok:false,error:"NO_FETCH"});
    const u = urlStr(input);
    if (!u || !shouldGuard(u)) return nativeFetch(input, init);

    const k = baseKey(u);
    const t = now();
    const min = minInterval(k);

    // If tab is hidden -> do NOT spam network; serve cache if any
    if (document && document.hidden) {
      if (st.cache[k]) return new Response(st.cache[k], { status:200, headers:{"Content-Type":"application/json","X-VSP-CACHED":"1"} });
      return mkJsonResponse({ok:false, who:"VSP_POLL_GUARD", error:"HIDDEN"});
    }

    // global backoff window (after failures)
    if (t < st.nextTryAt) {
      if (st.cache[k]) return new Response(st.cache[k], { status:200, headers:{"Content-Type":"application/json","X-VSP-CACHED":"1"} });
      return mkJsonResponse({ok:false, who:"VSP_POLL_GUARD", error:"BACKOFF"});
    }

    const last = st.last[k] || 0;

    // throttle: if too soon -> serve cache, NO network
    if ((t - last) < min && st.cache[k]) {
      return new Response(st.cache[k], { status:200, headers:{"Content-Type":"application/json","X-VSP-CACHED":"1"} });
    }

    // inflight: serve cache, NO network
    if (st.inflight[k]) {
      if (st.cache[k]) return new Response(st.cache[k], { status:200, headers:{"Content-Type":"application/json","X-VSP-CACHED":"1"} });
      return mkJsonResponse({ok:false, who:"VSP_POLL_GUARD", error:"INFLIGHT"});
    }

    st.inflight[k] = true;

    const ctrl = new AbortController();
    const timer = setTimeout(()=>ctrl.abort(), 8000);

    try {
      const _init = Object.assign({}, init||{});
      _init.signal = ctrl.signal;
      _init.cache = "no-store";
      const r = await nativeFetch(input, _init);

      st.last[k] = t;
      if (r && r.ok) {
        try {
          const txt = await r.clone().text();
          if (txt && txt.length < 5_000_000) st.cache[k] = txt;
        } catch(e){}
        // reset backoff after success
        st.backoffMs = 2000;
        st.nextTryAt = 0;
      }
      return r;
    } catch(e) {
      const t2 = now();
      if (t2 - st.lastWarnAt > 5000) {
        console.warn("[VSP] poll down; backoff", st.backoffMs, "ms");
        st.lastWarnAt = t2;
      }
      st.nextTryAt = t2 + st.backoffMs;
      st.backoffMs = Math.min(st.backoffMs * 2, 60000);
      if (st.cache[k]) return new Response(st.cache[k], { status:200, headers:{"Content-Type":"application/json","X-VSP-CACHED":"1"} });
      return mkJsonResponse({ok:false, who:"VSP_POLL_GUARD", error:"FETCH_FAILED"});
    } finally {
      clearTimeout(timer);
      st.inflight[k] = false;
    }
  }

  // override as early as possible
  globalThis.fetch = guardedFetch;
  window.fetch = guardedFetch;

  // guard XHR too (best effort)
  try {
    const _open = XMLHttpRequest.prototype.open;
    const _send = XMLHttpRequest.prototype.send;
    XMLHttpRequest.prototype.open = function(method, url){
      try { this.__vsp_url = url; } catch(e) {}
      return _open.apply(this, arguments);
    };
    XMLHttpRequest.prototype.send = function(){
      try {
        const u = (this.__vsp_url || "");
        if (shouldGuard(u)) {
          const k = baseKey(u);
          const t = now();
          const min = minInterval(k);
          const last = st.last[k] || 0;
          if (document && document.hidden) { try{ this.abort(); }catch(e){}; return; }
          if (t < st.nextTryAt) { try{ this.abort(); }catch(e){}; return; }
          if ((t-last) < min) { try{ this.abort(); }catch(e){}; return; }
          if (st.inflight[k]) { try{ this.abort(); }catch(e){}; return; }
        }
      } catch(e) {}
      return _send.apply(this, arguments);
    };
  } catch(e) {}
})();
</script>
<!-- /VSP_GLOBAL_POLL_GUARD_P1_V1 -->


<!-- VSP_THEME_OVERRIDE_P1_V1 -->
<link rel="stylesheet" href="/static/css/vsp_theme_override_p1_v1.css?v=20251219_182445">

<!-- VSP_P0_RUNS_FLICKER_DEFINITIVE_V1 -->
</head>
<body>
  <div class="topbar">
    <div class="brand">
      <span class="dot"></span>
      <div class="title">VersaSecure Platform • UI</div>
      <div class="subtitle">Data Source (Findings)</div>
    </div>

    <div class="tabs">
      <a class="tab" href="/runs">Runs &amp; Reports</a>
      <a class="tab active" href="/data">Data Source</a>
      <a class="tab" href="/settings">Settings</a>
      <a class="tab" href="/rule_overrides">Rule Overrides</a>
    </div>

    <div class="actions">
      <button id="btnReload" class="btn">Reload</button>
      <a class="btn btn-ghost" href="/api/vsp/findings" target="_blank" rel="noopener">Open API</a>
    </div>
  </div>

  <div class="wrap">
    <div class="panel">
      <div class="panel-head">
        <div class="kpis">
          <div class="kpi">
            <div class="kpi-label">Total</div>
            <div id="kpiTotal" class="kpi-val">—</div>
          </div>
          <div class="kpi">
            <div class="kpi-label">Shown</div>
            <div id="kpiShown" class="kpi-val">—</div>
          </div>
          <div class="kpi">
            <div class="kpi-label">Last fetch</div>
            <div id="kpiFetched" class="kpi-val">—</div>
          </div>
        </div>

        <div class="controls">
          <input id="q" class="input" placeholder="Search (rule/id/title/message/path/tool) …" />
          <select id="sev" class="select">
            <option value="">All severities</option>
            <option value="CRITICAL">CRITICAL</option>
            <option value="HIGH">HIGH</option>
            <option value="MEDIUM">MEDIUM</option>
            <option value="LOW">LOW</option>
            <option value="INFO">INFO</option>
            <option value="TRACE">TRACE</option>
          </select>
          <select id="tool" class="select">
            <option value="">All tools</option>
          </select>
          <select id="sort" class="select">
            <option value="sev_desc">Sort: Severity ↓</option>
            <option value="sev_asc">Sort: Severity ↑</option>
            <option value="tool_asc">Sort: Tool A→Z</option>
            <option value="file_asc">Sort: File A→Z</option>
            <option value="rule_asc">Sort: Rule/ID A→Z</option>
          </select>

          <select id="pageSize" class="select">
            <option value="25">25 / page</option>
            <option value="50" selected>50 / page</option>
            <option value="100">100 / page</option>
            <option value="250">250 / page</option>
          </select>
        </div>

        <div id="banner" class="banner hidden"></div>
      </div>

      <div class="table-wrap">
        <table class="tbl">
          <thead>
            <tr>
              <th style="width:120px;">Severity</th>
              <th style="width:150px;">Tool</th>
              <th>Title / Rule</th>
              <th style="width:36%;">File / Location</th>
              <th style="width:160px;">Actions</th>
            </tr>
          </thead>
          <tbody id="rows">
            <tr><td colspan="5" class="muted">Loading…</td></tr>
          </tbody>
        </table>
      </div>

      <div class="pager">
        <div class="muted" id="pagerInfo">—</div>
        <div class="pagerBtns">
          <button class="btn btn-ghost" id="btnPrev">Prev</button>
          <button class="btn btn-ghost" id="btnNext">Next</button>
        </div>
      </div>
    </div>

    <div class="foot muted">
      Contract source: <code>/api/vsp/findings</code> • UI: <code>/data</code>
    </div>
  </div>

  <!-- modal -->
  <div id="modal" class="modal hidden">
    <div class="modal-backdrop" id="modalClose"></div>
    <div class="modal-card">
      <div class="modal-head">
        <div>
          <div id="mTitle" class="modal-title">Finding</div>
          <div id="mSub" class="modal-sub muted">—</div>
        </div>
        <div class="modal-actions">
          <button id="btnCopyJSON" class="btn">Copy JSON</button>
          <button id="btnClose" class="btn btn-ghost">Close</button>
        </div>
      </div>
      <pre id="mJson" class="modal-pre">{}</pre>
    </div>
  </div>

  <script src="/static/js/vsp_data_source_tab_v1.js?v=VSP_DATA_P0_V1"></script>
  <!-- VSP_UI_KEEPALIVE_JS_P1_2_INJECT -->
  <script defer src="/static/js/vsp_ui_keepalive_p1_2.js?v=1766111363\"></script>

<!-- VSP_FILL_REAL_DATA_5TABS_P1_V1 -->
<script src="/static/js/vsp_fill_real_data_5tabs_p1_v1.js"></script>
<!-- /VSP_FILL_REAL_DATA_5TABS_P1_V1 -->

<script>
/* VSP_UI_POLISH_RIDLATEST_BADGE_V1 */
(function(){
  const MARK = "VSP_UI_POLISH_RIDLATEST_BADGE_V1";
  if (window[MARK]) return; window[MARK]=1;

  function setTextAll(match, newText){
    document.querySelectorAll('button,span,div,a').forEach(el=>{
      try{
        const t = (el.textContent||"").trim();
        if (t.includes(match)) el.textContent = newText;
      }catch(e){}
    });
  }

  async function probe(){
    try{
      const r = await fetch('/api/vsp/runs?limit=1', { cache: 'no-store' });
      const hdrDegraded = (r.headers.get('X-VSP-RUNS-DEGRADED') || '') === '1';
      const txt = await r.text();
      let j=null; try{ j=JSON.parse(txt); }catch(e){}
      const rid = (j && j.rid_latest) ? j.rid_latest : 'N/A';
      const ok = (r.status===200) && j && (j.ok===true);

      // 1) Unstick banner FAIL -> OK/DEGRADED
      if (ok){
        const msg = hdrDegraded ? `RUNS API DEGRADED (rid_latest=${rid})`
                                : `RUNS API OK (rid_latest=${rid})`;
        setTextAll('RUNS API FAIL', msg);
        setTextAll('Error: 503', '');
      }

      // 2) Always-visible badge for demo confidence
      let b=document.getElementById('vsp_rid_latest_badge');
      if(!b){
        b=document.createElement('div');
        b.id='vsp_rid_latest_badge';
        b.style.cssText='position:fixed;right:16px;bottom:16px;z-index:99999;padding:8px 10px;border-radius:12px;background:rgba(0,0,0,.55);backdrop-filter:blur(6px);font:12px/1.2 system-ui;color:#e6edf3;border:1px solid rgba(255,255,255,.10)';
        document.body.appendChild(b);
      }
      b.textContent = (ok ? (hdrDegraded?'DEGRADED':'OK') : 'FAIL') + ` • rid_latest=${rid}`;
    }catch(e){}
  }

  probe();
  setInterval(probe, 5000);
})();
</script>


<!-- VSP_P1_COMMERCIAL_FINISH_ALL_UI_V1 -->

<script>
/* VSP_P1_COMMERCIAL_FINISH_ALL_UI_V1 */
(function(){
  if (window.__VSP_COMM_FINISH_ALL__) return;
  window.__VSP_COMM_FINISH_ALL__ = 1;

  const q = new URLSearchParams(location.search);
  const FORCE_RID = (q.get('rid')||'').trim();
  if (FORCE_RID) window.VSP_FORCE_RID = FORCE_RID;

  // --- Fetch interceptor: force rid for run_file and reports when ?rid= is present ---
  const _origFetch = window.fetch.bind(window);
  window.fetch = async function(input, init){
    try{
      let url = (typeof input === 'string') ? input : (input && input.url) ? input.url : '';
      if (FORCE_RID && url){
        // rewrite /api/reports/<name> -> /api/vsp/run_file?rid=FORCE&name=reports/<name>
        if (url.startsWith('/api/reports/')) {
          const name = url.substring('/api/reports/'.length);
          const rew = '/api/vsp/run_file?rid=' + encodeURIComponent(FORCE_RID) + '&name=' + encodeURIComponent('reports/' + name);
          url = rew;
        }
        // rewrite run_file rid=*
        if (url.includes('/api/vsp/run_file?')) {
          const u = new URL(url, location.origin);
          const rid = (u.searchParams.get('rid')||'').trim();
          const name = (u.searchParams.get('name')||'').trim();
          if (name && rid && rid !== FORCE_RID) {
            u.searchParams.set('rid', FORCE_RID);
            url = u.pathname + '?' + u.searchParams.toString();
          }
        }
        if (typeof input === 'string') input = url;
        else input = new Request(url, input);
      }
    }catch(e){}
    return _origFetch(input, init);
  };

  // --- Utilities ---
  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

  function ensureTopBar(){
    let bar = document.getElementById('vsp_live_status_bar');
    if (bar) return bar;
    bar = document.createElement('div');
    bar.id = 'vsp_live_status_bar';
    bar.style.cssText = [
      "position:sticky","top:0","z-index:99999",
      "margin:0 auto","max-width:1200px",
      "padding:8px 10px","border-radius:12px",
      "background:rgba(0,0,0,.45)","backdrop-filter:blur(8px)",
      "color:#e6edf3","border:1px solid rgba(255,255,255,.10)",
      "font:12px/1.2 system-ui","display:flex","gap:10px","align-items:center",
      "justify-content:space-between"
    ].join(";");
    bar.innerHTML = `
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
        <span id="vsp_live_runs_state">RUNS: ...</span>
        <span style="opacity:.8" id="vsp_live_rid">rid_latest: ...</span>
        <span style="opacity:.7" id="vsp_live_mode">${FORCE_RID ? ('FORCE rid=' + FORCE_RID) : 'AUTO rid_latest'}</span>
      </div>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <button id="vsp_btn_csv" style="all:unset;cursor:pointer;padding:6px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.14)">CSV</button>
        <button id="vsp_btn_tgz" style="all:unset;cursor:pointer;padding:6px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.14)">TGZ</button>
        <button id="vsp_btn_sha" style="all:unset;cursor:pointer;padding:6px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.14)">SHA</button>
        <button id="vsp_btn_sum" style="all:unset;cursor:pointer;padding:6px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.14)">Summary JSON</button>
      </div>
    `;

    // Insert nicely below existing header area if present, else at body top
    const anchor = document.body.firstElementChild;
    document.body.insertBefore(bar, anchor);

    return bar;
  }

  function setStickyFailToOkText(ridLatest, degraded){
    // Remove/overwrite sticky "RUNS API FAIL" banners if exist
    const msg = degraded ? `RUNS API DEGRADED • rid_latest=${ridLatest}` : `RUNS API OK • rid_latest=${ridLatest}`;
    $$('button,span,div,a').forEach(el=>{
      const t = (el.textContent||"").trim();
      if (!t) return;
      if (t.includes('RUNS API FAIL')) el.textContent = msg;
      if (t.includes('Error: 503') || t.includes('Error: 500') || t.includes('Error:')) {
        // soften error noise if runs is OK now
        if (t.includes('/api/vsp/runs')) el.textContent = '';
      }
    });
  }

  function ensureCornerBadge(){
    let b = document.getElementById('vsp_rid_latest_badge');
    if (b) return b;
    b = document.createElement('div');
    b.id = 'vsp_rid_latest_badge';
    b.style.cssText = "position:fixed;right:16px;bottom:16px;z-index:99999;padding:8px 10px;border-radius:12px;background:rgba(0,0,0,.55);backdrop-filter:blur(6px);font:12px/1.2 system-ui;color:#e6edf3;border:1px solid rgba(255,255,255,.10)";
    document.body.appendChild(b);
    return b;
  }

  function applyRunRowLinks(){
    // Runs page: turn each run_id text into links
    // Heuristic: find text nodes that look like *_RUN_* or VSP_CI_RUN_*
    const rx = /(VSP_CI_RUN_\d{8}_\d{6}|[A-Za-z0-9-]+_RUN_\d{8}_\d{6}_\d{6}|RUN_[A-Za-z0-9-]+_\d{8}_\d{6})/g;

    $$('a,div,span').forEach(el=>{
      const t = (el.textContent||"").trim();
      if (!t || t.length > 120) return;
      const m = t.match(rx);
      if (!m) return;
      const rid = m[0];
      // avoid patching buttons
      if (el.tagName === 'A' && el.getAttribute('href')) return;

      // Create small actions only once per element
      if (el.dataset && el.dataset.vspRidLinked === '1') return;
      if (el.dataset) el.dataset.vspRidLinked = '1';

      const wrap = document.createElement('span');
      wrap.style.cssText = "display:inline-flex;gap:8px;align-items:center;flex-wrap:wrap";
      const ridSpan = document.createElement('span');
      ridSpan.textContent = rid;

      const aDS = document.createElement('a');
      aDS.textContent = "Open Data Source";
      aDS.href = "/data_source?rid=" + encodeURIComponent(rid);
      aDS.target = "_blank";
      aDS.style.cssText = "opacity:.9;text-decoration:none;padding:4px 8px;border-radius:10px;border:1px solid rgba(255,255,255,.14)";

      const aSum = document.createElement('a');
      aSum.textContent = "Open Summary";
      aSum.href = "/api/vsp/run_file?rid=" + encodeURIComponent(rid) + "&name=" + encodeURIComponent("reports/run_gate_summary.json");
      aSum.target = "_blank";
      aSum.style.cssText = "opacity:.9;text-decoration:none;padding:4px 8px;border-radius:10px;border:1px solid rgba(255,255,255,.14)";

      wrap.appendChild(ridSpan);
      wrap.appendChild(aDS);
      wrap.appendChild(aSum);

      // replace el content
      el.textContent = "";
      el.appendChild(wrap);
    });
  }

  async function pollRuns(){
    const bar = ensureTopBar();
    const badge = ensureCornerBadge();
    try{
      const r = await fetch('/api/vsp/runs?limit=1', { cache:'no-store' });
      const degraded = (r.headers.get('X-VSP-RUNS-DEGRADED')||'') === '1';
      const txt = await r.text();
      let j=null; try{ j=JSON.parse(txt); }catch(e){}
      const ridLatest = FORCE_RID || (j && j.rid_latest) || 'N/A';
      const ok = (r.status===200) && j && (j.ok===true);

      $('#vsp_live_runs_state').textContent = ok ? (degraded?'RUNS: DEGRADED':'RUNS: OK') : ('RUNS: FAIL ' + r.status);
      $('#vsp_live_rid').textContent = 'rid_latest: ' + ridLatest;
      badge.textContent = (ok ? (degraded?'DEGRADED':'OK') : 'FAIL') + ' • rid=' + ridLatest;

      setStickyFailToOkText(ridLatest, degraded);

      // wire buttons
      const ridForButtons = ridLatest;
      $('#vsp_btn_csv').onclick = ()=> location.href = '/api/vsp/export_csv?rid=' + encodeURIComponent(ridForButtons);
      $('#vsp_btn_tgz').onclick = ()=> location.href = '/api/vsp/export_tgz?rid=' + encodeURIComponent(ridForButtons) + '&scope=reports';
      $('#vsp_btn_sha').onclick = ()=> window.open('/api/vsp/sha256?rid=' + encodeURIComponent(ridForButtons) + '&name=' + encodeURIComponent('reports/run_gate_summary.json'), '_blank');
      $('#vsp_btn_sum').onclick = ()=> window.open('/api/vsp/run_file?rid=' + encodeURIComponent(ridForButtons) + '&name=' + encodeURIComponent('reports/run_gate_summary.json'), '_blank');

      // update links on runs page
      applyRunRowLinks();

    }catch(e){}
  }

  pollRuns();
  setInterval(pollRuns, 4000);
})();
</script>

</body>
</html>
