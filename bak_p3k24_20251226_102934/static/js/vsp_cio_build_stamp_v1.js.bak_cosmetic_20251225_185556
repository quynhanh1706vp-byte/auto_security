(function(){
  "use strict";
  if (window.__VSP_CIO_BUILD_STAMP_V1) return;
  window.__VSP_CIO_BUILD_STAMP_V1 = true;

  function qs(sel, root){ try{return (root||document).querySelector(sel);}catch(_e){return null;} }
  function ce(tag){ return document.createElement(tag); }
  function txt(s){ return document.createTextNode(String(s||"")); }

  function getRid(){
    try{
      if (window.__vspGetRid) return (window.__vspGetRid()||"").trim();
      return (new URLSearchParams(location.search).get("rid")||"").trim();
    }catch(_e){ return ""; }
  }

  async function fetchBuildHeaders(rid){
    // use an API that already returns X-VSP-RELEASE-* headers in your stack
    const url = "/api/vsp/findings_page_v3?rid=" + encodeURIComponent(rid||"") + "&limit=1&offset=0";
    const r = await fetch(url, { credentials: "same-origin", cache: "no-store" });
    const h = r.headers;
    return {
      rel_ts:  h.get("X-VSP-RELEASE-TS")  || "",
      rel_sha: h.get("X-VSP-RELEASE-SHA") || "",
      rel_pkg: h.get("X-VSP-RELEASE-PKG") || "",
      asset_v: h.get("X-VSP-ASSET-V")     || "",
      code:    r.status
    };
  }

  function shortSha(s){
    s = (s||"").trim();
    return s.length > 12 ? s.slice(0,12) : s;
  }

  function ensureStampHost(){
    // Try common topbar containers; fallback to body
    const host =
      qs("#vsp-topbar") ||
      qs(".vspTopbar") ||
      qs("header") ||
      qs("body");
    if (!host) return null;

    // Avoid duplicates
    if (qs("#vsp-cio-build-stamp")) return qs("#vsp-cio-build-stamp");

    const wrap = ce("div");
    wrap.id = "vsp-cio-build-stamp";
    wrap.style.cssText = [
      "display:flex",
      "align-items:center",
      "gap:10px",
      "margin-left:auto",
      "padding:6px 10px",
      "border-radius:10px",
      "border:1px solid rgba(255,255,255,0.10)",
      "background:rgba(0,0,0,0.25)",
      "font:12px/1.2 ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,'Liberation Mono','Courier New',monospace",
      "color:rgba(255,255,255,0.85)"
    ].join(";");

    const label = ce("span");
    label.id = "vsp-cio-build-text";
    label.appendChild(txt("Build: …"));

    const copy = ce("button");
    copy.type = "button";
    copy.id = "vsp-cio-build-copy";
    copy.textContent = "Copy";
    copy.style.cssText = [
      "cursor:pointer",
      "border-radius:10px",
      "padding:6px 10px",
      "border:1px solid rgba(255,255,255,0.14)",
      "background:rgba(255,255,255,0.06)",
      "color:rgba(255,255,255,0.9)",
      "font:12px ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,'Liberation Mono','Courier New',monospace"
    ].join(";");

    copy.addEventListener("click", async function(){
      try{
        const t = (label.textContent||"").trim();
        await navigator.clipboard.writeText(t);
        copy.textContent = "Copied";
        setTimeout(()=>{ copy.textContent="Copy"; }, 900);
      }catch(_e){
        copy.textContent = "NoClip";
        setTimeout(()=>{ copy.textContent="Copy"; }, 900);
      }
    });

    wrap.appendChild(label);
    wrap.appendChild(copy);

    // Prefer append into topbar row if exists, else host
    try{
      host.appendChild(wrap);
    }catch(_e){
      try{ (document.body||host).appendChild(wrap); }catch(_e2){}
    }
    return wrap;
  }

  async function main(){
    const host = ensureStampHost();
    if (!host) return;

    const label = qs("#vsp-cio-build-text") || host;
    const rid = getRid();

    // show instantly
    label.textContent = "RID: " + (rid || "(none)") + " • Build: …";

    let meta = null;
    try{
      meta = await fetchBuildHeaders(rid);
    }catch(e){
      label.textContent = "RID: " + (rid||"(none)") + " • Build: (api fail)";
      return;
    }

    const parts = [];
    parts.push("RID: " + (rid||"(none)"));
    if (meta.rel_ts)  parts.push("rel=" + meta.rel_ts);
    if (meta.rel_sha) parts.push("sha=" + shortSha(meta.rel_sha));
    if (meta.asset_v) parts.push("asset=" + meta.asset_v);
    if (!meta.rel_ts && !meta.rel_sha && !meta.asset_v) parts.push("code=" + String(meta.code||""));

    label.textContent = parts.join(" • ");
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", ()=>{ main(); }, { once:true });
  } else {
    main();
  }
})();
