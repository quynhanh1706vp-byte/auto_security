(function(){try{if(window.__VSP_PIN_BADGE_V1)return;var s=document.createElement("script");s.src="/static/js/vsp_pin_dataset_badge_v1.js?v="+Date.now();document.head.appendChild(s);}catch(e){}})();

// VSP_BADGEPIN_V2_LOADER
(function(){
  try{
    if (window.__VSP_BADGEPIN_V2_LOADER) return;
    window.__VSP_BADGEPIN_V2_LOADER = true;
    var id="vsp-pin-dataset-badge-v2";
    if (document.getElementById(id)) return;
    var sc=document.createElement("script");
    sc.id=id;
    sc.src="/static/js/vsp_pin_dataset_badge_v2.js?v=" + (window.__VSP_ASSET_V || Date.now());
    sc.async=true;
    sc.defer=true;
    (document.head||document.documentElement).appendChild(sc);
  }catch(e){}
})();

// === CIO: hard-block luxe outside /vsp5 (AUTO) ===
(function(){
  try{
    if (location && location.pathname && location.pathname !== "/vsp5") {
      // remove any luxe script tag if already present
      document.querySelectorAll('script[src*="vsp_dashboard_luxe_v1.js"]').forEach(s=>{ try{s.remove();}catch(e){} });
      // block future injection attempts
      const _origAppend = Element.prototype.appendChild;
      Element.prototype.appendChild = function(node){
        try{
          if (node && node.tagName === "SCRIPT" && node.src && node.src.includes("vsp_dashboard_luxe_v1.js")) {
            return node; // drop
          }
        }catch(e){}
        return _origAppend.call(this, node);
      };
    }
  }catch(e){}
})();
 // === END CIO hard-block luxe ===
/* VSP_P2_JS_ASSET_V_PINNED_V1 */
(function(){
  try {
    if (!window.__VSP_ASSET_V) window.__VSP_ASSET_V = "20251224_122204";
  } catch(e) {}
})();
function __vspAssetV(){
  try {
    return (window.__VSP_ASSET_V || "20251224_122204");
  } catch(e) {
    return "20251224_122204";
  }
}

/* VSP_P2_TREND_PATH_FORCE_V2 */
/* ===================== VSP_P0_FETCH_CACHE_DEDUPE_V1K =====================
   Purpose: reduce XHR spam by caching/deduping a few hot JSON endpoints at FE layer.
   Targets: /api/vsp/rid_latest, /api/vsp/rid_latest_gate_root, /api/vsp/release_latest
   Notes: strips ts= query param; TTL default 30s; dedup in-flight; returns Response(JSON).
========================================================================= */

/* ===================== VSP_P0_GLOBAL_FETCH_CACHE_DEDUPE_V1N5 =====================
   Goal: reduce XHR spam by dedupe+TTL cache across ALL FE modules (single place).
   - Dedupe inflight identical GETs (same normalized URL)
   - TTL cache hot endpoints (rid_latest, release_latest, runs, dashboard, gate summary, trend, top_findings)
   - Strip noisy ts= and sort query params for stable keys
=============================================================================== */
(function(){
  try{
    if (window.__VSP_FETCHCACHE_V1N5__) return;
    window.__VSP_FETCHCACHE_V1N5__ = true;

    const _fetch = window.fetch ? window.fetch.bind(window) : null;
    if (!_fetch) return;

    const now = ()=> Date.now();
    const inflight = new Map(); // key -> Promise(entry)
    const cache = new Map();    // key -> { exp, status, headers, text }

    function normUrl(input){
      try{
        const u = (input instanceof URL) ? input : new URL(String(input), location.origin);
        if (u.origin !== location.origin) return null;

        // strip cache-busters
        u.searchParams.delete("ts");
        u.searchParams.delete("_ts");
        u.searchParams.delete("__ts");

        // sort params for stable key
        const keys = Array.from(u.searchParams.keys()).sort();
        const pairs = [];
        for(const k of keys){
          const vals = u.searchParams.getAll(k);
          for(const v of vals){
            pairs.push([k, v]);
          }
        }
        u.search = "";
        for(const [k,v] of pairs){
          u.searchParams.append(k, v);
        }
        return u.pathname + (u.search ? u.search : "");
      }catch(e){
        return null;
      }
    }

    function ttlFor(pathq){
      try{
        const path = (pathq||"").split("?")[0] || "";
        // HOT endpoints: cap spam hard
        if (path === "/api/vsp/rid_latest") return 30000;
        if (path === "/api/vsp/rid_latest_gate_root") return 30000;
        if (path === "/api/vsp/release_latest") return 60000;
        if (path === "/api/vsp/runs") return 30000;

        if (path === "/api/vsp/dashboard_v3") return 12000;
        if (path === "/api/vsp/run_gate_summary_v1") return 12000;

        if (path === "/api/vsp/trend_v1?path=") return 15000;
        if (path === "/api/vsp/top_findings_v1") return 15000;

        // Findings paging is noisy/variable => do NOT global-cache it by default
        if (path.startsWith("/api/vsp/findings_page_")) return 0;

        return 0;
      }catch(e){ return 0; }
    }

    function headersToObj(h){
      const o = {};
      try{
        if (!h || !h.forEach) return o;
        h.forEach((v,k)=>{ o[k]=v; });
      }catch(e){}
      return o;
    }
    function objToHeaders(o){
      const h = new Headers();
      try{
        for(const k in (o||{})) h.set(k, String(o[k]));
      }catch(e){}
      return h;
    }

    async function fetchAndStore(key, input, init, ttl){
      const r = await _fetch(input, init);
      try{
        const clone = r.clone();
        const text = await clone.text();
        const ent = { exp: now()+ttl, status: r.status, headers: headersToObj(r.headers), text };
        cache.set(key, ent);
        return ent;
      }catch(e){
        // If we can't read body, still don't break callers
        return { exp: now()+ttl, status: r.status, headers: headersToObj(r.headers), text: "" };
      }
    }

    window.fetch = function(input, init){
      try{
        const method = ((init && init.method) ? String(init.method) : "GET").toUpperCase();
        if (method !== "GET") return _fetch(input, init);

        const key = normUrl(input);
        if (!key) return _fetch(input, init);

        const ttl = ttlFor(key);
        if (!ttl) return _fetch(input, init);

        const c = cache.get(key);
        if (c && c.exp > now()){
          // serve from cache
          return Promise.resolve(new Response(c.text, { status: c.status, headers: objToHeaders(c.headers) }));
        }

        const inf = inflight.get(key);
        if (inf){
          return inf.then(ent => new Response(ent.text, { status: ent.status, headers: objToHeaders(ent.headers) }));
        }

        const prom = fetchAndStore(key, input, init, ttl)
          .finally(()=>{ try{ inflight.delete(key); }catch(e){} });
        inflight.set(key, prom);

        // Caller gets real network response (not cached one) to preserve streaming semantics.
        // But to keep it simple and consistent, return a cloned Response built from stored entry.
        return prom.then(ent => new Response(ent.text, { status: ent.status, headers: objToHeaders(ent.headers) }));
      }catch(e){
        return _fetch(input, init);
      }
    };

  }catch(e){}
})(); 
/* ===================== /VSP_P0_GLOBAL_FETCH_CACHE_DEDUPE_V1N5 ===================== */

/* ===================== VSP_P0_FE_REQ_COUNTER_V1N5B =====================
   Lightweight request telemetry for commercial audit (no server access log needed).
   Use in DevTools console:
     __vspReqTop(10)  // top endpoints in last 10 seconds
     __vspReqClear()
============================================================================ */
(function(){
  try{
    if (window.__VSP_REQ_COUNTER_V1N5B__) return;
    window.__VSP_REQ_COUNTER_V1N5B__ = true;

    window.__VSP_REQ_LOG = window.__VSP_REQ_LOG || [];
    function norm(u){
      try{
        const x = new URL(String(u), location.origin);
        if (x.origin !== location.origin) return null;
        if (!x.pathname.startsWith("/api/vsp/")) return null;
        x.searchParams.delete("ts"); x.searchParams.delete("_ts"); x.searchParams.delete("__ts");
        // keep rid but normalize ordering
        const keys = Array.from(x.searchParams.keys()).sort();
        const pairs=[];
        for(const k of keys){
          const vals=x.searchParams.getAll(k);
          for(const v of vals) pairs.push([k,v]);
        }
        x.search="";
        for(const [k,v] of pairs) x.searchParams.append(k,v);
        return x.pathname + (x.search?x.search:"");
      }catch(e){ return null; }
    }

    const _fetch = window.fetch ? window.fetch.bind(window) : null;
    if (!_fetch) return;

    window.fetch = function(input, init){
      try{
        const method = ((init&&init.method)?String(init.method):"GET").toUpperCase();
        const key = norm(input);
        if (key){
          window.__VSP_REQ_LOG.push({ t: Date.now(), m: method, u: key });
          // cap memory
          if (window.__VSP_REQ_LOG.length > 2000) window.__VSP_REQ_LOG.splice(0, 500);
        }
      }catch(e){}
      return _fetch(input, init);
    };

    window.__vspReqClear = function(){ try{ window.__VSP_REQ_LOG = []; }catch(e){} };

    window.__vspReqTop = function(seconds){
      try{
        const sec = Math.max(1, Number(seconds||10));
        const cut = Date.now() - sec*1000;
        const arr = (window.__VSP_REQ_LOG||[]).filter(x=>x && x.t>=cut);
        const m = new Map();
        for(const x of arr){
          const k = x.u;
          m.set(k, (m.get(k)||0)+1);
        }
        const out = Array.from(m.entries()).sort((a,b)=>b[1]-a[1]).slice(0,25);
        console.log("[VSP_REQ_TOP]", { window_sec: sec, total: arr.length });
        for(const [k,c] of out) console.log(String(c).padStart(4," "), k);
        return out;
      }catch(e){
        console.warn("[VSP_REQ_TOP] error", e);
        return [];
      }
    };

  }catch(e){}
})(); 
/* ===================== /VSP_P0_FE_REQ_COUNTER_V1N5B ===================== */


/* ===================== VSP_P0_SINGLEFLIGHT_HELPER_V1N7 =====================
   window.__vspSF(url, ttlMs): single-flight + TTL JSON cache for hot endpoints.
============================================================================ */
(function(){
  try{
    if (window.__VSP_SF_V1N7__) return;
    window.__VSP_SF_V1N7__ = true;
    const inflight = new Map(); // url -> Promise
    const cache = new Map();    // url -> { exp, val }
    function now(){ return Date.now(); }
    window.__vspSF = async function(url, ttlMs){
      const ttl = Math.max(0, Number(ttlMs||0));
      const key = String(url||"");
      const c = cache.get(key);
      if (c && c.exp > now()) return c.val;
      const inf = inflight.get(key);
      if (inf) return await inf;
      const prom = (async ()=>{
        const r = await fetch(key, { credentials:"same-origin" });
        if (!r.ok) throw new Error("HTTP "+r.status+" for "+key);
        const j = await r.json();
        if (ttl) cache.set(key, { exp: now()+ttl, val: j });
        return j;
      })().finally(()=>{ try{ inflight.delete(key); }catch(e){} });
      inflight.set(key, prom);
      return await prom;
    };
  }catch(e){}
})(); 
/* ===================== /VSP_P0_SINGLEFLIGHT_HELPER_V1N7 ===================== */






(function(){
  try{
    if (window.__VSP_FETCH_CACHE_DEDUPE_V1K__) return;
    window.__VSP_FETCH_CACHE_DEDUPE_V1K__ = true;

    const TTL_MS = 30 * 1000;
    const cache = new Map();     // key -> {ts, status, json}
    const inflight = new Map();  // key -> Promise<{status,json}>

    function isSameOrigin(u){
      try{ return (new URL(u, location.origin)).origin === location.origin; }
      catch(e){ return false; }
    }
    function normUrl(u){
      try{
        const url = new URL(u, location.origin);
        if (url.searchParams.has("ts")) url.searchParams.delete("ts");
        return url.pathname + (url.search ? url.search : "");
      }catch(e){
        return String(u||"");
      }
    }
    function shouldCache(u){
      try{
        const url = new URL(u, location.origin);
        const p = url.pathname || "";
        if (!p.startsWith("/api/vsp/")) return false;
        return (
          p === "/api/vsp/rid_latest" ||
          p === "/api/vsp/rid_latest_gate_root" ||
          p === "/api/vsp/release_latest"
        );
      }catch(e){
        return false;
      }
    }
    function makeJsonResp(obj, status){
      try{
        return new Response(JSON.stringify(obj ?? {}), {
          status: status || 200,
          headers: { "Content-Type": "application/json; charset=utf-8" }
        });
      }catch(e){
        return new Response("{}", {status: status || 200, headers: {"Content-Type":"application/json"}});
      }
    }

    const origFetch = window.fetch.bind(window);
    window.fetch = function(resource, init){
      try{
        const method = ((init && init.method) || (resource && resource.method) || "GET").toUpperCase();
        const urlStr = (typeof resource === "string") ? resource : (resource && resource.url) ? resource.url : String(resource||"");
        if (method !== "GET") return origFetch(resource, init);
        if (!isSameOrigin(urlStr)) return origFetch(resource, init);
        if (!shouldCache(urlStr)) return origFetch(resource, init);

        const key = method + " " + normUrl(urlStr);
        const now = Date.now();

        const hit = cache.get(key);
        if (hit && (now - hit.ts) < TTL_MS){
          return Promise.resolve(makeJsonResp(hit.json, hit.status));
        }

        const inF = inflight.get(key);
        if (inF){
          return inF.then(r => makeJsonResp(r.json, r.status));
        }

        const pReq = origFetch(resource, init)
          .then(async (r) => {
            let j = {};
            try{ j = await r.clone().json(); }catch(e){ j = {}; }
            const pack = { status: r.status || 200, json: j };
            cache.set(key, { ts: Date.now(), status: pack.status, json: pack.json });
            return pack;
          })
          .finally(() => { try{ inflight.delete(key); }catch(e){} });

        inflight.set(key, pReq);
        return pReq.then(pack => makeJsonResp(pack.json, pack.status));
      }catch(e){
        return origFetch(resource, init);
      }
    };
  }catch(e){}
})(); 
/* ===================== /VSP_P0_FETCH_CACHE_DEDUPE_V1K ===================== */

/* ===================== VSP_P0_FETCH_CACHE_DEDUPE_V1K2 =====================
   Upgrade:
   - strip ts= for ALL /api/vsp/*
   - also cache rid-scoped heavy endpoints: dashboard_v3, run_gate_summary_v1 (TTL 12s)
========================================================================= */
(function(){
  try{
    if (!window.__VSP_FETCH_CACHE_DEDUPE_V1K__) return;
    if (window.__VSP_FETCH_CACHE_DEDUPE_V1K2__) return;
    window.__VSP_FETCH_CACHE_DEDUPE_V1K2__ = true;

    const TTL_HEAVY_MS = 12 * 1000;

    // Wrap fetch again but delegate to the already-wrapped fetch cache if present.
    const prevFetch = window.fetch.bind(window);

    function isSameOrigin(u){
      try{ return (new URL(u, location.origin)).origin === location.origin; }
      catch(e){ return false; }
    }
    function stripTsAll(u){
      try{
        const url = new URL(u, location.origin);
        if (url.pathname.startsWith("/api/vsp/") && url.searchParams.has("ts")) url.searchParams.delete("ts");
        return url.pathname + (url.search ? url.search : "");
      }catch(e){ return String(u||""); }
    }
    function isHeavy(u){
      try{
        const url = new URL(u, location.origin);
        if (!url.pathname.startsWith("/api/vsp/")) return false;
        return (url.pathname === "/api/vsp/dashboard_v3" || url.pathname === "/api/vsp/run_gate_summary_v1");
      }catch(e){ return false; }
    }

    const heavyCache = new Map();   // key -> {ts, status, json}
    const heavyIn = new Map();      // key -> Promise

    function makeJsonResp(obj, status){
      try{
        return new Response(JSON.stringify(obj ?? {}), {
          status: status || 200,
          headers: { "Content-Type": "application/json; charset=utf-8" }
        });
      }catch(e){
        return new Response("{}", {status: status || 200, headers: {"Content-Type":"application/json"}});
      }
    }

    window.fetch = function(resource, init){
      try{
        const method = ((init && init.method) || (resource && resource.method) || "GET").toUpperCase();
        const urlStr = (typeof resource === "string") ? resource : (resource && resource.url) ? resource.url : String(resource||"");
        if (method !== "GET") return prevFetch(resource, init);
        if (!isSameOrigin(urlStr)) return prevFetch(resource, init);

        const n = stripTsAll(urlStr);

        // Heavy rid-scoped cache
        if (isHeavy(urlStr)){
          const key = method + " " + n;
          const now = Date.now();
          const hit = heavyCache.get(key);
          if (hit && (now - hit.ts) < TTL_HEAVY_MS){
            return Promise.resolve(makeJsonResp(hit.json, hit.status));
          }
          const infl = heavyIn.get(key);
          if (infl){
            return infl.then(pack => makeJsonResp(pack.json, pack.status));
          }
          const pReq = prevFetch(n, init)
            .then(async (r)=>{
              let j = {};
              try{ j = await r.clone().json(); }catch(e){ j = {}; }
              const pack = {status: r.status || 200, json: j};
              heavyCache.set(key, {ts: Date.now(), status: pack.status, json: pack.json});
              return pack;
            })
            .finally(()=>{ try{ heavyIn.delete(key); }catch(e){} });
          heavyIn.set(key, pReq);
          return pReq.then(pack => makeJsonResp(pack.json, pack.status));
        }

        // For all /api/vsp/* just strip ts and delegate
        if (n !== urlStr && n.startsWith("/api/vsp/")){
          return prevFetch(n, init);
        }

        return prevFetch(resource, init);
      }catch(e){
        return prevFetch(resource, init);
      }
    };
  }catch(e){}
})();
 /* ===================== /VSP_P0_FETCH_CACHE_DEDUPE_V1K2 ===================== */




/* VSP_P2_BUNDLE_TABS5_V1
 * Router-bundle: load page modules by route, keep templates minimal:
 * Only include: vsp_tabs4_autorid_v1.js + this file.
 */
(function(){
  "use strict";

  function log(){ try{ console.log.apply(console, arguments); }catch(e){} }
  function warn(){ try{ console.warn.apply(console, arguments); }catch(e){} }

  function getAssetV(){
    // Try to reuse existing ?v=<digits> from any script tag.
    var scripts = document.getElementsByTagName("script");
    for (var i=0;i<scripts.length;i++){
      var src = scripts[i].getAttribute("src") || "";
      var m = src.match(/[?&]v=([0-9]{6,})/);
      if (m) return m[1];
    }
    return "";
  }

  function withV(url){
    var v = getAssetV();
    if(!v) return url;
    return url + (url.indexOf("?")>=0 ? "&" : "?") + "v=" + encodeURIComponent(v);
  }

  function loadScript(url){
    return new Promise(function(resolve, reject){
      var s = document.createElement("script");
      s.defer = true;
      s.src = withV(url);
      s.onload = function(){ resolve(url); };
      s.onerror = function(){ reject(new Error("load fail: "+url)); };
      document.head.appendChild(s);
    });
  }

  function exists(url){
    // Avoid noisy 404s: HEAD first (fallback GET if HEAD not allowed)
    var u = withV(url);
    return fetch(u, { method: "GET", credentials: "same-origin", cache: "no-store" })
      .then(function(r){
        if(r && r.ok) return true;
        if(r && (r.status === 405 || r.status === 403)) {
          return fetch(u, { method: "GET", credentials: "same-origin", cache: "no-store" })
            .then(function(r2){ return !!(r2 && r2.ok); })
            .catch(function(){ return false; });
        }
        return false;
      })
      .catch(function(){ return false; });
  }

  function loadIfExists(url){
    return exists(url).then(function(ok){
      if(!ok) return false;
      return loadScript(url).then(function(){ return true; }).catch(function(){ return false; });
    });
  }

  function pickRoute(){
    var p = (location.pathname || "/").toLowerCase();
    // normalize
    if (p === "/" || p === "/index") return "/vsp5";
    return p;
  }

  // Candidate modules: router will only load ones that exist.
  var ROUTES = {
    "/vsp5": [
      "/static/js/vsp_dash_only_v1.js",
      "/static/js/vsp_dashboard_kpi_force_any_v1.js",
      "/static/js/vsp_dashboard_gate_story_v1.js",
      "/static/js/vsp_dashboard_charts_pretty_v3.js"
    ],
    "/runs": [
      "/static/js/vsp_runs_reports_overlay_v1.js",
      "/static/js/vsp_runs_quick_actions_v1.js",
      "/static/js/vsp_runs_tab_resolved_v1.js"
    ],
    "/settings": [
      "/static/js/vsp_settings_tab_v1.js"
    ],
    "/data_source": [
      "/static/js/vsp_data_source_lazy_v1.js"
    ],
    "/rule_overrides": [
      "/static/js/vsp_rule_overrides_v1.js"
    ]
  };

  var route = pickRoute();
  var list = ROUTES[route] || [];
  if(!list.length){
    warn("[BundleTabs5] no modules mapped for route:", route);
    return;
  }

  log("[BundleTabs5] route=", route, "candidates=", list.length);

  // Load sequentially to keep deterministic order
  (function seq(i){
    if(i >= list.length){
      log("[BundleTabs5] done route=", route);
      return;
    }
    loadIfExists(list[i]).then(function(loaded){
      if(loaded) log("[BundleTabs5] loaded:", list[i]);
      seq(i+1);
    });
  })(0);


  // ===================== VSP_P2_BADGES_RID_OVERALL_V1 =====================
  (function(){
    function safeLog(){ try{ console.log.apply(console, arguments); }catch(e){} }
    function safeWarn(){ try{ console.warn.apply(console, arguments); }catch(e){} }

    function ensureStyle(){
      if (document.getElementById("vsp_p2_badges_style")) return;
      var st = document.createElement("style");
      st.id = "vsp_p2_badges_style";
      st.textContent = `
        .vsp-p2-badges{display:flex;gap:8px;align-items:center;margin-left:auto}
        .vsp-badge{font:12px/1.2 ui-sans-serif,system-ui; padding:4px 8px; border-radius:999px;
          border:1px solid rgba(255,255,255,.18); background:rgba(255,255,255,.06); color:#e8eefc;
          letter-spacing:.2px; white-space:nowrap}
        .vsp-badge b{font-weight:700}
        .vsp-badge.green{border-color:rgba(46,204,113,.45); background:rgba(46,204,113,.12)}
        .vsp-badge.amber{border-color:rgba(241,196,15,.45); background:rgba(241,196,15,.12)}
        .vsp-badge.red{border-color:rgba(231,76,60,.45); background:rgba(231,76,60,.12)}
        .vsp-badge.gray{opacity:.85}
        .vsp-badge-click:hover{filter:brightness(1.18)}
      `;
      document.head.appendChild(st);
    }

    function findTopbar(){
      // Your pages use .topnav in /vsp5; other tabs may also have it.
      return document.querySelector(".topnav") || document.querySelector("#topbar") || null;
    }

    function ensureContainer(topbar){
      var id = "vsp_p2_badges";
      var c = document.getElementById(id);
      if (c) return c;
      c = document.createElement("div");
      c.id = id;
      c.className = "vsp-p2-badges";
      if (topbar){
        topbar.appendChild(c);
      } else {
        // fallback: put at top of body (should rarely happen)
        c.style.position = "fixed";
        c.style.top = "10px";
        c.style.right = "10px";
        c.style.zIndex = "9999";
        document.body.appendChild(c);
      }
      return c;
    }

    
    function mkBadge(cls, text, opts){
      opts = opts || {};
      var el = document.createElement("span");
      el.className = "vsp-badge " + cls + (opts.click ? " vsp-badge-click" : "");
      el.textContent = text;
      if (opts.click){
        el.style.cursor = "pointer";
        el.title = opts.title || "Open";
        if (opts.action) el.dataset.vspAction = opts.action;
        if (opts.payload) el.dataset.vspPayload = opts.payload;
        el.addEventListener("click", function(){
          try{
            var a = el.dataset.vspAction || "";
            var p = el.dataset.vspPayload || "";
            if (a === "runs_rid"){
              // p is rid
              location.href = "/runs?rid=" + encodeURIComponent(p);
            } else if (a === "dash_gate"){
              location.href = "/vsp5?gate=1";
            }
          }catch(e){}
        });
      }
      return el;
    }


    function timeoutFetch(url, ms){
      var ctrl = new AbortController();
      var t = setTimeout(function(){ try{ ctrl.abort(); }catch(e){} }, ms);
      return fetch(url, {cache:"no-store", credentials:"same-origin", signal: ctrl.signal})
        .finally(function(){ clearTimeout(t); });
    }

    function pickOverallClass(v){
      v = (v || "").toString().toUpperCase();
      if (v === "GREEN" || v === "PASS" || v === "OK") return "green";
      if (v === "AMBER" || v === "WARN" || v === "WARNING" || v === "DEGRADED") return "amber";
      if (v === "RED" || v === "FAIL" || v === "BLOCK") return "red";
      return "gray";
    }

    function shortRid(rid){
      rid = (rid || "").toString();
      if (rid.length <= 18) return rid;
      return rid.slice(0, 10) + "…" + rid.slice(-6);
    }

    async function run(){
      try{
        ensureStyle();
        var topbar = findTopbar();
        var c = ensureContainer(topbar);

        // clear old
        c.innerHTML = "";
        c.appendChild(mkBadge("gray", "RID: …"));
        c.appendChild(mkBadge("gray", "Overall: …"));

        // 1) rid_latest
        var rid = "";
        try{
          var r1 = await timeoutFetch("/api/vsp/rid_latest", 3500);
          var j1 = await r1.json();
          rid = (j1 && j1.rid) ? j1.rid : "";
        }catch(e){
          safeWarn("[P2Badges] rid_latest fetch fail", e);
        }

        // 2) run_gate_summary
        var overall = "";
        var degraded = false;
        try{
          if (rid){
            var url = "/api/vsp/run_gate_summary_v1?rid=" + encodeURIComponent(rid);
            var r2 = await timeoutFetch(url, 4000);
            var j2 = await r2.json();

            overall = (j2 && j2.overall) ? j2.overall : "";
            // Best-effort degraded detection (flexible)
            degraded = !!(
              (j2 && j2.degraded) ||
              (j2 && j2.status && (""+j2.status).toUpperCase().includes("DEGRADED")) ||
              (j2 && j2.degraded_tools && Array.isArray(j2.degraded_tools) && j2.degraded_tools.length) ||
              (j2 && j2.missing_tools && Array.isArray(j2.missing_tools) && j2.missing_tools.length)
            );
          }
        }catch(e){
          safeWarn("[P2Badges] run_gate_summary fetch fail", e);
        }

        // render
        c.innerHTML = "";
        c.appendChild(mkBadge("gray", "RID: " + (rid ? shortRid(rid) : "n/a"), {click:true, action:"runs_rid", payload: rid || "", title:"Open Runs & Reports (RID)"}));
        var oc = pickOverallClass(overall);
        c.appendChild(mkBadge(oc, "Overall: " + (overall ? overall.toString().toUpperCase() : "n/a"), {click:true, action:"dash_gate", payload:"1", title:"Open Dashboard (Gate)"}));
        if (degraded){
          c.appendChild(mkBadge("amber", "DEGRADED", {click:true, action:"dash_gate", payload:"1", title:"Open Dashboard (Gate)"}));
        }

        safeLog("[P2Badges] ok rid=", rid, "overall=", overall, "degraded=", degraded);
      }catch(e){
        // no throw to avoid breaking UI
      }
    }

    // Run after DOM is ready enough
    if (document.readyState === "loading"){
      document.addEventListener("DOMContentLoaded", run);
    } else {
      run();
    }
  })();
  // ===================== /VSP_P2_BADGES_RID_OVERALL_V1 =====================

})();

/* VSP_P2_BADGES_CLICK_ACTIONS_V1 */


/* VSP_P2_SETTINGS_TOOL_POLICY_PANEL_V1 */
(function(){
  function _vspEl(tag, attrs, html){
    const e = document.createElement(tag);
    if (attrs) for (const k of Object.keys(attrs)) e.setAttribute(k, attrs[k]);
    if (html != null) e.innerHTML = html;
    return e;
  }

  function _vspTryMountSettingsPanel(){
    try {
      if (location.pathname !== "/settings") return;
      if (document.getElementById("vsp-settings-commercial-panel")) return;

      const anchor = document.querySelector("#vsp-settings-main") || document.querySelector("main") || document.body;
      const panel = _vspEl("div", {id:"vsp-settings-commercial-panel"}, `
        <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;">
          <div style="font-weight:800;letter-spacing:.2px;">Tool Coverage & Policy (Commercial)</div>
          <div style="opacity:.75;font-size:12px;">8 tools • degrade-graceful • evidence-first</div>
        </div>
        <div style="margin-top:10px;display:flex;flex-wrap:wrap;gap:8px;">
          <span class="vsp-pill">Bandit</span>
          <span class="vsp-pill">Semgrep</span>
          <span class="vsp-pill">Gitleaks</span>
          <span class="vsp-pill">KICS</span>
          <span class="vsp-pill">Trivy</span>
          <span class="vsp-pill">Syft</span>
          <span class="vsp-pill">Grype</span>
          <span class="vsp-pill">CodeQL</span>
        </div>
        <div style="margin-top:10px;opacity:.85;font-size:13px;line-height:1.5;">
          <ul style="margin:0;padding-left:18px;">
            <li><b>Timeout & degrade:</b> long tools (KICS/CodeQL) must timeout and mark <i>degraded</i>, not hang the pipeline.</li>
            <li><b>Severity normalization:</b> CRITICAL/HIGH/MEDIUM/LOW/INFO/TRACE.</li>
            <li><b>Artifacts:</b> always keep logs + raw outputs + unified findings + reports for audit/ISO mapping.</li>
            <li><b>Dashboard:</b> if KPI is disabled by policy, UI should show a degraded badge (not blank).</li>
          </ul>
        </div>
      `);

      // lightweight styling (works even without CSS)
      panel.style.cssText = "background:rgba(70,130,255,0.08);border:1px solid rgba(70,130,255,0.22);border-radius:14px;padding:12px 14px;margin:12px auto;max-width:1200px;color:#e9edf6;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial;";
      // add pill style if missing
      if (!document.getElementById("vsp-pill-style")) {
        const st = _vspEl("style", {id:"vsp-pill-style"}, `
          .vsp-pill{display:inline-block;padding:5px 10px;border-radius:999px;
          background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.14);
          font-size:12px;opacity:.92;}
        `);
        document.head.appendChild(st);
      }

      // insert near top
      try {
        if (anchor && anchor.firstChild) anchor.insertBefore(panel, anchor.firstChild);
        else anchor.appendChild(panel);
      } catch(e) {
        document.body.insertBefore(panel, document.body.firstChild);
      }
      console.log("[VSP][P2] settings commercial panel injected");
    } catch(e) {
      console.warn("[VSP][P2] settings panel inject failed:", e);
    }
  }

  if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", _vspTryMountSettingsPanel);
  else _vspTryMountSettingsPanel();
})();


/* VSP_P2_RULE_OVERRIDES_SAVE_BAR_V1 */
(function(){
  function _vspEl(tag, attrs, html){
    const e = document.createElement(tag);
    if (attrs) for (const k of Object.keys(attrs)) e.setAttribute(k, attrs[k]);
    if (html != null) e.innerHTML = html;
    return e;
  }

  function _pickStringKey(obj){
    if (!obj || typeof obj !== "object") return null;
    const prefer = ["text","content","raw","rules","overrides","yaml","json","data","value","body"];
    for (const k of prefer) if (typeof obj[k] === "string") return k;
    // fallback: first string field
    for (const k of Object.keys(obj)) if (typeof obj[k] === "string") return k;
    return null;
  }

  async function _ensureRuleOverridesBar(){
    try {
      if (location.pathname !== "/rule_overrides") return;
      if (document.getElementById("vsp-ro-savebar")) return;

      const anchor = document.querySelector("#vsp-rule-overrides-main") || document.querySelector("main") || document.body;

      // find textarea (existing editor) or create one
      let ta = document.querySelector("textarea");
      if (!ta) {
        ta = _vspEl("textarea", {id:"vsp-ro-textarea"}, "");
        ta.style.cssText = "width:100%;min-height:360px;background:rgba(0,0,0,0.25);border:1px solid rgba(255,255,255,0.18);border-radius:12px;padding:10px;color:#e9edf6;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,'Liberation Mono','Courier New',monospace;font-size:12px;line-height:1.45;";
        anchor.appendChild(ta);
      }

      const bar = _vspEl("div", {id:"vsp-ro-savebar"}, `
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;">
          <div style="font-weight:800;">Rule Overrides</div>
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
            <button id="vsp-ro-reload" type="button">Reload</button>
            <button id="vsp-ro-save" type="button">Save</button>
            <span id="vsp-ro-status" style="opacity:.8;font-size:12px;"></span>
          </div>
        </div>
      `);
      bar.style.cssText = "background:rgba(0,255,170,0.06);border:1px solid rgba(0,255,170,0.20);border-radius:14px;padding:10px 12px;margin:12px auto;max-width:1200px;color:#e9edf6;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial;";

      // button style
      const st = _vspEl("style", {id:"vsp-ro-btn-style"}, `
        #vsp-ro-savebar button{padding:7px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.18);
          background:rgba(255,255,255,0.08);color:#e9edf6;cursor:pointer;}
        #vsp-ro-savebar button:hover{background:rgba(255,255,255,0.12);}
      `);
      document.head.appendChild(st);

      try {
        if (anchor && anchor.firstChild) anchor.insertBefore(bar, anchor.firstChild);
        else anchor.appendChild(bar);
      } catch(e) {
        document.body.insertBefore(bar, document.body.firstChild);
      }

      const status = document.getElementById("vsp-ro-status");
      const setStatus = (t, isErr=false)=>{ if(status) status.textContent = t; if(status) status.style.opacity=isErr? "1":"0.85"; };

      let apiKey = null;

      async function load() {
        setStatus("Loading...");
        const j = await fetch("/api/ui/rule_overrides_v2", {credentials:"same-origin"}).then(r=>r.json());
        apiKey = _pickStringKey(j);
        if (apiKey && typeof j[apiKey] === "string") {
          ta.value = j[apiKey];
          setStatus("Loaded ("+apiKey+")");
        } else {
          // if server returns structured JSON, store pretty text
          ta.value = JSON.stringify(j, null, 2);
          setStatus("Loaded (json)");
        }
      }

      async function save() {
        setStatus("Saving...");
        let payload = null;
        if (apiKey) {
          payload = {[apiKey]: ta.value};
        } else {
          // fallback – try common key
          payload = {text: ta.value};
        }
        const res = await fetch("/api/ui/rule_overrides_v2", {
          method: "POST",
          credentials: "same-origin",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify(payload),
        });
        const txt = await res.text();
        if (res.ok) {
          setStatus("Saved ✓");
        } else {
          setStatus("Save failed: HTTP "+res.status, true);
          console.warn("[VSP][P2] rule_overrides save failed:", res.status, txt.slice(0,300));
        }
      }

      document.getElementById("vsp-ro-reload")?.addEventListener("click", ()=>load().catch(e=>setStatus("Load error", true)));
      document.getElementById("vsp-ro-save")?.addEventListener("click", ()=>save().catch(e=>setStatus("Save error", true)));

      await load();
      console.log("[VSP][P2] rule_overrides save bar injected");
    } catch(e) {
      console.warn("[VSP][P2] rule_overrides inject failed:", e);
    }
  }

  if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", _ensureRuleOverridesBar);
  else _ensureRuleOverridesBar();
})();


/* VSP_P2_RULE_OVERRIDES_SAVE_CONTRACT_RULES_V1C
   Backend:
     GET  /api/ui/rule_overrides_v2 -> {"ok":true,"schema":"rules_v1","rules":[...],...}
     POST /api/ui/rule_overrides_v2 expects same shape (schema + rules at least)
*/
(function(){
  async function roFix(){
    try{
      if (location.pathname !== "/rule_overrides") return;

      var btnSave = document.getElementById("vsp-ro-save");
      var btnReload = document.getElementById("vsp-ro-reload");
      var ta = document.querySelector("textarea");
      var status = document.getElementById("vsp-ro-status");

      if (!btnSave || !btnReload || !ta) return;

      function setStatus(t, isErr){
        if (!status) return;
        status.textContent = t;
        status.style.opacity = isErr ? "1" : "0.85";
      }

      var schema = "rules_v1";

      async function loadRules(){
        setStatus("Loading...", false);
        var j = await fetch("/api/ui/rule_overrides_v2", {credentials:"same-origin"}).then(function(r){return r.json();});
        schema = (j && j.schema) ? j.schema : "rules_v1";
        var rules = (j && Array.isArray(j.rules)) ? j.rules : [];
        ta.value = JSON.stringify(rules, null, 2);
        setStatus("Loaded (" + schema + "), rules=" + rules.length, false);
      }

      async function saveRules(){
        setStatus("Saving...", false);
        var parsed;
        try{
          parsed = JSON.parse(ta.value || "[]");
        }catch(e){
          setStatus("Textarea is not valid JSON", true);
          return;
        }

        var rules = [];
        if (Array.isArray(parsed)) rules = parsed;
        else if (parsed && Array.isArray(parsed.rules)) rules = parsed.rules;
        else{
          setStatus("JSON must be an array or object with 'rules' array", true);
          return;
        }

        var payload = {schema: (schema || "rules_v1"), rules: rules, notes: "ui"};
        var res = await fetch("/api/ui/rule_overrides_v2", {
          method: "POST",
          credentials: "same-origin",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify(payload)
        });

        var txt = await res.text();
        if (!res.ok){
          setStatus("Save failed HTTP " + res.status, true);
          try{ console.warn("[VSP][P2] rule_overrides save failed:", res.status, txt.slice(0,300)); }catch(e){}
          return;
        }

        // try parse {ok:true}
        try{
          var j2 = JSON.parse(txt);
          if (j2 && j2.ok === true) setStatus("Saved ✓ rules=" + rules.length, false);
          else setStatus("Saved (server response not ok?)", false);
        }catch(e){
          setStatus("Saved ✓ rules=" + rules.length, false);
        }
      }

      // Override handlers at capture phase (stop older injected handlers)
      btnReload.addEventListener("click", function(ev){
        ev.preventDefault(); ev.stopImmediatePropagation();
        loadRules().catch(function(){ setStatus("Load error", true); });
      }, true);

      btnSave.addEventListener("click", function(ev){
        ev.preventDefault(); ev.stopImmediatePropagation();
        saveRules().catch(function(){ setStatus("Save error", true); });
      }, true);

      if (!window.__VSP_RO_FIX_V1C__){
        window.__VSP_RO_FIX_V1C__ = 1;
        loadRules().catch(function(){});
        try{ console.log("[VSP][P2] rule_overrides save contract fixed (rules_v1) v1c"); }catch(e){}
      }
    }catch(e){
      try{ console.warn("[VSP][P2] roFix v1c error:", e); }catch(_e){}
    }
  }

  if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", roFix);
  else roFix();
})();


/* VSP_P0_SETTINGS_RENDER_TOOLS_TABLE_V1
   Render a real tools table on /settings using /api/ui/settings_v2
*/
(function(){
  function el(tag, cls, html){
    var d=document.createElement(tag);
    if (cls) d.className=cls;
    if (html!=null) d.innerHTML=html;
    return d;
  }
  function cssOnce(){
    if (document.getElementById("vsp-settings-tools-style")) return;
    var st=el("style", null, `
      .vsp-tools-wrap{margin-top:12px;padding:14px;border-radius:16px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.03)}
      .vsp-tools-h{display:flex;align-items:center;justify-content:space-between;gap:10px}
      .vsp-tools-title{font-weight:800;font-size:14px;opacity:.92}
      .vsp-tools-sub{font-size:12px;opacity:.75;margin-top:4px;line-height:1.35}
      .vsp-tools-meta{font-size:11px;opacity:.7}
      .vsp-tools-table{width:100%;border-collapse:separate;border-spacing:0;margin-top:10px;overflow:hidden;border-radius:14px}
      .vsp-tools-table th{font-size:11px;letter-spacing:.02em;text-transform:uppercase;opacity:.75;padding:10px 10px;background:rgba(0,0,0,.25);border-bottom:1px solid rgba(255,255,255,.08);text-align:left}
      .vsp-tools-table td{padding:10px 10px;border-bottom:1px solid rgba(255,255,255,.06);font-size:12px;opacity:.92}
      .vsp-pill{display:inline-flex;align-items:center;gap:6px;padding:3px 10px;border-radius:999px;font-size:11px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.18)}
      .vsp-dot{width:8px;height:8px;border-radius:50%;background:rgba(255,255,255,.35)}
      .vsp-dot.on{background:rgba(140,255,170,.9)}
      .vsp-dot.off{background:rgba(255,120,120,.9)}
      .vsp-mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
      .vsp-right{margin-left:auto}
      .vsp-btn{cursor:pointer;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.2);color:inherit;padding:6px 10px;border-radius:12px;font-size:12px;opacity:.9}
      .vsp-btn:hover{opacity:1}
    `);
    st.id="vsp-settings-tools-style";
    document.head.appendChild(st);
  }

  async function getJSON(url){
    try{
      var r=await fetch(url,{credentials:"same-origin"});
      return await r.json();
    }catch(e){ return null; }
  }

  function pickSettingsMount(){
    // Try common containers: a main content div, or fallback to body
    return document.querySelector("#vsp-settings-main")
      || document.querySelector("#vsp-settings")
      || document.querySelector(".vsp-settings-main")
      || document.querySelector("main")
      || document.body;
  }

  function renderTable(mount, data){
    cssOnce();
    if (document.getElementById("vsp-tools-wrap")) return;

    var wrap=el("div","vsp-tools-wrap","");
    wrap.id="vsp-tools-wrap";

    var h=el("div","vsp-tools-h","");
    var left=el("div","", "");
    left.appendChild(el("div","vsp-tools-title","Tool Coverage & Policy"));
    var sub="Live data from <span class='vsp-mono'>/api/ui/settings_v2</span>.";
    if (data && data.ui && data.ui.kpi_mode) sub += " KPI mode: <span class='vsp-mono'>"+data.ui.kpi_mode+"</span>.";
    left.appendChild(el("div","vsp-tools-sub",sub));
    h.appendChild(left);

    var meta=el("div","vsp-tools-meta vsp-right","");
    var via = (data && (data.__via__ || data.notes || data.source)) ? (data.__via__ || data.notes || data.source) : "—";
    meta.innerHTML = "source: <span class='vsp-mono'>"+ String(via).slice(0,120) +"</span>";
    h.appendChild(meta);

    var btn=el("button","vsp-btn","Refresh");
    btn.onclick = async function(){
      var d = await getJSON("/api/ui/settings_v2");
      if (!d || !d.tools){ alert("settings_v2 unavailable"); return; }
      // simple refresh: remove + re-render
      try{ wrap.remove(); }catch(e){}
      renderTable(pickSettingsMount(), d);
    };
    h.appendChild(btn);

    wrap.appendChild(h);

    var tbl=el("table","vsp-tools-table","");
    var thead=el("thead","", "");
    thead.appendChild(el("tr","",
      "<th>Tool</th><th>Enabled</th><th>Timeout</th><th>Degrade</th><th>Notes</th>"
    ));
    tbl.appendChild(thead);

    var tb=el("tbody","", "");
    var tools = (data && data.tools) ? data.tools : {};
    var order = ["BANDIT","SEMGREP","GITLEAKS","KICS","TRIVY","SYFT","GRYPE","CODEQL"];
    order.forEach(function(tid){
      var t = tools[tid] || {};
      var en = !!t.enabled;
      var dot = "<span class='vsp-dot "+(en?"on":"off")+"'></span>";
      var pill = "<span class='vsp-pill'>"+dot+(en?"Enabled":"Disabled")+"</span>";
      var tout = (t.timeout_sec==null || t.timeout_sec==="") ? "—" : String(t.timeout_sec)+"s";
      var deg = (t.degrade_on_fail===false) ? "No" : "Yes";
      var notes = (t.notes||"").toString();
      var tr=el("tr","",
        "<td class='vsp-mono'>"+tid+"</td>"+
        "<td>"+pill+"</td>"+
        "<td class='vsp-mono'>"+tout+"</td>"+
        "<td>"+deg+"</td>"+
        "<td>"+(notes ? notes.replace(/[<>]/g,"") : "—")+"</td>"
      );
      tb.appendChild(tr);
    });
    tbl.appendChild(tb);
    wrap.appendChild(tbl);

    // insert near top of settings page
    mount.prepend(wrap);
  }

  async function init(){
    try{
      if (location.pathname !== "/settings") return;
      // wait for page JS to build layout
      for (var i=0;i<12;i++){
        await new Promise(r=>setTimeout(r,120));
        var mount = pickSettingsMount();
        if (mount) break;
      }
      var d = await getJSON("/api/ui/settings_v2");
      if (!d || !d.tools){
        var mount = pickSettingsMount();
        if (!mount) return;
        cssOnce();
        var warn=el("div","vsp-tools-wrap","<div class='vsp-tools-title'>Tool Coverage & Policy</div><div class='vsp-tools-sub'>settings_v2 unavailable. (degraded)</div>");
        warn.id="vsp-tools-wrap";
        mount.prepend(warn);
        return;
      }
      renderTable(pickSettingsMount(), d);
    }catch(e){}
  }

  if (document.readyState==="loading") document.addEventListener("DOMContentLoaded", init);
  else init();
})();

/* VSP_SAFE_INTERVAL_V1 */

/* VSP_SAFE_INTERVAL_V1 */
(function(){
  try{
    // default: live OFF, only ON if /vsp5?live=1
    if (typeof window.__VSP_SAFE_LIVE === "undefined") {
      var sp = new URLSearchParams(location.search||"");
      window.__VSP_SAFE_LIVE = (sp.get("live")==="1");
    }
    window.__vspSafeInterval = window.__vspSafeInterval || function(fn, ms){
      var safeMs = Math.max(parseInt(ms||0,10) || 0, 2000);
      return window.__vspSafeInterval(function(){
        try{
          if (document.hidden) return;
          if (window.__VSP_SAFE_LIVE === false) return;
          fn && fn();
        }catch(e){
          console.warn("[VSP_SAFE_INTERVAL]", e);
        }
      }, safeMs);
    };
    window.__vspSafeTimeout = window.__vspSafeTimeout || function(fn, ms){
      var safeMs = Math.max(parseInt(ms||0,10) || 0, 200);
      return setTimeout(function(){
        try{
          if (window.__VSP_SAFE_LIVE === false && safeMs < 800) return;
          fn && fn();
        }catch(e){
          console.warn("[VSP_SAFE_TIMEOUT]", e);
        }
      }, safeMs);
    };
  }catch(e){
    console.warn("[VSP_SAFE_INIT]", e);
  }
})();

/* VSP_SAFE_INTERVAL_V2 */
(function(){
  try{
    var nativeSI = (window.__vspNativeSetInterval) ? window.__vspNativeSetInterval : window.setInterval.bind(window);
    // commercial-safe clamp: >=800ms, <=30000ms
    window.__vspSafeInterval = function(fn, ms){
      var v = Number(ms);
      if(!isFinite(v)) v = 0;
      if(v < 800) v = 800;
      if(v > 30000) v = 30000;
      return nativeSI(fn, v);
    };
  }catch(e){}
})();
