"""
WSGI entrypoint for gunicorn.
- Robust import: try app/application/create_app
- Force-register /healthz on the final application object
"""
import os
os.environ.setdefault("VSP_UI_MODE", "PROD")

application = None

# 1) Prefer explicit "application" if module provides it
try:
    from vsp_demo_app import application as _app  # type: ignore
    application = _app
except Exception:
    pass

# 2) Fallback to "app"
if application is None:
    try:
        from vsp_demo_app import app as _app  # type: ignore
        application = _app
    except Exception:
        pass

# 3) Fallback to factory create_app()
if application is None:
    try:
        from vsp_demo_app import create_app  # type: ignore
        application = create_app()
    except Exception as e:
        raise RuntimeError("Cannot obtain Flask application from vsp_demo_app") from e

# Force /healthz on the actual app object (works across Flask versions)
try:
    from flask import jsonify
    @application.route("/healthz", methods=["GET"])
    def _vsp_healthz_wsgi_v1():  # pragma: no cover
        return jsonify({"ok": True, "service": "vsp-ui-8910"}), 200
except Exception:
    pass
