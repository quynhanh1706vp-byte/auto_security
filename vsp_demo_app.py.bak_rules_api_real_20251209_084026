from __future__ import annotations

from pathlib import Path

from flask import Flask, redirect, render_template, jsonify

# Core V3 APIs: dashboard_v3, runs_index_v3, datasource_v2, trend_v1, ...
from vsp_api_core_v3 import bp_v3 as vsp_api_core_bp

ROOT_DIR = Path(__file__).resolve().parent.parent


def create_app() -> Flask:
    """
    VSP Demo App – bản UI thương mại 2025:
    - /               -> redirect /security_bundle
    - /security_bundle -> template vsp_dashboard_2025.html
    - /api/vsp/*      -> từ vsp_api_core_v3 + 2 API đơn giản:
        /api/vsp/settings/get
        /api/vsp/overrides/list
    """
    app = Flask(
        __name__,
        static_folder="static",
        template_folder="templates",
    )

    # Đăng ký blueprint core V3
    app.register_blueprint(vsp_api_core_bp)

    # ================== SETTINGS API (ĐƠN GIẢN) ==================
    @app.route("/api/vsp/settings/get")
    def api_vsp_settings_get():
        """
        Trả về cấu hình tools + env để UI Settings dùng.
        Sau này muốn đọc từ file JSON thì chỉnh ở đây.
        """
        tools = {
            "gitleaks":  {"enabled": True,  "label": "Gitleaks (Secrets)"},
            "semgrep":   {"enabled": True,  "label": "Semgrep (SAST)"},
            "kics":      {"enabled": True,  "label": "KICS (IaC)"},
            "codeql":    {"enabled": True,  "label": "CodeQL"},
            "bandit":    {"enabled": True,  "label": "Bandit (Python)"},
            "trivy_fs":  {"enabled": True,  "label": "Trivy FS"},
            "syft":      {"enabled": True,  "label": "Syft (SBOM)"},
            "grype":     {"enabled": True,  "label": "Grype (Vuln)"},
        }

        payload = {
            "ok": True,
            "env": {
                "profile": "EXT+",
                "root_dir": str(ROOT_DIR),
            },
            "tools": tools,
        }
        return jsonify(payload)

    # ================== RULE OVERRIDES API (ĐƠN GIẢN) ==================
    @app.route("/api/vsp/overrides/list")
    def api_vsp_overrides_list():
        """
        Tạm thời trả danh sách overrides rỗng.
        Sau này có file overrides thì đọc và trả thật.
        """
        payload = {
            "ok": True,
            "total": 0,
            "items": [],
        }
        return jsonify(payload)

    # ================== UI ROUTES ==================
    @app.route("/")
    def index():
        return redirect("/security_bundle")

    @app.route("/security_bundle")
    def security_bundle():
        return render_template("vsp_dashboard_2025.html")

    return app


app = create_app()


# ================= VSP SETTINGS / RUN API V1 =====================
from pathlib import Path
import os, json, subprocess
from datetime import datetime
from flask import request, jsonify

VSP_ROOT_DIR = Path(os.environ.get("VSP_ROOT_DIR") or "/home/test/Data/SECURITY_BUNDLE")
VSP_SETTINGS_FILE = VSP_ROOT_DIR / "config" / "vsp_settings.json"

@app.route("/api/vsp/settings/set", methods=["POST"])
def api_vsp_settings_set():
    data = request.get_json(force=True, silent=True) or {}
    cfg = {
        "profile": (data.get("profile") or "EXT+").upper(),
        "default_source_path": data.get("default_source_path") or data.get("source_path") or "",
        "tools": data.get("tools") or {},
    }
    try:
        VSP_SETTINGS_FILE.parent.mkdir(parents=True, exist_ok=True)
        VSP_SETTINGS_FILE.write_text(json.dumps(cfg, indent=2), encoding="utf-8")
        return jsonify({"ok": True})
    except Exception as e:
        return jsonify({"ok": False, "error": str(e)}), 500

@app.route("/api/vsp/run_full_ext", methods=["POST"])
def api_vsp_run_full_ext():
    data = request.get_json(force=True, silent=True) or {}
    # Đọc SRC từ JSON body, form-data hoặc query string
    data = (request.get_json(silent=True) or {})
    src = (
        (request.args.get("src") if hasattr(request, "args") else None)
        or (request.form.get("src") if hasattr(request, "form") else None)
        or data.get("src")
        or data.get("source")
        or ""
    ).strip()
    print("[API_RUN_FULL_EXT] src from request =", repr(src))
    profile = (data.get("profile") or "EXT+").upper()

    if not src:
        return jsonify({"ok": False, "error": "Missing src"}), 400

    script = VSP_ROOT_DIR / "bin" / "run_vsp_full_ext.sh"
    if not script.exists():
        return jsonify({"ok": False, "error": f"Script not found: {script}"}), 500

    # Dự đoán RUN_ID theo pattern chuẩn của pipeline
    run_id = "RUN_VSP_FULL_EXT_" + datetime.now().strftime("%Y%m%d_%H%M%S")

    env = os.environ.copy()
    env["PROFILE"] = profile
    env["VSP_PROFILE"] = profile
    env["RUN_ID_HINT"] = run_id  # để shell script có thể log nếu muốn

    try:
        subprocess.Popen(
            ["bash", str(script), src],
            cwd=str(VSP_ROOT_DIR),
            env=env,
            stdout=subprocess.DEVNULL,
            stderr=subprocess.DEVNULL,
        )
    except Exception as e:
        return jsonify({"ok": False, "error": str(e)}), 500

    # Không chờ scan xong – chỉ trigger rồi trả về RUN_ID dự đoán
    return jsonify({"ok": True, "run_id": run_id})


if __name__ == "__main__":
    app.run(host="0.0.0.0", port=8910, debug=True)


@app.route("/api/vsp/rule_overrides/get", methods=["GET"])
def vsp_rule_overrides_get():
    """Stub API cho Rule Overrides – trả dữ liệu rỗng, không lỗi."""
    from flask import jsonify
    return jsonify({
        "ok": True,
        "profile": "EXT+",
        "config_path": "/home/test/Data/SECURITY_BUNDLE/config/rule_overrides.json",
        "items": []
    })
