from __future__ import annotations

from pathlib import Path

from flask import Flask, redirect, render_template

# Blueprint core V3: chứa dashboard_v3, runs_index_v3, datasource_v2, trend_v1, settings, overrides
from vsp_api_core_v3 import bp_v3 as vsp_api_core_bp


ROOT_DIR = Path(__file__).resolve().parent.parent


def create_app() -> Flask:
    """
    VSP Demo App – bản tối giản:
    - Static: ui/static
    - Templates: ui/templates
    - Routes:
        /                -> redirect sang /security_bundle
        /security_bundle -> render vsp_dashboard_2025.html
    - Đăng ký blueprint vsp_api_core_v3 (bp_v3) cho các API /api/vsp/*
    """
    app = Flask(
        __name__,
        static_folder="static",
        template_folder="templates",
    )

    # Đăng ký blueprint API core V3
    app.register_blueprint(vsp_api_core_bp)

    @app.route("/")
    def index():
        # Cho UI cũ: / -> /security_bundle
        return redirect("/security_bundle")

    @app.route("/security_bundle")
    def security_bundle():
        # Template dashboard 2025 (đang dùng)
        return render_template("vsp_dashboard_2025.html")

    return app


app = create_app()

if __name__ == "__main__":
    # Chạy ở port 8910 như trước đây
    app.run(host="0.0.0.0", port=8910, debug=True)
