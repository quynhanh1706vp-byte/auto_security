(function () {
  "use strict";
  if (window.__VSP_CHARTS_BOOTSTRAP_V1) return;
  window.__VSP_CHARTS_BOOTSTRAP_V1 = true;

  console.log("[VSP_CHARTS_BOOT] bootstrap loaded (v1 multischema)");

  var CAND_ENDPOINTS = ["/api/vsp/dashboard_v3", "/api/vsp/dashboard_v3_latest", "/api/vsp/dashboard_v3"];

  function getEngine() {
    return window.VSP_CHARTS_ENGINE_V3 || window.VSP_CHARTS_ENGINE_V2 || null;
  }

  function looksLikeDash(o) {
    if (!o || typeof o !== "object") return false;
    // “strong” signals
    if (o.by_severity) return true;
    if (o.top_cwe_list) return true;
    if (o.latest_run_id) return true;
    return false;
  }

  function extractDash(resp) {
    // Accept many shapes: resp, resp.data, resp.dashboard_v3, resp.summary_all, etc.
    if (looksLikeDash(resp)) return resp;

    if (resp && typeof resp === "object") {
      if (looksLikeDash(resp.data)) return resp.data;
      if (looksLikeDash(resp.dashboard_v3)) return resp.dashboard_v3;
      if (looksLikeDash(resp.summary_all)) return resp.summary_all;

      // sometimes data is nested deeper
      if (resp.data && looksLikeDash(resp.data.dashboard_v3)) return resp.data.dashboard_v3;
      if (resp.data && looksLikeDash(resp.data.summary_all)) return resp.data.summary_all;
    }
    return null;
  }

  async function fetchAnyDash() {
    for (var i = 0; i < CAND_ENDPOINTS.length; i++) {
      var url = CAND_ENDPOINTS[i];
      try {
        var r = await fetch(url, { cache: "no-store" });
        if (!r.ok) continue;
        var j = await r.json();
        var d = extractDash(j);
        if (d) {
          console.log("[VSP_CHARTS_BOOT] dash resolved from", url);
          return d;
        } else {
          console.warn("[VSP_CHARTS_BOOT] no dash keys in response from", url, "keys=", (j && typeof j==="object") ? Object.keys(j).slice(0,10) : typeof j);
        }
      } catch (e) {}
    }
    return null;
  }

  async function tryInit(tag) {
    try {
      var eng = getEngine();
      if (!eng || !eng.initAll) return false;

      var data = window.__VSP_DASH_LAST_DATA_V3 || null;
      if (!data) {
        data = await fetchAnyDash();
        if (data) window.__VSP_DASH_LAST_DATA_V3 = data;
      }
      if (!data) return false;

      var ok = eng.initAll(data);
      console.log("[VSP_CHARTS_BOOT] initAll via", tag, "=>", ok);
      return !!ok;
    } catch (e) {
      console.warn("[VSP_CHARTS_BOOT] init failed", e);
      return false;
    }
  }

  function scheduleRetries(reason) {
    var tries = 0, maxTries = 25, delay = 400;
    (function tick() {
      tries++;
      tryInit(reason + "#"+tries).then(function (ok) {
        if (ok) return;
        if (tries < maxTries) setTimeout(tick, delay);
      });
    })();
  }

  window.addEventListener("vsp:charts-ready", function (ev) {
    console.log("[VSP_CHARTS_BOOT] got vsp:charts-ready", ev && ev.detail ? ev.detail : "");
    scheduleRetries("charts-ready");
  });

  // also kick once (in case event fired before listener)
  setTimeout(function () { scheduleRetries("startup"); }, 700);
})();
