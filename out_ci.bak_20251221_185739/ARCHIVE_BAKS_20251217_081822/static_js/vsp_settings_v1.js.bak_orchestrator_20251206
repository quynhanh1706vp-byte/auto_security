(function () {
  console.log("[VSP][SETTINGS_V1_STUB] Loaded (chưa có logic).");
})();


// ====================================================================
// VSP_SETTINGS_V1_ENHANCED_20251206
// - Tab Settings kiểu enterprise (read-only):
//   + ENV / profile / ROOT.
//   + Tool stack 7 tools: enabled? label.
//   + Profile & Integrations stub (chuẩn bị cho bản sau).
// ====================================================================
(function () {
  if (!window.VSP) window.VSP = {};
  const API_SETTINGS_GET = "/api/vsp/settings/get";

  async function fetchSettings() {
    try {
      const resp = await fetch(API_SETTINGS_GET);
      if (!resp.ok) throw new Error("HTTP " + resp.status);
      const data = await resp.json();
      console.log("[VSP][SETTINGS] settings loaded", data);
      return data;
    } catch (e) {
      console.warn("[VSP][SETTINGS] load error:", e);
      return null;
    }
  }

  function ensureRoot() {
    const tab = document.getElementById("tab-settings");
    if (!tab) {
      console.warn("[VSP][SETTINGS] Không tìm thấy #tab-settings.");
      return null;
    }

    // ưu tiên body bên trong card nếu có
    let body = tab.querySelector(".vsp-card-body");
    if (!body) body = tab;

    let root = body.querySelector(".vsp-settings-root");
    if (!root) {
      root = document.createElement("div");
      root.className = "vsp-settings-root";
      body.innerHTML = "";
      body.appendChild(root);
    }
    return root;
  }

  function renderSettingsNice(root, data) {
    if (!root || !data) return;

    const env   = data.env || {};
    const tools = data.tools || {};

    const profile = env.profile || env.PROFILE || "EXT+";
    const rootDir = env.ROOT || env.root || "-";
    const runDir  = env.RUN_DIR || env.run_dir || "-";

    // Chuẩn hoá danh sách tool
    const toolEntries = Object.entries(tools).map(([key, cfg]) => {
      cfg = cfg || {};
      return {
        key,
        label: cfg.label || cfg._label || key,
        enabled: !!cfg.enabled,
        notes: cfg.notes || ""
      };
    }).sort((a, b) => a.key.localeCompare(b.key));

    root.innerHTML = `
      <div class="vsp-settings-grid">
        <div class="vsp-settings-section">
          <div class="vsp-card-subtitle">General configuration</div>
          <dl class="vsp-kv-list">
            <div class="vsp-kv-row">
              <dt>Profile</dt>
              <dd>${profile}</dd>
            </div>
            <div class="vsp-kv-row">
              <dt>ROOT</dt>
              <dd>${rootDir}</dd>
            </div>
            <div class="vsp-kv-row">
              <dt>RUN_DIR</dt>
              <dd>${runDir}</dd>
            </div>
          </dl>
          <p class="vsp-muted-small">
            Read-only from unified settings API.  
            Future versions sẽ cho phép chỉnh profile &amp; ENV trực tiếp tại đây.
          </p>
        </div>

        <div class="vsp-settings-section">
          <div class="vsp-card-subtitle">Tool stack</div>
          <table class="vsp-table vsp-settings-tools">
            <thead>
              <tr>
                <th>Tool</th>
                <th>Status</th>
                <th>Label</th>
              </tr>
            </thead>
            <tbody>
              ${toolEntries.map(t => `
                <tr>
                  <td>${t.key}</td>
                  <td class="${t.enabled ? "vsp-tag-ok" : "vsp-tag-off"}">
                    ${t.enabled ? "Enabled" : "Disabled"}
                  </td>
                  <td>${t.label}</td>
                </tr>
              `).join("")}
            </tbody>
          </table>
        </div>
      </div>

      <div class="vsp-settings-grid vsp-settings-grid-bottom">
        <div class="vsp-settings-section">
          <div class="vsp-card-subtitle">Profiles &amp; pipeline</div>
          <p class="vsp-muted-small">
            Current profile: <strong>${profile}</strong>.  
            Planned: FAST / EXT+ / AGGR / FULL với cấu hình riêng (tool list, noise filter,
            SBOM, CodeQL, cloud scanner…).
          </p>
        </div>
        <div class="vsp-settings-section">
          <div class="vsp-card-subtitle">Integrations</div>
          <p class="vsp-muted-small">
            Roadmap: Webhook gửi kết quả, Slack/Teams alerts, upload SBOM lên
            Dependency-Track / GitLab / JFrog, push SARIF lên GitHub.
          </p>
        </div>
      </div>
    `;
  }

  let loading = false;
  window.VSP.loadSettingsNice = async function () {
    if (loading) return;
    loading = true;
    const root = ensureRoot();
    const data = await fetchSettings();
    renderSettingsNice(root, data || {});
    loading = false;
  };

  function triggerLoadSettings() {
    setTimeout(() => {
      if (window.VSP && typeof window.VSP.loadSettingsNice === "function") {
        window.VSP.loadSettingsNice();
      }
    }, 200);
  }

  // Nếu mở trang với hash tab-settings
  document.addEventListener("DOMContentLoaded", function () {
    if (window.location.hash.indexOf("tab-settings") !== -1) {
      triggerLoadSettings();
    }
  });

  // Khi bấm vào menu Settings bên sidebar
  document.addEventListener("click", function (e) {
    const t = e.target;
    if (!t) return;
    if (t.matches("[data-tab-target='tab-settings'], [data-tab-target='tab-settings'] *")) {
      triggerLoadSettings();
    }
  });
})();
