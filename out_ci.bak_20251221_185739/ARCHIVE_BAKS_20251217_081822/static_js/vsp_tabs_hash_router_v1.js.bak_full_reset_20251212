(function () {
  console.log('[VSP_TABS_ROUTER_V1] loaded from /static/js/vsp_tabs_hash_router_v1.js');

  function fmtInt(n) {
    if (n == null || isNaN(n)) return '-';
    n = Number(n);
    if (!isFinite(n)) return '-';
    return n.toLocaleString('en-US');
  }

  function fmtDate(s) {
    if (!s) return '-';
    try {
      var d = new Date(s);
      if (isNaN(d.getTime())) return s;
      return d.toLocaleString();
    } catch (e) {
      return s;
    }
  }

  function esc(s) {
    if (s == null) return '';
    return String(s)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;');
  }

  function getRoot() {
    var root = document.getElementById('vsp-dashboard-main');
    if (!root) {
      console.warn('[VSP_TABS_ROUTER_V1] #vsp-dashboard-main not found');
    }
    return root;
  }

  // ====== RENDER RUNS ======
  async function renderRuns(root) {
    console.log('[VSP_TABS_ROUTER_V1] renderRuns');

    root.innerHTML = '' +
      '<div class="vsp-tab-inner vsp-tab-runs">' +
        '<div class="vsp-tab-header">' +
          '<h2>Runs &amp; Reports</h2>' +
          '<p class="vsp-tab-subtitle">Lịch sử FULL_EXT / CI, xem nhanh KPI và timeline runs.</p>' +
        '</div>' +

        '<div class="vsp-kpi-row">' +
          '<div class="vsp-card vsp-kpi-card" id="vsp-runs-kpi-total">' +
            '<div class="vsp-kpi-label">Total Runs</div>' +
            '<div class="vsp-kpi-value">–</div>' +
            '<div class="vsp-kpi-desc">Tổng số run lưu trong hệ thống.</div>' +
          '</div>' +
          '<div class="vsp-card vsp-kpi-card" id="vsp-runs-kpi-last">' +
            '<div class="vsp-kpi-label">Last Run</div>' +
            '<div class="vsp-kpi-value">–</div>' +
            '<div class="vsp-kpi-desc">Run gần nhất (bất kỳ loại).</div>' +
          '</div>' +
          '<div class="vsp-card vsp-kpi-card" id="vsp-runs-kpi-last-full">' +
            '<div class="vsp-kpi-label">Last FULL_EXT</div>' +
            '<div class="vsp-kpi-value">–</div>' +
            '<div class="vsp-kpi-desc">FULL_EXT gần nhất.</div>' +
          '</div>' +
          '<div class="vsp-card vsp-kpi-card" id="vsp-runs-kpi-last-ci">' +
            '<div class="vsp-kpi-label">Last CI</div>' +
            '<div class="vsp-kpi-value">–</div>' +
            '<div class="vsp-kpi-desc">CI gần nhất.</div>' +
          '</div>' +
        '</div>' +

        '<div class="vsp-card vsp-table-card">' +
          '<div class="vsp-table-header">' +
            '<div>' +
              '<h3>Runs timeline</h3>' +
              '<p class="vsp-table-subtitle">Danh sách ~40 run mới nhất.</p>' +
            '</div>' +
          '</div>' +
          '<div class="vsp-table-wrapper">' +
            '<table class="vsp-table" id="vsp-runs-table">' +
              '<thead>' +
                '<tr>' +
                  '<th>Run ID</th>' +
                  '<th>Type</th>' +
                  '<th>Time</th>' +
                  '<th>Total</th>' +
                  '<th>Score</th>' +
                '</tr>' +
              '</thead>' +
              '<tbody>' +
                '<tr><td colspan="5" class="vsp-table-loading">Đang tải runs…</td></tr>' +
              '</tbody>' +
            '</table>' +
          '</div>' +
        '</div>' +
      '</div>';

    var tbody = root.querySelector('#vsp-runs-table tbody');
    var kTotal = root.querySelector('#vsp-runs-kpi-total .vsp-kpi-value');
    var kLast  = root.querySelector('#vsp-runs-kpi-last .vsp-kpi-value');
    var kFull  = root.querySelector('#vsp-runs-kpi-last-full .vsp-kpi-value');
    var kCi    = root.querySelector('#vsp-runs-kpi-last-ci .vsp-kpi-value');

    var data;
    try {
      var res = await fetch('/api/vsp/runs_index_v3?limit=40', { cache: 'no-store' });
      data = await res.json();
    } catch (e) {
      console.error('[VSP_TABS_ROUTER_V1][RUNS] fetch error', e);
      if (tbody) {
        tbody.innerHTML = '<tr><td colspan="5" class="vsp-table-error">Không tải được runs.</td></tr>';
      }
      return;
    }

    var items = Array.isArray(data.items) ? data.items : [];
    if (kTotal) kTotal.textContent = fmtInt(items.length);
    var last = items[0];
    if (kLast && last) kLast.textContent = fmtInt(last.total_findings);

    var lastFull = items.find(function (r) {
      return String(r.run_id || '').indexOf('FULL_EXT') !== -1;
    });
    var lastCi = items.find(function (r) {
      return String(r.run_id || '').indexOf('_CI_') !== -1;
    });

    if (kFull) kFull.textContent = lastFull ? fmtInt(lastFull.total_findings) : '–';
    if (kCi)   kCi.textContent   = lastCi   ? fmtInt(lastCi.total_findings)   : '–';

    if (!tbody) return;
    if (!items.length) {
      tbody.innerHTML = '<tr><td colspan="5" class="vsp-table-empty">Chưa có run nào.</td></tr>';
      return;
    }

    tbody.innerHTML = items.map(function (r) {
      var id = r.run_id || '(unknown)';
      var type = r.run_type ||
        (String(id).indexOf('_CI_') !== -1 ? 'CI' :
         (String(id).indexOf('FULL_EXT') !== -1 ? 'FULL_EXT' : 'RUN'));
      var t = r.created_at || r.started_at || r.finished_at;
      var score = r.security_posture_score != null ? r.security_posture_score :
                  (r.score != null ? r.score : '-');
      return '' +
        '<tr>' +
          '<td><code>' + esc(id) + '</code></td>' +
          '<td>' + esc(type) + '</td>' +
          '<td>' + esc(fmtDate(t)) + '</td>' +
          '<td>' + fmtInt(r.total_findings) + '</td>' +
          '<td>' + esc(score) + '</td>' +
        '</tr>';
    }).join('');

    console.log('[VSP_TABS_ROUTER_V1] Runs rendered with', items.length, 'items');
  }

  // ====== RENDER DATA SOURCE ======
  async function renderDataSource(root) {
    console.log('[VSP_TABS_ROUTER_V1] renderDataSource');

    root.innerHTML = '' +
      '<div class="vsp-tab-inner vsp-tab-datasource">' +
        '<div class="vsp-tab-header">' +
          '<h2>Data Source</h2>' +
          '<p class="vsp-tab-subtitle">Bảng findings unify từ tất cả tool.</p>' +
        '</div>' +

        '<div class="vsp-filter-row">' +
          '<select id="vsp-ds-filter-sev" class="vsp-input">' +
            '<option value="">Severity: All</option>' +
            '<option value="CRITICAL">Critical</option>' +
            '<option value="HIGH">High</option>' +
            '<option value="MEDIUM">Medium</option>' +
            '<option value="LOW">Low</option>' +
            '<option value="INFO">Info</option>' +
            '<option value="TRACE">Trace</option>' +
          '</select>' +
          '<input id="vsp-ds-filter-tool" class="vsp-input" placeholder="Tool (semgrep, kics,…)" />' +
          '<input id="vsp-ds-filter-text" class="vsp-input vsp-flex" placeholder="Search message/path…" />' +
          '<button id="vsp-ds-refresh" class="vsp-btn vsp-btn-secondary">Reload</button>' +
        '</div>' +

        '<div class="vsp-card vsp-table-card">' +
          '<div class="vsp-table-header">' +
            '<div>' +
              '<h3>Findings</h3>' +
              '<p class="vsp-table-subtitle">Tối đa 200 bản ghi mới nhất.</p>' +
            '</div>' +
            '<div class="vsp-table-kpi"><span id="vsp-ds-kpi-total">0</span> records</div>' +
          '</div>' +
          '<div class="vsp-table-wrapper">' +
            '<table class="vsp-table" id="vsp-ds-table">' +
              '<thead>' +
                '<tr>' +
                  '<th>Severity</th>' +
                  '<th>Tool</th>' +
                  '<th>Module / Path</th>' +
                  '<th>Message</th>' +
                  '<th>Run</th>' +
                '</tr>' +
              '</thead>' +
              '<tbody>' +
                '<tr><td colspan="5" class="vsp-table-loading">Đang tải findings…</td></tr>' +
              '</tbody>' +
            '</table>' +
          '</div>' +
        '</div>' +
      '</div>';

    var selSev  = root.querySelector('#vsp-ds-filter-sev');
    var inpTool = root.querySelector('#vsp-ds-filter-tool');
    var inpText = root.querySelector('#vsp-ds-filter-text');
    var btnReload = root.querySelector('#vsp-ds-refresh');
    var tbody = root.querySelector('#vsp-ds-table tbody');
    var kTotal = root.querySelector('#vsp-ds-kpi-total');

    async function fetchAndRender() {
      if (!tbody) return;
      tbody.innerHTML = '<tr><td colspan="5" class="vsp-table-loading">Đang tải findings…</td></tr>';

      var p = [];
      p.push('limit=200');
      if (selSev && selSev.value) p.push('severity=' + encodeURIComponent(selSev.value));
      if (inpTool && inpTool.value.trim())
        p.push('tool=' + encodeURIComponent(inpTool.value.trim()));
      if (inpText && inpText.value.trim())
        p.push('q=' + encodeURIComponent(inpText.value.trim()));

      var url = '/api/vsp/datasource_v2?' + p.join('&');

      var data;
      try {
        var res = await fetch(url, { cache: 'no-store' });
        data = await res.json();
      } catch (e) {
        console.error('[VSP_TABS_ROUTER_V1][DS] fetch error', e);
        tbody.innerHTML = '<tr><td colspan="5" class="vsp-table-error">Không tải được Data Source.</td></tr>';
        if (kTotal) kTotal.textContent = '0';
        return;
      }

      var items = Array.isArray(data.items) ? data.items : (Array.isArray(data) ? data : []);
      if (kTotal) kTotal.textContent = fmtInt(items.length);

      if (!items.length) {
        tbody.innerHTML = '<tr><td colspan="5" class="vsp-table-empty">Không có bản ghi nào.</td></tr>';
        return;
      }

      tbody.innerHTML = items.map(function (f) {
        var sev = (f.severity || f.raw_severity || 'INFO').toUpperCase();
        var tool = f.tool || f.source || '-';
        var path = f.module || f.file || f.path || f.location || '-';
        var msg  = f.message || f.title || f.short_message || '-';
        var run  = f.run_id || '-';
        return '' +
          '<tr>' +
            '<td><span class="vsp-badge vsp-badge-sev vsp-sev-' + esc(sev.toLowerCase()) + '">' + esc(sev) + '</span></td>' +
            '<td>' + esc(tool) + '</td>' +
            '<td class="vsp-mono">' + esc(path) + '</td>' +
            '<td>' + esc(msg) + '</td>' +
            '<td class="vsp-mono">' + esc(run) + '</td>' +
          '</tr>';
      }).join('');

      console.log('[VSP_TABS_ROUTER_V1] Data Source rendered with', items.length, 'items');
    }

    if (btnReload) btnReload.addEventListener('click', fetchAndRender);
    [inpTool, inpText].forEach(function (inp) {
      if (!inp) return;
      inp.addEventListener('keydown', function (e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          fetchAndRender();
        }
      });
    });

    fetchAndRender();
  }

  // ====== SETTINGS ======
  async function renderSettings(root) {
    console.log('[VSP_TABS_ROUTER_V1] renderSettings');

    root.innerHTML = '' +
      '<div class="vsp-tab-inner vsp-tab-settings">' +
        '<div class="vsp-tab-header">' +
          '<h2>Settings</h2>' +
          '<p class="vsp-tab-subtitle">Cấu hình gate policy, tools, profiles (preview).</p>' +
        '</div>' +
        '<div class="vsp-card-grid">' +
          '<div class="vsp-card">' +
            '<h3>Gate policy</h3>' +
            '<ul class="vsp-list" id="vsp-settings-gate-list">' +
              '<li>Loading gate policy…</li>' +
            '</ul>' +
          '</div>' +
          '<div class="vsp-card">' +
            '<h3>Tools</h3>' +
            '<ul class="vsp-list" id="vsp-settings-tools-list">' +
              '<li>Loading tools…</li>' +
            '</ul>' +
          '</div>' +
          '<div class="vsp-card">' +
            '<h3>Profiles</h3>' +
            '<ul class="vsp-list" id="vsp-settings-extra-list">' +
              '<li>Loading profiles…</li>' +
            '</ul>' +
          '</div>' +
        '</div>' +
      '</div>';

    var gateList  = root.querySelector('#vsp-settings-gate-list');
    var toolsList = root.querySelector('#vsp-settings-tools-list');
    var extraList = root.querySelector('#vsp-settings-extra-list');

    var data;
    try {
      var res = await fetch('/api/vsp/settings_ui_v1', { cache: 'no-store' });
      data = await res.json();
    } catch (e) {
      console.error('[VSP_TABS_ROUTER_V1][SETTINGS] fetch error', e);
      if (gateList) gateList.innerHTML = '<li class="vsp-error">Không tải được settings.</li>';
      return;
    }

    var settings = data.settings || {};

    if (gateList) {
      if (!settings.gate_policy) {
        gateList.innerHTML = '' +
          '<li>Mode: Default</li>' +
          '<li>Fail nếu CRITICAL &gt; 0</li>' +
          '<li>Fail nếu HIGH &gt; 10</li>' +
          '<li>MEDIUM/LOW chỉ cảnh báo.</li>';
      } else {
        var gp = settings.gate_policy;
        gateList.innerHTML = Object.keys(gp).map(function (k) {
          return '<li><strong>' + esc(k) + ':</strong> ' + esc(gp[k]) + '</li>';
        }).join('');
      }
    }

    if (toolsList) {
      var tools = settings.tools || settings.tools_enabled || {};
      var names = Object.keys(tools);
      if (!names.length) {
        toolsList.innerHTML = '<li>Semgrep, Gitleaks, KICS, CodeQL, Trivy…</li>';
      } else {
        toolsList.innerHTML = names.map(function (name) {
          var v = tools[name];
          var enabled = (v === true || v === 'on' || v === 'enabled');
          return '<li><strong>' + esc(name) + '</strong> – ' + (enabled ? 'enabled' : 'disabled') + '</li>';
        }).join('');
      }
    }

    if (extraList) {
      var extras = settings.extras || settings.profiles || {};
      var keys = Object.keys(extras);
      if (!keys.length) {
        extraList.innerHTML = '<li>FULL_EXT / SMOKE profile mặc định.</li>';
      } else {
        extraList.innerHTML = keys.map(function (name) {
          return '<li><strong>' + esc(name) + ':</strong> ' + esc(JSON.stringify(extras[name])) + '</li>';
        }).join('');
      }
    }

    console.log('[VSP_TABS_ROUTER_V1] Settings rendered');
  }

  // ====== RULES ======
  async function renderRules(root) {
    console.log('[VSP_TABS_ROUTER_V1] renderRules');

    root.innerHTML = '' +
      '<div class="vsp-tab-inner vsp-tab-rules">' +
        '<div class="vsp-tab-header">' +
          '<h2>Rule Overrides</h2>' +
          '<p class="vsp-tab-subtitle">Danh sách rule đã override (giảm severity, accepted risk…).</p>' +
        '</div>' +
        '<div class="vsp-card vsp-table-card">' +
          '<div class="vsp-table-header">' +
            '<div><h3>Current overrides</h3></div>' +
          '</div>' +
          '<div class="vsp-table-wrapper">' +
            '<table class="vsp-table" id="vsp-rules-table">' +
              '<thead>' +
                '<tr>' +
                  '<th>Tool</th>' +
                  '<th>Rule</th>' +
                  '<th>CWE</th>' +
                  '<th>Action</th>' +
                  '<th>Reason</th>' +
                '</tr>' +
              '</thead>' +
              '<tbody>' +
                '<tr><td colspan="5" class="vsp-table-loading">Đang tải overrides…</td></tr>' +
              '</tbody>' +
            '</table>' +
          '</div>' +
        '</div>' +
      '</div>';

    var tbody = root.querySelector('#vsp-rules-table tbody');

    var data;
    try {
      var res = await fetch('/api/vsp/rule_overrides_ui_v1', { cache: 'no-store' });
      data = await res.json();
    } catch (e) {
      console.error('[VSP_TABS_ROUTER_V1][RULES] fetch error', e);
      if (tbody) {
        tbody.innerHTML = '<tr><td colspan="5" class="vsp-table-error">Không tải được overrides.</td></tr>';
      }
      return;
    }

    var items = Array.isArray(data.overrides) ? data.overrides : (Array.isArray(data) ? data : []);
    if (!tbody) return;

    if (!items.length) {
      tbody.innerHTML = '<tr><td colspan="5" class="vsp-table-empty">Chưa có rule override nào.</td></tr>';
      return;
    }

    tbody.innerHTML = items.map(function (o) {
      return '' +
        '<tr>' +
          '<td>' + esc(o.tool || '-') + '</td>' +
          '<td>' + esc(o.rule_id || o.id || '-') + '</td>' +
          '<td>' + esc(o.cwe || o.cwe_id || '-') + '</td>' +
          '<td>' + esc(o.action || o.mode || '-') + '</td>' +
          '<td>' + esc(o.reason || o.note || '-') + '</td>' +
        '</tr>';
    }).join('');

    console.log('[VSP_TABS_ROUTER_V1] Rules rendered with', items.length, 'items');
  }

  // ====== BIND SIDEBAR ======
  function bindSidebarTabs() {
    var map = {
      'dashboard': 'dashboard',
      'runs & reports': 'runs',
      'data source': 'datasource',
      'settings': 'settings',
      'rule overrides': 'rules'
    };

    var nodes = document.querySelectorAll('a, button, div, span');
    nodes.forEach(function (el) {
      var txt = (el.textContent || '').trim().toLowerCase();
      if (!txt || !(txt in map)) return;

      el.addEventListener('click', function (e) {
        // để middle-click / ctrl+click vẫn mở tab mới
        if (e.button !== 0 || e.metaKey || e.ctrlKey || e.shiftKey || e.altKey) return;
        e.preventDefault();
        var h = '#' + map[txt];
        if (window.location.hash === h) {
          // nếu hash giống hệt thì gọi lại router cho chắc
          handleHashChange();
        } else {
          window.location.hash = h;
        }
      });

      console.log('[VSP_TABS_ROUTER_V1] Bound sidebar tab for text =', txt);
    });
  }

  // ====== ROUTER ======
  async function handleHashChange() {
    var root = getRoot();
    if (!root) return;

    var hash = window.location.hash || '';
    hash = hash.replace('#', '');
    if (!hash) hash = 'dashboard';

    console.log('[VSP_TABS_ROUTER_V1] handleHashChange ->', hash);

    if (hash === 'dashboard' || hash === 'home') {
      // Giữ nguyên layout Dashboard server render
      return;
    }
    if (hash === 'runs')       return renderRuns(root);
    if (hash === 'datasource') return renderDataSource(root);
    if (hash === 'settings')   return renderSettings(root);
    if (hash === 'rules')      return renderRules(root);

    console.warn('[VSP_TABS_ROUTER_V1] Unknown hash', hash);
  }

  window.addEventListener('hashchange', function () {
    handleHashChange();
  });

  function init() {
    bindSidebarTabs();
    handleHashChange();
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();
