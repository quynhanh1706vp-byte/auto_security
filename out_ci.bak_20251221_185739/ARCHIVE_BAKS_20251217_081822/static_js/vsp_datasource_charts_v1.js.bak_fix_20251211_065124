// VSP_DS_CHARTS_BAR_V2
// Vẽ 2 Chart.js: Severity by tool (stacked bar) + Top directories (horizontal bar)
// dựa trên dữ liệu /api/vsp/datasource_v2?limit=1000

(function() {
  const LOG = "[VSP_DS_CHARTS_BAR]";

  function findCanvases() {
    const tab = document.querySelector("#vsp-tab-datasource");
    if (!tab) {
      console.warn(LOG, "Không thấy #vsp-tab-datasource.");
      return null;
    }
    const canvases = tab.querySelectorAll("canvas");
    if (canvases.length < 2) {
      console.warn(LOG, "Cần >= 2 canvas cho mini charts, hiện có:", canvases.length);
      return null;
    }
    return {
      tool: canvases[0],
      dirs: canvases[1],
    };
  }

  async function loadData() {
    const res = await fetch("/api/vsp/datasource_v2?limit=1000");
    const data = await res.json();
    return data.items || [];
  }

  function aggregate(items) {
    const severityOrder = ["CRITICAL", "HIGH", "MEDIUM", "LOW", "INFO", "TRACE"];
    const byTool = {};
    const byDir = {};

    for (const f of items) {
      const tool = (f.tool || "unknown").toString();
      let sev = (f.severity || "INFO").toString().toUpperCase();
      if (!severityOrder.includes(sev)) sev = "INFO";

      if (!byTool[tool]) {
        byTool[tool] = {};
        for (const s of severityOrder) byTool[tool][s] = 0;
      }
      byTool[tool][sev] = (byTool[tool][sev] || 0) + 1;

      const path =
        f.path ||
        f.file ||
        f.filepath ||
        (f.location && (f.location.path || f.location.file)) ||
        f.relpath ||
        "";
      if (path) {
        const parts = String(path).split("/");
        const dir =
          parts.slice(0, 3).join("/") + (parts.length > 3 ? "/..." : "");
        byDir[dir] = (byDir[dir] || 0) + 1;
      }
    }

    const tools = Object.keys(byTool)
      .sort((a, b) => {
        const sa = Object.values(byTool[a]).reduce((x, y) => x + y, 0);
        const sb = Object.values(byTool[b]).reduce((x, y) => x + y, 0);
        return sb - sa;
      })
      .slice(0, 6);

    const dirs = Object.entries(byDir)
      .sort((a, b) => b[1] - a[1])
      .slice(0, 6);

    return { severityOrder, tools, byTool, dirs };
  }

  function buildSeverityChart(ctx, agg) {
    const { severityOrder, tools, byTool } = agg;
    if (!tools.length) {
      console.log(LOG, "Không có data cho chart severity-by-tool.");
      return;
    }
    const colors = {
      CRITICAL: "#ef4444",
      HIGH: "#f97316",
      MEDIUM: "#eab308",
      LOW: "#22c55e",
      INFO: "#0ea5e9",
      TRACE: "#64748b",
    };

    const datasets = severityOrder.map((sev) => ({
      label: sev,
      data: tools.map((t) => byTool[t][sev] || 0),
      backgroundColor: colors[sev] || "#6b7280",
      stack: "severity",
    }));

    new Chart(ctx, {
      type: "bar",
      data: {
        labels: tools,
        datasets,
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: "bottom",
            labels: { color: "#e5e7eb", font: { size: 10 } },
          },
          tooltip: {
            mode: "index",
            intersect: false,
          },
        },
        scales: {
          x: {
            stacked: true,
            ticks: { color: "#9ca3af", font: { size: 10 } },
            grid: { display: false },
          },
          y: {
            stacked: true,
            ticks: { color: "#9ca3af", font: { size: 10 } },
            grid: { color: "rgba(148,163,184,0.25)" },
          },
        },
      },
    });
  }

  function buildDirsChart(ctx, agg) {
    const { dirs } = agg;
    if (!dirs.length) {
      console.log(LOG, "Không có data cho chart top-directories.");
      return;
    }
    const labels = dirs.map(([dir]) => dir);
    const values = dirs.map(([, count]) => count);

    new Chart(ctx, {
      type: "bar",
      data: {
        labels,
        datasets: [
          {
            label: "Findings",
            data: values,
          },
        ],
      },
      options: {
        indexAxis: "y",
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: { mode: "nearest", intersect: true },
        },
        scales: {
          x: {
            ticks: { color: "#9ca3af", font: { size: 10 } },
            grid: { color: "rgba(148,163,184,0.25)" },
          },
          y: {
            ticks: { color: "#9ca3af", font: { size: 10 } },
            grid: { display: false },
          },
        },
      },
    });
  }

  async function init() {
    if (typeof Chart === "undefined") {
      console.warn(LOG, "Chart.js chưa được load (window.Chart undefined).");
      return;
    }
    const cvs = findCanvases();
    if (!cvs) return;

    try {
      const items = await loadData();
      if (!items.length) {
        console.log(LOG, "Không có findings để vẽ mini charts.");
        return;
      }
      const agg = aggregate(items);
      buildSeverityChart(cvs.tool.getContext("2d"), agg);
      buildDirsChart(cvs.dirs.getContext("2d"), agg);
    } catch (e) {
      console.warn(LOG, "Init error:", e);
    }
  }

  function start() {
    // chờ DS zone inject + height fix
    setTimeout(init, 700);
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", start);
  } else {
    start();
  }
})();
