// static/js/vsp_dashboard_enhance_v1.js
// V4 – Hydrate KPI Dashboard, handle object fields + nhiều ID DOM, lazy theo hash (#dashboard)

(function () {
  'use strict';

  if (window.VSP_DASH_ENHANCE_V4) return;
  window.VSP_DASH_ENHANCE_V4 = true;

  var LOG_PREFIX = '[VSP_DASH]';

  function $(sel) { return document.querySelector(sel); }

  function setText(id, value) {
    var el = document.getElementById(id);
    if (!el) return;
    if (value === null || value === undefined || value === '') {
      el.textContent = '—';
    } else {
      el.textContent = String(value);
    }
  }

  // Bắn vào nhiều ID cùng lúc: ID nào tồn tại sẽ được set
  function setTextAny(ids, value) {
    ids.forEach(function (id) { setText(id, value); });
  }

  function showError(msg) {
    var el = $('#vsp-dashboard-error');
    if (!el) return;
    el.textContent = msg || 'Không load được dữ liệu dashboard.';
    el.style.display = 'block';
  }

  function hideError() {
    var el = $('#vsp-dashboard-error');
    if (!el) return;
    el.style.display = 'none';
  }

  async function fetchDashboard() {
    try {
      var res = await fetch('/api/vsp/dashboard_v3', { cache: 'no-store' });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      var data = await res.json();
      console.log(LOG_PREFIX, 'dashboard_v3 data =', data);
      return data;
    } catch (e) {
      console.error(LOG_PREFIX, 'fetch dashboard_v3 error:', e);
      return null;
    }
  }

  // ---- Helpers để lấy text đẹp từ object ----
  function extractLabel(x) {
    if (x === null || x === undefined) return 'N/A';
    var t = typeof x;
    if (t === 'string' || t === 'number' || t === 'boolean') {
      return String(x);
    }
    if (Array.isArray(x)) {
      return x.map(extractLabel).join(', ');
    }
    var candKeys = [
      'label', 'name', 'id', 'code',
      'cwe', 'cwe_id', 'cwe_code',
      'module', 'file', 'path', 'target'
    ];
    for (var i = 0; i < candKeys.length; i++) {
      var k = candKeys[i];
      if (x[k]) return String(x[k]);
    }
    try { return JSON.stringify(x); } catch (e) { return '[object]'; }
  }

  function getTotalFindings(data) {
    if (!data) return null;
    if (data.total_findings != null) return data.total_findings;
    if (data.total_vulns != null) return data.total_vulns;
    if (data.summary_all && data.summary_all.total_findings != null)
      return data.summary_all.total_findings;
    if (data.metrics && data.metrics.total_findings != null)
      return data.metrics.total_findings;
    return null;
  }

  function getSeverityCounts(data) {
    var sev = (data && (data.by_severity || data.severity_cards)) || {};
    if (!Object.keys(sev).length && data && data.summary_all && data.summary_all.by_severity) {
      sev = data.summary_all.by_severity;
    }
    var result = {};
    ['CRITICAL','HIGH','MEDIUM','LOW','INFO','TRACE'].forEach(function (k) {
      var v = sev[k];
      if (v == null) {
        result[k] = 0;
      } else if (typeof v === 'number') {
        result[k] = v;
      } else if (typeof v === 'object' && v.count != null) {
        result[k] = v.count;
      } else {
        result[k] = Number(v) || 0;
      }
    });
    return result;
  }

  function applyKpi(data) {
    if (!data) return;

    window.VSP_DASHBOARD_DATA = data;

    var latestRun = data.latest_run_id || data.run_id || (data.last_run && data.last_run.run_id);
    var totalFindings = getTotalFindings(data);
    var score = (data.security_posture_score != null)
      ? data.security_posture_score
      : data.security_score;

    // TOTAL FINDINGS + RUN ID + SCORE – bắn vào nhiều ID ứng viên
    setTextAny(['vsp-kpi-latest-run-id','vsp-kpi-run-id'], latestRun || 'N/A');
    setTextAny(['vsp-kpi-total-findings','vsp-kpi-total_findings','vsp-kpi-total'], totalFindings);
    setTextAny(['vsp-kpi-security-score','vsp-kpi-score'], score);

    // Top tool / CWE / module
    setTextAny(['vsp-kpi-top-tool'],   extractLabel(data.top_risky_tool));
    setTextAny(['vsp-kpi-top-cwe'],    extractLabel(data.top_impacted_cwe));
    setTextAny(['vsp-kpi-top-module'], extractLabel(data.top_vulnerable_module));

    // 6 bucket severity – cũng bắn vào nhiều ID cho chắc
    var sev = getSeverityCounts(data);
    setTextAny(['vsp-sev-critical','vsp-kpi-critical','vsp-kpi-sev-critical'], sev.CRITICAL);
    setTextAny(['vsp-sev-high','vsp-kpi-high','vsp-kpi-sev-high'],             sev.HIGH);
    setTextAny(['vsp-sev-medium','vsp-kpi-medium','vsp-kpi-sev-medium'],       sev.MEDIUM);
    setTextAny(['vsp-sev-low','vsp-kpi-low','vsp-kpi-sev-low'],                sev.LOW);
    setTextAny(['vsp-sev-info','vsp-kpi-info','vsp-kpi-sev-info'],             sev.INFO);
    setTextAny(['vsp-sev-trace','vsp-kpi-trace','vsp-kpi-sev-trace'],          sev.TRACE);

    // Mini strip
    var toolsUsed = data.tools_used || (data.metrics && data.metrics.tools_used);
    if (Array.isArray(toolsUsed)) {
      setTextAny(['vsp-kpi-mini-tools'], toolsUsed.join(', '));
    } else {
      setTextAny(['vsp-kpi-mini-tools'], toolsUsed || '');
    }
    setTextAny(['vsp-kpi-mini-duration'],
      data.scan_duration_human ||
      (data.metrics && data.metrics.scan_duration_human) ||
      ''
    );

    // Bridge sang charts (nếu có)
    try {
      if (window.VSP_DASH_CHARTS &&
          typeof window.VSP_DASH_CHARTS.updateFromDashboard === 'function') {
        window.VSP_DASH_CHARTS.updateFromDashboard(data);
      }
    } catch (e) {
      console.warn(LOG_PREFIX, 'chart bridge error:', e);
    }
  }

  var hydrated = false;

  async function hydrateDashboard() {
    if (hydrated) return;
    var pane = document.getElementById('vsp-dashboard-main');
    if (!pane) {
      console.warn(LOG_PREFIX, 'Không tìm thấy pane #vsp-dashboard-main');
      return;
    }

    console.log(LOG_PREFIX, 'Hydrating dashboard...');
    hideError();

    var data = await fetchDashboard();
    if (!data) {
      showError('Không tải được /api/vsp/dashboard_v3');
      return;
    }
    if (data.ok === false && data.error) {
      console.error(LOG_PREFIX, 'API trả lỗi:', data.error);
      showError(data.error);
      return;
    }

    applyKpi(data);
    hydrated = true;
    console.log(LOG_PREFIX, 'Dashboard hydrated OK.');
  }

  function shouldHydrateNow() {
    var hash = window.location.hash || '#dashboard';
    return hash === '' || hash === '#dashboard';
  }

  function onHashChange() {
    if (shouldHydrateNow()) {
      hydrateDashboard();
    }
  }

  function onReady() {
    console.log(LOG_PREFIX, 'vsp_dashboard_enhance_v1.js (V4) loaded');
    if (shouldHydrateNow()) {
      hydrateDashboard();
    }
  }

  window.addEventListener('DOMContentLoaded', onReady);
  window.addEventListener('hashchange', onHashChange);
})();

// === VSP 2025 PATCH – ensure charts engine is called ===
;(function () {
  if (!window || !window.VSP_DASHBOARD_ENHANCE_PATCHED_V3) {
    window.VSP_DASHBOARD_ENHANCE_PATCHED_V3 = true;
  } else {
    return;
  }

  console.log('[VSP_DASH_PATCH] Patching hydrateDashboard to call charts_v3.');

  var oldHydrate = window.hydrateDashboard;
  if (typeof oldHydrate !== 'function') {
    console.warn('[VSP_DASH_PATCH] hydrateDashboard is not a function, skip patch.');
    return;
  }

  