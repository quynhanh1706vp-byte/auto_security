// VSP_DS_CHARTS_SECTION_V2
// - Tạo section "Data Source – mini charts" dưới bảng unified
// - Nếu Chart.js + data OK -> vẽ 2 chart
// - Nếu không -> hiển thị list top tool / top directories

(function() {
  const LOG = "[VSP_DS_CHARTS_SECTION]";

  async function loadData() {
    const res = await fetch("/api/vsp/datasource_v2?limit=1000");
    const data = await res.json();
    return data.items || [];
  }

  function aggregate(items) {
    const severityOrder = ["CRITICAL","HIGH","MEDIUM","LOW","INFO","TRACE"];
    const byTool = {};
    const byDir  = {};

    for (const f of items) {
      const tool = (f.tool || "unknown").toString();
      let sev = (f.severity || "INFO").toString().toUpperCase();
      if (!severityOrder.includes(sev)) sev = "INFO";

      if (!byTool[tool]) {
        byTool[tool] = { total: 0 };
        severityOrder.forEach(s => byTool[tool][s] = 0);
      }
      byTool[tool][sev] = (byTool[tool][sev] || 0) + 1;
      byTool[tool].total += 1;

      const path =
        f.path ||
        f.file ||
        f.filepath ||
        (f.location && (f.location.path || f.location.file)) ||
        f.relpath ||
        "";
      if (path) {
        const parts = String(path).split("/");
        const dir = parts.slice(0, 3).join("/") + (parts.length > 3 ? "/..." : "");
        byDir[dir] = (byDir[dir] || 0) + 1;
      }
    }

    const toolsSorted = Object.entries(byTool)
      .sort((a,b) => b[1].total - a[1].total)
      .slice(0,6);
    const dirsSorted = Object.entries(byDir)
      .sort((a,b)=>b[1] - a[1])
      .slice(0,6);

    return { severityOrder, byTool, toolsSorted, dirsSorted };
  }

  function ensureSection() {
    const tab = document.querySelector("#vsp-tab-datasource");
    if (!tab) return null;

    let section = document.getElementById("vsp-ds-mini-section");
    if (!section) {
      section = document.createElement("section");
      section.id = "vsp-ds-mini-section";
      section.className = "vsp-ds-mini-section";
      section.innerHTML = `
        <div class="vsp-ds-mini-header">
          <div>
            <div class="vsp-ds-mini-title">Data Source – mini charts</div>
            <div class="vsp-ds-mini-subtitle">
              Severity theo tool và Top directories dựa trên findings_unified hiện đang load.
            </div>
          </div>
        </div>
        <div class="vsp-ds-mini-grid">
          <div class="vsp-chart-card vsp-ds-card">
            <div class="vsp-chart-card-header">
              <div class="vsp-chart-card-title">Severity by tool</div>
              <div class="vsp-chart-card-subtitle">
                Phân bố CRIT/HIGH/MED/LOW/INFO/TRACE theo từng tool.
              </div>
            </div>
            <div class="vsp-chart-card-body">
              <div class="vsp-chart-canvas-wrapper">
                <canvas id="vsp-ds-chart-tools"></canvas>
              </div>
            </div>
            <div class="vsp-mini-list" id="vsp-ds-tools-list"></div>
          </div>
          <div class="vsp-chart-card vsp-ds-card">
            <div class="vsp-chart-card-header">
              <div class="vsp-chart-card-title">Top directories</div>
              <div class="vsp-chart-card-subtitle">
                Thư mục có nhiều findings nhất (từ path).
              </div>
            </div>
            <div class="vsp-chart-card-body">
              <div class="vsp-chart-canvas-wrapper">
                <canvas id="vsp-ds-chart-dirs"></canvas>
              </div>
            </div>
            <div class="vsp-mini-list" id="vsp-ds-dirs-list"></div>
          </div>
        </div>
      `;
      tab.appendChild(section);
      console.log(LOG, "Đã tạo section mini charts trong Data Source.");
    }
    return section;
  }

  function buildSeverityChart(ctx, agg) {
    const { severityOrder, toolsSorted, byTool } = agg;
    if (!toolsSorted.length) {
      console.log(LOG, "Không có data cho chart severity-by-tool.");
      return false;
    }
    const labels = toolsSorted.map(([tool]) => tool);
    const datasets = severityOrder.map((sev) => ({
      label: sev,
      data: toolsSorted.map(([tool]) => byTool[tool][sev] || 0),
      backgroundColor: {
        CRITICAL: "#ef4444",
        HIGH: "#f97316",
        MEDIUM: "#eab308",
        LOW: "#22c55e",
        INFO: "#0ea5e9",
        TRACE: "#64748b",
      }[sev] || "#6b7280",
      stack: "severity",
    }));

    new Chart(ctx, {
      type: "bar",
      data: { labels, datasets },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: "bottom",
            labels: { color: "#e5e7eb", font: { size: 10 } },
          },
          tooltip: { mode: "index", intersect: false },
        },
        scales: {
          x: {
            stacked: true,
            ticks: { color: "#9ca3af", font: { size: 10 } },
            grid: { display: false },
          },
          y: {
            stacked: true,
            ticks: { color: "#9ca3af", font: { size: 10 } },
            grid: { color: "rgba(148,163,184,0.25)" },
          },
        },
      },
    });
    return true;
  }

  function buildDirsChart(ctx, agg) {
    const { dirsSorted } = agg;
    if (!dirsSorted.length) {
      console.log(LOG, "Không có data cho chart top-directories.");
      return false;
    }
    const labels = dirsSorted.map(([dir]) => dir);
    const values = dirsSorted.map(([, count]) => count);

    new Chart(ctx, {
      type: "bar",
      data: {
        labels,
        datasets: [{ label: "Findings", data: values }],
      },
      options: {
        indexAxis: "y",
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: { mode: "nearest", intersect: true },
        },
        scales: {
          x: {
            ticks: { color: "#9ca3af", font: { size: 10 } },
            grid: { color: "rgba(148,163,184,0.25)" },
          },
          y: {
            ticks: { color: "#9ca3af", font: { size: 10 } },
            grid: { display: false },
          },
        },
      },
    });
    return true;
  }

  function renderToolsList(container, agg) {
    if (!container) return;
    container.innerHTML = "";
    const { toolsSorted } = agg;
    if (!toolsSorted.length) {
      container.innerHTML =
        '<div class="vsp-preview-note">Không có findings nào để tổng hợp theo tool.</div>';
      return;
    }
    toolsSorted.forEach(([tool, obj], idx) => {
      const row = document.createElement("div");
      row.className = "vsp-mini-row";
      row.innerHTML =
        `<span class="vsp-mini-rank">${idx + 1}</span>` +
        `<span class="vsp-mini-name">${tool}</span>` +
        `<span class="vsp-mini-count">${obj.total}</span>`;
      container.appendChild(row);
    });
  }

  function renderDirsList(container, agg) {
    if (!container) return;
    container.innerHTML = "";
    const { dirsSorted } = agg;
    if (!dirsSorted.length) {
      container.innerHTML =
        '<div class="vsp-preview-note">Không có findings nào để tổng hợp theo thư mục.</div>';
      return;
    }
    dirsSorted.forEach(([dir, count], idx) => {
      const row = document.createElement("div");
      row.className = "vsp-mini-row";
      row.innerHTML =
        `<span class="vsp-mini-rank">${idx + 1}</span>` +
        `<span class="vsp-mini-name">${dir}</span>` +
        `<span class="vsp-mini-count">${count}</span>`;
      container.appendChild(row);
    });
  }

  async function init() {
    const section = ensureSection();
    if (!section) {
      console.warn(LOG, "Không tìm thấy tab Data Source để gắn section.");
      return;
    }

    let items;
    try {
      items = await loadData();
    } catch (e) {
      console.warn(LOG, "Lỗi load datasource_v2:", e);
      return;
    }

    if (!items.length) {
      console.log(LOG, "Không có findings để vẽ mini charts.");
      return;
    }

    const agg = aggregate(items);
    console.log(LOG, "Agg:", agg);

    const cvsTools = document.getElementById("vsp-ds-chart-tools");
    const cvsDirs  = document.getElementById("vsp-ds-chart-dirs");
    const listTools = document.getElementById("vsp-ds-tools-list");
    const listDirs  = document.getElementById("vsp-ds-dirs-list");

    const canChart = typeof Chart !== "undefined";

    if (canChart && cvsTools && cvsDirs) {
      buildSeverityChart(cvsTools.getContext("2d"), agg);
      buildDirsChart(cvsDirs.getContext("2d"), agg);
    } else {
      console.warn(LOG, "Chart.js hoặc canvas không sẵn sàng – chỉ hiển thị list.");
    }

    renderToolsList(listTools, agg);
    renderDirsList(listDirs, agg);
  }

  function start() {
    let tries = 0;
    const maxTries = 30;
    const timer = setInterval(() => {
      const tab = document.querySelector("#vsp-tab-datasource");
      if (tab) {
        clearInterval(timer);
        init();
      } else if (++tries >= maxTries) {
        clearInterval(timer);
        console.warn(LOG, "Give up sau", tries, "lần – không thấy tab Data Source.");
      }
    }, 400);
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", start);
  } else {
    start();
  }
})();
