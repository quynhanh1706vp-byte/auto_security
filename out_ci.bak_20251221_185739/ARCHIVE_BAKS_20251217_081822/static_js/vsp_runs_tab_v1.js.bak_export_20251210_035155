// VSP_RUNS_TAB_V1 – Runs & Reports tab (commercial v1)
(function () {
  const LOG = "[VSP_RUNS_TAB]";
  const API = "/api/vsp/runs_index_v3";

  let loadedOnce = false;

  function fmtDate(s) {
    if (!s) return "-";
    try {
      const d = new Date(s);
      if (isNaN(d.getTime())) return s;
      return d.toLocaleString();
    } catch (e) {
      return s;
    }
  }

  function fmtScore(x) {
    if (x === null || x === undefined) return "-";
    return x;
  }

  function createActionButtons(run) {
    const runId = run.run_id || run.id || "";
    if (!runId) return "";

    const btnDashboard = `
      <button class="vsp-btn vsp-btn-ghost" data-action="view-dashboard" data-run-id="${runId}">
        Dashboard
      </button>
    `;

    const btnHtml = `
      <button class="vsp-btn vsp-btn-ghost" data-action="download-html" data-run-id="${runId}">
        HTML
      </button>
    `;

    const btnPdf = `
      <button class="vsp-btn vsp-btn-ghost" data-action="download-pdf" data-run-id="${runId}">
        PDF
      </button>
    `;

    const btnZip = `
      <button class="vsp-btn vsp-btn-ghost" data-action="download-zip" data-run-id="${runId}">
        ZIP
      </button>
    `;

    return btnDashboard + btnHtml + btnPdf + btnZip;
  }

  function wireActions(tbody) {
    tbody.addEventListener("click", function (e) {
      const btn = e.target.closest("button[data-action]");
      if (!btn) return;

      const action = btn.getAttribute("data-action");
      const runId = btn.getAttribute("data-run-id");
      if (!runId) return;

      console.log(LOG, "action", action, "runId", runId);

      if (action === "view-dashboard") {
        // TODO: map BE route dashboard by run_id
        window.open(`/vsp/dashboard?run_id=${encodeURIComponent(runId)}`, "_blank");
        return;
      }

      if (action === "download-html") {
        window.open(`/api/vsp/run_export_v3?run_id=${encodeURIComponent(runId)}&fmt=html`, "_blank");
        return;
      }

      if (action === "download-pdf") {
        window.open(`/api/vsp/run_export_v3?run_id=${encodeURIComponent(runId)}&fmt=pdf`, "_blank");
        return;
      }

      if (action === "download-zip") {
        window.open(`/api/vsp/run_export_v3?run_id=${encodeURIComponent(runId)}&fmt=zip`, "_blank");
        return;
      }
    });
  }

  async function loadRuns() {
    const tbody = document.getElementById("vsp-runs-tbody");
    if (!tbody) {
      console.warn(LOG, "Không tìm thấy tbody #vsp-runs-tbody");
      return;
    }

    tbody.innerHTML = `
      <tr><td colspan="6" class="vsp-table-loading">
        Đang tải lịch sử runs...
      </td></tr>
    `;

    try {
      const res = await fetch(API);
      if (!res.ok) {
        throw new Error("HTTP " + res.status);
      }
      const data = await res.json();
      console.log(LOG, "runs_index_v3 size=", data.length);

      if (!Array.isArray(data) || !data.length) {
        tbody.innerHTML = `
          <tr><td colspan="6" class="vsp-table-empty">
            Chưa có run nào được ghi nhận.
          </td></tr>
        `;
        return;
      }

      const rows = data.map(run => {
        const runId = run.run_id || run.id || "-";
        const profile = run.profile || run.scan_profile || "-";
        const startedAt = run.started_at || run.start_time || run.created_at || null;
        const totalFindings = (
          run.total_findings ??
          run.findings_total ??
          run.total ??
          "-"
        );
        const score = (
          run.security_score ??
          run.score ??
          null
        );

        return `
          <tr>
            <td class="vsp-font-mono">${runId}</td>
            <td>${profile}</td>
            <td>${fmtDate(startedAt)}</td>
            <td>${totalFindings}</td>
            <td>${fmtScore(score)}</td>
            <td>${createActionButtons(run)}</td>
          </tr>
        `;
      });

      tbody.innerHTML = rows.join("");
      wireActions(tbody);
    } catch (err) {
      console.error(LOG, "Lỗi load runs:", err);
      tbody.innerHTML = `
        <tr><td colspan="6" class="vsp-table-error">
          Không tải được dữ liệu runs. Vui lòng kiểm tra console hoặc API <code>${API}</code>.
        </td></tr>
      `;
    }
  }

  // Expose cho tabs runtime gọi
  window.vspLoadRunsTab = function () {
    if (loadedOnce) {
      console.log(LOG, "skip reload (đã load 1 lần)");
      return;
    }
    loadedOnce = true;
    console.log(LOG, "loadRuns()");
    loadRuns();
  };

  console.log(LOG, "initialized");
})();
