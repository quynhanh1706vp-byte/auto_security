/* === VSP_UI_FIX_ARTLIST_NULL_V1 === */
/* === VSP_UI_4TABS_COMMERCIAL_V1 === */
(function(){
  const API = {
    runsIndex: "/api/vsp/runs_index_v3_fs_resolved?limit=20&hide_empty=0&filter=1",
    statusV2: (rid) => `/api/vsp/run_status_v2/${encodeURIComponent(rid)}`,
    artIndex: (rid) => `/api/vsp/run_artifacts_index_v1/${encodeURIComponent(rid)}`
  };

  const $ = (s, r=document) => r.querySelector(s);
  const $all = (s, r=document) => Array.from(r.querySelectorAll(s));

  async function fetchJSON(url){
    const r = await fetch(url, {headers: {"Accept":"application/json"}});
    if (!r.ok) throw new Error(`HTTP ${r.status} ${url}`);
    return await r.json();
  }

  function normRid(runId){
    if (!runId) return "";
    runId = String(runId).trim();
    if (runId.startsWith("RUN_")) return runId;
    if (runId.startsWith("VSP_CI_")) return "RUN_" + runId;
    return runId;
  }

  function badge(verdict, label){
    const v = (verdict||"").toUpperCase();
    let cls="vsp-badge-muted", dot="vsp-dot-muted", text=v||"N/A";
    if (v==="GREEN"){cls="vsp-badge-green";dot="vsp-dot-green";}
    else if (v==="AMBER"||v==="YELLOW"){cls="vsp-badge-amber";dot="vsp-dot-amber";text="AMBER";}
    else if (v==="RED"){cls="vsp-badge-red";dot="vsp-dot-red";}
    else if (v==="DISABLED"||v==="NOT_RUN"||v==="DEGRADED"){cls="vsp-badge-muted";dot="vsp-dot-muted";text=v;}
    return `<span class="vsp-badge ${cls}" title="${label||""}"><span class="vsp-dot ${dot}"></span>${text}</span>`;
  }

  function setHTML(id, html){ const el=document.getElementById(id); if (el) el.innerHTML=html; }
  function setText(id, txt){ const el=document.getElementById(id); if (el) el.textContent=txt; }

  function tabSwitch(name){
    const tabs = ["dashboard","runs","settings","data"];
    tabs.forEach(t=>{
      const sec = document.getElementById(`tab-${t}`);
      if (sec) sec.style.display = (t===name) ? "" : "none";
    });
    $all("#nav button").forEach(b=>b.classList.toggle("active", b.dataset.tab===name));
    const titleMap = {dashboard:"Dashboard", runs:"Runs & Reports", settings:"Settings", data:"Data Source"};
    setText("page-title", titleMap[name] || "VSP");
  }

  function renderGateByTool(s){
    const rg = s.run_gate_summary || {};
    const bt = rg.by_tool || {};
    const rows = Object.keys(bt).sort().map(k=>{
      const o = bt[k]||{};
      const v = o.verdict || "N/A";
      const total = o.total ?? 0;
      return `<div class="vsp-row" style="margin:8px 0">
        <div style="min-width:92px;font-weight:800">${k}</div>
        <div>${badge(v, k)}</div>
        <div class="vsp-muted">total: <span class="vsp-mono">${total}</span></div>
      </div>`;
    }).join("");
    $("#gate-bytool").innerHTML = rows || `<div class="vsp-muted">No gate summary</div>`;
    setText("gate-ts", rg.ts ? `ts: ${rg.ts}` : "ts: -");
  }

  function updateKpis(s){
    const overall = s.overall_verdict || s.overall || (s.run_gate_summary && s.run_gate_summary.overall) || "N/A";
    const gateOverall = (s.run_gate_summary && (s.run_gate_summary.overall_verdict || s.run_gate_summary.overall)) || overall || "N/A";

    const glV = s.gitleaks_verdict || "NOT_RUN";
    const glT = Number(s.gitleaks_total || 0);

    let cqV = s.codeql_verdict || (s.has_codeql ? "AMBER" : "DISABLED");
    let cqT = Number(s.codeql_total || 0);
    if (!s.has_codeql && (cqV==="GREEN"||cqV==="AMBER"||cqV==="RED")) cqV="DISABLED";

    setHTML("kpi-overall", badge(overall,"status_v2.overall_verdict"));
    setText("kpi-overall-sub", s.rid_norm ? `RID: ${s.rid_norm}` : "");
    setHTML("kpi-gate", badge(gateOverall,"run_gate_summary.overall"));
    setText("kpi-gate-sub", s.run_gate_summary && s.run_gate_summary.ts ? `ts: ${s.run_gate_summary.ts}` : "");
    setHTML("kpi-gitleaks", badge(glV,"gitleaks_verdict"));
    setText("kpi-gitleaks-sub", `total: ${glT}`);
    setHTML("kpi-codeql", badge(cqV,"codeql_verdict"));
    setText("kpi-codeql-sub", `total: ${cqT}`);

    setHTML("pill-overall", badge(overall));
  }

  function updateMeta(s){
    const lines = [
      `rid: ${s.rid || "-"}`,
      `rid_norm: ${s.rid_norm || "-"}`,
      `ci_run_dir: ${s.ci_run_dir || "-"}`,
      `status: ${s.status || "-"}`,
      `stage: ${s.stage_name || "-"}`,
      `degraded_n: ${s.degraded_n ?? (Array.isArray(s.degraded_tools) ? s.degraded_tools.length : 0)}`
    ];
    $("#run-meta").textContent = lines.join("\n");
  }

  async function renderArtifacts(rid){
    try{
      const j = await fetchJSON(API.artIndex(rid));
      const items = j.items || j.artifacts || j.files || [];
      setText("art-count", `count: ${items.length}`);
      const __pa = $("#pill-art"); if(__pa) __pa.textContent = String(items.length);
      const __al=$("#art-list"); if(__al) __al.textContent = items.slice(0,300).map(x=>{
        if (typeof x === "string") return x;
        return x.path || x.name || JSON.stringify(x);
      }).join("\n");
    }catch(e){
      setText("art-count", "count: -");
      const __al=$("#art-list"); if(__al) __al.textContent = String(e);
  }
  }

  async function loadRuns(){
    const idx = await fetchJSON(API.runsIndex);
    const items = idx.items || idx.runs || idx.data || [];
    $("#pill-runs").textContent = String(items.length || 0);

    // build picker
    const optHtml = items.map(it=>{
      const runId = it.run_id || it.id || it.rid || it.rid_norm || it.name || "";
      const rid = normRid(runId);
      return `<option value="${rid}">${rid}</option>`;
    }).join("");
    $("#run-picker").innerHTML = optHtml || `<option value="">(no runs)</option>`;

    // build runs table (with status_v2)
    const tbody = $("#runs-tbody");
    tbody.innerHTML = "";
    for (const it of items.slice(0,20)){
      const runId = it.run_id || it.id || it.rid || it.rid_norm || it.name || "";
      const rid = normRid(runId);
      if (!rid.startsWith("RUN_")) continue;

      let s = null;
      try { s = await fetchJSON(API.statusV2(rid)); } catch(e){ s = null; }

      const overall = s ? (s.overall_verdict || (s.run_gate_summary && s.run_gate_summary.overall) || "N/A") : "N/A";
      const gate = s && s.run_gate_summary ? (s.run_gate_summary.overall || "N/A") : "N/A";
      const glV = s ? (s.gitleaks_verdict || "NOT_RUN") : "N/A";
      const cqV = s ? (s.codeql_verdict || (s.has_codeql ? "AMBER" : "DISABLED")) : "N/A";
      const deg = s ? (s.degraded_n ?? (Array.isArray(s.degraded_tools)?s.degraded_tools.length:0)) : "-";

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="vsp-mono">${rid}</td>
        <td>${badge(overall)}</td>
        <td>${badge(gate)}</td>
        <td>${badge(glV)} <span class="vsp-muted">(t=${Number((s&&s.gitleaks_total)||0)})</span></td>
        <td>${badge(cqV)} <span class="vsp-muted">(t=${Number((s&&s.codeql_total)||0)})</span></td>
        <td class="vsp-mono">${deg}</td>
      `;
      tr.style.cursor="pointer";
      tr.addEventListener("click", async ()=>{
        $("#run-picker").value = rid;
        await loadOne(rid);
        tabSwitch("dashboard");
      });
      tbody.appendChild(tr);
    }
  }

  async function loadOne(rid){
    if (!rid) return;
    let s = null;
    try { s = await fetchJSON(API.statusV2(rid)); } catch(e){ s = null; }
    if (!s){
      setText("run-meta", "cannot load status_v2");
      return;
    }
    updateKpis(s);
    renderGateByTool(s);
    updateMeta(s);
    await renderArtifacts(rid);
    await _vsp_setup_export_links(rid);
    await _vsp_render_datasource(rid, s);
  }

  function loadSettingsUi(){
    const key = (k)=>`vsp_ui_set_${k}`;
    const enable = localStorage.getItem(key("ENABLE_CODEQL")) ?? "1";
    const tCodeql = localStorage.getItem(key("TIMEOUT_CODEQL")) ?? "3600s";
    const tKics = localStorage.getItem(key("TIMEOUT_KICS")) ?? "1800s";
    $("#set-enable-codeql").value = enable;
    $("#set-timeout-codeql").value = tCodeql;
    $("#set-timeout-kics").value = tKics;

    $("#set-enable-codeql").addEventListener("change", ()=>localStorage.setItem(key("ENABLE_CODEQL"), $("#set-enable-codeql").value));
    $("#set-timeout-codeql").addEventListener("change", ()=>localStorage.setItem(key("TIMEOUT_CODEQL"), $("#set-timeout-codeql").value));
    $("#set-timeout-kics").addEventListener("change", ()=>localStorage.setItem(key("TIMEOUT_KICS"), $("#set-timeout-kics").value));
  }

  function bootNav(){
    $all("#nav button").forEach(b=>{
      b.addEventListener("click", ()=>{
        tabSwitch(b.dataset.tab);
      });
    });
    $("#btn-refresh").addEventListener("click", async ()=>{
      await loadRuns();
      const rid = $("#run-picker").value;
      if (rid) await loadOne(rid);
    await _vsp_setup_export_links(rid);
  });
    $("#run-picker").addEventListener("change", async ()=>{
      const rid = $("#run-picker").value;
      if (rid) await loadOne(rid);
    });
  }

/* === VSP_UI_4TABS_EXPORT_DS_V1 === */
async function _vsp_try_head(url){
  try{
    const r = await fetch(url, {method:"HEAD"});
    if (r.ok) return true;
  }catch(e){}
  try{
    const r2 = await fetch(url, {method:"GET", headers: {"Range":"bytes=0-0"}});
    if (r2.ok) return true;
  }catch(e){}
  return false;
}

async function _vsp_probe_first(urls){
  for (const u of urls){
    if (await _vsp_try_head(u)) return u;
  }
  return null;
}

function _vsp_disable_link(a, reason){
  if (!a) return;
  a.href = "#";
  a.style.opacity = "0.45";
  a.style.pointerEvents = "none";
  if (reason) a.title = reason;
}

function _vsp_pretty(obj){
  try { return JSON.stringify(obj, null, 2); } catch(e){ return String(obj); }
}

// try to fetch an artifact file by probing common endpoints
async function _vsp_fetch_artifact_text(rid, path){
  const qp = encodeURIComponent(path);
  const cands = [
    `/api/vsp/run_artifact_v1/${encodeURIComponent(rid)}?path=${qp}`,
    `/api/vsp/run_artifact_get_v1/${encodeURIComponent(rid)}?path=${qp}`,
    `/api/vsp/run_artifacts_get_v1/${encodeURIComponent(rid)}?path=${qp}`,
    `/api/vsp/artifact_get_v1/${encodeURIComponent(rid)}?path=${qp}`,
    `/api/vsp/run_artifact_v1/${encodeURIComponent(rid)}?p=${qp}`,
    `/api/vsp/run_artifact_get_v1/${encodeURIComponent(rid)}?p=${qp}`,
  ];
  for (const u of cands){
    try{
      const r = await fetch(u, {headers: {"Accept":"text/plain,application/json,*/*"}});
      if (!r.ok) continue;
      const txt = await r.text();
      // heuristic: not an HTML error page
      if ((txt||"").trim().startsWith("<!DOCTYPE html") || (txt||"").includes("HTTP_404")) continue;
      return {ok:true, url:u, text:txt};
    }catch(e){}
  }
  return {ok:false, url:null, text:null};
}

function _vsp_parse_csv_preview(csvText, limitRows=50){
  const lines = (csvText||"").split(/\r?\n/).filter(x=>x.trim().length>0);
  if (!lines.length) return {cols:[], rows:[]};
  // naive CSV split (good enough for preview)
  const split = (s)=> {
    const out=[]; let cur=""; let q=false;
    for (let i=0;i<s.length;i++){
      const ch=s[i];
      if (ch === '"' ){ q = !q; continue; }
      if (ch === "," && !q){ out.push(cur); cur=""; continue; }
      cur+=ch;
    }
    out.push(cur);
    return out.map(x=>x.trim());
  };
  const cols = split(lines[0]).slice(0,40);
  const rows = [];
  for (let i=1;i<lines.length && rows.length<limitRows;i++){
    rows.push(split(lines[i]).slice(0,40));
  }
  return {cols, rows};
}

function _vsp_render_findings_table(cols, rows){
  const head = document.getElementById("ds-findings-head");
  const body = document.getElementById("ds-findings-body");
  if (!head || !body) return;

  head.innerHTML = "";
  body.innerHTML = "";

  cols.slice(0,14).forEach(c=>{
    const th = document.createElement("th");
    th.textContent = c;
    head.appendChild(th);
  });

  rows.slice(0,80).forEach(r=>{
    const tr = document.createElement("tr");
    cols.slice(0,14).forEach((_,i)=>{
      const td = document.createElement("td");
      td.textContent = (r[i] ?? "");
      tr.appendChild(td);
    });
    body.appendChild(tr);
  });
}

async function _vsp_setup_export_links(selectedRid){
  const aHtml = document.getElementById("btn-exp-html");
  const aPdf  = document.getElementById("btn-exp-pdf");
  const aZip  = document.getElementById("btn-exp-zip");
  const aArt  = document.getElementById("btn-open-artindex");
  const hint  = document.getElementById("exp-hint");

  if (!aHtml && !aPdf && !aZip) return;

  if (!selectedRid){
    _vsp_disable_link(aHtml,"no run");
    _vsp_disable_link(aPdf,"no run");
    _vsp_disable_link(aZip,"no run");
    _vsp_disable_link(aArt,"no run");
    if (hint) hint.textContent = "no selected run";
    return;
  }

  // artifacts index always exists
  if (aArt){
    aArt.href = `/api/vsp/run_artifacts_index_v1/${encodeURIComponent(selectedRid)}`;
    aArt.style.opacity = "1";
    aArt.style.pointerEvents = "auto";
  }

  // probe export endpoints (several shapes)
  const mk = (fmt)=>[
    `/api/vsp/run_export_v3/${encodeURIComponent(selectedRid)}?fmt=${fmt}`,
    `/api/vsp/run_export_v3/${encodeURIComponent(selectedRid)}?format=${fmt}`,
    `/api/vsp/run_export_v3?rid=${encodeURIComponent(selectedRid)}&fmt=${fmt}`,
    `/api/vsp/run_export_v3?run_id=${encodeURIComponent(selectedRid)}&fmt=${fmt}`,
    `/api/vsp/run_export_v3?rid=${encodeURIComponent(selectedRid)}&format=${fmt}`,
  ];

  const uHtml = await _vsp_probe_first(mk("html"));
  const uPdf  = await _vsp_probe_first(mk("pdf"));
  const uZip  = await _vsp_probe_first(mk("zip"));

  if (uHtml){ aHtml.href=uHtml; aHtml.style.opacity="1"; aHtml.style.pointerEvents="auto"; }
  else _vsp_disable_link(aHtml,"export html not available");

  if (uPdf){ aPdf.href=uPdf; aPdf.style.opacity="1"; aPdf.style.pointerEvents="auto"; }
  else _vsp_disable_link(aPdf,"export pdf not available");

  if (uZip){ aZip.href=uZip; aZip.style.opacity="1"; aZip.style.pointerEvents="auto"; }
  else _vsp_disable_link(aZip,"export zip not available");

  if (hint){
    hint.textContent = `rid=${selectedRid} • export: ${uHtml?'HTML':'-'} ${uPdf?'PDF':'-'} ${uZip?'ZIP':'-'}`
  }
}

async function _vsp_render_datasource(rid, statusV2Obj){
  const boxS = document.getElementById("ds-statusv2");
  const boxA = document.getElementById("ds-artjson");
  const hint = document.getElementById("ds-findings-hint");

  if (boxS) boxS.textContent = _vsp_pretty(statusV2Obj || {});
  if (!rid) return;

  // artifacts index JSON
  let art = null;
  try{
    art = await fetchJSON(`/api/vsp/run_artifacts_index_v1/${encodeURIComponent(rid)}`);
    if (boxA) boxA.textContent = _vsp_pretty(art);
  }catch(e){
    if (boxA) boxA.textContent = String(e);
    if (hint) hint.textContent = "cannot load artifacts index";
    return;
  }

  // find candidate findings files from artifacts list
  const items = art.items || art.artifacts || art.files || [];
  const paths = items.map(x => (typeof x === "string") ? x : (x.path || x.name || "")).filter(Boolean);

  const pick = (needle)=> paths.find(p => p.toLowerCase().includes(needle));
  const csvPath = pick("findings_unified.csv") || pick("findings.csv") || pick("findings_unified");
  const jsonPath = pick("findings_unified.json") || pick("findings.json");

  if (!csvPath && !jsonPath){
    if (hint) hint.textContent = "no findings_unified.* in artifacts index";
    return;
  }

  // try csv first for table preview
  if (csvPath){
    if (hint) hint.textContent = `trying csv: ${csvPath}`;
    const r = await _vsp_fetch_artifact_text(rid, csvPath);
    if (r.ok){
      const pv = _vsp_parse_csv_preview(r.text, 60);
      _vsp_render_findings_table(pv.cols, pv.rows);
      if (hint) hint.textContent = `preview from CSV ✓ via ${r.url}`;
      return;
    }
  }

  // fallback json
  if (jsonPath){
    if (hint) hint.textContent = `trying json: ${jsonPath}`;
    const r = await _vsp_fetch_artifact_text(rid, jsonPath);
    if (r.ok){
      let obj = null;
      try{ obj = JSON.parse(r.text); }catch(e){ obj=null; }
      if (obj && Array.isArray(obj.items)) obj = obj.items;
      // render columns from first item keys
      const rows = Array.isArray(obj) ? obj.slice(0,60) : [];
      const cols = rows[0] ? Object.keys(rows[0]).slice(0,14) : [];
      const tableRows = rows.map(o => cols.map(c => (o && o[c] !== undefined) ? String(o[c]) : ""));
      _vsp_render_findings_table(cols, tableRows);
      if (hint) hint.textContent = `preview from JSON ✓ via ${r.url}`;
      return;
    }
  }

  if (hint) hint.textContent = "cannot fetch findings file (no artifact download endpoint found)";
}



  async function boot(){
    bootNav();
    loadSettingsUi();
    await loadRuns();
    const rid = $("#run-picker").value;
    if (rid) await loadOne(rid);
  }

  if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", boot);
  else boot();
})();
