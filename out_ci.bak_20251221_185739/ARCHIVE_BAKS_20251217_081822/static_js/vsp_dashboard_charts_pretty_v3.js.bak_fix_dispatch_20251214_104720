(function () {
  console.log("[VSP_CHARTS_V3] pretty charts loaded (FULL v2)");

  function getCanvasCtx(candidates) {
    for (var i = 0; i < candidates.length; i++) {
      var el = document.getElementById(candidates[i]);
      if (el && el.getContext) return el.getContext("2d");
    }
    // thử tìm theo data-attr
    var alt = document.querySelector("[data-vsp-chart='" + candidates[0] + "'] canvas");
    if (alt && alt.getContext) return alt.getContext("2d");
    
var el = document.getElementById(candidates[i]);


  // === VSP_PRETTY_V3_READY_AUTOCANVAS_V1 ===
  // Fallback: if canvas not found, try auto-create it under known placeholders
  try {
    var guessHost = function(id){
      var s = String(id||"").toLowerCase();
      if (s.includes("severity")) return "vsp-chart-severity";
      if (s.includes("trend")) return "vsp-chart-trend";
      if (s.includes("bytool") || s.includes("tool")) return "vsp-chart-bytool";
      if (s.includes("topcwe") || s.includes("cwe")) return "vsp-chart-topcwe";
      return null;
    };
    for (var k=0; k<candidates.length; k++){
      var cid = candidates[k];
      var hostId = guessHost(cid);
      if (!hostId) continue;
      var host = document.getElementById(hostId);
      if (!host) continue;
      // prevent duplicates
      if (document.getElementById(cid)) return document.getElementById(cid);

      var cv = document.createElement("canvas");
      cv.id = cid;
      cv.style.width = "100%";
      cv.style.height = "100%";
      cv.style.display = "block";
      host.innerHTML = "";
      host.appendChild(cv);
      console.log("[VSP_CHARTS_V3] autocreated canvas:", cid, "in", hostId);
      return cv;
    }
  } catch(e) {
    console.warn("[VSP_CHARTS_V3] autocanvas failed:", e);
  }
  // === END VSP_PRETTY_V3_READY_AUTOCANVAS_V1 ===

return null;
}

  function buildSeverityDonut(bySeverity) {
    if (typeof Chart === "undefined") {
      console.warn("[VSP_CHARTS_V3] Chart.js chưa load, bỏ qua severity donut.");
      return;
    }
    var ctx = getCanvasCtx(["vsp-chart-severity", "vsp-chart-severity-donut"]);
    if (!ctx) {
      console.warn("[VSP_CHARTS_V3] Không tìm thấy canvas severity.");
      return;
    }
    var labels = ["CRITICAL", "HIGH", "MEDIUM", "LOW", "INFO", "TRACE"];
    var data = labels.map(function (k) { return (bySeverity && bySeverity[k]) || 0; });

    new Chart(ctx, {
      type: "doughnut",
      data: {
        labels: labels,
        datasets: [{ data: data }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: "bottom" },
          title: { display: false }
        },
        cutout: "60%"
      }
    });
  }

  function buildTrend(trendByRun) {
    if (typeof Chart === "undefined") return;
    var ctx = getCanvasCtx(["vsp-chart-trend", "vsp-chart-total-findings-trend"]);
    if (!ctx) {
      console.warn("[VSP_CHARTS_V3] Không tìm thấy canvas trend.");
      return;
    }
    trendByRun = Array.isArray(trendByRun) ? trendByRun : [];

    var labels = trendByRun.map(function (r) { return r.run_id || r.label || ""; });
    var data = trendByRun.map(function (r) { return r.total_findings || 0; });

    new Chart(ctx, {
      type: "line",
      data: {
        labels: labels,
        datasets: [{ label: "Total findings", data: data, tension: 0.3 }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          x: { display: false },
          y: { beginAtZero: true }
        }
      }
    });
  }

  function buildCritHighByTool(byTool) {
    if (typeof Chart === "undefined") return;
    var ctx = getCanvasCtx(["vsp-chart-crit-high-tool"]);
    if (!ctx) {
      console.warn("[VSP_CHARTS_V3] Không tìm thấy canvas crit/high by tool.");
      return;
    }
    byTool = byTool || {};
    var tools = Object.keys(byTool);
    var data = tools.map(function (t) {
      var sev = (byTool[t] && byTool[t].by_severity) || {};
      return (sev.CRITICAL || 0) + (sev.HIGH || 0);
    });

    new Chart(ctx, {
      type: "bar",
      data: {
        labels: tools,
        datasets: [{ label: "CRIT+HIGH", data: data }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          x: { ticks: { autoSkip: true, maxRotation: 0, minRotation: 0 } },
          y: { beginAtZero: true }
        }
      }
    });
  }

  function buildTopCwe(topCweList) {
    if (typeof Chart === "undefined") return;
    var ctx = getCanvasCtx(["vsp-chart-top-cwe"]);
    if (!ctx) {
      console.warn("[VSP_CHARTS_V3] Không tìm thấy canvas top CWE.");
      return;
    }
    topCweList = Array.isArray(topCweList) ? topCweList : [];

    var labels = topCweList.map(function (c) { return c.cwe || c.id || ""; });
    var data = topCweList.map(function (c) { return c.total || c.count || 0; });

    new Chart(ctx, {
      type: "bar",
      data: {
        labels: labels,
        datasets: [{ label: "Findings", data: data }]
      },
      options: {
        indexAxis: "y",
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          x: { beginAtZero: true },
          y: { ticks: { autoSkip: true } }
        }
      }
    });
  }

  // Engine cho vsp_dashboard_enhance_v1.js
  window.VSP_CHARTS_ENGINE_V3 = {

// === VSP_PRETTY_V3_READY_AUTOCANVAS_V1 ===
try {
  window.dispatchEvent(new CustomEvent('vsp:charts-ready', { detail: { engine: 'V3' } }));
  console.log('[VSP_CHARTS_V3] dispatched vsp:charts-ready');
} catch(e) {}
// === END VSP_PRETTY_V3_READY_AUTOCANVAS_V1 ===
    initAll: function (dash) {
      if (!dash) {
        console.warn("[VSP_CHARTS_V3] initAll: không có dashboard data.");
        return;
      }
      try { buildSeverityDonut(dash.by_severity); } catch (e) { console.error(e); }
      try { buildTrend(dash.trend_by_run); } catch (e) { console.error(e); }
      try { buildCritHighByTool(dash.by_tool); } catch (e) { console.error(e); }
      try { buildTopCwe(dash.top_cwe_list); } catch (e) { console.error(e); }
    }
  };
})();
