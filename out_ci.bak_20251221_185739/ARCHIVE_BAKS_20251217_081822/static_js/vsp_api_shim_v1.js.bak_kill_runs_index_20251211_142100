/**
 * vsp_api_shim_v1.js
 * Intercept fetch cho 2 API:
 *   - /api/vsp/dashboard_v3  -> /static/data/vsp_dashboard_v3_latest.json
 *   - /api/vsp/runs_index_v3         -> trả danh sách rỗng
 */
(function () {
  if (typeof window === "undefined" || typeof window.fetch !== "function") {
    console.log("[VSP_API_SHIM] window.fetch không sẵn, bỏ qua.");
    return;
  }

  const origFetch = window.fetch;

  window.fetch = async function(input, init) {
    try {
      const url = (typeof input === "string") ? input : (input && input.url) || "";

      // Shim cho dashboard_v3
      if (url.includes("/api/vsp/dashboard_v3")) {
        console.log("[VSP_API_SHIM] intercept /api/vsp/dashboard_v3 -> static JSON");
        try {
          const resp = await origFetch("/static/data/vsp_dashboard_v3_latest.json", init);
          const text = await resp.text();
          return new Response(text, {
            status: 200,
            statusText: "OK",
            headers: { "Content-Type": "application/json" }
          });
        } catch (e) {
          console.error("[VSP_API_SHIM] lỗi khi proxy dashboard_v3_latest:", e);
          return new Response(
            JSON.stringify({ ok: false, error: "shim_error_dashboard_v3_latest" }),
            { status: 500, headers: { "Content-Type": "application/json" } }
          );
        }
      }

      // Shim cho runs_index_v3
      if (url.includes("/api/vsp/runs_index_v3")) {
        console.log("[VSP_API_SHIM] intercept /api/vsp/runs_index_v3 -> empty list");
        const body = JSON.stringify({ ok: true, items: [], total: 0 });
        return new Response(body, {
          status: 200,
          statusText: "OK",
          headers: { "Content-Type": "application/json" }
        });
      }

      // Mặc định: gọi fetch gốc
      return origFetch(input, init);
    } catch (err) {
      console.error("[VSP_API_SHIM] fetch wrapper error:", err);
      return origFetch(input, init);
    }
  };

  console.log("[VSP_API_SHIM] installed.");
})();
