/**
 * VSP console patch v1
 * Mục tiêu: chặn mọi log / warning chứa "[VSP_RUNS_UI_v1]"
 * để không còn rác console từ legacy stub cũ.
 */

(function () {
  'use strict';

  var origWarn = console.warn;
  var origLog  = console.log;

  function shouldMute(msg) {
    if (!msg || typeof msg !== 'string') return false;
    return msg.indexOf('[VSP_RUNS_UI_v1]') !== -1 ||
           msg.indexOf('tbody#vsp-runs-tbody') !== -1;
  }

  console.warn = function () {
    if (arguments.length > 0 && shouldMute(arguments[0])) {
      // Nuốt luôn log cũ
      return;
    }
    return origWarn.apply(console, arguments);
  };

  console.log = function () {
    if (arguments.length > 0 && shouldMute(arguments[0])) {
      return;
    }
    return origLog.apply(console, arguments);
  };

  origLog('[VSP_CONSOLE_PATCH] Installed console filter for legacy RUNS_UI_v1 logs.');
})();


// VSP_SETTINGS_AUTOBIND_v1
(function() {
  const LOG = "[VSP_SETTINGS_BIND]";
  function bindVspSettingsTab() {
    if (!window.vspInitSettingsTab) {
      console.log(LOG, "vspInitSettingsTab not found – skip.");
      return;
    }
    const btns = Array.from(document.querySelectorAll(
      "[data-vsp-tab='settings'], [data-vsp-target='#tab-settings'], [data-vsp-id='settings']"
    ));
    if (!btns.length) {
      console.warn(LOG, "No Settings tab button found.");
      return;
    }
    btns.forEach(btn => {
      if (btn.dataset.vspSettingsBound === "1") return;
      btn.addEventListener("click", () => {
        try {
          window.vspInitSettingsTab();
        } catch (e) {
          console.error(LOG, "Error in vspInitSettingsTab", e);
        }
      });
      btn.dataset.vspSettingsBound = "1";
    });
    console.log(LOG, "bound", btns.length, "Settings tab buttons.");
  }
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", bindVspSettingsTab);
  } else {
    bindVspSettingsTab();
  }
})();

// [VSP_TABS_MAIN_INIT]
(function () {
  "use strict";
  var LOG_PREFIX_TABS = "[VSP_TABS]";

  function logTabs() {
    if (typeof console !== "undefined" && console.log) {
      var args = Array.prototype.slice.call(arguments);
      args.unshift(LOG_PREFIX_TABS);
      console.log.apply(console, args);
    }
  }

  function normalizeLabel(text) {
    if (!text) return "";
    return text.replace(/\s+/g, " ").trim().toLowerCase();
  }

  function initTabs() {
    // Map label -> pane id
    var map = {
      "dashboard": "#vsp-tab-dashboard",
      "runs & reports": "#vsp-tab-runs",
      "data source": "#vsp-tab-datasource",
      "settings": "#vsp-tab-settings",
      "settings (profile / tools)": "#vsp-tab-settings",
      "rule overrides": "#vsp-tab-rules"
    };

    var buttons = [];
    var candidates = document.querySelectorAll("button, a, span");

    for (var i = 0; i < candidates.length; i++) {
      var el = candidates[i];
      var label = normalizeLabel(el.textContent || el.innerText);
      if (map[label]) {
        el.setAttribute("data-vsp-tab-target", map[label]);
        el.classList.add("vsp-tab-link");
        buttons.push(el);
      }
    }

    var panes = document.querySelectorAll(".vsp-tab-pane");
    if (!buttons.length || !panes.length) {
      logTabs("No tab buttons or panes found – skip.", "buttons", buttons.length, "panes", panes.length);
      return;
    }

    function showTab(targetSelector) {
      if (!targetSelector) return;
      var found = false;

      for (var i = 0; i < panes.length; i++) {
        var pane = panes[i];
        if (pane.matches(targetSelector)) {
          pane.classList.add("vsp-tab-pane-active");
          pane.style.display = "";
          found = true;
        } else {
          pane.classList.remove("vsp-tab-pane-active");
          pane.style.display = "none";
        }
      }

      for (var j = 0; j < buttons.length; j++) {
        var btn = buttons[j];
        var sel = btn.getAttribute("data-vsp-tab-target");
        if (sel === targetSelector) {
          btn.classList.add("vsp-tab-link-active");
        } else {
          btn.classList.remove("vsp-tab-link-active");
        }
      }

      if (!found) {
        logTabs("No pane matched selector:", targetSelector);
      } else {
        logTabs("Switched to tab:", targetSelector);
      }
    }

    buttons.forEach(function (btn) {
      btn.addEventListener("click", function (e) {
        e.preventDefault();
        var sel = btn.getAttribute("data-vsp-tab-target");
        if (!sel) return;
        showTab(sel);
      });
    });

    var defaultSelector = "#vsp-tab-dashboard";
    if (window.location.hash && document.querySelector(window.location.hash)) {
      defaultSelector = window.location.hash;
    }
    showTab(defaultSelector);
    logTabs("Initialized, default tab =", defaultSelector);

    // debug: vspTabsShow('#vsp-tab-runs')
    window.vspTabsShow = showTab;
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initTabs);
  } else {
    initTabs();
  }
})();
