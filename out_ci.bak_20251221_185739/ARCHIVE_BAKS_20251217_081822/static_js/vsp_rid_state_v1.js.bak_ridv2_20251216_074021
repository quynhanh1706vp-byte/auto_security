/* VSP_RID_STATE_V1: global RID state (localStorage + auto pick latest) */
(function(){
  const KEY = "VSP_CURRENT_RID";
  const RID_RE = /(RUN_)?VSP_CI_\d{8}_\d{6}/;

  function normRid(rid){
    if(!rid) return "";
    rid = String(rid).trim();
    // accept RUN_VSP_CI_... and VSP_CI_...
    rid = rid.replace(/^RUN_/, "");
    if(!RID_RE.test(rid)) return "";
    return rid.startsWith("VSP_CI_") ? rid : rid; // (after replace it is VSP_CI_...)
  }

  function get(){
    return normRid(localStorage.getItem(KEY) || "");
  }
  function set(rid){
    rid = normRid(rid);
    if(!rid) return false;
    localStorage.setItem(KEY, rid);
    window.dispatchEvent(new CustomEvent("vsp:rid-changed", { detail: { rid } }));
    return true;
  }
  function clear(){
    localStorage.removeItem(KEY);
    window.dispatchEvent(new CustomEvent("vsp:rid-changed", { detail: { rid: "" } }));
  }

  async function pickLatest(){
    try{
      const url = "/api/vsp/runs_index_v3_fs_resolved?limit=1&hide_empty=0&filter=1";
      const r = await fetch(url, { cache:"no-store" });
      if(!r.ok) return "";
      const j = await r.json();
      const ridRaw = (j && j.items && j.items[0] && j.items[0].run_id) ? j.items[0].run_id : "";
      const rid = normRid(ridRaw.replace(/^RUN_/, ""));
      if(rid) set(rid);
      return rid;
    }catch(e){
      console.warn("[VSP_RID_STATE_V1] pickLatest failed", e);
      return "";
    }
  }

  function updateHeader(){
    const rid = get();
    const el = document.getElementById("vsp-rid-label");
    if(el) el.textContent = rid ? ("RID: " + rid) : "RID: (none)";

    // enable/disable export buttons
    ["export-html","export-zip","export-pdf"].forEach(id=>{
      const b = document.getElementById(id);
      if(!b) return;
      b.disabled = !rid;
      b.classList.toggle("vsp-disabled", !rid);
    });
  }

  async function ensure(){
    updateHeader();
    if(get()) return get();
    const rid = await pickLatest();
    updateHeader();
    return rid;
  }

  function wireExports(){
    function go(fmt){
      const rid = get();
      if(!rid) return;
      const ridPath = "RUN_" + rid; // backend expects RUN_VSP_CI_...
      window.location.href = `/api/vsp/run_export_v3/${ridPath}?fmt=${encodeURIComponent(fmt)}`;
    }
    const h = document.getElementById("export-html");
    const z = document.getElementById("export-zip");
    const p = document.getElementById("export-pdf");
    if(h) h.addEventListener("click", ()=>go("html"));
    if(z) z.addEventListener("click", ()=>go("zip"));
    if(p) p.addEventListener("click", ()=>go("pdf"));
  }

  window.VSP_RID_STATE_V1 = { get, set, clear, ensure, pickLatest, updateHeader };

  window.addEventListener("vsp:rid-changed", updateHeader);
  document.addEventListener("DOMContentLoaded", async ()=>{
    wireExports();
    await ensure();
  });
})();
