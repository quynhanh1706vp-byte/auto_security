;(function () {
  const LOG_PREFIX = "[VSP_RUNS_TAB]";

  function $(id) {
    return document.getElementById(id);
  }

  function safe(obj, path, fallback) {
    try {
      return path.split(".").reduce((o, k) => (o && o[k] != null ? o[k] : undefined), obj) ?? fallback;
    } catch (e) {
      return fallback;
    }
  }

  function formatDate(iso) {
    if (!iso) return "";
    const d = new Date(iso);
    if (isNaN(d.getTime())) return iso;
    return d.toLocaleString();
  }

  function severityCount(item, key) {
    const bySev =
      safe(item, "summary.by_severity", null) ||
      safe(item, "by_severity", {}) ||
      {};
    return bySev[key] || 0;
  }

  function totalFindings(item) {
    const bySev =
      safe(item, "summary.by_severity", null) ||
      safe(item, "by_severity", {}) ||
      {};
    return Object.values(bySev).reduce((a, b) => a + (b || 0), 0);
  }

  function renderKPIs(items) {
    const totalRuns = items.length;
    let crit = 0,
      high = 0,
      total = 0;

    for (const it of items) {
      crit += severityCount(it, "CRITICAL");
      high += severityCount(it, "HIGH");
      total += totalFindings(it);
    }

    const elTotalRuns = $("vsp-runs-kpi-total");
    const elCritHigh = $("vsp-runs-kpi-crit-high");
    const elAvgFindings = $("vsp-runs-kpi-avg");

    if (elTotalRuns) elTotalRuns.textContent = String(totalRuns);
    if (elCritHigh) elCritHigh.textContent = String(crit + high);
    if (elAvgFindings) {
      const avg = totalRuns > 0 ? (total / totalRuns).toFixed(1) : "0.0";
      elAvgFindings.textContent = avg;
    }
  }

  function renderRunDetail(item) {
    if (!item) return;

    const runId = item.run_id || item.id || "";
    const startedAt = item.started_at || item.created_at || "";
    const profile = item.profile || item.scan_profile || "";
    const status = item.status || "unknown";

    const elId = $("vsp-run-detail-id");
    const elTime = $("vsp-run-detail-time");
    const elProfile = $("vsp-run-detail-profile");
    const elStatus = $("vsp-run-detail-status");
    const elCrit = $("vsp-run-detail-crit");
    const elHigh = $("vsp-run-detail-high");
    const elMed = $("vsp-run-detail-med");
    const elLow = $("vsp-run-detail-low");
    const elInfo = $("vsp-run-detail-info");
    const elTrace = $("vsp-run-detail-trace");
    const elTotal = $("vsp-run-detail-total");

    if (elId) elId.textContent = runId;
    if (elTime) elTime.textContent = formatDate(startedAt);
    if (elProfile) elProfile.textContent = profile;
    if (elStatus) elStatus.textContent = status;

    const bySev =
      safe(item, "summary.by_severity", null) ||
      safe(item, "by_severity", {}) ||
      {};
    const sev = (k) => bySev[k] || 0;

    if (elCrit) elCrit.textContent = sev("CRITICAL");
    if (elHigh) elHigh.textContent = sev("HIGH");
    if (elMed) elMed.textContent = sev("MEDIUM");
    if (elLow) elLow.textContent = sev("LOW");
    if (elInfo) elInfo.textContent = sev("INFO");
    if (elTrace) elTrace.textContent = sev("TRACE");
    if (elTotal) elTotal.textContent = totalFindings(item);
  }

  function buildRow(item) {
    const runId = item.run_id || item.id || "";
    const startedAt = item.started_at || item.created_at || "";
    const profile = item.profile || item.scan_profile || "";
    const status = item.status || "unknown";

    const tr = document.createElement("tr");
    tr.dataset.runId = runId;

    const tdTime = document.createElement("td");
    tdTime.textContent = formatDate(startedAt);

    const tdId = document.createElement("td");
    tdId.textContent = runId;

    const tdProfile = document.createElement("td");
    tdProfile.textContent = profile;

    const tdStatus = document.createElement("td");
    tdStatus.textContent = status;

    const mkSev = (k) => {
      const td = document.createElement("td");
      td.textContent = severityCount(item, k);
      return td;
    };

    const tdCrit = mkSev("CRITICAL");
    const tdHigh = mkSev("HIGH");
    const tdMed = mkSev("MEDIUM");
    const tdLow = mkSev("LOW");
    const tdInfo = mkSev("INFO");
    const tdTrace = mkSev("TRACE");

    const tdTotal = document.createElement("td");
    tdTotal.textContent = totalFindings(item);

    tr.appendChild(tdTime);
    tr.appendChild(tdId);
    tr.appendChild(tdProfile);
    tr.appendChild(tdStatus);
    tr.appendChild(tdCrit);
    tr.appendChild(tdHigh);
    tr.appendChild(tdMed);
    tr.appendChild(tdLow);
    tr.appendChild(tdInfo);
    tr.appendChild(tdTrace);
    tr.appendChild(tdTotal);

    tr.addEventListener("click", () => {
      const tbody = $("vsp-runs-tbody");
      if (tbody) {
        tbody
          .querySelectorAll("tr.vsp-run-selected")
          .forEach((row) => row.classList.remove("vsp-run-selected"));
      }
      tr.classList.add("vsp-run-selected");
      renderRunDetail(item);
    });

    return tr;
  }

  function getFiltersQuery() {
    const profile = $("vsp-runs-filter-profile");
    const severity = $("vsp-runs-filter-severity");
    const dateText = $("vsp-runs-filter-date");

    const params = new URLSearchParams();
    params.set("limit", "50");

    if (profile && profile.value) params.set("profile", profile.value);
    if (severity && severity.value) params.set("severity", severity.value);
    if (dateText && dateText.value) params.set("date", dateText.value);

    return params.toString();
  }

  async function loadRuns() {
    const tbody = $("vsp-runs-tbody");
    if (!tbody) {
      console.warn(LOG_PREFIX, "Không tìm thấy #vsp-runs-tbody");
      return;
    }

    const baseUrl = "/api/vsp/runs_index_v3";
    const q = getFiltersQuery();
    const url = q ? `${baseUrl}?${q}` : baseUrl;

    console.log(LOG_PREFIX, "Loading runs from", url);

    let resp, data;
    try {
      resp = await fetch(url, { method: "GET" });
    } catch (e) {
      console.error(LOG_PREFIX, "fetch error", e);
      return;
    }

    try {
      data = await resp.json();
    } catch (e) {
      console.error(LOG_PREFIX, "JSON parse error", e);
      return;
    }

    if (!data || data.ok === false) {
      console.error(LOG_PREFIX, "API error", data && data.error);
      return;
    }

    const items = data.items || [];
    console.log(LOG_PREFIX, "Loaded runs:", items.length);

    tbody.innerHTML = "";

    for (const it of items) {
      const tr = buildRow(it);
      tbody.appendChild(tr);
    }

    if (items.length > 0) {
      const firstRow = tbody.querySelector("tr");
      if (firstRow) firstRow.classList.add("vsp-run-selected");
      renderRunDetail(items[0]);
    } else {
      renderRunDetail(null);
    }

    renderKPIs(items);
  }

  function getActiveRunId() {
    const selected = document.querySelector("#vsp-runs-tbody tr.vsp-run-selected");
    if (selected && selected.dataset.runId) {
      return selected.dataset.runId;
    }
    const first = document.querySelector("#vsp-runs-tbody tr[data-run-id]");
    return first ? first.dataset.runId : null;
  }

  function bindFilters() {
    const btnApply = $("vsp-runs-filter-apply");
    if (!btnApply) return;

    btnApply.addEventListener("click", () => {
      loadRuns().catch((err) =>
        console.error(LOG_PREFIX, "reload error", err)
      );
    });
  }

  function bindExports() {
    const btnHtml = $("vsp-run-export-html");
    const btnZip = $("vsp-run-export-zip");

    if (!btnHtml && !btnZip) {
      console.log(LOG_PREFIX, "Không thấy nút Export – skip bind");
      return;
    }

    function doExport(fmt) {
      const runId = getActiveRunId();
      if (!runId) {
        alert("Không tìm thấy run nào để export.");
        return;
      }
      const url = `/api/vsp/run_export_v3?run_id=${encodeURIComponent(
        runId
      )}&fmt=${encodeURIComponent(fmt)}`;
      console.log(LOG_PREFIX, "Export", fmt, "->", url);
      window.open(url, "_blank");
    }

    if (btnHtml) {
      btnHtml.addEventListener("click", () => doExport("html"));
    }
    if (btnZip) {
      btnZip.addEventListener("click", () => doExport("zip"));
    }
  }

  // Hàm init được console_patch gọi khi tab Runs & Reports sẵn sàng
  window.vspInitRunsTab = function vspInitRunsTab() {
    console.log(LOG_PREFIX, "init");
    bindFilters();
    bindExports();
    loadRuns().catch((err) =>
      console.error(LOG_PREFIX, "initial load error", err)
    );
  };

  console.log(LOG_PREFIX, "vsp_runs_tab_v1.js loaded.");
})();
