// === VSP_CHARTS_ENGINE_SHIM_V1 ===
(function(){
  // Always provide a safe resolver so dashboard never crashes on missing symbol names.
  function _findChartsEngineShim(){
    return (
      window.VSP_CHARTS_ENGINE_V3 ||
      window.VSP_CHARTS_V3 ||
      window.VSP_CHARTS_PRETTY_V3 ||
      window.VSP_DASH_CHARTS_V3 ||
      window.VSP_CHARTS_ENGINE_V2 ||
      window.VSP_CHARTS_V2 ||
      window.VSP_CHARTS_ENGINE ||
      window.VSP_CHARTS ||
      null
    );
  }
  if (typeof window.findChartsEngine !== 'function') {
    window.findChartsEngine = _findChartsEngineShim;
  }
})();

// === VSP_FIND_CHARTS_ENGINE_FALLBACK_V1 ===
if (typeof window.findChartsEngine !== 'function') {
  window.findChartsEngine = function () {
    try {
      // Prefer explicit exported engines
      if (window.VSP_DASH_CHARTS_ENGINE) return window.VSP_DASH_CHARTS_ENGINE;
      if (window.VSP_DASH_CHARTS_V3) return window.VSP_DASH_CHARTS_V3;
      if (window.VSP_DASH_CHARTS_V2) return window.VSP_DASH_CHARTS_V2;

      // Heuristic: look for known globals from pretty charts scripts
      var cand = [
        window.vsp_dashboard_charts_v3,
        window.vsp_dashboard_charts_v2,
        window.VSP_CHARTS_V3,
        window.VSP_CHARTS_V2
      ].filter(Boolean)[0];

      return cand || null;
    } catch (e) { return null; }
  };
}
// === END VSP_FIND_CHARTS_ENGINE_FALLBACK_V1 ===
(function () {
  // VSP 2025 – Dashboard enhance V4 (clean, no patch lỗi)
  console.log('[VSP_DASH] vsp_dashboard_enhance_v1.js (V4 clean) loaded');

  function onReady(fn) {
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', fn);
    } else {
      fn();
    }
  }

  function safeText(id, value) {
    var el = document.getElementById(id);
    if (!el) return;
    el.textContent = value;
  }

  function fetchDashboard() {
    return fetch('/api/vsp/dashboard_v3', {
      credentials: 'same-origin'
    }).then(function (r) {
      if (!r.ok) throw new Error('HTTP ' + r.status);
      return r.json();
    });
  }

  function fillKpis(data) {
    if (!data || typeof data !== 'object') return;
    var bySeverity = data.by_severity || {};
    var total = data.total_findings != null
      ? data.total_findings
      : (bySeverity.CRITICAL || 0) + (bySeverity.HIGH || 0) +
        (bySeverity.MEDIUM || 0) + (bySeverity.LOW || 0) +
        (bySeverity.INFO || 0) + (bySeverity.TRACE || 0);

    safeText('vsp-kpi-total-findings', total);
    safeText('vsp-kpi-critical', bySeverity.CRITICAL != null ? bySeverity.CRITICAL : 0);
    safeText('vsp-kpi-high',     bySeverity.HIGH     != null ? bySeverity.HIGH     : 0);
    safeText('vsp-kpi-medium',   bySeverity.MEDIUM   != null ? bySeverity.MEDIUM   : 0);
    safeText('vsp-kpi-low',      bySeverity.LOW      != null ? bySeverity.LOW      : 0);
    safeText('vsp-kpi-info',     bySeverity.INFO     != null ? bySeverity.INFO     : 0);
    safeText('vsp-kpi-trace',    bySeverity.TRACE    != null ? bySeverity.TRACE    : 0);

    if (data.security_posture_score != null) {
      safeText('vsp-kpi-security-score', data.security_posture_score);
    }

    safeText('vsp-kpi-top-tool',   data.top_risky_tool       || 'N/A');
    safeText('vsp-kpi-top-cwe',    data.top_impacted_cwe     || data.top_cwe || 'N/A');
    safeText('vsp-kpi-top-module', data.top_vulnerable_module || 'N/A');

    var gate = data.ci_gate_status || data.ci_gate || {};
    var gateLabel = gate.label || gate.status || 'N/A';
    var gateDesc  = gate.description || 'Gate dựa trên CRITICAL/HIGH, score & coverage.';
    safeText('vsp-kpi-ci-gate-status',      gateLabel);
    safeText('vsp-kpi-ci-gate-status-desc', gateDesc);
  }

  function hydrateDashboard(data) {
    try {
      fillKpis(data);

      if (window.VSP_CHARTS_V3 && typeof window.VSP_CHARTS_V3.updateFromDashboard === 'function') {
        window.VSP_CHARTS_V3.updateFromDashboard(data);
      } else if (window.VSP_CHARTS_V2 && typeof window.VSP_CHARTS_V2.updateFromDashboard === 'function') {
        window.VSP_CHARTS_V2.updateFromDashboard(data);
      } else {
        console.debug('[VSP_DASH] No charts engine V2/V3 found – only KPIs filled. (will retry)');
      }

      console.log('[VSP_DASH] Dashboard hydrated OK (V4 clean).');
    } catch (e) {
      console.error('[VSP_DASH] Error hydrating dashboard:', e);
    }
  }

  window.hydrateDashboard = hydrateDashboard;

  onReady(function () {
    var pane = document.getElementById('vsp-dashboard-main');
    if (!pane) {
      console.log('[VSP_DASH] No dashboard pane found, skip auto fetch.');
      return;
    }
    console.log('[VSP_DASH] Hydrating dashboard (auto fetch)…');
    fetchDashboard()
      .then(function (data) {
        console.log('[VSP_DASH] dashboard_v3 data =', data);
        hydrateDashboard(data);
      })
      .catch(function (err) {
        console.error('[VSP_DASH] Failed to load /api/vsp/dashboard_v3:', err);
      });
  });

})();


// === VSP_DASH_CHARTS_RETRY_V1 ===
(function(){
  try{
    let tries = 0;
    function tryHydrate(){
      tries++;
      const eng = window.VSP_CHARTS_V3 || window.VSP_CHARTS_PRETTY_V3 || window.VSP_CHARTS_ENGINE_V3;
      if (eng && typeof eng.hydrate === 'function' && window.__VSP_LAST_DASH_DATA__){
        eng.hydrate(window.__VSP_LAST_DASH_DATA__);
        console.log('[VSP_DASH] charts hydrated via retry');
        return;
      }
      if (tries < 8) setTimeout(tryHydrate, 300);
    }
    setTimeout(tryHydrate, 300);
  }catch(e){}
})();
// === END VSP_DASH_CHARTS_RETRY_V1 ===


// === VSP_DASH_CHARTS_RETRY_V2 ===
(function(){
  try{
    let tries = 0;
    function tick(){
      tries++;
      const eng = findChartsEngine();
      if (eng && window.__VSP_LAST_DASH_DATA__){
        try{
          eng.hydrate(window.__VSP_LAST_DASH_DATA__);
          console.log('[VSP_DASH] charts hydrated via retry v2');
          return;
        }catch(e){}
      }
      if (tries < 8) setTimeout(tick, 350);
    }
    setTimeout(tick, 350);
  }catch(e){}
})();
// === END VSP_DASH_CHARTS_RETRY_V2 ===


// === VSP_DASH_USE_DASH_V3_AND_INIT_CHARTS_V1 ===
(function(){
  try {
    if (window.__VSP_DASH_INIT_CHARTS_V1) return;
    window.__VSP_DASH_INIT_CHARTS_V1 = true;

    function _vspGetChartsEngine() {
      return window.VSP_CHARTS_ENGINE_V3 || window.VSP_CHARTS_ENGINE_V2 || null;
    }

    window.__VSP_DASH_TRY_INIT_CHARTS_V1 = function(dash, reason) {
      try {
        if (dash) window.__VSP_DASH_LAST_DATA_V3 = dash;
        var eng = _vspGetChartsEngine();
        if (!eng || !eng.initAll) return false;
        var d = dash || window.__VSP_DASH_LAST_DATA_V3;
        if (!d) return false;
        var ok = eng.initAll(d);
        console.log("[VSP_DASH] charts initAll via", reason || "unknown", "=>", ok);
        return !!ok;
      } catch (e) {
        console.warn("[VSP_DASH] charts init failed", e);
        return false;
      }
    };

    // Listen for charts-ready (late engine load)
    window.addEventListener("vsp:charts-ready", function(ev){
      setTimeout(function(){
        window.__VSP_DASH_TRY_INIT_CHARTS_V1(null, "charts-ready");
      }, 0);
    });
  } catch(e) {
    console.warn("[VSP_DASH] init-charts patch failed", e);
  }
})();

// === VSP_ENHANCE_WAIT_CHARTS_READY_V1 ===

(function(){
  try{
    if (window.__VSP_ENHANCE_WAIT_CHARTS_READY_V1) return;
    window.__VSP_ENHANCE_WAIT_CHARTS_READY_V1 = true;

    function pickEngine(){
      return window.VSP_CHARTS_ENGINE_V3 || window.VSP_CHARTS_ENGINE_V2 || window.VSP_CHARTS_ENGINE || null;
    }

    function tryInit(){
      var eng = pickEngine();
      var d = window.__VSP_DASH_LAST_DATA_V3 || window.__VSP_DASH_LAST_DATA || window.__VSP_DASH_LAST_DATA_ANY || null;
      if (!eng || !eng.initAll || !d) return false;
      try{
        eng.initAll(d);
        return true;
      }catch(e){
        return false;
      }
    }

    window.addEventListener('vsp:charts-ready', function(){
      // chỉ init khi đã có data (dashboard fetch xong)
      tryInit();
    });

    // nếu engine đã có sẵn thì thử init luôn (không warn)
    tryInit();
  }catch(e){}
})();



// === VSP_UI_KPI_DRILLDOWN_V1 ===
(function(){
  const KEY = "vsp_ds_drill_url_v1";

  async function loadDashLatest(){
    try{
      const r = await fetch("/api/vsp/dashboard_latest_v1", {credentials:"same-origin"});
      const j = await r.json();
      window.__VSP_DASH_LATEST_V1 = j;
      return j;
    }catch(e){
      console.warn("[KPI_DRILLDOWN] loadDashLatest failed", e);
      return null;
    }
  }

  function _setDrillUrl(url){
    try{ sessionStorage.setItem(KEY, url); }catch(e){}
  }

  function openDrill(url){
    if(!url) return;
    _setDrillUrl(url);

    // best-effort: switch tab by hash
    try{
      if(!String(location.hash||"").toLowerCase().includes("datasource")){
        location.hash = "#datasource";
        // kick router if it listens
        setTimeout(()=>{ try{ window.dispatchEvent(new Event("hashchange")); }catch(e){} }, 50);
      }
    }catch(e){}

    // if Data Source JS installed hook -> use it
    if(typeof window.VSP_DS_APPLY_DRILL_URL_V1 === "function"){
      try{ window.VSP_DS_APPLY_DRILL_URL_V1(url); return; }catch(e){}
    }

    // fallback: open API in new tab (always works)
    try{ window.open(url, "_blank"); }catch(e){}
  }

  function bindClicks(dash){
    if(!dash || !dash.links) return;

    const sevLinks = (dash.links.severity || {});
    const allUrl   = dash.links.all;

    const nodes = Array.from(document.querySelectorAll("a,button,div,section,article,span"))
      .filter(el=>{
        const txt = (el.innerText||"").trim();
        return txt && txt.length > 0 && txt.length < 160;
      });

    function attachByKeyword(keywordUpper, url, title){
      if(!url) return;
      for(const el of nodes){
        const txt = (el.innerText||"").toUpperCase();
        if(!txt.includes(keywordUpper)) continue;
        if(el.__vsp_drill_attached) continue;
        el.__vsp_drill_attached = true;
        el.style.cursor = "pointer";
        el.title = title;
        el.addEventListener("click", (ev)=>{
          // allow user open normally with ctrl/cmd
          if(ev && (ev.ctrlKey || ev.metaKey || ev.shiftKey)) return;
          try{ ev.preventDefault(); }catch(e){}
          openDrill(url);
        });
      }
    }

    // severity KPI cards (by keyword)
    ["CRITICAL","HIGH","MEDIUM","LOW","INFO","TRACE"].forEach(sev=>{
      attachByKeyword(sev, sevLinks[sev], `Drilldown → ${sev}`);
    });

    // total findings KPI (heuristic)
    if(allUrl){
      for(const el of nodes){
        const txt = (el.innerText||"").toUpperCase();
        const hit = (txt.includes("TOTAL") && (txt.includes("FIND") || txt.includes("FINDINGS"))) || txt.includes("TOTAL FINDINGS");
        if(!hit) continue;
        if(el.__vsp_drill_total) continue;
        el.__vsp_drill_total = true;
        el.style.cursor = "pointer";
        el.title = "Drilldown → ALL findings";
        el.addEventListener("click", (ev)=>{
          if(ev && (ev.ctrlKey || ev.metaKey || ev.shiftKey)) return;
          try{ ev.preventDefault(); }catch(e){}
          openDrill(allUrl);
        });
      }
    }

    // expose helper for manual use
    window.VSP_DASH_OPEN_DRILL_V1 = openDrill;
    console.log("[KPI_DRILLDOWN] bound", {rid: dash.rid, hasLinks: !!dash.links});
  }

  window.addEventListener("load", async ()=>{
    const dash = await loadDashLatest();
    // wait a bit so DOM cards exist
    setTimeout(()=>bindClicks(dash), 600);
  });
})();



// === VSP_UI_DRILL_PANEL_V1 ===
(function(){
  const KEY = "vsp_ds_drill_url_v1";

  function setDrillUrl(url){
    try{ sessionStorage.setItem(KEY, url); }catch(e){}
  }
  function gotoDatasource(){
    const h = String(location.hash||"");
    if(h.startsWith("#vsp4-")) location.hash = "#vsp4-datasource";
    else location.hash = "#datasource";
    try{ window.dispatchEvent(new Event("hashchange")); }catch(e){}
  }
  async function dashLatest(){
    const r = await fetch("/api/vsp/dashboard_latest_v1", {credentials:"same-origin"});
    return await r.json();
  }

  function ensurePanel(d){
    const id="vsp_drill_panel_v1";
    if(document.getElementById(id)) return;

    const wrap=document.createElement("div");
    wrap.id=id;
    wrap.style.position="fixed";
    wrap.style.right="18px";
    wrap.style.bottom="18px";
    wrap.style.zIndex="9999";
    wrap.style.padding="10px";
    wrap.style.borderRadius="14px";
    wrap.style.border="1px solid rgba(255,255,255,.10)";
    wrap.style.background="rgba(2,6,23,.78)";
    wrap.style.backdropFilter="blur(10px)";
    wrap.style.boxShadow="0 10px 30px rgba(0,0,0,.35)";
    wrap.style.fontSize="12px";
    wrap.style.color="rgba(255,255,255,.85)";
    wrap.innerHTML = `
      <div style="font-weight:700;margin-bottom:6px;">Drilldown</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        <button id="vsp_drill_total" style="padding:6px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);color:#fff;cursor:pointer;">TOTAL</button>
        <button id="vsp_drill_critical" style="padding:6px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);color:#fff;cursor:pointer;">CRITICAL</button>
        <button id="vsp_drill_high" style="padding:6px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);color:#fff;cursor:pointer;">HIGH</button>
      </div>
      <div style="opacity:.65;margin-top:6px;">(opens Data Source)</div>
    `;
    document.body.appendChild(wrap);

    const links = (d && d.links) ? d.links : {};
    const sev = (links.severity)||{};
    function bind(btnId, url){
      const b=document.getElementById(btnId);
      if(!b) return;
      b.onclick = ()=>{
        if(!url){ console.warn("[DRILL] missing url for", btnId); return; }
        setDrillUrl(url);
        gotoDatasource();
        if(typeof window.VSP_DS_APPLY_DRILL_URL_V1==="function"){
          try{ window.VSP_DS_APPLY_DRILL_URL_V1(url); }catch(e){}
        }
        console.log("[DRILL] open", url);
      };
    }
    bind("vsp_drill_total", links.all);
    bind("vsp_drill_critical", sev.CRITICAL);
    bind("vsp_drill_high", sev.HIGH);
  }

  window.addEventListener("load", async ()=>{
    try{
      const d = await dashLatest();
      window.__VSP_DASH_LATEST_V1 = d;
      ensurePanel(d);
    }catch(e){
      console.warn("[DRILL_PANEL] failed", e);
    }
  });
})();

// === VSP_P2_DRILL_ROUTER_V1 ===
// Drill router: click elements with data-drill -> switch tab datasource + apply filters
(function(){
  function parseHashParams(){
    let h = (location.hash || "").replace(/^#\/?/,"");
    if (!h) return {};
    const out = {};
    for (const part of h.split("&")){
      if (!part) continue;
      const [k,v] = part.split("=",2);
      if (!k) continue;
      out[decodeURIComponent(k)] = decodeURIComponent(v||"");
    }
    return out;
  }

  function buildHash(tab, filters){
    const sp = new URLSearchParams();
    sp.set("tab", tab || "datasource");
    for (const [k,v] of Object.entries(filters||{})){
      if (v === undefined || v === null) continue;
      const sv = String(v).trim();
      if (!sv) continue;
      sp.set(k, sv);
    }
    return "#" + sp.toString();
  }

  function switchToDatasourceTab(){
    // Try click datasource tab button if exists
    const btn = document.querySelector("#tab-datasource, [data-tab-btn='datasource'], a[href*='datasource']");
    if (btn && btn.click) btn.click();
  }

  function applyDatasource(filters){
    // Set hash first (so reload preserves)
    const h = buildHash("datasource", filters||{});
    if (location.hash !== h) location.hash = h;

    // then call sink if available
    const sink = window.VSP_DATASOURCE_APPLY_FILTERS_V1;
    if (typeof sink === "function"){
      try{ sink(filters||{}, {noHashSync:true}); }catch(e){}
    }
  }

  function handleDrillClick(e){
    const a = e.target.closest("[data-drill]");
    if (!a) return;
    e.preventDefault();
    let val = a.getAttribute("data-drill") || "";
    // accept JSON {"sev":"HIGH"} or query "sev=HIGH&tool=semgrep"
    let filters = {};
    try{
      if (val.trim().startsWith("{")) filters = JSON.parse(val);
      else{
        const sp = new URLSearchParams(val.replace(/^#\/?/,""));
        sp.forEach((v,k)=>{ filters[k]=v; });
      }
    }catch(_){
      filters = {};
    }
    switchToDatasourceTab();
    applyDatasource(filters);
  }

  function onHashChange(){
    const hp = parseHashParams();
    if ((hp.tab||"") !== "datasource") return;
    const f = Object.assign({}, hp);
    delete f.tab;
    const sink = window.VSP_DATASOURCE_APPLY_FILTERS_V1;
    if (typeof sink === "function"){
      sink(f, {noHashSync:true});
    }
  }

  function bind(){
    // delegate click drill
    if (!document.body._vspDrillBound){
      document.body._vspDrillBound = true;
      document.body.addEventListener("click", handleDrillClick);
    }
    window.addEventListener("hashchange", onHashChange);
    // initial
    onHashChange();
  }

  if (document.readyState === "loading"){
    document.addEventListener("DOMContentLoaded", bind);
  }else{
    bind();
  }
})();

// === VSP_P2_AUTOBIND_KPI_DRILL_V1 ===
// Auto bind drilldown for KPI cards (clickable commercial)
// - Uses dashboard_latest_v1.links if present
// - Fallback binds severity labels CRITICAL/HIGH/MEDIUM/LOW/INFO/TRACE
(function(){
  const SEVS = ["CRITICAL","HIGH","MEDIUM","LOW","INFO","TRACE"];

  function qs(sel, root){ return (root||document).querySelector(sel); }
  function qsa(sel, root){ return Array.from((root||document).querySelectorAll(sel)); }

  function norm(s){ return String(s||"").trim().toUpperCase(); }

  function parseDrillToQuery(drill){
    // drill may be absolute/relative url to datasource, or a query-like string
    if (!drill) return "";
    let s = String(drill).trim();
    // if full URL, take hash or query
    try{
      if (s.startsWith("http")){
        const u = new URL(s);
        if (u.hash && u.hash.length > 1) return u.hash.replace(/^#\/?/,"");
        if (u.search && u.search.length > 1) return u.search.replace(/^\?/,"");
      }
    }catch(_){}
    // if starts with #...
    s = s.replace(/^#\/?/,"");
    // remove leading vsp4 path fragments
    s = s.replace(/^\/?vsp4\??/,"").replace(/^\?/,"");
    return s;
  }

  async function fetchDash(){
    const r = await fetch("/api/vsp/dashboard_latest_v1", {cache:"no-store"});
    return await r.json();
  }

  function bindEl(el, query){
    if (!el || !query) return;
    // do not double bind
    if (el.getAttribute("data-drill")) return;
    el.setAttribute("data-drill", query);
    el.style.cursor = "pointer";
    el.title = el.title || "Click to drilldown";
  }

  function findKpiCandidates(){
    // broad selectors; harmless if none
    const sels = [
      ".vsp-kpi-card", ".kpi-card", ".kpi", ".vsp-card",
      "[data-kpi]", "[data-kpi-card]", "[data-role='kpi']"
    ];
    const out = [];
    for (const s of sels){
      qsa(s).forEach(x=>out.push(x));
    }
    // fallback: any card-like divs in dashboard area
    const dash = qs("#vsp-dashboard-main") || qs("#tab-dashboard") || document.body;
    qsa("div", dash).forEach(d=>{
      const txt = norm(d.innerText||"");
      if (SEVS.some(s=>txt.includes(s)) && (d.offsetWidth>80 && d.offsetHeight>40)){
        out.push(d);
      }
    });
    // unique
    return Array.from(new Set(out));
  }

  function bestEffortBindFromLinks(links){
    // expected shapes:
    // links: { severity: {HIGH:"tab=datasource&sev=HIGH"...}, all:"...", suppressed:"..." }
    if (!links || typeof links !== "object") return false;
    const kpis = findKpiCandidates();
    let bound = 0;

    // bind severity-based
    for (const sev of SEVS){
      const drill = links?.severity?.[sev] || links?.["severity."+sev] || links?.[sev] || null;
      if (!drill) continue;
      const q = parseDrillToQuery(drill);
      if (!q) continue;
      for (const el of kpis){
        const txt = norm(el.innerText||"");
        if (txt.includes(sev)){
          bindEl(el, q);
          bound++;
        }
      }
    }

    // bind "all" if present
    if (links.all){
      const q = parseDrillToQuery(links.all);
      if (q){
        for (const el of kpis){
          const txt = norm(el.innerText||"");
          if (txt.includes("TOTAL") || txt.includes("ALL") || txt.includes("FINDINGS")){
            bindEl(el, q);
            bound++;
          }
        }
      }
    }
    return bound > 0;
  }

  function fallbackBindSev(){
    const kpis = findKpiCandidates();
    let bound = 0;
    for (const sev of SEVS){
      const q = "tab=datasource&sev=" + encodeURIComponent(sev) + "&limit=200";
      for (const el of kpis){
        const txt = norm(el.innerText||"");
        if (txt.includes(sev)){
          bindEl(el, q);
          bound++;
        }
      }
    }
    return bound>0;
  }

  async function init(){
    try{
      const j = await fetchDash();
      const links = j?.links || j?.drilldown || j?.drill || null;
      const ok = bestEffortBindFromLinks(links);
      if (!ok) fallbackBindSev();
    }catch(e){
      fallbackBindSev();
    }
  }

  if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", init);
  else init();
})();



// === VSP_P2_FORCE_8TOOLS_V1 ===
// Force Gate Summary to show 8 tools (commercial). Missing tool => NOT_RUN/0.
// Also capture latest /api/vsp/run_status_v2 JSON via fetch clone.
(function(){
  try{
    if (window.__VSP_P2_FORCE_8TOOLS_V1_INSTALLED) return;
    window.__VSP_P2_FORCE_8TOOLS_V1_INSTALLED = true;

    const TOOL_ORDER = ["BANDIT","CODEQL","GITLEAKS","GRYPE","KICS","SEMGREP","SYFT","TRIVY"];
    window.__VSP_TOOL_ORDER = TOOL_ORDER;

    const origFetch = window.fetch;
    window.fetch = async function(){
      const resp = await origFetch.apply(this, arguments);
      try{
        const u = (typeof arguments[0] === "string") ? arguments[0] : (arguments[0] && arguments[0].url) || "";
        if (u.includes("/api/vsp/run_status_v2")) {
          resp.clone().json().then(j => {
            window.__VSP_LAST_STATUS_V2 = j;
            try { window.__VSP_RENDER_GATE_8TOOLS(); } catch(e){}
          }).catch(()=>{});
        }
      }catch(e){}
      return resp;
    };

    function pickToolObj(st, T){
      if (!st || typeof st !== "object") return null;
      const k = T.toLowerCase();
      return st[k + "_summary"] || st[k] || (st.tools && (st.tools[T] || st.tools[k])) || null;
    }

    function normVerdict(v){
      v = String(v || "").toUpperCase();
      if (!v) return "NOT_RUN";
      return v;
    }

    window.__VSP_RENDER_GATE_8TOOLS = function(){
      const st = window.__VSP_LAST_STATUS_V2;
      // find a plausible gate summary container
      const box =
        document.querySelector("#vsp-gate-summary") ||
        document.querySelector("#gate-summary") ||
        document.querySelector("[data-vsp-gate-summary]") ||
        document.querySelector(".vsp-gate-summary") ||
        document.querySelector("section#vsp-pane-dashboard .vsp-card .vsp-gate") ||
        null;
      if (!box) return;

      // create or find list container
      let list = box.querySelector(".vsp-gate-list");
      if (!list) {
        list = document.createElement("div");
        list.className = "vsp-gate-list";
        box.appendChild(list);
      }

      const rows = TOOL_ORDER.map(T => {
        const o = pickToolObj(st, T) || {};
        const verdict = normVerdict(o.verdict || o.status || o.result || (st && st[(T.toLowerCase()) + "_verdict"]) || "");
        const total = (o.total != null) ? Number(o.total) : Number((st && st[(T.toLowerCase()) + "_total"]) || 0) || 0;
        const pillCls = "vsp-pill vsp-pill-" + verdict.toLowerCase();

        return `
          <div class="vsp-gate-row" style="display:flex;align-items:center;justify-content:space-between;padding:6px 0;border-top:1px solid rgba(255,255,255,.06)">
            <div style="font-weight:650;letter-spacing:.2px">${T}</div>
            <div style="display:flex;gap:10px;align-items:center">
              <span class="${pillCls}">${verdict}</span>
              <span style="opacity:.75">total: ${total}</span>
            </div>
          </div>`;
      }).join("");

      list.innerHTML = rows;
    };

    // attempt render once later (in case status fetched before patch)
    setTimeout(()=>{ try{ window.__VSP_RENDER_GATE_8TOOLS(); }catch(e){} }, 1200);
  }catch(e){}
})();
 // === /VSP_P2_FORCE_8TOOLS_V1 ===




// === VSP_UI_DRILLDOWN_AND_EXPORTPROBE_V1 ===
(function(){
  'use strict';

  // --- tiny utils ---
  const LOG_ONCE = new Set();
  function logOnce(k, ...a){ if(LOG_ONCE.has(k)) return; LOG_ONCE.add(k); console.log(...a); }
  function nowMs(){ try { return Date.now(); } catch(_){ return 0; } }

  function ridFromPage(){
    // best-effort: try globals, DOM attrs, URL params
    try {
      if (window.VSP_RID) return String(window.VSP_RID);
      if (window.__VSP_RID__) return String(window.__VSP_RID__);
    } catch(_){}
    try {
      const u = new URL(location.href);
      const rid = u.searchParams.get("rid") || u.searchParams.get("run_id") || u.searchParams.get("id");
      if (rid) return String(rid);
    } catch(_){}
    try {
      const el = document.querySelector("[data-rid],[data-run-id],[data-runid]");
      const v = el && (el.getAttribute("data-rid") || el.getAttribute("data-run-id") || el.getAttribute("data-runid"));
      if (v) return String(v);
    } catch(_){}
    return null;
  }

  function openTab(tabId){
    // expects your 4-tabs router to exist; best-effort click
    try {
      // common patterns: button#tab-datasource / a[href='#datasource']
      const btn = document.querySelector("#tab-" + tabId + ", [data-tab='"+tabId+"'], a[href='#"+tabId+"']");
      if (btn) { btn.click(); return true; }
    } catch(_){}
    // fallback: try call existing router func if you have one
    try {
      if (typeof window.VSP_SWITCH_TAB === "function") { window.VSP_SWITCH_TAB(tabId); return true; }
      if (typeof window.vspSwitchTab === "function") { window.vspSwitchTab(tabId); return true; }
    } catch(_){}
    return false;
  }

  // --- datasource filter bus (localStorage + CustomEvent) ---
  const LS_KEY = "vsp_ds_filters_v1";

  function pushDatasourceFilters(filters, opts){
    opts = opts || {};
    const payload = {
      v: 1,
      ts: nowMs(),
      rid: opts.rid || ridFromPage(),
      filters: filters || {}
    };
    try { localStorage.setItem(LS_KEY, JSON.stringify(payload)); } catch(_){}
    try {
      window.dispatchEvent(new CustomEvent("vsp:datasource:setFilters", { detail: payload }));
    } catch(_){}
  }

  // public API for drilldown
  window.VSP_DRILL_TO_DATASOURCE = function(filters, opts){
    try {
      pushDatasourceFilters(filters || {}, opts || {});
      openTab("datasource");
    } catch(e) {
      console.warn("[VSP][DRILL] failed", e);
    }
  };

  // --- export probe: make it quiet + stop after first success ---
  async function probeExportOnce(url){
    // HEAD is often blocked/noisy in browser setups; fallback to GET safely.
    try {
      const r = await fetch(url, { method: "HEAD", cache: "no-store", credentials: "same-origin" });
      if (r && r.ok) return { ok:true, via:"HEAD", status:r.status, headers:r.headers };
    } catch(_){}
    try {
      const r = await fetch(url + (url.includes("?") ? "&" : "?") + "_probe=1", { method: "GET", cache: "no-store", credentials: "same-origin" });
      if (r && r.ok) return { ok:true, via:"GET", status:r.status, headers:r.headers };
      return { ok:false, via:"GET", status: (r && r.status) || 0, headers: r && r.headers };
    } catch(e){
      return { ok:false, via:"ERR", status:0, err:String(e) };
    }
  }

  async function commercialExportProbeQuiet(){
    // only run on pages that show export controls
    const rid = ridFromPage();
    if (!rid) return;

    // build canonical export URL once (commercial behavior)
    const base = (window.VSP_RUN_EXPORT_BASE || "/api/vsp/run_export_v3").replace(/\/+$/,"");
    const pdfUrl = base + "/" + encodeURIComponent(rid) + "?fmt=pdf";

    const key = "export-probe-" + rid;
    if (window.__VSP_EXPORT_PROBED__ && window.__VSP_EXPORT_PROBED__[rid]) return;
    window.__VSP_EXPORT_PROBED__ = window.__VSP_EXPORT_PROBED__ || {};
    window.__VSP_EXPORT_PROBED__[rid] = true;

    const res = await probeExportOnce(pdfUrl);
    // treat failures as non-fatal; do NOT spam console
    if (!res.ok){
      logOnce(key+"-fail", "[VSP][EXPORT][PROBE] pdf probe not OK (non-fatal)", { rid, url: pdfUrl, via: res.via, status: res.status });
      window.VSP_EXPORT_AVAILABLE = window.VSP_EXPORT_AVAILABLE || {};
      window.VSP_EXPORT_AVAILABLE.pdf = 0;
      return;
    }

    // success: set availability and stop further probes
    window.VSP_EXPORT_AVAILABLE = window.VSP_EXPORT_AVAILABLE || {};
    window.VSP_EXPORT_AVAILABLE.pdf = 1;
    logOnce(key+"-ok", "[VSP][EXPORT][PROBE] pdf available", { rid, via: res.via, status: res.status });

    // if you have UI pills/badges, update them quietly
    try {
      const pill = document.querySelector("[data-export='pdf'], #pill-export-pdf, #pill-pdf");
      if (pill) { pill.classList.add("is-ok"); pill.classList.remove("is-bad"); }
    } catch(_){}
  }

  // run once after DOM ready
  function onReady(fn){
    if (document.readyState === "complete" || document.readyState === "interactive") return setTimeout(fn, 0);
    document.addEventListener("DOMContentLoaded", fn, { once: true });
  }

  // --- attach drilldown click helpers (best-effort, non-breaking) ---
  function wireDrilldownClicks(){
    // opt-in attributes (recommended): data-vsp-drill-tool / data-vsp-drill-sev / data-vsp-drill-cwe
    const els = document.querySelectorAll("[data-vsp-drill-tool],[data-vsp-drill-sev],[data-vsp-drill-cwe]");
    els.forEach(el=>{
      if (el.__vsp_drilled__) return;
      el.__vsp_drilled__ = true;
      el.style.cursor = "pointer";
      el.addEventListener("click", ()=>{
        const tool = el.getAttribute("data-vsp-drill-tool");
        const sev  = el.getAttribute("data-vsp-drill-sev");
        const cwe  = el.getAttribute("data-vsp-drill-cwe");
        const filters = {};
        if (tool) filters.tool = tool;
        if (sev)  filters.severity = sev;
        if (cwe)  filters.cwe = cwe;
        window.VSP_DRILL_TO_DATASOURCE(filters);
      });
    });

    // fallback: gate summary pills often include tool/sev text
    const pills = document.querySelectorAll(".vsp-pill,[data-pill]");
    pills.forEach(p=>{
      if (p.__vsp_drilled__) return;
      const t = (p.textContent || "").trim();
      // simple patterns: "GITLEAKS", "SEMGREP", "CRITICAL", "HIGH", "CWE-79"
      // (intentionally empty; handled by wireFallbackPills)
    });
  }

  // NOTE: avoid python-style in JS; keep safe fallback only
  function wireFallbackPills(){
    const pills = document.querySelectorAll(".vsp-pill,[data-pill]");
    pills.forEach(p=>{
      if (p.__vsp_drilled__) return;
      const txt = (p.textContent || "").trim();
      if (!txt) return;

      const up = txt.toUpperCase();
      const filters = {};
      const toolSet = new Set(["GITLEAKS","SEMGREP","TRIVY","CODEQL","KICS","GRYPE","SYFT","BANDIT"]);
      const sevSet  = new Set(["CRITICAL","HIGH","MEDIUM","LOW","INFO","TRACE"]);
      if (toolSet.has(up)) filters.tool = up;
      if (sevSet.has(up))  filters.severity = up;
      if (/^CWE-\d+$/i.test(up)) filters.cwe = up;

      if (Object.keys(filters).length === 0) return;

      p.__vsp_drilled__ = true;
      p.style.cursor = "pointer";
      p.title = "Click to drilldown → Data Source";
      p.addEventListener("click", ()=> window.VSP_DRILL_TO_DATASOURCE(filters));
    });
  }

  onReady(()=>{
    try { commercialExportProbeQuiet(); } catch(e){ /* silent */ }
    try { wireDrilldownClicks(); } catch(e){ /* silent */ }
    try { wireFallbackPills(); } catch(e){ /* silent */ }
  });

})();


/* VSP_DASH_BADGES_P1_V1: Dashboard badges for Degraded tools + Rule Overrides delta (live RID) */
(function(){
  'use strict';

  async function _j(url, timeoutMs=6000){
    const ctrl = new AbortController();
    const t = setTimeout(()=>ctrl.abort(), timeoutMs);
    try{
      const r = await fetch(url, {signal: ctrl.signal, headers:{'Accept':'application/json'}});
      const ct = (r.headers.get('content-type')||'').toLowerCase();
      if(!ct.includes('application/json')) return null;
      return await r.json();
    }catch(e){
      return null;
    }finally{
      clearTimeout(t);
    }
  }

  function _getRidFromLocal(){
    const keys = ["vsp_selected_rid_v2","vsp_selected_rid","vsp_current_rid","VSP_RID","vsp_rid"];
    for(const k of keys){
      try{
        const v = localStorage.getItem(k);
        if(v && v !== "null" && v !== "undefined") return v;
      }catch(e){}
    }
    return null;
  }

  async function _getRid(){
    try{
      if(window.VSP_RID && typeof window.VSP_RID.get === "function"){
        const r = window.VSP_RID.get();
        if(r) return r;
      }
    }catch(e){}
    const l = _getRidFromLocal();
    if(l) return l;

    const x = await _j("/api/vsp/latest_rid_v1");
    if(x && x.ok && x.run_id) return x.run_id;
    return null;
  }

  function _findDashHost(){
    return document.getElementById("vsp4-dashboard")
      || document.querySelector("[data-tab='dashboard']")
      || document.querySelector("#tab-dashboard")
      || document.querySelector(".vsp-dashboard")
      || document.querySelector("main")
      || document.body;
  }

  function _ensureBar(){
    const host = _findDashHost();
    if(!host) return null;

    let bar = document.getElementById("vsp-dash-p1-badges");
    if(bar) return bar;

    bar = document.createElement("div");
    bar.id = "vsp-dash-p1-badges";
    bar.style.cssText = "margin:10px 0 12px 0;padding:10px 12px;border:1px solid rgba(148,163,184,.18);border-radius:14px;background:rgba(2,6,23,.35);display:flex;gap:10px;flex-wrap:wrap;align-items:center;";

    function pill(id, label){
      const a = document.createElement("a");
      a.href="#";
      a.id=id;
      a.style.cssText = "display:inline-flex;gap:8px;align-items:center;padding:7px 10px;border-radius:999px;border:1px solid rgba(148,163,184,.22);text-decoration:none;color:#cbd5e1;font-size:12px;white-space:nowrap;";
      a.innerHTML = `<b style="font-weight:700;color:#e2e8f0">${label}</b><span style="opacity:.9" data-val>loading…</span>`;
      return a;
    }

    bar.appendChild(pill("vsp-pill-degraded","Degraded"));
    bar.appendChild(pill("vsp-pill-overrides","Overrides"));
    bar.appendChild(pill("vsp-pill-rid","RID"));

    host.prepend(bar);
    return bar;
  }

  function _setPill(id, text){
    const a = document.getElementById(id);
    if(!a) return;
    const v = a.querySelector("[data-val]");
    if(v) v.textContent = text;
  }

  function _fmtDegraded(st){
    const arr = (st && st.degraded_tools) ? st.degraded_tools : [];
    if(!arr || !arr.length) return "none";
    const parts = [];
    for(const it of arr.slice(0,4)){
      const tool = it.tool || it.name || "tool";
      const rc = (it.rc !== undefined && it.rc !== null) ? `rc=${it.rc}` : "";
      const v  = it.verdict ? String(it.verdict) : "";
      const why = it.reason || it.error || it.note || "";
      const one = [tool, v, rc].filter(Boolean).join(":") + (why ? ` (${String(why).slice(0,30)})` : "");
      parts.push(one.trim());
    }
    return parts.join(" | ") + (arr.length>4 ? ` (+${arr.length-4})` : "");
  }

  function _fmtOverrides(eff){
    const d = (eff && eff.delta) ? eff.delta : {};
    const matched = d.matched_n ?? 0;
    const applied = d.applied_n ?? 0;
    const sup = d.suppressed_n ?? 0;
    const chg = d.changed_severity_n ?? 0;
    const exp = d.expired_match_n ?? 0;
    return `matched=${matched} applied=${applied} suppressed=${sup} changed=${chg} expired=${exp}`;
  }

  async function refresh(){
    _ensureBar();
    const rid = await _getRid();
    _setPill("vsp-pill-rid", rid || "n/a");
    if(!rid) return;

    const [st, eff] = await Promise.all([
      _j(`/api/vsp/run_status_v2/${encodeURIComponent(rid)}`),
      _j(`/api/vsp/findings_effective_v1/${encodeURIComponent(rid)}?limit=0`)
    ]);

    _setPill("vsp-pill-degraded", _fmtDegraded(st));
    _setPill("vsp-pill-overrides", _fmtOverrides(eff));
  }

  document.addEventListener("click", function(ev){
    const a = ev.target && ev.target.closest && ev.target.closest("#vsp-pill-degraded,#vsp-pill-overrides");
    if(!a) return;
    ev.preventDefault();
    try{
      if(window.VSP_DASH_DRILLDOWN && typeof window.VSP_DASH_DRILLDOWN.open === "function"){
        window.VSP_DASH_DRILLDOWN.open();
      }
    }catch(e){}
  }, true);

  window.addEventListener("vsp:rid_changed", function(){ refresh(); });
  window.addEventListener("hashchange", function(){ setTimeout(refresh, 120); });
  window.addEventListener("load", function(){ setTimeout(refresh, 200); });

  setTimeout(refresh, 250);
})();


/* VSP_DASH_BADGES_P1_V3_FIXEDBAR: ensure badges visible even if dashboard host selector mismatch */
(function(){
  'use strict';

  function _pickHost(){
    // 1) container that holds KPI cards
    const card = document.querySelector(".vsp-card, .dashboard-card, .card");
    if(card && card.parentElement) return card.parentElement;

    // 2) active tab pane (common patterns)
    const active = document.querySelector(".tab-pane.active, .tab-content .active, [role='tabpanel'][aria-hidden='false']");
    if(active) return active;

    // 3) main content region
    return document.querySelector("main") || document.body;
  }

  function _ensureFixedStyle(){
    if(document.getElementById("vsp-dash-fixed-style")) return;
    const st = document.createElement("style");
    st.id="vsp-dash-fixed-style";
    st.textContent = `
      #vsp-dash-p1-badges{ z-index:9999; }
      #vsp-dash-p1-badges.vsp-fixed{
        position: sticky;
        top: 0;
        backdrop-filter: blur(8px);
        background: rgba(2,6,23,.60) !important;
      }
    `;
    document.head.appendChild(st);
  }

  // override ensureBar from V1 (if exists) by recreating bar + sticky class
  function ensureBarV3(){
    _ensureFixedStyle();
    let bar = document.getElementById("vsp-dash-p1-badges");
    if(bar) {
      bar.classList.add("vsp-fixed");
      return bar;
    }
    const host = _pickHost();
    if(!host) return null;

    bar = document.createElement("div");
    bar.id = "vsp-dash-p1-badges";
    bar.className = "vsp-fixed";
    bar.style.cssText = "margin:0 0 12px 0;padding:10px 12px;border:1px solid rgba(148,163,184,.18);border-radius:14px;background:rgba(2,6,23,.35);display:flex;gap:10px;flex-wrap:wrap;align-items:center;";

    function pill(id, label){
      const a = document.createElement("a");
      a.href="#";
      a.id=id;
      a.style.cssText = "display:inline-flex;gap:8px;align-items:center;padding:7px 10px;border-radius:999px;border:1px solid rgba(148,163,184,.22);text-decoration:none;color:#cbd5e1;font-size:12px;white-space:nowrap;";
      a.innerHTML = `<b style="font-weight:700;color:#e2e8f0">${label}</b><span style="opacity:.9" data-val>loading…</span>`;
      return a;
    }

    bar.appendChild(pill("vsp-pill-degraded","Degraded"));
    bar.appendChild(pill("vsp-pill-overrides","Overrides"));
    bar.appendChild(pill("vsp-pill-rid","RID"));

    host.prepend(bar);
    return bar;
  }

  // kick once after load to guarantee visibility
  window.addEventListener("load", function(){
    setTimeout(()=>{ try{ ensureBarV3(); }catch(e){} }, 200);
  });
  window.addEventListener("hashchange", function(){
    setTimeout(()=>{ try{ ensureBarV3(); }catch(e){} }, 120);
  });
  window.addEventListener("vsp:rid_changed", function(){
    setTimeout(()=>{ try{ ensureBarV3(); }catch(e){} }, 50);
  });
})();


/* VSP_DASH_DRILLDOWN_P1_V1: openable drilldown panel for Degraded + Overrides */
(function(){
  'use strict';

  async function _j(url, timeoutMs=8000){
    const ctrl = new AbortController();
    const t = setTimeout(()=>ctrl.abort(), timeoutMs);
    try{
      const r = await fetch(url, {signal: ctrl.signal, headers:{'Accept':'application/json'}});
      const ct = (r.headers.get('content-type')||'').toLowerCase();
      if(!ct.includes('application/json')) return null;
      return await r.json();
    }catch(e){
      return null;
    }finally{
      clearTimeout(t);
    }
  }

  function _getRidFromLocal(){
    const keys = ["vsp_selected_rid_v2","vsp_selected_rid","vsp_current_rid","VSP_RID","vsp_rid"];
    for(const k of keys){
      try{
        const v = localStorage.getItem(k);
        if(v && v !== "null" && v !== "undefined") return v;
      }catch(e){}
    }
    return null;
  }

  async function _getRid(){
    try{
      if(window.VSP_RID && typeof window.VSP_RID.get === "function"){
        const r = window.VSP_RID.get();
        if(r) return r;
      }
    }catch(e){}
    const l = _getRidFromLocal();
    if(l) return l;
    const x = await _j("/api/vsp/latest_rid_v1");
    if(x && x.ok && x.run_id) return x.run_id;
    return null;
  }

  function _ensureUI(){
    if(document.getElementById("vsp-dd-overlay")) return;

    const st = document.createElement("style");
    st.id = "vsp-dd-style";
    st.textContent = `
      #vsp-dd-overlay{position:fixed;inset:0;z-index:10000;background:rgba(0,0,0,.55);display:none;}
      #vsp-dd-panel{position:fixed;top:60px;right:18px;bottom:18px;width:min(820px,calc(100vw - 36px));
        z-index:10001;background:rgba(2,6,23,.96);border:1px solid rgba(148,163,184,.18);border-radius:18px;
        box-shadow:0 20px 80px rgba(0,0,0,.55);display:none;overflow:hidden;}
      #vsp-dd-head{display:flex;align-items:center;justify-content:space-between;padding:14px 14px;border-bottom:1px solid rgba(148,163,184,.14);}
      #vsp-dd-title{font-weight:800;color:#e2e8f0;font-size:14px;letter-spacing:.2px}
      #vsp-dd-actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
      .vsp-dd-btn{padding:7px 10px;border-radius:12px;border:1px solid rgba(148,163,184,.22);background:rgba(15,23,42,.55);
        color:#cbd5e1;font-size:12px;cursor:pointer}
      .vsp-dd-btn:hover{filter:brightness(1.08)}
      #vsp-dd-body{padding:14px;overflow:auto;height:calc(100% - 56px);color:#cbd5e1}
      .vsp-dd-card{border:1px solid rgba(148,163,184,.14);border-radius:16px;background:rgba(15,23,42,.35);padding:12px 12px;margin-bottom:12px;}
      .vsp-dd-kv{display:grid;grid-template-columns:160px 1fr;gap:6px 12px;font-size:12px;}
      .vsp-dd-k{opacity:.85}
      .vsp-dd-v{color:#e2e8f0}
      .vsp-dd-table{width:100%;border-collapse:separate;border-spacing:0 8px;font-size:12px;}
      .vsp-dd-table td{padding:8px 10px;border:1px solid rgba(148,163,184,.14);background:rgba(2,6,23,.35);}
      .vsp-dd-table tr td:first-child{border-radius:12px 0 0 12px;}
      .vsp-dd-table tr td:last-child{border-radius:0 12px 12px 0;}
      .vsp-dd-muted{opacity:.75}
      .vsp-dd-link{color:#93c5fd;text-decoration:none}
      .vsp-dd-link:hover{text-decoration:underline}
      code.vsp-dd-code{background:rgba(2,6,23,.6);border:1px solid rgba(148,163,184,.16);padding:2px 6px;border-radius:8px}
    `;
    document.head.appendChild(st);

    const ov = document.createElement("div");
    ov.id="vsp-dd-overlay";
    ov.addEventListener("click", close);
    document.body.appendChild(ov);

    const panel = document.createElement("div");
    panel.id="vsp-dd-panel";
    panel.innerHTML = `
      <div id="vsp-dd-head">
        <div id="vsp-dd-title">Drilldown</div>
        <div id="vsp-dd-actions">
          <button class="vsp-dd-btn" id="vsp-dd-refresh">Refresh</button>
          <button class="vsp-dd-btn" id="vsp-dd-copy">Copy RID</button>
          <button class="vsp-dd-btn" id="vsp-dd-close">Close</button>
        </div>
      </div>
      <div id="vsp-dd-body">
        <div class="vsp-dd-card"><div class="vsp-dd-muted">Loading…</div></div>
      </div>
    `;
    document.body.appendChild(panel);

    document.getElementById("vsp-dd-close").addEventListener("click", close);
    document.getElementById("vsp-dd-refresh").addEventListener("click", render);
    document.getElementById("vsp-dd-copy").addEventListener("click", async ()=>{
      const rid = await _getRid();
      try{ await navigator.clipboard.writeText(rid||""); }catch(e){}
    });

    window.addEventListener("keydown", (e)=>{
      if(e.key === "Escape") close();
    });
  }

  function open(){
    _ensureUI();
    document.getElementById("vsp-dd-overlay").style.display="block";
    document.getElementById("vsp-dd-panel").style.display="block";
    render();
  }

  function close(){
    const ov=document.getElementById("vsp-dd-overlay");
    const pn=document.getElementById("vsp-dd-panel");
    if(ov) ov.style.display="none";
    if(pn) pn.style.display="none";
  }

  function _fmtOverrides(eff){
    const d = (eff && eff.delta) ? eff.delta : {};
    const matched = d.matched_n ?? 0;
    const applied = d.applied_n ?? 0;
    const sup = d.suppressed_n ?? 0;
    const chg = d.changed_severity_n ?? 0;
    const exp = d.expired_match_n ?? 0;
    return {matched, applied, sup, chg, exp, now_utc: d.now_utc || ""};
  }

  function _htmlEscape(x){
    return String(x||"").replace(/[&<>"]/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;" }[c]));
  }

  async function render(){
    _ensureUI();
    const body = document.getElementById("vsp-dd-body");
    const title = document.getElementById("vsp-dd-title");
    const rid = await _getRid();
    title.textContent = rid ? `Drilldown • ${rid}` : "Drilldown • (no RID)";

    if(!rid){
      body.innerHTML = `<div class="vsp-dd-card"><div class="vsp-dd-muted">No RID selected.</div></div>`;
      return;
    }

    body.innerHTML = `<div class="vsp-dd-card"><div class="vsp-dd-muted">Loading ${_htmlEscape(rid)}…</div></div>`;

    const [st, eff, art] = await Promise.all([
      _j(`/api/vsp/run_status_v2/${encodeURIComponent(rid)}`),
      _j(`/api/vsp/findings_effective_v1/${encodeURIComponent(rid)}?limit=0`),
      _j(`/api/vsp/run_artifacts_index_v1/${encodeURIComponent(rid)}`)
    ]);

    const degraded = (st && st.degraded_tools) ? st.degraded_tools : [];
    const ov = _fmtOverrides(eff);

    let artHtml = `<div class="vsp-dd-muted">Artifacts: n/a</div>`;
    if(art && (art.ok || art.items)){
      const items = art.items || [];
      const links = items.slice(0,10).map(it=>{
        const name = _htmlEscape(it.name || it.file || "artifact");
        const url  = it.url || it.href || it.download_url || "";
        if(url) return `<a class="vsp-dd-link" href="${_htmlEscape(url)}" target="_blank" rel="noopener">${name}</a>`;
        return `<span class="vsp-dd-muted">${name}</span>`;
      });
      artHtml = `<div class="vsp-dd-muted">Artifacts:</div><div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:6px;">${links.join(" ") || '<span class="vsp-dd-muted">empty</span>'}</div>`;
    }

    const degradedRows = (degraded||[]).map(it=>{
      const tool=_htmlEscape(it.tool || it.name || "");
      const verdict=_htmlEscape(it.verdict || "");
      const rc=(it.rc!==undefined && it.rc!==null) ? _htmlEscape(it.rc) : "";
      const reason=_htmlEscape(it.reason || it.error || it.note || "");
      return `<tr>
        <td><b>${tool}</b></td>
        <td>${verdict || '<span class="vsp-dd-muted">—</span>'}</td>
        <td>${rc || '<span class="vsp-dd-muted">—</span>'}</td>
        <td>${reason || '<span class="vsp-dd-muted">—</span>'}</td>
      </tr>`;
    }).join("");

    body.innerHTML = `
      <div class="vsp-dd-card">
        <div style="font-weight:800;color:#e2e8f0;margin-bottom:8px;">Overview</div>
        <div class="vsp-dd-kv">
          <div class="vsp-dd-k">RID</div><div class="vsp-dd-v"><code class="vsp-dd-code">${_htmlEscape(rid)}</code></div>
          <div class="vsp-dd-k">Overrides delta</div><div class="vsp-dd-v">matched=${ov.matched} • applied=${ov.applied} • suppressed=${ov.sup} • changed=${ov.chg} • expired=${ov.exp}</div>
          <div class="vsp-dd-k">Delta time</div><div class="vsp-dd-v">${_htmlEscape(ov.now_utc) || '<span class="vsp-dd-muted">—</span>'}</div>
          <div class="vsp-dd-k">Degraded tools</div><div class="vsp-dd-v">${(degraded||[]).length || 0}</div>
        </div>
        <div style="margin-top:10px;">${artHtml}</div>
      </div>

      <div class="vsp-dd-card">
        <div style="font-weight:800;color:#e2e8f0;margin-bottom:8px;">Degraded details</div>
        ${(degraded && degraded.length) ? `
          <table class="vsp-dd-table">
            <tr>
              <td><b>Tool</b></td><td><b>Verdict</b></td><td><b>RC</b></td><td><b>Reason</b></td>
            </tr>
            ${degradedRows}
          </table>
        ` : `<div class="vsp-dd-muted">No degraded tools.</div>`}
      </div>
    `;
  }

  window.VSP_DASH_DRILLDOWN = { open, close, render };
})();

