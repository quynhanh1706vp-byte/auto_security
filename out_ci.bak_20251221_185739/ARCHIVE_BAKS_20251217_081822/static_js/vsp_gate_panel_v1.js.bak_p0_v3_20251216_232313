/* vsp_gate_panel_v1.js
 * Commercial Gate UI: GREEN / AMBER / RED + evidence links
 * - Picks latest RID from runs_index_v3_fs_resolved
 * - Uses run_status_v2/<RID> as source of truth
 */
(function () {
  'use strict';

  
  
  
  // P0 CANONICAL: gate panel must never fail because runs_index is filtered empty
  const __VSP_GATE_ORIG_FETCH__ = window.fetch.bind(window);

  function __vsp_gate_norm_url(u){
    try{
      if (typeof u !== "string") return u;
      if (u.indexOf("runs_index") < 0) return u;

      // force canonical params
      if (u.indexOf("filter=") >= 0) u = u.replace(/filter=\d+/g, "filter=0");
      else u += (u.indexOf("?")>=0 ? "&" : "?") + "filter=0";

      if (u.indexOf("hide_empty=") >= 0) u = u.replace(/hide_empty=\d+/g, "hide_empty=0");
      else u += (u.indexOf("?")>=0 ? "&" : "?") + "hide_empty=0";

      if (u.indexOf("limit=") >= 0) u = u.replace(/limit=\d+/g, "limit=1");
      else u += (u.indexOf("?")>=0 ? "&" : "?") + "limit=1";

      return u;
    }catch(_){ return u; }
  }

  function __vsp_gate_fetch(u, opts){
    try{ return __VSP_GATE_ORIG_FETCH__(__vsp_gate_norm_url(u), opts); }
    catch(_){ return __VSP_GATE_ORIG_FETCH__(u, opts); }
  }
// P0 FIX: ensure vspGateFetch exists (gate panel must never ReferenceError)
  function vspGateNormalizeRunsIndexUrl(u){
    try{
      if (typeof u !== "string") return u;
      if (u.indexOf("runs_index") < 0) return u;

      // force canonical params
      if (u.indexOf("filter=") >= 0) u = u.replace(/filter=\d+/g, "filter=0");
      else u += (u.indexOf("?")>=0 ? "&" : "?") + "filter=0";

      if (u.indexOf("hide_empty=") >= 0) u = u.replace(/hide_empty=\d+/g, "hide_empty=0");
      else u += (u.indexOf("?")>=0 ? "&" : "?") + "hide_empty=0";

      if (u.indexOf("limit=") >= 0) u = u.replace(/limit=\d+/g, "limit=1");
      else u += (u.indexOf("?")>=0 ? "&" : "?") + "limit=1";

      return u;
    }catch(_){ return u; }
  }
  function vspGateFetch(u, opts){
    try{
      const u2 = vspGateNormalizeRunsIndexUrl(u);
      return __vsp_gate_fetch(u2, opts);
    }catch(_){
      return __vsp_gate_fetch(u, opts);
    }
  }
// P0 CANONICAL: normalize runs_index URL (avoid empty gate panel)
  function vspGateNormalizeRunsIndexUrl(u){
    try{
      if (typeof u !== "string") return u;
      if (u.indexOf("runs_index") < 0) return u;

      // force filter=0
      if (u.indexOf("filter=") >= 0) {
        u = u.replace(/filter=\d+/g, "filter=0");
      } else {
        u += (u.indexOf("?")>=0 ? "&" : "?") + "filter=0";
      }

      // ensure hide_empty=0
      if (u.indexOf("hide_empty=") >= 0) u = u.replace(/hide_empty=\d+/g, "hide_empty=0");
      else u += (u.indexOf("?")>=0 ? "&" : "?") + "hide_empty=0";

      // ensure limit=1
      if (u.indexOf("limit=") >= 0) u = u.replace(/limit=\d+/g, "limit=1");
      else u += (u.indexOf("?")>=0 ? "&" : "?") + "limit=1";

      return u;
    }catch(_){ return u; }
  }
var EP_RUNS = '/api/vsp/runs_index_v3_fs_v4?limit=1&hide_empty=0&filter=1';
  function log(){ try{ console.log.apply(console, arguments);}catch(e){} }
  function esc(s){
    return String(s==null?'':s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;').replace(/'/g,'&#39;');
  }

  function pickDashboardPane(){
    return (
      document.getElementById('vsp-dashboard-main') ||
      document.getElementById('vsp-dashboard') ||
      document.querySelector('[data-vsp-pane="dashboard"]') ||
      document.querySelector('#pane-dashboard') ||
      document.querySelector('#tab-dashboard') ||
      document.querySelector('.vsp-pane-dashboard') ||
      null
    );
  }

  function pill(status){
    var s = String(status||'').toUpperCase();
    var bg = 'rgba(255,255,255,.10)', bd='rgba(255,255,255,.18)';
    if (s === 'GREEN') { bg='rgba(16,185,129,.18)'; bd='rgba(16,185,129,.35)'; }
    if (s === 'AMBER') { bg='rgba(245,158,11,.18)'; bd='rgba(245,158,11,.35)'; }
    if (s === 'RED')   { bg='rgba(239,68,68,.18)'; bd='rgba(239,68,68,.35)'; }
    return '<span style="display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid '+bd+';background:'+bg+';font-weight:700;font-size:12px;">'
      + esc(s || 'UNKNOWN') + '</span>';
  }

  function mkLink(href,label){
    return '<a class="vsp-btn vsp-btn-soft" target="_blank" rel="noopener" href="'+esc(href)+'">'+esc(label)+'</a>';
  }

  function computeGate(statusJson){
    var degradedN = 0;
    if (statusJson && Array.isArray(statusJson.degraded_tools)) degradedN = statusJson.degraded_tools.length;

    // heuristics: if api ok:false OR final:true with status contains fail/error OR has error field => RED
    var apiOk = (statusJson && statusJson.ok === true);
    var final = !!(statusJson && (statusJson.final === true || statusJson.is_final === true));
    var st = String((statusJson && (statusJson.status || statusJson.state || statusJson.result)) || '').toLowerCase();
    var err = statusJson && (statusJson.error || statusJson.err || statusJson.message);

    if (degradedN > 0) return { gate:'AMBER', reason:'degraded_tools=' + degradedN };
    if (!apiOk) return { gate:'RED', reason:'status_v2 ok=false' };
    if (err && final) return { gate:'RED', reason:'final error' };
    if (final && (st.includes('fail') || st.includes('error') || st.includes('crash'))) return { gate:'RED', reason:'final=' + st };
    return { gate:'GREEN', reason:'clean (no degraded, no final-fail)' };
  }

  function ensurePanel(pane){
    var el = document.getElementById('vsp-gate-panel-v1');
    if (el) return el;

    el = document.createElement('div');
    el.id = 'vsp-gate-panel-v1';
    el.className = 'vsp-card';
    el.style.margin = '12px 0';
    el.style.padding = '14px';

    // insert near top of dashboard
    if (pane.firstChild) pane.insertBefore(el, pane.firstChild);
    else pane.appendChild(el);
    return el;
  }

  function renderLoading(el){
    el.innerHTML =
      '<div style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;">' +
      '  <div>' +
      '    <div style="font-weight:800; font-size:16px;">CI/CD Gate</div>' +
      '    <div style="opacity:.75; font-size:12px;">Loading latest run…</div>' +
      '  </div>' +
      '  <div><button id="vsp-gate-refresh" class="vsp-btn vsp-btn-primary" style="padding:10px 14px;">Refresh</button></div>' +
      '</div>';
    var b = document.getElementById('vsp-gate-refresh');
    if (b) b.onclick = function(){ window.VSP_GATE_REFRESH && window.VSP_GATE_REFRESH(); };
  }

  function render(el, rid, rid_norm, ci_run_dir, statusJson){
    var g = computeGate(statusJson);
    var base = '/api/vsp';
    var links = [
      mkLink(base + '/run_status_v2/' + encodeURIComponent(rid), 'status_v2'),
      mkLink(base + '/run_artifacts_index_v1/' + encodeURIComponent(rid), 'artifacts'),
      mkLink(base + '/run_artifact_v2/' + encodeURIComponent(rid) + '?path=' + encodeURIComponent('runner.log'), 'runner.log'),
      mkLink(base + '/run_artifact_v2/' + encodeURIComponent(rid) + '?path=' + encodeURIComponent('degraded_tools.json'), 'degraded_tools.json'),
      mkLink(base + '/run_artifact_v2/' + encodeURIComponent(rid) + '?path=' + encodeURIComponent('report/summary_unified.json'), 'summary'),
      mkLink(base + '/run_artifact_v2/' + encodeURIComponent(rid) + '?path=' + encodeURIComponent('report/findings_unified.json'), 'findings')
    ].join(' ');

    el.innerHTML =
      '<div style="display:flex; align-items:flex-start; justify-content:space-between; gap:12px; flex-wrap:wrap;">' +
      '  <div style="min-width:320px;">' +
      '    <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">' +
      '      <div style="font-weight:800; font-size:16px;">CI/CD Gate</div>' +
      '      ' + pill(g.gate) +
      '      <div style="opacity:.8; font-size:12px;">' + esc(g.reason) + '</div>' +
      '    </div>' +
      '    <div style="margin-top:10px; font-size:12px; opacity:.85; line-height:1.5;">' +
      '      <div><span style="opacity:.7;">RID:</span> <code>' + esc(rid) + '</code></div>' +
      '      <div><span style="opacity:.7;">rid_norm:</span> <code>' + esc(rid_norm || '') + '</code></div>' +
      '      <div style="max-width:980px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;"><span style="opacity:.7;">ci_run_dir:</span> <code>' + esc(ci_run_dir || '') + '</code></div>' +
      '    </div>' +
      '  </div>' +
      '  <div style="display:flex; gap:10px; align-items:center;">' +
      '    <button id="vsp-gate-refresh" class="vsp-btn vsp-btn-primary" style="padding:10px 14px;">Refresh</button>' +
      '  </div>' +
      '</div>' +
      '<div style="margin-top:12px; display:flex; flex-wrap:wrap; gap:10px;">' + links + '</div>' +
      '<div style="margin-top:10px; opacity:.65; font-size:12px;">Gate policy: degraded→AMBER, final fail→RED, else→GREEN.</div>';

    var b = document.getElementById('vsp-gate-refresh');
    if (b) b.onclick = function(){ window.VSP_GATE_REFRESH && window.VSP_GATE_REFRESH(); };
  }

  function loadLatestAndRender(force){
    var pane = pickDashboardPane();
    if (!pane) { log('[VSP_GATE] dashboard pane not found -> skip'); return; }

    var hash = (location.hash || '').toLowerCase();
    if (!force && hash && !hash.includes('dashboard')) return;

    var el = ensurePanel(pane);
    renderLoading(el);

    vspGateFetch(EP_RUNS, { credentials:'same-origin' })
      .then(function(r){ return r.json(); })
      .then(function(j){
        var it = (j && j.items && j.items[0]) ? j.items[0] : null;
        if (!it) 
try{ console.warn("[VSP_GATE] no runs from runs_index_v3_fs_resolved (degraded)"); }catch(_){ } return;
        var rid = it.run_id || it.request_id || it.req_id;
        if (!rid) throw new Error('missing rid in runs_index_v3_fs_resolved item');

        var rid_norm = it.rid_norm || '';
        var ci_run_dir = it.ci_run_dir || '';

        return vspGateFetch('/api/vsp/run_status_v2/' + encodeURIComponent(rid), { credentials:'same-origin' })
          .then(function(r){ return r.json(); })
          .then(function(st){ render(el, rid, rid_norm, ci_run_dir, st); });
      })
      .catch(function(e){
        el.innerHTML =
          '<div style="font-weight:800; font-size:16px;">CI/CD Gate</div>' +
          '<div style="margin-top:8px; opacity:.8;">Failed to load gate</div>' +
          '<pre style="margin-top:10px; white-space:pre-wrap; opacity:.85; font-size:12px;">' + esc(String(e && e.stack ? e.stack : e)) + '</pre>' +
          '<div style="margin-top:10px;"><button id="vsp-gate-refresh" class="vsp-btn vsp-btn-primary" style="padding:10px 14px;">Refresh</button></div>';
        var b = document.getElementById('vsp-gate-refresh');
        if (b) b.onclick = function(){ window.VSP_GATE_REFRESH && window.VSP_GATE_REFRESH(); };
      });
  }

  window.VSP_GATE_REFRESH = function(){ loadLatestAndRender(true); };
  window.addEventListener('hashchange', function(){ loadLatestAndRender(false); });
  document.addEventListener('DOMContentLoaded', function(){ loadLatestAndRender(false); });

  log('[VSP_GATE] loaded');
})();
