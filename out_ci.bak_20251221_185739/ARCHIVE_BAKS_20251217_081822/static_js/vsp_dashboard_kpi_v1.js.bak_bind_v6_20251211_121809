/**
 * VSP Dashboard KPI binder V5
 * Quét mọi element trong tab dashboard để bind KPI.
 */
(function () {
  const LOG = "[VSP][KPI_V5]";

  function formatNumber(n) {
    if (typeof n !== "number") n = Number(n || 0);
    if (!isFinite(n)) return "0";
    try {
      return n.toLocaleString("en-US");
    } catch (e) {
      return String(n);
    }
  }

  function findLabelNodes(upperMatch) {
    const root =
      document.querySelector("#vsp-tab-dashboard") || document.body;
    const all = root.querySelectorAll("*");
    const out = [];
    all.forEach((el) => {
      const t = (el.textContent || "").trim();
      if (!t) return;
      const u = t.toUpperCase();
      if (u.indexOf(upperMatch) !== -1) {
        out.push(el);
      }
    });
    return out;
  }

  function findValueNearLabel(labelEl) {
    if (!labelEl) return null;

    let container = labelEl.closest("div");
    if (!container) container = labelEl.parentElement;
    if (!container) return null;

    const cands = Array.from(container.querySelectorAll("*"));
    const labelText = (labelEl.textContent || "").trim();

    const good = cands.filter((el) => {
      if (el === labelEl) return false;
      const t = (el.textContent || "").trim();
      if (!t) return false;
      if (t === labelText) return false;
      if (t.startsWith("Δ vs")) return false;
      const u = t.toUpperCase();
      if (u.includes("NOISE SURFACE")) return false;
      if (u.includes("WEIGHTED BY")) return false;
      // '-' hoặc dạng số (kể cả '0 / 100')
      if (t === "-") return true;
      if (/^\d[\d,\s/]*$/.test(t)) return true;
      return false;
    });

    return good[0] || null;
  }

  function bindLabel(labelMatch, valueObj, formatter) {
    const upperMatch = labelMatch.toUpperCase();
    const labels = findLabelNodes(upperMatch);
    let bound = 0;

    labels.forEach((labelEl) => {
      const valueEl = findValueNearLabel(labelEl);
      if (!valueEl) return;
      const txt = formatter(valueObj);
      valueEl.textContent = txt;
      bound += 1;
    });

    console.log(LOG, "Bound", labelMatch, "x", bound, "->", valueObj);
  }

  function bindFromData(data) {
    if (!data || typeof data !== "object") return;

    const sev = data.severity_cards || {};
    const total = Number(data.total_findings || 0);
    const score =
      typeof data.security_posture_score === "number"
        ? data.security_posture_score
        : null;

    const topTool = data.top_risky_tool || null;
    const topCwe = data.top_impacted_cwe || null;
    const topModule = data.top_vulnerable_module || null;

    // TOTAL FINDINGS
    bindLabel("TOTAL FINDINGS", total, formatNumber);

    // Severity buckets
    bindLabel("CRITICAL", Number(sev.CRITICAL || 0), formatNumber);
    bindLabel("HIGH", Number(sev.HIGH || 0), formatNumber);
    bindLabel("MEDIUM", Number(sev.MEDIUM || 0), formatNumber);
    bindLabel("LOW", Number(sev.LOW || 0), formatNumber);

    // INFO + TRACE
    const infoTrace =
      Number(sev.INFO || 0) + Number(sev.TRACE || 0);
    bindLabel("INFO + TRACE", infoTrace, formatNumber);

    // SECURITY POSTURE SCORE
    bindLabel(
      "SECURITY POSTURE SCORE",
      score === null ? "N/A" : score,
      (v) => (v === "N/A" ? "N/A" : v + " / 100")
    );

    // TOP RISKY TOOL
    bindLabel(
      "TOP RISKY TOOL",
      topTool,
      (obj) => {
        if (!obj || !obj.label) return "N/A";
        const n = obj.crit_high || obj.count || 0;
        return obj.label + " (" + n + ")";
      }
    );

    // TOP IMPACTED CWE
    bindLabel(
      "TOP IMPACTED CWE",
      topCwe,
      (obj) => {
        if (!obj || !obj.label) return "N/A";
        const n = obj.count || 0;
        return obj.label + " (" + n + ")";
      }
    );

    // TOP VULNERABLE MODULE
    bindLabel(
      "TOP VULNERABLE MODULE",
      topModule,
      (obj) => {
        if (!obj || !obj.label) return "N/A";
        const n = obj.count || 0;
        return obj.label + " (" + n + ")";
      }
    );
  }

  async function loadDashboardKpi() {
    try {
      const res = await fetch("/api/vsp/dashboard_v3");
      if (!res.ok) {
        console.error(LOG, "HTTP", res.status);
        return;
      }
      const data = await res.json();
      console.log(LOG, "Dashboard data:", data);
      bindFromData(data);
    } catch (err) {
      console.error(LOG, "Error loading dashboard KPI:", err);
    }
  }

  document.addEventListener("DOMContentLoaded", function () {
    loadDashboardKpi();
  });

  window.vspReloadDashboardKPI = loadDashboardKpi;
})();
