(function () {
  console.log('[VSP_DASH] vsp_dashboard_enhance_v1.js loaded');

  function $(id) { return document.getElementById(id); }

  function fmtInt(n) {
    if (n == null || isNaN(n)) return '--';
    n = Number(n);
    if (!isFinite(n)) return '--';
    return n.toLocaleString('en-US');
  }

  function esc(s) {
    if (s == null) return '';
    return String(s)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;');
  }

  function getDashboardPane() {
    return document.querySelector('#vsp-tab-dashboard, #vsp-dashboard-main');
  }

  // ============ KPI ============

  



function applyKpiFromDashboard(data) {
  if (!data) return;
  var bySev = data.by_severity || {};

  var total = data.total_findings;
  var score = data.security_posture_score;
  var topTool = data.top_risky_tool;
  var topCwe = data.top_impacted_cwe;
  var topModule = data.top_vulnerable_module;

  // Chuẩn hóa object -> string
  if (topCwe && typeof topCwe === 'object') {
    topCwe = topCwe.cwe_id || topCwe.cwe || topCwe.id || topCwe.name || JSON.stringify(topCwe);
  }
  if (topModule && typeof topModule === 'object') {
    topModule = topModule.id || topModule.module || topModule.path || topModule.name || JSON.stringify(topModule);
  }

  function pickValueEl(root) {
    // ưu tiên các class “value”
    var el = root.querySelector('.vsp-kpi-value, .vsp-kpi-main-value, .vsp-kpi-number, .vsp-kpi-pill-value');
    if (el) return el;
    // fallback: span/div hiển thị '--' hoặc số
    var cands = root.querySelectorAll('span,div');
    for (var i = 0; i < cands.length; i++) {
      var t = (cands[i].textContent || '').trim();
      if (t === '--' || /^[0-9][0-9,.\s]*$/.test(t)) {
        return cands[i];
      }
    }
    return null;
  }

  function setValOnCard(card, value) {
    if (!card) return;
    var v = pickValueEl(card);
    if (!v) return;
    if (typeof value === 'number') {
      v.textContent = fmtInt(value);
    } else {
      v.textContent = (value != null && value !== '') ? String(value) : '--';
    }
  }

  function setIdIfExists(id, value) {
    var el = $(id);
    if (!el) return;
    if (typeof value === 'number') {
      el.textContent = fmtInt(value);
    } else {
      el.textContent = (value != null && value !== '') ? String(value) : '--';
    }
  }

  // === 1) Lấy tất cả KPI card theo thứ tự DOM ===
  var cards = document.querySelectorAll('#vsp-dashboard-main .vsp-kpi-card');
  cards = Array.prototype.slice.call(cards || []);

  // Kỳ vọng:
  // 0: TOTAL FINDINGS
  // 1: SECURITY SCORE
  // 2: TOP RISKY TOOL
  // 3: TOP IMPACTED CWE
  // 4: TOP VULNERABLE MODULE
  if (cards.length >= 1) setValOnCard(cards[0], total);
  if (cards.length >= 2) setValOnCard(cards[1], score);
  if (cards.length >= 3) setValOnCard(cards[2], topTool);
  if (cards.length >= 4) setValOnCard(cards[3], topCwe);
  if (cards.length >= 5) setValOnCard(cards[4], topModule);

  // === 2) 6 card severity tiếp theo: CRIT, HIGH, MED, LOW, INFO, TRACE ===
  var sevVals = [
    bySev.CRITICAL || 0,
    bySev.HIGH || 0,
    bySev.MEDIUM || 0,
    bySev.LOW || 0,
    bySev.INFO || 0,
    bySev.TRACE || 0
  ];
  for (var si = 0; si < 6; si++) {
    var idx = 5 + si; // bắt đầu sau 5 card trên
    if (cards.length > idx) {
      setValOnCard(cards[idx], sevVals[si]);
    }
  }

  // === 3) fallback: map thêm vào ID nếu tồn tại (ẩn/hiện) ===
  setIdIfExists('vsp-kpi-total-findings', total);
  setIdIfExists('vsp-kpi-score', score);
  setIdIfExists('vsp-kpi-top-tool', topTool);
  setIdIfExists('vsp-kpi-top-cwe', topCwe);
  setIdIfExists('vsp-kpi-top-module', topModule);

  setIdIfExists('vsp-kpi-sev-critical', bySev.CRITICAL || 0);
  setIdIfExists('vsp-kpi-sev-high', bySev.HIGH || 0);
  setIdIfExists('vsp-kpi-sev-medium', bySev.MEDIUM || 0);
  setIdIfExists('vsp-kpi-sev-low', bySev.LOW || 0);
  setIdIfExists('vsp-kpi-sev-info', bySev.INFO || 0);
  setIdIfExists('vsp-kpi-sev-trace', bySev.TRACE || 0);

  console.log('[VSP_DASH] KPI hydrated', {
    total: total,
    score: score,
    topTool: topTool,
    topCwe: topCwe,
    topModule: topModule,
    bySev: bySev
  });
}





  // ============ CHART HELPERS ============

  function renderSeverityChart(bySev) {
    var host = $('#vsp-chart-severity');
    if (!host) return;

    var order = ['CRITICAL', 'HIGH', 'MEDIUM', 'LOW', 'INFO', 'TRACE'];
    var max = 0;
    order.forEach(function (k) {
      var v = Number(bySev[k] || 0);
      if (v > max) max = v;
    });
    if (!max) max = 1;

    host.innerHTML = order.map(function (sev) {
      var val = Number(bySev[sev] || 0);
      var width = Math.max(4, (val / max) * 100);
      return '' +
        '<div class="vsp-chart-row">' +
          '<div class="vsp-chart-label">' + esc(sev) + '</div>' +
          '<div class="vsp-chart-bar-wrap">' +
            '<div class="vsp-chart-bar vsp-sev-' + sev.toLowerCase() + '" style="width:' + width + '%"></div>' +
          '</div>' +
          '<div class="vsp-chart-value">' + fmtInt(val) + '</div>' +
        '</div>';
    }).join('');
  }

  function renderTrendChart(items) {
    var host = $('#vsp-chart-trend');
    if (!host) return;

    items = Array.isArray(items) ? items.slice() : [];
    if (!items.length) {
      host.innerHTML = '<div class="vsp-chart-empty">Không có dữ liệu trend.</div>';
      return;
    }

    items.sort(function (a, b) {
      return String(a.created_at || a.finished_at || '').localeCompare(
        String(b.created_at || b.finished_at || '')
      );
    });

    var last = items.slice(-8);

    var max = 0;
    last.forEach(function (r) {
      var v = Number(r.total_findings || 0);
      if (v > max) max = v;
    });
    if (!max) max = 1;

    host.innerHTML = last.map(function (r) {
      var v = Number(r.total_findings || 0);
      var h = Math.max(6, (v / max) * 100);
      var label = (r.run_id || '').replace(/^RUN_/, '').slice(0, 10);
      return '' +
        '<div class="vsp-chart-col">' +
          '<div class="vsp-chart-col-bar" style="height:' + h + '%"></div>' +
          '<div class="vsp-chart-col-label" title="' + esc(r.run_id || '') + '">' + esc(label) + '</div>' +
          '<div class="vsp-chart-col-value">' + fmtInt(v) + '</div>' +
        '</div>';
    }).join('');
  }

  function renderToolChart(toolAgg) {
    var host = $('#vsp-chart-tool');
    if (!host) return;

    var tools = Object.keys(toolAgg);
    if (!tools.length) {
      host.innerHTML = '<div class="vsp-chart-empty">Không có dữ liệu tool.</div>';
      return;
    }

    tools.sort(function (a, b) {
      return (toolAgg[b] || 0) - (toolAgg[a] || 0);
    });
    var top = tools.slice(0, 5);
    var max = 0;
    top.forEach(function (t) { if (toolAgg[t] > max) max = toolAgg[t]; });
    if (!max) max = 1;

    host.innerHTML = top.map(function (t) {
      var v = toolAgg[t];
      var w = Math.max(4, (v / max) * 100);
      return '' +
        '<div class="vsp-chart-row">' +
          '<div class="vsp-chart-label">' + esc(t) + '</div>' +
          '<div class="vsp-chart-bar-wrap">' +
            '<div class="vsp-chart-bar" style="width:' + w + '%"></div>' +
          '</div>' +
          '<div class="vsp-chart-value">' + fmtInt(v) + '</div>' +
        '</div>';
    }).join('');
  }

  function renderCweChart(cweAgg) {
    var host = $('#vsp-chart-cwe');
    if (!host) return;

    var cwes = Object.keys(cweAgg);
    if (!cwes.length) {
      host.innerHTML = '<div class="vsp-chart-empty">Không có dữ liệu CWE.</div>';
      return;
    }

    cwes.sort(function (a, b) {
      return (cweAgg[b] || 0) - (cweAgg[a] || 0);
    });
    var top = cwes.slice(0, 5);
    var max = 0;
    top.forEach(function (c) { if (cweAgg[c] > max) max = cweAgg[c]; });
    if (!max) max = 1;

    host.innerHTML = top.map(function (c) {
      var v = cweAgg[c];
      var w = Math.max(4, (v / max) * 100);
      return '' +
        '<div class="vsp-chart-row">' +
          '<div class="vsp-chart-label">' + esc(c || 'N/A') + '</div>' +
          '<div class="vsp-chart-bar-wrap">' +
            '<div class="vsp-chart-bar" style="width:' + w + '%"></div>' +
          '</div>' +
          '<div class="vsp-chart-value">' + fmtInt(v) + '</div>' +
        '</div>';
    }).join('');
  }

  // ============ FETCH & HYDRATE ============

  async function hydrateDashboard() {
    var pane = getDashboardPane();
    if (!pane) {
      console.warn('[VSP_DASH] hydrateDashboard() no pane, skip');
      return;
    }

    console.log('[VSP_DASH] hydrateDashboard on', pane.id);

    // Dashboard KPIs
    try {
      var res = await fetch('/api/vsp/dashboard_v3', { cache: 'no-store' });
      var data = await res.json();
      applyKpiFromDashboard(data);
      renderSeverityChart(data.by_severity || {});
    } catch (e) {
      console.error('[VSP_DASH] dashboard_v3 error', e);
    }

    // Trend
    try {
      var res2 = await fetch('/api/vsp/runs_index_v3?limit=40', { cache: 'no-store' });
      var runs = await res2.json();
      renderTrendChart(runs.items || []);
    } catch (e) {
      console.error('[VSP_DASH] runs_index_v3 error', e);
    }

    // Tool & CWE charts từ datasource
    try {
      var res3 = await fetch('/api/vsp/datasource_v2?limit=2000', { cache: 'no-store' });
      var ds = await res3.json();
      var items = Array.isArray(ds.items) ? ds.items : (Array.isArray(ds) ? ds : []);
      var toolAgg = {};
      var cweAgg = {};

      items.forEach(function (f) {
        var sev = String(f.severity || f.raw_severity || '').toUpperCase();
        var weight =
          sev === 'CRITICAL' ? 4 :
          sev === 'HIGH' ? 3 :
          sev === 'MEDIUM' ? 2 :
          sev === 'LOW' ? 1 : 0.5;

        var tool = f.tool || f.source || 'unknown';
        toolAgg[tool] = (toolAgg[tool] || 0) + weight;

        var cwe = f.cwe || f.cwe_id || '';
        if (cwe) {
          cweAgg[cwe] = (cweAgg[cwe] || 0) + 1;
        }
      });

      renderToolChart(toolAgg);
      renderCweChart(cweAgg);
    } catch (e) {
      console.error('[VSP_DASH] datasource_v2 error', e);
    }
  }

  function waitAndHydrate() {
    var count = 0;
    var max = 40; // ~10s nếu 250ms
    var timer = setInterval(function () {
      var pane = getDashboardPane();
      if (pane) {
        clearInterval(timer);
        console.log('[VSP_DASH] Found dashboard pane:', pane.id);
        hydrateDashboard();
      } else {
        count += 1;
        if (count >= max) {
          clearInterval(timer);
          console.warn('[VSP_DASH] Timeout – không tìm thấy dashboard pane (#vsp-tab-dashboard hoặc #vsp-dashboard-main).');
        }
      }
    }, 250);
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', waitAndHydrate);
  } else {
    waitAndHydrate();
  }
})();
