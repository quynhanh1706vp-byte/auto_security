// static/js/vsp_runs_tab_simple_v2.js
// V2 – Runs & Reports: thêm cột CI/CD Gate (GREEN / AMBER / RED / N/A)

(function () {
  'use strict';

  if (window.VSP_RUNS_TAB_V2) return;
  window.VSP_RUNS_TAB_V2 = true;

  var LOG_PREFIX = '[VSP_RUNS]';
  var hasHydrated = false;

  function gateText(item) {
    var v = item.ci_gate_status || item.gate_status || item.ci_status;
    if (!v) return 'N/A';
    return String(v);
  }

  function gateClass(v) {
    if (!v) return '';
    var s = String(v).toUpperCase();
    if (s.indexOf('GREEN') !== -1 || s.indexOf('PASS') !== -1) return 'vsp-badge gate-green';
    if (s.indexOf('AMBER') !== -1 || s.indexOf('YELLOW') !== -1 || s.indexOf('WARN') !== -1) return 'vsp-badge gate-amber';
    if (s.indexOf('RED') !== -1 || s.indexOf('FAIL') !== -1) return 'vsp-badge gate-red';
    return 'vsp-badge';
  }

  function renderRuns(items) {
    var host = document.getElementById('vsp-runs-main');
    if (!host) {
      console.warn(LOG_PREFIX, 'Không thấy #vsp-runs-main');
      return;
    }

    if (!items || !items.length) {
      host.innerHTML = '<div class="vsp-empty">Chưa có run nào.</div>';
      return;
    }

    var html = '';
    html += '<div class="vsp-section-title">RUNS &amp; REPORTS</div>';
    html += '<div class="vsp-section-sub">Lịch sử scan mới nhất từ SECURITY_BUNDLE (runs_index_v3)</div>';
    html += '<div class="vsp-table-wrapper">';
    html += '<table class="vsp-table vsp-table-runs">';
    html += '<thead><tr>';
    html += '<th>RUN ID</th>';
    html += '<th>TYPE</th>';
    html += '<th>STARTED</th>';
    html += '<th class="align-right">TOTAL FINDINGS</th>';
    html += '<th>CI/CD GATE</th>';
    html += '<th>STATUS</th>';
    html += '</tr></thead><tbody>';

    items.forEach(function (it) {
      var runId = it.run_id || it.id || '';
      var kind = it.kind || it.type || 'UNKNOWN';
      var started = it.started_at || it.created_at || '';
      var total = (it.total_findings != null ? it.total_findings : '');
      var status = it.status || 'DONE';

      var gate = gateText(it);
      var gateCls = gateClass(gate);

      html += '<tr>';
      html += '<td class="vsp-mono">' + runId + '</td>';
      html += '<td>' + kind + '</td>';
      html += '<td>' + started + '</td>';
      html += '<td class="align-right">' + total + '</td>';
      html += '<td><span class="' + gateCls + '">' + gate + '</span></td>';
      html += '<td><span class="vsp-badge status-' + String(status).toLowerCase() + '">' + status + '</span></td>';
      html += '</tr>';
    });

    html += '</tbody></table></div>';

    host.innerHTML = html;
  }

  function hydrateRunsTab() {
    if (hasHydrated) return;
    hasHydrated = true;

    console.log(LOG_PREFIX, 'Hydrating Runs tab (v2)...');

    fetch('/api/vsp/runs_index_v3?limit=40', { cache: 'no-store' })
      .then(function (res) { return res.json(); })
      .then(function (data) {
        var items = data.items || data.runs || [];
        renderRuns(items);
      })
      .catch(function (err) {
        console.error(LOG_PREFIX, 'Error loading runs_index_v3:', err);
      });
  }

  // Khi tab Runs được mở lần đầu
  document.addEventListener('DOMContentLoaded', function () {
    if (window.location.hash === '#runs') {
      hydrateRunsTab();
    }
  });

  window.addEventListener('hashchange', function () {
    if (window.location.hash === '#runs') {
      hydrateRunsTab();
    }
  });
})();
