(function () {
  console.log('[VSP_RULES_TAB] vsp_rules_tab_simple_v1.js loaded');

  const TAB_HASH = 'rules';
  const TAB_ID = 'vsp-tab-rules';

  function $(id) { return document.getElementById(id); }

  async function fetchRules() {
    const res = await fetch('/api/vsp/rule_overrides_ui_v1');
    if (!res.ok) throw new Error('HTTP ' + res.status);
    return await res.json();
  }

  function render(container, data) {
    const pretty = JSON.stringify(data, null, 2);
    container.innerHTML = `
      <div style="padding:16px 16px 8px 16px;">
        <div style="font-size:12px; text-transform:uppercase; letter-spacing:0.08em; opacity:0.7; margin-bottom:4px;">
          Rule Overrides
        </div>
        <div style="font-size:12px; opacity:0.7; margin-bottom:12px;">
          Mapping / override rule (rule_overrides_ui_v1)
        </div>
      </div>
      <div style="padding:0 16px 16px 16px;">
        <pre style="
          margin:0;
          padding:16px;
          border-radius:10px;
          border:1px solid rgba(148,163,184,0.25);
          background:rgba(15,23,42,0.96);
          font-size:11px;
          line-height:1.4;
          overflow:auto;
          color:#e5e7eb;
        ">${pretty}</pre>
      </div>
    `;
  }

  let loaded = false;

  async function hydrateTab() {
    const container = $(TAB_ID);
    if (!container) {
      console.warn('[VSP_RULES_TAB] Không thấy #' + TAB_ID);
      return;
    }
    if (loaded) return;
    loaded = true;

    container.innerHTML = `
      <div style="padding:16px; font-size:12px; opacity:0.7;">
        Đang tải rule overrides từ <code>/api/vsp/rule_overrides_ui_v1</code>...
      </div>
    `;
    try {
      const data = await fetchRules();
      render(container, data);
      console.log('[VSP_RULES_TAB] Hydrated rules tab');
    } catch (e) {
      console.error('[VSP_RULES_TAB] Lỗi khi load rule_overrides_ui_v1', e);
      container.innerHTML = `
        <div style="padding:16px; font-size:12px; color:#fecaca;">
          Lỗi khi tải rule_overrides_ui_v1: ${e}
        </div>
      `;
    }
  }

  function onHashChange() {
    const h = (window.location.hash || '').replace('#', '') || 'dashboard';
    if (h === TAB_HASH) {
      hydrateTab();
    }
  }

  function init() {
    window.addEventListener('hashchange', onHashChange);
    onHashChange();
  }

  if (document.readyState === 'complete' || document.readyState === 'interactive') {
    init();
  } else {
    document.addEventListener('DOMContentLoaded', init);
  }
})();
