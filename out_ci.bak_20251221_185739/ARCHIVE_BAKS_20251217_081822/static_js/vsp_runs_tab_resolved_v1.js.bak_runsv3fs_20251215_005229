/* vsp_runs_tab_resolved_v1.js
 * Commercial wiring: Runs tab uses /api/vsp/runs_index_v3_fs_resolved_v4_v4
 * - Shows: RID + rid_norm + ci_run_dir
 * - Links: status_v2, artifacts_index, report/summary_unified.json, report/findings_unified.json
 */
(function () {
  'use strict';

  var ENDPOINT = '/api/vsp/runs_index_v3_fs_resolved_v4_v4?limit=50&hide_empty=0&filter=1';

  function log() { try { console.log.apply(console, arguments); } catch (e) {} }
  function esc(s) {
    return String(s == null ? '' : s)
      .replace(/&/g, '&amp;').replace(/</g, '&lt;')
      .replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
  }
  function pickRunsPane() {
    return (
      document.getElementById('vsp-runs-main') ||
      document.getElementById('vsp-runs') ||
      document.querySelector('[data-vsp-pane="runs"]') ||
      document.querySelector('#pane-runs') ||
      document.querySelector('#tab-runs') ||
      document.querySelector('.vsp-pane-runs') ||
      // fallback: any pane that mentions "Runs"
      Array.from(document.querySelectorAll('div,section,main')).find(function (el) {
        var id = (el.id || '').toLowerCase();
        return id.includes('runs') && id.includes('vsp');
      }) ||
      null
    );
  }

  function mkLink(href, label) {
    return '<a class="vsp-btn vsp-btn-soft" target="_blank" rel="noopener" href="' + esc(href) + '">' + esc(label) + '</a>';
  }

  function rowActions(rid) {
    var base = '/api/vsp';
    var status = base + '/run_status_v2/' + encodeURIComponent(rid);
    var artIdx = base + '/run_artifacts_index_v1/' + encodeURIComponent(rid);
    var summary = base + '/run_artifact_v2/' + encodeURIComponent(rid) + '?path=' + encodeURIComponent('report/summary_unified.json');
    var findings = base + '/run_artifact_v2/' + encodeURIComponent(rid) + '?path=' + encodeURIComponent('report/findings_unified.json');
    return [
      mkLink(status, 'status_v2'),
      mkLink(artIdx, 'artifacts'),
      mkLink(summary, 'summary'),
      mkLink(findings, 'findings')
    ].join(' ');
  }

  function render(pane, items) {
    var html = '';
    html += '<div class="vsp-card" style="margin:12px 0; padding:14px;">';
    html += '  <div style="display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;">';
    html += '    <div>';
    html += '      <div style="font-weight:700; font-size:16px;">Runs & Reports (resolved)</div>';
    html += '      <div style="opacity:.75; font-size:12px;">Source: <code>' + esc(ENDPOINT) + '</code></div>';
    html += '    </div>';
    html += '    <div style="display:flex; gap:10px; align-items:center;">';
    html += '      <input id="vsp-runs-q" placeholder="filter by RID / rid_norm / target / profile..." ';
    html += '        style="min-width:320px; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.08); background:rgba(255,255,255,.03); color:inherit;">';
    html += '      <button id="vsp-runs-refresh" class="vsp-btn vsp-btn-primary" style="padding:10px 14px;">Refresh</button>';
    html += '    </div>';
    html += '  </div>';
    html += '</div>';

    html += '<div class="vsp-card" style="padding:0; overflow:auto;">';
    html += '<table style="width:100%; border-collapse:collapse;">';
    html += '  <thead>';
    html += '    <tr style="text-align:left; font-size:12px; opacity:.85;">';
    html += '      <th style="padding:12px 14px; border-bottom:1px solid rgba(255,255,255,.06);">Created</th>';
    html += '      <th style="padding:12px 14px; border-bottom:1px solid rgba(255,255,255,.06);">RID</th>';
    html += '      <th style="padding:12px 14px; border-bottom:1px solid rgba(255,255,255,.06);">rid_norm</th>';
    html += '      <th style="padding:12px 14px; border-bottom:1px solid rgba(255,255,255,.06);">Profile</th>';
    html += '      <th style="padding:12px 14px; border-bottom:1px solid rgba(255,255,255,.06);">Target</th>';
    html += '      <th style="padding:12px 14px; border-bottom:1px solid rgba(255,255,255,.06);">CI run dir</th>';
    html += '      <th style="padding:12px 14px; border-bottom:1px solid rgba(255,255,255,.06);">Degraded</th>';
    html += '      <th style="padding:12px 14px; border-bottom:1px solid rgba(255,255,255,.06);">Links</th>';
    html += '    </tr>';
    html += '  </thead>';
    html += '  <tbody id="vsp-runs-body"></tbody>';
    html += '</table>';
    html += '</div>';

    pane.innerHTML = html;

    function applyFilter(q) {
      q = (q || '').toLowerCase().trim();
      var tb = document.getElementById('vsp-runs-body');
      if (!tb) return;

      var filtered = items.filter(function (it) {
        if (!q) return true;
        var hay = [
          it.created_at, it.run_id, it.req_id, it.request_id, it.rid_norm,
          it.profile, it.target, it.ci_run_dir
        ].join(' ').toLowerCase();
        return hay.indexOf(q) >= 0;
      });

      tb.innerHTML = filtered.map(function (it) {
        var rid = it.run_id || it.request_id || it.req_id || '';
        var degradedN = 0;
        if (Array.isArray(it.degraded_tools)) degradedN = it.degraded_tools.length;
        if (typeof it.degraded_n === 'number') degradedN = it.degraded_n;

        return '' +
          '<tr style="border-bottom:1px solid rgba(255,255,255,.06); font-size:13px;">' +
          '  <td style="padding:12px 14px; white-space:nowrap; opacity:.85;">' + esc(it.created_at || '') + '</td>' +
          '  <td style="padding:12px 14px; font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;">' + esc(rid) + '</td>' +
          '  <td style="padding:12px 14px; font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; opacity:.85;">' + esc(it.rid_norm || '') + '</td>' +
          '  <td style="padding:12px 14px;">' + esc(it.profile || '') + '</td>' +
          '  <td style="padding:12px 14px; max-width:280px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">' + esc(it.target || '') + '</td>' +
          '  <td style="padding:12px 14px; max-width:520px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; opacity:.85;">' + esc(it.ci_run_dir || '') + '</td>' +
          '  <td style="padding:12px 14px; white-space:nowrap;">' + esc(degradedN) + '</td>' +
          '  <td style="padding:12px 14px; white-space:nowrap;">' + rowActions(rid) + '</td>' +
          '</tr>';
      }).join('');
    }

    var qEl = document.getElementById('vsp-runs-q');
    var rEl = document.getElementById('vsp-runs-refresh');
    if (qEl) qEl.addEventListener('input', function () { applyFilter(qEl.value); });
    if (rEl) rEl.addEventListener('click', function () { window.VSP_RUNS_RESOLVED_REFRESH && window.VSP_RUNS_RESOLVED_REFRESH(); });

    applyFilter('');
  }

  function loadAndRender(force) {
    var pane = pickRunsPane();
    if (!pane) { log('[VSP_RUNS_RESOLVED] runs pane not found -> skip'); return; }

    // Only refresh when runs tab active, unless forced
    var hash = (location.hash || '').toLowerCase();
    if (!force && hash && !hash.includes('runs') && !hash.includes('reports')) return;

    pane.innerHTML = '<div class="vsp-card" style="margin:12px 0; padding:14px;">Loading runs (resolved)â€¦</div>';

    fetch(ENDPOINT, { credentials: 'same-origin' })
      .then(function (r) { return r.json(); })
      .then(function (j) {
        var items = (j && j.items) ? j.items : [];
        render(pane, items);
        log('[VSP_RUNS_RESOLVED] loaded items=', items.length);
      })
      .catch(function (e) {
        pane.innerHTML = '<div class="vsp-card" style="margin:12px 0; padding:14px;">' +
          '<div style="font-weight:700;">Runs load failed</div>' +
          '<pre style="white-space:pre-wrap; opacity:.85; font-size:12px;">' + esc(String(e && e.stack ? e.stack : e)) + '</pre>' +
          '</div>';
      });
  }

  window.VSP_RUNS_RESOLVED_REFRESH = function () { loadAndRender(true); };

  // Hook hash router
  window.addEventListener('hashchange', function () { loadAndRender(false); });
  document.addEventListener('DOMContentLoaded', function () { loadAndRender(false); });

  log('[VSP_RUNS_RESOLVED] loaded');
})();
