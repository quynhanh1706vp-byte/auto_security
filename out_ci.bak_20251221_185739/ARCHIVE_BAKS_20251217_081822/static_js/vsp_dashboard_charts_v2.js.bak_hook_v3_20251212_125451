// static/js/vsp_dashboard_charts_v2.js
// V3 – 4 chart Dashboard: severity, trend, by tool, top CWE (dùng trực tiếp dashboard_v3)

(function () {
  'use strict';

  if (window.VSP_DASH_CHARTS && window.VSP_DASH_CHARTS.__V3) return;

  var LOG_PREFIX = '[VSP_CHARTS]';

  var charts = {
    __V3: true,
    severity: null,
    trend: null,
    byTool: null,
    topCwe: null
  };

  function ensureCanvas(id) {
    var host = document.getElementById(id);
    if (!host) {
      console.warn(LOG_PREFIX, 'Không thấy container', id);
      return null;
    }
    if (host.tagName.toLowerCase() === 'canvas') {
      return host.getContext('2d');
    }
    if (!host.querySelector('canvas')) {
      host.innerHTML = '<canvas style="width:100%;height:100%"></canvas>';
    }
    var canvas = host.querySelector('canvas');
    return canvas.getContext('2d');
  }

  // === Severity donut ===
  function buildSeverityDataset(bySeverity) {
    var labels = ['CRITICAL','HIGH','MEDIUM','LOW','INFO','TRACE'];
    var data = labels.map(function (k) {
      var v = bySeverity && bySeverity[k];
      if (typeof v === 'object' && v && v.count != null) return v.count;
      return v || 0;
    });
    return { labels: labels, data: data };
  }

  function renderSeverity(bySeverity) {
    var ctx = ensureCanvas('vsp-chart-severity');
    if (!ctx || !bySeverity) return;
    var ds = buildSeverityDataset(bySeverity);

    if (charts.severity) {
      charts.severity.data.labels = ds.labels;
      charts.severity.data.datasets[0].data = ds.data;
      charts.severity.update();
      return;
    }

    charts.severity = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: ds.labels,
        datasets: [{
          label: 'Findings by Severity',
          data: ds.data
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { position: 'bottom' }
        },
        cutout: '60%'
      }
    });
  }

  // === Trend line ===
  function renderTrend(trend) {
    var ctx = ensureCanvas('vsp-chart-trend');
    if (!ctx || !trend || !trend.length) return;

    var labels = trend.map(function (r) { return r.started_at || r.run_id; });
    var data = trend.map(function (r) { return r.total_findings || 0; });

    if (charts.trend) {
      charts.trend.data.labels = labels;
      charts.trend.data.datasets[0].data = data;
      charts.trend.update();
      return;
    }

    charts.trend = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: 'Total Findings per Run',
          data: data,
          fill: false
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
          y: { beginAtZero: true }
        }
      }
    });
  }

  // === Critical / High by Tool ===
  function renderByTool(byTool) {
    var ctx = ensureCanvas('vsp-chart-by-tool');
    if (!ctx || !byTool) return;

    var labels = Object.keys(byTool);
    if (!labels.length) return;

    var data = labels.map(function (k) {
      var v = byTool[k];

      // Dạng có by_severity
      if (v && typeof v === 'object') {
        if (v.by_severity) {
          var s = v.by_severity;
          var ch = (s.CRITICAL || 0) + (s.HIGH || 0);
          if (ch > 0) return ch;
        }
        // fallback: dùng total nếu có
        if (v.total != null) return v.total;
      }

      // Dạng số thô
      if (typeof v === 'number') return v;

      return 0;
    });

    if (charts.byTool) {
      charts.byTool.data.labels = labels;
      charts.byTool.data.datasets[0].data = data;
      charts.byTool.update();
      return;
    }

    charts.byTool = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Critical + High findings by tool',
          data: data
        }]
      },
      options: {
        responsive: true,
        indexAxis: 'y',
        plugins: { legend: { display: false } }
      }
    });
  }

  // === Top CWE bar chart ===
  function renderTopCwe(topCweList) {
    var ctx = ensureCanvas('vsp-chart-top-cwe');
    if (!ctx || !topCweList || !topCweList.length) return;

    var labels = topCweList.map(function (x) { return x.cwe || 'N/A'; });
    var data = topCweList.map(function (x) { return x.count || 0; });

    if (charts.topCwe) {
      charts.topCwe.data.labels = labels;
      charts.topCwe.data.datasets[0].data = data;
      charts.topCwe.update();
      return;
    }

    charts.topCwe = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Top CWE',
          data: data
        }]
      },
      options: {
        responsive: true,
        indexAxis: 'y',
        plugins: { legend: { display: false } }
      }
    });
  }

  charts.updateFromDashboard = function (data) {
    if (!data) return;
    if (!window.Chart) {
      console.warn(LOG_PREFIX, 'Chart.js chưa được load, bỏ qua charts.');
      return;
    }

    console.log(LOG_PREFIX, 'updateFromDashboard – render charts với dữ liệu:', data);

    renderSeverity(data.by_severity || data.severity_cards);
    renderTrend(data.trend_by_run || []);
    renderByTool(data.by_tool || {});
    renderTopCwe(data.top_cwe_list || []);
  };

  console.log(LOG_PREFIX, 'vsp_dashboard_charts_v2.js (V3) loaded');
  window.VSP_DASH_CHARTS = charts;
})();
