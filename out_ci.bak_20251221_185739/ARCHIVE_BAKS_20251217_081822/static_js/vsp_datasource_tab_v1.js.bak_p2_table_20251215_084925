/* vsp_datasource_tab_v1.js
 * Commercial Data Source tab:
 * - calls /api/vsp/run_findings_preview_v1/<RID>?limit=&offset=&tool=&severity=&q=
 * - renders table, no console spam
 */
(function(){
  const $ = (s)=>document.querySelector(s);
  const esc = (s)=>String(s??"").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));

  function showPane(){
    const pane = $("#vsp-pane-datasource");
    if(!pane) return false;
    // if router hides panes elsewhere, we just ensure ours visible when hash matches
    const h = (location.hash||"").replace("#","").trim().toLowerCase();
    if(h === "datasource"){
      pane.style.display = "";
    }
    return true;
  }

  async function load(offset){
    const pane = $("#vsp-pane-datasource");
    if(!pane) return;

    const rid = ($("#vsp-ds-rid")?.value||"").trim();
    const tool = ($("#vsp-ds-tool")?.value||"").trim();
    const sev  = ($("#vsp-ds-sev")?.value||"").trim();
    const q    = ($("#vsp-ds-q")?.value||"").trim();

    const meta = $("#vsp-ds-meta");
    const tb   = $("#vsp-ds-tbody");
    if(!rid){
      if(meta) meta.textContent = "Run ID is required.";
      if(tb) tb.innerHTML = "";
      return;
    }

    const limit = 50;
    const off = Math.max(0, Number(offset||0));
    const qs = new URLSearchParams({limit:String(limit), offset:String(off)});
    if(tool) qs.set("tool", tool);
    if(sev)  qs.set("severity", sev);
    if(q)    qs.set("q", q);

    const url = `/api/vsp/run_findings_preview_v1/${encodeURIComponent(rid)}?` + qs.toString();
    if(meta) meta.textContent = "Loading…";

    try{
      const r = await fetch(url, {cache:"no-store"});
      const j = await r.json().catch(()=>null);
      if(!j || !j.ok){
        if(meta) meta.textContent = `Not ready (${r.status})`;
        if(tb) tb.innerHTML = "";
        return;
      }

      const total = j.total ?? 0;
      const has = !!j.has_findings;
      const file = j.file || null;
      const warn = j.warning || null;
      const lim = j.limit ?? limit;
      const curOff = j.offset ?? off;

      if(meta){
        meta.textContent =
          `RID=${rid} • total=${total} • showing ${curOff+1}-${Math.min(curOff+lim,total)} • ` +
          (has ? "has_findings=YES" : "has_findings=NO") +
          (warn ? ` • warning=${warn}` : "") +
          (file ? ` • file=${file}` : "");
      }

      const items = Array.isArray(j.items) ? j.items : [];
      if(tb){
        tb.innerHTML = items.map(it=>{
          const tool2 = esc(it.tool||"");
          const sev2  = esc(it.severity||"");
          const title = esc(it.title||"");
          const file2 = esc(it.file||"");
          const line  = esc(it.line||"");
          const rule  = esc(it.rule_id||"");
          return `<tr>
            <td style="padding:10px; border-bottom:1px solid rgba(255,255,255,.06);">${tool2}</td>
            <td style="padding:10px; border-bottom:1px solid rgba(255,255,255,.06);">${sev2}</td>
            <td style="padding:10px; border-bottom:1px solid rgba(255,255,255,.06);">${title}</td>
            <td style="padding:10px; border-bottom:1px solid rgba(255,255,255,.06);">${file2}</td>
            <td style="padding:10px; border-bottom:1px solid rgba(255,255,255,.06);">${line}</td>
            <td style="padding:10px; border-bottom:1px solid rgba(255,255,255,.06);">${rule}</td>
          </tr>`;
        }).join("");
      }

      // remember for Next
      pane.dataset.vspDsOffset = String(curOff);
      pane.dataset.vspDsTotal  = String(total);
      pane.dataset.vspDsLimit  = String(lim);

    }catch(_e){
      if(meta) meta.textContent = "Load failed (network).";
      if(tb) tb.innerHTML = "";
    }
  }

  function bind(){
    const btn = $("#vsp-ds-load");
    const nxt = $("#vsp-ds-next");
    if(btn) btn.addEventListener("click", ()=>load(0));
    if(nxt) nxt.addEventListener("click", ()=>{
      const pane = $("#vsp-pane-datasource");
      const off = Number(pane?.dataset?.vspDsOffset||"0");
      const lim = Number(pane?.dataset?.vspDsLimit||"50");
      load(off + lim);
    });
  }

  function boot(){
    if(!showPane()) return;
    bind();
  }

  window.addEventListener("hashchange", ()=>{ showPane(); });
  document.addEventListener("DOMContentLoaded", boot);
})();


// === VSP_DS_DRILLDOWN_SINK_V1_FOR_TAB_V1 ===
(function(){
  const KEY = "vsp_ds_drill_url_v1";

  function pane(){
    return document.getElementById("vsp-pane-datasource") || document.body;
  }

  function ensureBox(){
    let box = document.getElementById("vsp_ds_drill_box_v1");
    if(!box){
      box = document.createElement("div");
      box.id = "vsp_ds_drill_box_v1";
      box.style.marginTop = "10px";
      box.style.padding = "10px";
      box.style.borderRadius = "14px";
      box.style.border = "1px solid rgba(255,255,255,.10)";
      box.style.background = "rgba(0,0,0,.25)";
      box.innerHTML = `
        <div style="display:flex;gap:10px;align-items:center;justify-content:space-between;">
          <div style="font-weight:700;letter-spacing:.2px;">Drill Result</div>
          <button id="vsp_ds_drill_clear_v1" style="padding:6px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);color:#fff;cursor:pointer;">Clear</button>
        </div>
        <div id="vsp_ds_drill_url_v1" style="opacity:.7;font-size:12px;margin-top:6px;word-break:break-all;"></div>
        <pre id="vsp_ds_drill_pre_v1" style="white-space:pre-wrap;word-break:break-word;font-size:12px;line-height:1.35;margin:10px 0 0 0;"></pre>
      `;
      // insert near top of datasource pane
      const p = pane();
      p.insertBefore(box, p.children[1] || null);
      document.getElementById("vsp_ds_drill_clear_v1").onclick = ()=>{
        try{ sessionStorage.removeItem(KEY); }catch(e){}
        document.getElementById("vsp_ds_drill_url_v1").textContent = "";
        document.getElementById("vsp_ds_drill_pre_v1").textContent = "";
      };
    }
    return box;
  }

  async function renderFromUrl(url){
    if(!url) return;
    ensureBox();
    const urlEl = document.getElementById("vsp_ds_drill_url_v1");
    const preEl = document.getElementById("vsp_ds_drill_pre_v1");
    urlEl.textContent = url;
    preEl.textContent = "Loading…";

    try{
      const r = await fetch(url, {credentials:"same-origin"});
      const ct = (r.headers.get("content-type")||"").toLowerCase();
      if(!ct.includes("application/json")){
        const tx = await r.text();
        preEl.textContent = "Non-JSON response\n\n" + tx.slice(0, 6000);
        return;
      }
      const j = await r.json();
      preEl.textContent = JSON.stringify(j, null, 2);
    }catch(e){
      preEl.textContent = "ERR: " + String(e);
    }
  }

  // API for dashboard to call
  window.VSP_DS_APPLY_DRILL_URL_V1 = function(url){
    try{ sessionStorage.setItem(KEY, url); }catch(e){}
    renderFromUrl(url);
  };

  function autoApplyIfDatasource(){
    const h = String(location.hash||"");
    if(!h.toLowerCase().includes("datasource")) return;
    let url=null;
    try{ url = sessionStorage.getItem(KEY); }catch(e){}
    if(url) setTimeout(()=>renderFromUrl(url), 200);
  }

  window.addEventListener("load", autoApplyIfDatasource);
  window.addEventListener("hashchange", autoApplyIfDatasource);
})();
