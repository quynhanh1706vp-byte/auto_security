/* P0_CHARTS_FALLBACK_V1 */
(function(){
  try{
    if (typeof window === "undefined") return;
    if (typeof window.__VSP_P0_CHARTS_FALLBACK === "function") return;

    window.__VSP_P0_CHARTS_FALLBACK = function(reason){
      try{
        var sel = ["#vsp-charts-root","#vsp-dashboard-charts","#vsp-dash-charts",".vsp-charts",".vsp-dashboard-charts"];
        var host = null;
        for (var i=0;i<sel.length;i++){
          var el = document.querySelector(sel[i]);
          if (el) { host = el; break; }
        }
        if (!host) return;
        if (host.querySelector(".vsp-p0-charts-fallback")) return;

        var d = document.createElement("div");
        d.className = "vsp-p0-charts-fallback";
        d.style.cssText = "margin-top:10px;padding:10px;border:1px dashed rgba(255,255,255,.18);border-radius:10px;background:rgba(0,0,0,.18);font-size:12px;opacity:.9";
        d.textContent = "Charts unavailable (degraded): " + (reason || "missing data/engine");
        host.appendChild(d);
      }catch(_){}
    };
  }catch(_){}
})();

/* P0_CHARTS_SKIP_NON_DASH_V1 */
(function(){
  try{
    const h = (location.hash || "").toLowerCase();
    if (h && h !== "#" && h !== "#dashboard") {
      try{ console.info("[VSP_CHARTS_BOOT][P0] skip (non-dashboard) hash=", h); }catch(_){}
      return;
    }
  }catch(_){}
})();

// vsp_dashboard_charts_bootstrap_v1.js (SAFE overwrite)
// - No recursion, no call-stack overflow
// - Init once when both engine + dashboard data are available
// - Retry bounded with setTimeout

(function(){
  if (window.__VSP_CHARTS_BOOT_SAFE_V2) return;
  window.__VSP_CHARTS_BOOT_SAFE_V2 = true;

  var tries = 0;
  var MAX_TRIES = 20;
  var DONE = false;

  function pickEngine(){
    return window.VSP_CHARTS_ENGINE_V3 || window.VSP_CHARTS_ENGINE_V2 || window.VSP_CHARTS_ENGINE || null;
  }
  function pickData(){
    return window.__VSP_DASH_LAST_DATA_V3 || window.__VSP_DASH_LAST_DATA || window.__VSP_DASH_LAST_DATA_ANY || null;
  }

  function attempt(tag){
    if (DONE) return true;
    var eng = pickEngine();
    var data = pickData();
    if (!eng || !eng.initAll || !data) return false;
    try{
      var ok = eng.initAll(data);
      DONE = true;
      console.log('[VSP_CHARTS_BOOT_SAFE_V2] initAll OK via', tag, 'engine=', (eng===window.VSP_CHARTS_ENGINE_V3?'V3':'OTHER'));
      return !!ok;
    }catch(e){
      console.warn('[VSP_CHARTS_BOOT_SAFE_V2] initAll failed', e);
      return false;
    }
  }

  function schedule(){
    if (DONE) return;
    if (tries++ >= MAX_TRIES) {
      console.warn('[VSP_CHARTS_BOOT_SAFE_V2] give up after', MAX_TRIES, 'tries');
      try{ if(window.__VSP_P0_CHARTS_FALLBACK) window.__VSP_P0_CHARTS_FALLBACK('give_up'); }catch(_){ }
return;
    }
    setTimeout(function(){
      if (attempt('retry#'+tries)) return;
      schedule();
    }, 200);
  }

  window.addEventListener('vsp:charts-ready', function(){
    attempt('charts-ready');
  });

  window.addEventListener('DOMContentLoaded', function(){
    if (!attempt('domcontentloaded')) schedule();
  });

  // immediate best-effort
  if (!attempt('immediate')) schedule();

})();
