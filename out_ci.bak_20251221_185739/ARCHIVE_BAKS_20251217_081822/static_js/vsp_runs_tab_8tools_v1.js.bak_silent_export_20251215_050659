/* vsp_runs_tab_8tools_v1.js (drawer quicklinks v1)
 * - Runs table (8 tools) using status_v2.run_gate_summary.by_tool
 * - Drawer: Quick Links (artifact_open rel=...), Export buttons, by_tool table, degraded_tools, artifacts_index JSON
 */
(function(){
  const RUNS_INDEX_URL = "/api/vsp/runs_index_v3_fs_resolved?limit=50&hide_empty=0&filter=1";
  const STATUS_V2_URL  = (rid) => `/api/vsp/run_status_v2/${encodeURIComponent(rid)}`;
  const ARTIFACTS_URL  = (rid) => `/api/vsp/run_artifacts_index_v1/${encodeURIComponent(rid)}`;
  const EXPORT_URL     = (rid, fmt) => `/api/vsp/run_export_v3/${encodeURIComponent(rid)}?fmt=${encodeURIComponent(fmt)}`;
  const ART_OPEN_URL   = (rid, rel) => `/api/vsp/run_artifact_open_v1/${encodeURIComponent(rid)}?rel=${encodeURIComponent(rel)}`;

  const TOOLS_A = ["SEMGREP","TRIVY","KICS","GITLEAKS"];
  const TOOLS_B = ["CODEQL","BANDIT","SYFT","GRYPE"];
  const TOOLS_ALL = [...TOOLS_A, ...TOOLS_B];

  // Common commercial artifact rel paths (best-effort)
  const COMMON_LINKS = [
    {label:"Report HTML", rel:"reports/vsp_run_report_cio_v3.html"},
    {label:"Report ZIP",  rel:"reports/report.zip"},
    {label:"Runner Log",  rel:"runner.log"},
    {label:"SUMMARY.txt", rel:"SUMMARY.txt"},
    {label:"Findings JSON", rel:"findings_unified.json"},
    {label:"Findings CSV",  rel:"findings_unified.csv"},
    {label:"Findings SARIF",rel:"findings_unified.sarif"},
    {label:"CodeQL JS SARIF", rel:"codeql/codeql_js.sarif"},
    {label:"CodeQL PY SARIF", rel:"codeql/codeql_py.sarif"},
    {label:"KICS raw", rel:"kics/kics.json"},
    {label:"Semgrep raw", rel:"semgrep/semgrep.json"},
    {label:"Trivy raw", rel:"trivy/trivy.json"},
    {label:"Gitleaks raw", rel:"gitleaks/gitleaks.json"},
  ];

  function normVerdict(v){
    if(!v) return "NOT_RUN";
    const s = String(v).toUpperCase();
    if (["PASS","OK","SUCCESS","GREEN"].includes(s)) return "GREEN";
    if (["FAIL","ERROR","RED"].includes(s)) return "RED";
    if (["WARN","WARNING","AMBER","YELLOW"].includes(s)) return "AMBER";
    if (["NOT_RUN","NOTRUN","SKIP","SKIPPED"].includes(s)) return "NOT_RUN";
    if (["DISABLED"].includes(s)) return "DISABLED";
    if (["DEGRADED"].includes(s)) return "DEGRADED";
    return s;
  }

  function pickTool(status, tool){
    const byTool = status?.run_gate_summary?.by_tool || {};
    const o = byTool?.[tool] || byTool?.[tool.toLowerCase()] || null;
    const verdict = normVerdict(o?.verdict || o?.overall || o?.status || null);
    const total = (o?.total ?? o?.findings_total ?? o?.count ?? o?.n ?? 0);
    return { verdict, total };
  }

  function badgeHtml(label, verdict, extra){
    const v = normVerdict(verdict);
    const x = (extra === null || extra === undefined) ? "" : ` (${extra})`;
    return `<span class="vsp-badge vsp-badge-${v}" title="${label}: ${v}${x}">${label}:${v}${x}</span>`;
  }

  async function fetchJson(url){
    const r = await fetch(url, { cache:"no-store" });
    const j = await r.json().catch(()=>null);
    if(!r.ok) throw new Error(`HTTP ${r.status}`);
    return j;
  }

  async function headOk(url){
    try{
      const r = await fetch(url, { method:"HEAD", cache:"no-store" });
      return r.ok;
    }catch(e){
      return false;
    }
  }

  function ensureStyles(){
    if (document.getElementById("vspRuns8ToolsStyles")) return;
    const css = document.createElement("style");
    css.id = "vspRuns8ToolsStyles";
    css.textContent = `
      .vsp-runs8-wrap{ padding:12px; }
      .vsp-runs8-title{ font-weight:780; font-size:14px; margin:6px 0 10px; opacity:0.95; }
      .vsp-runs8-table{ width:100%; border-collapse:collapse; font-size:12px; }
      .vsp-runs8-table th,.vsp-runs8-table td{ border-bottom:1px solid rgba(255,255,255,0.08); padding:10px 8px; vertical-align:top; }
      .vsp-runs8-table th{ text-transform:uppercase; font-size:11px; letter-spacing:.06em; opacity:.8; }
      .vsp-badge{ display:inline-block; padding:3px 7px; border-radius:10px; margin:2px 4px 2px 0; border:1px solid rgba(255,255,255,0.18); white-space:nowrap; }
      .vsp-badge-RED{ background: rgba(220,38,38,0.18); }
      .vsp-badge-AMBER{ background: rgba(245,158,11,0.18); }
      .vsp-badge-GREEN{ background: rgba(34,197,94,0.18); }
      .vsp-badge-NOT_RUN{ background: rgba(148,163,184,0.12); }
      .vsp-badge-DISABLED{ background: rgba(100,116,139,0.12); }
      .vsp-badge-DEGRADED{ background: rgba(56,189,248,0.12); }
      .vsp-badge-UNKNOWN{ background: rgba(148,163,184,0.12); }
      .vsp-exp-wrap{ display:flex; gap:6px; flex-wrap:wrap; }
      .vsp-exp-btn{ font-size:11px; padding:5px 8px; border-radius:10px; border:1px solid rgba(255,255,255,0.18); background: rgba(255,255,255,0.06); color: inherit; cursor:pointer; }
      .vsp-exp-btn[disabled]{ opacity:0.45; cursor:not-allowed; }
      .vsp-row-click{ cursor:pointer; }
      .vsp-link{ opacity:0.9; text-decoration:underline; }
      .vsp-drawer{ position:fixed; top:0; right:0; height:100%; width:min(680px, 94vw);
        background: rgba(2,6,23,0.98); border-left:1px solid rgba(255,255,255,0.10);
        padding:14px; z-index:99999; overflow:auto; display:none; }
      .vsp-drawer h3{ margin:0 0 10px; font-size:14px; }
      .vsp-drawer .close{ float:right; cursor:pointer; opacity:0.8; }
      .vsp-mini{ opacity:.88; font-size:12px; }
      .vsp-mini-table{ width:100%; border-collapse:collapse; margin-top:8px; font-size:12px; }
      .vsp-mini-table td,.vsp-mini-table th{ border-bottom:1px solid rgba(255,255,255,0.08); padding:8px 6px; text-align:left; }
      .vsp-pill{ display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid rgba(255,255,255,0.16); }
      .vsp-ql{ display:flex; flex-wrap:wrap; gap:8px; margin-top:8px; }
      .vsp-ql a{ padding:6px 10px; border-radius:12px; border:1px solid rgba(255,255,255,0.16); background: rgba(255,255,255,0.06); text-decoration:none; color:inherit; }
      .vsp-ql a.disabled{ opacity:0.45; pointer-events:none; }
    `;
    document.head.appendChild(css);
  }

  function findMount(){
    const m = document.querySelector("[data-vsp-runs-mount='1']");
    if (m) return m;
    const ids = ["vsp_runs_mount","tab_runs","runs_tab","vsp4_runs","runs","runsTab"];
    for(const id of ids){
      const el = document.getElementById(id);
      if(el) return el;
    }
    const wrap = document.createElement("div");
    wrap.id = "vsp_runs_mount";
    (document.querySelector("#app") || document.body).appendChild(wrap);
    return wrap;
  }

  function mkShell(){
    return `
      <div class="vsp-runs8-wrap">
        <div class="vsp-runs8-title">Runs & Reports (8 tools)</div>
        <table class="vsp-runs8-table">
          <thead>
            <tr>
              <th>Run</th>
              <th>Overall</th>
              <th>Gate</th>
              <th>Tools A</th>
              <th>Tools B</th>
              <th>Degraded</th>
              <th>Export</th>
            </tr>
          </thead>
          <tbody id="vspRuns8Tbody">
            <tr><td colspan="7">Loading…</td></tr>
          </tbody>
        </table>
      </div>
      <div class="vsp-drawer" id="vspRuns8Drawer">
        <span class="close" id="vspRuns8DrawerClose">✕</span>
        <h3 id="vspRuns8DrawerTitle">Run details</h3>
        <div id="vspRuns8DrawerBody"></div>
      </div>
    `;
  }

  function openDrawer(title, bodyHtml){
    const d = document.getElementById("vspRuns8Drawer");
    const t = document.getElementById("vspRuns8DrawerTitle");
    const b = document.getElementById("vspRuns8DrawerBody");
    if(!d || !t || !b) return;
    t.textContent = title;
    b.innerHTML = bodyHtml;
    d.style.display = "block";
  }
  function closeDrawer(){
    const d = document.getElementById("vspRuns8Drawer");
    if(d) d.style.display = "none";
  }

  function exportCell(rid){
    const btn = (fmt, label) => `<button class="vsp-exp-btn" data-rid="${rid}" data-fmt="${fmt}" disabled title="probe...">${label}</button>`;
    return `<div class="vsp-exp-wrap">${btn("html","HTML")}${btn("pdf","PDF")}${btn("zip","ZIP")}</div>`;
  }

  function toolBadges(status, tools){
    return tools.map(t=>{
      const r = pickTool(status, t);
      return badgeHtml(t, r.verdict, r.total);
    }).join("");
  }

  function toolTable(status){
    const rows = TOOLS_ALL.map(t=>{
      const r = pickTool(status, t);
      const v = normVerdict(r.verdict);
      return `<tr>
        <td><span class="vsp-pill">${t}</span></td>
        <td>${badgeHtml("v", v, "")}</td>
        <td>${r.total ?? 0}</td>
      </tr>`;
    }).join("");
    return `
      <table class="vsp-mini-table">
        <thead><tr><th>Tool</th><th>Verdict</th><th>Total</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>
    `;
  }

  async function renderQuickLinks(rid){
    // Probe existence via HEAD, then build buttons
    const probes = await Promise.all(COMMON_LINKS.map(async (x)=>{
      const url = ART_OPEN_URL(rid, x.rel);
      const ok = await headOk(url);
      return {...x, ok, url};
    }));
    const links = probes.map(x=>{
      const cls = x.ok ? "" : "disabled";
      const title = x.ok ? x.rel : `missing: ${x.rel}`;
      return `<a class="${cls}" href="${x.ok ? x.url : "#"}" target="_blank" title="${title}">${x.label}</a>`;
    }).join("");
    return `<div class="vsp-mini" style="margin-top:6px"><b>Quick Links</b></div><div class="vsp-ql">${links}</div>`;
  }

  async function render(){
    ensureStyles();
    const mount = findMount();
    mount.innerHTML = mkShell();

    const tbody = document.getElementById("vspRuns8Tbody");
    const closeBtn = document.getElementById("vspRuns8DrawerClose");
    if(closeBtn) closeBtn.onclick = closeDrawer;

    let runs;
    try{
      runs = await fetchJson(RUNS_INDEX_URL);
    }catch(e){
      tbody.innerHTML = `<tr><td colspan="7">Failed to load runs_index: ${String(e)}</td></tr>`;
      return;
    }
    const items = runs?.items || runs?.runs || [];
    if(!items.length){
      tbody.innerHTML = `<tr><td colspan="7">No runs found.</td></tr>`;
      return;
    }

    tbody.innerHTML = items.map((it, idx)=>{
      const rid = it.run_id || it.rid || it.id || it.name || `run_${idx}`;
      return `<tr id="vspRuns8Row_${idx}">
        <td><span class="vsp-link" title="${rid}">${rid}</span></td>
        <td id="vspRuns8Overall_${idx}">…</td>
        <td id="vspRuns8Gate_${idx}">…</td>
        <td id="vspRuns8A_${idx}">…</td>
        <td id="vspRuns8B_${idx}">…</td>
        <td id="vspRuns8Deg_${idx}">…</td>
        <td id="vspRuns8Exp_${idx}">${exportCell(rid)}</td>
      </tr>`;
    }).join("");

    // status_v2 fetch with small concurrency
    const limit = 6;
    let i = 0;
    const results = new Array(items.length).fill(null);

    async function worker(){
      while(i < items.length){
        const idx = i++;
        const it = items[idx];
        const rid = it.run_id || it.rid || it.id || it.name;
        try{
          const st = await fetchJson(STATUS_V2_URL(rid));
          results[idx] = { rid, st };
        }catch(e){
          results[idx] = { rid, st: null, err: String(e) };
        }
      }
    }
    await Promise.all(new Array(Math.min(limit, items.length)).fill(0).map(worker));

    for(let idx=0; idx<items.length; idx++){
      const rid = items[idx].run_id || items[idx].rid || items[idx].id || items[idx].name;
      const st = results[idx]?.st || null;

      const cellO = document.getElementById(`vspRuns8Overall_${idx}`);
      const cellG = document.getElementById(`vspRuns8Gate_${idx}`);
      const cellA = document.getElementById(`vspRuns8A_${idx}`);
      const cellB = document.getElementById(`vspRuns8B_${idx}`);
      const cellD = document.getElementById(`vspRuns8Deg_${idx}`);

      if(!st){
        if(cellO) cellO.innerHTML = `<span class="vsp-badge vsp-badge-UNKNOWN">ERR</span>`;
        if(cellG) cellG.textContent = "status_v2 failed";
        if(cellA) cellA.textContent = "-";
        if(cellB) cellB.textContent = "-";
        if(cellD) cellD.textContent = "-";
        continue;
      }

      const gateV = normVerdict(st?.run_gate_summary?.overall || st?.overall_verdict);
      const overallV = normVerdict(st?.overall_verdict || st?.run_gate_summary?.overall);
      if(cellO) cellO.innerHTML = `<span class="vsp-badge vsp-badge-${overallV}">${overallV}</span>`;
      if(cellG) cellG.innerHTML = `<span class="vsp-badge vsp-badge-${gateV}">${gateV}</span>`;
      if(cellA) cellA.innerHTML = toolBadges(st, TOOLS_A);
      if(cellB) cellB.innerHTML = toolBadges(st, TOOLS_B);

      const dn = (st?.degraded_tools && Array.isArray(st.degraded_tools)) ? st.degraded_tools.length : (st?.degraded_n ?? 0);
      const dv = dn > 0 ? "AMBER" : "GREEN";
      if(cellD) cellD.innerHTML = `<span class="vsp-badge vsp-badge-${dv}">${dn}</span>`;

      // Export buttons probe (HEAD)
      const expCell = document.getElementById(`vspRuns8Exp_${idx}`);
      if(expCell){
        const btns = expCell.querySelectorAll("button.vsp-exp-btn");
        btns.forEach(async (btn)=>{
          const fmt = btn.getAttribute("data-fmt");
          const ok = await headOk(EXPORT_URL(rid, fmt));
          btn.disabled = !ok;
          btn.title = ok ? "open export" : "no report yet";
          btn.onclick = ()=>{
            if(btn.disabled) return;
            window.open(EXPORT_URL(rid, fmt), "_blank");
          };
        });
      }

      // Row click -> drawer with quick links
      const row = document.getElementById(`vspRuns8Row_${idx}`);
      if(row){
        row.classList.add("vsp-row-click");
        row.onclick = async ()=>{
          let artifacts = null;
          try{ artifacts = await fetchJson(ARTIFACTS_URL(rid)); }catch(e){ artifacts = {ok:false, error:String(e)}; }

          const ci = st?.ci_run_dir || st?.ci || "-";
          const degraded = st?.degraded_tools || [];

          const linksTop = `
            <div class="vsp-mini" style="margin:8px 0 8px">
              <div><b>RID:</b> ${rid}</div>
              <div><b>CI:</b> ${ci}</div>
              <div style="margin-top:8px"><b>API Links</b></div>
              <div><a class="vsp-link" href="${STATUS_V2_URL(rid)}" target="_blank">status_v2</a></div>
              <div><a class="vsp-link" href="${ARTIFACTS_URL(rid)}" target="_blank">artifacts_index</a></div>
              <div style="margin-top:8px"><b>Export</b></div>
              <div>
                <a class="vsp-link" href="${EXPORT_URL(rid,"html")}" target="_blank">HTML</a> |
                <a class="vsp-link" href="${EXPORT_URL(rid,"pdf")}" target="_blank">PDF</a> |
                <a class="vsp-link" href="${EXPORT_URL(rid,"zip")}" target="_blank">ZIP</a>
              </div>
            </div>
          `;

          const ql = await renderQuickLinks(rid);
          const tools = `<div style="margin-top:12px"><b>by_tool (8 tools)</b></div>${toolTable(st)}`;
          const degBlock = `<div style="margin-top:12px"><b>degraded_tools</b></div><pre style="white-space:pre-wrap">${JSON.stringify(degraded, null, 2)}</pre>`;
          const artBlock = `<div style="margin-top:12px"><b>artifacts_index (raw)</b></div><pre style="white-space:pre-wrap">${JSON.stringify(artifacts, null, 2)}</pre>`;

          openDrawer(`Run details`, linksTop + ql + tools + degBlock + artBlock);
        };
      }
    }
  }

  function shouldRender(){
    const h = String(location.hash || "").toLowerCase();
    if(!h) return true;
    return h.includes("runs");
  }

  let _inflight = false;
  async function boot(){
    if(!shouldRender()) return;
    if(_inflight) return;
    _inflight = true;
    try{ await render(); } finally { _inflight = false; }
  }

  window.addEventListener("hashchange", boot);
  window.addEventListener("DOMContentLoaded", boot);
})();
