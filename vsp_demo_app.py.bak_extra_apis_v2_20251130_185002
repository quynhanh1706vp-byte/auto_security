from __future__ import annotations
import json
from pathlib import Path
from typing import Optional, Any

from flask import (
    Flask,
    jsonify,
    send_from_directory,
    request,
    render_template,
)

# --------------------------------------------------------------------
# Cấu hình Flask: static + templates của my_flask_app
# --------------------------------------------------------------------
UI_ROOT = Path(__file__).resolve().parent          # .../SECURITY_BUNDLE/ui
ROOT = UI_ROOT.parent                              # .../SECURITY_BUNDLE

app = Flask(
    __name__,
    static_folder="my_flask_app/static",
    template_folder="my_flask_app/templates",
)

OUT = ROOT / "out"
RULES = ROOT / "rules" / "vsp_rule_overrides.json"


# --------------------------------------------------------------------
# Helpers
# --------------------------------------------------------------------
def _discover_run_dirs(limit: int = 50):
    if not OUT.exists():
        return []
    dirs = sorted(
        [p for p in OUT.iterdir() if p.is_dir() and p.name.startswith("RUN_")],
        key=lambda p: p.stat().st_mtime,
        reverse=True,
    )
    return dirs[:limit]


def _get_latest_run() -> Optional[Path]:
    runs = _discover_run_dirs(limit=50)
    if not runs:
        return None
    # Ưu tiên RUN có report/findings_unified.json và file không rỗng
    for r in runs:
        f = r / "report" / "findings_unified.json"
        if f.exists() and f.stat().st_size > 0:
            return r
    # fallback: run mới nhất bất kỳ
    return runs[0]


def _load_json(path: Path) -> Any:
    if not path.exists():
        return None
    try:
        return json.loads(path.read_text(encoding="utf-8"))
    except Exception:
        return None


# --------------------------------------------------------------------
# Routes UI
# --------------------------------------------------------------------
@app.route("/")
def home():
    return "<meta http-equiv='refresh' content='0;URL=/security_bundle'>"


@app.route("/security_bundle")
def ui_main():
    # index.html dùng Jinja, url_for('static', ...) hoạt động
    return render_template("index.html")


# --------------------------------------------------------------------
# TAB 1 — DASHBOARD
# --------------------------------------------------------------------
@app.route("/api/vsp/dashboard")
def api_dashboard():
    run_dir = _get_latest_run()
    if not run_dir:
        return jsonify({"error": "no_run"}), 404

    summ = _load_json(run_dir / "report" / "summary_unified.json")
    if not summ:
        return jsonify({"error": "no_summary"}), 404

    return jsonify({
        "run_id": run_dir.name,
        "meta": summ.get("meta", {}),
        "kpi": {
            "total_findings": summ.get("total_findings", 0),
            "severity": summ.get("severity", {}),
            "tool_counts": summ.get("tool_counts", {}),
            "security_score": summ.get("security_score", None),
            "top_risky_tool": summ.get("top_risky_tool"),
            "top_cwe": summ.get("top_cwe"),
            "top_module": summ.get("top_module"),
        },
    })


# --------------------------------------------------------------------
# TAB 2 — RUNS & REPORTS
# --------------------------------------------------------------------
@app.route("/api/vsp/runs_index")
def api_runs_index():
    runs = _discover_run_dirs(limit=50)
    out = []
    for r in runs:
        summ = _load_json(r / "report" / "summary_unified.json")
        if not summ:
            continue
        meta = summ.get("meta", {})
        out.append({
            "run_id": r.name,
            "ts": meta.get("ts"),
            "src_path": meta.get("src_path"),
            "profile": meta.get("profile"),
            "engine_mode": meta.get("engine_mode"),
            "total_findings": summ.get("total_findings"),
            "severity": summ.get("severity", {}),
            "tools": list(summ.get("tool_counts", {}).keys()),
            "report_html": f"/out/{r.name}/report/report.html",
            "report_pdf": f"/out/{r.name}/report/report.pdf",
            "sbom": f"/out/{r.name}/report/sbom_trivy.json",
            "license_report": f"/out/{r.name}/report/license_report.json",
        })
    return jsonify({"runs": out})


# --------------------------------------------------------------------
# TAB 3 — DATA SOURCE
# --------------------------------------------------------------------
@app.route("/api/vsp/datasource")
def api_datasource():
    """
    mode = dashboard  -> chỉ trả sample ~1000 dòng cho Dashboard (nhanh)
    mode = None       -> trả full (tối đa 60000) cho tab Data Source
    """
    mode = request.args.get("mode")
    rid = request.args.get("run_id")
    run_dir: Optional[Path] = None

    if rid:
        cand = OUT / rid
        if cand.exists():
            run_dir = cand

    if not run_dir:
        run_dir = _get_latest_run()
    if not run_dir:
        return jsonify({"error": "no_run"}), 404

    fpath = run_dir / "report" / "findings_unified.json"
    data = _load_json(fpath)
    if not data:
        return jsonify({"error": "no_data"}), 404

    # hỗ trợ 2 dạng: list[] hoặc {rows: []}
    rows = data if isinstance(data, list) else data.get("rows", [])
    total = len(rows)

    if mode == "dashboard":
        visible = rows[:1000]   # đủ cho top risk / noisy / by tool
    else:
        visible = rows[:60000]  # trần cứng cho Data Source

    return jsonify({
        "run_id": run_dir.name,
        "total_rows": total,
        "rows": visible,
    })


# --------------------------------------------------------------------
# TAB 4 — SETTINGS
# --------------------------------------------------------------------
@app.route("/api/vsp/settings")
def api_settings():
    run_dir = _get_latest_run()
    if not run_dir:
        return jsonify({"error": "no_run"}), 404

    summ = _load_json(run_dir / "report" / "summary_unified.json")
    if not summ:
        return jsonify({"error": "no_summary"}), 404

    meta = summ.get("meta", {})
    return jsonify({
        "profile_label": meta.get("profile"),
        "src_path": meta.get("src_path"),
        "engine_mode": meta.get("engine_mode"),
        "last_run_id": run_dir.name,
        "tools_enabled": list(summ.get("tool_counts", {}).keys()),
        "max_rows_ui": meta.get("max_rows_ui", 300),
        "default_export": meta.get("default_export", "HTML"),
    })


# --------------------------------------------------------------------
# TAB 5 — RULE OVERRIDES
# --------------------------------------------------------------------
@app.route("/api/vsp/rule_overrides")
def api_rule_overrides():
    if not RULES.exists():
        return jsonify({
            "rules": [],
            "note": "nguồn: rules/vsp_rule_overrides.json – hiện chưa có rule override",
        })

    data = _load_json(RULES)
    if not data:
        return jsonify({
            "rules": [],
            "note": "nguồn: rules/vsp_rule_overrides.json – file trống hoặc lỗi",
        })

    rules = data.get("overrides", data)
    return jsonify({"rules": rules})


# --------------------------------------------------------------------
# Serve OUT/ (report HTML/PDF/JSON…)
# --------------------------------------------------------------------
@app.route("/out/<path:sub>")
def serve_out(sub: str):
    return send_from_directory(str(OUT), sub)


# --------------------------------------------------------------------
if __name__ == "__main__":
    app.run(host="0.0.0.0", port=8910)
